<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="geolei blog">
  <meta name="keyword" content="hexo-theme">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Javaå¹¶å‘ç¼–ç¨‹ä¹‹Conditionæœºåˆ¶åº•å±‚ | GeekIBLi
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="GeekIBLi" type="application/atom+xml">
</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>GeekIBLi</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>Javaå¹¶å‘ç¼–ç¨‹ä¹‹Conditionæœºåˆ¶åº•å±‚</h2>
  <p class="post-date">2021-08-03</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h1 id="Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶"><a href="#Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶" class="headerlink" title="Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶"></a>Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶</h1><p>è¿˜æ˜¯çœ‹ä¸€ä¸‹ä¹‹å‰ReentrantLockä¸­è°ƒç”¨conditionæ–¹æ³•çš„æµç¨‹å›¾ ğŸ‘‡</p>
<img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210803140956785.png" alt="image-20210803140956785" style="zoom:40%;" />



<p>ä»»ä½•ä¸€ä¸ªjavaå¯¹è±¡éƒ½å¤©ç„¶ç»§æ‰¿äºObjectç±»ï¼Œåœ¨çº¿ç¨‹é—´å®ç°é€šä¿¡çš„å¾€å¾€ä¼šåº”ç”¨åˆ°Objectçš„å‡ ä¸ªæ–¹æ³•ï¼Œæ¯”å¦‚wait(),wait(long timeout),wait(long timeout, int nanos)ä¸notify(),notifyAll()å‡ ä¸ªæ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ŒåŒæ ·çš„ï¼Œ åœ¨java Lockä½“ç³»ä¸‹ä¾ç„¶ä¼šæœ‰åŒæ ·çš„æ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚</p>
<p>ä»æ•´ä½“ä¸Šæ¥çœ‹<strong>Objectçš„waitå’Œnotify/notifyæ˜¯ä¸å¯¹è±¡ç›‘è§†å™¨é…åˆå®Œæˆçº¿ç¨‹é—´çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œè€ŒConditionä¸Locké…åˆå®Œæˆç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œå‰è€…æ˜¯javaåº•å±‚çº§åˆ«çš„ï¼Œåè€…æ˜¯è¯­è¨€çº§åˆ«çš„ï¼Œå…·æœ‰æ›´é«˜çš„å¯æ§åˆ¶æ€§å’Œæ‰©å±•æ€§</strong>ã€‚ä¸¤è€…é™¤äº†åœ¨ä½¿ç”¨æ–¹å¼ä¸Šä¸åŒå¤–ï¼Œåœ¨<strong>åŠŸèƒ½ç‰¹æ€§</strong>ä¸Šè¿˜æ˜¯æœ‰å¾ˆå¤šçš„ä¸åŒï¼š</p>
<ol>
<li>Conditionèƒ½å¤Ÿæ”¯æŒä¸å“åº”ä¸­æ–­ï¼Œè€Œé€šè¿‡ä½¿ç”¨Objectæ–¹å¼ä¸æ”¯æŒï¼›</li>
<li>Conditionèƒ½å¤Ÿæ”¯æŒå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ˆnew å¤šä¸ªConditionå¯¹è±¡ï¼‰ï¼Œè€ŒObjectæ–¹å¼åªèƒ½æ”¯æŒä¸€ä¸ªï¼›</li>
<li>Conditionèƒ½å¤Ÿæ”¯æŒè¶…æ—¶æ—¶é—´çš„è®¾ç½®ï¼Œè€ŒObjectä¸æ”¯æŒ</li>
</ol>
<h2 id="1-Conditionæ¥å£æä¾›çš„æ–¹æ³•"><a href="#1-Conditionæ¥å£æä¾›çš„æ–¹æ³•" class="headerlink" title="1. Conditionæ¥å£æä¾›çš„æ–¹æ³•"></a>1. Conditionæ¥å£æä¾›çš„æ–¹æ³•</h2><h3 id="1-1-awaitæ–¹æ³•"><a href="#1-1-awaitæ–¹æ³•" class="headerlink" title="1.1 awaitæ–¹æ³•"></a>1.1 awaitæ–¹æ³•</h3><p><strong>void await() throws InterruptedException</strong></p>
<p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è°ƒç”¨conditionçš„signalæˆ–è€…signalAllæ–¹æ³•å¹¶ä¸”å½“å‰çº¿ç¨‹è·å–Lockä»awaitæ–¹æ³•è¿”å›ï¼Œå¦‚æœåœ¨ç­‰å¾…çŠ¶æ€ä¸­è¢«ä¸­æ–­ä¼šæŠ›å‡ºè¢«ä¸­æ–­å¼‚å¸¸ï¼›</p>
<p><strong>long awaitNanos(long nanosTimeout)</strong></p>
<p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ï¼Œä¸­æ–­æˆ–è€…<strong>è¶…æ—¶</strong>ï¼›</p>
<p><strong>boolean await(long time, TimeUnit unit)throws InterruptedException</strong></p>
<p>åŒç¬¬äºŒç§ï¼Œæ”¯æŒè‡ªå®šä¹‰æ—¶é—´å•ä½</p>
<p><strong>boolean awaitUntil(Date deadline) throws InterruptedException</strong></p>
<p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ï¼Œä¸­æ–­æˆ–è€…<strong>åˆ°äº†æŸä¸ªæ—¶é—´</strong></p>
<h3 id="1-2-signalæ–¹æ³•"><a href="#1-2-signalæ–¹æ³•" class="headerlink" title="1.2 signalæ–¹æ³•"></a>1.2 signalæ–¹æ³•</h3><p><strong>void signal()</strong></p>
<p>å”¤é†’ä¸€ä¸ªç­‰å¾…åœ¨conditionä¸Šçš„çº¿ç¨‹ï¼Œå°†è¯¥çº¿ç¨‹ä»<strong>ç­‰å¾…é˜Ÿåˆ—</strong>ä¸­è½¬ç§»åˆ°<strong>åŒæ­¥é˜Ÿåˆ—</strong>ä¸­ï¼Œå¦‚æœåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­èƒ½å¤Ÿç«äº‰åˆ°Lockåˆ™å¯ä»¥ä»ç­‰å¾…æ–¹æ³•ä¸­è¿”å›ã€‚</p>
<p><strong>void signalAll()</strong></p>
<p>ä¸1çš„åŒºåˆ«åœ¨äºèƒ½å¤Ÿå”¤é†’æ‰€æœ‰ç­‰å¾…åœ¨conditionä¸Šçš„çº¿ç¨‹ã€‚</p>
<h2 id="2-Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨"><a href="#2-Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨" class="headerlink" title="2. Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨"></a>2. Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨</h2><p>ä¸‹é¢å…ˆé€šè¿‡ä¸€ä¸ªä¾‹å­çœ‹ä¸€ä¸‹Conditionçš„ä½¿ç”¨ ğŸ‘‡</p>
<p>1ã€å¤§è‡´æµç¨‹å°±æ˜¯çº¿ç¨‹1å…ˆè·å–lockä¹‹åï¼Œæ‰§è¡Œçº¿ç¨‹1çš„æ–¹æ³•ï¼Œç„¶åè°ƒç”¨condition.await();æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ï¼›åŒæ—¶åŠ å…¥Conditionç­‰å¾…é˜Ÿåˆ—</p>
<p>2ã€çº¿ç¨‹1é‡Šæ”¾lockä¹‹åï¼Œçº¿ç¨‹2è€Œå·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­äº†ï¼Œçº¿ç¨‹2è·å–lockæ‰§è¡Œæƒï¼Œæ‰§è¡Œcondition.signal()æ–¹æ³•å”¤é†’çº¿ç¨‹1</p>
<p>3ã€çº¿ç¨‹1è¢«å”¤é†’ä¹‹åï¼ŒnodeèŠ‚ç‚¹é‡æ–°æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è·å–æ‰§è¡Œæƒé™ï¼Œåœ¨çº¿ç¨‹2è°ƒç”¨äº†unlock()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹1é‡æ–°è·å–åˆ°lockä¹‹åï¼Œæ‰§è¡Œåç»­æµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Condition condition = lock.newCondition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;enter thread 1 &quot;</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;thread 1 invoke await&quot;</span>);</span><br><span class="line">                    condition.await();</span><br><span class="line">                    System.err.println(<span class="string">&quot;thread 1 invoked signal&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(<span class="string">&quot;exit thread 1 &quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;enter thread 2 &quot;</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;thread 2 invoke signal&quot;</span>);</span><br><span class="line">                condition.signal();</span><br><span class="line">                System.err.println(<span class="string">&quot;exit thread 2 &quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç çš„æ‰§è¡Œç»“æœå¯ä»¥çŒœæƒ³ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enter thread <span class="number">1</span> </span><br><span class="line">thread <span class="number">1</span> invoke await</span><br><span class="line">enter thread <span class="number">2</span> </span><br><span class="line">thread <span class="number">2</span> invoke signal</span><br><span class="line">exit thread <span class="number">2</span> </span><br><span class="line">thread <span class="number">1</span> invoked signal</span><br><span class="line">exit thread <span class="number">1</span> </span><br></pre></td></tr></table></figure>



<h2 id="3-Conditionç­‰å¾…-é€šçŸ¥å®ç°åŸç†"><a href="#3-Conditionç­‰å¾…-é€šçŸ¥å®ç°åŸç†" class="headerlink" title="3. Conditionç­‰å¾…/é€šçŸ¥å®ç°åŸç†"></a>3. Conditionç­‰å¾…/é€šçŸ¥å®ç°åŸç†</h2><p>è¦æƒ³èƒ½å¤Ÿæ·±å…¥çš„æŒæ¡conditionè¿˜æ˜¯åº”è¯¥çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹condiitonçš„æºç ã€‚åˆ›å»ºä¸€ä¸ªconditionå¯¹è±¡æ˜¯é€šè¿‡<code>lock.newCondition()</code>,è€Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ä¼šnewå‡ºä¸€ä¸ª<strong>ConditionObject</strong>å¯¹è±¡ï¼Œè¯¥ç±»æ˜¯AQSçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå’ŒNodeç±»ä¸€æ ·ï¼Œéå¸¸é‡è¦ã€‚</p>
<p>conditionæ˜¯è¦å’Œlocké…åˆä½¿ç”¨çš„ä¹Ÿå°±æ˜¯conditionå’ŒLockæ˜¯ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œè€Œlockçš„å®ç°åŸç†åˆä¾èµ–äºAQSï¼Œè‡ªç„¶è€Œç„¶ConditionObjectä½œä¸ºAQSçš„ä¸€ä¸ªå†…éƒ¨ç±»æ— å¯åšéã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“åœ¨é”æœºåˆ¶çš„å®ç°ä¸Šï¼ŒAQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯ç‹¬å å¼é”çš„è¯ï¼Œæ‰€æœ‰è·å–é”å¤±è´¥çš„çº¿ç¨‹çš„å°¾æ’å…¥åˆ°<strong>åŒæ­¥é˜Ÿåˆ—</strong>ï¼ŒåŒæ ·çš„ï¼Œconditionå†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨åŒæ ·çš„æ–¹å¼ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª <strong>ç­‰å¾…é˜Ÿåˆ—</strong>ï¼Œæ‰€æœ‰è°ƒç”¨condition.awaitæ–¹æ³•çš„çº¿ç¨‹ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”çº¿ç¨‹çŠ¶æ€è½¬æ¢ä¸ºç­‰å¾…çŠ¶æ€ã€‚</p>
<p>å¦å¤–æ³¨æ„åˆ°ConditionObjectä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š</p>
<p><code>private transient Node firstWaiter;</code></p>
<p><code>private transient Node lastWaiter;</code></p>
<p>åœ¨AQSä¸­conditioné˜Ÿåˆ—å¯ä»¥å­˜åœ¨å¤šä¸ªå¦‚ä¸‹æ‰€ç¤ºï¼Œä½†æ˜¯åŒæ­¥é˜Ÿåˆ—ä¹‹å¯èƒ½æ˜¯ä¸€ä¸ªï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŒæ­¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨é˜Ÿåˆ—ï¼Œè€Œç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘çš„é˜Ÿåˆ—ã€‚</p>
<img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210803142409623.png" alt="image-20210803142409623" style="zoom:33%;" />



<p>ä¸‹é¢ä»awaitæ–¹æ³•å…¥æ‰‹æ¥å­¦ä¹ Conditionçš„æœºåˆ¶æ˜¯å¦‚ä½•è¿è½¬çš„ã€‚</p>
<h3 id="3-1-ç­‰å¾…await"><a href="#3-1-ç­‰å¾…await" class="headerlink" title="3.1 ç­‰å¾…await"></a>3.1 ç­‰å¾…await</h3><p><code>public class ConditionObject implements Condition</code></p>
<p>AQS#ConditionObjectå†…éƒ¨ç±»å®ç°äº†Conditionæ¥å£çš„awaitæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  	<span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  	<span class="comment">// å°†èŠ‚ç‚¹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">  	<span class="comment">// è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹éœ€è¦é‡Šæ”¾lockè®©ç»™åˆ«çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">  	<span class="comment">// å¦‚æœèŠ‚ç‚¹ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ŒçŸ¥é“è¿›å…¥åŒæ­¥é˜Ÿåˆ—æˆ–è€…è¢«ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// è°ƒç”¨awaitçš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡åœ¨ä¸Šé¢çš„whileå¾ªç¯ï¼ŒçŸ¥é“è¢«å”¤é†’æˆ–è€…ç›¸åº”ä¸­æ–­ï¼Œæ‰ä¼šæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•</span></span><br><span class="line">  	<span class="comment">// è¿›å…¥åŒæ­¥é˜Ÿåˆ—å°è¯•è·å–lockï¼Œå’Œä¹‹å‰ä¸€æ ·ï¼Œä¸ºäº†é™åˆ¶ä¸€ç›´ç©ºè½¬ï¼Œä¼šåœ¨ç¬¬äºŒæ¬¡å¾ªç¯ä¹‹åï¼Œparkæ­¤èŠ‚ç‚¹ï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸­è½®åˆ°è¿™ä¸ªçº¿ç¨‹å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">      	<span class="comment">// æ¸…é™¤æ‰å–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè¸¢å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">  			<span class="comment">//å¤„ç†è¢«ä¸­æ–­çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>AQS#addConditionWaiter</strong> <strong>æ·»åŠ èŠ‚ç‚¹åˆ°ç­‰å¾…é˜Ÿåˆ—</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•åº”è¯¥æ¯”è¾ƒå¥½ç†è§£å§ï¼Œå°±æ˜¯æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚</p>
<p>âš ï¸ è¿™é‡Œå’ŒæŠŠèŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—è¿˜æœ‰ç‚¹åŒºåˆ«ï¼Œä¸çŸ¥é“å¤§å®¶è¿˜æœ‰æ²¡æœ‰å°è±¡ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå…ˆåˆ¤æ–­tailæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸æ˜¯ç©ºï¼Œåˆ™ç›´æ¥æ·»åŠ ï¼›å¦‚æœæ˜¯ç©ºï¼Œåˆ™è°ƒç”¨äº†<code>enq(Node node)</code>æ–¹æ³•ï¼Œå…ˆç”Ÿæˆä¸€ä¸ªheadèŠ‚ç‚¹ï¼Œç„¶ååœ¨æŠŠå½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°åé¢ï¼Œå¾ªç¯äº†ä¸¤éçš„ã€‚</p>
<p>è¿™é‡Œæ˜¯ç›´æ¥åˆ›å»ºå½“å‰èŠ‚ç‚¹ï¼Œç„¶åå°†firstWaiteræŒ‡é’ˆæŒ‡å‘äº†nodeï¼›</p>
<p><strong>AQS#fullyRelease é‡Šæ”¾lock</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> savedState = getState();</span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•ä¹Ÿä¸éš¾ï¼Œæƒ³ä¸€ä¸‹ï¼Œçº¿ç¨‹éƒ½å·²ç»è°ƒç”¨awaitæ–¹æ³•äº†ï¼Œè€Œä¸”ä¸Šä¸€æ­¥å°±å·²ç»æŠŠèŠ‚ç‚¹æ·»åŠ åˆ°äº†ç­‰å¾…é˜Ÿåˆ—ä¸­äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦åšä»€ä¹ˆå‘¢ï¼Ÿé‚£è‚¯å®šæ˜¯é‡Šæ”¾é”lockäº†ã€‚å¯¹ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯åšè¿™ä¸ªçš„ã€‚releaseæ–¹æ³•ä¹‹å‰å·²ç»ä»‹ç»äº†ï¼Œæ— éå°±æ˜¯å¯¹stateåšä¸€ä¸‹å‡æ³•ï¼ŒæŠŠå¯¹æˆ˜çº¿ç¨‹æ¸…ç©ºä¸€ä¸‹ï¼Œç»™æ–°æ¥çš„çº¿ç¨‹è…¾åœ°æ–¹ã€‚</p>
<p><strong>ä¸‹é¢æ‰æ˜¯awaitçš„å…³é”®æ ¸å¿ƒä»£ç </strong>ï¼šâ€¼ï¸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">while (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(this);</span><br><span class="line">        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>isOnSyncQueue(node)</code>åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¸ªåˆ¤æ–­å‘¢ï¼ŸåŸå› å¾ˆç®€å•ï¼Œå½“åˆ«çš„çº¿ç¨‹æˆ–è€…è‡ªå·±è°ƒç”¨äº†signalæ–¹æ³•ä¹‹åï¼Œä¼šæŠŠå½“å‰èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è¯´æ˜ä»€ä¹ˆå‘¢ï¼Œè¯´æ˜æ¥ä¸‹æ¥è¿™ä¸ªçº¿ç¨‹è¦å»ç«äº‰é”äº†ï¼Œä¹Ÿå°±æ˜¯è¢«å”¤é†’äº†ï¼Œå½“ç«äº‰é”æˆåŠŸä¹‹åï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¯ä»¥awaitåé¢çš„æ–¹æ³•äº†ã€‚</p>
<p><code>(interruptMode = checkInterruptWhileWaiting(node)) != 0</code></p>
<p>å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™å¯ä»¥ç›´æ¥è·³å‡ºå¾ªç¯ï¼Œå»ç«äº‰é”ã€‚</p>
<h3 id="3-2-é€šçŸ¥signal"><a href="#3-2-é€šçŸ¥signal" class="headerlink" title="3.2 é€šçŸ¥signal"></a>3.2 é€šçŸ¥signal</h3><p><strong>è°ƒç”¨conditionçš„signalæˆ–è€…signalAllæ–¹æ³•å¯ä»¥å°†ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</strong>ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹èƒ½å¤Ÿæœ‰æœºä¼šè·å¾—lockã€‚æŒ‰ç…§ç­‰å¾…é˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„ï¼Œæ‰€ä»¥ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹å¿…ç„¶ä¼šæ˜¯ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡è°ƒç”¨conditionçš„signalæ–¹æ³•æ˜¯å°†å¤´èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚signalæ–¹æ³•æºç ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1. å…ˆæ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å–lockï¼Œå¦‚æœæ²¡æœ‰è·å¾—é”ï¼Œè‚¯å®šæ˜¯è¯´ä¸é€šçš„</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">//2. è·å–ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹‹åçš„æ“ä½œéƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">	Node first = firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>signalæ–¹æ³•é¦–å…ˆä¼šæ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å–lockï¼Œå¦‚æœæ²¡æœ‰è·å–lockä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœè·å–çš„è¯å†å¾—åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å¤´æŒ‡é’ˆå¼•ç”¨çš„èŠ‚ç‚¹ï¼Œä¹‹åçš„æ“ä½œçš„doSignalæ–¹æ³•ä¹Ÿæ˜¯åŸºäºè¯¥èŠ‚ç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹doSignalæ–¹æ³•åšäº†äº›ä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p><strong>AQS#doSignal</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">//1. å°†å¤´ç»“ç‚¹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">		<span class="comment">//2. whileä¸­transferForSignalæ–¹æ³•å¯¹å¤´ç»“ç‚¹åšçœŸæ­£çš„å¤„ç†</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">             (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼ŒçœŸæ­£å¯¹å¤´èŠ‚ç‚¹åšå¤„ç†çš„é€»è¾‘åœ¨<strong>transferForSignal</strong>æ”¾ï¼Œè¯¥æ–¹æ³•æºç ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If cannot change waitStatus, the node has been cancelled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	  <span class="comment">//1. æ›´æ–°çŠ¶æ€ä¸º0ï¼ŒåŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„èŠ‚ç‚¹çš„åˆå§‹çŠ¶æ€æ˜¯0</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Splice onto queue and try to set waitStatus of predecessor to</span></span><br><span class="line"><span class="comment">     * indicate that thread is (probably) waiting. If cancelled or</span></span><br><span class="line"><span class="comment">     * attempt to set waitStatus fails, wake up to resync (in which</span></span><br><span class="line"><span class="comment">     * case the waitStatus can be transiently and harmlessly wrong).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">//2.å°†è¯¥èŠ‚ç‚¹ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­å»</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">  	<span class="comment">// pèŠ‚ç‚¹æ˜¯nodeçš„å‰ç½®èŠ‚ç‚¹ï¼Œéœ€è¦å°†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNAL</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³é”®é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼Œè¿™æ®µä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…</p>
<p>1.å°†å¤´ç»“ç‚¹çš„çŠ¶æ€æ›´æ”¹ä¸ºCONDITIONï¼›</p>
<p>2.è°ƒç”¨enqæ–¹æ³•ï¼Œå°†è¯¥èŠ‚ç‚¹å°¾æ’å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNAL</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š<strong>è°ƒç”¨conditionçš„signalçš„å‰ææ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹å·²ç»è·å–äº†lockï¼Œè¯¥æ–¹æ³•ä¼šä½¿å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹å³ç­‰å¾…æ—¶é—´æœ€é•¿çš„é‚£ä¸ªèŠ‚ç‚¹ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè€Œç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—åæ‰æœ‰æœºä¼šä½¿å¾—ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ï¼Œå³ä»awaitæ–¹æ³•ä¸­çš„LockSupport.park(this)æ–¹æ³•ä¸­è¿”å›ï¼Œä»è€Œæ‰æœ‰æœºä¼šä½¿å¾—è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æˆåŠŸé€€å‡º</strong>ã€‚</p>
<p><strong>signalAllæ–¹æ³•é€šçŸ¥æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</strong></p>
<p>sigllAllä¸sigalæ–¹æ³•çš„åŒºåˆ«ä½“ç°åœ¨doSignalAllæ–¹æ³•ä¸Šï¼Œå‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“doSignalæ–¹æ³•åªä¼šå¯¹ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œè€ŒdoSignalAllçš„æºç ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignalAll</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    lastWaiter = firstWaiter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        Node next = first.nextWaiter;</span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">        transferForSignal(first);</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (first != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•åªä¸è¿‡æ—¶é—´ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå³â€œé€šçŸ¥â€å½“å‰è°ƒç”¨condition.await()æ–¹æ³•çš„æ¯ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<h2 id="é¢è¯•é¢˜-ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100"><a href="#é¢è¯•é¢˜-ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100" class="headerlink" title="é¢è¯•é¢˜ ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100"></a>é¢è¯•é¢˜ ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ibli.note;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitNotifyDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> Condition condition;</span><br><span class="line">    <span class="keyword">private</span> Lock lock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaitNotifyDemo</span><span class="params">(Condition condition, Lock lock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.condition = condition;</span><br><span class="line">        <span class="keyword">this</span>.lock = lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                condition.signal();</span><br><span class="line">                <span class="keyword">if</span> (count &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(Thread.currentThread().getName() + <span class="string">&quot; =&gt; &quot;</span> + count);</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    condition.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        Condition condition = lock.newCondition();</span><br><span class="line">        WaitNotifyDemo waitNotifyDemo = <span class="keyword">new</span> WaitNotifyDemo(condition, lock);</span><br><span class="line">        <span class="keyword">new</span> Thread(waitNotifyDemo).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(waitNotifyDemo).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903602419400718">https://juejin.cn/post/6844903602419400718</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903654873382925">https://juejin.cn/post/6844903654873382925</a></p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#å¤šçº¿ç¨‹" >
    <span class="tag-code">å¤šçº¿ç¨‹</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ReetrantLock/">
        <span class="nav-arrow">â† </span>
        
          Javaå¹¶å‘ç¼–ç¨‹ä¹‹æ·±å…¥ç†è§£ReentrantLock
        
      </a>
    
    
      <a class="nav-right" href="/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6/">
        
          Javaå¹¶å‘ç¼–ç¨‹ä¹‹ä¸­æ–­æœºåˆ¶
        
        <span class="nav-arrow"> â†’</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- æ‰“èµ START -->
    
    <!-- æ‰“èµ END -->
    <!-- äºŒç»´ç  START -->
    
    <!-- äºŒç»´ç  END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo=""
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://example.com/wiki/Javaå¹¶å‘ç¼–ç¨‹ä¹‹Conditionæœºåˆ¶åº•å±‚/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>







    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2022 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>