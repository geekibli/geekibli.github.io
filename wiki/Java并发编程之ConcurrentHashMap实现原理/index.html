<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="geolei blog">
  <meta name="keyword" content="hexo-theme">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Javaå¹¶å‘ç¼–ç¨‹ä¹‹ConcurrentHashMapå®ç°åŸç† | GeekIBLi
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="GeekIBLi" type="application/atom+xml">
</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>GeekIBLi</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>Javaå¹¶å‘ç¼–ç¨‹ä¹‹ConcurrentHashMapå®ç°åŸç†</h2>
  <p class="post-date">2021-08-05</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h1 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h1><p>Mapåº”è¯¥æ˜¯æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­é™¤äº†Listä½¿ç”¨çš„ç¬¬äºŒé¢‘ç¹çš„æ•°æ®ç»“æ„äº†å§ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“HashMapæ— æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¿è¯å®‰å…¨ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»€ä¹ˆæ¥ä»£æ›¿HashMapå‘¢ï¼Œæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼ŒHashTableå’ŒConcurrentHashMap,ç”±äºHashTableçš„æ€§èƒ½ç›¸å¯¹æ¯”è¾ƒä½ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä½¿ç”¨ConcurrentHashMapæ¥ä»£æ›¿HashMapã€‚</p>
<img src="/Users/gaolei/Library/Application Support/typora-user-images/image-20210819174036440.png" alt="image-20210819174036440" style="zoom: 33%;" />

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><h3 id="HashTable-amp-HashMap"><a href="#HashTable-amp-HashMap" class="headerlink" title="HashTable&amp;HashMap"></a>HashTable&amp;HashMap</h3><p><code>HashTable</code>çš„<code>put</code>, <code>get</code>,<code>remove</code>ç­‰æ–¹æ³•æ˜¯é€šè¿‡<code>synchronized</code>æ¥ä¿®é¥°ä¿è¯å…¶çº¿ç¨‹å®‰å…¨æ€§çš„ã€‚</p>
<p><code>HashTable</code>æ˜¯ ä¸å…è®¸keyè·Ÿvalueä¸ºnullçš„ã€‚</p>
<p>é—®é¢˜æ˜¯<code>synchronized</code>æ˜¯ä¸ªå…³é”®å­—çº§åˆ«çš„==é‡é‡é”==ï¼Œåœ¨getæ•°æ®çš„æ—¶å€™ä»»ä½•å†™å…¥æ“ä½œéƒ½ä¸å…è®¸ã€‚ç›¸å¯¹æ¥è¯´æ€§èƒ½ä¸å¥½ã€‚</p>
<h3 id="ConcurrentHashMapæ¦‚è¿°"><a href="#ConcurrentHashMapæ¦‚è¿°" class="headerlink" title="ConcurrentHashMapæ¦‚è¿°"></a>ConcurrentHashMapæ¦‚è¿°</h3><p>åœ¨ConcurrentHashMapä¸­é€šè¿‡ä¸€ä¸ªNode&lt;K,V&gt;[]æ•°ç»„æ¥ä¿å­˜æ·»åŠ åˆ°mapä¸­çš„é”®å€¼å¯¹ï¼Œè€Œåœ¨åŒä¸€ä¸ªæ•°ç»„ä½ç½®æ˜¯é€šè¿‡é“¾è¡¨å’Œçº¢é»‘æ ‘çš„å½¢å¼æ¥ä¿å­˜çš„ã€‚ä½†æ˜¯è¿™ä¸ªæ•°ç»„åªæœ‰åœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œå¦åˆ™åªæ˜¯åˆå§‹åŒ–ä¸€ä¸ªConcurrentHashMapå¯¹è±¡çš„è¯ï¼Œåªæ˜¯è®¾å®šäº†ä¸€ä¸ªsizeCtlå˜é‡ï¼Œè¿™ä¸ªå˜é‡ç”¨æ¥åˆ¤æ–­å¯¹è±¡çš„ä¸€äº›çŠ¶æ€å’Œæ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Šã€‚</p>
<p>ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé»˜è®¤åˆæœŸé•¿åº¦ä¸º16ï¼Œå½“å¾€mapä¸­ç»§ç»­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé€šè¿‡hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä¸æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®çš„æ—¶å€™ï¼Œä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°åˆè¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64çš„æ—¶å€™ï¼Œåˆ™ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64äº†çš„è¯ï¼Œåœ¨ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚</p>
<p>é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹ç»™åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°çš„æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ é€šè¿‡hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥åŒºåˆ†ï¼Œæ˜¯è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®è¿˜æ˜¯æ”¾åˆ°æ‰©å®¹çš„é•¿åº¦çš„ç›¸åŒä½ç½®å» ã€‚åœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹çš„æ˜¯æ ‘ï¼ŒåŒæ—¶ç°åœ¨è¯¥èŠ‚ç‚¹çš„ä¸ªæ•°åˆå°äºç­‰äº6ä¸ªäº†ï¼Œåˆ™ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚</p>
<p>å–å…ƒç´ çš„æ—¶å€™ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡è®¡ç®—hashæ¥ç¡®å®šè¯¥å…ƒç´ åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®ï¼Œç„¶ååœ¨é€šè¿‡éå†é“¾è¡¨æˆ–æ ‘æ¥åˆ¤æ–­keyå’Œkeyçš„hashï¼Œå–å‡ºvalueå€¼ã€‚</p>
<h2 id="ConcurrentHashMap-åŸç†è§£æ"><a href="#ConcurrentHashMap-åŸç†è§£æ" class="headerlink" title="ConcurrentHashMap åŸç†è§£æ"></a>ConcurrentHashMap åŸç†è§£æ</h2><h3 id="ConcurrentHashMapå±æ€§"><a href="#ConcurrentHashMapå±æ€§" class="headerlink" title="ConcurrentHashMapå±æ€§"></a>ConcurrentHashMapå±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// è¡¨ç¤ºæ­£åœ¨è½¬ç§»</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// è¡¨ç¤ºå·²ç»è½¬æ¢æˆæ ‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;<span class="comment">//é»˜è®¤æ²¡åˆå§‹åŒ–çš„æ•°ç»„ï¼Œç”¨æ¥ä¿å­˜å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;<span class="comment">//è½¬ç§»çš„æ—¶å€™ç”¨çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æ¥æ§åˆ¶è¡¨åˆå§‹åŒ–å’Œæ‰©å®¹çš„ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œå½“åœ¨åˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šäº†å¤§å°ï¼Œè¿™ä¼šå°†è¿™ä¸ªå¤§å°ä¿å­˜åœ¨sizeCtlä¸­ï¼Œå¤§å°ä¸ºæ•°ç»„çš„0.75</span></span><br><span class="line"><span class="comment">     * å½“ä¸ºè´Ÿçš„æ—¶å€™ï¼Œè¯´æ˜è¡¨æ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å¼ ï¼Œ</span></span><br><span class="line"><span class="comment">     *     -1è¡¨ç¤ºåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     *     -(1+n) n:è¡¨ç¤ºæ´»åŠ¨çš„æ‰©å¼ çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br></pre></td></tr></table></figure>

<h4 id="Node-lt-K-V-gt-è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚"><a href="#Node-lt-K-V-gt-è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚" class="headerlink" title="Node&lt;K,V&gt;,è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚"></a><strong>Node&lt;K,V&gt;,è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> hash;    <span class="comment">//keyçš„hashå€¼</span></span><br><span class="line">  <span class="keyword">final</span> K key;       <span class="comment">//key</span></span><br><span class="line">  <span class="keyword">volatile</span> V val;    <span class="comment">//value</span></span><br><span class="line">  <span class="keyword">volatile</span> Node&lt;K,V&gt; next; <span class="comment">//è¡¨ç¤ºé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">  Node(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hash = hash;</span><br><span class="line">    <span class="keyword">this</span>.key = key;</span><br><span class="line">    <span class="keyword">this</span>.val = val;</span><br><span class="line">    <span class="keyword">this</span>.next = next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> val; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹"><a href="#TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹" class="headerlink" title="TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹"></a><strong>TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">  TreeNode&lt;K,V&gt; left;</span><br><span class="line">  TreeNode&lt;K,V&gt; right;</span><br><span class="line">  TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">  <span class="keyword">boolean</span> red;</span><br><span class="line"></span><br><span class="line">  TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next,</span><br><span class="line">           TreeNode&lt;K,V&gt; parent) &#123;</span><br><span class="line">    <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    <span class="keyword">this</span>.parent = parent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TreeBin-ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹"><a href="#TreeBin-ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹" class="headerlink" title="TreeBin ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹"></a><strong>TreeBin ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹</strong></h4><p><strong>åªå­˜å‚¨rootå’ŒfirstèŠ‚ç‚¹ï¼Œä¸å­˜å‚¨èŠ‚ç‚¹çš„keyã€valueå€¼ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeBin</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  TreeNode&lt;K,V&gt; root;</span><br><span class="line">  <span class="keyword">volatile</span> TreeNode&lt;K,V&gt; first;</span><br><span class="line">  <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">int</span> lockState;</span><br><span class="line">  <span class="comment">// values for lockState</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITER = <span class="number">1</span>; <span class="comment">// set while holding write lock</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WAITER = <span class="number">2</span>; <span class="comment">// set when waiting for write lock</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READER = <span class="number">4</span>; <span class="comment">// increment value for setting read lock</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ForwardingNode"><a href="#ForwardingNode" class="headerlink" title="ForwardingNode"></a><strong>ForwardingNode</strong></h4><p><strong>åœ¨è½¬ç§»çš„æ—¶å€™æ”¾åœ¨å¤´éƒ¨çš„èŠ‚ç‚¹ï¼Œæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">  ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">    <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•"><a href="#ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•" class="headerlink" title="ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•"></a><strong>ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ç”¨æ¥è¿”å›èŠ‚ç‚¹æ•°ç»„çš„æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹çš„åŸå­æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * casåŸå­æ“ä½œï¼Œåœ¨æŒ‡å®šä½ç½®è®¾å®šå€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * åŸå­æ“ä½œï¼Œåœ¨æŒ‡å®šä½ç½®è®¾å®šå€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">  U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConcurrentHashMapçš„åˆå§‹åŒ–"><a href="#ConcurrentHashMapçš„åˆå§‹åŒ–" class="headerlink" title="ConcurrentHashMapçš„åˆå§‹åŒ–"></a><strong>ConcurrentHashMapçš„åˆå§‹åŒ–</strong></h3><p>å…ˆçœ‹ä¸€ä¸‹ConcurrentHashMapçš„æ„é€ å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç©ºçš„æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœåœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™æŒ‡å®šäº†å®¹é‡ï¼Œåˆ™åˆå§‹åŒ–sizeCtl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">  <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">             MAXIMUM_CAPACITY :</span><br><span class="line">             tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å½“å‡ºå…¥ä¸€ä¸ªMapçš„æ—¶å€™ï¼Œå…ˆè®¾å®šsizeCtlä¸ºé»˜è®¤å®¹é‡ï¼Œåœ¨æ·»åŠ å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.sizeCtl = DEFAULT_CAPACITY;</span><br><span class="line">  putAll(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªæ„é€ æ–¹æ³•ä¸­ï¼Œéƒ½æ²¡æœ‰å¯¹å­˜å‚¨Mapå…ƒç´ Nodeçš„tableå˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚è€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡putæ“ä½œçš„æ—¶å€™åœ¨è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹çœ‹æ•°ç»„çš„åˆå§‹åŒ–æ–¹æ³•initTable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–æ•°ç»„tableï¼Œ</span></span><br><span class="line"><span class="comment">     * å¦‚æœsizeCtlå°äº0ï¼Œè¯´æ˜åˆ«çš„æ•°ç»„æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™è®©å‡ºæ‰§è¡Œæƒ</span></span><br><span class="line"><span class="comment">     * å¦‚æœsizeCtlå¤§äº0çš„è¯ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªå¤§å°ä¸ºsizeCtlçš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * å¦åˆ™çš„è¯åˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤å¤§å°(16)çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * ç„¶åè®¾ç½®sizeCtlçš„å€¼ä¸ºæ•°ç»„é•¿åº¦çš„3/4</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">  Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">  <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;    <span class="comment">//ç¬¬ä¸€æ¬¡putçš„æ—¶å€™ï¼Œtableè¿˜æ²¡è¢«åˆå§‹åŒ–ï¼Œè¿›å…¥while</span></span><br><span class="line">    <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)                            <span class="comment">//sizeCtlåˆå§‹å€¼ä¸º0ï¼Œå½“å°äº0çš„æ—¶å€™è¡¨ç¤ºåœ¨åˆ«çš„çº¿ç¨‹åœ¨åˆå§‹åŒ–è¡¨æˆ–æ‰©å±•è¡¨</span></span><br><span class="line">      Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;    <span class="comment">//SIZECTLï¼šè¡¨ç¤ºå½“å‰å¯¹è±¡çš„å†…å­˜åç§»é‡ï¼Œscè¡¨ç¤ºæœŸæœ›å€¼ï¼Œ-1è¡¨ç¤ºè¦æ›¿æ¢çš„å€¼ï¼Œè®¾å®šä¸º-1è¡¨ç¤ºè¦åˆå§‹åŒ–è¡¨äº†</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;        <span class="comment">//æŒ‡å®šäº†å¤§å°çš„æ—¶å€™å°±åˆ›å»ºæŒ‡å®šå¤§å°çš„Nodeæ•°ç»„ï¼Œå¦åˆ™åˆ›å»ºæŒ‡å®šå¤§å°(16)çš„Nodeæ•°ç»„</span></span><br><span class="line">          <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">          Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">          table = tab = nt;</span><br><span class="line">          sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        sizeCtl = sc;            <span class="comment">//åˆå§‹åŒ–åï¼ŒsizeCtlé•¿åº¦ä¸ºæ•°ç»„é•¿åº¦çš„3/4</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConcurrentHashMapçš„putæ“ä½œè¯¦è§£"><a href="#ConcurrentHashMapçš„putæ“ä½œè¯¦è§£" class="headerlink" title="ConcurrentHashMapçš„putæ“ä½œè¯¦è§£"></a>ConcurrentHashMapçš„putæ“ä½œè¯¦è§£</h3><p>ğŸ‘‡ä¸‹é¢æ˜¯putæ–¹æ³•çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  å•çº¯çš„é¢è°ƒç”¨putValæ–¹æ³•ï¼Œå¹¶ä¸”putValçš„ç¬¬ä¸‰ä¸ªå‚æ•°è®¾ç½®ä¸ºfalse</span></span><br><span class="line"><span class="comment">     *  å½“è®¾ç½®ä¸ºfalseçš„æ—¶å€™è¡¨ç¤ºè¿™ä¸ªvalueä¸€å®šä¼šè®¾ç½®</span></span><br><span class="line"><span class="comment">     *  trueçš„æ—¶å€™ï¼Œåªæœ‰å½“è¿™ä¸ªkeyçš„valueä¸ºç©ºçš„æ—¶å€™æ‰ä¼šè®¾ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸‹é¢çœ‹ä¸€ä¸‹putValæ–¹æ³•å®ç°ï¼š</strong></p>
<p>å½“æ·»åŠ ä¸€å¯¹é”®å€¼å¯¹çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå»åˆ¤æ–­ä¿å­˜è¿™äº›é”®å€¼å¯¹çš„æ•°ç»„æ˜¯ä¸æ˜¯åˆå§‹åŒ–äº†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±åˆå§‹åŒ–æ•°ç»„, ç„¶åé€šè¿‡è®¡ç®—hashå€¼æ¥ç¡®å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®ã€‚</p>
<p>å¦‚æœè¿™ä¸ªä½ç½®ä¸ºç©ºåˆ™ç›´æ¥æ·»åŠ ï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™å–å‡ºè¿™ä¸ªèŠ‚ç‚¹æ¥ï¼Œå–å‡ºæ¥çš„èŠ‚ç‚¹çš„hashå€¼æ˜¯MOVED(-1)çš„è¯ï¼Œåˆ™è¡¨ç¤ºå½“å‰æ­£åœ¨å¯¹è¿™ä¸ªæ•°ç»„è¿›è¡Œæ‰©å®¹ï¼Œå¤åˆ¶åˆ°æ–°çš„æ•°ç»„ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿå»å¸®åŠ©å¤åˆ¶ã€‚</p>
<p>å¦‚æœè¿™ä¸ªèŠ‚ç‚¹ï¼Œä¸ä¸ºç©ºï¼Œä¹Ÿä¸åœ¨æ‰©å®¹ï¼Œåˆ™é€šè¿‡synchronizedæ¥åŠ é”ï¼Œè¿›è¡Œæ·»åŠ æ“ä½œã€‚</p>
<p>ç„¶ååˆ¤æ–­å½“å‰å–å‡ºçš„èŠ‚ç‚¹ä½ç½®å­˜æ”¾çš„æ˜¯é“¾è¡¨è¿˜æ˜¯æ ‘ï¼Œå¦‚æœæ˜¯é“¾è¡¨çš„è¯ï¼Œåˆ™éå†æ•´ä¸ªé“¾è¡¨ï¼Œç›´åˆ°å–å‡ºæ¥çš„èŠ‚ç‚¹çš„keyæ¥ä¸ªè¦æ”¾çš„keyè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœkeyç›¸ç­‰ï¼Œå¹¶ä¸”keyçš„hashå€¼ä¹Ÿç›¸ç­‰çš„è¯ï¼Œåˆ™è¯´æ˜æ˜¯åŒä¸€ä¸ªkeyï¼Œåˆ™è¦†ç›–æ‰valueï¼Œå¦åˆ™çš„è¯åˆ™æ·»åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚å¦‚æœæ˜¯æ ‘çš„è¯ï¼Œåˆ™è°ƒç”¨putTreeValæ–¹æ³•æŠŠè¿™ä¸ªå…ƒç´ æ·»åŠ åˆ°æ ‘ä¸­å»ã€‚</p>
<p>æœ€ååœ¨æ·»åŠ å®Œæˆä¹‹åï¼Œä¼šåˆ¤æ–­åœ¨è¯¥èŠ‚ç‚¹å¤„å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹ï¼ˆæ³¨æ„æ˜¯æ·»åŠ å‰çš„ä¸ªæ•°ï¼‰ï¼Œå¦‚æœè¾¾åˆ°8ä¸ªä»¥ä¸Šäº†çš„è¯ï¼Œåˆ™è°ƒç”¨treeifyBinæ–¹æ³•æ¥å°è¯•å°†å¤„çš„é“¾è¡¨è½¬ä¸ºæ ‘ï¼Œæˆ–è€…æ‰©å®¹æ•°ç»„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span> <span class="params">(K key, V value,<span class="keyword">boolean</span> onlyIfAbsent)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  <span class="comment">//å–å¾—keyçš„hashå€¼</span></span><br><span class="line">  <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">  <span class="comment">//ç”¨æ¥è®¡ç®—åœ¨è¿™ä¸ªèŠ‚ç‚¹æ€»å…±æœ‰å¤šå°‘ä¸ªå…ƒç´ ï¼Œç”¨æ¥æ§åˆ¶æ‰©å®¹æˆ–è€…è½¬ç§»ä¸ºæ ‘</span></span><br><span class="line">  <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (Node&lt;K, V&gt;[] tab = table; ; ) &#123;</span><br><span class="line">    Node&lt;K, V&gt; f;</span><br><span class="line">    <span class="keyword">int</span> n, i, fh;</span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">      <span class="comment">//ç¬¬ä¸€æ¬¡putçš„æ—¶å€™tableæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–table</span></span><br><span class="line">      tab = initTable();</span><br><span class="line">    <span class="comment">//é€šè¿‡å“ˆå¸Œè®¡ç®—å‡ºä¸€ä¸ªè¡¨ä¸­çš„ä½ç½®å› ä¸ºnæ˜¯æ•°ç»„çš„é•¿åº¦ï¼Œæ‰€ä»¥(n-1)&amp;hashè‚¯å®šä¸ä¼šå‡ºç°æ•°ç»„è¶Šç•Œ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">//å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰å…ƒç´ çš„è¯ï¼Œåˆ™é€šè¿‡casçš„æ–¹å¼å°è¯•æ·»åŠ ï¼Œæ³¨æ„è¿™ä¸ªæ—¶å€™æ˜¯æ²¡æœ‰åŠ é”çš„</span></span><br><span class="line">      <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                   <span class="comment">//åˆ›å»ºä¸€ä¸ªNodeæ·»åŠ åˆ°æ•°ç»„ä¸­åŒºï¼Œnullè¡¨ç¤ºçš„æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©º</span></span><br><span class="line">                   <span class="keyword">new</span> Node&lt;K, V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">        <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * å¦‚æœæ£€æµ‹åˆ°æŸä¸ªèŠ‚ç‚¹çš„hashå€¼æ˜¯MOVEDï¼Œåˆ™è¡¨ç¤ºæ­£åœ¨è¿›è¡Œæ•°ç»„æ‰©å¼ çš„æ•°æ®å¤åˆ¶é˜¶æ®µï¼Œ</span></span><br><span class="line"><span class="comment">                 * åˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¼šå‚ä¸å»å¤åˆ¶ï¼Œé€šè¿‡å…è®¸å¤šçº¿ç¨‹å¤åˆ¶çš„åŠŸèƒ½ï¼Œä¸€æ¬¡æ¥å‡å°‘æ•°ç»„çš„å¤åˆ¶æ‰€å¸¦æ¥çš„æ€§èƒ½æŸå¤±</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">      tab = helpTransfer(tab, f);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * å¦‚æœåœ¨è¿™ä¸ªä½ç½®æœ‰å…ƒç´ çš„è¯ï¼Œå°±é‡‡ç”¨synchronizedçš„æ–¹å¼åŠ é”ï¼Œ</span></span><br><span class="line"><span class="comment">                     *     å¦‚æœæ˜¯é“¾è¡¨çš„è¯(hashå¤§äº0)ï¼Œå°±å¯¹è¿™ä¸ªé“¾è¡¨çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œéå†ï¼Œ</span></span><br><span class="line"><span class="comment">                     *         å¦‚æœæ‰¾åˆ°äº†keyå’Œkeyçš„hashå€¼éƒ½ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œåˆ™æŠŠå®ƒçš„å€¼æ›¿æ¢åˆ°</span></span><br><span class="line"><span class="comment">                     *         å¦‚æœæ²¡æ‰¾åˆ°çš„è¯ï¼Œåˆ™æ·»åŠ åœ¨é“¾è¡¨çš„æœ€åé¢</span></span><br><span class="line"><span class="comment">                     *  å¦åˆ™ï¼Œæ˜¯æ ‘çš„è¯ï¼Œåˆ™è°ƒç”¨putTreeValæ–¹æ³•æ·»åŠ åˆ°æ ‘ä¸­å»</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     *  åœ¨æ·»åŠ å®Œä¹‹åï¼Œä¼šå¯¹è¯¥èŠ‚ç‚¹ä¸Šå…³è”çš„çš„æ•°ç›®è¿›è¡Œåˆ¤æ–­ï¼Œ</span></span><br><span class="line"><span class="comment">                     *  å¦‚æœåœ¨8ä¸ªä»¥ä¸Šçš„è¯ï¼Œåˆ™ä¼šè°ƒç”¨treeifyBinæ–¹æ³•ï¼Œæ¥å°è¯•è½¬åŒ–ä¸ºæ ‘ï¼Œæˆ–è€…æ˜¯æ‰©å®¹</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">      V oldVal = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">        <span class="comment">//å†æ¬¡å–å‡ºè¦å­˜å‚¨çš„ä½ç½®çš„å…ƒç´ ï¼Œè·Ÿå‰é¢å–å‡ºæ¥çš„æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">          <span class="comment">//å–å‡ºæ¥çš„å…ƒç´ çš„hashå€¼å¤§äº0ï¼Œå½“è½¬æ¢ä¸ºæ ‘ä¹‹åï¼Œhashå€¼ä¸º-2</span></span><br><span class="line">          <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            binCount = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//éå†è¿™ä¸ªé“¾è¡¨</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K, V&gt; e = f; ; ++binCount) &#123;</span><br><span class="line">              K ek;</span><br><span class="line">              <span class="comment">//è¦å­˜çš„å…ƒç´ çš„hashï¼Œkeyè·Ÿè¦å­˜å‚¨çš„ä½ç½®çš„èŠ‚ç‚¹çš„ç›¸åŒçš„æ—¶å€™ï¼Œæ›¿æ¢æ‰è¯¥èŠ‚ç‚¹çš„valueå³å¯</span></span><br><span class="line">              <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                  ((ek = e.key) == key ||</span><br><span class="line">                   (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                oldVal = e.val;</span><br><span class="line">                <span class="comment">//å½“ä½¿ç”¨putIfAbsentçš„æ—¶å€™ï¼Œåªæœ‰åœ¨è¿™ä¸ªkeyæ²¡æœ‰è®¾ç½®å€¼å¾—æ—¶å€™æ‰è®¾ç½®</span></span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                  e.val = value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              Node&lt;K, V&gt; pred = e;</span><br><span class="line">              <span class="comment">//å¦‚æœä¸æ˜¯åŒæ ·çš„hashï¼ŒåŒæ ·çš„keyçš„æ—¶å€™ï¼Œåˆ™åˆ¤æ–­è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œ</span></span><br><span class="line">              <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//ä¸ºç©ºçš„è¯æŠŠè¿™ä¸ªè¦åŠ å…¥çš„èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                pred.next = <span class="keyword">new</span> Node&lt;K, V&gt;(hash, key,</span><br><span class="line">                                           value, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¡¨ç¤ºå·²ç»è½¬åŒ–æˆçº¢é»‘æ ‘ç±»å‹äº†</span></span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">            Node&lt;K, V&gt; p;</span><br><span class="line">            binCount = <span class="number">2</span>;</span><br><span class="line">            <span class="comment">//è°ƒç”¨putTreeValæ–¹æ³•ï¼Œå°†è¯¥å…ƒç´ æ·»åŠ åˆ°æ ‘ä¸­å»</span></span><br><span class="line">            <span class="keyword">if</span> ((p = ((TreeBin&lt;K, V&gt;) f).putTreeVal(hash, key,</span><br><span class="line">                                                    value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">              oldVal = p.val;</span><br><span class="line">              <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                p.val = value;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å½“åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹çš„æ•°ç›®è¾¾åˆ°8ä¸ªçš„æ—¶å€™ï¼Œåˆ™æ‰©å¼ æ•°ç»„æˆ–å°†ç»™èŠ‚ç‚¹çš„æ•°æ®è½¬ä¸ºtree</span></span><br><span class="line">        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">          treeifyBin(tab, i);</span><br><span class="line">        <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">return</span> oldVal;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  addCount(<span class="number">1L</span>, binCount);    <span class="comment">//è®¡æ•°</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£"><a href="#ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£" class="headerlink" title="ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£"></a><strong>ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£</strong></h3><p>åœ¨putæ–¹æ³•çš„è¯¦è§£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹çš„ä¸ªæ•°è¶…è¿‡8ä¸ªçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨treeifyBinæ–¹æ³•æ¥çœ‹çœ‹æ˜¯æ‰©å®¹è¿˜æ˜¯è½¬åŒ–ä¸ºä¸€æ£µæ ‘ï¼ŒåŒæ—¶åœ¨æ¯æ¬¡æ·»åŠ å®Œå…ƒç´ çš„addCountæ–¹æ³•ä¸­ï¼Œä¹Ÿä¼šåˆ¤æ–­å½“å‰æ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¦è¾¾åˆ°äº†sizeCtlçš„é‡ï¼Œå¦‚æœè¾¾åˆ°äº†çš„è¯ï¼Œåˆ™ä¼šè¿›å…¥transferæ–¹æ³•å»æ‰©å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Replaces all linked nodes in bin at given index unless table is</span></span><br><span class="line"><span class="comment">     * too small, in which case resizes instead.</span></span><br><span class="line"><span class="comment">     * å½“æ•°ç»„é•¿åº¦å°äº64çš„æ—¶å€™ï¼Œæ‰©å¼ æ•°ç»„é•¿åº¦ä¸€å€ï¼Œå¦åˆ™çš„è¯æŠŠé“¾è¡¨è½¬ä¸ºæ ‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">  <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;treeifyBinæ–¹\t==&gt;æ•°ç»„é•¿ï¼š&quot;</span>+tab.length);</span><br><span class="line">    <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)    <span class="comment">//MIN_TREEIFY_CAPACITY 64</span></span><br><span class="line">      tryPresize(n &lt;&lt; <span class="number">1</span>);        <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (b) &#123;    <span class="comment">//ä½¿ç”¨synchronizedåŒæ­¥å™¨ï¼Œå°†è¯¥èŠ‚ç‚¹å‡ºçš„é“¾è¡¨è½¬ä¸ºæ ‘</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">          TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;    <span class="comment">//hdï¼šæ ‘çš„å¤´(head)</span></span><br><span class="line">          <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; p =</span><br><span class="line">              <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)        <span class="comment">//æŠŠNodeç»„æˆçš„é“¾è¡¨ï¼Œè½¬åŒ–ä¸ºTreeNodeçš„é“¾è¡¨ï¼Œå¤´ç»“ç‚¹ä»»ç„¶æ”¾åœ¨ç›¸åŒçš„ä½ç½®</span></span><br><span class="line">              hd = p;    <span class="comment">//è®¾ç½®head</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              tl.next = p;</span><br><span class="line">            tl = p;</span><br><span class="line">          &#125;</span><br><span class="line">          setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));<span class="comment">//æŠŠTreeNodeçš„é“¾è¡¨æ”¾å…¥å®¹å™¨TreeBinä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å½“éœ€è¦æ‰©å®¹çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ—¶å€™tryPresizeæ–¹æ³•ï¼Œçœ‹çœ‹trePresizeçš„æºç </p>
<h3 id="trePresizeçš„æºç "><a href="#trePresizeçš„æºç " class="headerlink" title="trePresizeçš„æºç "></a>trePresizeçš„æºç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰©å®¹è¡¨ä¸ºæŒ‡å¯ä»¥å®¹çº³æŒ‡å®šä¸ªæ•°çš„å¤§å°ï¼ˆæ€»æ˜¯2çš„Næ¬¡æ–¹ï¼‰</span></span><br><span class="line"><span class="comment">     * å‡è®¾åŸæ¥çš„æ•°ç»„é•¿åº¦ä¸º16ï¼Œåˆ™åœ¨è°ƒç”¨tryPresizeçš„æ—¶å€™ï¼Œsizeå‚æ•°çš„å€¼ä¸º16&lt;&lt;1(32)ï¼Œæ­¤æ—¶sizeCtlçš„å€¼ä¸º12</span></span><br><span class="line"><span class="comment">     * è®¡ç®—å‡ºæ¥cçš„å€¼ä¸º64,åˆ™è¦æ‰©å®¹åˆ°sizeCtlâ‰¥ä¸ºæ­¢</span></span><br><span class="line"><span class="comment">     *  ç¬¬ä¸€æ¬¡æ‰©å®¹ä¹‹å æ•°ç»„é•¿ï¼š32 sizeCtlï¼š24</span></span><br><span class="line"><span class="comment">     *  ç¬¬äºŒæ¬¡æ‰©å®¹ä¹‹å æ•°ç»„é•¿ï¼š64 sizeCtlï¼š48</span></span><br><span class="line"><span class="comment">     *  ç¬¬äºŒæ¬¡æ‰©å®¹ä¹‹å æ•°ç»„é•¿ï¼š128 sizeCtlï¼š94 --&gt; è¿™ä¸ªæ—¶å€™æ‰ä¼šé€€å‡ºæ‰©å®¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * MAXIMUM_CAPACITY = 1 &lt;&lt; 30</span></span><br><span class="line"><span class="comment">             * å¦‚æœç»™å®šçš„å¤§å°å¤§äºç­‰äºæ•°ç»„å®¹é‡çš„ä¸€åŠï¼Œåˆ™ç›´æ¥ä½¿ç”¨æœ€å¤§å®¹é‡ï¼Œ</span></span><br><span class="line"><span class="comment">             * å¦åˆ™ä½¿ç”¨tableSizeForç®—å‡ºæ¥</span></span><br><span class="line"><span class="comment">             * åé¢tableä¸€ç›´è¦æ‰©å®¹åˆ°è¿™ä¸ªå€¼å°äºç­‰äºsizeCtrl(æ•°ç»„é•¿åº¦çš„3/4)æ‰é€€å‡ºæ‰©å®¹</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">  <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">  tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">int</span> sc;</span><br><span class="line">  <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">    <span class="comment">//            printTable(tab);    è°ƒè¯•ç”¨çš„</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * å¦‚æœæ•°ç»„tableè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªå¤§å°ä¸ºsizeCtrlå’Œåˆšåˆšç®—å‡ºæ¥çš„cä¸­è¾ƒå¤§çš„ä¸€ä¸ªå¤§å°çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">             * åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè®¾ç½®sizeCtrlä¸º-1ï¼Œåˆå§‹åŒ–å®Œæˆä¹‹åæŠŠsizeCtrlè®¾ç½®ä¸ºæ•°ç»„é•¿åº¦çš„3/4</span></span><br><span class="line"><span class="comment">             * ä¸ºä»€ä¹ˆè¦åœ¨æ‰©å¼ çš„åœ°æ–¹æ¥åˆå§‹åŒ–æ•°ç»„å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå¦‚æœç¬¬ä¸€æ¬¡putçš„æ—¶å€™ä¸æ˜¯putå•ä¸ªå…ƒç´ ï¼Œ</span></span><br><span class="line"><span class="comment">             * è€Œæ˜¯è°ƒç”¨putAllæ–¹æ³•ç›´æ¥putä¸€ä¸ªmapçš„è¯ï¼Œåœ¨putALlæ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨initTableæ–¹æ³•å»åˆå§‹åŒ–tableï¼Œ</span></span><br><span class="line"><span class="comment">             * è€Œæ˜¯ç›´æ¥è°ƒç”¨äº†tryPresizeæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åšä¸€ä¸ªæ˜¯ä¸æ˜¯éœ€è¦åˆå§‹åŒ–tableçš„åˆ¤æ–­</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">      n = (sc &gt; c) ? sc : c;</span><br><span class="line">      <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;    <span class="comment">//åˆå§‹åŒ–tabçš„æ—¶å€™ï¼ŒæŠŠsizeCtlè®¾ä¸º-1</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">            table = nt;</span><br><span class="line">            sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          sizeCtl = sc;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ä¸€ç›´æ‰©å®¹åˆ°çš„cå°äºç­‰äºsizeCtlæˆ–è€…æ•°ç»„é•¿åº¦å¤§äºæœ€å¤§é•¿åº¦çš„æ—¶å€™ï¼Œåˆ™é€€å‡º</span></span><br><span class="line"><span class="comment">             * æ‰€ä»¥åœ¨ä¸€æ¬¡æ‰©å®¹ä¹‹åï¼Œä¸æ˜¯åŸæ¥é•¿åº¦çš„ä¸¤å€ï¼Œè€Œæ˜¯2çš„næ¬¡æ–¹å€</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">      <span class="keyword">break</span>;    <span class="comment">//é€€å‡ºæ‰©å¼ </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">      <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * å¦‚æœæ­£åœ¨æ‰©å®¹Tableçš„è¯ï¼Œåˆ™å¸®åŠ©æ‰©å®¹</span></span><br><span class="line"><span class="comment">                 * å¦åˆ™çš„è¯ï¼Œå¼€å§‹æ–°çš„æ‰©å®¹</span></span><br><span class="line"><span class="comment">                 * åœ¨transferæ“ä½œï¼Œå°†ç¬¬ä¸€ä¸ªå‚æ•°çš„tableä¸­çš„å…ƒç´ ï¼Œç§»åŠ¨åˆ°ç¬¬äºŒä¸ªå…ƒç´ çš„tableä¸­å»ï¼Œ</span></span><br><span class="line"><span class="comment">                 * è™½ç„¶æ­¤æ—¶ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®çš„æ˜¯nullï¼Œä½†æ˜¯ï¼Œåœ¨transferæ–¹æ³•ä¸­ï¼Œå½“ç¬¬äºŒä¸ªå‚æ•°ä¸ºnullçš„æ—¶å€™ï¼Œ</span></span><br><span class="line"><span class="comment">                 * ä¼šåˆ›å»ºä¸€ä¸ªä¸¤å€å¤§å°çš„table</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] nt;</span><br><span class="line">        <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">            sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">            transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * transferçš„çº¿ç¨‹æ•°åŠ ä¸€,è¯¥çº¿ç¨‹å°†è¿›è¡Œtransferçš„å¸®å¿™</span></span><br><span class="line"><span class="comment">                     * åœ¨transferçš„æ—¶å€™ï¼Œscè¡¨ç¤ºåœ¨transferå·¥ä½œçš„çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">        <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">          transfer(tab, nt);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * æ²¡æœ‰åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹ï¼Œåˆ™å¼€å§‹æ‰©å®¹</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                   (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>)) &#123;</span><br><span class="line">        transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨tryPresizeæ–¹æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰åŠ é”ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹è¿›å…¥ï¼Œå¦‚æœæ•°ç»„æ­£åœ¨æ‰©å¼ ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿå»å¸®åŠ©æ‰©å®¹ã€‚</p>
<h3 id="transferæ–¹æ³•"><a href="#transferæ–¹æ³•" class="headerlink" title="transferæ–¹æ³•"></a>transferæ–¹æ³•</h3><p>æ•°ç»„æ‰©å®¹çš„ä¸»è¦æ–¹æ³•å°±æ˜¯transferæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Moves and/or copies the nodes in each bin to new table. See</span></span><br><span class="line"><span class="comment">     * above for explanation.</span></span><br><span class="line"><span class="comment">     * æŠŠæ•°ç»„ä¸­çš„èŠ‚ç‚¹å¤åˆ¶åˆ°æ–°çš„æ•°ç»„çš„ç›¸åŒä½ç½®ï¼Œæˆ–è€…ç§»åŠ¨åˆ°æ‰©å¼ éƒ¨åˆ†çš„ç›¸åŒä½ç½®</span></span><br><span class="line"><span class="comment">     * åœ¨è¿™é‡Œé¦–å…ˆä¼šè®¡ç®—ä¸€ä¸ªæ­¥é•¿ï¼Œè¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹å¤„ç†çš„æ•°ç»„é•¿åº¦ï¼Œç”¨æ¥æ§åˆ¶å¯¹CPUçš„ä½¿ç”¨ï¼Œ</span></span><br><span class="line"><span class="comment">     * æ¯ä¸ªCPUæœ€å°‘å¤„ç†16ä¸ªé•¿åº¦çš„æ•°ç»„å…ƒç´ ,ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªæ•°ç»„çš„é•¿åº¦åªæœ‰16ï¼Œé‚£åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹å…¶è¿›è¡Œæ‰©å®¹çš„å¤åˆ¶ç§»åŠ¨æ“ä½œ</span></span><br><span class="line"><span class="comment">     * æ‰©å®¹çš„æ—¶å€™ä¼šä¸€ç›´éå†ï¼ŒçŸ¥é“å¤åˆ¶å®Œæ‰€æœ‰èŠ‚ç‚¹ï¼Œæ²¡å¤„ç†ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ä¼šåœ¨é“¾è¡¨çš„å¤´éƒ¨è®¾ç½®ä¸€ä¸ªfwdèŠ‚ç‚¹ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹å°±ä¼šè·³è¿‡ä»–ï¼Œ</span></span><br><span class="line"><span class="comment">     * å¤åˆ¶ååœ¨æ–°æ•°ç»„ä¸­çš„é“¾è¡¨ä¸æ˜¯ç»å¯¹çš„ååºçš„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">  <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)    <span class="comment">//MIN_TRANSFER_STRIDE ç”¨æ¥æ§åˆ¶ä¸è¦å ç”¨å¤ªå¤šCPU</span></span><br><span class="line">    stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range    //MIN_TRANSFER_STRIDE=16</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å¦‚æœå¤åˆ¶çš„ç›®æ ‡nextTabä¸ºnullçš„è¯ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªtableä¸¤å€é•¿çš„nextTab</span></span><br><span class="line"><span class="comment">         * æ­¤æ—¶nextTableè¢«è®¾ç½®å€¼äº†(åœ¨åˆå§‹æƒ…å†µä¸‹æ˜¯ä¸ºnullçš„)</span></span><br><span class="line"><span class="comment">         * å› ä¸ºå¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹å¼€å§‹äº†è¡¨çš„æ‰©å¼ çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¼šè¿›æ¥å¸®å¿™æ‰©å¼ ï¼Œ</span></span><br><span class="line"><span class="comment">         * è€Œåªæ˜¯ç¬¬ä¸€ä¸ªå¼€å§‹æ‰©å¼ çš„çº¿ç¨‹éœ€è¦åˆå§‹åŒ–ä¸‹ç›®æ ‡æ•°ç»„</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">      Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">      nextTab = nt;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">      sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nextTable = nextTab;</span><br><span class="line">    transferIndex = n;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * åˆ›å»ºä¸€ä¸ªfwdèŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥æ§åˆ¶å¹¶å‘çš„ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–å·²ç»è¢«è½¬ç§»ä¹‹åï¼Œå°±è®¾ç½®ä¸ºfwdèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * è¿™æ˜¯ä¸€ä¸ªç©ºçš„æ ‡å¿—èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">  <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;    <span class="comment">//æ˜¯å¦ç»§ç»­å‘å‰æŸ¥æ‰¾çš„æ ‡å¿—ä½</span></span><br><span class="line">  <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep(æ¸…æ‰«) before committing nextTab,åœ¨å®Œæˆä¹‹å‰é‡æ–°åœ¨æ‰«æä¸€éæ•°ç»„ï¼Œçœ‹çœ‹æœ‰æ²¡å®Œæˆçš„æ²¡</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">    Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">    <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">      <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">      <span class="keyword">if</span> (--i &gt;= bound || finishing) &#123;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        i = -<span class="number">1</span>;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">               (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                             nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">        bound = nextBound;</span><br><span class="line">        i = nextIndex - <span class="number">1</span>;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">      <span class="keyword">int</span> sc;</span><br><span class="line">      <span class="keyword">if</span> (finishing) &#123;        <span class="comment">//å·²ç»å®Œæˆè½¬ç§»</span></span><br><span class="line">        nextTable = <span class="keyword">null</span>;</span><br><span class="line">        table = nextTab;</span><br><span class="line">        sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);    <span class="comment">//è®¾ç½®sizeCtlä¸ºæ‰©å®¹åçš„0.75</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">        i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)            <span class="comment">//æ•°ç»„ä¸­æŠŠnullçš„å…ƒç´ è®¾ç½®ä¸ºForwardingNodeèŠ‚ç‚¹(hashå€¼ä¸ºMOVED[-1])</span></span><br><span class="line">      advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">      advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (f) &#123;                <span class="comment">//åŠ é”æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">          Node&lt;K,V&gt; ln, hn;</span><br><span class="line">          <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;        <span class="comment">//è¯¥èŠ‚ç‚¹çš„hashå€¼å¤§äºç­‰äº0ï¼Œè¯´æ˜æ˜¯ä¸€ä¸ªNodeèŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                 * å› ä¸ºnçš„å€¼ä¸ºæ•°ç»„çš„é•¿åº¦ï¼Œä¸”æ˜¯power(2,x)çš„ï¼Œæ‰€ä»¥ï¼Œåœ¨&amp;æ“ä½œçš„ç»“æœåªå¯èƒ½æ˜¯0æˆ–è€…n</span></span><br><span class="line"><span class="comment">                                 * æ ¹æ®è¿™ä¸ªè§„åˆ™</span></span><br><span class="line"><span class="comment">                                 *         0--&gt;  æ”¾åœ¨æ–°è¡¨çš„ç›¸åŒä½ç½®</span></span><br><span class="line"><span class="comment">                                 *         n--&gt;  æ”¾åœ¨æ–°è¡¨çš„ï¼ˆn+åŸæ¥ä½ç½®ï¼‰</span></span><br><span class="line"><span class="comment">                                 */</span></span><br><span class="line">            <span class="keyword">int</span> runBit = fh &amp; n; </span><br><span class="line">            Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             * lastRun è¡¨ç¤ºçš„æ˜¯éœ€è¦å¤åˆ¶çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                             * æ¯å½“æ–°èŠ‚ç‚¹çš„hash&amp;n -&gt; b å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå°±æŠŠrunBitè®¾ç½®ä¸ºè¿™ä¸ªç»“æœb</span></span><br><span class="line"><span class="comment">                             * è¿™æ ·forå¾ªç¯ä¹‹åï¼ŒrunBitçš„å€¼å°±æ˜¯æœ€åä¸å˜çš„hash&amp;nçš„å€¼</span></span><br><span class="line"><span class="comment">                             * è€ŒlastRunçš„å€¼å°±æ˜¯æœ€åä¸€æ¬¡å¯¼è‡´hash&amp;n å‘ç”Ÿå˜åŒ–çš„èŠ‚ç‚¹(å‡è®¾ä¸ºpèŠ‚ç‚¹)</span></span><br><span class="line"><span class="comment">                             * ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºpèŠ‚ç‚¹åé¢çš„èŠ‚ç‚¹çš„hash&amp;n å€¼è·ŸpèŠ‚ç‚¹æ˜¯ä¸€æ ·çš„ï¼Œ</span></span><br><span class="line"><span class="comment">                             * æ‰€ä»¥åœ¨å¤åˆ¶åˆ°æ–°çš„tableçš„æ—¶å€™ï¼Œå®ƒè‚¯å®šè¿˜æ˜¯è·ŸpèŠ‚ç‚¹åœ¨åŒä¸€ä¸ªä½ç½®</span></span><br><span class="line"><span class="comment">                             * åœ¨å¤åˆ¶å®ŒpèŠ‚ç‚¹ä¹‹åï¼ŒpèŠ‚ç‚¹çš„nextèŠ‚ç‚¹è¿˜æ˜¯æŒ‡å‘å®ƒåŸæ¥çš„èŠ‚ç‚¹ï¼Œå°±ä¸éœ€è¦è¿›è¡Œå¤åˆ¶äº†ï¼Œè‡ªå·±å°±è¢«å¸¦è¿‡å»äº†</span></span><br><span class="line"><span class="comment">                             * è¿™ä¹Ÿå°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¤åˆ¶åçš„é“¾è¡¨çš„é¡ºåºå¹¶ä¸ä¸€å®šæ˜¯åŸæ¥çš„å€’åº</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">              <span class="keyword">int</span> b = p.hash &amp; n;    <span class="comment">//nçš„å€¼ä¸ºæ‰©å¼ å‰çš„æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">              <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                runBit = b;</span><br><span class="line">                lastRun = p;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">              ln = lastRun;</span><br><span class="line">              hn = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">              hn = lastRun;</span><br><span class="line">              ln = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             * æ„é€ ä¸¤ä¸ªé“¾è¡¨ï¼Œé¡ºåºå¤§éƒ¨åˆ†å’ŒåŸæ¥æ˜¯åçš„</span></span><br><span class="line"><span class="comment">                             * åˆ†åˆ«æ”¾åˆ°åŸæ¥çš„ä½ç½®å’Œæ–°å¢åŠ çš„é•¿åº¦çš„ç›¸åŒä½ç½®(i/n+i)</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">              <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">              <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                         * å‡è®¾runBitçš„å€¼ä¸º0ï¼Œ</span></span><br><span class="line"><span class="comment">                                         * åˆ™ç¬¬ä¸€æ¬¡è¿›å…¥è¿™ä¸ªè®¾ç½®çš„æ—¶å€™ç›¸å½“äºæŠŠæ—§çš„åºåˆ—çš„æœ€åä¸€æ¬¡å‘ç”Ÿhashå˜åŒ–çš„èŠ‚ç‚¹(è¯¥èŠ‚ç‚¹åé¢å¯èƒ½è¿˜æœ‰hashè®¡ç®—ååŒä¸º0çš„èŠ‚ç‚¹)è®¾ç½®åˆ°æ—§çš„tableçš„ç¬¬ä¸€ä¸ªhashè®¡ç®—åä¸º0çš„èŠ‚ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         * å¹¶ä¸”æŠŠè‡ªå·±è¿”å›ï¼Œç„¶ååœ¨ä¸‹æ¬¡è¿›æ¥çš„æ—¶å€™æŠŠå®ƒè‡ªå·±è®¾ç½®ä¸ºåé¢èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         */</span></span><br><span class="line">                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                         * å‡è®¾runBitçš„å€¼ä¸ä¸º0ï¼Œ</span></span><br><span class="line"><span class="comment">                                         * åˆ™ç¬¬ä¸€æ¬¡è¿›å…¥è¿™ä¸ªè®¾ç½®çš„æ—¶å€™ç›¸å½“äºæŠŠæ—§çš„åºåˆ—çš„æœ€åä¸€æ¬¡å‘ç”Ÿhashå˜åŒ–çš„èŠ‚ç‚¹(è¯¥èŠ‚ç‚¹åé¢å¯èƒ½è¿˜æœ‰hashè®¡ç®—ååŒä¸ä¸º0çš„èŠ‚ç‚¹)è®¾ç½®åˆ°æ—§çš„tableçš„ç¬¬ä¸€ä¸ªhashè®¡ç®—åä¸ä¸º0çš„èŠ‚ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         * å¹¶ä¸”æŠŠè‡ªå·±è¿”å›ï¼Œç„¶ååœ¨ä¸‹æ¬¡è¿›æ¥çš„æ—¶å€™æŠŠå®ƒè‡ªå·±è®¾ç½®ä¸ºåé¢èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         */</span></span><br><span class="line">                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);    </span><br><span class="line">            &#125;</span><br><span class="line">            setTabAt(nextTab, i, ln);    </span><br><span class="line">            setTabAt(nextTab, i + n, hn);</span><br><span class="line">            setTabAt(tab, i, fwd);</span><br><span class="line">            advance = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;    <span class="comment">//å¦åˆ™çš„è¯æ˜¯ä¸€ä¸ªæ ‘èŠ‚ç‚¹</span></span><br><span class="line">            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">            TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">            TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">              <span class="keyword">int</span> h = e.hash;</span><br><span class="line">              TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">              <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                  lo = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                  loTail.next = p;</span><br><span class="line">                loTail = p;</span><br><span class="line">                ++lc;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                  hi = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                  hiTail.next = p;</span><br><span class="line">                hiTail = p;</span><br><span class="line">                ++hc;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             * åœ¨å¤åˆ¶å®Œæ ‘èŠ‚ç‚¹ä¹‹åï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹å¤„æ„æˆçš„æ ‘è¿˜æœ‰å‡ ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line"><span class="comment">                             * å¦‚æœâ‰¤6ä¸ªçš„è¯ï¼Œå°±è½¬å›ä¸ºä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">            setTabAt(nextTab, i, ln);</span><br><span class="line">            setTabAt(nextTab, i + n, hn);</span><br><span class="line">            setTabAt(tab, i, fwd);</span><br><span class="line">            advance = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œï¼ŒConcurrentHashMapçš„putæ“ä½œå’Œæ‰©å®¹éƒ½ä»‹ç»çš„å·®ä¸å¤šäº†ï¼Œ</p>
<p>ä¸‹é¢çš„ä¸¤ç‚¹ä¸€å®šè¦æ³¨æ„ï¼š</p>
<p>1ã€å¤åˆ¶ä¹‹åçš„æ–°é“¾è¡¨ä¸æ˜¯æ—§é“¾è¡¨çš„ç»å¯¹å€’åº</p>
<p>2ã€åœ¨æ‰©å®¹çš„æ—¶å€™æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å¤„ç†çš„æ­¥é•¿ï¼Œæœ€å°‘ä¸º16ï¼Œåœ¨è¿™ä¸ªæ­¥é•¿èŒƒå›´å†…çš„æ•°ç»„èŠ‚ç‚¹åªæœ‰è‡ªå·±ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†</p>
<h3 id="ConcurrentHashMapçš„getæ“ä½œè¯¦è§£"><a href="#ConcurrentHashMapçš„getæ“ä½œè¯¦è§£" class="headerlink" title="ConcurrentHashMapçš„getæ“ä½œè¯¦è§£"></a><strong>ConcurrentHashMapçš„getæ“ä½œè¯¦è§£</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ç›¸æ¯”putæ–¹æ³•ï¼Œgetå°±å¾ˆå•çº¯äº†ï¼Œæ”¯æŒå¹¶å‘æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment">     * å½“keyä¸ºnullçš„æ—¶å€™å›æŠ›å‡ºNullPointerExceptionçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * getæ“ä½œé€šè¿‡é¦–å…ˆè®¡ç®—keyçš„hashå€¼æ¥ç¡®å®šè¯¥å…ƒç´ æ”¾åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®</span></span><br><span class="line"><span class="comment">     * ç„¶åéå†è¯¥ä½ç½®çš„æ‰€æœ‰èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸å­˜åœ¨çš„è¯è¿”å›null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">  <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">  <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">      (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">        <span class="keyword">return</span> e.val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">          ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">        <span class="keyword">return</span> e.val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹"><a href="#é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹" class="headerlink" title="é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹"></a><strong>é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹</strong></h3><p>å‰é¢åœ¨è®²è§£tryifyBinçš„æºç çš„æ—¶å€™è®²åˆ°è¿‡ï¼Œå¦‚æœåœ¨å½“ä¸ªbinä¸Šçš„å…ƒç´ è¶…è¿‡äº†8ä¸ªçš„æ—¶å€™ï¼Œå°±ä¼šå°è¯•å»æ‰©å®¹æ•°ç»„æˆ–è€…æ˜¯å°†é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘ã€‚</p>
<p>æºç ï¼šğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">  <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)    <span class="comment">//MIN_TREEIFY_CAPACITY 64</span></span><br><span class="line">      tryPresize(n &lt;&lt; <span class="number">1</span>);        <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//ä½¿ç”¨synchronizedåŒæ­¥å™¨ï¼Œå°†è¯¥èŠ‚ç‚¹å‡ºçš„é“¾è¡¨è½¬ä¸ºæ ‘</span></span><br><span class="line">      <span class="keyword">synchronized</span> (b) &#123;   </span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">          TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;    <span class="comment">//hdï¼šæ ‘çš„å¤´(head)</span></span><br><span class="line">          <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; p =</span><br><span class="line">              <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//æŠŠNodeç»„æˆçš„é“¾è¡¨ï¼Œè½¬åŒ–ä¸ºTreeNodeçš„é“¾è¡¨ï¼Œå¤´ç»“ç‚¹ä»»ç„¶æ”¾åœ¨ç›¸åŒçš„ä½ç½®</span></span><br><span class="line">            <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)        </span><br><span class="line">              hd = p;    <span class="comment">//è®¾ç½®head</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              tl.next = p;</span><br><span class="line">            tl = p;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//æŠŠTreeNodeçš„é“¾è¡¨æ”¾å…¥å®¹å™¨TreeBin</span></span><br><span class="line">          setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));ä¸­</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå°†Nodeçš„é“¾è¡¨è½¬åŒ–ä¸ºä¸€ä¸ªTreeNodeçš„é“¾è¡¨ï¼Œç„¶åå°†TreeNodeé“¾è¡¨çš„å¤´ç»“ç‚¹æ¥æ„é€ ä¸€ä¸ªTreeBinã€‚ä¸‹é¢æ˜¯TreeBinæ„é€ æ–¹æ³•çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">  <span class="comment">//åˆ›å»ºçš„TreeBinæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œhashå€¼ä¸ºTREEBINï¼ˆ-2ï¼‰</span></span><br><span class="line">  <span class="keyword">super</span>(TREEBIN, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);    </span><br><span class="line">  <span class="keyword">this</span>.first = b;</span><br><span class="line">  TreeNode&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = b, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">    next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">    x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">      x.parent = <span class="keyword">null</span>;</span><br><span class="line">      x.red = <span class="keyword">false</span>;</span><br><span class="line">      r = x;</span><br><span class="line">    &#125;<span class="comment">//</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      K k = x.key;</span><br><span class="line">      <span class="keyword">int</span> h = x.hash;</span><br><span class="line">      Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">//xä»£è¡¨çš„æ˜¯è½¬æ¢ä¸ºæ ‘ä¹‹å‰çš„é¡ºåºéå†åˆ°é“¾è¡¨çš„ä½ç½®çš„èŠ‚ç‚¹ï¼Œrä»£è¡¨çš„æ˜¯æ ¹èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> dir, ph;</span><br><span class="line">        K pk = p.key;</span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)    <span class="comment">//</span></span><br><span class="line">          dir = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">          dir = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                  (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                 (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">          <span class="comment">//å½“keyä¸å¯ä»¥æ¯”è¾ƒï¼Œæˆ–è€…ç›¸ç­‰çš„æ—¶å€™é‡‡å–çš„ä¸€ç§æ’åºæªæ–½</span></span><br><span class="line">          dir = tieBreakOrder(k, pk);   </span><br><span class="line">        TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œåˆ¤æ–­è¦æ”¾çš„left/rightæ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºç»§ç»­ç”¨left/rightèŠ‚ç‚¹æ¥åˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">          x.parent = xp;</span><br><span class="line">          <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">            xp.left = x;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            xp.right = x;</span><br><span class="line">          <span class="comment">//æ¯æ¬¡æ’å…¥ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™éƒ½è°ƒç”¨balanceInsertionæ¥ä¿æŒçº¢é»‘æ ‘çš„å¹³è¡¡</span></span><br><span class="line">          r = balanceInsertion(r, x); </span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.root = r;</span><br><span class="line">  <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶"><a href="#ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶" class="headerlink" title="ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶"></a>ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶</h2><p>å‰é¢åˆ†æäº†ä¸‹ConcurrentHashMapçš„æºç ï¼Œé‚£ä¹ˆï¼Œå¯¹äºä¸€ä¸ªæ˜ å°„é›†åˆæ¥è¯´ï¼ŒConcurrentHashMapæ˜¯å¦‚æœæ¥åšåˆ°å¹¶å‘å®‰å…¨ï¼Œåˆæ˜¯å¦‚ä½•åšåˆ°é«˜æ•ˆçš„å¹¶å‘çš„å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆæ˜¯è¯»æ“ä½œï¼Œä»æºç ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨getæ“ä½œä¸­ï¼Œæ ¹æœ¬æ²¡æœ‰ä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨unsafeæ–¹æ³•ï¼Œæ‰€ä»¥è¯»æ“ä½œæ˜¯æ”¯æŒå¹¶å‘æ“ä½œçš„ã€‚é‚£ä¹ˆå†™æ“ä½œå‘¢ï¼Ÿ</p>
<p>åˆ†æè¿™ä¸ªä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¼•èµ·æ•°ç»„çš„æ‰©å®¹ï¼Œæ‰©å®¹æ˜¯é€šè¿‡transferæ–¹æ³•æ¥è¿›è¡Œçš„ã€‚è€Œè°ƒç”¨transferæ–¹æ³•çš„åªæœ‰<code>trePresize</code>ã€<code>helpTransfer</code>å’Œ<code>addCount</code>ä¸‰ä¸ªæ–¹æ³•ã€‚</p>
<p>è¿™ä¸‰ä¸ªæ–¹æ³•åˆæ˜¯åˆ†åˆ«åœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¿›è¡Œè°ƒç”¨çš„å‘¢ï¼Ÿ</p>
<p>tryPresizeæ˜¯åœ¨treeIfybinå’ŒputAllæ–¹æ³•ä¸­è°ƒç”¨ï¼ŒtreeIfybinä¸»è¦æ˜¯åœ¨putæ·»åŠ å…ƒç´ å®Œä¹‹åï¼Œåˆ¤æ–­è¯¥æ•°ç»„èŠ‚ç‚¹ç›¸å…³å…ƒç´ æ˜¯ä¸æ˜¯å·²ç»è¶…è¿‡8ä¸ªçš„æ—¶å€™ï¼Œå¦‚æœè¶…è¿‡åˆ™ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥æ‰©å®¹æ•°ç»„æˆ–è€…æŠŠé“¾è¡¨è½¬ä¸ºæ ‘ã€‚</p>
<p>helpTransferæ˜¯åœ¨å½“ä¸€ä¸ªçº¿ç¨‹è¦å¯¹tableä¸­å…ƒç´ è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹åˆ°èŠ‚ç‚¹çš„HASHå€¼ä¸ºMOVEDçš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨helpTransferæ–¹æ³•ï¼Œåœ¨helpTransferä¸­å†è°ƒç”¨transferæ–¹æ³•æ¥å¸®åŠ©å®Œæˆæ•°ç»„çš„æ‰©å®¹</p>
<p>addCountæ˜¯åœ¨å½“å¯¹æ•°ç»„è¿›è¡Œæ“ä½œï¼Œä½¿å¾—æ•°ç»„ä¸­å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°å‘ç”Ÿäº†å˜åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨çš„æ–¹æ³•ã€‚</p>
<p><strong>æ‰€ä»¥å¼•èµ·æ•°ç»„æ‰©å®¹çš„æƒ…å†µå¦‚ä¸‹</strong>ï¼š</p>
<p>1ã€åªæœ‰åœ¨å¾€mapä¸­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œåœ¨æŸä¸€ä¸ªèŠ‚ç‚¹çš„æ•°ç›®å·²ç»è¶…è¿‡äº†8ä¸ªï¼ŒåŒæ—¶æ•°ç»„çš„é•¿åº¦åˆå°äº64çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘æ•°ç»„çš„æ‰©å®¹ã€‚</p>
<p>2ã€å½“æ•°ç»„ä¸­å…ƒç´ è¾¾åˆ°äº†sizeCtlçš„æ•°é‡çš„æ—¶å€™ï¼Œåˆ™ä¼šè°ƒç”¨transferæ–¹æ³•æ¥è¿›è¡Œæ‰©å®¹</p>
<p><strong>é‚£ä¹ˆåœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œå¯ä»¥ä¸å¯ä»¥å¯¹æ•°ç»„è¿›è¡Œè¯»å†™æ“ä½œå‘¢ï¼Ÿ</strong></p>
<p>äº‹å®ä¸Šæ˜¯å¯ä»¥çš„ã€‚å½“åœ¨è¿›è¡Œæ•°ç»„æ‰©å®¹çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹è¿˜æ²¡æœ‰è¢«å¤„ç†ï¼ˆä¹Ÿå°±æ˜¯è¯´è¿˜æ²¡æœ‰è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼‰ï¼Œé‚£å°±å¯ä»¥è¿›è¡Œè®¾ç½®æ“ä½œã€‚å¦‚æœè¯¥èŠ‚ç‚¹å·²ç»è¢«å¤„ç†äº†ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¼šåŠ å…¥åˆ°æ‰©å®¹çš„æ“ä½œä¸­å»ã€‚</p>
<p><strong>é‚£ä¹ˆï¼Œå¤šä¸ªçº¿ç¨‹åˆæ˜¯å¦‚ä½•åŒæ­¥å¤„ç†çš„å‘¢ï¼Ÿ</strong></p>
<p>åœ¨ConcurrentHashMapä¸­ï¼ŒåŒæ­¥å¤„ç†ä¸»è¦æ˜¯é€šè¿‡Synchronizedå’Œunsafeä¸¤ç§æ–¹å¼æ¥å®Œæˆçš„ã€‚</p>
<p>1ã€åœ¨å–å¾—sizeCtlã€æŸä¸ªä½ç½®çš„Nodeçš„æ—¶å€™ï¼Œä½¿ç”¨çš„éƒ½æ˜¯unsafeçš„æ–¹æ³•ï¼Œæ¥è¾¾åˆ°å¹¶å‘å®‰å…¨çš„ç›®çš„</p>
<p>2ã€å½“éœ€è¦åœ¨æŸä¸ªä½ç½®è®¾ç½®èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåˆ™ä¼šé€šè¿‡Synchronizedçš„åŒæ­¥æœºåˆ¶æ¥é”å®šè¯¥ä½ç½®çš„èŠ‚ç‚¹ã€‚</p>
<p>3ã€åœ¨æ•°ç»„æ‰©å®¹çš„æ—¶å€™ï¼Œåˆ™é€šè¿‡å¤„ç†çš„æ­¥é•¿å’ŒfwdèŠ‚ç‚¹æ¥è¾¾åˆ°å¹¶å‘å®‰å…¨çš„ç›®çš„ï¼Œé€šè¿‡è®¾ç½®hashå€¼ä¸ºMOVED</p>
<p>4ã€å½“æŠŠæŸä¸ªä½ç½®çš„èŠ‚ç‚¹å¤åˆ¶åˆ°æ‰©å¼ åçš„tableçš„æ—¶å€™ï¼Œä¹Ÿé€šè¿‡Synchronizedçš„åŒæ­¥æœºåˆ¶æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/search?query=concurrenthashmap&amp;utm_source=gold_browser_extension&amp;utm_medium=search">https://juejin.cn/search?query=concurrenthashmap&amp;utm_source=gold_browser_extension&amp;utm_medium=search</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904136937308168">https://juejin.cn/post/6844904136937308168</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zerotomax/p/8687425.html#go0">https://www.cnblogs.com/zerotomax/p/8687425.html#go0</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903520957644808">https://juejin.cn/post/6844903520957644808</a></p>
<p><a target="_blank" rel="noopener" href="https://processon.com/view/6049998ae401fd39d6fffbaa?fromnew=1">https://processon.com/view/6049998ae401fd39d6fffbaa?fromnew=1</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6871793103020556295">https://juejin.cn/post/6871793103020556295</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903641866846222">https://juejin.cn/post/6844903641866846222</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903602423595015">https://juejin.cn/post/6844903602423595015</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&mid=2247484161&idx=1&sn=6f52fb1f714f3ffd2f96a5ee4ebab146&chksm=ebd74200dca0cb16288db11f566cb53cafc580e08fe1c570e0200058e78676f527c014ffef41&scene=21###wechat_redirect">ConcurrentHashMapåŸºäºJDK1.8</a></p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#å¤šçº¿ç¨‹" >
    <span class="tag-code">å¤šçº¿ç¨‹</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCountDownLatch%E5%B7%A5%E5%85%B7/">
        <span class="nav-arrow">â† </span>
        
          Javaå¹¶å‘ç¼–ç¨‹ä¹‹CountDownLatchå·¥å…·
        
      </a>
    
    
      <a class="nav-right" href="/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/">
        
          è®¾è®¡æ¨¡å¼ä¹‹ç¾-äº«å…ƒæ¨¡å¼
        
        <span class="nav-arrow"> â†’</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- æ‰“èµ START -->
    
    <!-- æ‰“èµ END -->
    <!-- äºŒç»´ç  START -->
    
    <!-- äºŒç»´ç  END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo=""
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#ConcurrentHashMap"><span class="toc-nav-text">ConcurrentHashMap</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-text">å‰è¨€</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#HashTable-amp-HashMap"><span class="toc-nav-text">HashTable&amp;HashMap</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ConcurrentHashMap%E6%A6%82%E8%BF%B0"><span class="toc-nav-text">ConcurrentHashMapæ¦‚è¿°</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ConcurrentHashMap-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-nav-text">ConcurrentHashMap åŸç†è§£æ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ConcurrentHashMap%E5%B1%9E%E6%80%A7"><span class="toc-nav-text">ConcurrentHashMapå±æ€§</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Node-lt-K-V-gt-%E8%BF%99%E6%98%AF%E6%9E%84%E6%88%90%E6%AF%8F%E4%B8%AA%E5%85%83%E7%B4%A0%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%B1%BB%E3%80%82"><span class="toc-nav-text">Node&lt;K,V&gt;,è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#TreeNode%EF%BC%8C%E6%9E%84%E9%80%A0%E6%A0%91%E7%9A%84%E8%8A%82%E7%82%B9"><span class="toc-nav-text">TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#TreeBin-%E7%94%A8%E4%BD%9C%E6%A0%91%E7%9A%84%E5%A4%B4%E7%BB%93%E7%82%B9"><span class="toc-nav-text">TreeBin ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#ForwardingNode"><span class="toc-nav-text">ForwardingNode</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ConcurrentHashMap%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E6%96%B9%E6%B3%95"><span class="toc-nav-text">ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ConcurrentHashMap%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-nav-text">ConcurrentHashMapçš„åˆå§‹åŒ–</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ConcurrentHashMap%E7%9A%84put%E6%93%8D%E4%BD%9C%E8%AF%A6%E8%A7%A3"><span class="toc-nav-text">ConcurrentHashMapçš„putæ“ä½œè¯¦è§£</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ConcurrentHashMap%E7%9A%84%E6%89%A9%E5%AE%B9%E8%AF%A6%E8%A7%A3"><span class="toc-nav-text">ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#trePresize%E7%9A%84%E6%BA%90%E7%A0%81"><span class="toc-nav-text">trePresizeçš„æºç </span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#transfer%E6%96%B9%E6%B3%95"><span class="toc-nav-text">transferæ–¹æ³•</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ConcurrentHashMap%E7%9A%84get%E6%93%8D%E4%BD%9C%E8%AF%A6%E8%A7%A3"><span class="toc-nav-text">ConcurrentHashMapçš„getæ“ä½œè¯¦è§£</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%93%BE%E8%A1%A8%E8%BD%AC%E4%B8%BA%E7%BA%A2%E9%BB%91%E6%A0%91%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-nav-text">é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ConcurrentHashMap%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="toc-nav-text">ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://example.com/wiki/Javaå¹¶å‘ç¼–ç¨‹ä¹‹ConcurrentHashMapå®ç°åŸç†/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>







    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2022 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>