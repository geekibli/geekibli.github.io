<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>GeekIBLi</title>
  
  <subtitle>For Coder</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2021-08-04T06:17:49.104Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>gaolei</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹Blocking Queue</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BBlocking-Queue/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BBlocking-Queue/</id>
    <published>2021-08-03T08:48:32.000Z</published>
    <updated>2021-08-04T06:17:49.104Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Blocking-Queue"><a href="#Blocking-Queue" class="headerlink" title="Blocking Queue"></a>Blocking Queue</h1><p>A blocking queue is a queue that blocks when you try to dequeue from it and the queue is empty, or if you try to enqueue items to it and the queue is already full. A thread trying to dequeue from an empty queue is blocked until some other thread inserts an item into the queue. A thread trying to enqueue an item in a full queue is blocked until some other thread makes space in the queue, either by dequeuing one or more items or clearing the queue completely.</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210804131939043.png" alt="image-20210804131939043" style="zoom:50%;" /><p>é˜»å¡é˜Ÿåˆ—ä¸¤å¤§ç‰¹æ€§ï¼š</p><ul><li>å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœ<strong>ç”Ÿäº§è€…çº¿ç¨‹</strong>å‘é˜Ÿåˆ— put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨æˆ–è€…å“åº”ä¸­æ–­é€€å‡º</li><li>å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå¦‚æœ<strong>æ¶ˆè´¹è€…çº¿ç¨‹</strong> ä»é˜Ÿåˆ—é‡Œé¢ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©º</li></ul><p>é˜»å¡é˜Ÿåˆ—æœ€å¸¸ä½¿ç”¨åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ•°æ®ï¼Œå°†æ•°æ®å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼Œåœ¨é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ã€‚</p><p>é˜»å¡é˜Ÿåˆ—åœ¨ä¸å¯ç”¨æ—¶ï¼Œä¸‹é¢æ˜¯å„ç§å¤„ç†æ“ä½œçš„ç»“æœï¼šğŸ‘‡</p><table><thead><tr><th align="center">æ–¹æ³•/å¤„ç†æ–¹å¼</th><th align="center">æŠ›å‡ºå¼‚å¸¸</th><th align="center">è¿”å›ç‰¹æ®Šå€¼</th><th align="center">ä¸€ç›´é˜»å¡</th><th align="center">è¶…æ—¶é€€å‡º</th></tr></thead><tbody><tr><td align="center">æ’å…¥æ–¹æ³•</td><td align="center">add(e)</td><td align="center">offer(e)</td><td align="center">put(e)</td><td align="center">offer(e, time,unit)</td></tr><tr><td align="center">ç§»é™¤æ–¹æ³•</td><td align="center">remove()</td><td align="center">poll()</td><td align="center">take()</td><td align="center">poll(time,unit)</td></tr><tr><td align="center">æ£€æŸ¥æ–¹æ³•</td><td align="center">element()</td><td align="center">peek()</td><td align="center">ä¸å¯ç”¨</td><td align="center">ä¸å¯ç”¨</td></tr></tbody></table><h3 id="add-æŠ›å‡ºå¼‚å¸¸IllegalStateException"><a href="#add-æŠ›å‡ºå¼‚å¸¸IllegalStateException" class="headerlink" title="add æŠ›å‡ºå¼‚å¸¸IllegalStateException"></a>add æŠ›å‡ºå¼‚å¸¸IllegalStateException</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayBlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;queue size -&gt; &quot;</span> + queue.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼‚å¸¸ä¿¡æ¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalStateException: Queue full</span><br><span class="line">at java.util.AbstractQueue.add(AbstractQueue.java:<span class="number">98</span>)</span><br><span class="line">at java.util.concurrent.ArrayBlockingQueue.add(ArrayBlockingQueue.java:<span class="number">312</span>)</span><br><span class="line">at com.ibli.note.ArrayBlockingQueueDemo.main(ArrayBlockingQueueDemo.java:<span class="number">15</span>)</span><br></pre></td></tr></table></figure><h3 id="elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException"><a href="#elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException" class="headerlink" title="elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException"></a>elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayBlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;queue size -&gt; &quot;</span> + queue.size());</span><br><span class="line">        queue.element();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼‚å¸¸ä¿¡æ¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">queue size -&gt; <span class="number">0</span></span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.util.NoSuchElementException</span><br><span class="line">at java.util.AbstractQueue.element(AbstractQueue.java:<span class="number">136</span>)</span><br><span class="line">at com.ibli.note.ArrayBlockingQueueDemo.main(ArrayBlockingQueueDemo.java:<span class="number">14</span>)</span><br></pre></td></tr></table></figure><h2 id="ArrayBlockingQueue"><a href="#ArrayBlockingQueue" class="headerlink" title="ArrayBlockingQueue"></a>ArrayBlockingQueue</h2><p>åº•å±‚ç”±æ•°ç»„å®ç°çš„æœ‰ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ƒçš„å®¹é‡åœ¨åˆ›å»ºçš„æ—¶å€™å°±å·²ç»ç¡®è®¤äº†ï¼Œå¹¶ä¸”ä¸èƒ½ä¿®æ”¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.items = <span class="keyword">new</span> Object[capacity];</span><br><span class="line">    lock = <span class="keyword">new</span> ReentrantLock(fair);</span><br><span class="line">    notEmpty = lock.newCondition();</span><br><span class="line">    notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒArrayBlockingQueueæ˜¯ä¸ä¿è¯çº¿ç¨‹å…¬å¹³è®¿é—®é˜Ÿåˆ—çš„ï¼Œè¿™é‡Œæ‰€è°“çš„å…¬å¹³ä¸å¦æ˜¯æŒ‡ï¼Œé˜»å¡çš„çº¿ç¨‹èƒ½å¦æŒ‰ç…§é˜»å¡çš„å…ˆåé¡ºåºè®¿é—®é˜Ÿåˆ—ï¼Œå…ˆé˜»å¡å…ˆè®¿é—®ï¼Œåé˜»å¡åè®¿é—®ã€‚</p><p>æ€è€ƒä¸ºä»€ä¹ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯éå…¬å¹³çš„æ–¹å¼è®¿é—®å‘¢ï¼Ÿ ğŸ¤”</p><blockquote><p>è¿™ä¸ªæ˜¯ä¸ºäº†å¢åŠ ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡ï¼Œåœ¨ä¸ä¿è¯å…¬å¹³çš„æƒ…å†µä¸‹ï¼Œå¤šçº¿ç¨‹ä¹‹é—´ä¹‹é—´æ‰§è¡Œçš„æ•ˆç‡è¦æ¯”å…¬å¹³æ¨¡å¼ä¸‹é«˜çš„å¤šã€‚</p></blockquote><h3 id="ArrayBlovkingQueue-putæ–¹æ³•"><a href="#ArrayBlovkingQueue-putæ–¹æ³•" class="headerlink" title="ArrayBlovkingQueue#putæ–¹æ³•"></a>ArrayBlovkingQueue#putæ–¹æ³•</h3><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210804140652447.png" alt="image-20210804140652447"></p><p>ä¸‹é¢æ˜¯putæ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">  <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == items.length)</span><br><span class="line">          <span class="comment">// é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œé˜»å¡</span></span><br><span class="line">            notFull.await();</span><br><span class="line">      <span class="comment">// å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ </span></span><br><span class="line">        enqueue(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// æ‰§è¡Œå®Œæœ€åé‡Šæ”¾é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ·»åŠ æ•°æ®çš„æ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(E x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">    <span class="comment">// assert items[putIndex] == null;</span></span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">    items[putIndex] = x;</span><br><span class="line">    <span class="keyword">if</span> (++putIndex == items.length)</span><br><span class="line">        putIndex = <span class="number">0</span>;</span><br><span class="line">    count++;</span><br><span class="line">  <span class="comment">// æ•°æ®æ·»åŠ å®Œä¹‹åï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹åˆ°åŒæ­¥é˜Ÿåˆ—</span></span><br><span class="line">    notEmpty.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€¼ï¸å”¤é†’çš„çº¿ç¨‹èƒ½å¤ŸæŠ¢åˆ°é”æ˜¯ä¸ç¡®å®šçš„ï¼Œsignalä¼šæ·»åŠ èŠ‚ç‚¹åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…è·å–é”ã€‚è¿™ä¸ªå¯ä»¥çœ‹ä¸€ä¸‹Conditioné‚£ç¯‡æ–‡ç« ã€‚</p><p>ArrayBlockingQueueæ›´å¤šè¯¦ç»†ç»†èŠ‚ä»¥åŠåŸç†è·³è½¬é“¾æ¥<a href="https://www.jianshu.com/p/a636b3d83911">https://www.jianshu.com/p/a636b3d83911</a></p><h2 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h2><p>LinkedBlockingQueueæ˜¯ç”¨é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒåŒæ ·æ»¡è¶³FIFOçš„ç‰¹æ€§ï¼Œä¸ArrayBlockingQueueç›¸æ¯”èµ·æ¥å…·æœ‰æ›´é«˜çš„ååé‡ï¼Œä¸ºäº†é˜²æ­¢LinkedBlockingQueueå®¹é‡è¿…é€Ÿå¢ï¼ŒæŸè€—å¤§é‡å†…å­˜ã€‚é€šå¸¸åœ¨åˆ›å»ºLinkedBlockingQueueå¯¹è±¡æ—¶ï¼Œä¼šæŒ‡å®šå…¶å¤§å°ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œå®¹é‡ç­‰äºInteger.MAX_VALUE;</p><blockquote><p>Executors.newFixedThreadPool é˜¿é‡Œå·´å·´ç¦æ­¢ä½¿ç”¨Executorsæ¥åˆ›å»ºçº¿ç¨‹æ± </p></blockquote><p>é˜Ÿåˆ—å¤§å°æ— é™åˆ¶ï¼Œå¸¸ç”¨çš„ä¸ºæ— ç•Œçš„LinkedBlockingQueueï¼Œä½¿ç”¨è¯¥é˜Ÿåˆ—åšä¸ºé˜»å¡é˜Ÿåˆ—æ—¶è¦å°¤å…¶å½“å¿ƒï¼Œå½“ä»»åŠ¡è€—æ—¶è¾ƒé•¿æ—¶å¯èƒ½ä¼šå¯¼è‡´å¤§é‡æ–°ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­å †ç§¯æœ€ç»ˆå¯¼è‡´OOMã€‚é˜…è¯»ä»£ç å‘ç°ï¼ŒExecutors.newFixedThreadPool é‡‡ç”¨å°±æ˜¯ LinkedBlockingQueueï¼Œå½“QPSå¾ˆé«˜ï¼Œå‘é€æ•°æ®å¾ˆå¤§ï¼Œå¤§é‡çš„ä»»åŠ¡è¢«æ·»åŠ åˆ°è¿™ä¸ªæ— ç•ŒLinkedBlockingQueue ä¸­ï¼Œå¯¼è‡´cpuå’Œå†…å­˜é£™å‡æœåŠ¡å™¨æŒ‚æ‰ã€‚</p><h3 id="å±æ€§ä¿¡æ¯"><a href="#å±æ€§ä¿¡æ¯" class="headerlink" title="å±æ€§ä¿¡æ¯"></a>å±æ€§ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èŠ‚ç‚¹ç±»ï¼Œç”¨äºå­˜å‚¨æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    E item;</span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(E x) &#123; item = x; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é˜»å¡é˜Ÿåˆ—çš„å¤§å°ï¼Œé»˜è®¤ä¸ºInteger.MAX_VALUE */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å½“å‰é˜»å¡é˜Ÿåˆ—ä¸­çš„å…ƒç´ ä¸ªæ•° */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜»å¡é˜Ÿåˆ—çš„å¤´ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è·å–å¹¶ç§»é™¤å…ƒç´ æ—¶ä½¿ç”¨çš„é”ï¼Œå¦‚take, poll, etc */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** notEmptyæ¡ä»¶å¯¹è±¡ï¼Œå½“é˜Ÿåˆ—æ²¡æœ‰æ•°æ®æ—¶ç”¨äºæŒ‚èµ·æ‰§è¡Œåˆ é™¤çš„çº¿ç¨‹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty = takeLock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ·»åŠ å…ƒç´ æ—¶ä½¿ç”¨çš„é”å¦‚ put, offer, etc */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** notFullæ¡ä»¶å¯¹è±¡ï¼Œå½“é˜Ÿåˆ—æ•°æ®å·²æ»¡æ—¶ç”¨äºæŒ‚èµ·æ‰§è¡Œæ·»åŠ çš„çº¿ç¨‹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull = putLock.newCondition();</span><br></pre></td></tr></table></figure><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤å¤§å°ä¸ºInteger.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">this</span>(Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">    last = head = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(Integer.MAX_VALUE);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    putLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">if</span> (n == capacity)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Queue full&quot;</span>);</span><br><span class="line">            enqueue(<span class="keyword">new</span> Node&lt;E&gt;(e));</span><br><span class="line">            ++n;</span><br><span class="line">        &#125;</span><br><span class="line">        count.set(n);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LinkedBlockingQueue-putæ–¹æ³•"><a href="#LinkedBlockingQueue-putæ–¹æ³•" class="headerlink" title="LinkedBlockingQueue#putæ–¹æ³•"></a>LinkedBlockingQueue#putæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="comment">// è·å–é”ä¸­æ–­</span></span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œå¦‚æœå·²æ»¡é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠnodeæ”¾å…¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">        enqueue(node);</span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        <span class="comment">// å†æ¬¡åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æœ‰å¯ç”¨ç©ºé—´ï¼Œå¦‚æœæœ‰å”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ·»åŠ æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ä¸€æ¡æ•°æ®ï¼Œå”¤é†’æ¶ˆè´¹çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é˜Ÿåˆ—å·²æ»¡ï¼Œé˜»å¡ç­‰å¾…ã€‚</li><li>é˜Ÿåˆ—æœªæ»¡ï¼Œåˆ›å»ºä¸€ä¸ªnodeèŠ‚ç‚¹æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæ”¾å®Œä»¥åé˜Ÿåˆ—è¿˜æœ‰å‰©ä½™ç©ºé—´ï¼Œç»§ç»­å”¤é†’ä¸‹ä¸€ä¸ªæ·»åŠ çº¿ç¨‹è¿›è¡Œæ·»åŠ ã€‚å¦‚æœæ”¾ä¹‹å‰é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ ï¼Œæ”¾å®Œä»¥åè¦å”¤é†’æ¶ˆè´¹çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹ã€‚</li></ul><h3 id="ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ"><a href="#ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ" class="headerlink" title="ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ"></a>ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ</h3><p><strong>ç›¸åŒç‚¹</strong>ï¼šArrayBlockingQueueå’ŒLinkedBlockingQueueéƒ½æ˜¯é€šè¿‡conditioné€šçŸ¥æœºåˆ¶æ¥å®ç°å¯é˜»å¡å¼æ’å…¥å’Œåˆ é™¤å…ƒç´ ï¼Œå¹¶æ»¡è¶³çº¿ç¨‹å®‰å…¨çš„ç‰¹æ€§ï¼›</p><p><strong>ä¸åŒç‚¹</strong>ï¼š</p><p>1ã€ArrayBlockingQueueåº•å±‚æ˜¯é‡‡ç”¨çš„æ•°ç»„è¿›è¡Œå®ç°ï¼Œè€ŒLinkedBlockingQueueåˆ™æ˜¯é‡‡ç”¨é“¾è¡¨æ•°æ®ç»“æ„ï¼›</p><p>2ã€ArrayBlockingQueueæ’å…¥å’Œåˆ é™¤æ•°æ®ï¼Œåªé‡‡ç”¨äº†ä¸€ä¸ªlockï¼Œè€ŒLinkedBlockingQueueåˆ™æ˜¯åœ¨æ’å…¥å’Œåˆ é™¤åˆ†åˆ«é‡‡ç”¨äº†<code>putLock</code>å’Œ<code>takeLock</code>ï¼Œè¿™æ ·å¯ä»¥é™ä½çº¿ç¨‹ç”±äºçº¿ç¨‹æ— æ³•è·å–åˆ°lockè€Œè¿›å…¥WAITINGçŠ¶æ€çš„å¯èƒ½æ€§ï¼Œä»è€Œæé«˜äº†çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ•ˆç‡</p><p>æ›´å¤šLinkedBlockingQueueçš„å®ç°ç»†èŠ‚å‚è§<a href="https://blog.csdn.net/tonywu1992/article/details/83419448">https://blog.csdn.net/tonywu1992/article/details/83419448</a></p><h2 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h2><p>PriorityBlockingQueueæ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„<strong>æ— ç•Œé˜»å¡</strong>é˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡ç”¨è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»å®ç°compareTo()æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ–æ—¶é€šè¿‡æ„é€ å™¨å‚æ•°Comparatoræ¥æŒ‡å®šæ’åºè§„åˆ™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PriorityBlockingQueue</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 Comparator&lt;? <span class="keyword">super</span> E&gt; comparator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">this</span>.lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">this</span>.notEmpty = lock.newCondition();</span><br><span class="line">        <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p><p>1ã€é˜Ÿåˆ—ä¸­ä¸å…è®¸å‡ºç°nullå€¼ï¼Œä¹Ÿä¸å…è®¸å‡ºç°ä¸èƒ½æ’åºçš„å…ƒç´ ã€‚</p><p>2ã€é˜Ÿåˆ—å®¹é‡æ˜¯æ²¡æœ‰ä¸Šé™çš„ï¼Œä½†æ˜¯å¦‚æœæ’å…¥çš„å…ƒç´ è¶…è¿‡è´Ÿè½½ï¼Œæœ‰å¯èƒ½ä¼šå¼•èµ·OutOfMemoryå¼‚å¸¸ã€‚</p><blockquote><p>å½“æˆ‘ä»¬ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ˜¯éƒ½åº”è¯¥æ³¨æ„çš„ç‚¹ï¼Œä¸èƒ½åœ¨é˜Ÿåˆ—ä¸­æ— é™å­˜æ”¾æ•°æ®</p></blockquote><p>3ã€PriorityBlockingQueueç”±äºæ˜¯æ— ç•Œçš„ï¼Œæ‰€ä»¥putæ–¹æ³•æ˜¯éé˜»å¡çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    offer(e); <span class="comment">// never need to block  è¯·è‡ªè¡Œå¯¹ç…§ä¸Šé¢è¡¨æ ¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç»™å®šåˆå§‹å®¹é‡ï¼Œè¿™ä¸ªå®¹é‡ä¼šæŒ‰ç…§ä¸€å®šçš„ç®—æ³•è‡ªåŠ¨æ‰©å……</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Default array capacity.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PriorityBlockingQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé»˜è®¤çš„å®¹é‡æ˜¯ 11ï¼Œç”±äºä¹Ÿæ˜¯åŸºäºæ•°ç»„ã€‚</p><p>4ã€<code>å†…éƒ¨åªæœ‰ä¸€ä¸ªLockï¼Œæ‰€ä»¥ç”Ÿäº§æ¶ˆè´¹è€…ä¸èƒ½åŒæ—¶ä½œä¸š</code></p><p>è¯¦æƒ…å¯ä»¥å‚ç…§<a href="https://www.cnblogs.com/wyq1995/p/12289462.html">https://www.cnblogs.com/wyq1995/p/12289462.html</a></p><h2 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h2><p>DelayQueueé¡¾åæ€ä¹‰ï¼Œå…·æœ‰å»¶æ—¶ä½œç”¨çš„é˜Ÿåˆ—ã€‚</p><p>è®°å¾—ç¬¬ä¸€æ¬¡æ¥è§¦å»¶æ—¶é˜Ÿåˆ—çš„æ—¶å€™æ˜¯åœ¨çœ‹åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ—¶çœ‹åˆ°åº•å±‚æœ‰å…³å»¶æ—¶é˜Ÿåˆ—çš„å®ç°ã€‚</p><p>DelayQueue ä¹Ÿæ˜¯ä¸€ä¸ªæ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨æ—¶è¦æ³¨æ„OOMã€‚</p><p><code>åªæœ‰delayæ—¶é—´å°äº0çš„å…ƒç´ æ‰èƒ½å¤Ÿè¢«å–å‡ºã€‚</code></p><h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h3><p>åˆ›å»ºä¸€ä¸ªç±»ï¼Œå®ç°Delayedæ–¹æ³•ï¼Œé‡å†™getDelayæ–¹æ³•å’ŒcompareToæ–¹æ³•ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayData</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> second;</span><br><span class="line">    <span class="keyword">private</span> String val;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayData</span><span class="params">(<span class="keyword">long</span> second, String val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">        System.err.println(second + <span class="string">&quot; &quot;</span> + l);</span><br><span class="line">        <span class="keyword">this</span>.second = second + l;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSecond</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> diffTime = second - System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">return</span> unit.convert(diffTime,TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        DelayData tmp = (DelayData) o;</span><br><span class="line">        <span class="keyword">long</span> result =  second - tmp.getSecond() ;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DelayData&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;second=&quot;</span> + second +</span><br><span class="line">                <span class="string">&quot;, val=&#x27;&quot;</span> + val + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç„¶ååˆ›å»ºä¸¤ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueueDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        DelayQueue&lt;DelayData&gt; delayQueue = <span class="keyword">new</span> DelayQueue&lt;DelayData&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> DelayData(<span class="number">5000</span>, <span class="string">&quot;a&quot;</span>));</span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> DelayData(<span class="number">10000</span>, <span class="string">&quot;b&quot;</span>));</span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> DelayData(<span class="number">15000</span>, <span class="string">&quot;c&quot;</span>));</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span> &amp;&amp; flag) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.err.println(<span class="string">&quot;æ‰§è¡Œä¸€æ¬¡å¾ªç¯  é˜Ÿåˆ—é•¿åº¦&quot;</span> + delayQueue.size());</span><br><span class="line">                    DelayData poll = delayQueue.take();</span><br><span class="line">                    <span class="keyword">if</span> (poll != <span class="keyword">null</span>)&#123;</span><br><span class="line">                        System.err.println(poll.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (delayQueue.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                        flag = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SynchronousQueue"><a href="#SynchronousQueue" class="headerlink" title="SynchronousQueue"></a>SynchronousQueue</h2><p><strong>SynchronousQueue</strong>å®é™…ä¸Šå®ƒä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œå› ä¸ºå®ƒä¸ä¼šç»´æŠ¤é˜Ÿåˆ—ä¸­å…ƒç´ çš„å­˜å‚¨ç©ºé—´ï¼Œä¸å…¶ä»–é˜Ÿåˆ—ä¸åŒçš„æ˜¯ï¼Œå®ƒç»´æŠ¤ä¸€ç»„çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹åœ¨ç­‰å¾…æŠŠå…ƒç´ åŠ å…¥æˆ–ç§»é™¤é˜Ÿåˆ—ã€‚é€‚ç”¨äºç”Ÿäº§è€…å°‘æ¶ˆè´¹è€…å¤šçš„æƒ…å†µã€‚</p><p>SynchronousQueueæ˜¯ç”Ÿäº§è€…ç›´æ¥æŠŠæ•°æ®ç»™æ¶ˆè´¹è€…ï¼ˆæ¶ˆè´¹è€…ç›´æ¥ä»ç”Ÿäº§è€…è¿™é‡Œæ‹¿æ•°æ®ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œ<strong>æ¯ä¸€ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªçº¿ç¨‹å¯¹åº”çš„ç§»é™¤æ“ä½œ</strong>ã€‚SynchronousQueueåˆæœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><p>1ã€å…¬å¹³æ¨¡å¼</p><p>ã€€ã€€é‡‡ç”¨å…¬å¹³é”ï¼Œå¹¶é…åˆä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼ˆQueueï¼‰æ¥ç®¡ç†å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</p><p>2ã€éå…¬å¹³æ¨¡å¼</p><p>ã€€ã€€é‡‡ç”¨éå…¬å¹³é”ï¼Œå¹¶é…åˆä¸€ä¸ªLIFOæ ˆï¼ˆStackï¼‰æ¥ç®¡ç†å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œè¿™ä¹Ÿæ˜¯SynchronousQueueé»˜è®¤çš„æ¨¡å¼</p><h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">SynchronousQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SynchronousQueue</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">        transferer = fair ? <span class="keyword">new</span> TransferQueue() : <span class="keyword">new</span> TransferStack();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>transferer æ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ç”¨äºåœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¼ é€’æ•°æ®</p><h3 id="å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…"><a href="#å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…" class="headerlink" title="å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…"></a>å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…</h3><p>ä¸‹é¢æ¨¡æ‹Ÿä¸€ä¸ªç”Ÿäº§è€…ç”Ÿäº§æ•°æ®ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronousQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        SynchronousQueue queue = <span class="keyword">new</span> SynchronousQueue();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000L</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">                    queue.put(l);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :&quot;</span> + l);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">300</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š &quot;</span> + queue.take());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">300</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š &quot;</span> + queue.take());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç è¿è¡Œç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947404</span><br><span class="line">Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š 1628055947404</span><br><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947506</span><br><span class="line">Thread-2æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š 1628055947506</span><br><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947608</span><br><span class="line">Thread-2æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š 1628055947608</span><br><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947713</span><br></pre></td></tr></table></figure><p>SynchronousQueueè¯¦ç»†å®ç°ç»†èŠ‚å‚è§<a href="https://blog.csdn.net/yanyan19880509/article/details/52562039">https://blog.csdn.net/yanyan19880509/article/details/52562039</a></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html">https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html</a></p><p><a href="http://tutorials.jenkov.com/java-concurrency/index.html">http://tutorials.jenkov.com/java-concurrency/index.html</a></p><p><a href="https://www.baeldung.com/java-blocking-queue">https://www.baeldung.com/java-blocking-queue</a></p><p><a href="https://blog.csdn.net/tonywu1992/article/details/83419448">https://blog.csdn.net/tonywu1992/article/details/83419448</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Blocking-Queue&quot;&gt;&lt;a href=&quot;#Blocking-Queue&quot; class=&quot;headerlink&quot; title=&quot;Blocking Queue&quot;&gt;&lt;/a&gt;Blocking Queue&lt;/h1&gt;&lt;p&gt;A blocking queue is a </summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹ä¸­æ–­æœºåˆ¶</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6/</id>
    <published>2021-08-03T07:56:37.000Z</published>
    <updated>2021-08-03T08:43:17.432Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸­æ–­æœºåˆ¶"><a href="#ä¸­æ–­æœºåˆ¶" class="headerlink" title="ä¸­æ–­æœºåˆ¶"></a>ä¸­æ–­æœºåˆ¶</h1><p>Javaè¯­è¨€æä¾›ä¸€ç§æœºåˆ¶æ¥è¯•å›¾â€œç»ˆæ­¢â€ä¸€äº›ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œæ¯”å¦‚ä¸€ä¸‹ç©ºè½¬çš„çº¿ç¨‹ä¸€ç›´æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ä¸­æ–­çš„æ–¹å¼æ¥åœæ­¢è¿™ä¸€ç±»çš„çº¿ç¨‹ï¼Œè¿™å°±æ˜¯Javaä¸­æ–­æœºåˆ¶ã€‚</p><h2 id="1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹"><a href="#1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹" class="headerlink" title="1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹"></a>1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹</h2><p>1ã€<strong>Javaä¸­çº¿ç¨‹é—´æ˜¯åä½œå¼ï¼Œè€ŒéæŠ¢å å¼</strong>. è°ƒç”¨ä¸€ä¸ªçº¿ç¨‹çš„interrupt() æ–¹æ³•ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸æ˜¯å¼ºè¡Œå…³é—­è¿™ä¸ªçº¿ç¨‹ï¼Œåªæ˜¯è·Ÿè¿™ä¸ªçº¿ç¨‹æ‰“ä¸ªæ‹›å‘¼ï¼Œå°†çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ç½®ä¸ºtrueï¼Œçº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œç”±çº¿ç¨‹æœ¬èº«å†³å®šã€‚</p><p>2ã€isInterrupted() åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ã€‚</p><p>3ã€é™æ€æ–¹æ³• interrupted() åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ï¼ŒåŒæ—¶ä¸­æ–­æ ‡å¿—ä½æ”¹ä¸º falseã€‚</p><p>4ã€<strong>å¦‚æœæ–¹æ³•é‡Œå¦‚æœæŠ›å‡ºä¸­æ–­å¼‚å¸¸ InterruptedExceptionï¼Œåˆ™çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¼šè¢«å¤ä½æˆfalse</strong>ï¼Œå¦‚æœç¡®å®æ˜¯éœ€è¦ä¸­æ–­çº¿ç¨‹ï¼Œè¦æ±‚æˆ‘ä»¬è‡ªå·±åœ¨catchè¯­å¥å—é‡Œå†æ¬¡è°ƒç”¨interrupt()ã€‚</p><p>5ã€Java ä¸­æ‰€æœ‰çš„é˜»å¡æ–¹æ³•éƒ½ä¼šæŠ›å‡º InterruptedExceptionï¼Œæ¯”å¦‚wait(), join(),sleep()ã€‚</p><h2 id="2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•"><a href="#2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•" class="headerlink" title="2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•"></a>2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•</h2><p>åœ¨Javaä¸­æä¾›äº†3ä¸ªæœ‰å…³ä¸­æ–­çš„æ–¹æ³•ï¼š</p><h3 id="Thread-currentThread-isInterrupted"><a href="#Thread-currentThread-isInterrupted" class="headerlink" title="Thread.currentThread().isInterrupted()"></a>Thread.currentThread().isInterrupted()</h3><blockquote><p>åˆ¤æ–­å½“å‰çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</p></blockquote><h3 id="thread-interrupt"><a href="#thread-interrupt" class="headerlink" title="thread.interrupt();"></a>thread.interrupt();</h3><blockquote><p>ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œå°†ä¸­æ–­æ ‡å¿—è®¾ç½®æˆtrue</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != Thread.currentThread())</span><br><span class="line">            checkAccess();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (blockerLock) &#123;</span><br><span class="line">            Interruptible b = blocker;</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">                interrupt0();           <span class="comment">// Just to set the interrupt flag</span></span><br><span class="line">                b.interrupt(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        interrupt0();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Thread-interrupted"><a href="#Thread-interrupted" class="headerlink" title="Thread.interrupted()"></a>Thread.interrupted()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">interrupted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentThread().isInterrupted(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œæ”¹æˆfalseï¼›</p></blockquote><p>éªŒè¯ä¸€ä¸‹å°±å¯ä»¥äº† ğŸ‘‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.err.println(Thread.currentThread().isInterrupted());</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">    System.err.println(Thread.currentThread().isInterrupted());</span><br><span class="line">    <span class="keyword">boolean</span> interrupted = Thread.interrupted();</span><br><span class="line">    System.err.println(<span class="string">&quot;interrupted &quot;</span> + interrupted);</span><br><span class="line">    System.err.println(Thread.currentThread().isInterrupted());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3ã€ä¸­æ–­ä¾‹å­"><a href="#3ã€ä¸­æ–­ä¾‹å­" class="headerlink" title="3ã€ä¸­æ–­ä¾‹å­"></a>3ã€ä¸­æ–­ä¾‹å­</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterrupterDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span> &amp;&amp; !Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">                System.err.println(<span class="number">1</span>);</span><br><span class="line">                System.err.println(Thread.interrupted());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;after sleep &quot;</span>+ Thread.currentThread().isInterrupted());</span><br><span class="line">                  Thread.currentThread().interrupt();</span><br><span class="line">                    <span class="keyword">boolean</span> interrupted = Thread.interrupted();</span><br><span class="line">                    System.err.println(<span class="string">&quot;interrupted &quot;</span>+ Thread.currentThread().isInterrupted() + <span class="string">&quot;/ &quot;</span> + interrupted);</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                    System.err.println(<span class="string">&quot;final sleep &quot;</span>+ Thread.currentThread().isInterrupted());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸­æ–­ä¸€åœºä¸è¦ã€ åæ‰ ã€‘ï¼Œè¦ä¸åœ¨ç¨‹åºä¸­ç›¸åº”ä¸­æ–­ä¸€åœºï¼Œè¿›è¡Œç›¸åº”çš„é€»è¾‘å¤„ç†ï¼Œæˆ–è€…å°†ä¸€åœºç»§ç»­å‘ä¸ŠæŠ›ï¼Œç”±ä¸Šå±‚å¤„ç†ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://dayarch.top/p/java-concurrency-interrupt-mechnism.html">https://dayarch.top/p/java-concurrency-interrupt-mechnism.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸­æ–­æœºåˆ¶&quot;&gt;&lt;a href=&quot;#ä¸­æ–­æœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;ä¸­æ–­æœºåˆ¶&quot;&gt;&lt;/a&gt;ä¸­æ–­æœºåˆ¶&lt;/h1&gt;&lt;p&gt;Javaè¯­è¨€æä¾›ä¸€ç§æœºåˆ¶æ¥è¯•å›¾â€œç»ˆæ­¢â€ä¸€äº›ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œæ¯”å¦‚ä¸€ä¸‹ç©ºè½¬çš„çº¿ç¨‹ä¸€ç›´æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ä¸­æ–­çš„æ–¹å¼æ¥åœæ­¢è¿™ä¸€ç±»çš„çº¿</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹Conditionæœºåˆ¶åº•å±‚</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCondition%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCondition%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82/</id>
    <published>2021-08-03T04:00:16.000Z</published>
    <updated>2021-08-03T07:16:38.710Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶"><a href="#Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶" class="headerlink" title="Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶"></a>Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶</h1><p>è¿˜æ˜¯çœ‹ä¸€ä¸‹ä¹‹å‰ReentrantLockä¸­è°ƒç”¨conditionæ–¹æ³•çš„æµç¨‹å›¾ ğŸ‘‡</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210803140956785.png" alt="image-20210803140956785" style="zoom:40%;" /><p>ä»»ä½•ä¸€ä¸ªjavaå¯¹è±¡éƒ½å¤©ç„¶ç»§æ‰¿äºObjectç±»ï¼Œåœ¨çº¿ç¨‹é—´å®ç°é€šä¿¡çš„å¾€å¾€ä¼šåº”ç”¨åˆ°Objectçš„å‡ ä¸ªæ–¹æ³•ï¼Œæ¯”å¦‚wait(),wait(long timeout),wait(long timeout, int nanos)ä¸notify(),notifyAll()å‡ ä¸ªæ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ŒåŒæ ·çš„ï¼Œ åœ¨java Lockä½“ç³»ä¸‹ä¾ç„¶ä¼šæœ‰åŒæ ·çš„æ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚</p><p>ä»æ•´ä½“ä¸Šæ¥çœ‹<strong>Objectçš„waitå’Œnotify/notifyæ˜¯ä¸å¯¹è±¡ç›‘è§†å™¨é…åˆå®Œæˆçº¿ç¨‹é—´çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œè€ŒConditionä¸Locké…åˆå®Œæˆç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œå‰è€…æ˜¯javaåº•å±‚çº§åˆ«çš„ï¼Œåè€…æ˜¯è¯­è¨€çº§åˆ«çš„ï¼Œå…·æœ‰æ›´é«˜çš„å¯æ§åˆ¶æ€§å’Œæ‰©å±•æ€§</strong>ã€‚ä¸¤è€…é™¤äº†åœ¨ä½¿ç”¨æ–¹å¼ä¸Šä¸åŒå¤–ï¼Œåœ¨<strong>åŠŸèƒ½ç‰¹æ€§</strong>ä¸Šè¿˜æ˜¯æœ‰å¾ˆå¤šçš„ä¸åŒï¼š</p><ol><li>Conditionèƒ½å¤Ÿæ”¯æŒä¸å“åº”ä¸­æ–­ï¼Œè€Œé€šè¿‡ä½¿ç”¨Objectæ–¹å¼ä¸æ”¯æŒï¼›</li><li>Conditionèƒ½å¤Ÿæ”¯æŒå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ˆnew å¤šä¸ªConditionå¯¹è±¡ï¼‰ï¼Œè€ŒObjectæ–¹å¼åªèƒ½æ”¯æŒä¸€ä¸ªï¼›</li><li>Conditionèƒ½å¤Ÿæ”¯æŒè¶…æ—¶æ—¶é—´çš„è®¾ç½®ï¼Œè€ŒObjectä¸æ”¯æŒ</li></ol><h2 id="1-Conditionæ¥å£æä¾›çš„æ–¹æ³•"><a href="#1-Conditionæ¥å£æä¾›çš„æ–¹æ³•" class="headerlink" title="1. Conditionæ¥å£æä¾›çš„æ–¹æ³•"></a>1. Conditionæ¥å£æä¾›çš„æ–¹æ³•</h2><h3 id="1-1-awaitæ–¹æ³•"><a href="#1-1-awaitæ–¹æ³•" class="headerlink" title="1.1 awaitæ–¹æ³•"></a>1.1 awaitæ–¹æ³•</h3><p><strong>void await() throws InterruptedException</strong></p><p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è°ƒç”¨conditionçš„signalæˆ–è€…signalAllæ–¹æ³•å¹¶ä¸”å½“å‰çº¿ç¨‹è·å–Lockä»awaitæ–¹æ³•è¿”å›ï¼Œå¦‚æœåœ¨ç­‰å¾…çŠ¶æ€ä¸­è¢«ä¸­æ–­ä¼šæŠ›å‡ºè¢«ä¸­æ–­å¼‚å¸¸ï¼›</p><p><strong>long awaitNanos(long nanosTimeout)</strong></p><p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ï¼Œä¸­æ–­æˆ–è€…<strong>è¶…æ—¶</strong>ï¼›</p><p><strong>boolean await(long time, TimeUnit unit)throws InterruptedException</strong></p><p>åŒç¬¬äºŒç§ï¼Œæ”¯æŒè‡ªå®šä¹‰æ—¶é—´å•ä½</p><p><strong>boolean awaitUntil(Date deadline) throws InterruptedException</strong></p><p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ï¼Œä¸­æ–­æˆ–è€…<strong>åˆ°äº†æŸä¸ªæ—¶é—´</strong></p><h3 id="1-2-signalæ–¹æ³•"><a href="#1-2-signalæ–¹æ³•" class="headerlink" title="1.2 signalæ–¹æ³•"></a>1.2 signalæ–¹æ³•</h3><p><strong>void signal()</strong></p><p>å”¤é†’ä¸€ä¸ªç­‰å¾…åœ¨conditionä¸Šçš„çº¿ç¨‹ï¼Œå°†è¯¥çº¿ç¨‹ä»<strong>ç­‰å¾…é˜Ÿåˆ—</strong>ä¸­è½¬ç§»åˆ°<strong>åŒæ­¥é˜Ÿåˆ—</strong>ä¸­ï¼Œå¦‚æœåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­èƒ½å¤Ÿç«äº‰åˆ°Lockåˆ™å¯ä»¥ä»ç­‰å¾…æ–¹æ³•ä¸­è¿”å›ã€‚</p><p><strong>void signalAll()</strong></p><p>ä¸1çš„åŒºåˆ«åœ¨äºèƒ½å¤Ÿå”¤é†’æ‰€æœ‰ç­‰å¾…åœ¨conditionä¸Šçš„çº¿ç¨‹ã€‚</p><h2 id="2-Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨"><a href="#2-Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨" class="headerlink" title="2. Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨"></a>2. Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨</h2><p>ä¸‹é¢å…ˆé€šè¿‡ä¸€ä¸ªä¾‹å­çœ‹ä¸€ä¸‹Conditionçš„ä½¿ç”¨ ğŸ‘‡</p><p>1ã€å¤§è‡´æµç¨‹å°±æ˜¯çº¿ç¨‹1å…ˆè·å–lockä¹‹åï¼Œæ‰§è¡Œçº¿ç¨‹1çš„æ–¹æ³•ï¼Œç„¶åè°ƒç”¨condition.await();æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ï¼›åŒæ—¶åŠ å…¥Conditionç­‰å¾…é˜Ÿåˆ—</p><p>2ã€çº¿ç¨‹1é‡Šæ”¾lockä¹‹åï¼Œçº¿ç¨‹2è€Œå·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­äº†ï¼Œçº¿ç¨‹2è·å–lockæ‰§è¡Œæƒï¼Œæ‰§è¡Œcondition.signal()æ–¹æ³•å”¤é†’çº¿ç¨‹1</p><p>3ã€çº¿ç¨‹1è¢«å”¤é†’ä¹‹åï¼ŒnodeèŠ‚ç‚¹é‡æ–°æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è·å–æ‰§è¡Œæƒé™ï¼Œåœ¨çº¿ç¨‹2è°ƒç”¨äº†unlock()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹1é‡æ–°è·å–åˆ°lockä¹‹åï¼Œæ‰§è¡Œåç»­æµç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Condition condition = lock.newCondition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;enter thread 1 &quot;</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;thread 1 invoke await&quot;</span>);</span><br><span class="line">                    condition.await();</span><br><span class="line">                    System.err.println(<span class="string">&quot;thread 1 invoked signal&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(<span class="string">&quot;exit thread 1 &quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;enter thread 2 &quot;</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;thread 2 invoke signal&quot;</span>);</span><br><span class="line">                condition.signal();</span><br><span class="line">                System.err.println(<span class="string">&quot;exit thread 2 &quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„æ‰§è¡Œç»“æœå¯ä»¥çŒœæƒ³ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enter thread <span class="number">1</span> </span><br><span class="line">thread <span class="number">1</span> invoke await</span><br><span class="line">enter thread <span class="number">2</span> </span><br><span class="line">thread <span class="number">2</span> invoke signal</span><br><span class="line">exit thread <span class="number">2</span> </span><br><span class="line">thread <span class="number">1</span> invoked signal</span><br><span class="line">exit thread <span class="number">1</span> </span><br></pre></td></tr></table></figure><h2 id="3-Conditionç­‰å¾…-é€šçŸ¥å®ç°åŸç†"><a href="#3-Conditionç­‰å¾…-é€šçŸ¥å®ç°åŸç†" class="headerlink" title="3. Conditionç­‰å¾…/é€šçŸ¥å®ç°åŸç†"></a>3. Conditionç­‰å¾…/é€šçŸ¥å®ç°åŸç†</h2><p>è¦æƒ³èƒ½å¤Ÿæ·±å…¥çš„æŒæ¡conditionè¿˜æ˜¯åº”è¯¥çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹condiitonçš„æºç ã€‚åˆ›å»ºä¸€ä¸ªconditionå¯¹è±¡æ˜¯é€šè¿‡<code>lock.newCondition()</code>,è€Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ä¼šnewå‡ºä¸€ä¸ª<strong>ConditionObject</strong>å¯¹è±¡ï¼Œè¯¥ç±»æ˜¯AQSçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå’ŒNodeç±»ä¸€æ ·ï¼Œéå¸¸é‡è¦ã€‚</p><p>conditionæ˜¯è¦å’Œlocké…åˆä½¿ç”¨çš„ä¹Ÿå°±æ˜¯conditionå’ŒLockæ˜¯ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œè€Œlockçš„å®ç°åŸç†åˆä¾èµ–äºAQSï¼Œè‡ªç„¶è€Œç„¶ConditionObjectä½œä¸ºAQSçš„ä¸€ä¸ªå†…éƒ¨ç±»æ— å¯åšéã€‚</p><p>æˆ‘ä»¬çŸ¥é“åœ¨é”æœºåˆ¶çš„å®ç°ä¸Šï¼ŒAQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯ç‹¬å å¼é”çš„è¯ï¼Œæ‰€æœ‰è·å–é”å¤±è´¥çš„çº¿ç¨‹çš„å°¾æ’å…¥åˆ°<strong>åŒæ­¥é˜Ÿåˆ—</strong>ï¼ŒåŒæ ·çš„ï¼Œconditionå†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨åŒæ ·çš„æ–¹å¼ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª <strong>ç­‰å¾…é˜Ÿåˆ—</strong>ï¼Œæ‰€æœ‰è°ƒç”¨condition.awaitæ–¹æ³•çš„çº¿ç¨‹ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”çº¿ç¨‹çŠ¶æ€è½¬æ¢ä¸ºç­‰å¾…çŠ¶æ€ã€‚</p><p>å¦å¤–æ³¨æ„åˆ°ConditionObjectä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š</p><p><code>private transient Node firstWaiter;</code></p><p><code>private transient Node lastWaiter;</code></p><p>åœ¨AQSä¸­conditioné˜Ÿåˆ—å¯ä»¥å­˜åœ¨å¤šä¸ªå¦‚ä¸‹æ‰€ç¤ºï¼Œä½†æ˜¯åŒæ­¥é˜Ÿåˆ—ä¹‹å¯èƒ½æ˜¯ä¸€ä¸ªï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŒæ­¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨é˜Ÿåˆ—ï¼Œè€Œç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘çš„é˜Ÿåˆ—ã€‚</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210803142409623.png" alt="image-20210803142409623" style="zoom:33%;" /><p>ä¸‹é¢ä»awaitæ–¹æ³•å…¥æ‰‹æ¥å­¦ä¹ Conditionçš„æœºåˆ¶æ˜¯å¦‚ä½•è¿è½¬çš„ã€‚</p><h3 id="3-1-ç­‰å¾…await"><a href="#3-1-ç­‰å¾…await" class="headerlink" title="3.1 ç­‰å¾…await"></a>3.1 ç­‰å¾…await</h3><p><code>public class ConditionObject implements Condition</code></p><p>AQS#ConditionObjectå†…éƒ¨ç±»å®ç°äº†Conditionæ¥å£çš„awaitæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  <span class="comment">// å°†èŠ‚ç‚¹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">  <span class="comment">// è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹éœ€è¦é‡Šæ”¾lockè®©ç»™åˆ«çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// å¦‚æœèŠ‚ç‚¹ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ŒçŸ¥é“è¿›å…¥åŒæ­¥é˜Ÿåˆ—æˆ–è€…è¢«ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨awaitçš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡åœ¨ä¸Šé¢çš„whileå¾ªç¯ï¼ŒçŸ¥é“è¢«å”¤é†’æˆ–è€…ç›¸åº”ä¸­æ–­ï¼Œæ‰ä¼šæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•</span></span><br><span class="line">  <span class="comment">// è¿›å…¥åŒæ­¥é˜Ÿåˆ—å°è¯•è·å–lockï¼Œå’Œä¹‹å‰ä¸€æ ·ï¼Œä¸ºäº†é™åˆ¶ä¸€ç›´ç©ºè½¬ï¼Œä¼šåœ¨ç¬¬äºŒæ¬¡å¾ªç¯ä¹‹åï¼Œparkæ­¤èŠ‚ç‚¹ï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸­è½®åˆ°è¿™ä¸ªçº¿ç¨‹å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">      <span class="comment">// æ¸…é™¤æ‰å–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè¸¢å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">  <span class="comment">//å¤„ç†è¢«ä¸­æ–­çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AQS#addConditionWaiter</strong> <strong>æ·»åŠ èŠ‚ç‚¹åˆ°ç­‰å¾…é˜Ÿåˆ—</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•åº”è¯¥æ¯”è¾ƒå¥½ç†è§£å§ï¼Œå°±æ˜¯æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚</p><p>âš ï¸ è¿™é‡Œå’ŒæŠŠèŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—è¿˜æœ‰ç‚¹åŒºåˆ«ï¼Œä¸çŸ¥é“å¤§å®¶è¿˜æœ‰æ²¡æœ‰å°è±¡ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå…ˆåˆ¤æ–­tailæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸æ˜¯ç©ºï¼Œåˆ™ç›´æ¥æ·»åŠ ï¼›å¦‚æœæ˜¯ç©ºï¼Œåˆ™è°ƒç”¨äº†<code>enq(Node node)</code>æ–¹æ³•ï¼Œå…ˆç”Ÿæˆä¸€ä¸ªheadèŠ‚ç‚¹ï¼Œç„¶ååœ¨æŠŠå½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°åé¢ï¼Œå¾ªç¯äº†ä¸¤éçš„ã€‚</p><p>è¿™é‡Œæ˜¯ç›´æ¥åˆ›å»ºå½“å‰èŠ‚ç‚¹ï¼Œç„¶åå°†firstWaiteræŒ‡é’ˆæŒ‡å‘äº†nodeï¼›</p><p><strong>AQS#fullyRelease é‡Šæ”¾lock</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> savedState = getState();</span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿä¸éš¾ï¼Œæƒ³ä¸€ä¸‹ï¼Œçº¿ç¨‹éƒ½å·²ç»è°ƒç”¨awaitæ–¹æ³•äº†ï¼Œè€Œä¸”ä¸Šä¸€æ­¥å°±å·²ç»æŠŠèŠ‚ç‚¹æ·»åŠ åˆ°äº†ç­‰å¾…é˜Ÿåˆ—ä¸­äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦åšä»€ä¹ˆå‘¢ï¼Ÿé‚£è‚¯å®šæ˜¯é‡Šæ”¾é”lockäº†ã€‚å¯¹ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯åšè¿™ä¸ªçš„ã€‚releaseæ–¹æ³•ä¹‹å‰å·²ç»ä»‹ç»äº†ï¼Œæ— éå°±æ˜¯å¯¹stateåšä¸€ä¸‹å‡æ³•ï¼ŒæŠŠå¯¹æˆ˜çº¿ç¨‹æ¸…ç©ºä¸€ä¸‹ï¼Œç»™æ–°æ¥çš„çº¿ç¨‹è…¾åœ°æ–¹ã€‚</p><p><strong>ä¸‹é¢æ‰æ˜¯awaitçš„å…³é”®æ ¸å¿ƒä»£ç </strong>ï¼šâ€¼ï¸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">while (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(this);</span><br><span class="line">        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>isOnSyncQueue(node)</code>åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¸ªåˆ¤æ–­å‘¢ï¼ŸåŸå› å¾ˆç®€å•ï¼Œå½“åˆ«çš„çº¿ç¨‹æˆ–è€…è‡ªå·±è°ƒç”¨äº†signalæ–¹æ³•ä¹‹åï¼Œä¼šæŠŠå½“å‰èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è¯´æ˜ä»€ä¹ˆå‘¢ï¼Œè¯´æ˜æ¥ä¸‹æ¥è¿™ä¸ªçº¿ç¨‹è¦å»ç«äº‰é”äº†ï¼Œä¹Ÿå°±æ˜¯è¢«å”¤é†’äº†ï¼Œå½“ç«äº‰é”æˆåŠŸä¹‹åï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¯ä»¥awaitåé¢çš„æ–¹æ³•äº†ã€‚</p><p><code>(interruptMode = checkInterruptWhileWaiting(node)) != 0</code></p><p>å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™å¯ä»¥ç›´æ¥è·³å‡ºå¾ªç¯ï¼Œå»ç«äº‰é”ã€‚</p><h3 id="3-2-é€šçŸ¥signal"><a href="#3-2-é€šçŸ¥signal" class="headerlink" title="3.2 é€šçŸ¥signal"></a>3.2 é€šçŸ¥signal</h3><p><strong>è°ƒç”¨conditionçš„signalæˆ–è€…signalAllæ–¹æ³•å¯ä»¥å°†ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</strong>ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹èƒ½å¤Ÿæœ‰æœºä¼šè·å¾—lockã€‚æŒ‰ç…§ç­‰å¾…é˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„ï¼Œæ‰€ä»¥ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹å¿…ç„¶ä¼šæ˜¯ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡è°ƒç”¨conditionçš„signalæ–¹æ³•æ˜¯å°†å¤´èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚signalæ–¹æ³•æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1. å…ˆæ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å–lockï¼Œå¦‚æœæ²¡æœ‰è·å¾—é”ï¼Œè‚¯å®šæ˜¯è¯´ä¸é€šçš„</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">//2. è·å–ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹‹åçš„æ“ä½œéƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">Node first = firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>signalæ–¹æ³•é¦–å…ˆä¼šæ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å–lockï¼Œå¦‚æœæ²¡æœ‰è·å–lockä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœè·å–çš„è¯å†å¾—åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å¤´æŒ‡é’ˆå¼•ç”¨çš„èŠ‚ç‚¹ï¼Œä¹‹åçš„æ“ä½œçš„doSignalæ–¹æ³•ä¹Ÿæ˜¯åŸºäºè¯¥èŠ‚ç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹doSignalæ–¹æ³•åšäº†äº›ä»€ä¹ˆäº‹æƒ…ã€‚</p><p><strong>AQS#doSignal</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//1. å°†å¤´ç»“ç‚¹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//2. whileä¸­transferForSignalæ–¹æ³•å¯¹å¤´ç»“ç‚¹åšçœŸæ­£çš„å¤„ç†</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">             (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼ŒçœŸæ­£å¯¹å¤´èŠ‚ç‚¹åšå¤„ç†çš„é€»è¾‘åœ¨<strong>transferForSignal</strong>æ”¾ï¼Œè¯¥æ–¹æ³•æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If cannot change waitStatus, the node has been cancelled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="comment">//1. æ›´æ–°çŠ¶æ€ä¸º0ï¼ŒåŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„èŠ‚ç‚¹çš„åˆå§‹çŠ¶æ€æ˜¯0</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Splice onto queue and try to set waitStatus of predecessor to</span></span><br><span class="line"><span class="comment">     * indicate that thread is (probably) waiting. If cancelled or</span></span><br><span class="line"><span class="comment">     * attempt to set waitStatus fails, wake up to resync (in which</span></span><br><span class="line"><span class="comment">     * case the waitStatus can be transiently and harmlessly wrong).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//2.å°†è¯¥èŠ‚ç‚¹ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­å»</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">  <span class="comment">// pèŠ‚ç‚¹æ˜¯nodeçš„å‰ç½®èŠ‚ç‚¹ï¼Œéœ€è¦å°†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNAL</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼Œè¿™æ®µä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…</p><p>1.å°†å¤´ç»“ç‚¹çš„çŠ¶æ€æ›´æ”¹ä¸ºCONDITIONï¼›</p><p>2.è°ƒç”¨enqæ–¹æ³•ï¼Œå°†è¯¥èŠ‚ç‚¹å°¾æ’å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNAL</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š<strong>è°ƒç”¨conditionçš„signalçš„å‰ææ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹å·²ç»è·å–äº†lockï¼Œè¯¥æ–¹æ³•ä¼šä½¿å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹å³ç­‰å¾…æ—¶é—´æœ€é•¿çš„é‚£ä¸ªèŠ‚ç‚¹ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè€Œç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—åæ‰æœ‰æœºä¼šä½¿å¾—ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ï¼Œå³ä»awaitæ–¹æ³•ä¸­çš„LockSupport.park(this)æ–¹æ³•ä¸­è¿”å›ï¼Œä»è€Œæ‰æœ‰æœºä¼šä½¿å¾—è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æˆåŠŸé€€å‡º</strong>ã€‚</p><p><strong>signalAllæ–¹æ³•é€šçŸ¥æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</strong></p><p>sigllAllä¸sigalæ–¹æ³•çš„åŒºåˆ«ä½“ç°åœ¨doSignalAllæ–¹æ³•ä¸Šï¼Œå‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“doSignalæ–¹æ³•åªä¼šå¯¹ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œè€ŒdoSignalAllçš„æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignalAll</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    lastWaiter = firstWaiter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        Node next = first.nextWaiter;</span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">        transferForSignal(first);</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (first != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•åªä¸è¿‡æ—¶é—´ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå³â€œé€šçŸ¥â€å½“å‰è°ƒç”¨condition.await()æ–¹æ³•çš„æ¯ä¸€ä¸ªçº¿ç¨‹ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://juejin.cn/post/6844903602419400718">https://juejin.cn/post/6844903602419400718</a></p><p><a href="https://juejin.cn/post/6844903654873382925">https://juejin.cn/post/6844903654873382925</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&quot;&gt;&lt;a href=&quot;#Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&quot;&gt;&lt;/a&gt;Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&lt;/h1&gt;&lt;p&gt;è¿˜æ˜¯</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹æ·±å…¥ç†è§£ReentrantLock</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ReetrantLock/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ReetrantLock/</id>
    <published>2021-08-02T08:00:33.000Z</published>
    <updated>2021-08-03T03:54:52.341Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h1><p>ReentrantLocké‡å…¥é”ï¼Œæ˜¯å®ç°Lockæ¥å£çš„ä¸€ä¸ªç±»ï¼Œä¹Ÿæ˜¯åœ¨å®é™…ç¼–ç¨‹ä¸­ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ä¸€ä¸ªé”ï¼Œ<strong>æ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡</strong></p><h2 id="åŠ é”æ“ä½œ"><a href="#åŠ é”æ“ä½œ" class="headerlink" title="åŠ é”æ“ä½œ"></a>åŠ é”æ“ä½œ</h2><p><strong>æ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡</strong></p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802160050888.png" alt="image-20210802160050888" style="zoom:50%;" /><p>ä¸‹é¢ä»¥éå…¬å¹³é”çš„lockæ–¹æ³•ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ReentrantLockæºç çš„å®ç° ğŸ‘‡</p><h3 id="é¦–å…ˆæ˜¯lockæ–¹æ³•"><a href="#é¦–å…ˆæ˜¯lockæ–¹æ³•" class="headerlink" title="é¦–å…ˆæ˜¯lockæ–¹æ³•"></a>é¦–å…ˆæ˜¯lockæ–¹æ³•</h3><p>1ã€è¿›å…¥lockæ–¹æ³•é¦–å…ˆå¯¹è°ƒç”¨compareAndSetState(0,1)å»å°è¯•è·å–é”ï¼Œè¿™ä¸€ç‚¹æ­£æ˜¯ä½“ç°äº†éå…¬å¹³é”</p><p>2ã€å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰è·å–åˆ°é”ï¼Œç„¶åæ‰§è¡Œç¬¬äºŒæ­¥acquire(1)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// éå…¬å¹³é”</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>lockæ–¹æ³•é¦–å…ˆä¼šå»casä¿®æ”¹AQSçš„stateçŠ¶æ€ï¼Œç‹¬å é”æ¨¡å¼ä¸‹stateå¢åŠ 1è¡¨ç¤ºè·å–é”æˆåŠŸï¼›stateè®¾ç½®æˆåŠŸä¹‹åï¼Œéœ€è¦å°†ç‹¬å çº¿ç¨‹å­—æ®µè®¾ç½®æˆå½“å‰çº¿ç¨‹ï¼š<code>exclusiveOwnerThread = thread;</code></p><h3 id="AQS-acquire-1"><a href="#AQS-acquire-1" class="headerlink" title="AQS#acquire(1)"></a>AQS#acquire(1)</h3><p>å¦‚æœæ²¡æœ‰æŠ¢å åˆ°é”ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸‹é¢çš„acquireæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨AQSç±»ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">            selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tryAcquireæ–¹æ³•æ˜¯åœ¨å­ç±»å®ç°çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ReentrantLockçš„nonfairTryAcquireï¼Œä¹Ÿå°±æ˜¯éå…¬å¹³é”çš„å®ç°ã€‚</p><h3 id="nonfairTryAcquire-int-acquires-æ–¹æ³•"><a href="#nonfairTryAcquire-int-acquires-æ–¹æ³•" class="headerlink" title="nonfairTryAcquire(int acquires)æ–¹æ³•"></a>nonfairTryAcquire(int acquires)æ–¹æ³•</h3><p>ä¸‹é¢æ˜¯ReentrantLockï¼Œéå…¬å¹³é”çš„lockå®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">            <span class="keyword">int</span> c = getState();</span><br><span class="line">  <span class="comment">// è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">  <span class="comment">// é”å†²å…¥</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>int c = getState() == 0 åˆ™è¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹å æœ‰é”ï¼Œå½“å‰çº¿ç¨‹æ¥åŠ é”æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨caså°è¯•è·å–é”ã€‚</p><p>current == getExclusiveOwnerThread() è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰çº¿ç¨‹é”äº†ï¼Œ<code> int nextc = c + acquires;</code>åˆ™è¡¨ç¤ºæ”¯æŒé”é‡å…¥ï¼Œnextcçš„å€¼åˆ™è¡¨ç¤ºé”é‡å…¥çš„æ¬¡æ•°ï¼›</p><p>ä»¥ä¸Šå¦‚æœæ²¡æœ‰åŠ é”æˆåŠŸï¼Œåˆ™è¿”å›falseï¼Œç„¶åæ‰§è¡ŒAQSçš„acquireQueueæ–¹æ³•ï¼Œé¦–å…ˆå°†å½“å‰èŠ‚ç‚¹å°è£…æˆ<code>addWaiter(Node.EXCLUSIVE), arg)</code> æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶åˆ¤æ–­å¤´èŠ‚ç‚¹æ˜¯å¦è·å–é”æˆåŠŸï¼Œå¦‚æœæˆåŠŸäº†ï¼Œå°†å½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°å¤´ä¸Šï¼›</p><h3 id="AQS-addWaiter-Node-mode"><a href="#AQS-addWaiter-Node-mode" class="headerlink" title="AQS#addWaiter(Node mode)"></a>AQS#addWaiter(Node mode)</h3><p>æ·»åŠ èŠ‚ç‚¹åˆ°é˜Ÿåˆ—ä¸­ï¼ŒNode.EXCLUSIVEç‹¬å é”ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯<strong>å°¾æ’æ³•</strong>ï¼Œåœ¨é˜Ÿåˆ—çš„é˜Ÿå°¾æ·»åŠ æ–°çš„èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸æ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç©ºçš„ï¼Œåˆ™è°ƒç”¨enqæ–¹æ³•ï¼Œåˆ›å»ºé˜Ÿåˆ—ï¼Œå¹¶æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-enq-final-Node-node"><a href="#AQS-enq-final-Node-node" class="headerlink" title="AQS#enq(final Node node)"></a>AQS#enq(final Node node)</h3><p>ç¬¬ä¸€ä¸ªçº¿ç¨‹è·å–é”çš„æ—¶å€™ï¼Œè‚¯å®šæ˜¯æ— é”çš„çŠ¶æ€ï¼Œæ ¹æœ¬èµ°ä¸åˆ°è¿™ä¸€æ­¥ï¼Œæœ€æ—©èµ°åˆ°è¿™é‡Œçš„æ˜¯ç¬¬äºŒä¸ªå»è·å–é”çš„çº¿ç¨‹ã€‚</p><p>å½“ç¬¬äºŒä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°è¯¥æ–¹æ³•æ˜¯éœ€è¦æ‰§è¡Œ<strong>ä¸¤æ¬¡å¾ªç¯</strong>ï¼š</p><p>1ã€t == nullæ—¶ï¼Œéœ€è¦åˆå§‹åŒ–é˜Ÿåˆ—</p><p>2ã€æ‰§è¡Œä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå°†nodeæ·»åŠ åˆ°tail,ç”±äºè¿™ä¸ªæ–¹æ³•è¿˜æ˜¯å¤„åœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„ï¼Œæ‰€ä»¥ï¼Œè®¾ç½®é˜Ÿå°¾çš„æ—¶å€™è¿˜æ˜¯éœ€è¦casæ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-acquireQueued-final-Node-node-int-arg"><a href="#AQS-acquireQueued-final-Node-node-int-arg" class="headerlink" title="AQS#acquireQueued(final Node node, int arg)"></a>AQS#acquireQueued(final Node node, int arg)</h3><p><font color=red>è¿™ä¸ªæ–¹æ³•ç»å¯¹æ˜¯ç»å¯¹çš„AQSæ ¸å¿ƒæ–¹æ³•Â </font> â€¼ï¸</p><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æœ‰3ä¸ªé‡è¦æ“ä½œï¼š</p><p>1ã€åˆ¤æ–­å‰ç½®èŠ‚ç‚¹æ˜¯ä¸æ˜¯headï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå»å°è¯•è·å–é”ï¼›</p><p>2ã€å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸æ˜¯headï¼Œè¦æŠŠå‰ç½®èŠ‚ç‚¹çš„waitStateè®¾ç½®æˆSIGNALï¼ŒåŒæ—¶parkå½“å‰çº¿ç¨‹ï¼Œé¿å…ä¸€ç›´ç©ºè½¬ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ç”¨çš„  for (;;) {}</p><p>3ã€å¦‚æœè·å–é”å’Œparkéƒ½å¤±è´¥äº†ï¼Œåˆ™æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®æˆcancelçŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-cancelAcquire-Node-node"><a href="#AQS-cancelAcquire-Node-node" class="headerlink" title="AQS.cancelAcquire(Node node)"></a>AQS.cancelAcquire(Node node)</h3><p><code>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒéš¾ç†è§£ï¼Œæ€»ç»“ä¸€ä¸‹å°±å¹²äº†ä¸‹é¢å‡ ä¸ªäº‹ï¼š</code></p><p>1ã€æ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•çš„nodeè‚¯å®šæ˜¯è¦å–æ¶ˆçš„ï¼Œé‚£ä¸ªéœ€è¦threadè®¾ç½®æˆnull</p><p>2ã€æŸ¥çœ‹å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹æœ‰æ²¡æœ‰æ˜¯å–æ¶ˆçŠ¶æ€çš„ï¼Œä¸€èµ·è¸¢å‡ºé˜Ÿåˆ—</p><p>3ã€æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®æˆNode.CANCELLEDçŠ¶æ€</p><p>4ã€åˆ¤æ–­nodeåœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼Œå¦‚æœæ˜¯é˜Ÿå°¾çš„è¯ï¼ŒæŠŠtailæŒ‡å‘nodeçš„å‰ç½®èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠå‰é©±èŠ‚ç‚¹çš„nextæŒ‡å‘null</p><p>5ã€å¦‚æœä¸æ˜¯tailèŠ‚ç‚¹ï¼Œé‚£ä¹ˆåˆ¤æ–­æ˜¯ä¸æ˜¯headï¼Œå¦‚æœä¸æ˜¯headï¼Œé‚£ä¹ˆï¼Œå°†nodeçš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNALï¼Œå¹¶ä¸”æŠŠnodeçš„å‰é©±èŠ‚ç‚¹nodeçš„nextèŠ‚ç‚¹</p><p>6ã€å¦‚æœnodeæ˜¯headèŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥unparkæ­¤çº¿ç¨‹å»æ‰§è¡Œacquire</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Ignore if node doesn&#x27;t exist</span></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Skip cancelled predecessors</span></span><br><span class="line">        Node pred = node.prev;</span><br><span class="line">        <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>) <span class="comment">//cancelled</span></span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// predNext is the apparent node to unsplice. CASes below will</span></span><br><span class="line">        <span class="comment">// fail if not, in which case, we lost race vs another cancel</span></span><br><span class="line">        <span class="comment">// or signal, so no further action is necessary.</span></span><br><span class="line">        Node predNext = pred.next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can use unconditional write instead of CAS here.</span></span><br><span class="line">        <span class="comment">// After this atomic step, other Nodes can skip past us.</span></span><br><span class="line">        <span class="comment">// Before, we are free of interference from other threads.</span></span><br><span class="line">        node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we are the tail, remove ourselves.</span></span><br><span class="line">        <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">            compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If successor needs signal, try to set pred&#x27;s next-link</span></span><br><span class="line">            <span class="comment">// so it will get one. Otherwise wake it up to propagate.</span></span><br><span class="line">            <span class="keyword">int</span> ws;</span><br><span class="line">            <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">                ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">                 (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">                pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// ifæ‰§è¡Œçš„é€»è¾‘æ˜¯æŠŠå‰ç½®èŠ‚ç‚¹è®¾ç½®æˆNode.SIGNAL</span></span><br><span class="line">                Node next = node.next;</span><br><span class="line">                <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                  <span class="comment">// æŠŠnodeçš„å‰ç½®å‰ç½®èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘nodeçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå› ä¸ºä¸Šé¢nodeå·²ç»æ˜¯Node.CANCELLEDçŠ¶æ€äº†ï¼Œéœ€è¦è¸¢å‡ºé˜Ÿåˆ—</span></span><br><span class="line">                    compareAndSetNext(pred, predNext, next);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å‰ç½®èŠ‚ç‚¹æ˜¯headï¼Œæ­¤æ—¶æ²¡æœ‰è¢«äººç«äº‰é”èµ„æºï¼Œç›´æ¥å”¤é†’å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            node.next = node; <span class="comment">// help GC</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä»¥ReentrantLockçš„éå…¬å¹³é”ä¸ºä¾‹å­¦ä¹ äº†ä¸€ä¸‹ReentrantLockåŠ é”çš„è¿‡ç¨‹ã€‚é‚£ä¹ˆæ€è€ƒä¸€ä¸‹å…¬å¹³é”å’Œéå…¬å¹³é”çš„æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼ŸğŸ¤”</p><p>ç†è§£äº†ä¸Šé¢çš„æµç¨‹ä¹‹åï¼Œä¸‹é¢ç›´æ¥æ¯”è¾ƒæºç éå¾ˆå¥½ç†è§£ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ï¼</p><h2 id="å…¬å¹³é”å’Œéå…¬å¹³é”"><a href="#å…¬å¹³é”å’Œéå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”å’Œéå…¬å¹³é”"></a>å…¬å¹³é”å’Œéå…¬å¹³é”</h2><p>å¦‚ä½•åˆ¶å®šReentarntLockçš„å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çœ‹äº†NonfairSync#lockçš„å®ç°ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹FairSync#lockçš„å®ç°ï¼šğŸ‘‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3000897897090466540L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fair version of tryAcquire.  Don&#x27;t grant access unless</span></span><br><span class="line"><span class="comment">     * recursive call or no waiters or is first.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FairSyncå’ŒNonfairSyncéƒ½æ˜¯ReentrantLockçš„é™æ€å†…éƒ¨ç±»ï¼Œåœ¨FairSyncçš„lockæ–¹æ³•ä¸­ï¼Œæ²¡æœ‰ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">   setExclusiveOwnerThread(Thread.currentThread());</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç›´æ¥è°ƒç”¨AQS#acquire(1)æ–¹æ³•ï¼Œè€Œä¸”åœ¨ReentrantLock#FairSync#FairSync(int acquires)çš„å®ç°ä¸­ï¼Œæ·»åŠ äº†ä¸€ä¸ªåˆ¤æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">               compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">               setExclusiveOwnerThread(current);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯<code>hasQueuedPredecessors</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰èŠ‚ç‚¹åœ¨ç­‰å¾…ï¼Œå¦‚æœæœ‰çš„è¯ï¼ŒReentrantLock#FairSync#FairSync(int acquires)ç›´æ¥è¿”å›falseï¼Œå½“å‰èŠ‚ç‚¹æ™ºèƒ½è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™ä¸¤ç‚¹å°±æ˜¯å…¬å¹³é”å’Œéå…¬å¹³é”çš„æ˜æ˜¾åŒºåˆ«ä½“ç°ã€‚</p><h2 id="é‡Šæ”¾é”æ“ä½œ"><a href="#é‡Šæ”¾é”æ“ä½œ" class="headerlink" title="é‡Šæ”¾é”æ“ä½œ"></a>é‡Šæ”¾é”æ“ä½œ</h2><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802205517221.png" alt="image-20210802205517221"></p><h3 id="unlock"><a href="#unlock" class="headerlink" title="unlock()"></a>unlock()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-release-int-arg"><a href="#AQS-release-int-arg" class="headerlink" title="AQS#release(int arg)"></a>AQS#release(int arg)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tryReleaseçš„å…·ä½“å®ç°ä»æ˜¯æœ‰å…·ä½“çš„å­ç±»æ¥å®ç°çš„ã€‚</p><h3 id="ReentrantLock-tryRelease-int-releases-æ–¹æ³•"><a href="#ReentrantLock-tryRelease-int-releases-æ–¹æ³•" class="headerlink" title="ReentrantLock#tryRelease(int releases)æ–¹æ³•"></a>ReentrantLock#tryRelease(int releases)æ–¹æ³•</h3><p>1ã€é‡Šæ”¾é”çš„é€»è¾‘åº”è¯¥æ¯”è¾ƒå¥½ç†è§£ï¼Œæ˜¯å°†stateåšå‡æ³•ã€‚</p><p>2ã€åˆ¤æ–­state == 0 , åˆ™è¡¨ç¤ºæ— é”çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯0ï¼Œåˆ™è¡¨ç¤ºè¿˜åœ¨çº¿ç¨‹é‡å…¥çš„çŠ¶æ€ä¸‹ï¼ŒåŒæ—¶è®¾ç½®state</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼Œè®¾ç½®stateçš„æ—¶å€™æ˜¯ç›´æ¥èµ‹å€¼çš„ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨casï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">    state = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è€ƒè™‘åˆ°ä¸Šä¸‹æ–‡å°±å¾ˆç®€å•äº†ï¼Œæ­¤æ—¶è®¾ç½®stateçš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§çŠ¶æ€ï¼Œæ— é”å’Œé‡å…¥é”ï¼Œè‚¯å®šä¸ä¼šæ˜¯å¤šçº¿ç¨‹çš„åœºæ™¯ã€‚æ‰€ä»¥ä¸éœ€è¦casæ“ä½œã€‚</p><p>æ¥ç€åˆ†æä¸Šé¢çš„AQS#releaseæ–¹æ³•:</p><p>å½“stateè®¾ç½®æˆåŠŸä¹‹åï¼Œéœ€è¦åˆ¤æ–­headèŠ‚ç‚¹ï¼Œç„¶åå”¤é†’headçš„åé©±èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œå¦‚æœå­˜åœ¨çš„è¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// è¿™é‡Œæ˜¯å…±äº«é”ï¼Œåœ¨ReentarntLockå…ˆè·³è¿‡</span></span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="tryLock-long-time-TimeUnit-unit"><a href="#tryLock-long-time-TimeUnit-unit" class="headerlink" title="tryLock(long time, TimeUnit unit)"></a>tryLock(long time, TimeUnit unit)</h2><p><strong>æ–¹æ³•æè¿°å¦‚ä¸‹ï¼š</strong><br><font color=blue>åœ¨ç»™å®šçš„ç­‰å¾…æ—¶é—´å†…å¹¶ä¸”çº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­ä»¥åŠé”å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œå»è·å–é”ã€‚</font><br>å¦‚æœé”å¯ç”¨ï¼Œæ–¹æ³•ä¼šç›´æ¥è¿”å›ã€‚<br>å¦‚æœé”ä¸å¯ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹å°†ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€ä»¥è¾¾åˆ°çº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå¹¶ä¸”ä¼‘çœ ç›´åˆ°ä¸‹é¢ä¸‰ä¸ªäº‹ä»¶ä¸­çš„ä¸€ä¸ªå‘ç”Ÿï¼š<br>â‘ ã€å½“å‰çº¿ç¨‹è·å–åˆ°é”<br>â‘¡ã€å…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹<br>â‘¢ã€æŒ‡å®šçš„ç­‰å¾…æ—¶é—´å·²è¿‡<br>å‡å¦‚å½“å‰çº¿ç¨‹ï¼š<br>åœ¨è¯¥æ–¹æ³•çš„æ¡ç›®ä¸Šè®¾ç½®å…¶ä¸­æ–­çŠ¶æ€æˆ–åœ¨è·å–é”æ—¶ä¸­æ–­ï¼Œå¹¶ä¸”æ”¯æŒé”è·å–ä¸­æ–­æ—¶ï¼Œå°†æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œå½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€ä¼šè¢«æ¸…é™¤ã€‚<br>å‡å¦‚ç»™å®šçš„ç­‰å¾…æ—¶é—´å·²è¿‡ï¼Œå°†ä¼šè¿”å›falseã€‚</p><p>ä¸‹é¢å…·ä½“é˜…è¯»æºç å®ç°,æ–¹æ³•çš„å…¥å‚æŒ‡å®šäº†ç­‰å¾…æ—¶é—´ï¼Œå’Œæ—¶é—´çš„å•ä½ï¼Œæœ‰<code>NANOSECONDS</code>ã€<code>MICROSECONDS</code>ã€<code>MILLISECONDS</code>ã€<code>SECONDS</code>â€¦ç­‰å•ä½ã€‚</p><p>ä¸‹é¢å…·ä½“é˜…è¯»æºç å®ç°,æ–¹æ³•çš„å…¥å‚æŒ‡å®šäº†ç­‰å¾…æ—¶é—´ï¼Œå’Œæ—¶é—´çš„å•ä½ï¼Œæœ‰<code>NANOSECONDS</code>ã€<code>MICROSECONDS</code>ã€<code>MILLISECONDS</code>ã€<code>SECONDS</code>â€¦ç­‰å•ä½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(timeout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•çš„å†…éƒ¨è°ƒç”¨äº†<code>Sync</code>çš„<code>tryAcquireNanos</code>ï¼Œç»§ç»­å¾€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquireNanos</span><span class="params">(<span class="keyword">int</span> arg, <span class="keyword">long</span> nanosTimeout)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­ä¸­æ–­çŠ¶æ€å¹¶å†³å®šæ˜¯å¦æŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è°ƒç”¨doAcquireNanosè¿›è¡Œç­‰å¾…</span></span><br><span class="line">    <span class="keyword">return</span> tryAcquire(arg) ||</span><br><span class="line">        doAcquireNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tryAcqure</code>å’Œä¹‹å‰åˆ†æçš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œä¸å†èµ˜è¿°ã€‚<br>æ¥ä¸‹æ¥æ˜¯<code>doAcquireNanos</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">doAcquireNanos</span><span class="params">(<span class="keyword">int</span> arg, <span class="keyword">long</span> nanosTimeout)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœç»™å®šçš„æ—¶é—´å€¼å°äºç­‰äº0ï¼Œåˆ™ç›´æ¥è¿”å›false</span></span><br><span class="line">    <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//æ ¹æ®ç»™å®šå‚æ•°è®¡ç®—æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deadline = System.nanoTime() + nanosTimeout;</span><br><span class="line">    <span class="comment">//å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°CLHç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="comment">//åˆå§‹å¤±è´¥æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åœ¨ç»™å®šæ—¶é—´å†…å¾ªç¯/è‡ªæ—‹å°è¯•è·å–é”</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//å–å‡ºå‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">//å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸ºé¦–èŠ‚ç‚¹ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC å‰é¦–èŠ‚ç‚¹å‡ºé˜Ÿï¼Œå¸®åŠ©GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åˆ¤æ–­æ˜¯å¦ç­‰å¾…è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™è¿”å›false</span></span><br><span class="line">            nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//è¿™é‡Œåˆ¤æ–­æ˜¯å¦å¯ä»¥é˜»å¡çº¿ç¨‹å¹¶åšç›¸åº”æ“ä½œï¼Œè·Ÿä¹‹å‰åˆ†æçš„å‡ ä¸ªæ–¹æ³•ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡Œçš„é˜»å¡å¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¹¶ä¸”æ˜¯åœ¨æœ‰é™æ—¶é—´å†…é˜»å¡ï¼Œç±»ä¼¼äºsleep</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                nanosTimeout &gt; spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(<span class="keyword">this</span>, nanosTimeout);</span><br><span class="line">            <span class="comment">//åˆ¤æ–­ä¸­æ–­çŠ¶æ€ï¼Œå¹¶å†³å®šæ˜¯å¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>doAcquireNanos</code>çš„é˜»å¡æ˜¯æœ‰æ—¶é—´é™åˆ¶çš„ï¼Œæ‰€ä»¥èƒ½åœ¨ç»™å®šçš„æ—¶é—´å†…ï¼Œè¿”å›è·å–é”çš„æ“ä½œç»“æœã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://juejin.cn/post/6870099231361728525">https://juejin.cn/post/6870099231361728525</a></p><p><a href="https://www.processon.com/view/5f047c16f346fb1ae598b4dd?fromnew=1">https://www.processon.com/view/5f047c16f346fb1ae598b4dd?fromnew=1</a></p><p><a href="https://www.imooc.com/article/51118">https://www.imooc.com/article/51118</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ReentrantLock&quot;&gt;&lt;a href=&quot;#ReentrantLock&quot; class=&quot;headerlink&quot; title=&quot;ReentrantLock&quot;&gt;&lt;/a&gt;ReentrantLock&lt;/h1&gt;&lt;p&gt;ReentrantLocké‡å…¥é”ï¼Œæ˜¯å®ç°Lockæ¥å£</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹AQSåº•å±‚å®ç°ä¸åŸç†</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BAQS%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%8E%9F%E7%90%86/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BAQS%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%8E%9F%E7%90%86/</id>
    <published>2021-08-02T07:17:07.000Z</published>
    <updated>2021-08-03T01:45:36.985Z</updated>
    
    <content type="html"><![CDATA[<p>AQSé”é™æ—¶ç­‰å¾…æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p><p>å…¬å¹³é”ä¸éå…¬å¹³é”æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</p><h1 id="ç‹¬å é”-amp-å…±äº«é”"><a href="#ç‹¬å é”-amp-å…±äº«é”" class="headerlink" title="ç‹¬å é”&amp;å…±äº«é”"></a>ç‹¬å é”&amp;å…±äº«é”</h1><h2 id="ç‹¬å é”"><a href="#ç‹¬å é”" class="headerlink" title="ç‹¬å é”"></a>ç‹¬å é”</h2><p>å³åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ï¼Œå½“è¿™ä¸ªçº¿ç¨‹è¿˜æ²¡æœ‰é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯è·å–ä¸äº†çš„ï¼Œåªèƒ½åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè¿›è¡Œç­‰å¾…ã€‚</p><h1 id="å…¬å¹³é”-amp-éå…¬å¹³é”"><a href="#å…¬å¹³é”-amp-éå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”&amp;éå…¬å¹³é”"></a>å…¬å¹³é”&amp;éå…¬å¹³é”</h1><h2 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h2><p><strong>å…¬å¹³ç­–ç•¥ï¼š</strong>åœ¨å¤šä¸ªçº¿ç¨‹äº‰ç”¨é”çš„æƒ…å†µä¸‹ï¼Œå…¬å¹³ç­–ç•¥å€¾å‘äºå°†è®¿é—®æƒæˆäºˆç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç›¸å½“äºæœ‰ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼Œå…ˆè¿›å…¥ç­‰å¾…é˜Ÿåˆ—çš„çº¿ç¨‹åç»­ä¼šå…ˆè·å¾—é”ï¼Œè¿™æ ·æŒ‰ç…§â€œå…ˆæ¥ååˆ°â€çš„åŸåˆ™ï¼Œå¯¹äºæ¯ä¸€ä¸ªç­‰å¾…çº¿ç¨‹éƒ½æ˜¯å…¬å¹³çš„ã€‚</p><h2 id="éå…¬å¹³é”"><a href="#éå…¬å¹³é”" class="headerlink" title="éå…¬å¹³é”"></a>éå…¬å¹³é”</h2><p>åœ¨å¤šä¸ªçº¿ç¨‹äº‰ç”¨é”çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿæœ€ç»ˆè·å¾—é”çš„çº¿ç¨‹æ˜¯éšæœºçš„ï¼ˆç”±åº•å±‚OSè°ƒåº¦ï¼‰ã€‚</p><blockquote><p><em>æ³¨æ„ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…¬å¹³ç­–ç•¥çš„ç¨‹åºåœ¨å¤šçº¿ç¨‹è®¿é—®æ—¶ï¼Œæ€»ä½“ååé‡ï¼ˆå³é€Ÿåº¦å¾ˆæ…¢ï¼Œå¸¸å¸¸æå…¶æ…¢ï¼‰æ¯”è¾ƒä½ï¼Œå› ä¸ºæ­¤æ—¶åœ¨çº¿ç¨‹è°ƒåº¦ä¸Šé¢çš„å¼€é”€æ¯”è¾ƒå¤§ã€‚</em></p></blockquote><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802175827435.png" alt="image-20210802175827435" style="zoom:50%;" /><h1 id="AQSæ˜¯ä»€ä¹ˆ"><a href="#AQSæ˜¯ä»€ä¹ˆ" class="headerlink" title="AQSæ˜¯ä»€ä¹ˆ"></a>AQSæ˜¯ä»€ä¹ˆ</h1><p>åŒæ­¥å™¨æ˜¯ç”¨æ¥æ„å»ºé”å’Œå…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒçš„å®ç°ä¸»è¦ä¾èµ–äºä¸€ä¸ªintç±»å‹çš„æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ä»¥åŠä¸€ä¸ªFIFOé˜Ÿåˆ—æ„å»ºç­‰å¾…é˜Ÿåˆ—ã€‚å®ƒçš„å­ç±»å¿…é¡»é‡å†™AQSå®šä¹‰çš„å‡ ä¸ªprotectedä¿®é¥°çš„ç”¨æ¥æ”¹å˜åŒæ­¥çŠ¶æ€çš„æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•ä¸»è¦æ˜¯ç”¨æ¥å®ç°æ’é˜Ÿå’Œé˜»å¡æœºåˆ¶çš„ã€‚</p><p>åŒæ­¥å™¨æ˜¯å®ç°é”çš„å…³é”®ï¼Œåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨ï¼Œåˆ©ç”¨åŒæ­¥å™¨å®ç°é”çš„è¯­ä¹‰ï¼Œå¯ä»¥è¿™æ ·ç†è§£ä¸¤è€…çš„å…³ç³»ï¼š</p><p>é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…å’Œé”äº¤äº’çš„æ¥å£ï¼Œéšè—äº†å®ç°çš„ç»†èŠ‚ï¼ŒåŒæ­¥å™¨æ˜¯é¢å‘é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼Œçº¿ç¨‹çš„æ’é˜Ÿï¼Œç­‰å¾…å’Œå”¤é†’ç­‰åº•å±‚æ“ä½œã€‚</p><p><strong>AQSçš„è®¾è®¡æ˜¯ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œå®ƒå°†ä¸€ä¸ªæ–¹æ³•å¼€æ”¾ç»™å­ç±»é‡å†™ï¼Œè€ŒåŒæ­¥å™¨ç»™åŒæ­¥ç»„ä»¶æ‰€æä¾›çš„æ¨¡ç‰ˆæ–¹æ³•åˆä¼šé‡æ–°è°ƒç”¨å­ç±»æ‰€é‡å†™çš„æ–¹æ³•ã€‚</strong></p><h1 id="AQSæ ¸å¿ƒæ€æƒ³"><a href="#AQSæ ¸å¿ƒæ€æƒ³" class="headerlink" title="AQSæ ¸å¿ƒæ€æƒ³"></a>AQSæ ¸å¿ƒæ€æƒ³</h1><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚</p><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶AQSæ˜¯ç”¨CLHé˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚</p><p>1ã€AQSä½¿ç”¨ä¸€ä¸ªintæˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€</p><p>2ã€ä½¿ç”¨Nodeå®ç°FIFOé˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨äºæ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥è£…ç½®</p><p>AQSèµ„æºå…±äº«æ–¹å¼ï¼šç‹¬å Exclusiveï¼ˆæ’å®ƒé”æ¨¡å¼ï¼‰å’Œå…±äº«Shareï¼ˆå…±äº«é”æ¨¡å¼ï¼‰</p><blockquote><p>AQSå®ƒçš„æ‰€æœ‰å­ç±»ä¸­ï¼Œè¦ä¹ˆå®ç°å¹¶ä½¿ç”¨äº†å®ƒçš„ç‹¬å åŠŸèƒ½çš„apiï¼Œè¦ä¹ˆä½¿ç”¨äº†å…±äº«é”çš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šåŒæ—¶ä½¿ç”¨ä¸¤å¥—apiï¼Œå³ä¾¿æ˜¯æœ€æœ‰åçš„å­ç±»ReentrantReadWriteLockä¹Ÿæ˜¯é€šè¿‡ä¸¤ä¸ªå†…éƒ¨ç±»è¯»é”å’Œå†™é”åˆ†åˆ«å®ç°äº†ä¸¤å¥—apiæ¥å®ç°çš„</p></blockquote><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802175542181.png" alt="image-20210802175542181" style="zoom:50%;" /><h2 id="stateçŠ¶æ€"><a href="#stateçŠ¶æ€" class="headerlink" title="stateçŠ¶æ€"></a>stateçŠ¶æ€</h2><p>stateçŠ¶æ€ä½¿ç”¨volatile intç±»å‹çš„å˜é‡ï¼Œè¡¨ç¤ºå½“å‰åŒæ­¥çŠ¶æ€ã€‚stateçš„è®¿é—®æ–¹å¼æœ‰ä¸‰ç§:</p><p><code>getState()</code><br> <code>setState()</code><br> <code>compareAndSetState()</code></p><h2 id="Nodeå†…éƒ¨ç±»"><a href="#Nodeå†…éƒ¨ç±»" class="headerlink" title="Nodeå†…éƒ¨ç±»"></a>Nodeå†…éƒ¨ç±»</h2><p>Nodeç±»æ˜¯AQSçš„ç»å¯¹æ ¸å¿ƒç±»ï¼ŒAQSåŸºäºNodeæ¥æ„å»ºåŒæ­¥é˜Ÿåˆ—å’ŒConditioné˜Ÿåˆ—ï¼›</p><p><strong>æºç å¦‚ä¸‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** Marker to indicate a node is waiting in shared mode */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">        <span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/** waitStatus value to indicate successor&#x27;s thread needs unparking */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment">         * unconditionally propagate</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line">        <span class="keyword">volatile</span> Node prev;</span><br><span class="line">        <span class="keyword">volatile</span> Node next;</span><br><span class="line">        <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">        Node nextWaiter;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns true if node is waiting in shared mode.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// è·å–å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">            Node p = prev;</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node() &#123;    <span class="comment">// Used to establish initial head or SHARED marker</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">            <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">            <span class="keyword">this</span>.thread = thread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123; <span class="comment">// Used by Condition</span></span><br><span class="line">            <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">            <span class="keyword">this</span>.thread = thread;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>CANCELLED</strong><br> waitStatuså€¼ä¸º1æ—¶è¡¨ç¤ºè¯¥çº¿ç¨‹èŠ‚ç‚¹å·²é‡Šæ”¾ï¼ˆè¶…æ—¶ã€ä¸­æ–­ï¼‰ï¼Œå·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸ä¼šå†é˜»å¡ã€‚</p><p><strong>SIGNAL</strong><br> waitStatusä¸º-1æ—¶è¡¨ç¤ºè¯¥çº¿ç¨‹çš„åç»­çº¿ç¨‹éœ€è¦é˜»å¡ï¼Œå³åªè¦å‰ç½®èŠ‚ç‚¹é‡Šæ”¾é”ï¼Œå°±ä¼šé€šçŸ¥æ ‡è¯†ä¸º SIGNAL çŠ¶æ€çš„åç»­èŠ‚ç‚¹çš„çº¿ç¨‹</p><p><strong>CONDITION</strong><br> waitStatusä¸º-2æ—¶ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹åœ¨conditioné˜Ÿåˆ—ä¸­é˜»å¡ï¼ˆConditionæœ‰ä½¿ç”¨ï¼‰</p><p><strong>PROPAGATE</strong><br> waitStatusä¸º-3æ—¶ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹ä»¥åŠåç»­çº¿ç¨‹è¿›è¡Œæ— æ¡ä»¶ä¼ æ’­ï¼ˆCountDownLatchä¸­æœ‰ä½¿ç”¨ï¼‰å…±äº«æ¨¡å¼ä¸‹ï¼Œ PROPAGATE çŠ¶æ€çš„çº¿ç¨‹å¤„äºå¯è¿è¡ŒçŠ¶æ€</p><h1 id="AQSä¹‹ç‹¬å -éå…¬å¹³"><a href="#AQSä¹‹ç‹¬å -éå…¬å¹³" class="headerlink" title="AQSä¹‹ç‹¬å +éå…¬å¹³"></a>AQSä¹‹ç‹¬å +éå…¬å¹³</h1><h2 id="è·å–é”acquire"><a href="#è·å–é”acquire" class="headerlink" title="è·å–é”acquire"></a>è·å–é”acquire</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802195409121.png" alt="image-20210802195409121" style="zoom:50%;" /><p>ReentrantLockæ˜¯AQSç‹¬å æ¨¡å¼çš„ç»å…¸å®ç°ï¼ŒReentrantLockåœ¨æ„é€ å®ä¾‹æ˜¯å¯ä»¥æŒ‡å®šæ˜¯å¦æ˜¯fair lockã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates an instance of &#123;<span class="doctag">@code</span> ReentrantLock&#125; with the</span></span><br><span class="line"><span class="comment">    * given fairness policy.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fair &#123;<span class="doctag">@code</span> true&#125; if this lock should use a fair ordering policy</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">       sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="acquireæ–¹æ³•è·å–è®¸å¯"><a href="#acquireæ–¹æ³•è·å–è®¸å¯" class="headerlink" title="acquireæ–¹æ³•è·å–è®¸å¯"></a>acquireæ–¹æ³•è·å–è®¸å¯</h3><p>ä¸‹é¢æˆ‘ä»¬å°±ä»é”çš„è·å–å…¥æ‰‹å¼€å§‹è§£è¯»AQSï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="tryAcquireæŠ½è±¡æ–¹æ³•"><a href="#tryAcquireæŠ½è±¡æ–¹æ³•" class="headerlink" title="tryAcquireæŠ½è±¡æ–¹æ³•"></a>tryAcquireæŠ½è±¡æ–¹æ³•</h3><p>tryAcquireæ˜¯ä¸ªprotectedæ–¹æ³•ï¼Œå…·ä½“æ˜¯å®ç°åœ¨å¯¹åº”çš„å­ç±»ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½å°±æ˜¯å°è¯•å»ä¿®æ”¹stateçš„çŠ¶æ€å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯"><a href="#nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯" class="headerlink" title="nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯"></a>nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock éå…¬å¹³é”è¿›æ¥å°±å¼€å§‹æŠ¢å é”ï¼Œä½“ç°éå…¬å¹³æ€§</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä»¥ReentrantLockæ–¹æ³•çš„å®ç°ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line"><span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">            <span class="comment">// getState()è¿”å›çš„å°±æ˜¯AQSç±»ä¸­çš„stateå­—æ®µçš„å€¼</span></span><br><span class="line">            <span class="keyword">int</span> c = getState();</span><br><span class="line">            <span class="comment">// c == 0 è¯´æ˜å½“å‰é”æ²¡æœ‰è¢«ä»»ä½•çº¿ç¨‹å æœ‰</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨caså»ä¿®æ”¹stateçš„å€¼ï¼Œç‹¬å æ¨¡å¼ä¸‹acquires = 1</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                <span class="comment">// ä¿®æ”¹stateæˆåŠŸä¹‹åï¼Œå°†ç‹¬å çº¿ç¨‹è®¾ç½®æˆå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”è¿”å›trueï¼Œè¡¨ç¤ºæŠ¢å é”æˆåŠŸ</span></span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœstate ï¼= 0 å¹¶ä¸”ç‹¬å çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æŒæœ‰å¯¹è±¡çš„é”ï¼Œæ­¤æ—¶ï¼Œéœ€è¦é”é‡å…¥ï¼Œstateç»§ç»­ç´¯åŠ </span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>AQSçš„acquire(int arg)æ–¹æ³•ä¸­è¿˜æœ‰ä¸€éƒ¨åˆ†å°±æ˜¯ <code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code></p><h3 id="addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—"><a href="#addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—"></a>addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—</h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹addWaiteræ–¹æ³•ï¼Œjava.util.concurrent.locks.AbstractQueuedSynchronizer#addWaiter</p><p>å¦‚æœtryAcquireè¿”å›FALSEï¼ˆè·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼‰ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°CLHåŒæ­¥é˜Ÿåˆ—å°¾éƒ¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line"><span class="comment">// é¦–å…ˆåˆ›å»ºä¸€ä¸ªNodeèŠ‚ç‚¹</span></span><br><span class="line">        Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">        <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">        Node pred = tail;</span><br><span class="line">        <span class="comment">// cas å°†å½“å‰èŠ‚ç‚¹è®¾ç½®åˆ°åŒæ­¥é˜Ÿåˆ—çš„é˜Ÿå°¾</span></span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸Šé¢casè®¾ç½®æ²¡æœ‰æˆåŠŸï¼Œåˆ™é€šè¿‡enqæ–¹æ³•å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>java.util.concurrent.locks.AbstractQueuedSynchronizer#enq</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           Node t = tail;</span><br><span class="line">           <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; </span><br><span class="line">               <span class="comment">// Must initialize åˆå§‹åŒ–å¤´èŠ‚ç‚¹</span></span><br><span class="line">               <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                   tail = head;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               node.prev = t;</span><br><span class="line">               <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                   t.next = node;</span><br><span class="line">                   <span class="keyword">return</span> t;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è‡ªæ—‹ï¼Œæœ€ç»ˆå°†nodeèŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p><h3 id="acquireQueuedè·å–è®¸å¯"><a href="#acquireQueuedè·å–è®¸å¯" class="headerlink" title="acquireQueuedè·å–è®¸å¯"></a>acquireQueuedè·å–è®¸å¯</h3><p>èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¹‹ä¸­ï¼Œç„¶åæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³• â€¼ï¸</p><p>acquireQueuedæ–¹æ³•ä¸ºä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰çº¿ç¨‹ï¼ˆNodeï¼‰è¿›å…¥åŒæ­¥é˜Ÿåˆ—åï¼Œå°±ä¼šè¿›å…¥ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè‡ªçœåœ°è§‚å¯Ÿï¼Œå½“æ¡ä»¶æ»¡è¶³ï¼Œè·å–åˆ°åŒæ­¥çŠ¶æ€åï¼Œå°±å¯ä»¥ä»è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºï¼Œå¦åˆ™ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">              <span class="comment">// å¦‚æœnodeèŠ‚ç‚¹æ˜¯é˜Ÿåˆ—ä¸­ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼ˆå› ä¸ºç¬¬ä¸€ä¸ªæ­£åœ¨æ‰§è¡ŒçŠ¶æ€ï¼‰è‚¯å®šè¦é˜Ÿåˆ—ä¸­ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹å°è¯•è·å–é”</span></span><br><span class="line">                <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">              <span class="comment">// ç¬¬äºŒä¸ªèŠ‚ç‚¹è°ƒç”¨tryAcquireæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                   <span class="comment">//æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®æˆé˜Ÿåˆ—å¤´èŠ‚ç‚¹</span></span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·é˜Ÿåˆ—ä¸­åç»­çš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    interrupted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœè·å–é”å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="shouldParkAfterFailedAcquireæ–¹æ³•"><a href="#shouldParkAfterFailedAcquireæ–¹æ³•" class="headerlink" title="shouldParkAfterFailedAcquireæ–¹æ³•"></a>shouldParkAfterFailedAcquireæ–¹æ³•</h3><p>shouldParkAfterFailedAcquireå°†é˜Ÿåˆ—åç»­èŠ‚ç‚¹æŒ‚èµ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">       <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">         <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„waitStatus == Node.SIGNAL åˆ™ç›´æ¥è¿”å›true</span></span><br><span class="line">         <span class="comment">// å› ä¸ºå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯Node.SIGNALæ—¶ï¼Œæ‰ä¼šé€šçŸ¥åç»­èŠ‚ç‚¹è¿›è¡Œparkæˆ–è€…unpark</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">//  static final int CANCELLED =  1;</span></span><br><span class="line">         <span class="comment">// å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ç›´æ¥åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­å»é™¤</span></span><br><span class="line">           <span class="keyword">do</span> &#123;</span><br><span class="line">               node.prev = pred = pred.prev;</span><br><span class="line">           &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">           pred.next = node;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// å°†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„waitStatusè®¾ç½®æˆNode.SIGNAL</span></span><br><span class="line">           compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private final boolean parkAndCheckInterrupt() &#123;</span><br><span class="line">// æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œèµ°åˆ°è¿™è‚¯å®šæ˜¯æ²¡æœ‰æ‹¿åˆ°æ‰§è¡Œæƒçš„ï¼Œçº¿ç¨‹éœ€è¦æŒ‚èµ·ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”</span><br><span class="line">    LockSupport.park(this);</span><br><span class="line">    return Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå¦‚æœè·å–å¤±è´¥çš„è¯ï¼Œä¼šè°ƒç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š</p><h3 id="cancelAcquireå–æ¶ˆè·å–"><a href="#cancelAcquireå–æ¶ˆè·å–" class="headerlink" title="cancelAcquireå–æ¶ˆè·å–"></a>cancelAcquireå–æ¶ˆè·å–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœèŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// ç”±äºçº¿ç¨‹è¦è¢«å–æ¶ˆäº†ï¼Œæ‰€ä»¥å°† thread çº¿ç¨‹æ¸…æ‰</span></span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢è¿™æ­¥è¡¨ç¤ºå°† node çš„ pre æŒ‡å‘ä¹‹å‰ç¬¬ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„ç»“ç‚¹ï¼ˆå³è·³è¿‡æ‰€æœ‰å–æ¶ˆçŠ¶æ€çš„ç»“ç‚¹ï¼‰,waitStatus &gt; 0 è¡¨ç¤ºå½“å‰ç»“ç‚¹çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç»è¿‡è¿‡æ»¤åçš„ pre çš„ next ç»“ç‚¹ï¼Œè¿™ä¸€æ­¥ä¸»è¦ç”¨åœ¨åé¢çš„ CAS è®¾ç½® pre çš„ next èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line">    <span class="comment">// å°†å½“å‰ç»“ç‚¹è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å–æ¶ˆç»“ç‚¹ä¸ºå°¾ç»“ç‚¹ï¼Œä½¿ç”¨ CAS åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸ºå…¶å‰é©±èŠ‚ç‚¹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™å°¾ç»“ç‚¹çš„ next æŒ‡é’ˆè®¾ç½®ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸€æ­¥çœ‹å¾—æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æƒ³æƒ³ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œé‚£æ˜¯ä¸æ˜¯è¦æŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯æˆ‘ä»¬ä¹‹å‰ä¹Ÿè¯´äº†ï¼Œè¦å”¤é†’æˆ–é˜»å¡ç»“ç‚¹ï¼Œé¡»åœ¨å…¶å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNAL çš„æ¡ä»¶æ‰èƒ½æ“ä½œï¼Œ</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥åœ¨è®¾ç½® pre çš„ next èŠ‚ç‚¹æ—¶è¦ä¿è¯ pre ç»“ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œæƒ³é€šäº†è¿™ä¸€ç‚¹ç›¸ä¿¡ä½ ä¸éš¾ç†è§£ä»¥ä¸‹ä»£ç ã€‚</span></span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ pre ä¸º headï¼Œæˆ–è€…  pre çš„çŠ¶æ€è®¾ç½® SIGNAL å¤±è´¥ï¼Œåˆ™ç›´æ¥å”¤é†’åç»§ç»“ç‚¹å»ç«äº‰é”ï¼Œä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ SIGNAL çš„ç»“ç‚¹å–æ¶ˆï¼ˆæˆ–é‡Šæ”¾é”ï¼‰åå¯ä»¥å”¤é†’åç»§ç»“ç‚¹</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é‡Šæ”¾é”release"><a href="#é‡Šæ”¾é”release" class="headerlink" title="é‡Šæ”¾é”release"></a>é‡Šæ”¾é”release</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tryReleaseæ–¹æ³•ä¹Ÿæ˜¯ç”±å­ç±»æ¥å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">            <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                free = <span class="keyword">true</span>;</span><br><span class="line">              <span class="comment">// å°†ç‹¬å çº¿ç¨‹è®¾ç½®æˆnullï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”æ—¶ä¼šè®¾ç½®æˆè‡ªå·±çš„</span></span><br><span class="line">                setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setState(c);</span><br><span class="line">            <span class="keyword">return</span> free;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ‰§è¡ŒunparkSuccessor(h);æ–¹æ³•äº†ï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾äº†é”ä¹‹åï¼Œéœ€è¦å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ã€‚è¿™é‡Œæ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œè¦æ‰§è¡Œçš„NodeèŠ‚ç‚¹çš„waitStatusè‚¯å®šæ˜¯0ï¼›ï¼Ÿï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">       <span class="comment">//ç½®é›¶å½“å‰çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹çŠ¶æ€ï¼Œå…è®¸å¤±è´¥</span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹å¾€åæ‰¾waitStatus&lt;=0çš„èŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡Œunpark</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">  <span class="comment">// æ‰¾åˆ°ä¸‹ä¸€ä¸ªéœ€è¦å”¤é†’çš„ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conditionåœ¨AQSä¸­çš„å®ç°"><a href="#Conditionåœ¨AQSä¸­çš„å®ç°" class="headerlink" title="Conditionåœ¨AQSä¸­çš„å®ç°"></a>Conditionåœ¨AQSä¸­çš„å®ç°</h1><p>ä¸Šé¢å·²ç»ä»‹ç»äº†<code>AQS</code>æ‰€æä¾›çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå½“ç„¶å®ƒè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç‰¹æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥ç»§ç»­è¯´ä¸‹<code>Condition</code>è¿™ä¸ªç»„ä»¶ã€‚</p><p>Conditionæ˜¯åœ¨java 1.5ä¸­æ‰å‡ºç°çš„ï¼Œå®ƒç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„<code>Object</code>çš„<code>wait()</code>ã€<code>notify()</code>å®ç°çº¿ç¨‹é—´çš„åä½œï¼Œç›¸æ¯”ä½¿ç”¨<code>Object</code>çš„<code>wait()</code>ã€<code>notify()</code>ï¼Œä½¿ç”¨<code>Condition</code>ä¸­çš„<code>await()</code>ã€<code>signal()</code>è¿™ç§æ–¹å¼å®ç°çº¿ç¨‹é—´åä½œæ›´åŠ å®‰å…¨å’Œé«˜æ•ˆã€‚å› æ­¤é€šå¸¸æ¥è¯´æ¯”è¾ƒæ¨èä½¿ç”¨`Condition</p><p>å…¶ä¸­<code>AbstractQueueSynchronizer</code>ä¸­å®ç°äº†<code>Condition</code>ä¸­çš„æ–¹æ³•ï¼Œä¸»è¦å¯¹å¤–æä¾›<code>awaite(Object.wait())</code>å’Œ<code>signal(Object.notify())</code>è°ƒç”¨ã€‚</p><h2 id="Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨"><a href="#Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨" class="headerlink" title="Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨"></a>Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Condition condition = lock.newCondition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€åŠ é”æˆåŠŸ&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€æ‰§è¡Œawaitè¢«æŒ‚èµ·&quot;</span>);</span><br><span class="line">                condition.await();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€è¢«å”¤é†’æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€é‡Šæ”¾é”æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒåŠ é”æˆåŠŸ&quot;</span>);</span><br><span class="line">                condition.signal();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒå”¤é†’çº¿ç¨‹ä¸€&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒé‡Šæ”¾é”æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹ä¸€è°ƒç”¨äº†condition.await();ä¹‹åï¼Œçº¿ç¨‹äºŒæ‰å¯ä»¥è·å–åˆ°é”å¹¶ä¸”æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼Œçº¿ç¨‹äºŒè°ƒç”¨ condition.signal();ä¹‹åå”¤é†’çº¿ç¨‹ä¸€ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œåªæœ‰åœ¨çº¿ç¨‹äºŒæ‰§è¡Œå®Œæˆä¹‹åè°ƒç”¨lock.unlock();ä¹‹åï¼Œçº¿ç¨‹ä¸€é‡æ–°å›å»åˆ°é”ï¼Œç„¶åæ‰§è¡Œçº¿ç¨‹ä¸€åç»­çš„æµç¨‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802183143055.png" alt="image-20210802183143055"></p><h2 id="awaitæ–¹æ³•"><a href="#awaitæ–¹æ³•" class="headerlink" title="awaitæ–¹æ³•"></a>awaitæ–¹æ³•</h2><p>awaitä½¿å½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè®¸å¯ï¼Œç„¶åè¿›å…¥Conditioné˜Ÿåˆ—ï¼Œç­‰å¾…åœ¨æŸä¸ªæ—¶åˆ»è¢«æŸä¸ªçº¿ç¨‹å”¤é†’ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  <span class="comment">// å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeèŠ‚ç‚¹æ·»åŠ çš„Conditioné˜Ÿåˆ—ä¸­</span></span><br><span class="line">            Node node = addConditionWaiter();</span><br><span class="line">  <span class="comment">// æ·»åŠ åˆ°Conditioné˜Ÿåˆ—ä¸­çš„çº¿ç¨‹éœ€è¦é‡Šæ”¾é”èµ„æº</span></span><br><span class="line">            <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">            <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ˜¯ä¸æ˜¯åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">            <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">              <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆç›´æ¥parkæŒ‚èµ·</span></span><br><span class="line">                LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">  <span class="comment">//  è¡¨æ˜å·²ç»æœ‰çš„çº¿ç¨‹è°ƒç”¨äº†signalå”¤é†’å½“å‰çº¿ç¨‹ï¼Œ</span></span><br><span class="line">  <span class="comment">// å¹¶ä¸”èŠ‚ç‚¹å·²ç»å­˜æ”¾åˆ°äº†åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨å¦‚æœacquireQueuedè¯·æ±‚è®¸å¯äº†</span></span><br><span class="line">  <span class="comment">// savedStateæ˜¯è·å–è®¸å¯çš„ä¸ªæ•° è¿™ä¸ªè¦å’Œä¹‹å‰é‡Šæ”¾çš„è®¸å¯ä¸ªæ•°ä¸€è‡´</span></span><br><span class="line">            <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">                interruptMode = REINTERRUPT;</span><br><span class="line">            <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">                unlinkCancelledWaiters();</span><br><span class="line">            <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">                reportInterruptAfterWait(interruptMode);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><strong>addConditionWaiteræ–¹æ³•æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹åˆ°Conditioné˜Ÿåˆ—ä¸­</strong></p><p>java.util.concurrent.locks.AbstractQueuedSynchronizer.ConditionObject#addConditionWaiter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node t = lastWaiter;</span><br><span class="line">            <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">              <span class="comment">// å…ˆæ£€æŸ¥ä¸€éæœ‰æ²¡æœ‰å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæ¸…é™¤æ‰</span></span><br><span class="line">                unlinkCancelledWaiters();</span><br><span class="line">                t = lastWaiter;</span><br><span class="line">            &#125;</span><br><span class="line">  <span class="comment">// å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeæ·»åŠ åˆ°Conditioné˜Ÿåˆ—ä¸­</span></span><br><span class="line">            Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">                firstWaiter = node;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                t.nextWaiter = node;</span><br><span class="line">            lastWaiter = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2 id="signalæ–¹æ³•"><a href="#signalæ–¹æ³•" class="headerlink" title="signalæ–¹æ³•"></a>signalæ–¹æ³•</h2><p>å”¤é†’ä¸€ä¸ªçº¿ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">            Node first = firstWaiter;</span><br><span class="line">            <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">                doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="doSignalæ–¹æ³•"><a href="#doSignalæ–¹æ³•" class="headerlink" title="doSignalæ–¹æ³•"></a>doSignalæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">                    lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">                first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">              <span class="comment">// å°†Conditioné˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹çŠ¶æ€è®¾ç½®æˆSIGNALï¼Œå¹¶å°†èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">            &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">                     (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="transferForSignalæ–¹æ³•"><a href="#transferForSignalæ–¹æ³•" class="headerlink" title="transferForSignalæ–¹æ³•"></a>transferForSignalæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If cannot change waitStatus, the node has been cancelled.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">         <span class="comment">// å°†èŠ‚ç‚¹çŠ¶æ€æ”¹æˆ0 </span></span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Splice onto queue and try to set waitStatus of predecessor to</span></span><br><span class="line"><span class="comment">         * indicate that thread is (probably) waiting. If cancelled or</span></span><br><span class="line"><span class="comment">         * attempt to set waitStatus fails, wake up to resync (in which</span></span><br><span class="line"><span class="comment">         * case the waitStatus can be transiently and harmlessly wrong).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">         <span class="comment">// æŠŠå½“å‰æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿”å›å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        Node p = enq(node);</span><br><span class="line">        <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">        <span class="comment">// è®¾ç½®å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL</span></span><br><span class="line">        <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        <span class="comment">// å”¤é†’å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">            LockSupport.unpark(node.thread);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://mp.weixin.qq.com/s/hB5ncpe7_tVovQj1sNlDRA">https://mp.weixin.qq.com/s/hB5ncpe7_tVovQj1sNlDRA</a></p><p><a href="https://mp.weixin.qq.com/s/iNz6sTen2CSOdLE0j7qu9A">https://mp.weixin.qq.com/s/iNz6sTen2CSOdLE0j7qu9A</a></p><p><a href="https://github.com/AobingJava/JavaFamily">https://github.com/AobingJava/JavaFamily</a></p><p><a href="https://segmentfault.com/a/1190000015804888/">https://segmentfault.com/a/1190000015804888/</a></p><p><a href="https://juejin.cn/post/6844903997438951437">https://juejin.cn/post/6844903997438951437</a></p><p><a href="https://juejin.cn/post/6870099231361728525">https://juejin.cn/post/6870099231361728525</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;AQSé”é™æ—¶ç­‰å¾…æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å…¬å¹³é”ä¸éå…¬å¹³é”æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ&lt;/p&gt;
&lt;h1 id=&quot;ç‹¬å é”-amp-å…±äº«é”&quot;&gt;&lt;a href=&quot;#ç‹¬å é”-amp-å…±äº«é”&quot; class=&quot;headerlink&quot; title=&quot;ç‹¬å é”&amp;amp;å…±äº«é”&quot;&gt;&lt;/a&gt;ç‹¬å é”&amp;amp</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ç³»åˆ—åˆé›†</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97%E5%90%88%E9%9B%86/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%B3%BB%E5%88%97%E5%90%88%E9%9B%86/</id>
    <published>2021-08-02T03:22:49.000Z</published>
    <updated>2021-08-04T06:26:23.238Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾"><a href="#Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾" class="headerlink" title="Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾"></a>Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802193933121.png" alt="image-20210802193933121"  /><h2 id="çŸ¥è¯†æ¸…å•"><a href="#çŸ¥è¯†æ¸…å•" class="headerlink" title="çŸ¥è¯†æ¸…å•"></a>çŸ¥è¯†æ¸…å•</h2><ul><li>Javaå¤šçº¿ç¨‹ä¸å¹¶å‘åŸºç¡€</li><li><a href="https://geekibli.github.io/wiki/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">Javaå†…å­˜æ¨¡å‹</a></li><li><a href="https://geekibli.github.io/wiki/Java-synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E5%89%96%E6%9E%90/">æ·±å…¥ç†è§£åŒæ­¥é”-synchronizedå…³é”®å­—</a></li><li><a href="https://geekibli.github.io/wiki/Java-synchronzied%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">synchronizedå®ç°åŸç†æ¦‚è¿°</a></li><li><a href="https://geekibli.github.io/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3volatile/">æ·±å…¥ç†è§£volatileå…³é”®å­—</a></li><li>æ·±å…¥ç†è§£finalå…³é”®å­—</li><li>æ·±å…¥ç†è§£å¹¶å‘ç¼–ç¨‹ä¹‹Blocking Queue</li><li><a href="https://geekibli.github.io/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BAQS%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%8E%9F%E7%90%86/">æ·±å…¥ç†è§£å¹¶å‘ç¼–ç¨‹ä¹‹AQS</a></li><li><a href="https://geekibli.github.io/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ReetrantLock/">æ·±å…¥ç†è§£ReentrantLockåº”ç”¨åŠå®ç°</a></li><li><a href="https://geekibli.github.io/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCondition%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82/">æ·±å…¥Conditionæœºåˆ¶çš„åº•å±‚åŸç†</a></li><li><a href="https://geekibli.github.io/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6/">Javaå¤šçº¿ç¨‹ä¹‹ä¸­æ–­æœºåˆ¶</a></li><li>æ·±å…¥ç†è§£å¹¶å‘å®¹å™¨ä¹‹concurrentHashMap</li><li><a href="https://geekibli.github.io/wiki/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BThreadLocal/">æ·±å…¥ç†è§£å¹¶å‘ç¼–ç¨‹ä¹‹ThreadLocal</a></li><li>æ·±å…¥ç†è§£Atomicåº•å±‚åŠåŸç†</li><li>å¹¶å‘ç¼–ç¨‹ä¹‹çº¿ç¨‹æ± ä½¿ç”¨åŠæµç¨‹å®ç°åŸç†</li><li><a href="https://geekibli.github.io/wiki/Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/">å¦‚ä½•æ„å»ºä¸€ä¸ªå®‰å…¨å¯ç”¨çš„çº¿ç¨‹æ± </a></li><li>JUC-CountDownLatch</li><li>JUC-CyclicBarrier</li><li>LockSupportå·¥å…·</li><li>å¹¶å‘ç¼–ç¨‹ä¹‹Unsafeç±»</li></ul><h2 id="å­¦ä¹ æ–‡æ¡£"><a href="#å­¦ä¹ æ–‡æ¡£" class="headerlink" title="å­¦ä¹ æ–‡æ¡£"></a>å­¦ä¹ æ–‡æ¡£</h2><p><a href="https://www.codercc.com/backend/basic/juc/">https://www.codercc.com/backend/basic/juc/</a></p><p><a href="https://segmentfault.com/a/1190000015558984">https://segmentfault.com/a/1190000015558984</a></p><p><a href="https://www.pdai.tech/md/java/thread/java-thread-x-juc-overview.html">https://www.pdai.tech/md/java/thread/java-thread-x-juc-overview.html</a></p><p><a href="https://github.com/AobingJava/JavaFamily">https://github.com/AobingJava/JavaFamily</a></p><p><a href="https://dayarch.top/categories/Coding/Java-Concurrency/">https://dayarch.top/categories/Coding/Java-Concurrency/</a></p><p><a href="http://tutorials.jenkov.com/java-concurrency/blocking-queues.html">http://tutorials.jenkov.com/java-concurrency/blocking-queues.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾&quot;&gt;&lt;a href=&quot;#Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾&quot; class=&quot;headerlink&quot; title=&quot;Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾&quot;&gt;&lt;/a&gt;Lockæ¡†æ¶ç»§æ‰¿å…³ç³»å›¾&lt;/h2&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>JVM-åƒåœ¾æ”¶é›†å™¨</title>
    <link href="http://example.com/wiki/JVM-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/"/>
    <id>http://example.com/wiki/JVM-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/</id>
    <published>2021-07-31T06:13:17.000Z</published>
    <updated>2021-07-31T07:53:22.140Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨"><a href="#1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨"></a>1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨</h1><p>å¦‚æœè¯´åƒåœ¾æ”¶é›†ç®—æ³•æ˜¯å†…å­˜å›æ”¶çš„æ–¹æ³•è®ºï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨å°±æ˜¯å†…å­˜å›æ”¶çš„å…·ä½“å®ç°ã€‚</p><p>JVMè§„èŒƒå¯¹äºåƒåœ¾æ”¶é›†å™¨çš„åº”è¯¥å¦‚ä½•å®ç°æ²¡æœ‰ä»»ä½•è§„å®šï¼Œå› æ­¤ä¸åŒçš„å‚å•†ã€ä¸åŒç‰ˆæœ¬çš„è™šæ‹Ÿæœºæ‰€æä¾›çš„åƒåœ¾æ”¶é›†å™¨å·®åˆ«è¾ƒå¤§ï¼Œè¿™é‡Œåªçœ‹HotSpotè™šæ‹Ÿæœºã€‚ å°±åƒæ²¡æœ‰æœ€å¥½çš„ç®—æ³•ä¸€æ ·ï¼Œåƒåœ¾æ”¶é›†å™¨ä¹Ÿæ²¡æœ‰æœ€å¥½ï¼Œåªæœ‰æœ€åˆé€‚ã€‚æˆ‘ä»¬èƒ½åšçš„å°±æ˜¯æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„åƒåœ¾æ”¶é›†å™¨ã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731155230422.png" alt="image-20210731155230422" style="zoom: 33%;" /><p>ä¸Šå›¾å±•ç¤ºäº†7ç§ä½œç”¨äºä¸åŒåˆ†ä»£çš„æ”¶é›†å™¨ï¼Œå…¶ä¸­ç”¨äºå›æ”¶æ–°ç”Ÿä»£çš„æ”¶é›†å™¨åŒ…æ‹¬Serialã€PraNewã€Parallel Scavengeï¼Œå›æ”¶è€å¹´ä»£çš„æ”¶é›†å™¨åŒ…æ‹¬Serial Oldã€Parallel Oldã€CMSï¼Œè¿˜æœ‰ç”¨äºå›æ”¶æ•´ä¸ªJavaå †çš„G1æ”¶é›†å™¨ã€‚ä¸åŒæ”¶é›†å™¨ä¹‹é—´çš„è¿çº¿è¡¨ç¤ºå®ƒä»¬å¯ä»¥æ­é…ä½¿ç”¨ã€‚</p><h1 id="2ã€ä¸²è¡Œï¼Œå¹¶è¡Œå’Œå¹¶å‘"><a href="#2ã€ä¸²è¡Œï¼Œå¹¶è¡Œå’Œå¹¶å‘" class="headerlink" title="2ã€ä¸²è¡Œï¼Œå¹¶è¡Œå’Œå¹¶å‘"></a>2ã€ä¸²è¡Œï¼Œå¹¶è¡Œå’Œå¹¶å‘</h1><h2 id="2-1-ä¸²è¡Œ"><a href="#2-1-ä¸²è¡Œ" class="headerlink" title="2.1 ä¸²è¡Œ"></a>2.1 ä¸²è¡Œ</h2><p>è®¡ç®—æœºä¸­çš„ä¸²è¡Œæ˜¯ç”¨ Serial è¡¨ç¤ºã€‚A å’Œ B ä¸¤ä¸ªä»»åŠ¡è¿è¡Œåœ¨ä¸€ä¸ª CPU çº¿ç¨‹ä¸Šï¼Œåœ¨ A ä»»åŠ¡æ‰§è¡Œå®Œä¹‹å‰ä¸å¯ä»¥æ‰§è¡Œ Bã€‚å³ï¼Œåœ¨æ•´ä¸ªç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä»…å­˜åœ¨ä¸€ä¸ªè¿è¡Œä¸Šä¸‹æ–‡ï¼Œå³ä¸€ä¸ªè°ƒç”¨æ ˆä¸€ä¸ªå †ã€‚ç¨‹åºä¼šæŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªæŒ‡ä»¤ã€‚</p><h2 id="2-2-å¹¶è¡Œ"><a href="#2-2-å¹¶è¡Œ" class="headerlink" title="2.2 å¹¶è¡Œ"></a>2.2 å¹¶è¡Œ</h2><p>å¹¶è¡Œæ€§æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šäº‹ä»¶æˆ–æ´»åŠ¨åœ¨åŒä¸€æ—¶åˆ»å‘ç”Ÿã€‚åœ¨å¤šé“ç¨‹åºç¯å¢ƒä¸‹ï¼Œ<strong>å¹¶è¡Œæ€§ä½¿å¤šä¸ªç¨‹åºåŒä¸€æ—¶åˆ»å¯åœ¨ä¸åŒ CPU ä¸ŠåŒæ—¶æ‰§è¡Œ</strong>ã€‚æ¯”å¦‚ï¼ŒA å’Œ B ä¸¤ä¸ªä»»åŠ¡å¯ä»¥åŒæ—¶è¿è¡Œåœ¨ä¸åŒçš„ CPU çº¿ç¨‹ä¸Šï¼Œæ•ˆç‡è¾ƒé«˜ï¼Œä½†å—é™äº CPU çº¿ç¨‹æ•°ï¼Œå¦‚æœä»»åŠ¡æ•°é‡è¶…è¿‡äº† CPU çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹ä¸Šçš„ä»»åŠ¡ä»ç„¶æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚</p><h2 id="2-3-å¹¶å‘"><a href="#2-3-å¹¶å‘" class="headerlink" title="2.3 å¹¶å‘"></a>2.3 å¹¶å‘</h2><p>å¹¶å‘æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨å®è§‚(ç›¸å¯¹äºè¾ƒé•¿çš„æ—¶é—´åŒºé—´è€Œè¨€)ä¸Šè¡¨ç°ä¸ºåŒæ—¶æ‰§è¡Œï¼Œè€Œå®é™…ä¸Šæ˜¯è½®æµç©¿æ’ç€æ‰§è¡Œï¼Œ<strong>å¹¶å‘çš„å®è´¨æ˜¯ä¸€ä¸ªç‰©ç† CPU åœ¨è‹¥å¹²é“ç¨‹åºä¹‹é—´å¤šè·¯å¤ç”¨</strong>ï¼Œå…¶ç›®çš„æ˜¯æé«˜æœ‰é™ç‰©ç†èµ„æºçš„è¿è¡Œæ•ˆç‡ã€‚ å¹¶å‘ä¸å¹¶è¡Œä¸²è¡Œå¹¶ä¸æ˜¯äº’æ–¥çš„æ¦‚å¿µï¼Œå¦‚æœæ˜¯åœ¨ä¸€ä¸ªCPUçº¿ç¨‹ä¸Šå¯ç”¨å¹¶å‘ï¼Œé‚£ä¹ˆè‡ªç„¶å°±è¿˜æ˜¯ä¸²è¡Œçš„ï¼Œè€Œå¦‚æœåœ¨å¤šä¸ªçº¿ç¨‹ä¸Šå¯ç”¨å¹¶å‘ï¼Œé‚£ä¹ˆç¨‹åºçš„æ‰§è¡Œå°±å¯ä»¥æ˜¯æ—¢å¹¶å‘åˆå¹¶è¡Œçš„ã€‚</p><h2 id="2-4-JVM-åƒåœ¾æ”¶é›†ä¸­çš„ä¸²è¡Œã€å¹¶è¡Œå’Œå¹¶å‘"><a href="#2-4-JVM-åƒåœ¾æ”¶é›†ä¸­çš„ä¸²è¡Œã€å¹¶è¡Œå’Œå¹¶å‘" class="headerlink" title="2.4 JVM åƒåœ¾æ”¶é›†ä¸­çš„ä¸²è¡Œã€å¹¶è¡Œå’Œå¹¶å‘"></a>2.4 JVM åƒåœ¾æ”¶é›†ä¸­çš„ä¸²è¡Œã€å¹¶è¡Œå’Œå¹¶å‘</h2><p>åœ¨ JVM åƒåœ¾æ”¶é›†å™¨ä¸­ä¹Ÿæ¶‰åŠåˆ°å¦‚ä¸Šçš„ä¸‰ä¸ªæ¦‚å¿µã€‚</p><ul><li>ä¸²è¡Œï¼ˆSerialï¼‰ï¼šä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶çš„å›æ”¶å™¨ã€‚</li><li>å¹¶è¡Œï¼ˆParallelï¼‰ï¼šæŒ‡å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»ç„¶å¤„äºç­‰å¾…çŠ¶æ€ã€‚</li><li>å¹¶å‘ï¼ˆConcurrentï¼‰ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆä½†ä¸ä¸€å®šæ˜¯å¹¶è¡Œï¼Œå¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œï¼‰ï¼Œç”¨æˆ·ç¨‹åºåœ¨ç»§ç»­è¿è¡Œï¼Œè€Œåƒåœ¾æ”¶é›†å™¨è¿è¡Œåœ¨å¦ä¸€ä¸ª CPU ä¸Šã€‚</li></ul><p>åœ¨äº†è§£äº†è¿™äº›æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å…·ä½“ä»‹ç»å¸¸ç”¨çš„åƒåœ¾æ”¶é›†å™¨ã€‚</p><h1 id="3ã€ä¸»æµçš„åƒåœ¾æ”¶é›†å™¨"><a href="#3ã€ä¸»æµçš„åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="3ã€ä¸»æµçš„åƒåœ¾æ”¶é›†å™¨"></a>3ã€ä¸»æµçš„åƒåœ¾æ”¶é›†å™¨</h1><h2 id="3-1-Serialæ”¶é›†å™¨"><a href="#3-1-Serialæ”¶é›†å™¨" class="headerlink" title="3.1 Serialæ”¶é›†å™¨"></a>3.1 Serialæ”¶é›†å™¨</h2><p>Serialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨æ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨äº†ï¼ˆæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€ç”Ÿä»£é‡‡ç”¨æ ‡å¿—æ•´ç†ç®—æ³•ï¼‰ã€‚å¤§å®¶çœ‹åå­—å°±çŸ¥é“è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨äº†ã€‚ å®ƒçš„ â€œå•çº¿ç¨‹â€ çš„æ„ä¹‰ä¸ä»…ä»…æ„å‘³ç€å®ƒåªä¼šä½¿ç”¨ä¸€æ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯å®ƒåœ¨<code>è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œçš„æ—¶å€™å¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹</code>ï¼ˆ â€œStop The Worldâ€ ï¼šå°†ç”¨æˆ·æ­£å¸¸å·¥ä½œçš„çº¿ç¨‹å…¨éƒ¨æš‚åœæ‰ï¼‰ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚ </p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731143820628.png" alt="image-20210731143820628" style="zoom:50%;" /><p>ä¸Šå›¾ä¸­ï¼š</p><ul><li>æ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼ŒStop-The-World</li><li>è€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ï¼ŒStop-The-World</li></ul><p>å½“å®ƒè¿›è¡ŒGCå·¥ä½œçš„æ—¶å€™ï¼Œè™½ç„¶ä¼šé€ æˆStop-The-Worldï¼Œæ­£å¦‚æ¯ç§ç®—æ³•éƒ½æœ‰å­˜åœ¨çš„åŸå› ï¼Œè¯¥ä¸²è¡Œæ”¶é›†å™¨ä¹Ÿæœ‰å­˜åœ¨çš„åŸå› ï¼šå› ä¸ºç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹æ¯”ï¼‰ï¼Œå¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è¯´ï¼Œæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œä¸“å¿ƒåšGCï¼Œè‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ•ˆç‡ã€‚</p><p>æ‰€ä»¥Serialæ”¶é›†å™¨å¯¹äºè¿è¡Œåœ¨clientæ¨¡å¼ä¸‹çš„åº”ç”¨æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼ˆåˆ°ç›®å‰ä¸ºæ­¢ï¼Œå®ƒä¾ç„¶æ˜¯è™šæ‹Ÿæœºè¿è¡Œåœ¨clientæ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼‰ ä¸²è¡Œæ”¶é›†å™¨çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œè™šæ‹Ÿæœºçš„å¼€å‘è€…å½“ç„¶ä¹Ÿæ˜¯çŸ¥é“è¿™ä¸ªç¼ºç‚¹çš„ï¼Œæ‰€ä»¥ä¸€ç›´éƒ½åœ¨ç¼©å‡Stop The Worldçš„æ—¶é—´ã€‚ åœ¨åç»­çš„åƒåœ¾æ”¶é›†å™¨è®¾è®¡ä¸­åœé¡¿æ—¶é—´åœ¨ä¸æ–­ç¼©çŸ­ï¼ˆä½†æ˜¯ä»ç„¶è¿˜æœ‰åœé¡¿ï¼Œå¯»æ‰¾æœ€ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨çš„è¿‡ç¨‹ä»ç„¶åœ¨ç»§ç»­ï¼‰</p><h3 id="3-1-1-ç‰¹ç‚¹"><a href="#3-1-1-ç‰¹ç‚¹" class="headerlink" title="3.1.1 ç‰¹ç‚¹"></a>3.1.1 ç‰¹ç‚¹</h3><ul><li>é’ˆå¯¹æ–°ç”Ÿä»£çš„æ”¶é›†å™¨ï¼›</li><li>é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼›</li><li>å•çº¿ç¨‹æ”¶é›†ï¼›</li><li>è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœæ‰€æœ‰å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®Œæˆï¼› å³ä¼šâ€Stop The Worldâ€ï¼›</li></ul><h3 id="3-1-2-åº”ç”¨åœºæ™¯"><a href="#3-1-2-åº”ç”¨åœºæ™¯" class="headerlink" title="3.1.2 åº”ç”¨åœºæ™¯"></a>3.1.2 åº”ç”¨åœºæ™¯</h3><ul><li><code>ä¾ç„¶æ˜¯HotSpotåœ¨Clientæ¨¡å¼ä¸‹é»˜è®¤çš„æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼›</code></li><li>ä¹Ÿæœ‰ä¼˜äºå…¶ä»–æ”¶é›†å™¨çš„åœ°æ–¹ï¼š ç®€å•é«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰ï¼›</li><li>å¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è¯´ï¼ŒSerialæ”¶é›†å™¨æ²¡æœ‰çº¿ç¨‹äº¤äº’ï¼ˆåˆ‡æ¢ï¼‰å¼€é”€ï¼Œå¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ï¼›</li><li>åœ¨ç”¨æˆ·çš„æ¡Œé¢åº”ç”¨åœºæ™¯ä¸­ï¼Œå¯ç”¨å†…å­˜ä¸€èˆ¬ä¸å¤§ï¼ˆå‡ åMè‡³ä¸€ä¸¤ç™¾Mï¼‰ï¼Œå¯ä»¥åœ¨è¾ƒçŸ­æ—¶é—´å†…å®Œæˆåƒåœ¾æ”¶é›†ï¼ˆå‡ åMSè‡³ä¸€ç™¾å¤šMSï¼‰,åªè¦ä¸é¢‘ç¹å‘ç”Ÿï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„</li></ul><h3 id="3-1-3-å‚æ•°è®¾ç½®"><a href="#3-1-3-å‚æ•°è®¾ç½®" class="headerlink" title="3.1.3 å‚æ•°è®¾ç½®"></a>3.1.3 å‚æ•°è®¾ç½®</h3><p>æ·»åŠ è¯¥å‚æ•°æ¥æ˜¾å¼çš„ä½¿ç”¨ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨: â€œ-XX:+UseSerialGCâ€</p><h2 id="3-2-ParNewæ”¶é›†å™¨"><a href="#3-2-ParNewæ”¶é›†å™¨" class="headerlink" title="3.2 ParNewæ”¶é›†å™¨"></a>3.2 ParNewæ”¶é›†å™¨</h2><blockquote><p> Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬-ä½¿ç”¨å¤šæ¡çº¿ç¨‹è¿›è¡ŒGC</p></blockquote><p>ParNewæ”¶é›†å™¨å…¶å®å°±æ˜¯Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé™¤äº†ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å¤–ï¼Œå…¶ä½™è¡Œä¸ºï¼ˆæ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€å›æ”¶ç­–ç•¥ç­‰ç­‰ï¼‰å’ŒSerialæ”¶é›†å™¨å®Œå…¨ä¸€æ ·ã€‚ å®ƒæ˜¯è®¸å¤šè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºçš„é¦–è¦é€‰æ‹©ï¼Œé™¤äº†Serialæ”¶é›†å™¨å¤–ï¼Œç›®å‰åªæœ‰å®ƒèƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œã€‚ CMSæ”¶é›†å™¨æ˜¯ä¸€ä¸ªè¢«è®¤ä¸ºå…·æœ‰åˆ’æ—¶ä»£æ„ä¹‰çš„å¹¶å‘æ”¶é›†å™¨ï¼Œå› æ­¤å¦‚æœæœ‰ä¸€ä¸ªåƒåœ¾æ”¶é›†å™¨èƒ½å’Œå®ƒä¸€èµ·æ­é…ä½¿ç”¨è®©å…¶æ›´åŠ å®Œç¾ï¼Œé‚£è¿™ä¸ªæ”¶é›†å™¨å¿…ç„¶ä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†äº†ã€‚ æ”¶é›†å™¨çš„è¿è¡Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731144404779.png" alt="image-20210731144404779" style="zoom:50%;" /><h3 id="3-2-1-åº”ç”¨åœºæ™¯ï¼š"><a href="#3-2-1-åº”ç”¨åœºæ™¯ï¼š" class="headerlink" title="3.2.1 åº”ç”¨åœºæ™¯ï¼š"></a>3.2.1 åº”ç”¨åœºæ™¯ï¼š</h3><p>åœ¨Serveræ¨¡å¼ä¸‹ï¼ŒParNewæ”¶é›†å™¨æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ”¶é›†å™¨ï¼Œ<strong>å› ä¸ºé™¤Serialå¤–ï¼Œç›®å‰åªæœ‰å®ƒèƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œ</strong>ï¼› ä½†<font color=red>åœ¨å•ä¸ªCPUç¯å¢ƒä¸­ï¼Œä¸ä¼šæ¯”Serailæ”¶é›†å™¨æœ‰æ›´å¥½çš„æ•ˆæœï¼Œå› ä¸ºå­˜åœ¨çº¿ç¨‹äº¤äº’å¼€é”€ã€‚</font></p><h3 id="3-2-2-è®¾ç½®å‚æ•°"><a href="#3-2-2-è®¾ç½®å‚æ•°" class="headerlink" title="3.2.2 è®¾ç½®å‚æ•°"></a>3.2.2 è®¾ç½®å‚æ•°</h3><p>æŒ‡å®šä½¿ç”¨CMSåï¼Œä¼šé»˜è®¤ä½¿ç”¨ParNewä½œä¸ºæ–°ç”Ÿä»£æ”¶é›†: â€œ-XX:+UseConcMarkSweepGCâ€ å¼ºåˆ¶æŒ‡å®šä½¿ç”¨ParNew:<br>â€œ-XX:+UseParNewGCâ€ æŒ‡å®šåƒåœ¾æ”¶é›†çš„çº¿ç¨‹æ•°é‡ï¼ŒParNewé»˜è®¤å¼€å¯çš„æ”¶é›†çº¿ç¨‹ä¸CPUçš„æ•°é‡ç›¸: â€œ-XX:ParallelGCThreadsâ€</p><h3 id="3-2-3-ä¸ºä»€ä¹ˆåªæœ‰ParNewèƒ½ä¸CMSæ”¶é›†å™¨é…åˆ"><a href="#3-2-3-ä¸ºä»€ä¹ˆåªæœ‰ParNewèƒ½ä¸CMSæ”¶é›†å™¨é…åˆ" class="headerlink" title="3.2.3 ä¸ºä»€ä¹ˆåªæœ‰ParNewèƒ½ä¸CMSæ”¶é›†å™¨é…åˆ"></a>3.2.3 ä¸ºä»€ä¹ˆåªæœ‰ParNewèƒ½ä¸CMSæ”¶é›†å™¨é…åˆ</h3><ul><li>CMSæ˜¯HotSpotåœ¨JDK1.5æ¨å‡ºçš„ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘ï¼ˆConcurrentï¼‰æ”¶é›†å™¨ï¼Œ<strong>ç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ï¼ˆåŸºæœ¬ä¸Šï¼‰åŒæ—¶å·¥ä½œ</strong>ï¼›</li><li>CMSä½œä¸ºè€å¹´ä»£æ”¶é›†å™¨ï¼Œä½†å´æ— æ³•ä¸JDK1.4å·²ç»å­˜åœ¨çš„æ–°ç”Ÿä»£æ”¶é›†å™¨Parallel Scavengeé…åˆå·¥ä½œï¼›</li><li>å› ä¸ºParallel Scavengeï¼ˆä»¥åŠG1ï¼‰éƒ½æ²¡æœ‰ä½¿ç”¨ä¼ ç»Ÿçš„GCæ”¶é›†å™¨ä»£ç æ¡†æ¶ï¼Œè€Œå¦å¤–ç‹¬ç«‹å®ç°ï¼›è€Œå…¶ä½™å‡ ç§æ”¶é›†å™¨åˆ™å…±ç”¨äº†éƒ¨åˆ†çš„æ¡†æ¶ä»£ç ï¼›</li></ul><h2 id="3-3-Parallel-Scavengeæ”¶é›†å™¨"><a href="#3-3-Parallel-Scavengeæ”¶é›†å™¨" class="headerlink" title="3.3 Parallel Scavengeæ”¶é›†å™¨"></a>3.3 Parallel Scavengeæ”¶é›†å™¨</h2><p>Parallel Scavengeæ”¶é›†å™¨æ˜¯ä¸€ä¸ªæ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œå®ƒä¹Ÿæ˜¯ä½¿ç”¨å¤åˆ¶ç®—æ³•çš„æ”¶é›†å™¨ï¼Œåˆæ˜¯å¹¶è¡Œçš„å¤šçº¿ç¨‹æ”¶é›†å™¨ã€‚ Parallel Scavengeæ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯ååé‡ï¼ˆå¦‚ä½•é«˜æ•ˆç‡çš„åˆ©ç”¨CPUï¼‰ã€‚ CMSç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚ <strong>æ‰€è°“ååé‡å°±æ˜¯CPUä¸­ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸CPUæ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼</strong>ã€‚ï¼ˆååé‡ï¼šCPUç”¨äºç”¨æˆ·ä»£ç çš„æ—¶é—´/CPUæ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ï¼Œå³=è¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´/(è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´+åƒåœ¾æ”¶é›†æ—¶é—´)ã€‚æ¯”å¦‚ï¼Œè™šæ‹Ÿæœºæ€»å…±è¿è¡Œäº†100åˆ†é’Ÿï¼Œå…¶ä¸­åƒåœ¾æ”¶é›†èŠ±æ‰1åˆ†é’Ÿï¼Œé‚£ååé‡å°±æ˜¯99%ã€‚ï¼‰ è¿è¡Œç¤ºæ„å›¾ï¼š</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731144823884.png" alt="image-20210731144823884" style="zoom:50%;" /><h3 id="3-3-1-ç‰¹ç‚¹"><a href="#3-3-1-ç‰¹ç‚¹" class="headerlink" title="3.3.1 ç‰¹ç‚¹"></a>3.3.1 ç‰¹ç‚¹</h3><ul><li>æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼›</li><li>é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼›</li><li>å¤šçº¿ç¨‹æ”¶é›†ï¼›</li><li>CMSç­‰æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ˜¯å°½å¯èƒ½åœ°ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼›è€ŒParallel Scavengeæ”¶é›†å™¨çš„ç›®æ ‡åˆ™æ˜¯è¾¾ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼ˆThroughputï¼‰ï¼›</li></ul><h3 id="3-3-2-åº”ç”¨åœºæ™¯"><a href="#3-3-2-åº”ç”¨åœºæ™¯" class="headerlink" title="3.3.2 åº”ç”¨åœºæ™¯"></a>3.3.2 åº”ç”¨åœºæ™¯</h3><ul><li>é«˜ååé‡ä¸ºç›®æ ‡ï¼Œå³å‡å°‘åƒåœ¾æ”¶é›†æ—¶é—´ï¼Œè®©ç”¨æˆ·ä»£ç è·å¾—æ›´é•¿çš„è¿è¡Œæ—¶é—´ï¼›</li><li>å½“åº”ç”¨ç¨‹åºè¿è¡Œåœ¨å…·æœ‰å¤šä¸ªCPUä¸Šï¼Œå¯¹æš‚åœæ—¶é—´æ²¡æœ‰ç‰¹åˆ«é«˜çš„è¦æ±‚æ—¶ï¼Œå³ç¨‹åºä¸»è¦åœ¨åå°è¿›è¡Œè®¡ç®—ï¼Œè€Œä¸éœ€è¦ä¸ç”¨æˆ·è¿›è¡Œå¤ªå¤šäº¤äº’ï¼›</li><li>ä¾‹å¦‚ï¼Œé‚£äº›æ‰§è¡Œæ‰¹é‡å¤„ç†ã€è®¢å•å¤„ç†ï¼ˆå¯¹è´¦ç­‰ï¼‰ã€å·¥èµ„æ”¯ä»˜ã€ç§‘å­¦è®¡ç®—çš„åº”ç”¨ç¨‹åºï¼›</li></ul><h3 id="3-3-3-è®¾ç½®å‚æ•°"><a href="#3-3-3-è®¾ç½®å‚æ•°" class="headerlink" title="3.3.3 è®¾ç½®å‚æ•°"></a>3.3.3 è®¾ç½®å‚æ•°</h3><p>Parallel Scavengeæ”¶é›†å™¨æä¾›ä¸¤ä¸ªå‚æ•°ç”¨äºç²¾ç¡®æ§åˆ¶ååé‡ï¼š</p><ul><li>æ§åˆ¶æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ â€œ-XX:MaxGCPauseMillisâ€</li><li>æ§åˆ¶æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ï¼Œå¤§äº0çš„æ¯«ç§’æ•°ï¼› MaxGCPauseMillisè®¾ç½®å¾—ç¨å°ï¼Œåœé¡¿æ—¶é—´å¯èƒ½ä¼šç¼©çŸ­ï¼Œä½†ä¹Ÿå¯èƒ½ä¼šä½¿å¾—ååé‡ä¸‹é™ï¼›å› ä¸ºå¯èƒ½å¯¼è‡´åƒåœ¾æ”¶é›†å‘ç”Ÿå¾—æ›´é¢‘ç¹ï¼› è®¾ç½®åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡ â€œ-XX:GCTimeRatioâ€</li><li>è®¾ç½®åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡ï¼Œ0 &lt; n &lt; 100çš„æ•´æ•°ï¼› GCTimeRatioç›¸å½“äºè®¾ç½®ååé‡å¤§å°ï¼› åƒåœ¾æ”¶é›†æ‰§è¡Œæ—¶é—´å åº”ç”¨ç¨‹åºæ‰§è¡Œæ—¶é—´çš„æ¯”ä¾‹çš„è®¡ç®—æ–¹æ³•æ˜¯ï¼š 1 / (1 + n) ã€‚ ä¾‹å¦‚ï¼Œé€‰é¡¹-XX:GCTimeRatio=19ï¼Œè®¾ç½®äº†åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„5% = 1/(1+19)ï¼›é»˜è®¤å€¼æ˜¯1% = 1/(1+99)ï¼Œå³n=99ï¼› åƒåœ¾æ”¶é›†æ‰€èŠ±è´¹çš„æ—¶é—´æ˜¯å¹´è½»ä¸€ä»£å’Œè€å¹´ä»£æ”¶é›†çš„æ€»æ—¶é—´ï¼› å¦‚æœæ²¡æœ‰æ»¡è¶³ååé‡ç›®æ ‡ï¼Œåˆ™å¢åŠ ä»£çš„å†…å­˜å¤§å°ä»¥å°½é‡å¢åŠ ç”¨æˆ·ç¨‹åºè¿è¡Œçš„æ—¶é—´ï¼›</li></ul><h2 id="3-4-Serial-Oldæ”¶é›†å™¨"><a href="#3-4-Serial-Oldæ”¶é›†å™¨" class="headerlink" title="3.4 Serial Oldæ”¶é›†å™¨"></a>3.4 Serial Oldæ”¶é›†å™¨</h2><p>Serialæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨ã€‚ å®ƒä¸»è¦æœ‰ä¸¤å¤§ç”¨é€”ï¼šä¸€ç§ç”¨é€”æ˜¯åœ¨JDK1.5ä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ä¸Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼Œå¦ä¸€ç§ç”¨é€”æ˜¯ä½œä¸ºCMSæ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆ</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731143820628.png" alt="image-20210731143820628" style="zoom:50%;" /><h3 id="3-4-1-ç‰¹ç‚¹"><a href="#3-4-1-ç‰¹ç‚¹" class="headerlink" title="3.4.1 ç‰¹ç‚¹"></a>3.4.1 ç‰¹ç‚¹</h3><ul><li><strong>é’ˆå¯¹è€å¹´ä»£ï¼›</strong></li><li>é‡‡ç”¨â€æ ‡è®°-æ•´ç†-å‹ç¼©â€ç®—æ³•ï¼ˆMark-Sweep-Compactï¼‰ï¼›</li><li>å•çº¿ç¨‹æ”¶é›†ï¼›</li></ul><h3 id="3-4-2-åº”ç”¨åœºæ™¯"><a href="#3-4-2-åº”ç”¨åœºæ™¯" class="headerlink" title="3.4.2 åº”ç”¨åœºæ™¯"></a>3.4.2 åº”ç”¨åœºæ™¯</h3><ul><li>ä¸»è¦ç”¨äºClientæ¨¡å¼ï¼›</li><li>è€Œåœ¨Serveræ¨¡å¼æœ‰ä¸¤å¤§ç”¨é€”ï¼š<br>ï¼ˆAï¼‰ã€åœ¨JDK1.5åŠä¹‹å‰ï¼Œä¸Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼ˆJDK1.6æœ‰Parallel Oldæ”¶é›†å™¨å¯æ­é…Parallel Scavengeæ”¶é›†å™¨ï¼‰ï¼›<br>ï¼ˆBï¼‰ã€ä½œä¸ºCMSæ”¶é›†å™¨çš„åå¤‡é¢„æ¡ˆï¼Œåœ¨å¹¶å‘æ”¶é›†å‘ç”ŸConcurrent Mode Failureæ—¶ä½¿ç”¨ï¼›</li></ul><h2 id="3-5-Parallel-Oldæ”¶é›†å™¨"><a href="#3-5-Parallel-Oldæ”¶é›†å™¨" class="headerlink" title="3.5 Parallel Oldæ”¶é›†å™¨"></a>3.5 Parallel Oldæ”¶é›†å™¨</h2><p>Parallel Scavengeæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ã€‚ ä½¿ç”¨å¤šçº¿ç¨‹å’Œâ€œæ ‡è®°-æ•´ç†â€ç®—æ³•ã€‚åœ¨æ³¨é‡ååé‡ä»¥åŠCPUèµ„æºçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavengeæ”¶é›†å™¨å’ŒParallel Oldæ”¶é›†å™¨ã€‚ åœ¨JDK1.6æ‰æœ‰çš„ã€‚</p><h3 id="3-5-1-ç‰¹ç‚¹"><a href="#3-5-1-ç‰¹ç‚¹" class="headerlink" title="3.5.1 ç‰¹ç‚¹"></a>3.5.1 ç‰¹ç‚¹</h3><ul><li><strong>é’ˆå¯¹è€å¹´ä»£ï¼›</strong></li><li>é‡‡ç”¨â€æ ‡è®°-æ•´ç†-å‹ç¼©â€ç®—æ³•ï¼›</li><li>å¤šçº¿ç¨‹æ”¶é›†ï¼› Parallel Scavenge/Parallel Oldæ”¶é›†å™¨è¿è¡Œç¤ºæ„å›¾å¦‚ä¸‹</li></ul><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731145301909.png" alt="image-20210731145301909" style="zoom:50%;" /><h3 id="3-5-2-åº”ç”¨åœºæ™¯"><a href="#3-5-2-åº”ç”¨åœºæ™¯" class="headerlink" title="3.5.2 åº”ç”¨åœºæ™¯"></a>3.5.2 åº”ç”¨åœºæ™¯</h3><ul><li>JDK1.6åŠä¹‹åç”¨æ¥ä»£æ›¿è€å¹´ä»£çš„Serial Oldæ”¶é›†å™¨ï¼›</li><li>ç‰¹åˆ«æ˜¯åœ¨Serveræ¨¡å¼ï¼Œå¤šCPUçš„æƒ…å†µä¸‹ï¼› è¿™æ ·åœ¨æ³¨é‡ååé‡ä»¥åŠCPUèµ„æºæ•æ„Ÿçš„åœºæ™¯ï¼Œå°±æœ‰äº†Parallel Scavengeï¼ˆæ–°ç”Ÿä»£ï¼‰åŠ Parallel Oldï¼ˆè€å¹´ä»£ï¼‰æ”¶é›†å™¨çš„â€ç»™åŠ›â€åº”ç”¨ç»„åˆï¼›</li></ul><h3 id="3-5-3-è®¾ç½®å‚æ•°"><a href="#3-5-3-è®¾ç½®å‚æ•°" class="headerlink" title="3.5.3 è®¾ç½®å‚æ•°"></a>3.5.3 è®¾ç½®å‚æ•°</h3><p>æŒ‡å®šä½¿ç”¨Parallel Oldæ”¶é›†å™¨: â€œ-XX:+UseParallelOldGCâ€</p><h2 id="3-6-CMSï¼ˆConcurrent-Mark-Sweepï¼‰æ”¶é›†å™¨"><a href="#3-6-CMSï¼ˆConcurrent-Mark-Sweepï¼‰æ”¶é›†å™¨" class="headerlink" title="3.6 CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨"></a>3.6 CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨</h2><p>CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥<strong>è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨</strong>ã€‚<code>å®ƒéå¸¸é€‚åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨</code>ã€‚</p><h3 id="3-6-1-ç‰¹ç‚¹"><a href="#3-6-1-ç‰¹ç‚¹" class="headerlink" title="3.6.1 ç‰¹ç‚¹"></a>3.6.1 ç‰¹ç‚¹</h3><ul><li><strong>é’ˆå¯¹è€å¹´ä»£</strong></li><li>åŸºäºâ€æ ‡è®°-æ¸…é™¤â€ç®—æ³•(ä¸è¿›è¡Œå‹ç¼©æ“ä½œï¼Œä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡)</li><li>ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡</li><li>å¹¶å‘æ”¶é›†ã€ä½åœé¡¿</li><li>éœ€è¦æ›´å¤šçš„å†…å­˜ CMSæ˜¯HotSpotåœ¨JDK1.5æ¨å‡ºçš„ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘ï¼ˆConcurrentï¼‰æ”¶é›†å™¨ï¼› ç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ï¼ˆåŸºæœ¬ä¸Šï¼‰åŒæ—¶å·¥ä½œï¼›</li></ul><h3 id="3-6-2-åº”ç”¨åœºæ™¯"><a href="#3-6-2-åº”ç”¨åœºæ™¯" class="headerlink" title="3.6.2 åº”ç”¨åœºæ™¯"></a>3.6.2 åº”ç”¨åœºæ™¯</h3><ul><li>ä¸ç”¨æˆ·äº¤äº’è¾ƒå¤šçš„åœºæ™¯ï¼›ï¼ˆå¦‚å¸¸è§WEBã€B/S-æµè§ˆå™¨/æœåŠ¡å™¨æ¨¡å¼ç³»ç»Ÿçš„æœåŠ¡å™¨ä¸Šçš„åº”ç”¨ï¼‰</li><li>å¸Œæœ›ç³»ç»Ÿåœé¡¿æ—¶é—´æœ€çŸ­ï¼Œæ³¨é‡æœåŠ¡çš„å“åº”é€Ÿåº¦ï¼› ä»¥ç»™ç”¨æˆ·å¸¦æ¥è¾ƒå¥½çš„ä½“éªŒï¼›</li></ul><h3 id="3-6-3-CMSæ”¶é›†å™¨è¿ä½œè¿‡ç¨‹"><a href="#3-6-3-CMSæ”¶é›†å™¨è¿ä½œè¿‡ç¨‹" class="headerlink" title="3.6.3 CMSæ”¶é›†å™¨è¿ä½œè¿‡ç¨‹"></a>3.6.3 CMSæ”¶é›†å™¨è¿ä½œè¿‡ç¨‹</h3><p>ä»åå­—ä¸­çš„Mark Sweepè¿™ä¸¤ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼ŒCMSæ”¶é›†å™¨æ˜¯ä¸€ç§ â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•å®ç°çš„ï¼Œå®ƒçš„è¿ä½œè¿‡ç¨‹ç›¸æ¯”äºå‰é¢å‡ ç§åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ›´åŠ å¤æ‚ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹å¯åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731145628763.png" alt="image-20210731145628763" style="zoom:50%;" /><ul><li>åˆå§‹æ ‡è®°ï¼š æš‚åœæ‰€æœ‰çš„å…¶ä»–çº¿ç¨‹ï¼Œåˆå§‹æ ‡è®°ä»…ä»…æ ‡è®°GC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼›</li><li>å¹¶å‘æ ‡è®° å¹¶å‘æ ‡è®°å°±æ˜¯è¿›è¡ŒGC Roots Tracingçš„è¿‡ç¨‹ï¼› åŒæ—¶å¼€å¯GCå’Œç”¨æˆ·çº¿ç¨‹ï¼Œ<strong>ç”¨ä¸€ä¸ªé—­åŒ…ç»“æ„å»è®°å½•å¯è¾¾å¯¹è±¡</strong>ã€‚ä½†åœ¨è¿™ä¸ªé˜¶æ®µç»“æŸï¼Œè¿™ä¸ªé—­åŒ…ç»“æ„å¹¶ä¸èƒ½ä¿è¯åŒ…å«å½“å‰æ‰€æœ‰çš„å¯è¾¾å¯¹è±¡ã€‚å› ä¸ºç”¨æˆ·çº¿ç¨‹å¯èƒ½ä¼šä¸æ–­çš„æ›´æ–°å¼•ç”¨åŸŸï¼Œæ‰€ä»¥GCçº¿ç¨‹æ— æ³•ä¿è¯å¯è¾¾æ€§åˆ†æçš„å®æ—¶æ€§ã€‚æ‰€ä»¥è¿™ä¸ªç®—æ³•é‡Œä¼šè·Ÿè¸ªè®°å½•è¿™äº›å‘ç”Ÿå¼•ç”¨æ›´æ–°çš„åœ°æ–¹ï¼›</li><li>é‡æ–°æ ‡è®°ï¼š é‡æ–°æ ‡è®°é˜¶æ®µå°±æ˜¯ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ä¸ºç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼ˆé‡‡ç”¨å¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œæ¥æå‡æ•ˆç‡ï¼‰ï¼›éœ€è¦â€Stop The Worldâ€ï¼Œä¸”åœé¡¿æ—¶é—´æ¯”åˆå§‹æ ‡è®°ç¨é•¿ï¼Œä½†è¿œæ¯”å¹¶å‘æ ‡è®°çŸ­ï¼›</li><li>å¹¶å‘æ¸…é™¤ï¼š å¼€å¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒæ—¶GCçº¿ç¨‹å¼€å§‹å¯¹ä¸ºæ ‡è®°çš„åŒºåŸŸåšæ¸…æ‰«ï¼Œå›æ”¶æ‰€æœ‰çš„åƒåœ¾å¯¹è±¡ï¼› ç”±äºæ•´ä¸ªè¿‡ç¨‹è€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹æ”¶é›†å™¨çº¿ç¨‹éƒ½å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œã€‚ æ‰€ä»¥æ€»ä½“æ¥è¯´ï¼ŒCMSçš„å†…å­˜å›æ”¶æ˜¯ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·â€œå¹¶å‘â€æ‰§è¡Œçš„ã€‚</li></ul><h3 id="3-6-4å‚æ•°è®¾ç½®"><a href="#3-6-4å‚æ•°è®¾ç½®" class="headerlink" title="3.6.4å‚æ•°è®¾ç½®"></a>3.6.4å‚æ•°è®¾ç½®</h3><p>æŒ‡å®šä½¿ç”¨CMSæ”¶é›†å™¨ â€œ-XX:+UseConcMarkSweepGCâ€</p><h3 id="3-6-5-CMSæ”¶é›†å™¨ç¼ºç‚¹"><a href="#3-6-5-CMSæ”¶é›†å™¨ç¼ºç‚¹" class="headerlink" title="3.6.5 CMSæ”¶é›†å™¨ç¼ºç‚¹"></a>3.6.5 CMSæ”¶é›†å™¨ç¼ºç‚¹</h3><h4 id="3-6-5-1-å¯¹CPUèµ„æºæ•æ„Ÿ"><a href="#3-6-5-1-å¯¹CPUèµ„æºæ•æ„Ÿ" class="headerlink" title="3.6.5.1 å¯¹CPUèµ„æºæ•æ„Ÿ"></a>3.6.5.1 å¯¹CPUèµ„æºæ•æ„Ÿ</h4><p>é¢å‘å¹¶å‘è®¾è®¡çš„ç¨‹åºéƒ½å¯¹CPUèµ„æºæ¯”è¾ƒæ•æ„Ÿï¼ˆå¹¶å‘ç¨‹åºçš„ç‰¹ç‚¹ï¼‰ã€‚åœ¨å¹¶å‘é˜¶æ®µï¼Œå®ƒè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹åœé¡¿ï¼Œä½†ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹ï¼ˆæˆ–è€…è¯´CPUèµ„æºï¼‰è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡ä¼šé™ä½ã€‚ï¼ˆåœ¨å¯¹è´¦ç³»ç»Ÿä¸­ï¼Œä¸é€‚åˆä½¿ç”¨CMSæ”¶é›†å™¨ï¼‰ã€‚ CMSçš„é»˜è®¤æ”¶é›†çº¿ç¨‹æ•°é‡æ˜¯=(CPUæ•°é‡+3)/4ï¼› å½“CPUæ•°é‡è¶Šå¤šï¼Œå›æ”¶çš„çº¿ç¨‹å ç”¨CPUå°±å°‘ã€‚ ä¹Ÿå°±æ˜¯å½“CPUåœ¨4ä¸ªä»¥ä¸Šæ—¶ï¼Œå¹¶å‘å›æ”¶æ—¶åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸å°‘äº25%çš„CPUèµ„æºï¼Œå¯¹ç”¨æˆ·ç¨‹åºå½±å“å¯èƒ½è¾ƒå¤§ï¼›ä¸è¶³4ä¸ªæ—¶ï¼Œå½±å“æ›´å¤§ï¼Œå¯èƒ½æ— æ³•æ¥å—ã€‚ï¼ˆæ¯”å¦‚ CPU=2æ—¶ï¼Œé‚£ä¹ˆå°±å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å›æ”¶ï¼Œå äº†50%çš„CPUèµ„æºã€‚ï¼‰ ï¼ˆä¸€ä¸ªå›æ”¶çº¿ç¨‹ä¼šåœ¨å›æ”¶æœŸé—´ä¸€ç›´å ç”¨CPUèµ„æºï¼‰</p><p>é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæ›¾å‡ºç°äº†â€å¢é‡å¼å¹¶å‘æ”¶é›†å™¨â€ï¼ˆIncremental Concurrent Mark Sweep/i-CMSï¼‰ï¼› ç±»ä¼¼ä½¿ç”¨æŠ¢å å¼æ¥æ¨¡æ‹Ÿå¤šä»»åŠ¡æœºåˆ¶çš„æ€æƒ³ï¼Œè®©æ”¶é›†çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹äº¤æ›¿è¿è¡Œï¼Œå‡å°‘æ”¶é›†çº¿ç¨‹è¿è¡Œæ—¶é—´ï¼› ä½†æ•ˆæœå¹¶ä¸ç†æƒ³ï¼ŒJDK1.6åå°±å®˜æ–¹ä¸å†æå€¡ç”¨æˆ·ä½¿ç”¨ã€‚</p><h4 id="3-6-5-2-æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾"><a href="#3-6-5-2-æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾" class="headerlink" title="3.6.5.2 æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾"></a>3.6.5.2 æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾</h4><p>æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾,å¯èƒ½å‡ºç°â€Concurrent Mode Failureâ€å¤±è´¥ åœ¨å¹¶å‘æ¸…é™¤æ—¶ï¼Œç”¨æˆ·çº¿ç¨‹æ–°äº§ç”Ÿçš„åƒåœ¾ï¼Œç§°ä¸ºæµ®åŠ¨åƒåœ¾ï¼›</p><p><strong>è§£å†³åŠæ³•ï¼š</strong> è¿™ä½¿å¾—å¹¶å‘æ¸…é™¤æ—¶éœ€è¦é¢„ç•™ä¸€å®šçš„å†…å­˜ç©ºé—´ï¼Œä¸èƒ½åƒå…¶ä»–æ”¶é›†å™¨åœ¨è€å¹´ä»£å‡ ä¹å¡«æ»¡å†è¿›è¡Œæ”¶é›†ï¼› ä¹Ÿå¯ä»¥è®¤ä¸ºCMSæ‰€éœ€è¦çš„ç©ºé—´æ¯”å…¶ä»–åƒåœ¾æ”¶é›†å™¨å¤§ï¼› å¯ä»¥ä½¿ç”¨â€-XX:CMSInitiatingOccupancyFractionâ€ï¼Œè®¾ç½®CMSé¢„ç•™è€å¹´ä»£å†…å­˜ç©ºé—´ï¼› </p><h4 id="3-6-5-3-äº§ç”Ÿå¤§é‡å†…å­˜ç¢ç‰‡"><a href="#3-6-5-3-äº§ç”Ÿå¤§é‡å†…å­˜ç¢ç‰‡" class="headerlink" title="3.6.5.3 äº§ç”Ÿå¤§é‡å†…å­˜ç¢ç‰‡"></a>3.6.5.3 äº§ç”Ÿå¤§é‡å†…å­˜ç¢ç‰‡</h4><p>ç”±äºCMSæ˜¯åŸºäºâ€œæ ‡è®°+æ¸…é™¤â€ç®—æ³•æ¥å›æ”¶è€å¹´ä»£å¯¹è±¡çš„ï¼Œå› æ­¤é•¿æ—¶é—´è¿è¡Œåä¼šäº§ç”Ÿå¤§é‡çš„ç©ºé—´ç¢ç‰‡é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´æ–°ç”Ÿä»£å¯¹è±¡æ™‹å‡åˆ°è€ç”Ÿä»£å¤±è´¥ã€‚ ç”±äºç¢ç‰‡è¿‡å¤šï¼Œå°†ä¼šç»™å¤§å¯¹è±¡çš„åˆ†é…å¸¦æ¥éº»çƒ¦ã€‚å› æ­¤ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼Œ<strong>è€å¹´ä»£è¿˜æœ‰å¾ˆå¤šå‰©ä½™çš„ç©ºé—´ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°è¿ç»­çš„ç©ºé—´æ¥åˆ†é…å½“å‰å¯¹è±¡ï¼Œè¿™æ ·ä¸å¾—ä¸æå‰è§¦å‘ä¸€æ¬¡Full GC</strong>ã€‚</p><ul><li>è§£å†³åŠæ³• ä½¿ç”¨â€-XX:+UseCMSCompactAtFullCollectionâ€å’Œâ€-XX:+CMSFullGCsBeforeCompactionâ€ï¼Œéœ€è¦ç»“åˆä½¿ç”¨ã€‚</li><li>UseCMSCompactAtFullCollection â€œ-XX:+UseCMSCompactAtFullCollectionâ€</li></ul><p>ä¸ºäº†è§£å†³ç©ºé—´ç¢ç‰‡é—®é¢˜ï¼ŒCMSæ”¶é›†å™¨æä¾›âˆ’XX:+UseCMSCompactAlFullCollectionæ ‡å¿—ï¼Œä½¿å¾—CMSå‡ºç°ä¸Šé¢è¿™ç§æƒ…å†µæ—¶ä¸è¿›è¡ŒFull GCï¼Œè€Œå¼€å¯å†…å­˜ç¢ç‰‡çš„åˆå¹¶æ•´ç†è¿‡ç¨‹ï¼› ä½†åˆå¹¶æ•´ç†è¿‡ç¨‹æ— æ³•å¹¶å‘ï¼Œåœé¡¿æ—¶é—´ä¼šå˜é•¿ï¼› é»˜è®¤å¼€å¯ï¼ˆä½†ä¸ä¼šè¿›è¡Œï¼Œéœ€è¦ç»“åˆCMSFullGCsBeforeCompactionä½¿ç”¨ï¼‰ï¼›</p><ul><li>CMSFullGCsBeforeCompaction ç”±äºåˆå¹¶æ•´ç†æ˜¯æ— æ³•å¹¶å‘æ‰§è¡Œçš„ï¼Œç©ºé—´ç¢ç‰‡é—®é¢˜æ²¡æœ‰äº†ï¼Œä½†æ˜¯æœ‰å¯¼è‡´äº†è¿ç»­çš„åœé¡¿ã€‚å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªå‚æ•°âˆ’XX:CMSFullGCsBeforeCompactionï¼Œè¡¨ç¤ºåœ¨å¤šå°‘æ¬¡ä¸å‹ç¼©çš„Full GCä¹‹åï¼Œå¯¹ç©ºé—´ç¢ç‰‡è¿›è¡Œå‹ç¼©æ•´ç†ã€‚ å¯ä»¥å‡å°‘åˆå¹¶æ•´ç†è¿‡ç¨‹çš„åœé¡¿æ—¶é—´ï¼› é»˜è®¤ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡éƒ½æ‰§è¡ŒFull GCï¼Œä¸ä¼šè¿›è¡Œå‹ç¼©æ•´ç†ï¼› ç”±äºç©ºé—´ä¸å†è¿ç»­ï¼ŒCMSéœ€è¦ä½¿ç”¨å¯ç”¨â€ç©ºé—²åˆ—è¡¨â€å†…å­˜åˆ†é…æ–¹å¼ï¼Œè¿™æ¯”ç®€å•å®ç”¨â€ç¢°æ’æŒ‡é’ˆâ€åˆ†é…å†…å­˜æ¶ˆè€—å¤§ï¼›</li></ul><h3 id="3-6-6-CMS-amp-Parallel-Old"><a href="#3-6-6-CMS-amp-Parallel-Old" class="headerlink" title="3.6.6 CMS&amp;Parallel Old"></a>3.6.6 CMS&amp;Parallel Old</h3><p>æ€»ä½“æ¥çœ‹ï¼ŒCMSä¸Parallel Oldåƒåœ¾æ”¶é›†å™¨ç›¸æ¯”ï¼Œ<font color=red>CMSå‡å°‘äº†æ‰§è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†æ—¶åº”ç”¨æš‚åœçš„æ—¶é—´ï¼› ä½†å´å¢åŠ äº†æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†æ—¶åº”ç”¨æš‚åœçš„æ—¶é—´ã€é™ä½äº†ååé‡è€Œä¸”éœ€è¦å ç”¨æ›´å¤§çš„å †ç©ºé—´</font>ï¼› ï¼ˆåŸå› ï¼šCMSä¸è¿›è¡Œå†…å­˜ç©ºé—´æ•´ç†èŠ‚çœäº†æ—¶é—´ï¼Œä½†æ˜¯å¯ç”¨ç©ºé—´ä¸å†æ˜¯è¿ç»­çš„äº†ï¼Œåƒåœ¾æ”¶é›†ä¹Ÿä¸èƒ½ç®€å•çš„ä½¿ç”¨æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€æ¬¡å¯ç”¨æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜çš„åœ°å€äº†ã€‚</p><p>ç›¸åï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ä½¿ç”¨å¯ç”¨ç©ºé—´åˆ—è¡¨ã€‚å³ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæŒ‡å‘æœªåˆ†é…åŒºåŸŸçš„åˆ—è¡¨ï¼Œæ¯æ¬¡ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œä¼šä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªåˆé€‚å¤§å°çš„å†…å­˜åŒºåŸŸæ¥ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ã€‚è¿™æ ·åšçš„ç»“æœæ˜¯ï¼Œ<font color=red>è€å¹´ä»£ä¸Šçš„å†…å­˜çš„åˆ†é…æ¯”ç®€å•å®ç”¨ç¢°æ’æŒ‡é’ˆåˆ†é…å†…å­˜æ¶ˆè€—å¤§ã€‚</font>è¿™ä¹Ÿä¼šå¢åŠ å¹´è½»ä»£åƒåœ¾æ”¶é›†çš„é¢å¤–è´Ÿæ‹…ï¼Œå› ä¸ºè€å¹´ä»£ä¸­çš„å¤§éƒ¨åˆ†å¯¹è±¡æ˜¯åœ¨æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†çš„æ—¶å€™ä»æ–°ç”Ÿä»£æå‡ä¸ºè€å¹´ä»£çš„ã€‚ï¼‰ å½“æ–°ç”Ÿä»£å¯¹è±¡æ— æ³•åˆ†é…è¿‡å¤§å¯¹è±¡ï¼Œå°±ä¼šæ”¾åˆ°è€å¹´ä»£è¿›è¡Œåˆ†é…ã€‚</p><h2 id="3-7-G1æ”¶é›†å™¨"><a href="#3-7-G1æ”¶é›†å™¨" class="headerlink" title="3.7 G1æ”¶é›†å™¨"></a>3.7 G1æ”¶é›†å™¨</h2><p>ä¸Šä¸€ä»£çš„åƒåœ¾æ”¶é›†å™¨(ä¸²è¡Œserial, å¹¶è¡Œparallel, ä»¥åŠCMS)éƒ½æŠŠå †å†…å­˜åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„ä¸‰ä¸ªéƒ¨åˆ†: å¹´è½»ä»£(young generation), å¹´è€ä»£(old generation), ä»¥åŠæŒä¹…ä»£(permanent generation)ã€‚</p><p>G1ï¼ˆGarbage-Firstï¼‰æ˜¯JDK7-u4æ‰æ¨å‡ºå•†ç”¨çš„æ”¶é›†å™¨ï¼›<br>G1 (Garbage-First)æ˜¯ä¸€æ¬¾<strong>é¢å‘æœåŠ¡å™¨çš„åƒåœ¾æ”¶é›†å™¨</strong>ï¼Œä¸»è¦é’ˆå¯¹é…å¤‡å¤šé¢—å¤„ç†å™¨åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ã€‚ä»¥æé«˜æ¦‚ç‡æ»¡è¶³GCåœé¡¿æ—¶é—´è¦æ±‚çš„åŒæ—¶ï¼Œè¿˜å…·å¤‡é«˜ååé‡æ€§èƒ½ç‰¹å¾ã€‚è¢«è§†ä¸ºJDK1.7ä¸­HotSpotè™šæ‹Ÿæœºçš„ä¸€ä¸ªé‡è¦è¿›åŒ–ç‰¹å¾ã€‚<br><strong>G1çš„ä½¿å‘½æ˜¯åœ¨æœªæ¥æ›¿æ¢CMSï¼Œå¹¶ä¸”åœ¨JDK1.9å·²ç»æˆä¸ºé»˜è®¤çš„æ”¶é›†å™¨ã€‚</strong></p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731151137749.png" alt="image-20210731151137749" style="zoom:33%;" /><h3 id="3-7-1-ç‰¹ç‚¹"><a href="#3-7-1-ç‰¹ç‚¹" class="headerlink" title="3.7.1 ç‰¹ç‚¹"></a>3.7.1 ç‰¹ç‚¹</h3><h4 id="3-7-1-1-å¹¶è¡Œä¸å¹¶å‘"><a href="#3-7-1-1-å¹¶è¡Œä¸å¹¶å‘" class="headerlink" title="3.7.1.1 å¹¶è¡Œä¸å¹¶å‘"></a>3.7.1.1 å¹¶è¡Œä¸å¹¶å‘</h4><p>G1èƒ½å……åˆ†åˆ©ç”¨CPUã€å¤šæ ¸ç¯å¢ƒä¸‹çš„ç¡¬ä»¶ä¼˜åŠ¿ï¼Œä½¿ç”¨å¤šä¸ªCPUï¼ˆCPUæˆ–è€…CPUæ ¸å¿ƒï¼‰æ¥ç¼©çŸ­stop-The-Worldåœé¡¿æ—¶é—´ã€‚éƒ¨åˆ†å…¶ä»–æ”¶é›†å™¨åŸæœ¬éœ€è¦åœé¡¿Javaçº¿ç¨‹æ‰§è¡Œçš„GCåŠ¨ä½œï¼ŒG1æ”¶é›†å™¨ä»ç„¶å¯ä»¥é€šè¿‡å¹¶å‘çš„æ–¹å¼è®©javaç¨‹åºç»§ç»­æ‰§è¡Œã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731154444389.png" alt="image-20210731154444389" style="zoom:50%;" /><h4 id="3-7-1-2-åˆ†ä»£æ”¶é›†"><a href="#3-7-1-2-åˆ†ä»£æ”¶é›†" class="headerlink" title="3.7.1.2 åˆ†ä»£æ”¶é›†"></a>3.7.1.2 åˆ†ä»£æ”¶é›†</h4><p>è™½ç„¶G1å¯ä»¥ä¸éœ€è¦å…¶ä»–æ”¶é›†å™¨é…åˆå°±èƒ½ç‹¬ç«‹ç®¡ç†æ•´ä¸ªGCå †ï¼Œä½†æ˜¯è¿˜æ˜¯ä¿ç•™äº†åˆ†ä»£çš„æ¦‚å¿µã€‚</p><ul><li>èƒ½ç‹¬ç«‹ç®¡ç†æ•´ä¸ªGCå †ï¼ˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼‰ï¼Œè€Œä¸éœ€è¦ä¸å…¶ä»–æ”¶é›†å™¨æ­é…ï¼›</li><li>èƒ½å¤Ÿé‡‡ç”¨ä¸åŒæ–¹å¼å¤„ç†ä¸åŒæ—¶æœŸçš„å¯¹è±¡ï¼›</li><li>è™½ç„¶ä¿ç•™åˆ†ä»£æ¦‚å¿µï¼Œä½†Javaå †çš„å†…å­˜å¸ƒå±€æœ‰å¾ˆå¤§å·®åˆ«ï¼›</li><li>å°†æ•´ä¸ªå †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼›</li><li>æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†æ˜¯ç‰©ç†éš”ç¦»ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€éƒ¨åˆ†Regionï¼ˆä¸éœ€è¦è¿ç»­ï¼‰çš„é›†åˆï¼›</li></ul><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731151108695.png" alt="image-20210731151108695" style="zoom:50%;" /><h3 id="3-7-2-ç©ºé—´æ•´åˆ"><a href="#3-7-2-ç©ºé—´æ•´åˆ" class="headerlink" title="3.7.2 ç©ºé—´æ•´åˆ"></a>3.7.2 ç©ºé—´æ•´åˆ</h3><p>ä¸CMSçš„â€œæ ‡è®°â€“æ¸…ç†â€ç®—æ³•ä¸åŒï¼ŒG1ä»æ•´ä½“æ¥çœ‹æ˜¯åŸºäºâ€œæ ‡è®°æ•´ç†â€ç®—æ³•å®ç°çš„æ”¶é›†å™¨ï¼›ä»å±€éƒ¨ä¸Šæ¥çœ‹æ˜¯åŸºäºâ€œå¤åˆ¶â€ç®—æ³•å®ç°çš„ã€‚</p><ul><li>ä»æ•´ä½“çœ‹ï¼Œæ˜¯åŸºäºæ ‡è®°-æ•´ç†ç®—æ³•ï¼›</li><li>ä»å±€éƒ¨ï¼ˆä¸¤ä¸ªRegioné—´ï¼‰çœ‹ï¼Œæ˜¯åŸºäºå¤åˆ¶ç®—æ³•ï¼›<br>è¿™æ˜¯ä¸€ç§ç±»ä¼¼ç«è½¦ç®—æ³•çš„å®ç°ï¼›<br>ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œæœ‰åˆ©äºé•¿æ—¶é—´è¿è¡Œï¼›</li></ul><blockquote><p>ï¼ˆç«è½¦ç®—æ³•æ˜¯åˆ†ä»£æ”¶é›†å™¨æ‰€ç”¨çš„ç®—æ³•ï¼Œç›®çš„æ˜¯åœ¨æˆç†Ÿå¯¹è±¡ç©ºé—´ä¸­æä¾›é™å®šæ—¶é—´çš„æ¸è¿›æ”¶é›†ã€‚åœ¨åé¢ä¸€ç¯‡ä¸­ä¼šä¸“é—¨ä»‹ç»ï¼‰</p></blockquote><h3 id="3-7-3-å¯é¢„æµ‹çš„åœé¡¿"><a href="#3-7-3-å¯é¢„æµ‹çš„åœé¡¿" class="headerlink" title="3.7.3 å¯é¢„æµ‹çš„åœé¡¿"></a>3.7.3 å¯é¢„æµ‹çš„åœé¡¿</h3><p>è¿™æ˜¯G1ç›¸å¯¹äºCMSçš„å¦ä¸€ä¸ªå¤§ä¼˜åŠ¿ï¼Œé™ä½åœé¡¿æ—¶é—´æ˜¯G1å’ŒCMSå…±åŒçš„å…³æ³¨ç‚¹ï¼Œä½†G1é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œè¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ã€‚å¯ä»¥æ˜ç¡®æŒ‡å®šMæ¯«ç§’æ—¶é—´ç‰‡å†…ï¼Œåƒåœ¾æ”¶é›†æ¶ˆè€—çš„æ—¶é—´ä¸è¶…è¿‡Næ¯«ç§’ã€‚åœ¨ä½åœé¡¿çš„åŒæ—¶å®ç°é«˜ååé‡ã€‚</p><h3 id="3-7-4-G1æ”¶é›†å™¨å»¶ä¼¸"><a href="#3-7-4-G1æ”¶é›†å™¨å»¶ä¼¸" class="headerlink" title="3.7.4 G1æ”¶é›†å™¨å»¶ä¼¸"></a>3.7.4 G1æ”¶é›†å™¨å»¶ä¼¸</h3><h4 id="3-7-4-1-ä¸ºä»€ä¹ˆG1å¯ä»¥å®ç°å¯é¢„æµ‹åœé¡¿"><a href="#3-7-4-1-ä¸ºä»€ä¹ˆG1å¯ä»¥å®ç°å¯é¢„æµ‹åœé¡¿" class="headerlink" title="3.7.4.1 ä¸ºä»€ä¹ˆG1å¯ä»¥å®ç°å¯é¢„æµ‹åœé¡¿"></a>3.7.4.1 ä¸ºä»€ä¹ˆG1å¯ä»¥å®ç°å¯é¢„æµ‹åœé¡¿</h4><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731154741680.png" alt="image-20210731154741680" style="zoom:50%;" /><p>å¯ä»¥æœ‰è®¡åˆ’åœ°é¿å…åœ¨Javaå †çš„è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ï¼› G1æ”¶é›†å™¨å°†å†…å­˜åˆ†å¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼Œæ–°ç”Ÿä»£å’Œè€å¹´ä»£æ¦‚å¿µä¿ç•™ï¼Œä½†æ˜¯å·²ç»ä¸å†ç‰©ç†éš”ç¦»ã€‚ G1è·Ÿè¸ªå„ä¸ªRegionè·å¾—å…¶æ”¶é›†ä»·å€¼å¤§å°ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼› æ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„Regionï¼ˆåç§°Garbage-Firstçš„ç”±æ¥ï¼‰ï¼› è¿™å°±ä¿è¯äº†åœ¨æœ‰é™çš„æ—¶é—´å†…å¯ä»¥è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ï¼›</p><h4 id="3-7-4-2-ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜"><a href="#3-7-4-2-ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜" class="headerlink" title="3.7.4.2 ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜"></a>3.7.4.2 ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜</h4><p>ä¸€ä¸ªRegionä¸å¯èƒ½æ˜¯å­¤ç«‹çš„ï¼Œä¸€ä¸ªRegionä¸­çš„å¯¹è±¡å¯èƒ½è¢«å…¶ä»–ä»»æ„Regionä¸­å¯¹è±¡å¼•ç”¨ï¼Œåˆ¤æ–­å¯¹è±¡å­˜æ´»æ—¶ï¼Œæ˜¯å¦éœ€è¦æ‰«ææ•´ä¸ªJavaå †æ‰èƒ½ä¿è¯å‡†ç¡®ï¼Ÿ åœ¨å…¶ä»–çš„åˆ†ä»£æ”¶é›†å™¨ï¼Œä¹Ÿå­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼ˆè€ŒG1æ›´çªå‡ºï¼‰ï¼šå›æ”¶æ–°ç”Ÿä»£ä¹Ÿä¸å¾—ä¸åŒæ—¶æ‰«æè€å¹´ä»£ï¼Ÿ è¿™æ ·çš„è¯ä¼šé™ä½Minor GCçš„æ•ˆç‡ï¼›</p><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><p>æ— è®ºG1è¿˜æ˜¯å…¶ä»–åˆ†ä»£æ”¶é›†å™¨ï¼ŒJVMéƒ½æ˜¯ä½¿ç”¨Remembered Setæ¥é¿å…å…¨å±€æ‰«æï¼š æ¯ä¸ªRegionéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„Remembered Setï¼› æ¯æ¬¡Referenceç±»å‹æ•°æ®å†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªWrite Barrieræš‚æ—¶ä¸­æ–­æ“ä½œï¼› ç„¶åæ£€æŸ¥å°†è¦å†™å…¥çš„å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å’Œè¯¥Referenceç±»å‹æ•°æ®åœ¨ä¸åŒçš„Regionï¼ˆå…¶ä»–æ”¶é›†å™¨ï¼šæ£€æŸ¥è€å¹´ä»£å¯¹è±¡æ˜¯å¦å¼•ç”¨äº†æ–°ç”Ÿä»£å¯¹è±¡ï¼‰ï¼› å¦‚æœä¸åŒï¼Œé€šè¿‡CardTableæŠŠç›¸å…³å¼•ç”¨ä¿¡æ¯è®°å½•åˆ°å¼•ç”¨æŒ‡å‘å¯¹è±¡çš„æ‰€åœ¨Regionå¯¹åº”çš„Remembered Setä¸­ï¼› å½“è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œåœ¨GCæ ¹èŠ‚ç‚¹çš„æšä¸¾èŒƒå›´åŠ å…¥Remembered Setï¼› å°±å¯ä»¥ä¿è¯ä¸è¿›è¡Œå…¨å±€æ‰«æï¼Œä¹Ÿä¸ä¼šæœ‰é—æ¼ã€‚</p><h3 id="3-7-5-åº”ç”¨åœºæ™¯"><a href="#3-7-5-åº”ç”¨åœºæ™¯" class="headerlink" title="3.7.5 åº”ç”¨åœºæ™¯"></a>3.7.5 åº”ç”¨åœºæ™¯</h3><ul><li><strong>é¢å‘æœåŠ¡ç«¯åº”ç”¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜ã€å¤šå¤„ç†å™¨çš„æœºå™¨ï¼›</strong></li><li>æœ€ä¸»è¦çš„åº”ç”¨æ˜¯ä¸ºéœ€è¦ä½GCå»¶è¿Ÿï¼Œå¹¶å…·æœ‰å¤§å †çš„åº”ç”¨ç¨‹åºæä¾›è§£å†³æ–¹æ¡ˆï¼› å¦‚ï¼šåœ¨å †å¤§å°çº¦6GBæˆ–æ›´å¤§æ—¶ï¼Œå¯é¢„æµ‹çš„æš‚åœæ—¶é—´å¯ä»¥ä½äº0.5ç§’ï¼› ï¼ˆå®è·µï¼šå¯¹è´¦ç³»ç»Ÿä¸­å°†CMSåƒåœ¾æ”¶é›†å™¨ä¿®æ”¹ä¸ºG1ï¼Œé™ä½å¯¹è´¦æ—¶é—´20ç§’ä»¥ä¸Šï¼‰</li></ul><blockquote><p>å…·ä½“ä»€ä¹ˆæƒ…å†µä¸‹åº”ç”¨G1åƒåœ¾æ”¶é›†å™¨æ¯”CMSå¥½ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹å‡ ç‚¹ï¼ˆä½†ä¸æ˜¯ç»å¯¹ï¼‰ï¼š è¶…è¿‡50ï¼…çš„Javaå †è¢«æ´»åŠ¨æ•°æ®å ç”¨ï¼› å¯¹è±¡åˆ†é…é¢‘ç‡æˆ–å¹´ä»£çš„æå‡é¢‘ç‡å˜åŒ–å¾ˆå¤§ï¼› GCåœé¡¿æ—¶é—´è¿‡é•¿ï¼ˆé•¿äº0.5è‡³1ç§’ï¼‰ï¼› å»ºè®®ï¼š å¦‚æœç°åœ¨é‡‡ç”¨çš„æ”¶é›†å™¨æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œä¸ç”¨æ€¥ç€å»é€‰æ‹©G1ï¼› å¦‚æœåº”ç”¨ç¨‹åºè¿½æ±‚ä½åœé¡¿ï¼Œå¯ä»¥å°è¯•é€‰æ‹©G1ï¼› æ˜¯å¦ä»£æ›¿CMSåªæœ‰éœ€è¦å®é™…åœºæ™¯æµ‹è¯•æ‰çŸ¥é“ã€‚ï¼ˆå¦‚æœä½¿ç”¨G1åå‘ç°æ€§èƒ½è¿˜æ²¡æœ‰ä½¿ç”¨CMSå¥½ï¼Œé‚£ä¹ˆè¿˜æ˜¯é€‰æ‹©CMSæ¯”è¾ƒå¥½ï¼‰</p></blockquote><h3 id="3-7-6-è®¾ç½®å‚æ•°"><a href="#3-7-6-è®¾ç½®å‚æ•°" class="headerlink" title="3.7.6 è®¾ç½®å‚æ•°"></a>3.7.6 è®¾ç½®å‚æ•°</h3><p>å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‚æ•°ï¼Œæ¥è®¾ç½®ä¸€äº›G1ç›¸å…³çš„é…ç½®ã€‚ æŒ‡å®šä½¿ç”¨G1æ”¶é›†å™¨ï¼š â€œ-XX:+UseG1GCâ€</p><p>å½“æ•´ä¸ªJavaå †çš„å ç”¨ç‡è¾¾åˆ°å‚æ•°å€¼æ—¶ï¼Œå¼€å§‹å¹¶å‘æ ‡è®°é˜¶æ®µï¼›é»˜è®¤ä¸º45ï¼š â€œ-XX:InitiatingHeapOccupancyPercentâ€</p><p>ä¸ºG1è®¾ç½®æš‚åœæ—¶é—´ç›®æ ‡ï¼Œé»˜è®¤å€¼ä¸º200æ¯«ç§’ï¼š â€œ-XX:MaxGCPauseMillisâ€</p><p>è®¾ç½®æ¯ä¸ªRegionå¤§å°ï¼ŒèŒƒå›´1MBåˆ°32MBï¼›ç›®æ ‡æ˜¯åœ¨æœ€å°Javaå †æ—¶å¯ä»¥æ‹¥æœ‰çº¦2048ä¸ªRegion: â€œ-XX:G1HeapRegionSizeâ€</p><p>æ–°ç”Ÿä»£æœ€å°å€¼ï¼Œé»˜è®¤å€¼5%: â€œ-XX:G1NewSizePercentâ€</p><p>æ–°ç”Ÿä»£æœ€å¤§å€¼ï¼Œé»˜è®¤å€¼60%: â€œ-XX:G1MaxNewSizePercentâ€</p><p>è®¾ç½®STWæœŸé—´ï¼Œå¹¶è¡ŒGCçº¿ç¨‹æ•°: â€œ-XX:ParallelGCThreadsâ€</p><p>è®¾ç½®å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œå¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹æ•°: â€œ-XX:ConcGCThreadsâ€</p><p>G1åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªåŒºåŸŸçš„å¯¹è±¡æ´»æ€§éƒ½è¢«è®¡ç®—ï¼Œåœ¨å›æ”¶æ—¶å€™ï¼Œå°±å¯ä»¥æ ¹æ®ç”¨æˆ·è®¾ç½®çš„åœé¡¿æ—¶é—´ï¼Œé€‰æ‹©æ´»æ€§è¾ƒä½çš„åŒºåŸŸæ”¶é›†ï¼Œè¿™æ ·æ—¢èƒ½ä¿è¯åƒåœ¾å›æ”¶ï¼Œåˆèƒ½ä¿è¯åœé¡¿æ—¶é—´ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šé™ä½å¤ªå¤šçš„ååé‡ã€‚Remarkï¼ˆé‡æ–°æ ‡è®°ï¼‰é˜¶æ®µæ–°ç®—æ³•çš„è¿ç”¨ï¼Œä»¥åŠæ”¶é›†è¿‡ç¨‹ä¸­çš„å‹ç¼©ï¼Œéƒ½å¼¥è¡¥äº†CMSä¸è¶³ã€‚ å¼•ç”¨Oracleå®˜ç½‘çš„ä¸€å¥è¯ï¼šâ€œG1 is planned as the long term replacement for the Concurrent Mark-Sweep Collector (CMS)â€ã€‚ G1è®¡åˆ’ä½œä¸ºå¹¶å‘æ ‡è®°-æ¸…é™¤æ”¶é›†å™¨(CMS)çš„é•¿æœŸæ›¿ä»£å“</p><h1 id="4ã€å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨"><a href="#4ã€å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="4ã€å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨"></a>4ã€å¦‚ä½•é€‰æ‹©åƒåœ¾æ”¶é›†å™¨</h1><p>åƒåœ¾æ”¶é›†å™¨ä¸»è¦å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰å¤§ç±»ï¼š</p><ul><li><strong>ä¸²è¡Œæ”¶é›†å™¨</strong>ï¼šSerialå’ŒSerial Old<br>åªèƒ½æœ‰ä¸€ä¸ªåƒåœ¾å›æ”¶çº¿ç¨‹æ‰§è¡Œï¼Œç”¨æˆ·çº¿ç¨‹æš‚åœã€‚ é€‚ç”¨äºå†…å­˜æ¯”è¾ƒå°çš„åµŒå…¥å¼è®¾å¤‡ ã€‚</li><li><strong>å¹¶è¡Œæ”¶é›†å™¨</strong>[<strong>ååé‡ä¼˜å…ˆ</strong>]ï¼šParallel Scanvengeå’ŒParallel Old<br>å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»ç„¶å¤„äºç­‰å¾…çŠ¶æ€ã€‚ é€‚ç”¨äºç§‘å­¦è®¡ç®—ã€åå°å¤„ç†ç­‰è‹¥äº¤äº’åœºæ™¯ ã€‚</li><li><strong>å¹¶å‘æ”¶é›†å™¨</strong>[<strong>åœé¡¿æ—¶é—´ä¼˜å…ˆ</strong>]ï¼šCMSå’ŒG1ã€‚<br>ç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œ(ä½†å¹¶ä¸ä¸€å®šæ˜¯å¹¶è¡Œçš„ï¼Œå¯èƒ½æ˜¯äº¤æ›¿æ‰§è¡Œçš„)ï¼Œåƒåœ¾æ”¶é›†çº¿ç¨‹åœ¨æ‰§è¡Œçš„æ—¶å€™ä¸ä¼šåœé¡¿ç”¨æˆ·çº¿ç¨‹çš„è¿è¡Œã€‚ é€‚ç”¨äºå¯¹æ—¶é—´æœ‰è¦æ±‚çš„åœºæ™¯ï¼Œæ¯”å¦‚Webåº”ç”¨ã€‚</li></ul><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://zhuanlan.zhihu.com/p/142273073">https://zhuanlan.zhihu.com/p/142273073</a></p><p><a href="https://juejin.cn/post/6844903877024677901">https://juejin.cn/post/6844903877024677901</a></p><p><a href="https://juejin.cn/post/6844904159817236494">é¢è¯•å®˜ï¼šä½ å¯¹JVMåƒåœ¾æ”¶é›†å™¨äº†è§£å—ï¼Ÿ13è¿é—®ä½ æ˜¯å¦æŠ—çš„ä½ï¼</a></p><p><a href="https://juejin.cn/post/6874060477031579661#heading-32">https://juejin.cn/post/6874060477031579661#heading-32</a></p><p><a href="https://juejin.cn/post/6844904041080684552">https://juejin.cn/post/6844904041080684552</a></p><p><a href="https://juejin.cn/post/6844904159817236494#heading-14">https://juejin.cn/post/6844904159817236494#heading-14</a></p><p><a href="https://juejin.cn/post/6844903892774289421#heading-20">https://juejin.cn/post/6844903892774289421#heading-20</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨&quot;&gt;&lt;a href=&quot;#1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨&quot; class=&quot;headerlink&quot; title=&quot;1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨&quot;&gt;&lt;/a&gt;1ã€ä»€ä¹ˆæ˜¯åƒåœ¾æ”¶é›†å™¨&lt;/h1&gt;&lt;p&gt;å¦‚æœè¯´åƒåœ¾æ”¶é›†ç®—æ³•æ˜¯å†…å­˜å›æ”¶çš„æ–¹æ³•è®ºï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨å°±æ˜¯å†…å­˜å›æ”¶çš„å…·ä½“å®ç°ã€‚</summary>
      
    
    
    
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVM-åƒåœ¾å›æ”¶æœºåˆ¶</title>
    <link href="http://example.com/wiki/JVM-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/"/>
    <id>http://example.com/wiki/JVM-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/</id>
    <published>2021-07-30T11:49:33.000Z</published>
    <updated>2021-07-31T06:15:06.866Z</updated>
    
    <content type="html"><![CDATA[<p><strong>åƒåœ¾å›æ”¶æ€»ä½“æ€è·¯ï¼š</strong></p><p>1ã€ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼Œä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶ï¼›</p><p>2ã€å›æ”¶çš„åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿç”±è°æ¥å›æ”¶è°ï¼Ÿ</p><p>3ã€å›æ”¶çš„åˆ¤æ–­æ ‡å‡†æ˜¯ä»€ä¹ˆ</p><p>4ã€ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Œå›æ”¶çš„ç§ç±»å’Œæµç¨‹æ˜¯æ€æ ·çš„</p><p>5ã€åœ¨å“ªäº›åœ°æ–¹è¿›è¡Œå›æ”¶</p><hr><h1 id="1-ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"><a href="#1-ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶" class="headerlink" title="1. ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"></a>1. ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶</h1><p>ä»»ä½•è¯­è¨€åœ¨è¿è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šåˆ›å»ºå¯¹è±¡ï¼Œä¹Ÿå°±æ„å‘³ç€éœ€è¦åœ¨å†…å­˜ä¸­ä¸ºè¿™äº›å¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†é…ç©ºé—´ï¼Œåœ¨è¿™äº›å¯¹è±¡å¤±å»ä½¿ç”¨çš„æ„ä¹‰çš„æ—¶å€™ï¼Œéœ€è¦é‡Šæ”¾æ‰è¿™äº›å†…å®¹ï¼Œä¿è¯å†…å­˜èƒ½å¤Ÿæä¾›ç»™æ–°çš„å¯¹è±¡ä½¿ç”¨ã€‚<strong>å¯¹äºå¯¹è±¡å†…å­˜çš„é‡Šæ”¾å°±æ˜¯åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œä¹Ÿå«åšgc</strong>ã€‚</p><p>å¯¹äºjavaå¼€å‘è€…æ¥è¯´gcæ˜¯ä¸€ä¸ªåŒåˆƒå‰‘ï¼Œä¸€æ–¹é¢ï¼Œjavaç¨‹åºå‘˜åœ¨å¼€å‘ç¨‹åºçš„æ—¶å€™ä¸éœ€è¦åƒå¼€å‘C++é‚£æ ·æ‰‹åŠ¨åˆ†é…å¯¹è±¡çš„å†…å­˜ï¼Œè¿˜è¦åœ¨åˆé€‚çš„æ—¶æœºæ‰‹åŠ¨é‡Šæ”¾ï¼Œä¸€å®šç¨‹åº¦åœ°é™ä½äº†javaç¨‹åºå‘˜çš„å¼€å‘éš¾åº¦ã€‚å¦ä¸€æ–¹é¢ï¼Œè™šæ‹Ÿæœºå¯ä»¥å¸®åŠ©ç¨‹åºå¼€å‘äººå‘˜ç®¡ç†å†…å­˜ï¼Œå¦‚æœç¨‹åºå‘˜ä¸äº†è§£è™šæ‹Ÿæœºåƒåœ¾å›æ”¶çš„åŸç†ï¼Œå¾ˆå®¹æ˜“å¼•èµ·OOMï¼Œé€ æˆæœåŠ¡çš„å´©æºƒå’Œç³»ç»Ÿçš„å®•æœºï¼›</p><h1 id="2ã€å¯¹è±¡å¦‚ä½•åˆ¤æ´»"><a href="#2ã€å¯¹è±¡å¦‚ä½•åˆ¤æ´»" class="headerlink" title="2ã€å¯¹è±¡å¦‚ä½•åˆ¤æ´»"></a>2ã€å¯¹è±¡å¦‚ä½•åˆ¤æ´»</h1><p>å¯¹è±¡å­˜æ´»è¡¨ç¤ºçš„æ˜¯å½“å‰å¯¹è±¡æ˜¯å¦è¿˜åœ¨è¢«ä½¿ç”¨ï¼Œæ²¡æœ‰è¢«ä½¿ç”¨çš„å¯¹è±¡æˆ‘ä»¬å¯ä»¥ç§°å…¶ä¸ºå·²ç»â€œæ­»äº¡â€ï¼Œå¦‚æœå¯¹è±¡ä¾ç„¶åœ¨è¢«ä½¿ç”¨ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºâ€œå­˜æ´»â€çŠ¶æ€ï¼Œå¯¹è±¡æ˜¯å¦è¢«ä½¿ç”¨åˆ™æ˜¯é€šè¿‡å¯¹è±¡çš„å¼•ç”¨è¿›è¡Œåˆ¤æ–­çš„ã€‚è€Œåƒåœ¾å›æ”¶æœºåˆ¶å°±æ˜¯è´Ÿè´£å°†å·²ç»æ­»äº¡çš„å¯¹è±¡è¿›è¡Œæ¸…ç†ã€‚</p><p><strong>ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆ3ä¸ªåŒºåŸŸéšçº¿ç¨‹è€Œç”Ÿ</strong>ï¼Œéšçº¿ç¨‹è€Œç­ï¼Œæ ˆä¸­çš„æ ˆå¸§éšç€æ–¹æ³•çš„è¿›å…¥å’Œé€€å‡ºè€Œæœ‰æ¡ä¸ç´Šåœ°æ‰§è¡Œç€å‡ºæ ˆå’Œå…¥æ ˆçš„æ“ä½œã€‚<code>æ¯ä¸€ä¸ªæ ˆå¸§ä¸­åˆ†é…å¤šå°‘å†…å­˜åŸºæœ¬ä¸Šæ˜¯åœ¨ç±»ç»“æ„ç¡®å®šä¸‹æ¥æ—¶å°±å·²çŸ¥çš„</code>ï¼Œå› æ­¤è¿™å‡ ä¸ªåŒºåŸŸçš„å†…å­˜åˆ†é…å’Œå›æ”¶éƒ½å…·å¤‡ç¡®å®šæ€§ï¼Œåœ¨è¿™å‡ ä¸ªåŒºåŸŸä¸éœ€è¦è¿‡å¤šçš„è€ƒè™‘å›æ”¶çš„é—®é¢˜ï¼Œå½“æ–¹æ³•ç»“æŸæˆ–è€…çº¿ç¨‹ç»“æŸçš„æ—¶å€™ï¼Œå†…å­˜è‡ªç„¶å°±è·Ÿç€å›æ”¶äº†ã€‚</p><p>Javaå †åˆ™å’Œä¸Šè¿°ä¸‰ç§åŒºåŸŸä¸åŒï¼ŒJavaä¸­ä¸€ä¸ªæ¥å£çš„å¤šä¸ªå®ç°ç±»éœ€è¦çš„å†…å­˜å¯èƒ½ä¸ä¸€æ ·ï¼Œä¸€ä¸ªæ–¹æ³•ä¸­çš„å¤šä¸ªåˆ†æ”¯éœ€è¦çš„å†…å­˜ä¹Ÿä¸ä¸€æ ·ï¼Œè€Œ**åªæœ‰å½“<code>Javaç¨‹åºè¿è¡Œæ—¶æˆ‘ä»¬æ‰èƒ½çŸ¥é“å“ªäº›å¯¹è±¡ä¼šè¢«åˆ›å»º**</code>ï¼Œæ‰€ä»¥å †ä¸­çš„å†…å­˜åˆ†é…å’Œå›æ”¶éƒ½æ˜¯<code>åŠ¨æ€</code>è¿›è¡Œçš„ï¼Œå› æ­¤åƒåœ¾æ”¶é›†å™¨æ‰€å…³æ³¨çš„ä¹Ÿæ˜¯è¿™éƒ¨åˆ†çš„å†…å­˜ã€‚</p><p>åƒåœ¾å›æ”¶å™¨åœ¨å¯¹å †è¿›è¡Œå›æ”¶å‰ï¼Œç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯è¦åˆ¤æ–­å †ä¸­çš„å¯¹è±¡å“ªäº›æ˜¯ä¾æ—§åœ¨ä½¿ç”¨çš„ï¼Œå“ªäº›å·²ç»ä¸å¯èƒ½å†è¢«ä½¿ç”¨äº†ã€‚è¿™é‡Œçš„åˆ¤æ–­ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œç¬¬äºŒç§æ˜¯å¯è¾¾æ€§åˆ†æç®—æ³•ã€‚</p><h2 id="2-1-å¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#2-1-å¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="2.1 å¼•ç”¨è®¡æ•°ç®—æ³•"></a>2.1 å¼•ç”¨è®¡æ•°ç®—æ³•</h2><p>å¼•ç”¨è®¡æ•°ç®—æ³•ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å°±åŠ 1ï¼Œå½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å°±å‡1ï¼Œä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚è¿™ç§ç®—æ³•å®ç°ç®€å•ï¼Œåˆ¤å®šæ•ˆç‡ä¹Ÿå¾ˆé«˜ï¼Œ<font color=red>ä½†æ˜¯å®ƒéš¾ä»¥è§£å†³å¯¹è±¡ä¹‹é—´å¾ªç¯å¼•ç”¨çš„é—®é¢˜</font>ï¼Œä¾‹å¦‚å¯¹è±¡Aå’Œå¯¹è±¡Bç›¸äº’å¼•ç”¨äº†å¯¹æ–¹ï¼Œè€ŒAå’ŒBéƒ½æ²¡æœ‰åœ¨è¢«ä½¿ç”¨äº†ï¼Œä½†è¿™ä¸¤ä¸ªå¯¹è±¡å´ä¹Ÿä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p><h2 id="2-2-å¯è¾¾æ€§åˆ†æ"><a href="#2-2-å¯è¾¾æ€§åˆ†æ" class="headerlink" title="2.2 å¯è¾¾æ€§åˆ†æ"></a>2.2 å¯è¾¾æ€§åˆ†æ</h2><p>ä¸»æµçš„åˆ¤æ–­æ–¹æ³•åˆ™æ˜¯ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»ã€‚è¿™ä¸ªç®—æ³•éœ€è¦é€‰æ‹©ä¸€äº›å¯¹è±¡ä½œä¸ºâ€œGC Rootsâ€ï¼Œæ¯æ¬¡éƒ½é€šè¿‡è¿™äº›rootsèŠ‚ç‚¹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsä¸å­˜åœ¨å¼•ç”¨é“¾çš„æ—¶å€™ï¼Œåˆ™è¯æ˜è¿™ä¸ªå¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730201240815.png" alt="image-20210730201240815" style="zoom:50%;" /><p>åœ¨Javaè¯­è¨€ä¸­ï¼Œå¯ä½œä¸ºGC Rootsçš„å¯¹è±¡åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š</p><p>1ã€è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡<br>2ã€æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡<br>3ã€æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡<br>4ã€æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆå³Nativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡</p><p>å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­æ ¹æ®GC Rootsæ‰¾å¼•ç”¨é“¾ï¼Œå­˜åœ¨ä¸¤ä¸ªä¸»è¦çš„é—®é¢˜ã€‚</p><p>ä¸€ä¸ªæ˜¯å¯ä½œä¸ºGC Rootsçš„èŠ‚ç‚¹ä¸»è¦åœ¨å…¨å±€æ€§çš„å¼•ç”¨ï¼ˆä¾‹å¦‚å¸¸é‡æˆ–è€…ç±»é™æ€å±æ€§ï¼‰äºä¸Šä¸‹æ–‡(ä¾‹å¦‚æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­ï¼Œç°åœ¨å¾ˆå¤šåº”ç”¨ä»…ä»…æ–¹æ³•åŒºå°±æœ‰æ•°ç™¾å…†ï¼Œå¦‚æœè¦é€ä¸ªæ£€æŸ¥è¿™é‡Œé¢çš„å¼•ç”¨ï¼Œå°†ä¼šæ¶ˆè€—å¾ˆå¤šçš„æ—¶é—´ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯GCåœé¡¿ï¼Œå¯è¾¾æ€§åˆ†æå¿…é¡»ç¡®ä¿åœ¨æ•´ä¸ªçš„åˆ†æè¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œç³»ç»Ÿå°±åƒè¢«å†»ç»“åœ¨æŸä¸ªæ—¶é—´èŠ‚ç‚¹ï¼Œæ•´ä¸ªåˆ†æè¿‡ç¨‹ä¸­å¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸èƒ½å‘ç”Ÿå˜åŒ–ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åˆ†æç»“æœçš„å‡†ç¡®æ€§ï¼Œå› æ­¤åœ¨è¿›è¡ŒGCæ—¶ï¼Œéœ€è¦åœé¡¿æ‰€æœ‰çš„Javaçº¿ç¨‹ã€‚ï¼ˆStop The Worldï¼‰</p><h2 id="3-3-å¯¹è±¡ä¸¤æ¬¡æ ‡è®°åˆ¤æ´»"><a href="#3-3-å¯¹è±¡ä¸¤æ¬¡æ ‡è®°åˆ¤æ´»" class="headerlink" title="3.3 å¯¹è±¡ä¸¤æ¬¡æ ‡è®°åˆ¤æ´»"></a>3.3 å¯¹è±¡ä¸¤æ¬¡æ ‡è®°åˆ¤æ´»</h2><p>å³ä½¿åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éæ˜¯â€éæ­»ä¸å¯â€œçš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€ç¼“åˆ‘â€œé˜¶æ®µï¼Œ<em><strong>è¦å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹</strong></em>ï¼š</p><p>å¦‚æœå¯¹è±¡åœ¨è¿›è¡Œå¯è¾¾æ€§åˆ†æåå‘ç°æ²¡æœ‰ä¸GC Rootsç›¸è¿æ¥çš„å¼•ç”¨é“¾ï¼Œé‚£å®ƒå°†ä¼šè¢«ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶ä¸”è¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œç­›é€‰çš„æ¡ä»¶æ˜¯æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•(å½“å¯¹è±¡æ²¡æœ‰è¦†ç›–finalize()æ–¹æ³•ï¼Œæˆ–è€…finalize()æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡ï¼Œè™šæ‹Ÿæœºå°†è¿™ä¸¤ç§æƒ…å†µéƒ½è§†ä¸ºâ€æ²¡æœ‰å¿…è¦æ‰§è¡Œâ€œ)ã€‚</p><p>å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«åˆ¤å®šä¸ºæœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¼šæ”¾ç½®åœ¨ä¸€ä¸ªå«åšF-Queueçš„é˜Ÿåˆ—ä¹‹ä¸­ï¼Œå¹¶åœ¨ç¨åç”±ä¸€ä¸ªç”±è™šæ‹Ÿæœºè‡ªåŠ¨å»ºç«‹çš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹å»æ‰§è¡Œå®ƒã€‚è¿™é‡Œçš„æ‰§è¡Œæ˜¯æŒ‡ç”±è™šæ‹Ÿæœºå»è§¦å‘è¿™ä¸ªæ–¹æ³•ï¼Œä½†å¹¶ä¸ä¸€å®šä¼šç­‰å¾…è¯¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼ˆä¸ºäº†é¿å…finalizeæ–¹æ³•ä¸­å‡ºç°ç±»ä¼¼æ­»å¾ªç¯éƒ½æ“ä½œï¼Œå¯¼è‡´å†…å­˜æ— æ³•è¢«å›æ”¶ï¼ŒåŒæ—¶å¯¼è‡´F-Queueé˜Ÿåˆ—ä¸­çš„å…¶ä»–å¯¹è±¡ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼‰ã€‚</p><p>å½“æ‰§è¡Œå®Œfinalze()æ–¹æ³•åï¼ŒGCå°†ä¼šå¯¹F-Queueä¸­çš„å¯¹è±¡è¿›è¡Œç¬¬äºŒæ¬¡å°è§„æ¨¡çš„æ ‡è®°ï¼Œå¦‚æœå¯¹è±¡åœ¨finalize()æ–¹æ³•ä¸­åˆé‡æ–°è·å¾—äº†å¼•ç”¨ï¼Œå¯¹è±¡å°†ä¼šè¢«ç§»å‡ºå¯¹åˆ—å¹¶ä¸”ç»§ç»­å­˜æ´»ï¼Œå¦‚æœå¯¹è±¡ä¾æ—§å­˜åœ¨äºé˜Ÿåˆ—ä¸­å¹¶ä¸”è¢«è¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°ï¼Œå¯¹è±¡å°†è¢«GCå›æ”¶ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœç¬¬ä¸€æ¬¡é€šè¿‡finalize()æ–¹æ³•æ•‘æ´»äº†å¯¹è±¡ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡ç›¸åŒçš„æ–¹æ³•å°±ä¼šå¤±æ•ˆã€‚åŒæ—¶ç”±äºfinalize()æ–¹æ³•çš„è¿è¡Œä»£ä»·é«˜æ˜‚ï¼Œä¸ç¡®å®šæ€§å¤§ï¼Œæ— æ³•ä¿è¯å„ä¸ªå¯¹è±¡çš„è°ƒç”¨é¡ºåºï¼Œå› æ­¤åº”å½“å°½é‡é¿å…ä½¿ç”¨finalize()æ–¹æ³•ã€‚</p><h1 id="3-å¯¹è±¡å¼•ç”¨åˆ†ç±»"><a href="#3-å¯¹è±¡å¼•ç”¨åˆ†ç±»" class="headerlink" title="3. å¯¹è±¡å¼•ç”¨åˆ†ç±»"></a>3. å¯¹è±¡å¼•ç”¨åˆ†ç±»</h1><p>JDK1.2ä»¥å‰ï¼ŒJavaä¸­å¼•ç”¨çš„å®šä¹‰å¾ˆä¼ ç»Ÿï¼Œå¦‚æœreferenceç±»å‹çš„æ•°æ®ä¸­å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±ç§°è¿™å—å†…å­˜ä»£è¡¨ç€ä¸€ä¸ªå¼•ç”¨ã€‚è¿™ç§å®šä¹‰ä¸‹çš„å¯¹è±¡åªå­˜åœ¨ä¸¤ç§çŠ¶æ€ï¼Œè¢«å¼•ç”¨å’Œæœªè¢«å¼•ç”¨çŠ¶æ€ã€‚ä½†æœ‰äº›å¯¹è±¡æˆ‘ä»¬å¸Œæœ›å½“å†…å­˜å­˜å¤Ÿçš„æ—¶å€™èƒ½å¤Ÿä¿ç•™è¿™äº›å¯¹è±¡ï¼Œå½“å†…å­˜ä¸è¶³çš„æ—¶å€™åˆ™èƒ½å¤Ÿå¯¹è¿™äº›å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼Œè¿™ä¸€ç±»å¯¹è±¡åˆ™æ— æ³•ä½¿ç”¨è¿™ç§ä¼ ç»Ÿçš„å®šä¹‰æ¥è¡¨ç¤ºã€‚</p><p>JDK1.2ä¹‹åï¼ŒJavaå¯¹å¼•ç”¨è¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸º<code>å¼ºå¼•ç”¨</code>ã€<code>è½¯å¼•ç”¨</code>ã€<code>å¼±å¼•ç”¨</code>å’Œ<code>è™šå¼•ç”¨</code>å››ç§ï¼Œè¿™å››ç§å¼•ç”¨çš„å¼ºåº¦ä¾æ¬¡é€æ¸å‡å¼±ã€‚</p><h2 id="3-1-å¼ºå¼•ç”¨"><a href="#3-1-å¼ºå¼•ç”¨" class="headerlink" title="3.1 å¼ºå¼•ç”¨"></a>3.1 å¼ºå¼•ç”¨</h2><p>å°±æ˜¯æŒ‡åœ¨ç¨‹åºä»£ç ä¸­æ™®éå­˜åœ¨çš„ï¼Œç±»ä¼¼ <code>Object obj = new Object()</code> è¿™ç±»çš„å¼•ç”¨ï¼Œåªè¦å¼ºå¼•ç”¨è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨æ°¸è¿œä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚å³ä½¿å†…å­˜ä¸è¶³æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¹Ÿä¸ä¼šå›æ”¶å¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œè€Œæ˜¯ä¼šç›´æ¥æŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚å¦‚æœæƒ³è®©å¼ºå¼•ç”¨å¯¹è±¡è¢«å›æ”¶ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®obj = null;æ¥å®ç°ã€‚</p><h2 id="3-2-è½¯å¼•ç”¨"><a href="#3-2-è½¯å¼•ç”¨" class="headerlink" title="3.2 è½¯å¼•ç”¨"></a>3.2 è½¯å¼•ç”¨</h2><p>ç”¨æ¥æè¿°ä¸€äº›è¿˜æœ‰ç”¨ä½†å¹¶éå¿…éœ€çš„å¯¹è±¡ã€‚å¯¹äºè½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨å†…å­˜è¶³å¤Ÿçš„æ—¶å€™ï¼Œæ˜¯ä¸ä¼šå›æ”¶è½¯å¼•ç”¨çš„å¯¹è±¡çš„ï¼Œè€Œåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ï¼Œå¦‚æœè½¯å¼•ç”¨å›æ”¶åä¾ç„¶å†…å­˜ä¸è¶³ï¼Œåˆ™ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚åœ¨JDK1.2ä¹‹åï¼Œæä¾›äº†SoftReferenceç±»æ¥å®ç°è½¯å¼•ç”¨ã€‚<code>è½¯å¼•ç”¨å¯ä»¥ç”¨æ¥å®ç°ç¼“å­˜æŠ€æœ¯ã€‚</code></p><h2 id="3-3-å¼±å¼•ç”¨"><a href="#3-3-å¼±å¼•ç”¨" class="headerlink" title="3.3 å¼±å¼•ç”¨"></a>3.3 å¼±å¼•ç”¨</h2><p>å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ä¸€æ ·ç”¨æ¥æè¿°éå¿…é¡»çš„å¯¹è±¡ï¼Œä½†æ˜¯å®ƒçš„å¼ºåº¦æ¯”è½¯å¼•ç”¨æ›´å¼±ä¸€äº›ï¼Œè¢«<code>å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰</code>ã€‚å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œæ—¶ï¼Œæ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚åœ¨JDK1.2ä¹‹åï¼Œæä¾›äº†<code>WeakReference</code>ç±»æ¥å®ç°å¼±å¼•ç”¨ã€‚</p><h2 id="3-4-è™šå¼•ç”¨"><a href="#3-4-è™šå¼•ç”¨" class="headerlink" title="3.4 è™šå¼•ç”¨"></a>3.4 è™šå¼•ç”¨</h2><p>è™šå¼•ç”¨ä¹Ÿè¢«ç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚åœ¨JDK1.2ä¹‹åï¼Œæä¾›äº†PhantomReferenceç±»æ¥å®ç°è™šå¼•ç”¨ã€‚</p><h1 id="4-åƒåœ¾å›æ”¶ç®—æ³•"><a href="#4-åƒåœ¾å›æ”¶ç®—æ³•" class="headerlink" title="4.åƒåœ¾å›æ”¶ç®—æ³•"></a>4.åƒåœ¾å›æ”¶ç®—æ³•</h1><p><em>åƒåœ¾æ”¶é›†ç®—æ³•çš„ç›®çš„æ˜¯åœ¨å·²ç»æ˜ç¡®äº†å“ªäº›å†…å­˜å—éœ€è¦å›æ”¶ä»¥åï¼Œå¦‚ä½•é«˜æ•ˆçš„å›æ”¶è¿™äº›å†…å­˜ç©ºé—´ã€‚</em></p><h2 id="4-1-æ ‡è®°æ¸…é™¤ç®—æ³•"><a href="#4-1-æ ‡è®°æ¸…é™¤ç®—æ³•" class="headerlink" title="4.1 æ ‡è®°æ¸…é™¤ç®—æ³•"></a>4.1 æ ‡è®°æ¸…é™¤ç®—æ³•</h2><p><strong>æ ‡è®°-æ¸…é™¤ç®—æ³•</strong>é‡‡ç”¨ä»æ ¹é›†åˆè¿›è¡Œæ‰«æï¼Œå¯¹å­˜æ´»çš„å¯¹è±¡å¯¹è±¡æ ‡è®°ï¼Œæ ‡è®°å®Œæ¯•åï¼Œå†æ‰«ææ•´ä¸ªç©ºé—´ä¸­æœªè¢«æ ‡è®°çš„å¯¹è±¡ï¼Œè¿›è¡Œå›æ”¶ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚æ ‡è®°-æ¸…é™¤ç®—æ³•ä¸éœ€è¦è¿›è¡Œå¯¹è±¡çš„ç§»åŠ¨ï¼Œå¹¶ä¸”ä»…å¯¹ä¸å­˜æ´»çš„å¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œåœ¨å­˜æ´»å¯¹è±¡æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹æä¸ºé«˜æ•ˆã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730203128783.png" alt="image-20210730203128783" style="zoom:50%;" /><p>æ ‡è®°æ¸…é™¤ç®—æ³•ä¸»è¦æœ‰ä¸¤ä¸ªä¸è¶³ä¹‹å¤„ï¼šä¸€ä¸ªæ˜¯æ•ˆç‡é—®é¢˜ï¼Œæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜ï¼›å¦ä¸€ä¸ªé—®é¢˜æ˜¯ç©ºé—´é—®é¢˜ï¼Œæ ‡è®°æ¸…é™¤ä¹‹åä¼šé€ æˆå†…å­˜ç©ºé—´ä¸­å­˜åœ¨å¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼Œç©ºé—´ç¢ç‰‡å¤ªå¤šæ—¶ï¼Œå½“è¦åˆ†é…ä¸€ç‰‡å¤§å†…å­˜ç©ºé—´æ—¶å¯èƒ½ä¼šæ‰¾ä¸åˆ°åˆé€‚çš„è¿ç»­å†…å­˜ç©ºé—´è¿›è¡Œåˆ†é…ï¼Œä»è€Œè§¦å‘å¦ä¸€æ¬¡åƒåœ¾æ”¶é›†åŠ¨ä½œã€‚</p><h2 id="4-2-æ ‡è®°å¤åˆ¶ç®—æ³•"><a href="#4-2-æ ‡è®°å¤åˆ¶ç®—æ³•" class="headerlink" title="4.2 æ ‡è®°å¤åˆ¶ç®—æ³•"></a>4.2 æ ‡è®°å¤åˆ¶ç®—æ³•</h2><p>è¯¥ç®—æ³•çš„æå‡ºæ˜¯ä¸ºäº†å…‹æœ<strong>å¥æŸ„çš„å¼€é”€</strong>å’Œ<strong>è§£å†³å †ç¢ç‰‡</strong>çš„åƒåœ¾å›æ”¶ã€‚å»ºç«‹åœ¨å­˜æ´»å¯¹è±¡å°‘ï¼Œåƒåœ¾å¯¹è±¡å¤šçš„å‰æä¸‹ã€‚æ­¤ç®—æ³•<code>æ¯æ¬¡åªå¤„ç†æ­£åœ¨ä½¿ç”¨ä¸­çš„å¯¹è±¡</code>ï¼Œå› æ­¤å¤åˆ¶æˆæœ¬æ¯”è¾ƒå°ï¼ŒåŒæ—¶å¤åˆ¶è¿‡å»åè¿˜èƒ½è¿›è¡Œç›¸åº”çš„å†…å­˜æ•´ç†ï¼Œä¸ä¼šå‡ºç°ç¢ç‰‡é—®é¢˜ã€‚ä½†ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯éœ€è¦ä¸¤å€å†…å­˜ç©ºé—´ã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730203413207.png" alt="image-20210730203413207" style="zoom:50%;" /><p>å®ƒå¼€å§‹æ—¶æŠŠå †åˆ†æˆ ä¸€ä¸ªå¯¹è±¡é¢å’Œå¤šä¸ªç©ºé—²é¢ï¼Œ ç¨‹åºä»å¯¹è±¡é¢ä¸ºå¯¹è±¡åˆ†é…ç©ºé—´ï¼Œå½“å¯¹è±¡æ»¡äº†ï¼ŒåŸºäºcopyingç®—æ³•çš„åƒåœ¾ æ”¶é›†å°±ä»æ ¹é›†ä¸­æ‰«ææ´»åŠ¨å¯¹è±¡ï¼Œå¹¶å°†æ¯ä¸ªæ´»åŠ¨å¯¹è±¡å¤åˆ¶åˆ°ç©ºé—²é¢(ä½¿å¾—æ´»åŠ¨å¯¹è±¡æ‰€å çš„å†…å­˜ä¹‹é—´æ²¡æœ‰ç©ºé—²æ´)ï¼Œè¿™æ ·ç©ºé—²é¢å˜æˆäº†å¯¹è±¡é¢ï¼ŒåŸæ¥çš„å¯¹è±¡é¢å˜æˆäº†ç©ºé—²é¢ï¼Œç¨‹åºä¼šåœ¨æ–°çš„å¯¹è±¡é¢ä¸­åˆ†é…å†…å­˜ã€‚ä¸€ç§å…¸å‹çš„åŸºäºcopingç®—æ³•çš„åƒåœ¾å›æ”¶æ˜¯stop-and-copyç®—æ³•ï¼Œå®ƒå°†å †åˆ†æˆå¯¹è±¡é¢å’Œç©ºé—²åŒºåŸŸé¢ï¼Œåœ¨å¯¹è±¡é¢ä¸ç©ºé—²åŒºåŸŸé¢çš„åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œç¨‹åºæš‚åœæ‰§è¡Œã€‚</p><p>ç°åœ¨çš„å•†ä¸šè™šæ‹Ÿæœºéƒ½ä¼š<code>é‡‡ç”¨è¿™ç§ç®—æ³•æ¥å›æ”¶æ–°ç”Ÿä»£</code>ï¼Œæ ¹æ®ç»Ÿè®¡æ–°ç”Ÿä»£ä¸­98%çš„å¯¹è±¡éƒ½æ˜¯â€œæœå¤•ç”Ÿæ­»â€çš„ï¼Œå› æ­¤å¯¹äºæ–°ç”Ÿä»£çš„å›æ”¶ä¸ç”¨æŒ‰ç…§1:1çš„æ¯”ä¾‹æ¥è¿›è¡Œå†…å­˜åˆ’åˆ†ï¼Œå¯ä»¥å°†å†…å­˜åˆ’åˆ†ä¸ºä¸€å—EdenåŒºåŸŸå’Œä¸¤å—Survivorç©ºé—´ï¼Œæ¯æ¬¡ä½¿ç”¨æ—¶éƒ½é€‰æ‹©EdenåŒºåŸŸå’Œä¸€å—SurvivoråŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ã€‚<em><strong>å½“å›æ”¶æ—¶ï¼Œå°†EdenåŒºåŸŸå’ŒSurvivoråŒºåŸŸä¸­è¿˜å­˜æ´»çš„å¯¹è±¡å…¨éƒ¨ç§»åŠ¨åˆ°å¦ä¸€å—SurvivoråŒºåŸŸï¼Œç„¶åæ¸…ç†æ‰EdenåŒºåŸŸå’Œåˆšåˆšä½¿ç”¨çš„SurvivoråŒºåŸŸã€‚</strong></em></p><p><em><strong>HotSpotè™šæ‹Ÿæœºä¸­Edenå’ŒSurvivorçš„æ¯”ä¾‹æ˜¯1:8</strong></em>ï¼Œ<em><strong>å³æ¯æ¬¡éƒ½æœ‰90%çš„å†…å­˜ç©ºé—´åœ¨è¿›è¡Œä½¿ç”¨ï¼Œåªæœ‰10%çš„å†…å­˜ç©ºé—´è¢«æµªè´¹äº†ã€‚</strong></em>å½“ç„¶ï¼Œå¦‚æœæ¯æ¬¡å†…å­˜éƒ½æœ‰98%è¢«å›æ”¶ï¼Œé‚£ä¹ˆæ¯æ¬¡è¢«ç§»åŠ¨åˆ°å¦ä¸€å—SurvivoråŒºåŸŸçš„å†…å­˜åªæœ‰2%ï¼Œè¿™æ ·æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœç§»åŠ¨åˆ°å¦ä¸€å—SurvivoråŒºåŸŸçš„å†…å­˜è¶…è¿‡äº†10%ï¼Œå°±éœ€è¦ä¾èµ–å…¶ä»–çš„å†…å­˜ï¼ˆè¿™é‡ŒæŒ‡è€å¹´ä»£ï¼‰è¿›è¡Œåˆ†é…æ‹…ä¿äº†ï¼ˆå°†å¤šå‡ºçš„å¯¹è±¡åˆ†é…åˆ°è€å¹´ä»£ï¼‰ã€‚</p><h2 id="4-3-æ ‡è®°æ•´ç†ç®—æ³•"><a href="#4-3-æ ‡è®°æ•´ç†ç®—æ³•" class="headerlink" title="4.3 æ ‡è®°æ•´ç†ç®—æ³•"></a>4.3 æ ‡è®°æ•´ç†ç®—æ³•</h2><p>â€ƒæ­¤ç®—æ³•æ˜¯ç»“åˆäº†â€œæ ‡è®°-æ¸…é™¤â€å’Œâ€œå¤åˆ¶ç®—æ³•â€ä¸¤ä¸ªç®—æ³•çš„ä¼˜ç‚¹ã€‚é¿å…äº†â€œæ ‡è®°-æ¸…é™¤â€çš„ç¢ç‰‡é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿé¿å…äº†â€œå¤åˆ¶â€ç®—æ³•çš„ç©ºé—´é—®é¢˜ã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730203709050.png" alt="image-20210730203709050" style="zoom:50%;" /><p>æ ‡è®°-æ•´ç†ç®—æ³•çš„æ ‡è®°è¿‡ç¨‹å’Œæ ‡è®°-æ¸…é™¤ç®—æ³•çš„æ ‡è®°è¿‡ç¨‹ä¸€è‡´ï¼Œä½†æ˜¯åœ¨æ ‡è®°å®Œä»¥åï¼Œæ ‡è®°-æ•´ç†ç®—æ³•ä¼šå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½ç§»åŠ¨åˆ°ä¸€ç«¯ï¼Œç„¶åå†è¿›è¡Œæ¸…é™¤ã€‚<strong>è¿™ç§ç®—æ³•é€‚ç”¨äºè€å¹´ä»£</strong>ï¼Œå› ä¸ºè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»ç‡éƒ½ä¼šæ¯”è¾ƒé«˜ï¼Œå¦‚æœåƒä¹‹å‰ä¸€æ ·è¿›è¡Œå¤åˆ¶ç§»åŠ¨ï¼Œå°†ä¼šäº§ç”Ÿå¤§é‡çš„å¤åˆ¶æ“ä½œå¯¼è‡´æ•ˆç‡å˜ä½ï¼ŒåŒæ—¶æ¯æ¬¡éƒ½ä¼šå­˜æ´»ä¸‹å¤§é‡å¯¹è±¡å¯¼è‡´éœ€è¦å¾ˆå¤šçš„å†…å­˜ç©ºé—´æ¥è¿›è¡Œåˆ†é…æ‹…ä¿ã€‚</p><h2 id="4-4-åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#4-4-åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="4.4 åˆ†ä»£æ”¶é›†ç®—æ³•"></a>4.4 åˆ†ä»£æ”¶é›†ç®—æ³•</h2><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210731141452995.png" alt="image-20210731141452995" style="zoom:50%;" /><p>å½“å‰å•†ä¸šè™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†éƒ½é‡‡ç”¨â€œåˆ†ä»£æ”¶é›†â€ç®—æ³•ï¼Œè¿™ç§ç®—æ³•æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—ï¼Œä¸€èˆ¬æ˜¯æŠŠJavaå †åˆ’åˆ†ä½æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚æ–°ç”Ÿä»£ä¸­æ¯æ¬¡éƒ½ä¼šæœ‰å¤§æ‰¹å¯¹è±¡æ­»å»ï¼Œåªæœ‰å°‘é‡å¯¹è±¡å­˜æ´»ï¼Œå› æ­¤å¯ä»¥é€‰ç”¨å¤åˆ¶ç®—æ³•ã€‚</p><p>è€å¹´ä»£æ¯æ¬¡éƒ½ä¼šæœ‰å¤§é‡å¯¹è±¡å­˜æ´»ï¼Œå› æ­¤é€‰æ‹©æ ‡è®°-æ¸…ç†æˆ–è€…æ ‡è®°-æ•´ç†ç®—æ³•æ¥è¿›è¡Œã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;åƒåœ¾å›æ”¶æ€»ä½“æ€è·¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1ã€ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼Œä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶ï¼›&lt;/p&gt;
&lt;p&gt;2ã€å›æ”¶çš„åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿç”±è°æ¥å›æ”¶è°ï¼Ÿ&lt;/p&gt;
&lt;p&gt;3ã€å›æ”¶çš„åˆ¤æ–­æ ‡å‡†æ˜¯ä»€ä¹ˆ&lt;/p&gt;
&lt;p&gt;4ã€ä»€ä¹ˆæ—¶å€™å›æ”¶ï¼Œå›æ”¶çš„ç§ç±»å’Œæµç¨‹æ˜¯æ€æ ·çš„&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVM-å¯¹è±¡åˆ›å»º</title>
    <link href="http://example.com/wiki/JVM-%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA/"/>
    <id>http://example.com/wiki/JVM-%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA/</id>
    <published>2021-07-30T06:42:55.000Z</published>
    <updated>2021-07-30T08:46:15.093Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-å¯¹è±¡åˆ›å»ºæ–¹å¼"><a href="#1-å¯¹è±¡åˆ›å»ºæ–¹å¼" class="headerlink" title="1.å¯¹è±¡åˆ›å»ºæ–¹å¼"></a>1.å¯¹è±¡åˆ›å»ºæ–¹å¼</h2><p>Javaä¸­æœ‰ä¸€ä¸‹å‡ ç§æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼š</p><table><thead><tr><th><strong>æ–¹å¼</strong></th><th><strong>å®è´¨</strong></th></tr></thead><tbody><tr><td>ä½¿ç”¨newå…³é”®</td><td>è°ƒç”¨æ— å‚æˆ–æœ‰å‚æ„é€ å™¨å‡½æ•°åˆ›å»º</td></tr><tr><td>ä½¿ç”¨Classçš„newInstanceæ–¹æ³•</td><td>è°ƒç”¨æ— å‚æˆ–æœ‰å‚æ„é€ å™¨å‡½æ•°åˆ›å»ºï¼Œä¸”éœ€è¦æ˜¯publiçš„æ„é€ å‡½æ•°</td></tr><tr><td>ä½¿ç”¨Constructorç±»çš„newInstanceæ–¹æ³•</td><td>è°ƒç”¨æœ‰å‚å’Œç§æœ‰privateæ„é€ å™¨å‡½æ•°åˆ›å»ºï¼Œå®ç”¨æ€§æ›´å¹¿</td></tr><tr><td>ä½¿ç”¨Cloneæ–¹æ³•</td><td>ä¸è°ƒç”¨ä»»ä½•å‚æ„é€ å™¨å‡½æ•°ï¼Œä¸”å¯¹è±¡éœ€è¦å®ç°Cloneableæ¥å£å¹¶å®ç°å…¶å®šä¹‰çš„cloneæ–¹æ³•ï¼Œä¸”é»˜è®¤ä¸ºæµ…å¤åˆ¶</td></tr><tr><td>ç¬¬ä¸‰æ–¹åº“Objenesis</td><td>åˆ©ç”¨äº†asmå­—èŠ‚ç æŠ€æœ¯ï¼ŒåŠ¨æ€ç”ŸæˆConstructorå¯¹è±¡</td></tr></tbody></table><h2 id="2ã€å¯¹è±¡åˆ›å»ºè¿‡ç¨‹"><a href="#2ã€å¯¹è±¡åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="2ã€å¯¹è±¡åˆ›å»ºè¿‡ç¨‹"></a>2ã€å¯¹è±¡åˆ›å»ºè¿‡ç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730153219366.png" alt="image-20210730153219366"></p><h3 id="2-1-ç±»çš„åŠ è½½"><a href="#2-1-ç±»çš„åŠ è½½" class="headerlink" title="2.1 ç±»çš„åŠ è½½"></a>2.1 ç±»çš„åŠ è½½</h3><p>è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆå°†å»æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°æ˜¯å¦èƒ½åœ¨å¸¸é‡æ± ä¸­å®šä½åˆ°ä¸€ä¸ªç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹ã€‚</p><h3 id="2-2-åˆ†é…å†…å­˜"><a href="#2-2-åˆ†é…å†…å­˜" class="headerlink" title="2.2 åˆ†é…å†…å­˜"></a>2.2 åˆ†é…å†…å­˜</h3><p>ç±»çš„åŠ è½½æ£€æŸ¥é€šè¿‡åï¼Œæ¥ä¸‹æ¥æ˜¯ä¸ºæ–°ç”Ÿå¯¹è±¡åˆ†é…å†…å­˜ã€‚ä½†ç±»åŠ è½½å®Œæˆåæ‰€éœ€çš„å†…å­˜å¤§å°å°±å·²ç»å®Œå…¨ç¡®å®šï¼Œä¸ºå¯¹è±¡åˆ†é…ç©ºé—´çš„ä»»åŠ¡ç­‰åŒäºæŠŠä¸€å—ç¡®å®šå¤§å°çš„å†…å­˜ä»javaå †ä¸­åˆ’åˆ†å‡ºæ¥ã€‚åˆ†é…å†…å­˜æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><strong>æŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰</strong>ï¼šå‡è®¾javaå †ä¸­å†…å­˜æ˜¯ç»å¯¹è§„æ•´çš„ï¼Œæ‰€æœ‰ç”¨è¿‡å¾—å†…å­˜éƒ½æ”¾åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜æ”¾åœ¨å¦ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œé‚£æ‰€åˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠé‚£ä¸ªæŒ‡é’ˆå‘ç©ºé—²ç©ºé—´é‚£è¾¹æŒªåˆ°ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»</li><li><strong>ç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰</strong>ï¼šå¦‚æœjavaå †ä¸­çš„å†…å­˜å¹¶ä¸æ˜¯å®Œæ•´çš„ï¼Œå·²ä½¿ç”¨çš„å†…å­˜å’Œç©ºé—²çš„å†…å­˜ç›¸äº’äº¤é”™ï¼Œé‚£å°±æ²¡æœ‰åŠæ³•ç®€å•åœ°è¿›è¡ŒæŒ‡é’ˆç¢°æ’äº†ï¼Œè™šæ‹Ÿæœºå°±å¿…é¡»ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½•ä¸Šå“ªäº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œåœ¨åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„è®°å½•ã€‚</li></ul><p>é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”±javaå †æ˜¯å¦å®Œæ•´å†³å®šï¼Œè€Œjavaå †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†ï¼ˆæ ‡è®°-æ•´ç†ï¼‰åŠŸèƒ½å†³å®šã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨Serialã€ParNewç­‰å¸¦æœ‰Compactè¿‡ç¨‹çš„æ”¶é›†å™¨æ—¶ï¼Œç³»ç»Ÿé‡‡ç”¨çš„åˆ†é…ç®—æ³•æ˜¯æŒ‡é’ˆç¢°æ’ï¼Œè€Œä½¿ç”¨CMSè¿™ç§åŸºäºMark-Sweepç®—æ³•çš„æ”¶é›†å™¨æ—¶ï¼Œé€šå¸¸é‡‡ç”¨ç©ºé—²åˆ—è¡¨ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘ï¼Œåœ¨è™šæ‹Ÿæœºä¸­å¯¹è±¡é¢‘ç¹çš„åˆ›å»ºï¼ˆå³ä½¿æ˜¯ä¿®æ”¹ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡çš„ä½ç½®ï¼‰ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ä¼šå¸¦æ¥çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚ä½œä¸ºè™šæ‹Ÿæœºæ¥è¯´ï¼Œå¿…é¡»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€æœ‰è™šæ‹Ÿæœºé‡‡ç”¨ä¸¤ç§æ–¹å¼ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š</p><ul><li><strong>CAS+å¤±è´¥é‡è¯•</strong>ï¼šCASæ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ã€‚æ‰€è°“ä¹è§‚é”å°±æ˜¯ï¼Œæ¯æ¬¡ä¸åŠ é”è€Œæ˜¯å‡è®¾æ²¡æœ‰å†²çªè€Œå»å®ŒæˆæŸé¡¹æ“ä½œï¼Œå¦‚æœå› ä¸ºå†²çªå¤±è´¥å°±é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚è™šæ‹Ÿæœºé‡‡ç”¨CASé…ä¸Šå¤±è´¥é‡è¯•çš„æ–¹å¼ä¿è¯æ›´æ–°æ“ä½œçš„åŸå­æ€§</li><li><strong>æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰</strong>ï¼šä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹é¢„å…ˆåœ¨EdenåŒºåˆ†é…ä¸€å—å†…å­˜ï¼ŒJVMåœ¨ç»™çº¿ç¨‹ä¸­çš„å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œé¦–å…ˆåœ¨TLABåˆ†é…ï¼Œå½“å¯¹è±¡å¤§äºTLABä¸­å‰©ä½™å†…å­˜æˆ–TLABçš„å†…å­˜å·²ç”¨å°½æ—¶ï¼Œåœ¨é‡‡ç”¨ä¸Šè¿°çš„CASè¿›è¡Œå†…å­˜åˆ†é…</li></ul><h3 id="2-3-åˆå§‹åŒ–é›¶å€¼"><a href="#2-3-åˆå§‹åŒ–é›¶å€¼" class="headerlink" title="2.3 åˆå§‹åŒ–é›¶å€¼"></a>2.3 åˆå§‹åŒ–é›¶å€¼</h3><p>å†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ï¼Œè¿™â¼€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨ Java ä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±ç›´æ¥ä½¿â½¤ï¼Œ<code>ç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼</code>ã€‚</p><h3 id="2-4-è®¾ç½®å¯¹è±¡å¤´"><a href="#2-4-è®¾ç½®å¯¹è±¡å¤´" class="headerlink" title="2.4 è®¾ç½®å¯¹è±¡å¤´"></a>2.4 è®¾ç½®å¯¹è±¡å¤´</h3><p>åˆå§‹åŒ–é›¶å€¼å®Œæˆä¹‹åï¼Œè™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›â¾å¿…è¦çš„è®¾ç½®ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œç ã€å¯¹è±¡çš„ GC åˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯ã€‚ è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡å¤´ä¸­ã€‚ å¦å¤–ï¼Œæ ¹æ®è™šæ‹Ÿæœºå½“å‰è¿â¾çŠ¶æ€çš„ä¸åŒï¼Œå¦‚æ˜¯å¦å¯â½¤åå‘é”ç­‰ï¼Œå¯¹è±¡å¤´ä¼šæœ‰ä¸åŒçš„è®¾ç½®â½…å¼ã€‚</p><h3 id="2-5-æ‰§è¡ŒInitæ–¹æ³•"><a href="#2-5-æ‰§è¡ŒInitæ–¹æ³•" class="headerlink" title="2.5 æ‰§è¡ŒInitæ–¹æ³•"></a>2.5 æ‰§è¡ŒInitæ–¹æ³•</h3><p>åœ¨ä¸Šâ¾¯â¼¯ä½œéƒ½å®Œæˆä¹‹åï¼Œä»è™šæ‹Ÿæœºçš„è§†â»†æ¥çœ‹ï¼Œâ¼€ä¸ªæ–°çš„å¯¹è±¡å·²ç»äº§â½£äº†ï¼Œä½†ä» Java ç¨‹åºçš„è§†â»†æ¥çœ‹ï¼Œå¯¹è±¡åˆ›å»ºæ‰åˆšå¼€å§‹ï¼Œ <code>&lt;init&gt;</code> â½…æ³•è¿˜æ²¡æœ‰æ‰§â¾ï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½è¿˜ä¸ºé›¶ã€‚æ‰€ä»¥â¼€èˆ¬æ¥è¯´ï¼Œæ‰§â¾ new æŒ‡ä»¤ä¹‹åä¼šæ¥ç€æ‰§â¾ <code>&lt;init&gt;</code>â½…æ³•ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›â¾åˆå§‹åŒ–ï¼Œè¿™æ ·â¼€ä¸ªçœŸæ­£å¯â½¤çš„å¯¹è±¡æ‰ç®—å®Œå…¨äº§â½£å‡ºæ¥ã€‚</p><h2 id="3-å¯¹è±¡åœ¨å†…å­˜å¸ƒå±€"><a href="#3-å¯¹è±¡åœ¨å†…å­˜å¸ƒå±€" class="headerlink" title="3.å¯¹è±¡åœ¨å†…å­˜å¸ƒå±€"></a>3.å¯¹è±¡åœ¨å†…å­˜å¸ƒå±€</h2><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730160335842.png" alt="image-20210730160335842" style="zoom:33%;" /><p><code>å¯¹è±¡å¤´(Header)</code>ï¼šåŒ…å«ä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œç ã€GC åˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹ IDã€åå‘æ—¶é—´æˆ³ç­‰ï¼Œ32 ä½è™šæ‹Ÿæœºå  32 bitï¼Œ64 ä½è™šæ‹Ÿæœºå  64 bitã€‚å®˜æ–¹ç§°ä¸º â€˜Mark Wordâ€™ã€‚ç¬¬äºŒéƒ¨åˆ†æ˜¯ç±»å‹æŒ‡é’ˆï¼Œå³å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»çš„å…ƒæ•°æ®æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚å¦å¤–ï¼Œå¦‚æœæ˜¯ Java æ•°ç»„ï¼Œå¯¹è±¡å¤´ä¸­è¿˜å¿…é¡»æœ‰ä¸€å—ç”¨äºè®°å½•æ•°ç»„é•¿åº¦çš„æ•°æ®ï¼Œå› ä¸ºæ™®é€šå¯¹è±¡å¯ä»¥é€šè¿‡ Java å¯¹è±¡å…ƒæ•°æ®ç¡®å®šå¤§å°ï¼Œè€Œæ•°ç»„å¯¹è±¡ä¸å¯ä»¥ã€‚</p><p><code>å®ä¾‹æ•°æ®(Instance Data)</code>ï¼šç¨‹åºä»£ç ä¸­æ‰€å®šä¹‰çš„å„ç§ç±»å‹çš„å­—æ®µå†…å®¹(åŒ…å«çˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„å’Œå­ç±»ä¸­å®šä¹‰çš„)ã€‚</p><p><code>å¯¹é½å¡«å……(Padding)</code>ï¼šä¸æ˜¯å¿…ç„¶éœ€è¦ï¼Œä¸»è¦æ˜¯å ä½ï¼Œä¿è¯å¯¹è±¡å¤§å°æ˜¯æŸä¸ªå­—èŠ‚çš„æ•´æ•°å€ã€‚</p><h2 id="4-å¯¹è±¡è®¿é—®"><a href="#4-å¯¹è±¡è®¿é—®" class="headerlink" title="4. å¯¹è±¡è®¿é—®"></a>4. å¯¹è±¡è®¿é—®</h2><p>å»ºâ½´å¯¹è±¡å°±æ˜¯ä¸ºäº†ä½¿â½¤å¯¹è±¡ï¼Œæˆ‘ä»¬çš„Javaç¨‹åºé€šè¿‡æ ˆä¸Šçš„ reference æ•°æ®æ¥æ“ä½œå †ä¸Šçš„å…·ä½“å¯¹è±¡ã€‚å¯¹è±¡çš„è®¿é—®â½…å¼æœ‰è™šæ‹Ÿæœºå®ç°â½½å®šï¼Œâ½¬å‰ä¸»æµçš„è®¿é—®â½…å¼æœ‰ä½¿â½¤å¥æŸ„å’Œç›´æ¥æŒ‡é’ˆä¸¤ç§ï¼š</p><h3 id="4-1-å¥æŸ„è®¿é—®"><a href="#4-1-å¥æŸ„è®¿é—®" class="headerlink" title="4.1 å¥æŸ„è®¿é—®"></a>4.1 å¥æŸ„è®¿é—®</h3><p> å¦‚æœä½¿â½¤å¥æŸ„çš„è¯ï¼Œé‚£ä¹ˆJavaå †ä¸­å°†ä¼šåˆ’åˆ†å‡ºâ¼€å—å†…å­˜æ¥ä½œä¸ºå¥æŸ„æ± ï¼Œreference ä¸­å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡çš„å¥æŸ„åœ°å€ï¼Œâ½½å¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡å®ä¾‹æ•°æ®ä¸ç±»å‹æ•°æ®å„â¾ƒçš„å…·ä½“åœ°å€ä¿¡æ¯ï¼›</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730160814175.png" alt="image-20210730160814175" style="zoom:50%;" /><h3 id="4-2-ç›´æ¥æŒ‡é’ˆ"><a href="#4-2-ç›´æ¥æŒ‡é’ˆ" class="headerlink" title="4 .2 ç›´æ¥æŒ‡é’ˆ"></a>4 .2 ç›´æ¥æŒ‡é’ˆ</h3><p> å¦‚æœä½¿â½¤ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼Œé‚£ä¹ˆ Java å †å¯¹è±¡çš„å¸ƒå±€ä¸­å°±å¿…é¡»è€ƒè™‘å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼Œâ½½reference ä¸­å­˜å‚¨çš„ç›´æ¥å°±æ˜¯å¯¹è±¡çš„åœ°å€ã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730161006154.png" alt="image-20210730161006154" style="zoom:50%;" /><p>è¿™ä¸¤ç§å¯¹è±¡è®¿é—®â½…å¼å„æœ‰ä¼˜åŠ¿ã€‚ä½¿â½¤å¥æŸ„æ¥è®¿é—®çš„æœ€â¼¤å¥½å¤„æ˜¯ reference ä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„å¥æŸ„åœ°å€ï¼Œåœ¨å¯¹è±¡è¢«ç§»åŠ¨æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œâ½½ reference æœ¬èº«ä¸éœ€è¦ä¿®æ”¹ã€‚ä½¿â½¤ç›´æ¥æŒ‡é’ˆè®¿é—®â½…å¼æœ€â¼¤çš„å¥½å¤„å°±æ˜¯é€Ÿåº¦å¿«ï¼Œå®ƒèŠ‚çœäº†â¼€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€ã€‚</p><h2 id="5ã€å¯¹è±¡å†…å­˜åˆ†é…"><a href="#5ã€å¯¹è±¡å†…å­˜åˆ†é…" class="headerlink" title="5ã€å¯¹è±¡å†…å­˜åˆ†é…"></a>5ã€å¯¹è±¡å†…å­˜åˆ†é…</h2><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730164126810.png" alt="image-20210730164126810" style="zoom:50%;" /><p>Javaå†…å­˜ä½“ç³»ä¸­æ‰€æå€¡çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœ€ç»ˆå¯ä»¥å½’ç»“ä¸ºè‡ªåŠ¨åŒ–åœ°è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š<strong>ç»™å¯¹è±¡åˆ†é…å†…å­˜</strong>å’Œ<strong>å›æ”¶åˆ†é…ç»™å¯¹è±¡çš„å†…å­˜</strong>ã€‚</p><p>å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œå¾€å¤§æ–¹å‘è®²ï¼Œå°±æ˜¯åœ¨å †ä¸Šåˆ†é…ï¼Œå¯¹è±¡ä¸»è¦åˆ†é…åœ¨æ–°ç”Ÿä»£çš„EdenåŒºåŸŸï¼Œå¦‚æœå¯åŠ¨äº†æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼Œå°†æŒ‰çº¿ç¨‹ä¼˜å…ˆåˆ†é…åœ¨TLABä¸Šã€‚<code>å°‘æ•°æƒ…å†µä¸‹ä¹Ÿå¯èƒ½ç›´æ¥åˆ†é…åœ¨è€å¹´ä»£ä¸­</code>ã€‚å…·ä½“çš„åˆ†é…è§„åˆ™å–å†³äºåƒåœ¾æ”¶é›†å™¨çš„ç±»å‹ä»¥åŠè™šæ‹Ÿæœºä¸­å‚æ•°çš„é…ç½®ã€‚ä½†æ˜¯æœ‰å‡ æ¡æœ€æ™®éçš„å†…å­˜åˆ†é…è§„åˆ™å¦‚ä¸‹ï¼š</p><h3 id="5-1-å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…"><a href="#5-1-å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…" class="headerlink" title="5.1 å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…"></a>5.1 å¯¹è±¡ä¼˜å…ˆåœ¨Edenåˆ†é…</h3><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£EdenåŒºè¿›è¡Œåˆ†é…ã€‚å½“EdenåŒºæ²¡æœ‰è¶³å¤Ÿå†…å­˜è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†ä¼šå‘èµ·ä¸€æ¬¡Minor GCã€‚</p><h3 id="5-2-å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"><a href="#5-2-å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£" class="headerlink" title="5.2 å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"></a>5.2 å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</h3><p>æ‰€è°“å¤§å¯¹è±¡ï¼Œæ˜¯æŒ‡éœ€è¦å¤§é‡è¿ç»­å­˜å‚¨ç©ºé—´çš„Javaå¯¹è±¡ï¼Œæœ€å…¸å‹çš„å¤§å¯¹è±¡å°±æ˜¯é‚£ç§å¾ˆé•¿çš„å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„ã€‚å¤§å¯¹è±¡å¯¹è™šæ‹Ÿæœºåˆ†é…æ¥è¯´æ˜¯ä¸€ä¸ªåæ¶ˆæ¯ï¼Œç»å¸¸å‡ºç°å¤§å¯¹è±¡ä¼šå¯¼è‡´è™šæ‹Ÿæœºéœ€è¦ç»å¸¸è°ƒç”¨GCæ¥ä¸ºè¿™äº›å¤§å¯¹è±¡æ•´ç†å‡ºè¶³å¤Ÿçš„è¿ç»­ç©ºé—´ã€‚</p><h3 id="5-3é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"><a href="#5-3é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£" class="headerlink" title="5.3é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"></a>5.3é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£</h3><p>æ—¢ç„¶è™šæ‹Ÿæœºé‡‡ç”¨äº†åˆ†ä»£æ”¶é›†çš„æ€æƒ³æ¥ç®¡ç†å†…å­˜ï¼Œé‚£ä¹ˆå†…å­˜å›æ”¶æ—¶å°±å¿…é¡»èƒ½è¯†åˆ«å“ªäº›å¯¹è±¡åº”è¯¥æ”¾åœ¨æ–°ç”Ÿä»£ï¼Œå“ªäº›å¯¹è±¡åº”è¯¥æ”¾åœ¨è€å¹´ä»£ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œè™šæ‹Ÿæœºç»™æ¯ä¸€ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªå¯¹è±¡å¹´é¾„è®¡æ•°å™¨ã€‚å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ä¸”ç»è¿‡äº†ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½å¤Ÿè¢«Survivorå®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¹¶ä¸”å¯¹è±¡å¹´é¾„è®¾ç½®ä¸º1ã€‚å¯¹è±¡åœ¨SurvivoråŒºåŸŸä¸­æ¯ç†¬è¿‡ä¸€æ¬¡Minor GCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º15å²ï¼‰å¯¹è±¡å°†ä¼šè¢«æ™‹èº«åˆ°è€å¹´ä»£ä¸­ã€‚</p><h3 id="5-4-åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"><a href="#5-4-åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š" class="headerlink" title="5.4 åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"></a>5.4 åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š</h3><p>ä¸ºäº†èƒ½å¤Ÿæ›´å¥½çš„é€‚åº”ä¸åŒç¨‹åºçš„å†…å­˜çŠ¶å†µï¼Œè™šæ‹Ÿæœºå¹¶ä¸æ˜¯æ¯æ¬¡éƒ½è¦ç­‰åˆ°å¯¹è±¡çš„å¹´é¾„åˆ°è¾¾é˜ˆå€¼æ‰å°†å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚å¦‚æœåœ¨Survivorç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— éœ€ç­‰å¾…å¹´é¾„å¢é•¿ã€‚</p><h3 id="5-6-ç©ºé—´åˆ†é…æ‹…ä¿"><a href="#5-6-ç©ºé—´åˆ†é…æ‹…ä¿" class="headerlink" title="5.6 ç©ºé—´åˆ†é…æ‹…ä¿"></a>5.6 ç©ºé—´åˆ†é…æ‹…ä¿</h3><p>åœ¨å‘ç”ŸMinor GCä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆæ£€æŸ¥è€å¹´ä»£ä¸­æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡ç©ºé—´ç»¼åˆï¼Œå¦‚æœè¿™ä¸ªæ¡ä»¶æˆç«‹ï¼Œé‚£ä¹ˆMinor GCå¯ä»¥ç¡®ä¿æ˜¯å®‰å…¨çš„ã€‚å¦‚æœä¸æˆç«‹ï¼Œåˆ™è™šæ‹Ÿæœºä¼šæŸ¥çœ‹HandlePromotionFailureè®¾ç½®å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ã€‚å¦‚æœå…è®¸ï¼Œé‚£ä¹ˆä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡çš„å¹³å‡å¤§å°ï¼Œå¦‚æœå¤§äºï¼Œå°†å°è¯•è¿›è¡Œä¸€æ¬¡Minor GCï¼Œå°½ç®¡è¿™æ¬¡GCæ˜¯æœ‰é£é™©çš„ï¼›å¦‚æœå°äºï¼Œæˆ–è€…è®¾ç½®ä¸å…è®¸ï¼Œé‚£è¿™æ—¶å°†æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GCã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-å¯¹è±¡åˆ›å»ºæ–¹å¼&quot;&gt;&lt;a href=&quot;#1-å¯¹è±¡åˆ›å»ºæ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;1.å¯¹è±¡åˆ›å»ºæ–¹å¼&quot;&gt;&lt;/a&gt;1.å¯¹è±¡åˆ›å»ºæ–¹å¼&lt;/h2&gt;&lt;p&gt;Javaä¸­æœ‰ä¸€ä¸‹å‡ ç§æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th</summary>
      
    
    
    
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVM-å†…å­˜ç»“æ„</title>
    <link href="http://example.com/wiki/JVM-%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/"/>
    <id>http://example.com/wiki/JVM-%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/</id>
    <published>2021-07-30T03:53:42.000Z</published>
    <updated>2021-07-30T07:34:46.274Z</updated>
    
    <content type="html"><![CDATA[<p>ä½œä¸ºç¨‹åºå‘˜ï¼Œæœ€å¸¸æ¥è§¦åˆ°Javaè™šæ‹Ÿæœºçš„éƒ¨åˆ†åº”è¯¥æ˜¯å†…å­˜ç»“æ„è¿™ä¸€éƒ¨åˆ†äº†ï¼ŒåŒæ ·è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹å¾ˆå¤šï¼Œé¢è¯•ä¹Ÿæ˜¯æœ€å¸¸è¢«é—®åˆ°çš„ã€‚è™½ç„¶JDKå·²ç»å‘å¸ƒäº†16ç‰ˆæœ¬ï¼Œä½†æ˜¯å›½å†…å¤§éƒ¨åˆ†ä¼ä¸šéƒ½è¿˜åœ¨ä½¿ç”¨JDK8ã€‚ ä»Šå¤©å­¦ä¹ ä¸€ä¸‹è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶æ•°æ®åŒºçš„ç»„æˆå’Œå„ä¸ªç»„ä»¶çš„åŠŸèƒ½ã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730144621195.png" alt="image-20210730144621195" style="zoom:50%;" /><p>JDK8å®˜æ–¹ç½‘ç«™æ–‡æ¡£é“¾æ¥ â€“ ã€‹ <a href="https://docs.oracle.com/javase/8/docs/index.html">JDK</a></p><h1 id="è¿è¡Œæ—¶æ•°æ®åŒº"><a href="#è¿è¡Œæ—¶æ•°æ®åŒº" class="headerlink" title="è¿è¡Œæ—¶æ•°æ®åŒº"></a>è¿è¡Œæ—¶æ•°æ®åŒº</h1><p>Javaè™šæ‹Ÿæœºåœ¨æ‰§è¡ŒJavaç¨‹åºçš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒæ‰€ç®¡ç†çš„å†…å­˜åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªä¸åŒçš„æ•°æ®åŒºåŸŸã€‚è¿™äº›æ•°æ®åŒºåŸŸæœ‰å„è‡ªçš„ç”¨é€”ï¼Œä»¥åŠåˆ›å»ºå’Œé”€æ¯çš„æ—¶é—´ï¼Œæœ‰çš„åŒºåŸŸéšç€è™šæ‹Ÿæœºè¿›ç¨‹çš„å¯åŠ¨è€Œå­˜åœ¨ï¼Œæœ‰äº›åŒºåŸŸåˆ™ä¾èµ–ç”¨æˆ·çš„å¯åŠ¨å’Œç»“æŸè€Œå»ºç«‹å’Œé”€æ¯ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730141548126.png" alt="image-20210730141548126"></p><h2 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h2><p>ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒæ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚åœ¨è™šæ‹Ÿæœºçš„æ¨¡å‹æ¦‚å¿µä¸­ï¼Œå­—èŠ‚ç è§£é‡Šå™¨çš„å·¥ä½œå°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚</p><blockquote><p>å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œä¸€ä¸ª Java æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼›å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯ Native æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨çš„å€¼åˆ™ä¸º (Undefined)ã€‚</p></blockquote><p>ç”±äºJavaè™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢å¤„ç†å™¨æ‰§è¡Œæ—¶é—´çš„æ–¹å¼å®ç°çš„ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨çš„ä¸€ä¸ªæ ¸åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ï¼Œå› æ­¤ï¼Œ<font color=red>ä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½å¤Ÿæ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯ä¸€æ¡çº¿ç¨‹éƒ½éœ€è¦æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„æ¡çº¿ç¨‹ä¹‹é—´çš„è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨</font>ï¼Œè¿™ç±»å†…å­˜åŒºåŸŸç§°ä¸ºâ€œçº¿ç¨‹ç§æœ‰â€çš„å†…å­˜ï¼Œå³å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šæ‹¥æœ‰è‡ªå·±çš„ä¸€å—å†…å­˜åŒºåŸŸã€‚</p><p>ç¨‹åºè®¡æ•°å™¨åœ¨æ‰§è¡Œæœ¬åœ°æ–¹æ³•æ—¶ï¼ˆä¾‹å¦‚è°ƒç”¨Cè¯­è¨€ä»£ç ï¼‰è®¡æ•°å™¨å€¼ä¸ºç©ºï¼Œå…¶ä»–æ—¶å€™åˆ™æ˜¯æŒ‡å‘æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚</p><p>ç¨‹åºè®¡æ•°å™¨æ˜¯åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å”¯ä¸€ä¸€ä¸ªæ²¡æœ‰è§„å®šä»»ä½•OutOfMemoryErroræƒ…å†µçš„åŒºåŸŸï¼Œå› ä¸ºJavaç¨‹åºè®¡æ•°å™¨å®ƒæ‰€éœ€è¦å­˜å‚¨çš„å†…å®¹ä»…ä»…å°±æ˜¯ä¸‹ä¸€ä¸ªéœ€è¦å¾…æ‰§è¡Œçš„å‘½ä»¤çš„åœ°å€ï¼Œå…¶æ‰€éœ€å†…å­˜æ˜¯åˆ›å»ºæ—¶å³å¯åªæ™“çš„ï¼Œä¸éœ€è¦åæœŸè¿›è¡Œæ‰©å®¹ç­‰å…¶ä»–çš„æ“ä½œã€‚</p><h2 id="Javaè™šæ‹Ÿæœºæ ˆ"><a href="#Javaè™šæ‹Ÿæœºæ ˆ" class="headerlink" title="Javaè™šæ‹Ÿæœºæ ˆ"></a>Javaè™šæ‹Ÿæœºæ ˆ</h2><p>Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stacksï¼‰ï¼Œ<font color=red>Javaè™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„,å®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒ</font>ã€‚Javaæ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨<code>å±€éƒ¨å˜é‡è¡¨</code>ã€<code>æ“ä½œæ•°æ ˆ</code>ã€<code>åŠ¨æ€é“¾æ¥</code>ã€<code>æ–¹æ³•å‡ºå£</code>ç­‰ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªæ–¹æ³•ä»è°ƒç”¨ç›´è‡³æ–¹æ³•æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚</p><p>è™šæ‹Ÿæœºæ ˆä¸­å±€éƒ¨å˜é‡è¡¨éƒ¨åˆ†ä¸Javaå¯¹è±¡å†…å­˜åˆ†é…å…³ç³»å¯†åˆ‡ï¼Œå±€éƒ¨å˜é‡è¡¨å­˜æ”¾äº†ç¼–è¯‘å™¨å¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceç±»å‹ï¼Œè¯¥ç±»å‹å¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–å…¶ä»–äºæ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰å’ŒreturnAddressç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚</p><p>å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œ64ä½é•¿åº¦çš„longå’Œdoubleç±»å‹çš„æ•°æ®ä¼šå ç”¨2ä¸ªå±€éƒ¨å˜é‡ç©ºé—´ï¼Œå…¶ä½™çš„æ•°æ®ç±»å‹åªå ç”¨ä¸€ä¸ªã€‚<code>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æœŸé—´å®Œæˆåˆ†é…</code>ï¼Œå½“è¿›å…¥ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨å¸§ä¸­åˆ†é…å¤šå¤§çš„å±€éƒ¨å˜é‡ç©ºé—´æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œåœ¨æ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚</p><p>åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­ï¼Œå¯¹è¿™ä¸ªåŒºåŸŸè§„å®šäº†ä¸¤ç§å¼‚å¸¸çŠ¶å†µï¼š</p><p>å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†æŠ›å‡ºStackOverflowErrorå¼‚å¸¸ï¼›<br>å¦‚æœè™šæ‹Ÿæœºæ ˆå¯ä»¥åŠ¨æ€æ‹“å±•ï¼Œå¦‚æœæ‹“å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°±ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="æœ¬åœ°æ–¹æ³•æ ˆ"></a>æœ¬åœ°æ–¹æ³•æ ˆ</h2><p>æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰ä¸è™šæ‹Ÿæœºæ ˆä½œç”¨ç±»ä¼¼ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒNativeæ–¹æ³•æœåŠ¡ã€‚æœ‰äº›è™šæ‹Ÿæœºä¼šå°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚ä¸è™šæ‹Ÿæœºæ ˆä¸€æ ·ï¼Œæœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šæŠ›å‡ºStackOverflowErroå’ŒOutOfMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="Javaå †"><a href="#Javaå †" class="headerlink" title="Javaå †"></a>Javaå †</h2><p>Javaå †ï¼ˆJava Heapï¼‰ï¼Œå¯¹äºå¤§å¤šæ•°çš„åº”ç”¨æ¥è¯´ï¼ŒJavaå †æ˜¯è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„æœ€å¤§çš„ä¸€å—å†…å­˜ã€‚<code>Javaå †æ˜¯è¢«æ‰€æœ‰çš„çº¿ç¨‹æ‰€å…±äº«çš„ï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»º</code>ã€‚æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åœ¨è¿™é‡Œåˆ†é…å†…å­˜çš„ï¼ˆJavaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°ä¸ºæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹å’Œæ•°ç»„éƒ½è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼‰ã€‚</p><p><strong>Javaå †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸ</strong>ï¼Œå› æ­¤å¾ˆå¤šæ—¶å€™ä¹Ÿè¢«ç§°ä¸ºGCå †ã€‚ä»å†…å­˜å›æ”¶çš„è§’åº¦æ¥çœ‹ï¼Œç”±äºç°åœ¨æ”¶é›†å™¨åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨åˆ†ä»£ç®—æ³•æ”¶é›†å™¨ï¼Œæ‰€ä»¥Javaå †ä¸­è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼›å†ç»†è‡´ä¸€ç‚¹å¯ä»¥åˆ†ä¸ºEdenç©ºé—´ã€From Survivorç©ºé—´ã€To Survivorç©ºé—´ç­‰ã€‚ä»å†…å­˜åˆ†é…çš„è§’åº¦æ¥çœ‹ï¼Œçº¿ç¨‹å…±äº«çš„Javaå †ä¸­å¯èƒ½åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚</p><p>æ ¹æ®Javaè™šæ‹Ÿæœºè§„èŒƒï¼Œ<em><strong>Javaå †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œåªè¦é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„å³å¯</strong></em>ï¼Œåœ¨å®ç°æ—¶æ—¢å¯ä»¥æ˜¯å›ºå®šå¤§å°çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯æ‹“å±•çš„ï¼Œå½“å‰ä¸»æµçš„è™šæ‹Ÿæœºéƒ½æ˜¯æŒ‰ç…§å¯æ‹“å±•æ¥å®ç°çš„ã€‚å¦‚æœåœ¨å †ä¸­æ²¡æœ‰å†…å­˜å®Œæˆå®ä¾‹åˆ†é…ï¼Œå¹¶ä¸”å †ä¹Ÿæ— æ³•å†æ‹“å±•æ—¶ï¼Œå°†ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</p><p>åœ¨ Java ä¸­ï¼Œå †è¢«åˆ’åˆ†æˆä¸¤ä¸ªä¸åŒçš„åŒºåŸŸï¼š<strong>æ–°ç”Ÿä»£ ( Young )<strong>ã€</strong>è€å¹´ä»£ ( Old )<strong>ã€‚</strong>æ–°ç”Ÿä»£ ( Young )</strong> åˆè¢«åˆ’åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼š<strong>Eden</strong>ã€**From Survivor(S0)<strong>ã€</strong>To Survivor(S1)**ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730150932873.png" alt="image-20210730150932873" style="zoom: 30%;" /><p>è¿™æ ·åˆ’åˆ†çš„ç›®çš„æ˜¯ä¸ºäº†ä½¿JVMèƒ½å¤Ÿæ›´å¥½çš„ç®¡ç†å†…å­˜ä¸­çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬å†…å­˜çš„åˆ†é…ä»¥åŠå›æ”¶ã€‚  è€Œæ–°ç”Ÿä»£æŒ‰edenå’Œä¸¤ä¸ªsurvivorçš„åˆ†æ³•ï¼Œæ˜¯ä¸ºäº†</p><ul><li>æœ‰æ•ˆç©ºé—´å¢å¤§ï¼Œeden+1ä¸ªsurvivorï¼›</li><li>æœ‰åˆ©äºå¯¹è±¡ä»£çš„è®¡ç®—ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åœ¨S0/S1ä¸­è¾¾åˆ°è®¾ç½®çš„XX:MaxTenuringThresholdå€¼åï¼Œä¼šå°†å…¶æŒªåˆ°è€å¹´ä»£ä¸­ï¼Œå³åªéœ€æ‰«æå…¶ä¸­ä¸€ä¸ªsurvivorã€‚å¦‚æœæ²¡æœ‰S0/S1,ç›´æ¥åˆ†æˆä¸¤ä¸ªåŒºï¼Œè¯¥å¦‚ä½•è®¡ç®—å¯¹è±¡ç»è¿‡äº†å¤šå°‘æ¬¡GCè¿˜æ²¡è¢«é‡Šæ”¾ã€‚</li><li>ä¸¤ä¸ªSurvivoråŒºå¯è§£å†³å†…å­˜ç¢ç‰‡åŒ–</li></ul><h3 id="å †æ ˆç›¸å…³å‚æ•°"><a href="#å †æ ˆç›¸å…³å‚æ•°" class="headerlink" title="å †æ ˆç›¸å…³å‚æ•°"></a>å †æ ˆç›¸å…³å‚æ•°</h3><table><thead><tr><th><strong>å‚æ•°</strong></th><th><strong>æè¿°</strong></th></tr></thead><tbody><tr><td>-Xms</td><td>å †å†…å­˜åˆå§‹å¤§å°ï¼Œå•ä½mã€g</td></tr><tr><td>-Xmx</td><td>å †å†…å­˜æœ€å¤§å…è®¸å¤§å°ï¼Œä¸€èˆ¬ä¸è¦å¤§äºç‰©ç†å†…å­˜çš„80%</td></tr><tr><td>-Xmn</td><td>å¹´è½»ä»£å†…å­˜åˆå§‹å¤§å°</td></tr><tr><td>-Xss</td><td>æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å°ï¼Œå³JVMæ ˆçš„å¤§å°</td></tr><tr><td>-XX:NewRatio</td><td>å¹´è½»ä»£(åŒ…æ‹¬Edenå’Œä¸¤ä¸ªSurvivoråŒº)ä¸å¹´è€ä»£çš„æ¯”å€¼</td></tr><tr><td>-XX:NewSzie(-Xns)</td><td>å¹´è½»ä»£å†…å­˜åˆå§‹å¤§å°,å¯ä»¥ç¼©å†™-Xns</td></tr><tr><td>-XX:MaxNewSize(-Xmx)</td><td>å¹´è½»ä»£å†…å­˜æœ€å¤§å…è®¸å¤§å°ï¼Œå¯ä»¥ç¼©å†™-Xmx</td></tr><tr><td>-XX:SurvivorRatio</td><td>å¹´è½»ä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„å®¹é‡æ¯”ä¾‹å€¼ï¼Œé»˜è®¤ä¸º8ï¼Œå³8:1</td></tr><tr><td>-XX:MinHeapFreeRatio</td><td>GCåï¼Œå¦‚æœå‘ç°ç©ºé—²å †å†…å­˜å åˆ°æ•´ä¸ªé¢„ä¼°å †å†…å­˜çš„40%ï¼Œåˆ™æ”¾å¤§å †å†…å­˜çš„é¢„ä¼°æœ€å¤§å€¼ï¼Œä½†ä¸è¶…è¿‡å›ºå®šæœ€å¤§å€¼ã€‚</td></tr><tr><td>-XX:MaxHeapFreeRatio</td><td>é¢„ä¼°å †å†…å­˜æ˜¯å †å¤§å°åŠ¨æ€è°ƒæ§çš„é‡è¦é€‰é¡¹ä¹‹ä¸€ã€‚å †å†…å­˜é¢„ä¼°æœ€å¤§å€¼ä¸€å®šå°äºæˆ–ç­‰äºå›ºå®šæœ€å¤§å€¼(-XmxæŒ‡å®šçš„æ•°å€¼)ã€‚å‰è€…ä¼šæ ¹æ®ä½¿ç”¨æƒ…å†µåŠ¨æ€è°ƒå¤§æˆ–ç¼©å°ï¼Œä»¥æé«˜GCå›æ”¶çš„æ•ˆç‡ï¼Œé»˜è®¤70%</td></tr><tr><td>-XX:MaxTenuringThreshold</td><td>åƒåœ¾æœ€å¤§å¹´é¾„ï¼Œè®¾ç½®ä¸º0çš„è¯,åˆ™å¹´è½»ä»£å¯¹è±¡ä¸ç»è¿‡SurvivoråŒº,ç›´æ¥è¿›å…¥å¹´è€ä»£ã€‚å¯¹äºå¹´è€ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨,å¯ä»¥æé«˜æ•ˆç‡.å¦‚æœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼,åˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶,è¿™æ ·å¯ä»¥å¢åŠ å¯¹è±¡å†å¹´è½»ä»£çš„å­˜æ´» æ—¶é—´,å¢åŠ åœ¨å¹´è½»ä»£å³è¢«å›æ”¶çš„æ¦‚ç‡</td></tr><tr><td>-XX:InitialTenuringThreshold</td><td>å¯ä»¥è®¾å®šè€å¹´ä»£é˜€å€¼çš„åˆå§‹å€¼</td></tr><tr><td>-XX:+PrintTenuringDistribution</td><td>æŸ¥çœ‹æ¯æ¬¡minor GCåæ–°çš„å­˜æ´»å‘¨æœŸçš„é˜ˆå€¼</td></tr></tbody></table><blockquote><p><strong>Noteï¼š</strong> æ¯æ¬¡GC åä¼šè°ƒæ•´å †çš„å¤§å°ï¼Œä¸ºäº†<strong>é˜²æ­¢åŠ¨æ€è°ƒæ•´å¸¦æ¥çš„æ€§èƒ½æŸè€—</strong>ï¼Œä¸€èˆ¬è®¾ç½®-<strong>Xmsã€-Xmx ç›¸ç­‰</strong>ã€‚</p></blockquote><p>æ–°ç”Ÿä»£çš„ä¸‰ä¸ªè®¾ç½®å‚æ•°ï¼š-Xmnï¼Œ-XX:NewSizeï¼Œ-XX:NewRatioçš„ä¼˜å…ˆçº§ï¼š<br> ï¼ˆ1ï¼‰.æœ€é«˜ä¼˜å…ˆçº§ï¼š  -XX:NewSize=1024må’Œ-XX:MaxNewSize=1024m<br> ï¼ˆ2ï¼‰.æ¬¡é«˜ä¼˜å…ˆçº§ï¼š  -Xmn1024m  ï¼ˆé»˜è®¤ç­‰æ•ˆæ•ˆæœæ˜¯ï¼š-XX:NewSize==-XX:MaxNewSize==1024mï¼‰<br> ï¼ˆ3ï¼‰.æœ€ä½ä¼˜å…ˆçº§ï¼š-XX:NewRatio=2<br> æ¨èä½¿ç”¨çš„æ˜¯-Xmnå‚æ•°ï¼ŒåŸå› æ˜¯è¿™ä¸ªå‚æ•°å¾ˆç®€æ´ï¼Œç›¸å½“äºä¸€æ¬¡æ€§è®¾å®šNewSizeå’ŒMaxNewSIzeï¼Œè€Œä¸”ä¸¤è€…ç›¸ç­‰ã€‚</p><h2 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h2><p>æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰ä¸Javaå †ä¸€æ ·ï¼Œæ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œ<strong>å®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®</strong>ã€‚<code>ç±»åŠ è½½çš„ä¿¡æ¯å’Œæ•°æ®å°±æ”¾åœ¨æ–¹æ³•åŒºã€‚</code></p><p>Javaè™šæ‹Ÿæœºè§„èŒƒå †æ–¹æ³•åŒºçš„é™åˆ¶éå¸¸å®½æ¾ï¼Œé™¤äº†å’ŒJavaå †ä¸€æ ·ä¸éœ€è¦è¿ç»­çš„å†…å­˜å’Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‹“å±•å¤–ï¼Œè¿˜å¯ä»¥é€‰æ‹©ä¸å®ç°åƒåœ¾æ”¶é›†ã€‚ç›¸å¯¹è€Œè¨€ï¼Œåƒåœ¾æ”¶é›†è¡Œä¸ºåœ¨è¿™ä¸ªåŒºåŸŸæ˜¯æ¯”è¾ƒå°‘å‡ºç°çš„ï¼Œè¿™ä¸ªåŒºåŸŸçš„å†…å­˜å›æ”¶ç›®æ ‡ä¸»è¦æ˜¯é’ˆå¯¹å¸¸é‡æ± çš„å›æ”¶å’Œå¯¹ç±»å‹çš„å¸è½½ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªåŒºåŸŸçš„å†…å­˜å›æ”¶æˆç»©æ¯”è¾ƒä»¤äººéš¾ä»¥æ»¡æ„ï¼Œå°¤å…¶æ—¶ç±»å‹å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ï¼Œä½†æ˜¯è¿™ä¸ªåŒºåŸŸçš„å†…å­˜å›æ”¶ä¹Ÿæ˜¯å¿…è¦çš„ã€‚</p><p>æ ¹æ®Javaè™šæ‹Ÿæœºè§„èŒƒè§„å®šï¼Œå½“æ–¹æ³•åŒºæ— æ³•æ»¡è¶³å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="è¿è¡Œæ—¶å¸¸é‡æ± "><a href="#è¿è¡Œæ—¶å¸¸é‡æ± " class="headerlink" title="è¿è¡Œæ—¶å¸¸é‡æ± "></a>è¿è¡Œæ—¶å¸¸é‡æ± </h2><p>è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼ŒClassæ–‡ä»¶ä¸­é™¤äº†ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯å¸¸é‡æ± ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åè¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å­˜æ”¾ã€‚</p><p>è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦å¤–ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å…·å¤‡åŠ¨æ€æ€§ï¼ŒJavaè¯­è¨€å¹¶ä¸è¦æ±‚å¸¸é‡ä¸€å®šåªæœ‰ç¼–è¯‘å™¨æ‰èƒ½äº§ç”Ÿï¼Œä¹Ÿå°±æ˜¯å¹¶éé¢„ç½®å…¥Classæ–‡ä»¶ä¸­å¸¸é‡æ± çš„å†…å®¹æ‰èƒ½è¿›å…¥æ–¹æ³•åŒºè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œè¿è¡ŒæœŸé—´ä¹Ÿå¯èƒ½å°†æ–°çš„å¸¸é‡æ± æ”¾å…¥æ± ä¸­ï¼Œè¿™ç§ç‰¹æ€§è¢«å¼€å‘äººå‘˜åˆ©ç”¨å¾—æ¯”è¾ƒå¤šçš„ä¾¿æ˜¯Stringç±»çš„intern()æ–¹æ³•ã€‚</p><p>å½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="ç›´æ¥å†…å­˜"><a href="#ç›´æ¥å†…å­˜" class="headerlink" title="ç›´æ¥å†…å­˜"></a>ç›´æ¥å†…å­˜</h2><p>ç›´æ¥å†…å­˜ï¼ˆDirect Memory)å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒæ‰€å®šä¹‰çš„å†…å­˜åŒºåŸŸï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹çš„ä½¿ç”¨ï¼Œè€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´OutOfMemoryErrorå¼‚å¸¸å‡ºç°ã€‚</p><p>åœ¨JDK1.4ä¸­æ–°åŠ å…¥çš„NIOï¼ˆNew Input/Outputï¼‰ç±»ï¼Œå¼•å…¥äº†ä¸€ç§åŸºäºé€šé“ä¸ç¼“å†²åŒºçš„I/Oæ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨Nativeå‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨Javaå †ä¸­çš„DirectByteBufferå¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œï¼Œè¿™æ ·èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†åœ¨Javaå †ä¸­å’ŒNativeå †ä¸­æ¥å›å¤åˆ¶æ•°æ®ã€‚</p><p>ç›´æ¥å†…å­˜è™½ç„¶ä¸ä¼šå—åˆ°Javaå †å¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯å—åˆ°æœ¬æœºæ€»å†…å­˜å¤§å°ä»¥åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ï¼Œå¦‚æœå¿½ç•¥äº†ç›´æ¥å†…å­˜ï¼Œå½“å„ä¸ªåŒºåŸŸå†…å­˜æ€»å’Œå¤§äºæœåŠ¡å™¨å†…å­˜æ—¶ï¼Œå°†ä¼šå¯¼è‡´åŠ¨æ€æ‹“å±•æ—¶å‡ºç°OutOfMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-2.html#jvms-2.5">https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-2.html#jvms-2.5</a></p><p><a href="https://blog.csdn.net/qq_21122519/article/details/94408118">https://blog.csdn.net/qq_21122519/article/details/94408118</a></p><p><a href="https://www.processon.com/view/5ec5d7c60791290fe0768668?fromnew=1">https://www.processon.com/view/5ec5d7c60791290fe0768668?fromnew=1</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä½œä¸ºç¨‹åºå‘˜ï¼Œæœ€å¸¸æ¥è§¦åˆ°Javaè™šæ‹Ÿæœºçš„éƒ¨åˆ†åº”è¯¥æ˜¯å†…å­˜ç»“æ„è¿™ä¸€éƒ¨åˆ†äº†ï¼ŒåŒæ ·è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹å¾ˆå¤šï¼Œé¢è¯•ä¹Ÿæ˜¯æœ€å¸¸è¢«é—®åˆ°çš„ã€‚è™½ç„¶JDKå·²ç»å‘å¸ƒäº†16ç‰ˆæœ¬ï¼Œä½†æ˜¯å›½å†…å¤§éƒ¨åˆ†ä¼ä¸šéƒ½è¿˜åœ¨ä½¿ç”¨JDK8ã€‚ ä»Šå¤©å­¦ä¹ ä¸€ä¸‹è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶æ•°æ®åŒºçš„ç»„æˆå’Œå„ä¸ªç»„ä»¶çš„åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;img src=&quot;ht</summary>
      
    
    
    
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVM-æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</title>
    <link href="http://example.com/wiki/JVM-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    <id>http://example.com/wiki/JVM-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA/</id>
    <published>2021-07-30T02:35:12.000Z</published>
    <updated>2021-08-02T03:49:17.437Z</updated>
    
    <content type="html"><![CDATA[<h2 id="JVMç»“æ„å›¾"><a href="#JVMç»“æ„å›¾" class="headerlink" title="JVMç»“æ„å›¾"></a>JVMç»“æ„å›¾</h2><p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730150029336.png" alt="image-20210730150029336"></p><h2 id="çŸ¥è¯†æ¸…å•"><a href="#çŸ¥è¯†æ¸…å•" class="headerlink" title="çŸ¥è¯†æ¸…å•"></a>çŸ¥è¯†æ¸…å•</h2><ul><li><a href="https://geekibli.github.io/wiki/JVM-%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/">Javaå†…å­˜ç»“æ„</a> </li><li><a href="https://geekibli.github.io/wiki/JVM-%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA/">Javaå¯¹è±¡åˆ›å»º</a></li><li><a href="https://geekibli.github.io/wiki/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">Javaå†…å­˜æ¨¡å‹</a></li><li><a href="https://geekibli.github.io/wiki/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">ç±»åŠ è½½æœºåˆ¶</a></li><li><a href="https://geekibli.github.io/wiki/JVM-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/">åƒåœ¾å›æ”¶æœºåˆ¶</a></li><li><a href="https://geekibli.github.io/wiki/JVM-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/">åƒåœ¾æ”¶é›†å™¨</a></li><li>è™šæ‹Ÿæœºè°ƒä¼˜</li></ul><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><p><a href="https://blog.csdn.net/qq_21122519/article/details/94408118">JAVAè™šæ‹Ÿæœºæ¦‚è¿°</a><br><a href="http://c.biancheng.net/view/3677.html">Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰å·¥ä½œåŸç†</a><br><a href="https://juejin.cn/post/6844903892774289421">æ¨èæ”¶è—ç³»åˆ—ï¼šä¸€æ–‡ç†è§£JVMè™šæ‹Ÿæœºï¼ˆå†…å­˜ã€åƒåœ¾å›æ”¶ã€æ€§èƒ½ä¼˜åŒ–ï¼‰è§£å†³é¢è¯•ä¸­é‡åˆ°é—®é¢˜</a><br><a href="https://juejin.cn/post/6981790758290358302">Javaè™šæ‹Ÿæœºå†…å­˜ç®¡ç†å’Œæ€§èƒ½è°ƒä¼˜</a><br><a href="https://juejin.cn/post/6844903494063751175">é‡è¯» JVM</a><br><a href="https://juejin.cn/post/6986594521752535053">ã€2021æœ€æ–°ç‰ˆã€‘JVMé¢è¯•é¢˜æ€»ç»“ï¼ˆ87é“é¢˜å«ç­”æ¡ˆè§£æï¼‰</a><br><a href="https://www.pdai.tech/md/java/jvm/java-jvm-classload.html">JVM åŸºç¡€ - Java ç±»åŠ è½½æœºåˆ¶</a><br><a href="https://juejin.cn/post/6981643053396131853">JVMçŸ¥è¯†ç‚¹æ•´ç†</a><br><a href="https://www.processon.com/view/5ec5d7c60791290fe0768668?fromnew=1">https://www.processon.com/view/5ec5d7c60791290fe0768668?fromnew=1</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;JVMç»“æ„å›¾&quot;&gt;&lt;a href=&quot;#JVMç»“æ„å›¾&quot; class=&quot;headerlink&quot; title=&quot;JVMç»“æ„å›¾&quot;&gt;&lt;/a&gt;JVMç»“æ„å›¾&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://cdn.jsdelivr.net/gh/code-xiaozhuang/</summary>
      
    
    
    
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹-æ·±å…¥ç†è§£volatile</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3volatile/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3volatile/</id>
    <published>2021-07-29T08:25:05.000Z</published>
    <updated>2021-07-29T12:27:03.344Z</updated>
    
    <content type="html"><![CDATA[<h1 id="volatileç‰¹æ€§"><a href="#volatileç‰¹æ€§" class="headerlink" title="volatileç‰¹æ€§"></a>volatileç‰¹æ€§</h1><p>æ­£ç¡®ç†è§£volatile</p><blockquote><p>å¤šçº§cacheç»“æ„ -&gt; ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰-&gt; store bufferå’Œinvalidate queue -&gt; å†…å­˜å±éšœ</p></blockquote><h2 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h2><p>volatileçš„å¯è§æ€§ä¾èµ–äºJavaå†…å­˜æ¨¡å‹ã€‚ å¯ä»¥å‚è§ä¹‹å‰çš„æ–‡ç«   ğŸ‘‰ <a href="https://geekibli.github.io/wiki/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">Javaå†…å­˜æ¨¡å‹</a></p><p><code>Javaå†…å­˜æ¨¡å‹(JavaMemoryModel)</code>æè¿°äº†Javaç¨‹åºä¸­å„ç§å˜é‡(çº¿ç¨‹å…±äº«å˜é‡)çš„è®¿é—®è§„åˆ™ï¼Œä»¥åŠåœ¨JVMä¸­å°†å˜é‡ï¼Œå­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­è¯»å–å˜é‡è¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚</p><p>æ‰€æœ‰çš„å…±äº«å˜é‡éƒ½å­˜å‚¨äºä¸»å†…å­˜ï¼Œè¿™é‡Œæ‰€è¯´çš„å˜é‡æŒ‡çš„æ˜¯å®ä¾‹å˜é‡å’Œç±»å˜é‡ï¼Œä¸åŒ…å«å±€éƒ¨å˜é‡ï¼Œå› ä¸ºå±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå› æ­¤ä¸å­˜åœ¨ç«äº‰é—®é¢˜ã€‚</p><p>æ¯ä¸€ä¸ªçº¿ç¨‹è¿˜å­˜åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜ï¼Œä¿ç•™äº†è¢«çº¿ç¨‹ä½¿ç”¨çš„å˜é‡çš„å·¥ä½œå‰¯æœ¬ã€‚</p><p><code>çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰çš„æ“ä½œ(è¯»ï¼Œå–)éƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­å®Œæˆï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡</code>ã€‚</p><p>ä¸åŒçº¿ç¨‹ä¹‹é—´ä¹Ÿä¸èƒ½ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é—´å˜é‡çš„å€¼çš„ä¼ é€’éœ€è¦é€šè¿‡ä¸»å†…å­˜ä¸­è½¬æ¥å®Œæˆã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210729170756502.png" alt="image-20210729170756502" style="zoom:35%;" /><p>volatileå®ç°å¯è§æ€§</p><p>æ¯ä¸ªçº¿ç¨‹æ“ä½œæ•°æ®çš„æ—¶å€™ä¼šæŠŠæ•°æ®ä»ä¸»å†…å­˜è¯»å–åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå¦‚æœä»–æ“ä½œäº†æ•°æ®å¹¶ä¸”å†™ä¼šäº†ï¼Œä»–å…¶ä»–å·²ç»è¯»å–çš„çº¿ç¨‹çš„å˜é‡å‰¯æœ¬å°±ä¼šå¤±æ•ˆäº†ï¼Œéœ€è¦éƒ½æ•°æ®è¿›è¡Œæ“ä½œåˆè¦å†æ¬¡å»ä¸»å†…å­˜ä¸­è¯»å–äº†ã€‚</p><p>volatileä¿è¯ä¸åŒçº¿ç¨‹å¯¹å…±äº«å˜é‡æ“ä½œçš„å¯è§æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†volatileä¿®é¥°çš„å˜é‡ï¼Œå½“ä¿®æ”¹å†™å›ä¸»å†…å­˜æ—¶ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹ç«‹å³çœ‹åˆ°æœ€æ–°çš„å€¼ã€‚</p><p>è‡³äºå…¶ä»–çº¿ç¨‹æ˜¯å¦‚ä½•æ›´æ–°ç¼“å­˜è¡Œä¸­çš„æ•°æ®ä»¥åŠå…¶ä»–çº¿ç¨‹çš„ç¼“å­˜è¡Œæ˜¯å¦‚ä½•å¤±æ•ˆçš„ï¼Œå¯ä»¥å‚è§ä¹‹å‰çš„æ–‡ç« ã€‚ <a href="https://geekibli.github.io/wiki/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">Javaå†…å­˜æ¨¡å‹</a></p><h3 id="å—…æ¢æœºåˆ¶"><a href="#å—…æ¢æœºåˆ¶" class="headerlink" title="å—…æ¢æœºåˆ¶"></a>å—…æ¢æœºåˆ¶</h3><p>åœ¨ç°ä»£è®¡ç®—æœºä¸­ï¼ŒCPU çš„é€Ÿåº¦æ˜¯æé«˜çš„ï¼Œå¦‚æœ CPU éœ€è¦å­˜å–æ•°æ®æ—¶éƒ½ç›´æ¥ä¸å†…å­˜æ‰“äº¤é“ï¼Œåœ¨å­˜å–è¿‡ç¨‹ä¸­ï¼ŒCPU å°†ä¸€ç›´ç©ºé—²ï¼Œè¿™æ˜¯ä¸€ç§æå¤§çš„æµªè´¹ï¼Œæ‰€ä»¥ï¼Œä¸ºäº†æé«˜å¤„ç†é€Ÿåº¦ï¼ŒCPU ä¸ç›´æ¥å’Œå†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯åœ¨ CPU ä¸å†…å­˜ä¹‹é—´åŠ å…¥å¾ˆå¤šå¯„å­˜å™¨ï¼Œå¤šçº§ç¼“å­˜ï¼Œå®ƒä»¬æ¯”å†…å­˜çš„å­˜å–é€Ÿåº¦é«˜å¾—å¤šï¼Œè¿™æ ·å°±è§£å†³äº† CPU è¿ç®—é€Ÿåº¦å’Œå†…å­˜è¯»å–é€Ÿåº¦ä¸ä¸€è‡´é—®é¢˜ã€‚</p><p>ç”±äº CPU ä¸å†…å­˜ä¹‹é—´åŠ å…¥äº†ç¼“å­˜ï¼Œåœ¨è¿›è¡Œæ•°æ®æ“ä½œæ—¶ï¼Œå…ˆå°†æ•°æ®ä»å†…å­˜æ‹·è´åˆ°ç¼“å­˜ä¸­ï¼ŒCPU ç›´æ¥æ“ä½œçš„æ˜¯ç¼“å­˜ä¸­çš„æ•°æ®ã€‚ä½†åœ¨å¤šå¤„ç†å™¨ä¸‹ï¼Œå°†å¯èƒ½å¯¼è‡´å„è‡ªçš„ç¼“å­˜æ•°æ®ä¸ä¸€è‡´ï¼ˆè¿™ä¹Ÿæ˜¯å¯è§æ€§é—®é¢˜çš„ç”±æ¥ï¼‰ï¼Œä¸ºäº†ä¿è¯å„ä¸ªå¤„ç†å™¨çš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¼šå®ç°ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œè€Œ<strong>å—…æ¢æ˜¯å®ç°ç¼“å­˜ä¸€è‡´æ€§çš„å¸¸è§æœºåˆ¶</strong>ã€‚</p><p><strong>å—…æ¢æœºåˆ¶å·¥ä½œåŸç†</strong>ï¼šæ¯ä¸ªå¤„ç†å™¨é€šè¿‡ç›‘å¬åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±çš„ç¼“å­˜å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå¦‚æœå¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­æŠŠæ•°æ®è¯»åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­ã€‚</p><p>æ³¨æ„ï¼š</p><blockquote><p>åŸºäº CPU ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ŒJVM å®ç°äº† volatile çš„å¯è§æ€§ï¼Œä½†ç”±äºæ€»çº¿å—…æ¢æœºåˆ¶ï¼Œä¼šä¸æ–­çš„ç›‘å¬æ€»çº¿ï¼Œå¦‚æœå¤§é‡ä½¿ç”¨ volatile ä¼šå¼•èµ·æ€»çº¿é£æš´ã€‚æ‰€ä»¥ï¼Œvolatile çš„ä½¿ç”¨è¦é€‚åˆå…·ä½“åœºæ™¯ã€‚</p></blockquote><h2 id="é‡æ’åº"><a href="#é‡æ’åº" class="headerlink" title="é‡æ’åº"></a>é‡æ’åº</h2><p><strong>ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åº</strong>?</p><p>ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æ—¢å®šçš„ä»£ç æ‰§è¡Œé¡ºåºè¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚</p><p>ã€æºä»£ç ã€‘ -&gt; ã€ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’åºã€‘-&gt; ã€æŒ‡ä»¤é›†å¹¶è¡Œé‡æ’åºã€‘-&gt; ã€å†…å­˜ç³»ç»Ÿé‡æ’åºã€‘-&gt; ã€æœ€ç»ˆæ‰§è¡ŒæŒ‡ä»¤åºåˆ—ã€‘</p><p>ä¸€èˆ¬é‡æ’åºå¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š</p><ul><li>ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåº;</li><li>æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåº;</li><li>å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯»/å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œçš„ã€‚</li></ul><h3 id="as-if-serialè¯­ä¹‰"><a href="#as-if-serialè¯­ä¹‰" class="headerlink" title="as-if-serialè¯­ä¹‰"></a>as-if-serialè¯­ä¹‰</h3><p>ä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹ä¸‹çš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ã€‚ç¼–è¯‘å™¨ã€runtimeå’Œå¤„ç†å™¨éƒ½å¿…é¡»éµå®ˆas-if-serialè¯­ä¹‰ã€‚</p><p>javaç¼–è¯‘å™¨ä¼šåœ¨ç”ŸæˆæŒ‡ä»¤ç³»åˆ—æ—¶åœ¨é€‚å½“çš„ä½ç½®ä¼šæ’å…¥<code>å†…å­˜å±éšœ</code>æŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p><p>ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼ŒJMMä¼šé™åˆ¶ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºï¼ŒJMMä¼šé’ˆå¯¹ç¼–è¯‘å™¨åˆ¶å®švolatileé‡æ’åºè§„åˆ™è¡¨ï¼š</p><table><thead><tr><th align="center"><strong>å†…å­˜å±éšœ</strong></th><th align="left"><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td align="center">StoreStore å±éšœ</td><td align="left">ç¦æ­¢ä¸Šé¢çš„æ™®é€šå†™å’Œä¸‹é¢çš„ volatile å†™é‡æ’åºã€‚</td></tr><tr><td align="center">StoreLoad å±éšœ</td><td align="left">é˜²æ­¢ä¸Šé¢çš„ volatile å†™ä¸ä¸‹é¢å¯èƒ½æœ‰çš„ volatile è¯»/å†™é‡æ’åºã€‚</td></tr><tr><td align="center">LoadLoad å±éšœ</td><td align="left">ç¦æ­¢ä¸‹é¢æ‰€æœ‰çš„æ™®é€šè¯»æ“ä½œå’Œä¸Šé¢çš„ volatile è¯»é‡æ’åºã€‚</td></tr><tr><td align="center">LoadStore å±éšœ</td><td align="left">ç¦æ­¢ä¸‹é¢æ‰€æœ‰çš„æ™®é€šå†™æ“ä½œå’Œä¸Šé¢çš„ volatile è¯»é‡æ’åºã€‚</td></tr></tbody></table><h3 id="happens-beforeè§„åˆ™"><a href="#happens-beforeè§„åˆ™" class="headerlink" title="happens-beforeè§„åˆ™"></a>happens-beforeè§„åˆ™</h3><p>å¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»å­˜åœ¨happens-beforeå…³ç³»ã€‚</p><p><strong>volatileåŸŸè§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™æ“ä½œï¼Œhappens-beforeäºä»»æ„çº¿ç¨‹åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚</strong></p><h3 id="volatileåœ¨DCLçš„åº”ç”¨"><a href="#volatileåœ¨DCLçš„åº”ç”¨" class="headerlink" title="volatileåœ¨DCLçš„åº”ç”¨"></a>volatileåœ¨DCLçš„åº”ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton singleton;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ å‡½æ•°ç§æœ‰ï¼Œç¦æ­¢å¤–éƒ¨å®ä¾‹åŒ–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    singleton = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åœ¨å˜é‡singletonä¹‹é—´åŠ ä¸Švolatileå…³é”®å­—ã€‚è¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œå…ˆè¦äº†è§£å¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å…¶å®å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆ†é…å†…å­˜ç©ºé—´ã€‚</li><li>åˆå§‹åŒ–å¯¹è±¡ã€‚</li><li>å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚</li></ul><p>ä½†æ˜¯ç”±äºæ“ä½œç³»ç»Ÿå¯ä»¥<code>å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åº</code>ï¼Œæ‰€ä»¥ä¸Šé¢çš„è¿‡ç¨‹ä¹Ÿå¯èƒ½ä¼šå˜æˆå¦‚ä¸‹è¿‡ç¨‹ï¼š</p><ul><li>åˆ†é…å†…å­˜ç©ºé—´ã€‚</li><li>å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚</li><li>åˆå§‹åŒ–å¯¹è±¡</li></ul><p>å¦‚æœæ˜¯è¿™ä¸ªæµç¨‹ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å°±å¯èƒ½å°†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å¯¹è±¡å¼•ç”¨æš´éœ²å‡ºæ¥ï¼Œä»è€Œå¯¼è‡´ä¸å¯é¢„æ–™çš„ç»“æœã€‚å› æ­¤ï¼Œä¸ºäº†é˜²æ­¢è¿™ä¸ªè¿‡ç¨‹çš„é‡æ’åºï¼Œæˆ‘ä»¬éœ€è¦å°†å˜é‡è®¾ç½®ä¸ºvolatileç±»å‹çš„å˜é‡ã€‚</p><h3 id="ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ"><a href="#ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ" class="headerlink" title="ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ"></a>ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundFloobleLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> Flooble theFlooble;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initInBackground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do lots of stuff</span></span><br><span class="line">        theFlooble = <span class="keyword">new</span> Flooble();  <span class="comment">// this is the only write to theFlooble</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeOtherClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123; </span><br><span class="line">            <span class="comment">// do some stuff...</span></span><br><span class="line">            <span class="comment">// use the Flooble, but only if it is ready</span></span><br><span class="line">            <span class="keyword">if</span> (floobleLoader.theFlooble != <span class="keyword">null</span>) </span><br><span class="line">                doSomething(floobleLoader.theFlooble);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>theFlooble</code> å¼•ç”¨ä¸æ˜¯ volatile ç±»å‹ï¼Œ<code>doWork()</code> ä¸­çš„ä»£ç åœ¨è§£é™¤å¯¹ <code>theFlooble</code> çš„å¼•ç”¨æ—¶ï¼Œå°†ä¼šå¾—åˆ°ä¸€ä¸ªä¸å®Œå…¨æ„é€ çš„ <code>Flooble</code>ã€‚</p><p>è¯¥æ¨¡å¼çš„ä¸€ä¸ªå¿…è¦æ¡ä»¶æ˜¯ï¼šè¢«å‘å¸ƒçš„å¯¹è±¡å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ–è€…æ˜¯æœ‰æ•ˆçš„ä¸å¯å˜å¯¹è±¡ï¼ˆæœ‰æ•ˆä¸å¯å˜æ„å‘³ç€å¯¹è±¡çš„çŠ¶æ€åœ¨å‘å¸ƒä¹‹åæ°¸è¿œä¸ä¼šè¢«ä¿®æ”¹ï¼‰ã€‚volatile ç±»å‹çš„å¼•ç”¨å¯ä»¥ç¡®ä¿å¯¹è±¡çš„å‘å¸ƒå½¢å¼çš„å¯è§æ€§ï¼Œä½†æ˜¯å¦‚æœå¯¹è±¡çš„çŠ¶æ€åœ¨å‘å¸ƒåå°†å‘ç”Ÿæ›´æ”¹ï¼Œé‚£ä¹ˆå°±éœ€è¦é¢å¤–çš„åŒæ­¥ã€‚</p><h2 id="æ— æ³•ä¿è¯åŸå­æ€§"><a href="#æ— æ³•ä¿è¯åŸå­æ€§" class="headerlink" title="æ— æ³•ä¿è¯åŸå­æ€§"></a>æ— æ³•ä¿è¯åŸå­æ€§</h2><p>æ‰€è°“çš„åŸå­æ€§æ˜¯æŒ‡åœ¨ä¸€æ¬¡æ“ä½œæˆ–è€…å¤šæ¬¡æ“ä½œä¸­ï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œå…¨éƒ¨éƒ½å¾—åˆ°äº†æ‰§è¡Œå¹¶ä¸”ä¸ä¼šå—åˆ°ä»»ä½•å› ç´ çš„å¹²æ‰°è€Œä¸­æ–­ï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œéƒ½ä¸æ‰§è¡Œã€‚</p><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œvolatile å…³é”®å­—å¯ä»¥ä¿è¯å…±äº«æ•°æ®çš„å¯è§æ€§ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯å¯¹æ•°æ®æ“ä½œçš„åŸå­æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ volatile ä¿®é¥°çš„å˜é‡æ˜¯<strong>çº¿ç¨‹ä¸å®‰å…¨çš„</strong>ã€‚</p><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é”æœºåˆ¶ï¼Œæˆ–è€…ä½¿ç”¨åŸå­ç±»ï¼ˆå¦‚ AtomicIntegerï¼‰ã€‚</p><p>è¿™é‡Œç‰¹åˆ«è¯´ä¸€ä¸‹ï¼Œå¯¹ä»»æ„å•ä¸ªä½¿ç”¨ volatile ä¿®é¥°çš„å˜é‡çš„è¯» / å†™æ˜¯å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äº <code>flag = !flag</code> è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚ç®€å•åœ°è¯´å°±æ˜¯ï¼Œ<strong>å•çº¯çš„èµ‹å€¼æ“ä½œæ˜¯åŸå­æ€§çš„</strong>ã€‚</p><h1 id="volatile-å’Œ-synchronized"><a href="#volatile-å’Œ-synchronized" class="headerlink" title="volatile å’Œ synchronized"></a>volatile å’Œ synchronized</h1><p>volatileåªèƒ½ä¿®é¥°å®ä¾‹å˜é‡å’Œç±»å˜é‡ï¼Œè€Œsynchronizedå¯ä»¥ä¿®é¥°æ–¹æ³•ï¼Œä»¥åŠä»£ç å—ã€‚</p><p>volatileä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†æ˜¯ä¸ä¿è¯åŸå­æ€§(å¤šçº¿ç¨‹è¿›è¡Œå†™æ“ä½œï¼Œä¸ä¿è¯çº¿ç¨‹å®‰å…¨);è€Œsynchronizedæ˜¯ä¸€ç§æ’ä»–(äº’æ–¥)çš„æœºåˆ¶ã€‚</p><p>volatileç”¨äºç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼šå¯ä»¥è§£å†³å•ä¾‹åŒé‡æ£€æŸ¥å¯¹è±¡åˆå§‹åŒ–ä»£ç æ‰§è¡Œä¹±åºé—®é¢˜ã€‚</p><p>volatileå¯ä»¥çœ‹åšæ˜¯è½»é‡ç‰ˆçš„synchronizedï¼Œvolatileä¸ä¿è¯åŸå­æ€§ï¼Œä½†æ˜¯å¦‚æœæ˜¯å¯¹ä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œå¤šä¸ªçº¿ç¨‹çš„èµ‹å€¼ï¼Œè€Œæ²¡æœ‰å…¶ä»–çš„æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨volatileæ¥ä»£æ›¿synchronizedï¼Œå› ä¸ºèµ‹å€¼æœ¬èº«æ˜¯æœ‰åŸå­æ€§çš„ï¼Œè€Œvolatileåˆä¿è¯äº†å¯è§æ€§ï¼Œæ‰€ä»¥å°±å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨äº†ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>1ã€volatileä¿®é¥°ç¬¦é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼šæŸä¸ªå±æ€§è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æ­¤å±æ€§ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³å¾—åˆ°ä¿®æ”¹åçš„å€¼ï¼Œæ¯”å¦‚booleanflag;æˆ–è€…ä½œä¸ºè§¦å‘å™¨ï¼Œå®ç°è½»é‡çº§åŒæ­¥ã€‚</p><p>2ã€volatileå±æ€§çš„è¯»å†™æ“ä½œéƒ½æ˜¯æ— é”çš„ï¼Œå®ƒä¸èƒ½æ›¿ä»£synchronizedï¼Œå› ä¸ºå®ƒæ²¡æœ‰æä¾›<strong>åŸå­æ€§å’Œäº’æ–¥æ€§</strong>ã€‚å› ä¸ºæ— é”ï¼Œä¸éœ€è¦èŠ±è´¹æ—¶é—´åœ¨è·å–é”å’Œé‡Šæ”¾é”_ä¸Šï¼Œæ‰€ä»¥è¯´å®ƒæ˜¯ä½æˆæœ¬çš„ã€‚</p><p>3ã€volatileåªèƒ½ä½œç”¨äºå±æ€§ï¼Œæˆ‘ä»¬ç”¨volatileä¿®é¥°å±æ€§ï¼Œè¿™æ ·compilerså°±ä¸ä¼šå¯¹è¿™ä¸ªå±æ€§åšæŒ‡ä»¤é‡æ’åºã€‚</p><p>4ã€volatileæä¾›äº†å¯è§æ€§ï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹å¯¹å…¶çš„ä¿®æ”¹å°†ç«‹é©¬å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œvolatileå±æ€§ä¸ä¼šè¢«çº¿ç¨‹ç¼“å­˜ï¼Œå§‹ç»ˆä»ä¸» å­˜ä¸­è¯»å–ã€‚</p><p>5ã€volatileæä¾›äº†happens-beforeä¿è¯ï¼Œå¯¹volatileå˜é‡vçš„å†™å…¥happens-beforeæ‰€æœ‰å…¶ä»–çº¿ç¨‹åç»­å¯¹vçš„è¯»æ“ä½œã€‚</p><p>6ã€volatileå¯ä»¥ä½¿å¾—longå’Œdoubleçš„èµ‹å€¼æ˜¯åŸå­çš„ã€‚</p><p>7ã€volatileå¯ä»¥åœ¨å•ä¾‹åŒé‡æ£€æŸ¥ä¸­å®ç°å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Œä»è€Œä¿è¯å®‰å…¨æ€§ã€‚</p><hr><p><strong>å‚è€ƒèµ„æ–™</strong></p><p><a href="https://mp.weixin.qq.com/s/Oa3tcfAFO9IgsbE22C5TEg">é¢è¯•å®˜æƒ³åˆ°ï¼Œä¸€ä¸ªVolatileï¼Œæ•–ä¸™éƒ½èƒ½å¹åŠå°æ—¶</a></p><p><a href="https://juejin.cn/post/6844903520760496141">é¢è¯•å®˜æœ€çˆ±çš„volatileå…³é”®å­—</a></p><p><a href="https://juejin.cn/post/6844903959107207175">ä¸€æ–‡åƒé€Volatileï¼Œå¾æœé¢è¯•å®˜</a></p><p><a href="https://www.cnblogs.com/lidl/archive/2012/06/25/2561431.html">javaè¯­è¨€çš„çº¿ç¨‹å®‰å…¨volatileç”¨æ³•</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;volatileç‰¹æ€§&quot;&gt;&lt;a href=&quot;#volatileç‰¹æ€§&quot; class=&quot;headerlink&quot; title=&quot;volatileç‰¹æ€§&quot;&gt;&lt;/a&gt;volatileç‰¹æ€§&lt;/h1&gt;&lt;p&gt;æ­£ç¡®ç†è§£volatile&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¤šçº§cac</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Java-synchronizedå…³é”®å­—å‰–æ</title>
    <link href="http://example.com/wiki/Java-synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E5%89%96%E6%9E%90/"/>
    <id>http://example.com/wiki/Java-synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E5%89%96%E6%9E%90/</id>
    <published>2021-07-29T05:37:27.000Z</published>
    <updated>2021-07-29T07:56:57.965Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡å…³äºsynchronizedå…³é”®å­—çš„æ–‡ç« ï¼Œæ˜¯å½“æ—¶å¬é©¬å£«å…µè€å¸ˆçš„å…¬å¼€è¯¾æ—¶è®°å½•çš„ä¸€äº›å…³é”®ç¬”è®°ğŸ“’ <a href="https://geekibli.github.io/wiki/Java-synchronzied%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">é“¾æ¥ğŸ”—</a></p><p>ä¸‹é¢æˆ‘ä»¬è¿˜æ˜¯è¦å­¦ä¹ å’Œæ€»ç»“ä¸€ä¸‹synchronized</p><h2 id="synchronized-ç‰¹æ€§"><a href="#synchronized-ç‰¹æ€§" class="headerlink" title="synchronized ç‰¹æ€§"></a>synchronized ç‰¹æ€§</h2><ul><li>æœ‰åºæ€§<br><code>as-if-serial</code></li></ul><p>ä¸ç®¡ç¼–è¯‘å™¨å’ŒCPUå¦‚ä½•é‡æ’åºï¼Œå¿…é¡»ä¿è¯åœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ç¨‹åºçš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œè¿˜æœ‰å°±æ˜¯æœ‰æ•°æ®ä¾èµ–çš„ä¹Ÿæ˜¯ä¸èƒ½é‡æ’åºçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> b = a;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤æ®µæ˜¯æ€ä¹ˆéƒ½ä¸èƒ½é‡æ’åºçš„ï¼Œbçš„å€¼ä¾èµ–açš„å€¼ï¼Œaå¦‚æœä¸å…ˆèµ‹å€¼ï¼Œé‚£å°±ä¸ºç©ºäº†ã€‚</p><ul><li>å¯è§æ€§<br>ä¸»è¦ä¾é Javaå†…å­˜æ¨¡å‹å®ç°</li><li>åŸå­æ€§<br>é€šè¿‡æ±‡ç¼–æŒ‡ä»¤æ§åˆ¶</li><li>å¯é‡å…¥<br>synchronizedé”å¯¹è±¡çš„æ—¶å€™æœ‰ä¸ªè®¡æ•°å™¨ï¼Œä»–ä¼šè®°å½•ä¸‹çº¿ç¨‹è·å–é”çš„æ¬¡æ•°ï¼Œåœ¨æ‰§è¡Œå®Œå¯¹åº”çš„ä»£ç å—ä¹‹åï¼Œè®¡æ•°å™¨å°±ä¼š-1ï¼Œç›´åˆ°è®¡æ•°å™¨æ¸…é›¶ï¼Œå°±é‡Šæ”¾é”äº†</li><li>ä¸å¯ä¸­æ–­<br>ä¸å¯ä¸­æ–­å°±æ˜¯æŒ‡ï¼Œä¸€ä¸ªçº¿ç¨‹è·å–é”ä¹‹åï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å¤„äºé˜»å¡æˆ–è€…ç­‰å¾…çŠ¶æ€ï¼Œå‰ä¸€ä¸ªä¸é‡Šæ”¾ï¼Œåä¸€ä¸ªä¹Ÿä¸€ç›´ä¼šé˜»å¡æˆ–è€…ç­‰å¾…ï¼Œä¸å¯ä»¥è¢«ä¸­æ–­ã€‚<br>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒLockçš„tryLockæ–¹æ³•æ˜¯å¯ä»¥è¢«ä¸­æ–­çš„ã€‚</li></ul><h2 id="äº†è§£å¯¹è±¡å¤´"><a href="#äº†è§£å¯¹è±¡å¤´" class="headerlink" title="äº†è§£å¯¹è±¡å¤´"></a>äº†è§£å¯¹è±¡å¤´</h2><p><strong>Mark Word</strong>ï¼šé»˜è®¤å­˜å‚¨å¯¹è±¡çš„HashCodeï¼Œåˆ†ä»£å¹´é¾„å’Œé”æ ‡å¿—ä½ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯éƒ½æ˜¯ä¸å¯¹è±¡è‡ªèº«å®šä¹‰æ— å…³çš„æ•°æ®ï¼Œæ‰€ä»¥Mark Wordè¢«è®¾è®¡æˆä¸€ä¸ªéå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å­˜å‚¨å°½é‡å¤šçš„æ•°æ®ã€‚å®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿è¡ŒæœŸé—´Mark Wordé‡Œå­˜å‚¨çš„æ•°æ®ä¼šéšç€é”æ ‡å¿—ä½çš„å˜åŒ–è€Œå˜åŒ–ã€‚</p><p><strong>åœ¨64ä½çš„è™šæ‹Ÿæœºä¸­ï¼š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210729145750638.png" alt="image-20210729145750638"></p><p><strong>32ä½è™šæ‹Ÿæœºä¸­ï¼š</strong></p><p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210729145831606.png" alt="image-20210729145831606"></p><p><strong>å¯ä»¥å‚è§ä¹‹å‰çš„æ–‡ç« </strong>  ğŸ‘‰  <a href="https://geekibli.github.io/wiki/Java%E5%AF%B9%E8%B1%A1%E5%A4%B4/">Javaå¯¹è±¡å¤´</a></p><h2 id="synchronizedå®ç°"><a href="#synchronizedå®ç°" class="headerlink" title="synchronizedå®ç°"></a>synchronizedå®ç°</h2><p>ä¹‹å‰çš„æ–‡ç« å·²ç»åœ¨ <code>Javaä»£ç </code>ã€<code>å­—èŠ‚ç </code>ã€<code>JVMçº§åˆ«</code>å’Œ<code>æ±‡ç¼–æŒ‡ä»¤</code>å››ä¸ªçº§åˆ«ä»‹ç»äº†synchronziedçš„å®ç°ã€‚<br>JDKå¯¹synchronziedä¸æ–­çš„ä¼˜åŒ–ï¼Œå¤§å®¶ç†Ÿæ‚‰çš„é”å‡çº§è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯åœ¨æºç é‡Œé¢ï¼Œè°ƒç”¨äº†ä¸åŒçš„å®ç°å»è·å–è·å–é”ï¼Œå¤±è´¥å°±è°ƒç”¨æ›´é«˜çº§çš„å®ç°ï¼Œæœ€åå‡çº§å®Œæˆã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210729144552761.png" alt="image-20210729144552761"></p><p>å‡çº§æ–¹å‘ï¼šã€ æ— é” ã€‘ -&gt; ã€ åå‘é” ã€‘-&gt; ã€ è½»é‡çº§é” ã€‘-&gt; ã€ é‡é‡çº§é” ã€‘</p><p>Tipï¼š<font color=red>åˆ‡è®°è¿™ä¸ªå‡çº§è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„</font>ï¼›</p><h3 id="æ— é”"><a href="#æ— é”" class="headerlink" title="æ— é”"></a>æ— é”</h3><p>æ— é”æ˜¯æŒ‡æ²¡æœ‰å¯¹èµ„æºè¿›è¡Œé”å®šï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½èƒ½è®¿é—®å¹¶ä¿®æ”¹åŒä¸€ä¸ªèµ„æºï¼Œä½†åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹æˆåŠŸã€‚</p><p>æ— é”çš„ç‰¹ç‚¹æ˜¯ä¿®æ”¹æ“ä½œä¼šåœ¨å¾ªç¯å†…è¿›è¡Œï¼Œçº¿ç¨‹ä¼šä¸æ–­çš„å°è¯•ä¿®æ”¹å…±äº«èµ„æºã€‚å¦‚æœæ²¡æœ‰å†²çªå°±ä¿®æ”¹æˆåŠŸå¹¶é€€å‡ºï¼Œå¦åˆ™å°±ä¼šç»§ç»­å¾ªç¯å°è¯•ã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹ä¿®æ”¹åŒä¸€ä¸ªå€¼ï¼Œå¿…å®šä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹æˆåŠŸï¼Œè€Œå…¶ä»–ä¿®æ”¹å¤±è´¥çš„çº¿ç¨‹ä¼šä¸æ–­é‡è¯•ç›´åˆ°ä¿®æ”¹æˆåŠŸã€‚</p><h3 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h3><p>å¯¹è±¡å¤´æ˜¯ç”± Mark Word å’Œ Class pointer ç»„æˆï¼Œé”äº‰å¤ºä¹Ÿå°±æ˜¯å¯¹è±¡å¤´æŒ‡å‘çš„Monitorå¯¹è±¡çš„äº‰å¤ºï¼Œä¸€æ—¦æœ‰çº¿ç¨‹æŒæœ‰äº†è¿™ä¸ªå¯¹è±¡ï¼Œæ ‡å¿—ä½ä¿®æ”¹ä¸º1ï¼Œå°±è¿›å…¥åå‘æ¨¡å¼ï¼ŒåŒæ—¶ä¼šæŠŠè¿™ä¸ªçº¿ç¨‹çš„IDè®°å½•åœ¨å¯¹è±¡çš„Mark Wordä¸­ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹æ˜¯é‡‡ç”¨äº†<code>CAS</code>ä¹è§‚é”æ“ä½œçš„ï¼Œæ¯æ¬¡åŒä¸€çº¿ç¨‹è¿›å…¥ï¼Œè™šæ‹Ÿæœºå°±ä¸è¿›è¡Œä»»ä½•åŒæ­¥çš„æ“ä½œäº†ï¼Œå¯¹æ ‡å¿—ä½+1å°±å¥½äº†ï¼Œä¸åŒçº¿ç¨‹è¿‡æ¥ï¼ŒCASä¼šå¤±è´¥ï¼Œä¹Ÿå°±æ„å‘³ç€è·å–é”å¤±è´¥ã€‚</p><p>åå‘é”åœ¨1.6ä¹‹åæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œ1.5ä¸­æ˜¯å…³é—­çš„ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯å‚æ•°æ˜¯xx:-UseBiasedLocking=falseã€‚</p><p>åˆæ¬¡æ‰§è¡Œåˆ°synchronizedä»£ç å—çš„æ—¶å€™ï¼Œé”å¯¹è±¡å˜æˆåå‘é”ï¼ˆé€šè¿‡CASä¿®æ”¹å¯¹è±¡å¤´é‡Œçš„é”æ ‡å¿—ä½ï¼‰ï¼Œå­—é¢æ„æ€æ˜¯â€œåå‘äºç¬¬ä¸€ä¸ªè·å¾—å®ƒçš„çº¿ç¨‹â€çš„é”ã€‚æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—åï¼Œçº¿ç¨‹å¹¶ä¸ä¼šä¸»åŠ¨é‡Šæ”¾åå‘é”ã€‚</p><p>å½“ç¬¬äºŒæ¬¡åˆ°è¾¾åŒæ­¥ä»£ç å—æ—¶ï¼Œçº¿ç¨‹ä¼šåˆ¤æ–­æ­¤æ—¶æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å°±æ˜¯è‡ªå·±ï¼ˆæŒæœ‰é”çš„çº¿ç¨‹IDä¹Ÿåœ¨å¯¹è±¡å¤´é‡Œï¼‰ï¼Œå¦‚æœæ˜¯åˆ™æ­£å¸¸å¾€ä¸‹æ‰§è¡Œã€‚ç”±äºä¹‹å‰æ²¡æœ‰é‡Šæ”¾é”ï¼Œè¿™é‡Œä¹Ÿå°±ä¸éœ€è¦é‡æ–°åŠ é”ã€‚<code>å¦‚æœè‡ªå§‹è‡³ç»ˆä½¿ç”¨é”çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œå¾ˆæ˜æ˜¾åå‘é”å‡ ä¹æ²¡æœ‰é¢å¤–å¼€é”€ï¼Œæ€§èƒ½æé«˜ã€‚</code></p><p>åå‘é”æ˜¯æŒ‡å½“ä¸€æ®µåŒæ­¥ä»£ç <strong>ä¸€ç›´è¢«åŒä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®</strong>æ—¶ï¼Œå³ä¸å­˜åœ¨å¤šä¸ªçº¿ç¨‹çš„ç«äº‰æ—¶ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹åœ¨åç»­è®¿é—®æ—¶ä¾¿ä¼šè‡ªåŠ¨è·å¾—é”ï¼Œä»è€Œé™ä½è·å–é”å¸¦æ¥çš„æ¶ˆè€—ï¼Œå³æé«˜æ€§èƒ½ã€‚</p><p>å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥ä»£ç å—å¹¶è·å–é”æ—¶ï¼Œä¼šåœ¨ Mark Word é‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹ IDã€‚åœ¨çº¿ç¨‹è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ä¸å†é€šè¿‡ CAS æ“ä½œæ¥åŠ é”å’Œè§£é”ï¼Œè€Œæ˜¯æ£€æµ‹ Mark Word é‡Œæ˜¯å¦å­˜å‚¨ç€æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚<code>è½»é‡çº§é”çš„è·å–åŠé‡Šæ”¾ä¾èµ–å¤šæ¬¡ CAS åŸå­æŒ‡ä»¤</code>ï¼Œè€Œ<code>åå‘é”åªéœ€è¦åœ¨ç½®æ¢ ThreadID çš„æ—¶å€™ä¾èµ–ä¸€æ¬¡ CAS åŸå­æŒ‡ä»¤</code>å³å¯ã€‚</p><p>åå‘é”åªæœ‰é‡åˆ°å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ï¼Œ<code>çº¿ç¨‹æ˜¯ä¸ä¼šä¸»åŠ¨é‡Šæ”¾åå‘é”çš„ã€‚</code></p><p>å…³äºåå‘é”çš„æ’¤é”€ï¼Œéœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼Œå³åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šæ²¡æœ‰å­—èŠ‚ç æ­£åœ¨æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šå…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œç„¶ååˆ¤æ–­é”å¯¹è±¡æ˜¯å¦å¤„äºè¢«é”å®šçŠ¶æ€ã€‚å¦‚æœ<code>çº¿ç¨‹ä¸å¤„äºæ´»åŠ¨çŠ¶æ€</code>ï¼Œåˆ™å°†å¯¹è±¡å¤´è®¾ç½®æˆæ— é”çŠ¶æ€ï¼Œå¹¶æ’¤é”€åå‘é”ï¼Œæ¢å¤åˆ°æ— é”ï¼ˆæ ‡å¿—ä½ä¸º01ï¼‰æˆ–è½»é‡çº§é”ï¼ˆæ ‡å¿—ä½ä¸º00ï¼‰çš„çŠ¶æ€ã€‚</p><p><strong>åå‘é”å…³é—­ï¼Œæˆ–è€…å¤šä¸ªçº¿ç¨‹ç«äº‰åå‘é”æ€ä¹ˆåŠå‘¢ï¼Ÿ</strong></p><h3 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h3><p>è¿˜æ˜¯è·ŸMark Work ç›¸å…³ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡æ˜¯æ— é”çš„ï¼Œjvmå°±ä¼šåœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªå«<code>é”è®°å½•ï¼ˆLock Recordï¼‰</code>çš„ç©ºé—´ï¼Œç”¨æ¥å­˜å‚¨é”å¯¹è±¡çš„Mark Word æ‹·è´ï¼Œç„¶åæŠŠLock Recordä¸­çš„owneræŒ‡å‘å½“å‰å¯¹è±¡ã€‚</p><p>JVMæ¥ä¸‹æ¥ä¼šåˆ©ç”¨CASå°è¯•æŠŠå¯¹è±¡åŸæœ¬çš„Mark Word æ›´æ–°ä¼šLock Recordçš„æŒ‡é’ˆï¼ŒæˆåŠŸå°±è¯´æ˜åŠ é”æˆåŠŸï¼Œæ”¹å˜é”æ ‡å¿—ä½ï¼Œæ‰§è¡Œç›¸å…³åŒæ­¥æ“ä½œã€‚</p><p>å¦‚æœå¤±è´¥äº†ï¼Œå°±ä¼šåˆ¤æ–­å½“å‰å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘äº†å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œæ˜¯åˆ™è¡¨ç¤ºå½“å‰çš„çº¿ç¨‹å·²ç»æŒæœ‰äº†è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œå¦åˆ™è¯´æ˜è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰äº†ï¼Œç»§ç»­é”å‡çº§ï¼Œä¿®æ”¹é”çš„çŠ¶æ€ï¼Œä¹‹åç­‰å¾…çš„çº¿ç¨‹ä¹Ÿé˜»å¡ã€‚</p><p>è½»é‡çº§é”æ˜¯æŒ‡å½“é”æ˜¯åå‘é”çš„æ—¶å€™ï¼Œå´è¢«å¦å¤–çš„çº¿ç¨‹æ‰€è®¿é—®ï¼Œæ­¤æ—¶åå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„å½¢å¼å°è¯•è·å–é”ï¼Œçº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</p><p>è½»é‡çº§é”çš„è·å–ä¸»è¦ç”±ä¸¤ç§æƒ…å†µï¼š<br>â‘  å½“å…³é—­åå‘é”åŠŸèƒ½æ—¶ï¼›<br>â‘¡ ç”±äºå¤šä¸ªçº¿ç¨‹ç«äº‰åå‘é”å¯¼è‡´åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ã€‚</p><p>ä¸€æ—¦æœ‰ç¬¬äºŒä¸ªçº¿ç¨‹åŠ å…¥é”ç«äº‰ï¼Œåå‘é”å°±å‡çº§ä¸ºè½»é‡çº§é”ï¼ˆè‡ªæ—‹é”ï¼‰ã€‚è¿™é‡Œè¦æ˜ç¡®ä¸€ä¸‹ä»€ä¹ˆæ˜¯é”ç«äº‰ï¼š</p><blockquote><p>å¦‚æœå¤šä¸ªçº¿ç¨‹è½®æµè·å–ä¸€ä¸ªé”ï¼Œä½†æ˜¯æ¯æ¬¡è·å–é”çš„æ—¶å€™éƒ½å¾ˆé¡ºåˆ©ï¼Œæ²¡æœ‰å‘ç”Ÿé˜»å¡ï¼Œé‚£ä¹ˆå°±ä¸å­˜åœ¨é”ç«äº‰ã€‚åªæœ‰å½“æŸçº¿ç¨‹å°è¯•è·å–é”çš„æ—¶å€™ï¼Œå‘ç°è¯¥é”å·²ç»è¢«å ç”¨ï¼Œåªèƒ½ç­‰å¾…å…¶é‡Šæ”¾ï¼Œè¿™æ‰å‘ç”Ÿäº†é”ç«äº‰ã€‚</p></blockquote><img src='https://img-blog.csdnimg.cn/20200606123648335.png' width=600 height=650><p>åœ¨è½»é‡çº§é”çŠ¶æ€ä¸‹ç»§ç»­é”ç«äº‰ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„çº¿ç¨‹å°†è‡ªæ—‹ï¼Œå³ä¸åœåœ°å¾ªç¯åˆ¤æ–­é”æ˜¯å¦èƒ½å¤Ÿè¢«æˆåŠŸè·å–ã€‚è·å–é”çš„æ“ä½œï¼Œå…¶å®å°±æ˜¯é€šè¿‡CASä¿®æ”¹å¯¹è±¡å¤´é‡Œçš„é”æ ‡å¿—ä½ã€‚å…ˆæ¯”è¾ƒå½“å‰é”æ ‡å¿—ä½æ˜¯å¦ä¸ºâ€œé‡Šæ”¾â€ï¼Œå¦‚æœæ˜¯åˆ™å°†å…¶è®¾ç½®ä¸ºâ€œé”å®šâ€ï¼Œæ¯”è¾ƒå¹¶è®¾ç½®æ˜¯åŸå­æ€§å‘ç”Ÿçš„ã€‚è¿™å°±ç®—æŠ¢åˆ°é”äº†ï¼Œç„¶åçº¿ç¨‹å°†å½“å‰é”çš„æŒæœ‰è€…ä¿¡æ¯ä¿®æ”¹ä¸ºè‡ªå·±ã€‚</p><p>é•¿æ—¶é—´çš„è‡ªæ—‹æ“ä½œæ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ï¼Œä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹å°±åªèƒ½åœ¨åŸåœ°ç©ºè€—CPUï¼Œæ‰§è¡Œä¸äº†ä»»ä½•æœ‰æ•ˆçš„ä»»åŠ¡ï¼Œè¿™ç§ç°è±¡å«åšå¿™ç­‰ï¼ˆbusy-waitingï¼‰ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹ç”¨ä¸€ä¸ªé”ï¼Œä½†æ˜¯æ²¡æœ‰å‘ç”Ÿé”ç«äº‰ï¼Œæˆ–è€…å‘ç”Ÿäº†å¾ˆè½»å¾®çš„é”ç«äº‰ï¼Œé‚£ä¹ˆsynchronizedå°±ç”¨è½»é‡çº§é”ï¼Œå…è®¸çŸ­æ—¶é—´çš„å¿™ç­‰ç°è±¡ã€‚è¿™æ˜¯ä¸€ç§æŠ˜è¡·çš„æƒ³æ³•ï¼ŒçŸ­æ—¶é—´çš„å¿™ç­‰ï¼Œæ¢å–çº¿ç¨‹åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´åˆ‡æ¢çš„å¼€é”€ã€‚</p><h3 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h3><p>æˆ‘ä¸æ˜¯åœ¨ä¸Šé¢æåˆ°äº†Linuxç³»ç»Ÿçš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢å¾ˆè€—èµ„æºï¼Œå…¶å®å°±æ˜¯çº¿ç¨‹çš„ç­‰å¾…å”¤èµ·è¿‡ç¨‹ï¼Œé‚£æ€ä¹ˆæ‰èƒ½å‡å°‘è¿™ç§æ¶ˆè€—å‘¢ï¼Ÿ</p><p>è‡ªæ—‹ï¼Œè¿‡æ¥çš„ç°åœ¨å°±ä¸æ–­è‡ªæ—‹ï¼Œé˜²æ­¢çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œä¸€æ—¦å¯ä»¥è·å–èµ„æºï¼Œå°±ç›´æ¥å°è¯•æˆåŠŸï¼Œç›´åˆ°è¶…å‡ºé˜ˆå€¼ï¼Œè‡ªæ—‹é”çš„é»˜è®¤å¤§å°æ˜¯10æ¬¡ï¼Œ-XXï¼šPreBlockSpinå¯ä»¥ä¿®æ”¹ã€‚</p><p>è‡ªæ—‹éƒ½å¤±è´¥äº†ï¼Œé‚£å°±å‡çº§ä¸ºé‡é‡çº§çš„é”ï¼Œåƒ1.5çš„ä¸€æ ·ï¼Œç­‰å¾…å”¤èµ·å’¯ã€‚</p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210729151704773.png" alt="image-20210729151704773" style="zoom:33%;" /><h3 id="è‡ªé€‚åº”è‡ªæ—‹é”"><a href="#è‡ªé€‚åº”è‡ªæ—‹é”" class="headerlink" title="è‡ªé€‚åº”è‡ªæ—‹é”"></a>è‡ªé€‚åº”è‡ªæ—‹é”</h3><p>è‡ªé€‚åº”æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šï¼š</p><ul><li>å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…ä¹‹å‰æˆåŠŸè·å¾—è¿‡çš„é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½å†æ¬¡æˆåŠŸï¼Œå› æ­¤å…è®¸è‡ªæ—‹ç­‰å¾…æŒç»­ç›¸å¯¹æ›´é•¿çš„æ—¶é—´ã€‚</li><li>ç›¸åçš„ï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡ï¼Œé‚£ä¹ˆä»¥åè¦è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½å‡å°‘è‡ªæ—‹æ—¶é—´ç”šè‡³çœç•¥è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚</li></ul><p><strong>è‡ªé€‚åº”è‡ªæ—‹è§£å†³çš„æ˜¯â€œé”ç«äº‰æ—¶é—´ä¸ç¡®å®šâ€çš„é—®é¢˜</strong>ã€‚JVMå¾ˆéš¾æ„ŸçŸ¥ç¡®åˆ‡çš„é”ç«äº‰æ—¶é—´ï¼Œè€Œäº¤ç»™ç”¨æˆ·åˆ†æå°±è¿åäº†JVMçš„è®¾è®¡åˆè¡·ã€‚è‡ªé€‚åº”è‡ªæ—‹å‡å®šä¸åŒçº¿ç¨‹æŒæœ‰åŒä¸€ä¸ªé”å¯¹è±¡çš„æ—¶é—´åŸºæœ¬ç›¸å½“ï¼Œç«äº‰ç¨‹åº¦è¶‹äºç¨³å®šã€‚å› æ­¤ï¼Œå¯ä»¥æ ¹æ®ä¸Šä¸€æ¬¡è‡ªæ—‹çš„æ—¶é—´ä¸ç»“æœè°ƒæ•´ä¸‹ä¸€æ¬¡è‡ªæ—‹çš„æ—¶é—´ã€‚</p><h3 id="é‡é‡çº§é”"><a href="#é‡é‡çº§é”" class="headerlink" title="é‡é‡çº§é”"></a>é‡é‡çº§é”</h3><p>å¦‚æœé”ç«äº‰æƒ…å†µä¸¥é‡ï¼ŒæŸä¸ªè¾¾åˆ°æœ€å¤§è‡ªæ—‹æ¬¡æ•°çš„çº¿ç¨‹ï¼Œä¼šå°†è½»é‡çº§é”å‡çº§ä¸ºé‡é‡çº§é”ï¼ˆä¾ç„¶æ˜¯CASä¿®æ”¹é”æ ‡å¿—ä½ï¼Œä½†ä¸ä¿®æ”¹æŒæœ‰é”çš„çº¿ç¨‹IDï¼‰ã€‚å½“åç»­çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œå‘ç°è¢«å ç”¨çš„é”æ˜¯é‡é‡çº§é”ï¼Œåˆ™ç›´æ¥å°†è‡ªå·±æŒ‚èµ·ï¼ˆè€Œä¸æ˜¯å¿™ç­‰ï¼‰ï¼Œç­‰å¾…å°†æ¥è¢«å”¤é†’ã€‚</p><p>é‡é‡çº§é”æ˜¯æŒ‡å½“æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”ä¹‹åï¼Œå…¶ä½™æ‰€æœ‰ç­‰å¾…è·å–è¯¥é”çš„çº¿ç¨‹éƒ½ä¼šå¤„äºé˜»å¡çŠ¶æ€ã€‚</p><p>ç®€è¨€ä¹‹ï¼Œå°±æ˜¯æ‰€æœ‰çš„æ§åˆ¶æƒéƒ½äº¤ç»™äº†æ“ä½œç³»ç»Ÿï¼Œç”±æ“ä½œç³»ç»Ÿæ¥è´Ÿè´£çº¿ç¨‹é—´çš„è°ƒåº¦å’Œçº¿ç¨‹çš„çŠ¶æ€å˜æ›´ã€‚è€Œè¿™æ ·ä¼šå‡ºç°é¢‘ç¹åœ°å¯¹çº¿ç¨‹è¿è¡ŒçŠ¶æ€çš„åˆ‡æ¢ï¼Œçº¿ç¨‹çš„æŒ‚èµ·å’Œå”¤é†’ï¼Œä»è€Œæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„</p><p>å¤§å®¶åœ¨çœ‹ObjectMonitoræºç çš„æ—¶å€™ï¼Œä¼šå‘ç°Atomic::cmpxchg_ptrï¼ŒAtomic::inc_ptrç­‰å†…æ ¸å‡½æ•°ï¼Œå¯¹åº”çš„çº¿ç¨‹å°±æ˜¯park()å’Œupark()ã€‚<br>è¿™ä¸ªæ“ä½œæ¶‰åŠç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬æ¢äº†ï¼Œè¿™ç§åˆ‡æ¢æ˜¯å¾ˆè€—èµ„æºçš„ï¼Œæ‰€ä»¥çŸ¥é“ä¸ºå•¥æœ‰è‡ªæ—‹é”è¿™æ ·çš„æ“ä½œäº†å§ï¼ŒæŒ‰é“ç†ç±»ä¼¼æ­»å¾ªç¯çš„æ“ä½œæ›´è´¹èµ„æºæ‰æ˜¯å¯¹å§ï¼Ÿå…¶å®ä¸æ˜¯ï¼Œå¤§å®¶äº†è§£ä¸€ä¸‹å°±çŸ¥é“äº†ã€‚</p><blockquote><p>é‚£ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆæ˜¯å•¥å‘¢ï¼Ÿ</p></blockquote><img src='https://oscimg.oschina.net/oscnet/up-3d168748d90e18da228ce8f55a9cc4a6cc4.png' width=300 height=300><p>Linuxç³»ç»Ÿçš„ä½“ç³»ç»“æ„åˆ†ä¸ºç”¨æˆ·ç©ºé—´ï¼ˆåº”ç”¨ç¨‹åºçš„æ´»åŠ¨ç©ºé—´ï¼‰å’Œå†…æ ¸ã€‚æˆ‘ä»¬æ‰€æœ‰çš„ç¨‹åºéƒ½åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œï¼Œè¿›å…¥ç”¨æˆ·è¿è¡ŒçŠ¶æ€ä¹Ÿå°±æ˜¯ï¼ˆç”¨æˆ·æ€ï¼‰ï¼Œä½†æ˜¯å¾ˆå¤šæ“ä½œå¯èƒ½æ¶‰åŠå†…æ ¸è¿è¡Œï¼Œæ¯”å¦‚æ¶‰åŠåˆ°I/Oï¼Œæˆ‘ä»¬å°±ä¼šè¿›å…¥å†…æ ¸è¿è¡ŒçŠ¶æ€ï¼ˆå†…æ ¸æ€ï¼‰ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ˆå¤æ‚çš„ï¼Œä¹Ÿæ¶‰åŠå¾ˆå¤šå€¼çš„ä¼ é€’ï¼Œæˆ‘ç®€å•æ¦‚æ‹¬ä¸‹æµç¨‹ï¼š</p><ul><li>ç”¨æˆ·æ€æŠŠä¸€äº›æ•°æ®æ”¾åˆ°å¯„å­˜å™¨ï¼Œæˆ–è€…åˆ›å»ºå¯¹åº”çš„å †æ ˆï¼Œè¡¨æ˜éœ€è¦æ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡ã€‚</li><li>ç”¨æˆ·æ€æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼ˆç³»ç»Ÿè°ƒç”¨æ˜¯æ“ä½œç³»ç»Ÿçš„æœ€å°åŠŸèƒ½å•ä½ï¼‰ã€‚</li><li>CPUåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œè·³åˆ°å¯¹åº”çš„å†…å­˜æŒ‡å®šçš„ä½ç½®æ‰§è¡ŒæŒ‡ä»¤ã€‚</li><li>ç³»ç»Ÿè°ƒç”¨å¤„ç†å™¨å»è¯»å–æˆ‘ä»¬å…ˆå‰æ”¾åˆ°å†…å­˜çš„æ•°æ®å‚æ•°ï¼Œæ‰§è¡Œç¨‹åºçš„è¯·æ±‚ã€‚</li><li>è°ƒç”¨å®Œæˆï¼Œæ“ä½œç³»ç»Ÿé‡ç½®CPUä¸ºç”¨æˆ·æ€è¿”å›ç»“æœï¼Œå¹¶æ‰§è¡Œä¸‹ä¸ªæŒ‡ä»¤ã€‚</li></ul><p>æ‰€ä»¥å¤§å®¶ä¸€ç›´è¯´ï¼Œ1.6ä¹‹å‰æ˜¯é‡é‡çº§é”ï¼Œæ²¡é”™ï¼Œä½†æ˜¯ä»–é‡é‡çš„æœ¬è´¨ï¼Œæ˜¯ObjectMonitorè°ƒç”¨çš„è¿‡ç¨‹ï¼Œä»¥åŠLinuxå†…æ ¸çš„å¤æ‚è¿è¡Œæœºåˆ¶å†³å®šçš„ï¼Œå¤§é‡çš„ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼Œæ‰€ä»¥æ•ˆç‡æ‰ä½ã€‚<br>è¿˜æœ‰ä¸¤ç§æƒ…å†µä¹Ÿä¼šå‘ç”Ÿå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢ï¼šå¼‚å¸¸äº‹ä»¶å’Œå¤–å›´è®¾å¤‡çš„ä¸­æ–­ å¤§å®¶ä¹Ÿå¯ä»¥äº†è§£ä¸‹ã€‚</p><blockquote><p>æ™®é€šçš„IOè¯»å†™ä¹Ÿä¼šæ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸çš„åˆ‡æ¢ï¼Œä½†æ˜¯ä¸ºäº†æå‡IO çš„æ€§èƒ½ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥é€šè¿‡ <code>é›¶æ‹·è´</code> æ¥å®ç°ï¼ŒRediså’ŒKafka,è¿˜æœ‰nettyçš„åº•å±‚IOæ¨¡å‹éƒ½å­˜åœ¨é›¶æ‹·è´ã€‚</p></blockquote><h3 id="é”å¯¹æ¯”"><a href="#é”å¯¹æ¯”" class="headerlink" title="é”å¯¹æ¯”"></a>é”å¯¹æ¯”</h3><p><img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210729150936860.png" alt="image-20210729150936860"></p><h2 id="synchronizedå’ŒLockå¯¹æ¯”"><a href="#synchronizedå’ŒLockå¯¹æ¯”" class="headerlink" title="synchronizedå’ŒLockå¯¹æ¯”"></a>synchronizedå’ŒLockå¯¹æ¯”</h2><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ä»–ä»¬çš„åŒºåˆ«ï¼š</p><ul><li>synchronizedæ˜¯å…³é”®å­—ï¼Œæ˜¯JVMå±‚é¢çš„åº•å±‚å•¥éƒ½å¸®æˆ‘ä»¬åšäº†ï¼Œè€ŒLockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ˜¯JDKå±‚é¢çš„æœ‰ä¸°å¯Œçš„APIã€‚</li><li>synchronizedä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œè€ŒLockå¿…é¡»æ‰‹åŠ¨é‡Šæ”¾é”ã€‚</li><li>synchronizedæ˜¯ä¸å¯ä¸­æ–­çš„ï¼ŒLockå¯ä»¥ä¸­æ–­ä¹Ÿå¯ä»¥ä¸ä¸­æ–­ã€‚</li><li>é€šè¿‡Lockå¯ä»¥çŸ¥é“çº¿ç¨‹æœ‰æ²¡æœ‰æ‹¿åˆ°é”ï¼Œè€Œsynchronizedä¸èƒ½ã€‚</li><li>synchronizedèƒ½é”ä½æ–¹æ³•å’Œä»£ç å—ï¼Œè€ŒLockåªèƒ½é”ä½ä»£ç å—ã€‚</li><li>Lockå¯ä»¥ä½¿ç”¨è¯»é”æé«˜å¤šçº¿ç¨‹è¯»æ•ˆç‡ã€‚</li><li>synchronizedæ˜¯éå…¬å¹³é”ï¼ŒReentrantLockå¯ä»¥æ§åˆ¶æ˜¯å¦æ˜¯å…¬å¹³é”ã€‚</li></ul><p>ä¸¤è€…ä¸€ä¸ªæ˜¯JDKå±‚é¢çš„ä¸€ä¸ªæ˜¯JVMå±‚é¢çš„ï¼Œæˆ‘è§‰å¾—æœ€å¤§çš„åŒºåˆ«å…¶å®åœ¨ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦ä¸°å¯Œçš„apiï¼Œè¿˜æœ‰ä¸€ä¸ªæˆ‘ä»¬çš„åœºæ™¯ã€‚</p><blockquote><p><strong>æ¯”å¦‚æˆ‘ç°åœ¨æ˜¯æ»´æ»´ï¼Œæˆ‘æ—©ä¸Šæœ‰æ‰“è½¦é«˜å³°ï¼Œæˆ‘ä»£ç ä½¿ç”¨äº†å¤§é‡çš„synchronizedï¼Œæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿé”å‡çº§è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„ï¼Œè¿‡äº†é«˜å³°æˆ‘ä»¬è¿˜æ˜¯é‡é‡çº§çš„é”ï¼Œé‚£æ•ˆç‡æ˜¯ä¸æ˜¯å¤§æ‰“æŠ˜æ‰£äº†ï¼Ÿè¿™ä¸ªæ—¶å€™ä½ ç”¨Lockæ˜¯ä¸æ˜¯å¾ˆå¥½ï¼Ÿ</strong></p></blockquote><h2 id="synchronizedä½¿ç”¨æ³¨æ„äº‹é¡¹"><a href="#synchronizedä½¿ç”¨æ³¨æ„äº‹é¡¹" class="headerlink" title="synchronizedä½¿ç”¨æ³¨æ„äº‹é¡¹"></a>synchronizedä½¿ç”¨æ³¨æ„äº‹é¡¹</h2><p>synchronizedæ˜¯é€šè¿‡è½¯ä»¶(JVM)å®ç°çš„ï¼Œç®€å•æ˜“ç”¨ï¼Œå³ä½¿åœ¨JDK5ä¹‹åæœ‰äº†Lockï¼Œä»ç„¶è¢«å¹¿æ³›åœ°ä½¿ç”¨ã€‚</p><blockquote><p> <strong>ä½¿ç”¨Synchronizedæœ‰å“ªäº›è¦æ³¨æ„çš„ï¼Ÿ</strong></p></blockquote><ul><li>é”å¯¹è±¡ä¸èƒ½ä¸ºç©ºï¼Œå› ä¸ºé”çš„ä¿¡æ¯éƒ½ä¿å­˜åœ¨å¯¹è±¡å¤´é‡Œ</li><li>ä½œç”¨åŸŸä¸å®œè¿‡å¤§ï¼Œå½±å“ç¨‹åºæ‰§è¡Œçš„é€Ÿåº¦ï¼Œæ§åˆ¶èŒƒå›´è¿‡å¤§ï¼Œç¼–å†™ä»£ç ä¹Ÿå®¹æ˜“å‡ºé”™</li><li>é¿å…æ­»é”</li><li>åœ¨èƒ½é€‰æ‹©çš„æƒ…å†µä¸‹ï¼Œæ—¢ä¸è¦ç”¨Lockä¹Ÿä¸è¦ç”¨synchronizedå…³é”®å­—ï¼Œç”¨java.util.concurrentåŒ…ä¸­çš„å„ç§å„æ ·çš„ç±»ï¼Œå¦‚æœä¸ç”¨è¯¥åŒ…ä¸‹çš„ç±»ï¼Œåœ¨æ»¡è¶³ä¸šåŠ¡çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨synchronizedå…³é”®ï¼Œå› ä¸ºä»£ç é‡å°‘ï¼Œé¿å…å‡ºé”™</li></ul><blockquote><p><strong>synchronizedæ˜¯å…¬å¹³é”å—ï¼Ÿ</strong></p></blockquote><p>synchronizedå®é™…ä¸Šæ˜¯éå…¬å¹³çš„ï¼Œæ–°æ¥çš„çº¿ç¨‹æœ‰å¯èƒ½ç«‹å³è·å¾—ç›‘è§†å™¨ï¼Œè€Œåœ¨ç­‰å¾…åŒºä¸­ç­‰å€™å·²ä¹…çš„çº¿ç¨‹å¯èƒ½å†æ¬¡ç­‰å¾…ï¼Œä¸è¿‡è¿™ç§æŠ¢å çš„æ–¹å¼å¯ä»¥é¢„é˜²é¥¥é¥¿ã€‚</p><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><p><a href="https://www.cnblogs.com/bakari/p/5520860.html">Linuxæ¢ç§˜ä¹‹ç”¨æˆ·æ€ä¸å†…æ ¸æ€</a></p><p><a href="https://mp.weixin.qq.com/s/FgBCop2zFfcX5ZszE0NoCQ">å‚»ç“œä¸‰æ­ªè®©æˆ‘æ•™ä»–ã€Œé›¶æ‹·è´ã€</a></p><p><a href="https://www.jianshu.com/p/8c255b942535">åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”ã€è‡ªæ—‹é”ã€è‡ªé€‚åº”è‡ªæ—‹é”</a></p><p><a href="https://www.cnblogs.com/mingyueyy/p/13054296.html">å…³äº é”çš„å››ç§çŠ¶æ€ä¸é”å‡çº§è¿‡ç¨‹ å›¾æ–‡è¯¦è§£</a></p><p><a href="https://mp.weixin.qq.com/s/2ka1cDTRyjsAGk_-ii4ngw">æ­»ç£•Synchronizedåº•å±‚å®ç°</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹‹å‰å†™è¿‡ä¸€ç¯‡å…³äºsynchronizedå…³é”®å­—çš„æ–‡ç« ï¼Œæ˜¯å½“æ—¶å¬é©¬å£«å…µè€å¸ˆçš„å…¬å¼€è¯¾æ—¶è®°å½•çš„ä¸€äº›å…³é”®ç¬”è®°ğŸ“’ &lt;a href=&quot;https://geekibli.github.io/wiki/Java-synchronzied%E5%BA%95%E5%B1%82%E5%8E%9</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼-ç§’æ€ç³»ç»Ÿè®¾è®¡</title>
    <link href="http://example.com/wiki/%E5%88%86%E5%B8%83%E5%BC%8F-%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
    <id>http://example.com/wiki/%E5%88%86%E5%B8%83%E5%BC%8F-%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</id>
    <published>2021-07-29T03:03:58.000Z</published>
    <updated>2021-07-29T03:48:33.391Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜"><a href="#ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜" class="headerlink" title="ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜"></a>ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜</h1><h2 id="é«˜å¹¶å‘"><a href="#é«˜å¹¶å‘" class="headerlink" title="é«˜å¹¶å‘"></a>é«˜å¹¶å‘</h2><p>ç§’æ€æ´»åŠ¨çš„ç‰¹ç‚¹å°±æ˜¯çŸ­æ—¶é—´å†…èšé›†å¤§é‡è¯·æ±‚ç¬æ—¶åˆ°è¾¾æœåŠ¡ç«¯ï¼Œæ­¤æ—¶æ•°æ®åº“å·²ç»æ— æ³•æ”¯æ’‘å¦‚æ­¤å¤§æ•°æ®é‡çš„è¯·æ±‚äº†ã€‚å•ä¸ªçš„æ•°æ®åº“QPSä»…æœ‰å‡ ç™¾ï¼Œä½ å¯èƒ½ä¼šæƒ³ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥éƒ¨ç½²ä¸€ä¸ªæ•°æ®åº“é›†ç¾¤å‘¢ï¼Œåœ¨æ•°æ®åº“é›†ç¾¤å‰ä½¿ç”¨Nginxåˆ†å‘ï¼Œå°†è´Ÿè½½å¹³å‡åˆ†æ‘Šåˆ°æ¯ä¸€ä¸ªæ•°æ®åº“ä¸å°±å¯ä»¥äº†å—ã€‚<br>è¿™ç§æ–¹å¼ä¸€å®šç¨‹åº¦ä¸Šæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å›½å†…çœŸæ­£çš„äº’è”ç½‘å¤§å‚è‚¯å®šä¸æ˜¯è¿™æ ·åšçš„ï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹å®Œå…¨å¯ä»¥ä½¿ç”¨å†…å­˜æ“ä½œæ¥ä»£æ›¿è®¿é—®æ•°æ®åº“ï¼Œæ¯”å¦‚Redisé›†ç¾¤ã€‚åœ¨ç½‘ç»œå¸¦å®½å…è®¸çš„æƒ…å†µä¸‹ï¼ŒRedisçš„é›†ç¾¤çš„ç³»ç»Ÿååé‡è‚¯å®šå’Œæ•°æ®åº“é›†ç¾¤ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ï¼Œè¿™é‡Œè¦æŸ¥å‡ åå€å‡ ç™¾å€ã€‚</p><h2 id="è¶…å–"><a href="#è¶…å–" class="headerlink" title="è¶…å–"></a>è¶…å–</h2><p>è¶…å–æœ€ç›´æ¥çš„åæœå°±æ˜¯å¯èƒ½ä¼šå¯¹å…¬å¸é€ æˆç›´æ¥çš„ç»æµæŸå¤±ã€‚é˜²æ­¢è¶…å–æ˜¯ç§’æ€ç³»ç»Ÿå¿…é¡»è¦ä¿è¯çš„ä¸€ç‚¹ã€‚è¶…å–çš„è§£å†³åŠæ³•å°±æ˜¯åŠ é”ï¼Œä¿è¯åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹åº“å­˜å¯ä»¥æ­£å¸¸çš„æ­£ç¡®çš„æ‰£å‡ã€‚</p><h2 id="æ¶æ„è¯·æ±‚"><a href="#æ¶æ„è¯·æ±‚" class="headerlink" title="æ¶æ„è¯·æ±‚"></a>æ¶æ„è¯·æ±‚</h2><h3 id="äº§å“å±‚ç­–ç•¥"><a href="#äº§å“å±‚ç­–ç•¥" class="headerlink" title="äº§å“å±‚ç­–ç•¥"></a>äº§å“å±‚ç­–ç•¥</h3><p>ç§’æ€å™¨ä¸€èˆ¬ä¸‹å•å’Œè´­ä¹°åŠå…¶è¿…é€Ÿï¼Œæ ¹æ®è´­ä¹°è®°å½•å¯ä»¥ç”„åˆ«å‡ºä¸€éƒ¨åˆ†ã€‚å¯ä»¥é€šè¿‡æ ¡éªŒç è¾¾åˆ°ä¸€å®šçš„æ–¹æ³•ï¼Œè¿™å°±è¦æ±‚æ ¡éªŒç è¶³å¤Ÿå®‰å…¨ï¼Œä¸è¢«ç ´è§£ï¼Œé‡‡ç”¨çš„æ–¹å¼æœ‰ï¼šç§’æ€ä¸“ç”¨éªŒè¯ç ï¼Œç”µè§†å…¬å¸ƒéªŒè¯ç ï¼Œç§’æ€ç­”é¢˜ã€‚</p><h3 id="å‰ç«¯æ§åˆ¶"><a href="#å‰ç«¯æ§åˆ¶" class="headerlink" title="å‰ç«¯æ§åˆ¶"></a>å‰ç«¯æ§åˆ¶</h3><p>é™¤æ­¤ä¹‹å¤–å‰æ®µå¯ä»¥æ·»åŠ ç‚¹å‡»æ¬¡æ•°é™åˆ¶ï¼Œç‚¹å‡»ä¸€å®šæ¬¡æ•°ä¹‹åï¼Œå°†æŒ‰é’®ç½®ç°è‰²ï¼Œæˆ–è€…åœ¨jså±‚çº§è¿›è¡Œæ§åˆ¶ï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯æ¯æ¬¡éƒ½ç‚¹å‡»æˆåŠŸäº†ï¼Œä½†æ˜¯ä»…ä»…å‘èµ·ä¸€æ¬¡æœåŠ¡ç«¯è¯·æ±‚ï¼›</p><h3 id="åç«¯æ§åˆ¶"><a href="#åç«¯æ§åˆ¶" class="headerlink" title="åç«¯æ§åˆ¶"></a>åç«¯æ§åˆ¶</h3><ul><li>æ·»åŠ æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯æ‰§è¡Œä¸€å®šæ•°é‡æ—¶ï¼Œé˜Ÿåˆ—åç»­çš„æ¶ˆæ¯ä¸åœ¨æ‰§è¡Œ</li><li>åç«¯æ¶æ„æŒ‰ç…§æ¨¡å—æ‹†åˆ†ï¼Œç”¨æˆ·ä¸åŒçš„è¯·æ±‚åˆ†æ•£è½¬å‘åˆ°å„ä¸ªæ¨¡å—çš„æœåŠ¡å™¨ï¼Œè´Ÿè½½å‡è¡¡</li><li>æ•°æ®åº“åˆ†åº“åˆ†è¡¨ï¼ˆåˆ†ç‰‡ç­–ç•¥ï¼‰å’Œredisé›†ç¾¤</li><li>å‡çº§æœåŠ¡å™¨å¸¦å®½ï¼Œå‹åŠ›æµ‹è¯•ï¼Œä¿è¯ç³»ç»Ÿååé‡</li><li>è¿‡è½½ä¿æŠ¤ï¼Œé™æµï¼Œè¯·æ±‚æ‹’ç»å’ŒæœåŠ¡é™çº§</li></ul><h2 id="é“¾æ¥åŠ ç›"><a href="#é“¾æ¥åŠ ç›" class="headerlink" title="é“¾æ¥åŠ ç›"></a>é“¾æ¥åŠ ç›</h2><p>é“¾æ¥åŠ ç›ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ä¿æŠ¤æ¶æ„æ”»å‡»ï¼Œæ¯”å¦‚ä¸‹å•æ¥å£ï¼Œå¦‚æœæš´éœ²ä¹‹åï¼Œå°±ä¼šå­˜åœ¨æ¶æ„æ”»å‡»ï¼Œä¸€ä¸ªç”¨æˆ·ä¸‹äº†å‡ ç™¾ä¸ªå•çš„æƒ…å†µæˆ–è€…ä¸€ä¸ªIPä¸‹äº†å¾ˆå¤šå•å­ï¼Œç±»ä¼¼ä¸é»„ç‰›æŠ¢ç¥¨ä¹‹åå†å»å”®å–ã€‚</p><h1 id="ç§’æ€ç³»ç»Ÿæ¶æ„å›¾ï¼ˆå‚è€ƒï¼‰"><a href="#ç§’æ€ç³»ç»Ÿæ¶æ„å›¾ï¼ˆå‚è€ƒï¼‰" class="headerlink" title="ç§’æ€ç³»ç»Ÿæ¶æ„å›¾ï¼ˆå‚è€ƒï¼‰"></a>ç§’æ€ç³»ç»Ÿæ¶æ„å›¾ï¼ˆå‚è€ƒï¼‰</h1><img src='https://oscimg.oschina.net/oscnet/up-a6fa908f7ee0f098a7a7eb4965dd282124b.png'><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://mp.weixin.qq.com/s/KWb3POodisbOEsQVblsoGw"> æ•–ä¸™å¸¦ä½ è®¾è®¡ã€ç§’æ€ç³»ç»Ÿã€‘</a><br><a href="https://mp.weixin.qq.com/s/z2S1EjWQDwKm5Ud36IenNw">ã€ŠåŠæ‰“é¢è¯•å®˜ã€‹ç³»åˆ—-ç§’æ€ç³»ç»Ÿè®¾è®¡</a><br><a href="https://cloud.tencent.com/developer/article/1520361">è¿™æ˜¯æˆ‘è¯»è¿‡å†™å¾—æœ€å¥½çš„ã€ç§’æ€ç³»ç»Ÿæ¶æ„ã€‘åˆ†æä¸å®æˆ˜ï¼</a><br><a href="https://www.infoq.cn/article/ypqschsrdsk8bv5nhny4">è¿™ä¸€æ¬¡ï¼Œå½»åº•å¼„æ‡‚â€œç§’æ€ç³»ç»Ÿâ€</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜&quot;&gt;&lt;a href=&quot;#ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜&quot; class=&quot;headerlink&quot; title=&quot;ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜&quot;&gt;&lt;/a&gt;ç§’æ€ç³»ç»Ÿçš„æŒ‘æˆ˜&lt;/h1&gt;&lt;h2 id=&quot;é«˜å¹¶å‘&quot;&gt;&lt;a href=&quot;#é«˜å¹¶å‘&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    
    <category term="åˆ†å¸ƒå¼" scheme="http://example.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>JVM-Xms,Xmxå’ŒXss</title>
    <link href="http://example.com/wiki/JVM-Xms-Xmx%E5%92%8CXss/"/>
    <id>http://example.com/wiki/JVM-Xms-Xmx%E5%92%8CXss/</id>
    <published>2021-07-28T13:04:14.000Z</published>
    <updated>2021-07-30T08:33:40.342Z</updated>
    
    <content type="html"><![CDATA[<img src="https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730163232526.png" alt="image-20210730163232526" style="zoom:47%;" /><h1 id="æ€§èƒ½è°ƒä¼˜å‚æ•°Xmsï¼ŒXmxï¼ŒXssçš„å«ä¹‰"><a href="#æ€§èƒ½è°ƒä¼˜å‚æ•°Xmsï¼ŒXmxï¼ŒXssçš„å«ä¹‰" class="headerlink" title="æ€§èƒ½è°ƒä¼˜å‚æ•°Xmsï¼ŒXmxï¼ŒXssçš„å«ä¹‰"></a>æ€§èƒ½è°ƒä¼˜å‚æ•°Xmsï¼ŒXmxï¼ŒXssçš„å«ä¹‰</h1><h2 id="Xss"><a href="#Xss" class="headerlink" title="-Xss"></a>-Xss</h2><p>è§„å®šäº†æ¯ä¸ªçº¿ç¨‹è™šæ‹Ÿæœºæ ˆåŠå †æ ˆçš„å¤§å°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ256kæ˜¯è¶³å¤Ÿçš„ï¼Œæ­¤é…ç½®å°†ä¼šå½±å“æ­¤è¿›ç¨‹ä¸­å¹¶å‘çº¿ç¨‹æ•°çš„å¤§å°ã€‚</p><h3 id="Xms"><a href="#Xms" class="headerlink" title="-Xms"></a>-Xms</h3><p>è¡¨ç¤ºåˆå§‹åŒ–JAVAå †çš„å¤§å°åŠè¯¥è¿›ç¨‹åˆšåˆ›å»ºå‡ºæ¥çš„æ—¶å€™ï¼Œä»–çš„ä¸“å±JAVAå †çš„å¤§å°ï¼Œä¸€æ—¦å¯¹è±¡å®¹é‡è¶…è¿‡äº†JAVAå †çš„åˆå§‹å®¹é‡ï¼ŒJAVAå †å°†ä¼šè‡ªåŠ¨æ‰©å®¹åˆ°-Xmxå¤§å°ã€‚</p><h3 id="Xmx"><a href="#Xmx" class="headerlink" title="-Xmx"></a>-Xmx</h3><p>è¡¨ç¤ºjavaå †å¯ä»¥æ‰©å±•åˆ°çš„æœ€å¤§å€¼ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œé€šå¸¸å°†-Xmså’Œ-Xmxè®¾ç½®æˆä¸€æ ·çš„ï¼Œå› ä¸ºå½“å †ä¸å¤Ÿç”¨è€Œå‘ç”Ÿæ‰©å®¹æ—¶ï¼Œä¼šå‘ç”Ÿå†…å­˜æŠ–åŠ¨å½±å“ç¨‹åºè¿è¡Œæ—¶çš„ç¨³å®šæ€§ã€‚</p><h3 id="å †å†…å­˜åˆ†é…ï¼š"><a href="#å †å†…å­˜åˆ†é…ï¼š" class="headerlink" title="å †å†…å­˜åˆ†é…ï¼š"></a>å †å†…å­˜åˆ†é…ï¼š</h3><p>JVMåˆå§‹åˆ†é…çš„å†…å­˜ç”±-XmsæŒ‡å®šï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/64<br>JVMæœ€å¤§åˆ†é…çš„å†…å­˜ç”±-XmxæŒ‡å®šï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/4<br>é»˜è®¤ç©ºä½™å †å†…å­˜å°äº40%æ—¶ï¼ŒJVMå°±ä¼šå¢å¤§å †ç›´åˆ°-Xmxçš„æœ€å¤§é™åˆ¶ï¼›ç©ºä½™å †å†…å­˜å¤§äº70%æ—¶ï¼ŒJVMä¼šå‡å°‘å †ç›´åˆ° -Xmsçš„æœ€å°é™åˆ¶ã€‚<br>å› æ­¤æœåŠ¡å™¨ä¸€èˆ¬è®¾ç½®-Xmsã€-Xmxç›¸ç­‰ä»¥é¿å…åœ¨æ¯æ¬¡GC åè°ƒæ•´å †çš„å¤§å°ã€‚å¯¹è±¡çš„å †å†…å­˜ç”±ç§°ä¸ºåƒåœ¾å›æ”¶å™¨çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿå›æ”¶ã€‚<br>éå †å†…å­˜åˆ†é…ï¼š<br>JVMä½¿ç”¨-XX:PermSizeè®¾ç½®éå †å†…å­˜åˆå§‹å€¼ï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/64ï¼›<br>ç”±XX:MaxPermSizeè®¾ç½®æœ€å¤§éå †å†…å­˜çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ç‰©ç†å†…å­˜çš„1/4ã€‚<br>-Xmn2Gï¼šè®¾ç½®å¹´è½»ä»£å¤§å°ä¸º2Gã€‚<br>-XX:SurvivorRatioï¼Œè®¾ç½®å¹´è½»ä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„æ¯”å€¼ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>1ã€<a href="https://blog.csdn.net/a1439775520/article/details/97787160">ç±»ä¼¼-Xmsã€-Xmnè¿™äº›å‚æ•°çš„å«ä¹‰ï¼š</a><br>2ã€<a href="https://baijiahao.baidu.com/s?id=1671253445384660292&wfr=spider&for=pc">JVMä¸‰å¤§æ€§èƒ½è°ƒä¼˜å‚æ•°Xmsï¼ŒXmxï¼ŒXssçš„å«ä¹‰ï¼Œä½ åˆçŸ¥é“å¤šå°‘å‘¢</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;img src=&quot;https://cdn.jsdelivr.net/gh/code-xiaozhuang/image@main/gao/image-20210730163232526.png&quot; alt=&quot;image-20210730163232526&quot; style=&quot;zoom:</summary>
      
    
    
    
    <category term="Develop Lan" scheme="http://example.com/categories/Develop-Lan/"/>
    
    <category term="Java" scheme="http://example.com/categories/Develop-Lan/Java/"/>
    
    <category term="JVM" scheme="http://example.com/categories/Develop-Lan/Java/JVM/"/>
    
    
    <category term="Java" scheme="http://example.com/tags/Java/"/>
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVM-è‡ªå®šä¹‰ç±»åŠ è½½å™¨</title>
    <link href="http://example.com/wiki/JVM-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/"/>
    <id>http://example.com/wiki/JVM-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/</id>
    <published>2021-07-28T13:02:32.000Z</published>
    <updated>2021-07-28T15:18:55.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h1><p>ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰åŠ è½½å™¨</p><p>åŸå› ï¼š<br>1ã€å­˜æ”¾åœ¨è‡ªå®šä¹‰è·¯å¾„ä¸Šçš„ç±»ï¼Œéœ€è¦é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»åŠ è½½ã€‚ã€æ³¨æ„ï¼šAppClassLoaderåŠ è½½classpathä¸‹çš„ç±»ã€‘<br>2ã€ç±»ä¸ä¸€å®šä»æ–‡ä»¶ä¸­åŠ è½½ï¼Œä¹Ÿå¯èƒ½ä»ç½‘ç»œä¸­çš„æµä¸­åŠ è½½ï¼Œè¿™å°±éœ€è¦è‡ªå®šä¹‰åŠ è½½å™¨å»å®ç°åŠ å¯†è§£å¯†ã€‚<br>3ã€å¯ä»¥å®šä¹‰ç±»çš„å®ç°æœºåˆ¶ï¼Œå®ç°ç±»çš„çƒ­éƒ¨ç½²,<br>å¦‚OSGiä¸­çš„bundleæ¨¡å—å°±æ˜¯é€šè¿‡å®ç°è‡ªå·±çš„ClassLoaderå®ç°çš„ï¼Œ<br>å¦‚tomcatå®ç°çš„è‡ªå®šä¹‰ç±»åŠ è½½æ¨¡å‹ã€‚</p><p>å¦‚ä½•å®ç°è‡ªå®šä¹‰åŠ è½½å™¨</p><blockquote><p>å®ç°è‡ªå®šä¹‰ç±»åŠ è½½æœ‰ä»¥ä¸‹ä¸¤æ­¥ï¼š<br>1ã€ç»§æ‰¿ClassLoader<br>2ã€é‡å†™findClassï¼Œåœ¨findClassé‡Œè·å–ç±»çš„å­—èŠ‚ç ï¼Œå¹¶è°ƒç”¨ClassLoaderä¸­çš„defineClassæ–¹æ³•æ¥åŠ è½½ç±»ï¼Œè·å–classå¯¹è±¡ã€‚<br>æ³¨æ„ï¼šå¦‚æœè¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œéœ€è¦é‡å†™loadClassæ–¹æ³•ã€‚<br>å¦‚ä¸‹ï¼šæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ çš„ç±»åŠ è½½å™¨</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span>  <span class="keyword">extends</span>  <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] data=<span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                 data= loadByte(name);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.defineClass(data,<span class="number">0</span>,data.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">byte</span>[] loadByte(String name) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(<span class="string">&quot;/Users/admin/test/&quot;</span>+name);</span><br><span class="line">            FileInputStream fi = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            <span class="keyword">int</span> len = fi.available();</span><br><span class="line">            <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">            fi.read(b);</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯è¦åŠ è½½çš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç±»ç¼–è¯‘åçš„class æ–‡ä»¶æ”¾ç½®åœ¨/Users/admin/test/ä¸‹,ç„¶åæ‰§è¡Œå¦‚ä¸‹ä»£ç å»åŠ è½½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MyClassLoader classLoader = <span class="keyword">new</span> MyClassLoader();</span><br><span class="line">        Class clazz = classLoader.loadClass(<span class="string">&quot;Demo.class&quot;</span>);</span><br><span class="line">        Object o=clazz.newInstance();</span><br><span class="line">        Method method = clazz.getMethod(<span class="string">&quot;say&quot;</span>);</span><br><span class="line">        method.invoke(o);</span><br><span class="line"></span><br><span class="line">è¾“å‡º:hello</span><br></pre></td></tr></table></figure><p>èƒ½ä¸èƒ½è‡ªå·±å†™ä¸€ä¸ªjava.lang.String</p><p>1ã€ä»£ç ä¹¦å†™åå¯ä»¥ç¼–è¯‘ä¸ä¼šæŠ¥é”™<br>2ã€åœ¨å¦ä¸€ä¸ªç±»ä¸­åŠ è½½java.lang.Stringï¼Œé€šè¿‡åå°„è°ƒç”¨è‡ªå·±å†™çš„Stringç±»é‡Œçš„æ–¹æ³•ï¼Œå¾—åˆ°ç»“æœNoSuchMethodï¼Œè¯´æ˜åŠ è½½çš„è¿˜æ˜¯åŸæ¥çš„Stringï¼Œå› ä¸ºé€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶ï¼Œä¼šæŠŠjava.lang.Stringä¸€ç›´æäº¤ç»™å¯åŠ¨ç±»åŠ è½½å™¨å»åŠ è½½ï¼Œé€šè¿‡ä»–åŠ è½½ï¼ŒåŠ è½½åˆ°çš„æ°¸è¿œæ˜¯/libä¸‹é¢çš„java.lang.String<br>3ã€åœ¨è¿™ä¸ªè‡ªå·±å†™çš„ç±»ä¸­å†™ä¸Šmainæ–¹æ³•<br>public static void main(String[] args)<br>æ‰§è¡Œmainæ–¹æ³•æŠ¥é”™ï¼Œå› ä¸ºè¿™ä¸ªStringå¹¶ä¸æ˜¯ç³»ç»Ÿçš„java.lang.Stringï¼Œæ‰€ä»¥JVMæ‰¾ä¸åˆ°mainæ–¹æ³•çš„ç­¾å</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://blog.csdn.net/qq_28605513/article/details/85014451">JVM:å¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ</a><br>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/qq_28605513/article/details/85014451">https://blog.csdn.net/qq_28605513/article/details/85014451</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨&quot;&gt;&lt;a href=&quot;#å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨&quot; class=&quot;headerlink&quot; title=&quot;å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨&quot;&gt;&lt;/a&gt;å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨&lt;/h1&gt;&lt;p&gt;ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰åŠ è½½å™¨&lt;/p&gt;
&lt;p&gt;åŸå› ï¼š&lt;br&gt;1ã€å­˜æ”¾åœ¨è‡ªå®šä¹‰è·¯å¾„ä¸Šçš„ç±»ï¼Œéœ€è¦é€š</summary>
      
    
    
    
    <category term="Develop Lan" scheme="http://example.com/categories/Develop-Lan/"/>
    
    <category term="Java" scheme="http://example.com/categories/Develop-Lan/Java/"/>
    
    <category term="JVM" scheme="http://example.com/categories/Develop-Lan/Java/JVM/"/>
    
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼-ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</title>
    <link href="http://example.com/wiki/%E5%88%86%E5%B8%83%E5%BC%8F-%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/"/>
    <id>http://example.com/wiki/%E5%88%86%E5%B8%83%E5%BC%8F-%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/</id>
    <published>2021-07-28T13:01:05.000Z</published>
    <updated>2021-07-28T15:18:55.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><a href="#ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></a>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</h1><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•(Consistent Hashing Algorithm)æ˜¯ä¸€ç§åˆ†å¸ƒå¼ç®—æ³•ï¼Œå¸¸ç”¨äºè´Ÿè½½å‡è¡¡ã€‚Memcached clientä¹Ÿé€‰æ‹©è¿™ç§ç®—æ³•ï¼Œè§£å†³å°†key-valueå‡åŒ€åˆ†é…åˆ°ä¼—å¤šMemcached serverä¸Šçš„é—®é¢˜ã€‚å®ƒå¯ä»¥å–ä»£ä¼ ç»Ÿçš„å–æ¨¡æ“ä½œï¼Œè§£å†³äº†å–æ¨¡æ“ä½œæ— æ³•åº”å¯¹å¢åˆ Memcached Serverçš„é—®é¢˜(å¢åˆ serverä¼šå¯¼è‡´åŒä¸€ä¸ªkey,åœ¨getæ“ä½œæ—¶åˆ†é…ä¸åˆ°æ•°æ®çœŸæ­£å­˜å‚¨çš„serverï¼Œå‘½ä¸­ç‡ä¼šæ€¥å‰§ä¸‹é™)ã€‚</p><h2 id="å“ˆå¸ŒæŒ‡æ ‡"><a href="#å“ˆå¸ŒæŒ‡æ ‡" class="headerlink" title="å“ˆå¸ŒæŒ‡æ ‡"></a>å“ˆå¸ŒæŒ‡æ ‡</h2><blockquote><p>è¯„ä¼°ä¸€ä¸ªå“ˆå¸Œç®—æ³•çš„ä¼˜åŠ£ï¼Œæœ‰å¦‚ä¸‹æŒ‡æ ‡ï¼Œè€Œä¸€è‡´æ€§å“ˆå¸Œå…¨éƒ¨æ»¡è¶³ï¼š</p></blockquote><ul><li>å‡è¡¡æ€§(Balance)ï¼šå°†å…³é”®å­—çš„å“ˆå¸Œåœ°å€å‡åŒ€åœ°åˆ†å¸ƒåœ¨åœ°å€ç©ºé—´ä¸­ï¼Œä½¿åœ°å€ç©ºé—´å¾—åˆ°å……åˆ†åˆ©ç”¨ï¼Œè¿™æ˜¯è®¾è®¡å“ˆå¸Œçš„ä¸€ä¸ªåŸºæœ¬ç‰¹æ€§ã€‚</li><li>å•è°ƒæ€§(Monotonicity): å•è°ƒæ€§æ˜¯æŒ‡å½“åœ°å€ç©ºé—´å¢å¤§æ—¶ï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•°æ‰€å¾—åˆ°çš„å…³é”®å­—çš„å“ˆå¸Œåœ°å€ä¹Ÿèƒ½æ˜ å°„çš„æ–°çš„åœ°å€ç©ºé—´ï¼Œè€Œä¸æ˜¯ä»…é™äºåŸå…ˆçš„åœ°å€ç©ºé—´ã€‚æˆ–ç­‰åœ°å€ç©ºé—´å‡å°‘æ—¶ï¼Œä¹Ÿæ˜¯åªèƒ½æ˜ å°„åˆ°æœ‰æ•ˆçš„åœ°å€ç©ºé—´ä¸­ã€‚ç®€å•çš„å“ˆå¸Œå‡½æ•°å¾€å¾€ä¸èƒ½æ»¡è¶³æ­¤æ€§è´¨ã€‚</li><li>åˆ†æ•£æ€§(Spread): å“ˆå¸Œç»å¸¸ç”¨åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç»ˆç«¯ç”¨æˆ·é€šè¿‡å“ˆå¸Œå‡½æ•°å°†è‡ªå·±çš„å†…å®¹å­˜åˆ°ä¸åŒçš„ç¼“å†²åŒºã€‚æ­¤æ—¶ï¼Œç»ˆç«¯æœ‰å¯èƒ½çœ‹ä¸åˆ°æ‰€æœ‰çš„ç¼“å†²ï¼Œè€Œæ˜¯åªèƒ½çœ‹åˆ°å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å½“ç»ˆç«¯å¸Œæœ›é€šè¿‡å“ˆå¸Œè¿‡ç¨‹å°†å†…å®¹æ˜ å°„åˆ°ç¼“å†²ä¸Šæ—¶ï¼Œç”±äºä¸åŒç»ˆç«¯æ‰€è§çš„ç¼“å†²èŒƒå›´æœ‰å¯èƒ½ä¸åŒï¼Œä»è€Œå¯¼è‡´å“ˆå¸Œçš„ç»“æœä¸ä¸€è‡´ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ç›¸åŒçš„å†…å®¹è¢«ä¸åŒçš„ç»ˆç«¯æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ã€‚è¿™ç§æƒ…å†µæ˜¾ç„¶æ˜¯åº”è¯¥é¿å…çš„ï¼Œå› ä¸ºå®ƒå¯¼è‡´ç›¸åŒå†…å®¹è¢«å­˜å‚¨åˆ°ä¸åŒç¼“å†²ä¸­å»ï¼Œé™ä½äº†ç³»ç»Ÿå­˜å‚¨çš„æ•ˆç‡ã€‚åˆ†æ•£æ€§çš„å®šä¹‰å°±æ˜¯ä¸Šè¿°æƒ…å†µå‘ç”Ÿçš„ä¸¥é‡ç¨‹åº¦ã€‚å¥½çš„å“ˆå¸Œç®—æ³•åº”èƒ½å¤Ÿå°½é‡é¿å…ä¸ä¸€è‡´çš„æƒ…å†µå‘ç”Ÿï¼Œä¹Ÿå°±æ˜¯å°½é‡é™ä½åˆ†æ•£æ€§ã€‚</li><li>è´Ÿè½½(Load): è´Ÿè½½é—®é¢˜å®é™…ä¸Šæ˜¯ä»å¦ä¸€ä¸ªè§’åº¦çœ‹å¾…åˆ†æ•£æ€§é—®é¢˜ã€‚æ—¢ç„¶ä¸åŒçš„ç»ˆç«¯å¯èƒ½å°†ç›¸åŒçš„å†…å®¹æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªç‰¹å®šçš„ç¼“å†²åŒºè€Œè¨€ï¼Œä¹Ÿå¯èƒ½è¢«ä¸åŒçš„ç”¨æˆ·æ˜ å°„ä¸ºä¸åŒçš„å†…å®¹ã€‚ä¸åˆ†æ•£æ€§ä¸€æ ·ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯åº”å½“é¿å…çš„ï¼Œå› æ­¤å¥½çš„å“ˆå¸Œç®—æ³•åº”èƒ½å¤Ÿå°½é‡é™ä½ç¼“å†²çš„è´Ÿè·</li></ul><h2 id="ä¸€è‡´æ€§å“ˆå¸Œ"><a href="#ä¸€è‡´æ€§å“ˆå¸Œ" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œ"></a>ä¸€è‡´æ€§å“ˆå¸Œ</h2><blockquote><p>å°†èŠ‚ç‚¹é€šè¿‡hashæ˜ å°„åˆ°hashç¯ä¸Šï¼Œç†æƒ³çš„æƒ…å†µæ˜¯å¤šä¸ªèŠ‚ç‚¹ç›´æ¥åˆ†å¸ƒå‡åŒ€</p></blockquote><img src="https://oscimg.oschina.net/oscnet/up-ac8ab4cd06d150b14ddfe58e2cdcbdb7dff.png" ><p>å½“æˆ‘ä»¬çš„å¯¹è±¡é€šè¿‡hashç®—æ³•åˆ†é…åœ¨hashç¯ä¸Šçš„æ—¶å€™ï¼Œå®ƒæ˜¯å›ºå®šåˆ†é…åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„ç©ºé—´ä¸Šçš„ï¼Œå½“æˆ‘ä»¬åœ¨BCä¹‹é—´æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä»…ä»…ä¼šå½±å“åˆ°BCè¿™ä¸€æ®µç©ºé—´ä¸Šçš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç¯ä¸Šçš„æ•°æ®éƒ½è¦è·Ÿç€å˜åŒ–ï¼›</p><blockquote><p>ç°å®æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯èƒ½åˆ†é…ä¸å‡åŒ€</p></blockquote><img src="https://oscimg.oschina.net/oscnet/up-3a12f9634fed9d5f67debfcdd7fe22f1fae.png"><p>è¿™å’Œä¼ ç»Ÿçš„hashå–æ¨¡ä¸€æ ·ï¼ŒåŒæ ·ä¼šæ•°æ®å€¾æ–œçš„é—®é¢˜ï¼</p><blockquote><p>è™šæ‹ŸèŠ‚ç‚¹</p></blockquote><p>è¿™ä¸ªæ—¶å€™è™šæ‹ŸèŠ‚ç‚¹å°±æ­¤è¯ç”Ÿï¼Œä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è™šæ‹ŸèŠ‚ç‚¹åœ¨ä¸€è‡´æ€§Hashä¸­çš„ä½œç”¨ã€‚å½“æˆ‘ä»¬åœ¨Hashç¯ä¸Šæ–°å¢è‹¥å¹²ä¸ªç‚¹ï¼Œé‚£ä¹ˆæ¯ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å°±ä¼šæ¥è¿‘ç›¸ç­‰ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯æˆ‘ä»¬å¯ä»¥æ–°å¢è‹¥å¹²ä¸ªç‰‡/è¡¨ï¼Œä½†æ˜¯æˆæœ¬æœ‰é™ï¼Œæˆ‘ä»¬é€šè¿‡å¤åˆ¶å¤šä¸ªAã€Bã€Cçš„å‰¯æœ¬({A1-An},{B1-Bn},{C1-Cn})ä¸€èµ·å‚ä¸è®¡ç®—ï¼ŒæŒ‰ç…§é¡ºæ—¶é’ˆçš„æ–¹å‘è¿›è¡Œæ•°æ®åˆ†å¸ƒï¼ŒæŒ‰ç…§ä¸‹å›¾ç¤ºæ„:<br><img src="https://oscimg.oschina.net/oscnet/up-88c2aef2ec993ede090695ffe78f53f999a.png"></p><p>æ­¤æ—¶A=[A,C1)&amp;[A1,C2)&amp;[A2,B4)&amp;[A3,A4)&amp;[A4,B1)ï¼›B=[B,A1)&amp;[B2,C)&amp;[B3,C3)&amp;[B4,C4)&amp;[B1,A)ï¼›C=[C1,B)&amp;[C2,B2)&amp;[C,B3)&amp;[B3,C3)&amp;[C4,A3)ï¼›ç”±å›¾å¯ä»¥çœ‹å‡ºåˆ†å¸ƒç‚¹è¶Šå¯†é›†ï¼Œå¹³è¡¡æ€§çº¦å¥½ã€‚</p><h2 id="ç®—æ³•å®ç°"><a href="#ç®—æ³•å®ç°" class="headerlink" title="ç®—æ³•å®ç°"></a>ç®—æ³•å®ç°</h2><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰å¤šç§å…·ä½“çš„å®ç°ï¼ŒåŒ…æ‹¬ Chord ç®—æ³•ï¼ŒKAD ç®—æ³•ç­‰ï¼Œéƒ½æ¯”è¾ƒå¤æ‚ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>1 ã€<a href="https://blog.csdn.net/kefengwang/article/details/81628977">ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„åŸç†ä¸å®ç°</a><br>2ã€<a href="https://www.cnblogs.com/xialihua1023/p/10304932.html">æµ…è°ˆä¸€è‡´æ€§HashåŸç†åŠåº”ç”¨</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•&quot;&gt;&lt;a href=&quot;#ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•&quot; class=&quot;headerlink&quot; title=&quot;ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•&quot;&gt;&lt;/a&gt;ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•&lt;/h1&gt;&lt;p&gt;ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•(Consistent Hashing Algorithm)æ˜¯ä¸€ç§åˆ†å¸ƒå¼ç®—æ³•ï¼Œå¸¸ç”¨äºè´Ÿ</summary>
      
    
    
    
    <category term="Distributed Dir" scheme="http://example.com/categories/Distributed-Dir/"/>
    
    <category term="theory" scheme="http://example.com/categories/Distributed-Dir/theory/"/>
    
    
    <category term="åˆ†å¸ƒå¼" scheme="http://example.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼-CAPç†è®º</title>
    <link href="http://example.com/wiki/%E5%88%86%E5%B8%83%E5%BC%8F-CAP%E7%90%86%E8%AE%BA/"/>
    <id>http://example.com/wiki/%E5%88%86%E5%B8%83%E5%BC%8F-CAP%E7%90%86%E8%AE%BA/</id>
    <published>2021-07-28T10:15:10.000Z</published>
    <updated>2021-07-28T15:18:55.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CAP-åŸåˆ™"><a href="#CAP-åŸåˆ™" class="headerlink" title="CAP åŸåˆ™"></a>CAP åŸåˆ™</h1><p>CAPåŸåˆ™åˆç§°CAPå®šç†ï¼ŒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ã€åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ã€‚<br>CAPåŸåˆ™çš„ç²¾é«“å°±æ˜¯è¦ä¹ˆAPï¼Œè¦ä¹ˆCPï¼Œè¦ä¹ˆACï¼Œä½†æ˜¯ä¸å­˜åœ¨CAPã€‚</p><img src="https://oscimg.oschina.net/oscnet/up-1d3052b25a13428857fde791eaa01c02e9b.png"><ul><li>ä¸€è‡´æ€§ï¼ˆCï¼‰ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®å¤‡ä»½ï¼Œåœ¨åŒä¸€æ—¶åˆ»æ˜¯å¦åŒæ ·çš„å€¼ï¼Œå³å†™æ“ä½œä¹‹åçš„è¯»æ“ä½œï¼Œå¿…é¡»è¿”å›è¯¥å€¼ã€‚ï¼ˆåˆ†ä¸ºå¼±ä¸€è‡´æ€§ã€å¼ºä¸€è‡´æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§ï¼‰</li><li>å¯ç”¨æ€§ï¼ˆAï¼‰ï¼šåœ¨é›†ç¾¤ä¸­ä¸€éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœåï¼Œé›†ç¾¤æ•´ä½“æ˜¯å¦è¿˜èƒ½å“åº”å®¢æˆ·ç«¯çš„è¯»å†™è¯·æ±‚ã€‚ï¼ˆå¯¹æ•°æ®æ›´æ–°å…·å¤‡é«˜å¯ç”¨æ€§ï¼‰</li><li>åˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼‰ï¼šä»¥å®é™…æ•ˆæœè€Œè¨€ï¼Œåˆ†åŒºç›¸å½“äºå¯¹é€šä¿¡çš„æ—¶é™è¦æ±‚ã€‚ç³»ç»Ÿå¦‚æœä¸èƒ½åœ¨æ—¶é™å†…è¾¾æˆæ•°æ®ä¸€è‡´æ€§ï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†åˆ†åŒºçš„æƒ…å†µï¼Œå¿…é¡»å°±å½“å‰æ“ä½œåœ¨Cå’ŒAä¹‹é—´åšå‡ºé€‰æ‹©ã€‚</li></ul><h2 id="å–èˆç­–ç•¥"><a href="#å–èˆç­–ç•¥" class="headerlink" title="å–èˆç­–ç•¥"></a>å–èˆç­–ç•¥</h2><blockquote><p>CA without P</p></blockquote><p>å¦‚æœä¸è¦æ±‚Pï¼ˆä¸å…è®¸åˆ†åŒºï¼‰ï¼Œåˆ™Cï¼ˆå¼ºä¸€è‡´æ€§ï¼‰å’ŒAï¼ˆå¯ç”¨æ€§ï¼‰æ˜¯å¯ä»¥ä¿è¯çš„ã€‚ä½†æ”¾å¼ƒPçš„åŒæ—¶ä¹Ÿå°±æ„å‘³ç€æ”¾å¼ƒäº†ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼èŠ‚ç‚¹å—é™ï¼Œæ²¡åŠæ³•éƒ¨ç½²å­èŠ‚ç‚¹ï¼Œè¿™æ˜¯è¿èƒŒåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„åˆè¡·çš„ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“RDBMSï¼šOracleã€MySQLå°±æ˜¯CAã€‚</p><blockquote><p>CP without A</p></blockquote><p>å¦‚æœä¸è¦æ±‚Aï¼ˆå¯ç”¨ï¼‰ï¼Œç›¸å½“äºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åœ¨æœåŠ¡å™¨ä¹‹é—´ä¿æŒå¼ºä¸€è‡´ï¼Œè€ŒPï¼ˆåˆ†åŒºï¼‰ä¼šå¯¼è‡´åŒæ­¥æ—¶é—´æ— é™å»¶é•¿(ä¹Ÿå°±æ˜¯ç­‰å¾…æ•°æ®åŒæ­¥å®Œæ‰èƒ½æ­£å¸¸è®¿é—®æœåŠ¡)ï¼Œä¸€æ—¦å‘ç”Ÿç½‘ç»œæ•…éšœæˆ–è€…æ¶ˆæ¯ä¸¢å¤±ç­‰æƒ…å†µï¼Œå°±è¦<font color=red>ç‰ºç‰²ç”¨æˆ·çš„ä½“éªŒ</font>ï¼Œç­‰å¾…æ‰€æœ‰æ•°æ®å…¨éƒ¨ä¸€è‡´äº†ä¹‹åå†è®©ç”¨æˆ·è®¿é—®ç³»ç»Ÿã€‚è®¾è®¡æˆCPçš„ç³»ç»Ÿå…¶å®ä¸å°‘ï¼Œæœ€å…¸å‹çš„å°±æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚Redisã€HBaseç­‰ã€‚å¯¹äºè¿™äº›åˆ†å¸ƒå¼æ•°æ®åº“æ¥è¯´ï¼Œæ•°æ®çš„ä¸€è‡´æ€§æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ï¼Œå› ä¸ºå¦‚æœè¿è¿™ä¸ªæ ‡å‡†éƒ½è¾¾ä¸åˆ°ï¼Œé‚£ä¹ˆç›´æ¥é‡‡ç”¨å…³ç³»å‹æ•°æ®åº“å°±å¥½ï¼Œæ²¡å¿…è¦å†æµªè´¹èµ„æºæ¥éƒ¨ç½²åˆ†å¸ƒå¼æ•°æ®åº“ã€‚</p><blockquote><p>AP wihtout C</p></blockquote><p>è¦é«˜å¯ç”¨å¹¶å…è®¸åˆ†åŒºï¼Œåˆ™éœ€æ”¾å¼ƒä¸€è‡´æ€§ã€‚ä¸€æ—¦åˆ†åŒºå‘ç”Ÿï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯èƒ½ä¼šå¤±å»è”ç³»ï¼Œä¸ºäº†é«˜å¯ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æœ¬åœ°æ•°æ®æä¾›æœåŠ¡ï¼Œè€Œè¿™æ ·ä¼šå¯¼è‡´å…¨å±€æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚å…¸å‹çš„åº”ç”¨å°±å¦‚æŸç±³çš„æŠ¢è´­æ‰‹æœºåœºæ™¯ï¼Œå¯èƒ½å‰å‡ ç§’ä½ æµè§ˆå•†å“çš„æ—¶å€™é¡µé¢æç¤ºæ˜¯æœ‰åº“å­˜çš„ï¼Œå½“ä½ é€‰æ‹©å®Œå•†å“å‡†å¤‡ä¸‹å•çš„æ—¶å€™ï¼Œç³»ç»Ÿæç¤ºä½ ä¸‹å•å¤±è´¥ï¼Œå•†å“å·²å”®å®Œã€‚è¿™å…¶å®å°±æ˜¯å…ˆåœ¨ Aï¼ˆå¯ç”¨æ€§ï¼‰æ–¹é¢ä¿è¯ç³»ç»Ÿå¯ä»¥æ­£å¸¸çš„æœåŠ¡ï¼Œç„¶ååœ¨æ•°æ®çš„ä¸€è‡´æ€§æ–¹é¢åšäº†äº›ç‰ºç‰²ï¼Œè™½ç„¶å¤šå°‘ä¼šå½±å“ä¸€äº›ç”¨æˆ·ä½“éªŒï¼Œä½†ä¹Ÿä¸è‡³äºé€ æˆç”¨æˆ·è´­ç‰©æµç¨‹çš„ä¸¥é‡é˜»å¡ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆâ€”â€”BASE"><a href="#è§£å†³æ–¹æ¡ˆâ€”â€”BASE" class="headerlink" title="è§£å†³æ–¹æ¡ˆâ€”â€”BASE"></a>è§£å†³æ–¹æ¡ˆâ€”â€”BASE</h2><p>BASEæ˜¯Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ã€Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰å’ŒEventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ä¸‰ä¸ªçŸ­è¯­çš„ç®€å†™ï¼ŒBASEæ˜¯å¯¹CAPä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœã€‚</p><p>æ ¸å¿ƒæ€æƒ³ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrong consistencyï¼‰ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual consistencyï¼‰ã€‚</p><blockquote><p>åŸºæœ¬å¯ç”¨Basically Available</p></blockquote><p>åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§â€”â€”ä½†è¯·æ³¨æ„ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ï¼Œä»¥ä¸‹ä¸¤ä¸ªå°±æ˜¯â€œåŸºæœ¬å¯ç”¨â€çš„å…¸å‹ä¾‹å­ã€‚</p><p>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåœ¨çº¿æœç´¢å¼•æ“éœ€è¦0.5ç§’å†…è¿”å›ç»™ç”¨æˆ·ç›¸åº”çš„æŸ¥è¯¢ç»“æœï¼Œä½†ç”±äºå‡ºç°å¼‚å¸¸ï¼ˆæ¯”å¦‚ç³»ç»Ÿéƒ¨åˆ†æœºæˆ¿å‘ç”Ÿæ–­ç”µæˆ–æ–­ç½‘æ•…éšœï¼‰ï¼ŒæŸ¥è¯¢ç»“æœçš„å“åº”æ—¶é—´å¢åŠ åˆ°äº†1~2ç§’ã€‚<br>åŠŸèƒ½ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ä¸Šè¿›è¡Œè´­ç‰©ï¼Œæ¶ˆè´¹è€…å‡ ä¹èƒ½å¤Ÿé¡ºåˆ©åœ°å®Œæˆæ¯ä¸€ç¬”è®¢å•ï¼Œä½†æ˜¯åœ¨ä¸€äº›èŠ‚æ—¥å¤§ä¿ƒè´­ç‰©é«˜å³°çš„æ—¶å€™ï¼Œç”±äºæ¶ˆè´¹è€…çš„è´­ç‰©è¡Œä¸ºæ¿€å¢ï¼Œä¸ºäº†ä¿æŠ¤è´­ç‰©ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ã€‚</p><blockquote><p>è½¯çŠ¶æ€Soft state</p></blockquote><p>è½¯çŠ¶æ€ä¹Ÿç§°å¼±çŠ¶æ€ï¼Œå’Œç¡¬çŠ¶æ€ç›¸å¯¹ï¼Œæ˜¯æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚</p><blockquote><p>æœ€ç»ˆä¸€è‡´æ€§Eventually consistent</p></blockquote><p>æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/lixinkuan328/article/details/95535691">https://blog.csdn.net/lixinkuan328/article/details/95535691</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CAP-åŸåˆ™&quot;&gt;&lt;a href=&quot;#CAP-åŸåˆ™&quot; class=&quot;headerlink&quot; title=&quot;CAP åŸåˆ™&quot;&gt;&lt;/a&gt;CAP åŸåˆ™&lt;/h1&gt;&lt;p&gt;CAPåŸåˆ™åˆç§°CAPå®šç†ï¼ŒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailab</summary>
      
    
    
    
    <category term="Distributed Dir" scheme="http://example.com/categories/Distributed-Dir/"/>
    
    <category term="theory" scheme="http://example.com/categories/Distributed-Dir/theory/"/>
    
    
    <category term="åˆ†å¸ƒå¼" scheme="http://example.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Mysql-äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†</title>
    <link href="http://example.com/wiki/Mysql-%E4%BA%8B%E5%8A%A1%E7%89%B9%E6%80%A7%E4%B8%8E%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"/>
    <id>http://example.com/wiki/Mysql-%E4%BA%8B%E5%8A%A1%E7%89%B9%E6%80%A7%E4%B8%8E%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</id>
    <published>2021-07-28T10:13:07.000Z</published>
    <updated>2021-07-28T15:18:55.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†"><a href="#äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†" class="headerlink" title="äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†"></a>äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†</h1><h2 id="äº‹åŠ¡ç‰¹æ€§"><a href="#äº‹åŠ¡ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡ç‰¹æ€§"></a>äº‹åŠ¡ç‰¹æ€§</h2><blockquote><p>åŸå­æ€§(Atomicity)</p></blockquote><p>äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“åƒåŸå­ä¸€æ ·ä¸å¯åˆ†å‰²ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸ,è¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚</p><blockquote><p>ä¸€è‡´æ€§(Consistency)</p></blockquote><p>äº‹åŠ¡çš„æ‰§è¡Œç»“æœå¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚ä¸€è‡´æ€§çŠ¶æ€æ˜¯æŒ‡:1.ç³»ç»Ÿçš„çŠ¶æ€æ»¡è¶³æ•°æ®çš„å®Œæ•´æ€§çº¦æŸ(ä¸»ç ,å‚ç…§å®Œæ•´æ€§,checkçº¦æŸç­‰) 2.ç³»ç»Ÿçš„çŠ¶æ€ååº”æ•°æ®åº“æœ¬åº”æè¿°çš„ç°å®ä¸–ç•Œçš„çœŸå®çŠ¶æ€,æ¯”å¦‚è½¬è´¦å‰åä¸¤ä¸ªè´¦æˆ·çš„é‡‘é¢æ€»å’Œåº”è¯¥ä¿æŒä¸å˜ã€‚</p><blockquote><p>éš”ç¦»æ€§(Isolation)</p></blockquote><p>å¹¶å‘æ‰§è¡Œçš„äº‹åŠ¡ä¸ä¼šç›¸äº’å½±å“,å…¶å¯¹æ•°æ®åº“çš„å½±å“å’Œå®ƒä»¬ä¸²è¡Œæ‰§è¡Œæ—¶ä¸€æ ·ã€‚æ¯”å¦‚å¤šä¸ªç”¨æˆ·åŒæ—¶å¾€ä¸€ä¸ªè´¦æˆ·è½¬è´¦,æœ€åè´¦æˆ·çš„ç»“æœåº”è¯¥å’Œä»–ä»¬æŒ‰å…ˆåæ¬¡åºè½¬è´¦çš„ç»“æœä¸€æ ·ã€‚</p><blockquote><p>æŒä¹…æ€§(Durability)</p></blockquote><p>äº‹åŠ¡ä¸€æ—¦æäº¤,å…¶å¯¹æ•°æ®åº“çš„æ›´æ–°å°±æ˜¯æŒä¹…çš„ã€‚ä»»ä½•äº‹åŠ¡æˆ–ç³»ç»Ÿæ•…éšœéƒ½ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p><p>åœ¨äº‹åŠ¡çš„ACIDç‰¹æ€§ä¸­,Cå³ä¸€è‡´æ€§æ˜¯äº‹åŠ¡çš„æ ¹æœ¬è¿½æ±‚,è€Œå¯¹æ•°æ®ä¸€è‡´æ€§çš„ç ´åä¸»è¦æ¥è‡ªä¸¤ä¸ªæ–¹é¢<br>1.äº‹åŠ¡çš„å¹¶å‘æ‰§è¡Œ<br>2.äº‹åŠ¡æ•…éšœæˆ–ç³»ç»Ÿæ•…éšœ</p><h2 id="äº‹åŠ¡å®ç°åŸç†"><a href="#äº‹åŠ¡å®ç°åŸç†" class="headerlink" title="äº‹åŠ¡å®ç°åŸç†"></a>äº‹åŠ¡å®ç°åŸç†</h2><img src="https://oscimg.oschina.net/oscnet/up-7b54f7847cee22930ec53a4058179a2b531.png" width=460 height=300><ul><li>å¹¶å‘æ§åˆ¶æŠ€æœ¯ä¿è¯äº†äº‹åŠ¡çš„éš”ç¦»æ€§,ä½¿æ•°æ®åº“çš„ä¸€è‡´æ€§çŠ¶æ€ä¸ä¼šå› ä¸ºå¹¶å‘æ‰§è¡Œçš„æ“ä½œè¢«ç ´åã€‚</li><li>æ—¥å¿—æ¢å¤æŠ€æœ¯ä¿è¯äº†äº‹åŠ¡çš„åŸå­æ€§,ä½¿ä¸€è‡´æ€§çŠ¶æ€ä¸ä¼šå› äº‹åŠ¡æˆ–ç³»ç»Ÿæ•…éšœè¢«ç ´åã€‚åŒæ—¶ä½¿å·²æäº¤çš„å¯¹æ•°æ®åº“çš„ä¿®æ”¹ä¸ä¼šå› ç³»ç»Ÿå´©æºƒè€Œä¸¢å¤±,ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€‚</li></ul><h3 id="å›æ»šæ—¥å¿—ï¼ˆundoï¼‰"><a href="#å›æ»šæ—¥å¿—ï¼ˆundoï¼‰" class="headerlink" title="å›æ»šæ—¥å¿—ï¼ˆundoï¼‰"></a>å›æ»šæ—¥å¿—ï¼ˆundoï¼‰</h3><p>undo logå±äº ã€Œ é€»è¾‘æ—¥å¿— ã€ï¼Œå®ƒè®°å½•çš„æ˜¯sqlæ‰§è¡Œç›¸å…³çš„ä¿¡æ¯ã€‚å½“å‘ç”Ÿå›æ»šæ—¶ï¼ŒInnoDBä¼šæ ¹æ®undo logçš„å†…å®¹åšä¸ä¹‹å‰ç›¸åçš„å·¥ä½œï¼šå¯¹äºæ¯ä¸ªinsertï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œdeleteï¼›å¯¹äºæ¯ä¸ªdeleteï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œinsertï¼›å¯¹äºæ¯ä¸ªupdateï¼Œå›æ»šæ—¶ä¼šæ‰§è¡Œä¸€ä¸ªç›¸åçš„updateï¼ŒæŠŠæ•°æ®æ”¹å›å»ã€‚</p><p>undo logç”¨äºå­˜æ”¾æ•°æ®è¢«ä¿®æ”¹å‰çš„å€¼ï¼Œå¦‚æœä¿®æ”¹å‡ºç°å¼‚å¸¸ï¼Œå¯ä»¥ä½¿ç”¨undoæ—¥å¿—æ¥å®ç°å›æ»šæ“ä½œï¼Œä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚å¦å¤–InnoDB MVCCäº‹åŠ¡ç‰¹æ€§ä¹Ÿæ˜¯åŸºäºundoæ—¥å¿—å®ç°çš„ã€‚</p><p>å› æ­¤ï¼Œundo logæœ‰ä¸¤ä¸ªä½œç”¨ï¼šæä¾›å›æ»šå’Œå¤šä¸ªè¡Œç‰ˆæœ¬æ§åˆ¶(MVCC)ã€‚</p><h3 id="é‡åšæ—¥å¿—ï¼ˆredoï¼‰"><a href="#é‡åšæ—¥å¿—ï¼ˆredoï¼‰" class="headerlink" title="é‡åšæ—¥å¿—ï¼ˆredoï¼‰"></a>é‡åšæ—¥å¿—ï¼ˆredoï¼‰</h3><p>redo logé‡åšæ—¥å¿—è®°å½•çš„æ˜¯æ–°æ•°æ®çš„å¤‡ä»½ï¼Œå±äºç‰©ç†æ—¥å¿—ã€‚åœ¨äº‹åŠ¡æäº¤å‰ï¼Œåªè¦å°†redo logæŒä¹…åŒ–å³å¯ï¼Œä¸éœ€è¦å°†æ•°æ®æŒä¹…åŒ–ã€‚å½“ç³»ç»Ÿå´©æºƒæ—¶ï¼Œè™½ç„¶æ•°æ®æ²¡æœ‰æŒä¹…åŒ–ï¼Œä½†æ˜¯redo logå·²ç»æŒä¹…åŒ–ã€‚ç³»ç»Ÿå¯ä»¥æ ¹æ®redo logçš„å†…å®¹ï¼Œå°†æ‰€æœ‰æ•°æ®æ¢å¤åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚</p><p>redo logåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€æ˜¯å†…å­˜ä¸­çš„æ—¥å¿—ç¼“å†²(redo log buffer)ï¼Œè¯¥éƒ¨åˆ†æ—¥å¿—æ˜¯æ˜“å¤±æ€§çš„ï¼›äºŒæ˜¯ç£ç›˜ä¸Šçš„é‡åšæ—¥å¿—æ–‡ä»¶(redo log file)ï¼Œè¯¥éƒ¨åˆ†æ—¥å¿—æ˜¯æŒä¹…çš„ã€‚</p><p>MySQLä¸­redo logåˆ·æ–°è§„åˆ™é‡‡ç”¨ä¸€ç§ç§°ä¸ºCheckpointçš„æœºåˆ¶ï¼ˆåˆ©ç”¨LSNå®ç°ï¼‰ï¼Œä¸ºäº†ç¡®ä¿å®‰å…¨æ€§ï¼Œåˆå¼•å…¥double writeæœºåˆ¶ã€‚</p><h2 id="äº‹åŠ¡åŸºæœ¬æ“ä½œ"><a href="#äº‹åŠ¡åŸºæœ¬æ“ä½œ" class="headerlink" title="äº‹åŠ¡åŸºæœ¬æ“ä½œ"></a>äº‹åŠ¡åŸºæœ¬æ“ä½œ</h2><p>å¼€å¯äº‹åŠ¡ï¼šstart transaction<br>å›æ»šäº‹åŠ¡ï¼šrollback<br>æäº¤äº‹åŠ¡ï¼šcommit</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.cnblogs.com/f-ck-need-u/archive/2018/05/08/9010872.html">1ã€è¯¦ç»†åˆ†æMySQLäº‹åŠ¡æ—¥å¿—(redo logå’Œundo log)</a><br><a href="https://www.cnblogs.com/takumicx/p/9998844.html">2ã€æ•°æ®åº“äº‹åŠ¡çš„æ¦‚å¿µåŠå…¶å®ç°åŸç†</a><br><a href="https://zhuanlan.zhihu.com/p/281927963">3ã€æ•°æ®åº“äº‹åŠ¡å®ç°åŸç†</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†&quot;&gt;&lt;a href=&quot;#äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†&quot; class=&quot;headerlink&quot; title=&quot;äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†&quot;&gt;&lt;/a&gt;äº‹åŠ¡ç‰¹æ€§ä¸å®ç°åŸç†&lt;/h1&gt;&lt;h2 id=&quot;äº‹åŠ¡ç‰¹æ€§&quot;&gt;&lt;a href=&quot;#äº‹åŠ¡ç‰¹æ€§&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="DataBase" scheme="http://example.com/categories/DataBase/"/>
    
    <category term="MySQL" scheme="http://example.com/categories/DataBase/MySQL/"/>
    
    
    <category term="MySQL" scheme="http://example.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Mysql-äº‹åŠ¡éš”ç¦»çº§åˆ«</title>
    <link href="http://example.com/wiki/Mysql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"/>
    <id>http://example.com/wiki/Mysql-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/</id>
    <published>2021-07-28T10:12:49.000Z</published>
    <updated>2021-07-28T15:19:02.293Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ•°æ®åº“éš”ç¦»çº§åˆ«"><a href="#æ•°æ®åº“éš”ç¦»çº§åˆ«" class="headerlink" title="æ•°æ®åº“éš”ç¦»çº§åˆ«"></a>æ•°æ®åº“éš”ç¦»çº§åˆ«</h1><p>SQLæ ‡å‡†å®šä¹‰äº†4ç±»éš”ç¦»çº§åˆ«ï¼ŒåŒ…æ‹¬äº†ä¸€äº›å…·ä½“è§„åˆ™ï¼Œç”¨æ¥é™å®šäº‹åŠ¡å†…å¤–çš„å“ªäº›æ”¹å˜æ˜¯å¯è§çš„ï¼Œå“ªäº›æ˜¯ä¸å¯è§çš„ã€‚ä½çº§åˆ«çš„éš”ç¦»çº§ä¸€èˆ¬æ”¯æŒæ›´é«˜çš„å¹¶å‘å¤„ç†ï¼Œå¹¶æ‹¥æœ‰æ›´ä½çš„ç³»ç»Ÿå¼€é”€ã€‚å¦å¤–ï¼Œè¿™ç¯‡åˆ†å¸ƒå¼äº‹åŠ¡ä¸ç†è§£ï¼Ÿä¸€æ¬¡ç»™ä½ è®²æ¸…æ¥šï¼æ¨èå¤§å®¶é˜…è¯»ã€‚</p><blockquote><p>Read Uncommittedï¼ˆè¯»å–æœªæäº¤å†…å®¹ï¼‰</p></blockquote><p>åœ¨è¯¥éš”ç¦»çº§åˆ«ï¼Œæ‰€æœ‰äº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“æœã€‚æœ¬éš”ç¦»çº§åˆ«å¾ˆå°‘ç”¨äºå®é™…åº”ç”¨ï¼Œå› ä¸ºå®ƒçš„æ€§èƒ½ä¹Ÿä¸æ¯”å…¶ä»–çº§åˆ«å¥½å¤šå°‘ã€‚è¯»å–æœªæäº¤çš„æ•°æ®ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºè„è¯»ï¼ˆDirty Readï¼‰ã€‚</p><blockquote><p>Read Committedï¼ˆè¯»å–æäº¤å†…å®¹ï¼‰</p></blockquote><p>è¿™æ˜¯å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†ä¸æ˜¯MySQLé»˜è®¤çš„ï¼‰ã€‚å®ƒæ»¡è¶³äº†éš”ç¦»çš„ç®€å•å®šä¹‰ï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½çœ‹è§å·²ç»æäº¤äº‹åŠ¡æ‰€åšçš„æ”¹å˜ã€‚è¿™ç§éš”ç¦»çº§åˆ« ä¹Ÿæ”¯æŒæ‰€è°“çš„ä¸å¯é‡å¤è¯»ï¼ˆNonrepeatable Readï¼‰ï¼Œå› ä¸ºåŒä¸€äº‹åŠ¡çš„å…¶ä»–å®ä¾‹åœ¨è¯¥å®ä¾‹å¤„ç†å…¶é—´å¯èƒ½ä¼šæœ‰æ–°çš„commitï¼Œæ‰€ä»¥åŒä¸€selectå¯èƒ½è¿”å›ä¸åŒç»“æœã€‚</p><blockquote><p>Repeatable Readï¼ˆå¯é‡è¯»ï¼‰</p></blockquote><p>è¿™æ˜¯MySQLçš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒç¡®ä¿åŒä¸€äº‹åŠ¡çš„å¤šä¸ªå®ä¾‹åœ¨å¹¶å‘è¯»å–æ•°æ®æ—¶ï¼Œä¼šçœ‹åˆ°åŒæ ·çš„æ•°æ®è¡Œã€‚ä¸è¿‡ç†è®ºä¸Šï¼Œè¿™ä¼šå¯¼è‡´å¦ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¹»è¯» ï¼ˆPhantom Readï¼‰ã€‚ç®€å•çš„è¯´ï¼Œå¹»è¯»æŒ‡å½“ç”¨æˆ·è¯»å–æŸä¸€èŒƒå›´çš„æ•°æ®è¡Œæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡åˆåœ¨è¯¥èŒƒå›´å†…æ’å…¥äº†æ–°è¡Œï¼Œå½“ç”¨æˆ·å†è¯»å–è¯¥èŒƒå›´çš„æ•°æ®è¡Œæ—¶ï¼Œä¼šå‘ç°æœ‰æ–°çš„â€œå¹»å½±â€ è¡Œã€‚InnoDBå’ŒFalconå­˜å‚¨å¼•æ“é€šè¿‡å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiversion Concurrency Controlï¼‰æœºåˆ¶è§£å†³äº†è¯¥é—®é¢˜ã€‚</p><blockquote><p>Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰</p></blockquote><p>è¿™æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®ƒé€šè¿‡å¼ºåˆ¶äº‹åŠ¡æ’åºï¼Œä½¿ä¹‹ä¸å¯èƒ½ç›¸äº’å†²çªï¼Œä»è€Œè§£å†³å¹»è¯»é—®é¢˜ã€‚ç®€è¨€ä¹‹ï¼Œå®ƒæ˜¯åœ¨æ¯ä¸ªè¯»çš„æ•°æ®è¡Œä¸ŠåŠ ä¸Šå…±äº«é”ã€‚åœ¨è¿™ä¸ªçº§åˆ«ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡çš„è¶…æ—¶ç°è±¡å’Œé”ç«äº‰ã€‚</p><h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«äº§ç”Ÿçš„é—®é¢˜"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«äº§ç”Ÿçš„é—®é¢˜" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«äº§ç”Ÿçš„é—®é¢˜"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«äº§ç”Ÿçš„é—®é¢˜</h2><img src="https://oscimg.oschina.net/oscnet/up-ee3cb778a32220ff81103f9163d22f774b2.png"> <blockquote><p>è„è¯»(Drity Read)</p></blockquote><p>æŸä¸ªäº‹åŠ¡å·²æ›´æ–°ä¸€ä»½æ•°æ®ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡åœ¨æ­¤æ—¶è¯»å–äº†åŒä¸€ä»½æ•°æ®ï¼Œç”±äºæŸäº›åŸå› ï¼Œå‰ä¸€ä¸ªRollBackäº†æ“ä½œï¼Œåˆ™åä¸€ä¸ªäº‹åŠ¡æ‰€è¯»å–çš„æ•°æ®å°±ä¼šæ˜¯ä¸æ­£ç¡®çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">äº‹åŠ¡Aç¬¬ä¸€æ¬¡è¯»å–åˆ°price=100</span><br><span class="line">åŒæ—¶äº‹åŠ¡Bæ›´æ–°update price=120ï¼Œä½†æ˜¯æ­¤æ—¶çš„äº‹åŠ¡Bè¿˜æœªcommit</span><br><span class="line">äº‹åŠ¡Aè¯»å–çš„price=120</span><br><span class="line">äº‹åŠ¡B-&gt;rollbackæ“ä½œ</span><br><span class="line">äº‹åŠ¡Aè¯»å–åˆ°çš„æ˜¯è„æ•°æ®</span><br></pre></td></tr></table></figure><blockquote><p>ä¸å¯é‡å¤è¯»(Non-repeatable read)</p></blockquote><p>åœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡æŸ¥è¯¢ä¹‹ä¸­æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™å¯èƒ½æ˜¯ä¸¤æ¬¡æŸ¥è¯¢è¿‡ç¨‹ä¸­é—´æ’å…¥äº†ä¸€ä¸ªäº‹åŠ¡æ›´æ–°çš„åŸæœ‰çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">äº‹åŠ¡Aç¬¬ä¸€æ¬¡è¯»å–åˆ°price=100</span><br><span class="line">åŒæ—¶äº‹åŠ¡Bæ›´æ–°update price=120ï¼Œå¹¶commit</span><br><span class="line">äº‹åŠ¡Aè¯»å–çš„price=120</span><br><span class="line">äº‹åŠ¡Aå¤šæ¬¡è¯»å–çš„ç»“æœä¸ä¸€è‡´</span><br></pre></td></tr></table></figure><blockquote><p>å¹»è¯»(Phantom Read) </p></blockquote><p><font color=red >å¹»è¯»å’Œä¸å¯é‡å¤è¯»çš„åŒºåˆ«åœ¨äºï¼Œå¹»è¯»ä¸»è¦è¡¨ç°åœ¨æ•°æ®çš„åˆ é™¤å’Œæ’å…¥ï¼Œè€Œä¸å¯é‡å¤è¯»è¡¨ç°åœ¨æ•°æ®çš„æ›´æ–°ã€‚</font></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">äº‹åŠ¡Aç¬¬ä¸€æ¬¡è¯»å–åˆ°price=100</span><br><span class="line">åŒæ—¶äº‹åŠ¡Bæ›´æ–°delete price=100 è¿™æ¡è®°å½•ï¼Œå¹¶commit</span><br><span class="line">äº‹åŠ¡Aè¯»å–çš„price=100</span><br><span class="line">priceè¿™æ¡è®°å½•å·²ç»ä¸å­˜åœ¨ï¼Œä½†æ˜¯äº‹åŠ¡Aè¿˜æ˜¯å¯ä»¥è¯»å–åˆ°</span><br></pre></td></tr></table></figure><p>1ã€åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šæŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ï¼Œå¹»è¯»åªåœ¨å½“å‰è¯»ä¸‹æ‰ä¼šå‡ºç°ã€‚<br>ã€€ã€€2ã€å¹»è¯»ä¸“æŒ‡æ–°æ’å…¥çš„è¡Œï¼Œè¯»åˆ°åŸæœ¬å­˜åœ¨è¡Œçš„æ›´æ–°ç»“æœä¸ç®—ã€‚å› ä¸ºå½“å‰è¯»çš„ä½œç”¨å°±æ˜¯èƒ½è¯»åˆ°æ‰€æœ‰å·²ç»æäº¤è®°å½•çš„æœ€æ–°å€¼ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://blog.csdn.net/xiewenfeng520/article/details/99407038">1ã€mysqlæ•°æ®åº“çš„éš”ç¦»çº§åˆ«</a><br><a href="https://blog.csdn.net/sinat_15805929/article/details/91127491">2ã€MYSQLæ•°æ®åº“çš„å››ç§éš”ç¦»çº§åˆ«</a><br><a href="https://www.jianshu.com/p/c53c8ab650b5">3ã€MySQLå¹»è¯»</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ•°æ®åº“éš”ç¦»çº§åˆ«&quot;&gt;&lt;a href=&quot;#æ•°æ®åº“éš”ç¦»çº§åˆ«&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®åº“éš”ç¦»çº§åˆ«&quot;&gt;&lt;/a&gt;æ•°æ®åº“éš”ç¦»çº§åˆ«&lt;/h1&gt;&lt;p&gt;SQLæ ‡å‡†å®šä¹‰äº†4ç±»éš”ç¦»çº§åˆ«ï¼ŒåŒ…æ‹¬äº†ä¸€äº›å…·ä½“è§„åˆ™ï¼Œç”¨æ¥é™å®šäº‹åŠ¡å†…å¤–çš„å“ªäº›æ”¹å˜æ˜¯å¯è§çš„ï¼Œå“ªäº›æ˜¯ä¸å¯è§çš„</summary>
      
    
    
    
    <category term="DataBase" scheme="http://example.com/categories/DataBase/"/>
    
    <category term="MySQL" scheme="http://example.com/categories/DataBase/MySQL/"/>
    
    
  </entry>
  
</feed>
