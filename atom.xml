<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>GeekIBLi</title>
  
  <subtitle>For Coder</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2021-08-07T12:29:56.245Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>gaolei</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-é—¨é¢æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E9%97%A8%E9%9D%A2%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E9%97%A8%E9%9D%A2%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T12:27:47.000Z</published>
    <updated>2021-08-07T12:29:56.245Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—¨é¢æ¨¡å¼"><a href="#é—¨é¢æ¨¡å¼" class="headerlink" title="é—¨é¢æ¨¡å¼"></a>é—¨é¢æ¨¡å¼</h1><p>é—¨é¢æ¨¡å¼åˆå«åšå¤–è§‚æ¨¡å¼ï¼Œæä¾›ç»Ÿä¸€çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥è®¿é—®å­ç³»ç»Ÿä¸­çš„ä¸€ç¾¤æ¥å£ï¼›<br>é—¨é¢æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¥å£ï¼Œè®©å­ç³»ç»Ÿæ›´å®¹æ˜“ä½¿ç”¨ï¼›é—¨é¢æ¨¡å¼å±äºç»“æ„å‹æ¨¡å¼ï¼›  </p><h2 id="ç±»å›¾"><a href="#ç±»å›¾" class="headerlink" title="ç±»å›¾"></a>ç±»å›¾</h2><p><img src="https://oscimg.oschina.net/oscnet/up-937cef58fcd4540a37854b0eeb31cda5c06.png">  </p><h3 id="Facade-é—¨é¢ç±»"><a href="#Facade-é—¨é¢ç±»" class="headerlink" title="Facade é—¨é¢ç±»"></a>Facade é—¨é¢ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Facade</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç»§æ‰¿å„ä¸ªå­ç³»ç»ŸåŠŸèƒ½ï¼Œè¿›è¡Œå°è£…ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¸éµå¾ªå•ä¸€èŒè´£åŸåˆ™</span></span><br><span class="line">    SubSystemA subSystemA = <span class="keyword">new</span> SubSystemA();</span><br><span class="line">    SubSystemB subSystemB = <span class="keyword">new</span> SubSystemB();</span><br><span class="line">    SubSystemC subSystemC = <span class="keyword">new</span> SubSystemC();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        subSystemA.doA();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        subSystemB.doB();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doC</span><span class="params">()</span></span>&#123;</span><br><span class="line">        subSystemC.doC();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­ç³»ç»ŸA"><a href="#å­ç³»ç»ŸA" class="headerlink" title="å­ç³»ç»ŸA"></a>å­ç³»ç»ŸA</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubSystemA</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doA</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­ç³»ç»ŸB"><a href="#å­ç³»ç»ŸB" class="headerlink" title="å­ç³»ç»ŸB"></a>å­ç³»ç»ŸB</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubSystemB</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doB</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­ç³»ç»ŸC"><a href="#å­ç³»ç»ŸC" class="headerlink" title="å­ç³»ç»ŸC"></a>å­ç³»ç»ŸC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubSystemC</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doC</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸ŠFacadeç±»é›†æˆäº†ä¸‰ä¸ªå­ç³»ç»Ÿçš„ç±»ï¼Œåœ¨è‡ªå·±å®šä¹‰çš„æ–¹æ³•ä¸­ï¼Œå¹¶ä¸æ˜¯Facadeè‡ªå·±å®ç°çš„é€»è¾‘ï¼Œè€Œæ˜¯<br>è°ƒç”¨äº†å¯¹åº”å­ç³»ç»Ÿçš„æ–¹æ³•ï¼Œè¿™ç§å®ç°æ–¹å¼å«åšé—¨é¢æ¨¡å¼ï¼›æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼›  </p><p>çœ‹åˆ°è¿™æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¼¼æ›¾ç›¸è¯†å‘¢ï¼Œæ²¡é”™ï¼Œæˆ‘ä»¬å¤©å¤©éƒ½åœ¨å†™çš„Controller,Service,Daoä¸å°±æ˜¯é—¨é¢æ¨¡å¼å—ï¼Œ<br>æ²¡é”™ï¼Œåªä¸è¿‡æŠŠè¿™ç§æ–¹å¼å½¢æˆæ–¹æ³•è®ºï¼Œä¹Ÿå°±æœ‰äº†æ‰€è°“çš„é—¨é¢æ¨¡å¼ï¼  </p><h2 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><p>ä¸€äº›å•†ä¸šåšå®¢ä¼šæœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯å‘è¡¨æ–‡ç« æˆ–è€…è¯„è®ºç‚¹èµä¼šè·å¾—ä¸€äº›ç§¯åˆ†å•Šï¼Œè™šæ‹Ÿå¸å•Š,ç„¶åä¼šæœ‰ç§¯åˆ†å•†åŸï¼Œåœ¨é‡Œé¢å¯ä»¥å…è´¹çš„å…‘æ¢å•†å“ï¼Œå…¶å®å¾ˆéš¾å‡‘çš„å¤Ÿç§¯åˆ†ï¼Œä¸å¤Ÿè´¹åŠ²çš„â€¦ å¥½äº†ï¼Œç»“åˆä¼ªä»£ç æ¥ä½“éªŒé—¨é¢æ¨¡å¼ğŸ‘‡ğŸ‘‡ğŸ‘‡ï¼š  </p><p><strong>ä¸‹é¢æ˜¯ä¸€äº›æ¼”ç¤ºæ‰€éœ€è¦çš„ç±»ï¼š</strong>  </p><h3 id="å…³ç³»å›¾å¦‚ä¸‹"><a href="#å…³ç³»å›¾å¦‚ä¸‹" class="headerlink" title="å…³ç³»å›¾å¦‚ä¸‹"></a>å…³ç³»å›¾å¦‚ä¸‹</h3><p><img src="https://oscimg.oschina.net/oscnet/up-e117a07cbd9489e5a037d1e64961c1062c7.png">  </p><h3 id="PaymentService-æ”¯ä»˜æœåŠ¡"><a href="#PaymentService-æ”¯ä»˜æœåŠ¡" class="headerlink" title="PaymentService æ”¯ä»˜æœåŠ¡"></a>PaymentService æ”¯ä»˜æœåŠ¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">pay</span><span class="params">(GiftInfo giftInfo)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰£å‡&quot;</span> + giftInfo.getName() + <span class="string">&quot;ç§¯åˆ†æˆåŠŸï¼&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="QualityService-åº“å­˜æœåŠ¡"><a href="#QualityService-åº“å­˜æœåŠ¡" class="headerlink" title="QualityService åº“å­˜æœåŠ¡"></a>QualityService åº“å­˜æœåŠ¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QualityService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">(GiftInfo giftInfo)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ ¡éªŒ&quot;</span> + giftInfo.getName() + <span class="string">&quot;ç§¯åˆ†é€šè¿‡ï¼Œåº“å­˜å……è¶³ï¼&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ShipService-ç‰©æµæœåŠ¡"><a href="#ShipService-ç‰©æµæœåŠ¡" class="headerlink" title="ShipService ç‰©æµæœåŠ¡"></a>ShipService ç‰©æµæœåŠ¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShipService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doShip</span><span class="params">(GiftInfo giftInfo)</span></span>&#123;</span><br><span class="line">        System.out.println(giftInfo.getName() + <span class="string">&quot;ç”Ÿæˆç‰©æµè®¢å•&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®¢æˆ·ç«¯-éé—¨é¢æ¨¡å¼å†™æ³•"><a href="#å®¢æˆ·ç«¯-éé—¨é¢æ¨¡å¼å†™æ³•" class="headerlink" title="å®¢æˆ·ç«¯ éé—¨é¢æ¨¡å¼å†™æ³•"></a>å®¢æˆ·ç«¯ éé—¨é¢æ¨¡å¼å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    QualityService qualityService = <span class="keyword">new</span> QualityService();</span><br><span class="line">    PaymentService paymentService = <span class="keyword">new</span> PaymentService();</span><br><span class="line">    ShipService shipService = <span class="keyword">new</span> ShipService();</span><br><span class="line"></span><br><span class="line">    GiftInfo giftInfo = <span class="keyword">new</span> GiftInfo(<span class="string">&quot; ã€ŠJavaç¼–ç¨‹æ€æƒ³ã€‹ &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!qualityService.isAvailable(giftInfo))&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Quality not enough!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!paymentService.pay(giftInfo))&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Pay error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String shipNo = shipService.doShip(giftInfo);</span><br><span class="line">    System.err.println(<span class="string">&quot;Order shipNo:&quot;</span> + shipNo);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§å†™æ³•ä¼šå°†åº“å­˜ï¼Œæ”¯ä»˜å’Œç‰©æµç­‰æœåŠ¡éƒ½æš´éœ²ç»™è°ƒç”¨æ–¹ï¼Œæ˜¯å¾ˆä¸å®‰å…¨çš„ï¼Œè€Œä¸”é€ æˆå®¢æˆ·ç«¯ä¾èµ–ä¸¥é‡ï¼Œä»£ç è‡ƒè‚¿ï¼›  </p><h3 id="é—¨é¢æ¨¡å¼å†™æ³•"><a href="#é—¨é¢æ¨¡å¼å†™æ³•" class="headerlink" title="é—¨é¢æ¨¡å¼å†™æ³•"></a>é—¨é¢æ¨¡å¼å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       FacadeService facadeService = <span class="keyword">new</span> FacadeService();</span><br><span class="line">       GiftInfo giftInfo = <span class="keyword">new</span> GiftInfo(<span class="string">&quot; ã€ŠJavaç¼–ç¨‹æ€æƒ³ã€‹ &quot;</span>);</span><br><span class="line">       String shipNo = facadeService.doOrder(giftInfo);</span><br><span class="line">       System.err.println(<span class="string">&quot;Order shipNo:&quot;</span> + shipNo);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ç§å°±æ˜¯é—¨é¢æ¨¡å¼çš„å†™æ³•ğŸ‘† ï¼Œ ç›¸ä¿¡å¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰å§ï¼Œè¿™æ ·çš„è¯ï¼Œæš´éœ²ç»™å®¢æˆ·ç«¯å°±ä¸€ä¸ªè®¢å•æœåŠ¡å°±å¯ä»¥äº†ï¼</p><h2 id="é—¨é¢æ¨¡å¼çš„åº”ç”¨åœºæ™¯"><a href="#é—¨é¢æ¨¡å¼çš„åº”ç”¨åœºæ™¯" class="headerlink" title="é—¨é¢æ¨¡å¼çš„åº”ç”¨åœºæ™¯"></a>é—¨é¢æ¨¡å¼çš„åº”ç”¨åœºæ™¯</h2><ul><li><strong>å­ç³»ç»Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œå¢åŠ é—¨é¢æ¨¡å¼æä¾›ç®€å•çš„æ¥å£ï¼Œç»™ç”¨æˆ·ä½¿ç”¨ï¼›</strong></li><li><strong>æ„å»ºå¤šå±‚çš„ç³»ç»Ÿæ¥å£ï¼Œåˆ©ç”¨é—¨é¢å¯¹è±¡ä½œä¸ºæ¯å±‚çš„å…¥å£ï¼Œç®€åŒ–å±‚ä¹‹é—´çš„è°ƒç”¨</strong></li></ul><h2 id="é—¨é¢æ¨¡å¼çš„åº”ç”¨"><a href="#é—¨é¢æ¨¡å¼çš„åº”ç”¨" class="headerlink" title="é—¨é¢æ¨¡å¼çš„åº”ç”¨"></a>é—¨é¢æ¨¡å¼çš„åº”ç”¨</h2><p><code>Spring JdbcUtils</code><br><code>Mybatis configuration</code><br><code>Tomcat requestFacade responseFacade </code></p><h2 id="é—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹"><a href="#é—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹" class="headerlink" title="é—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹"></a>é—¨é¢æ¨¡å¼çš„ä¼˜ç‚¹</h2><ul><li><strong>ç®€åŒ–äº†è°ƒç”¨è¿‡ç¨‹ï¼Œæ— éœ€æ·±å…¥äº†è§£å­ç³»ç»Ÿï¼Œä»¥é˜²æ­¢ç»™å­ç³»ç»Ÿå¸¦æ¥é£é™©</strong></li></ul><p>æ ¹æ®ä¸Šé¢ç¤¼å“å…‘æ¢çš„é€»è¾‘ï¼Œç”¨æˆ·æ ¹æœ¬ä¸careä½ åº•å±‚çš„å…‘æ¢é€»è¾‘ï¼Œä»€ä¹ˆåº“å­˜å•Šï¼Œæ”¯ä»˜çŠ¶æ€å•Šï¼Œç”Ÿæˆè®¢å•é€»è¾‘ç­‰ç­‰ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œæˆ‘åªéœ€è¦ä¸€æ­¥ä¸‹å•å³å¯ï¼›  </p><ul><li><strong>å‡å°‘ç³»ç»Ÿä¾èµ–ï¼Œæ¾è€¦åˆ</strong></li></ul><p>è¿™ä¸€ç‚¹ä¹Ÿæ˜¯ç›¸å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œå®¢æˆ·ç«¯åªå…³å¿ƒçš„çš„è®¢å•æœåŠ¡å°±å¥½äº†ï¼Œå…¶ä»–çš„åº“å­˜ï¼Œä¾›åº”é“¾ç­‰éƒ½ä¸å…³ç³»ï¼›</p><ul><li><strong>æ›´å¥½çš„åˆ’åˆ†è®¿é—®å±‚æ¬¡ï¼Œæé«˜äº†å®‰å…¨æ€§</strong></li></ul><p>åˆç†çš„åˆ’åˆ†å±‚æ¬¡ï¼Œå‡å°‘åº•å±‚ç³»ç»Ÿçš„æš´éœ²ï¼Œä»…ä»…æš´éœ²ä¸€äº›å¿…è¦çš„çŠ¶æ€å’Œæ¥å£ï¼Œè¿™ä¸€ç‚¹å¤§å®¶åº”è¯¥éƒ½çŸ¥é“çš„ï¼Œåƒserviceå±‚è°ƒç”¨Daoå±‚ï¼Œè€Œä¸èƒ½åœ¨serviceå±‚ç›´æ¥è®¿é—®æ•°æ®åº“ï¼›</p><ul><li><strong>éµå¾ªè¿ªç±³ç‰¹æ³•åˆ™</strong></li></ul><h2 id="é—¨é¢æ¨¡å¼çš„ç¼ºç‚¹"><a href="#é—¨é¢æ¨¡å¼çš„ç¼ºç‚¹" class="headerlink" title="é—¨é¢æ¨¡å¼çš„ç¼ºç‚¹"></a>é—¨é¢æ¨¡å¼çš„ç¼ºç‚¹</h2><ul><li><strong>å½“å­ç³»ç»Ÿçš„åŠŸèƒ½éœ€è¦æ‰©å±•æˆ–è€…ä¿®æ”¹çš„æ—¶å€™ï¼Œä¸Šå±‚å°è£…å¯èƒ½è¦é¢ä¸´ä¿®æ”¹çš„é£é™©ï¼Œè¿™æ ·å¢åŠ äº†åæœŸçš„ç»´æŠ¤æˆæœ¬ï¼Œä¹Ÿä¸éµå¾ªå¼€é—­åŸåˆ™</strong></li><li><strong>å¯èƒ½ä¼šè¿èƒŒå•ä¸€èŒè´£åŸåˆ™</strong></li></ul><h2 id="é—¨é¢æ¨¡å¼å’Œä»£ç†æ¨¡å¼çš„åŒºåˆ«"><a href="#é—¨é¢æ¨¡å¼å’Œä»£ç†æ¨¡å¼çš„åŒºåˆ«" class="headerlink" title="é—¨é¢æ¨¡å¼å’Œä»£ç†æ¨¡å¼çš„åŒºåˆ«"></a>é—¨é¢æ¨¡å¼å’Œä»£ç†æ¨¡å¼çš„åŒºåˆ«</h2><p>ç®€å•æ¥è¯´ï¼Œé—¨é¢æ¨¡å¼å°±æ˜¯ä¸€ç§ä»£ç†æ¨¡å¼ï¼Œæ˜¯å±äºé™æ€ä»£ç†çš„æ¨¡å¼ï¼›ä½†æ˜¯å’Œé™æ€ä»£ç†åˆæœ‰ä¸€äº›åŒºåˆ«ï¼Œé—¨é¢æ¨¡å¼çš„ä¾§é‡ç‚¹åœ¨äºå¯¹åº•å±‚çš„å°è£…ï¼Œè€Œé™æ€ä»£ç†åˆ™ç»ˆäºå¯¹ä»£ç†å¯¹è±¡çš„å¢å¼ºï¼Œé™¤äº†è°ƒç”¨å—å§”æ‰˜å¯¹è±¡çš„æ–¹æ³•ä¹‹å¤–ï¼Œå¯ä»¥æ‰©å±•é¢å¤–çš„åŠŸèƒ½ï¼›<br>å¾ˆå¤šæ—¶å€™ä¼šæŠŠé—¨é¢æ¨¡å¼æ³¨å…¥æˆå•ä¾‹ï¼Œæ¯”å¦‚ä¸€äº›å…¨å±€çš„Util,è¿˜æœ‰æˆ‘ä»¬å¸¸è§çš„ä¸€äº›Controllerç­‰ç­‰ï¼›  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é—¨é¢æ¨¡å¼&quot;&gt;&lt;a href=&quot;#é—¨é¢æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;é—¨é¢æ¨¡å¼&quot;&gt;&lt;/a&gt;é—¨é¢æ¨¡å¼&lt;/h1&gt;&lt;p&gt;é—¨é¢æ¨¡å¼åˆå«åšå¤–è§‚æ¨¡å¼ï¼Œæä¾›ç»Ÿä¸€çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥è®¿é—®å­ç³»ç»Ÿä¸­çš„ä¸€ç¾¤æ¥å£ï¼›&lt;br&gt;é—¨é¢æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¥å£ï¼Œè®©å­ç³»ç»Ÿæ›´å®¹æ˜“ä½¿</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-é€‚é…å™¨æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T12:23:59.000Z</published>
    <updated>2021-08-07T12:25:54.734Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h1><p>é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰åˆå«åšå˜å‹å™¨æ¨¡å¼ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å°†ä¸€ä¸ªç±»çš„æ¥å£å˜æˆå®¢æˆ·ç«¯æ‰€æœŸæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œä»è€Œ<br>ä½¿å¾—åŸæœ¬å› æ¥å£ä¸åŒ¹é…è€Œå¯¼è‡´æ— æ³•åœ¨ä¸€èµ·å·¥ä½œçš„ä¸¤ä¸ªç±»èƒ½å¤Ÿåœ¨ä¸€èµ·å·¥ä½œï¼Œå±äºç»“æ„æ€§è®¾è®¡æ¨¡å¼çš„ä¸€ç§ï¼›</p><p>åœ¨è½¯ä»¶å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼ŒåŸºæœ¬ä¸Šä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸­é—´å±‚è§£å†³ã€‚é€‚é…å™¨æ¨¡å¼å…¶å®å°±æ˜¯ä¸€ä¸ªä¸­é—´å±‚ï¼Œé€‚é…å™¨æ¨¡å¼èµ·ç€<br>è½¬åŒ–/å§”æ‰˜çš„ä½œç”¨ï¼Œå°†ä¸€ç§æ¥å£è½¬åŒ–ä¸ºä¸¤ä¸€ç§æœåŠ¡åŠŸèƒ½æˆ–éœ€æ±‚çš„æ¥å£ã€‚</p><p>ä¸‹é¢ä¸¾ä¸ªä¾‹å­æ¥åˆ†æä¸€ä¸‹ğŸ‘‡  </p><h2 id="ç±»å›¾"><a href="#ç±»å›¾" class="headerlink" title="ç±»å›¾"></a>ç±»å›¾</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-785fc6504778eee5c2c820597c0d6e36fbd.png" style="zoom:67%;" /> å¦‚å›¾æ˜¯ä¸€ä¸ªé€‚é…å™¨æ¨¡å¼ç±»å›¾æ‰€åœ¨ğŸ‘†  <h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>å®ç°ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šä¸­é€‰æ‹©ï¼Œäºšé©¬é€Šçš„AWS,é˜¿é‡Œçš„OSSç­‰ç­‰å§ï¼Œä½†æ˜¯ä¸åŒçš„å‚å•†æœ‰è‡ªå·±çš„æ ‡å‡†æˆ–è€…API,ä½†æ˜¯åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­ä½“ç°çš„å°±æ˜¯ä¸€ä¸ªputObjectæ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦å®šä¹‰ä¸€ä¸ªCloudSDKæ ‡å‡†ï¼Œç„¶åä¸åŒçš„å‚å•†æ¥é€‚é…æˆ‘ä»¬è‡ªå·±çš„æ ‡å‡†ï¼Œåœ¨æˆ‘ä»¬çš„putObjectå’Œä¸‰æ–¹çš„SDKä¸­é—´åŠ ä¸€å±‚é€‚é…å±‚ï¼›<br>å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œä»…ä»…æ˜¯å®Œæˆæ–‡ä»¶ä¸Šä¼ çš„åŠ¨ä½œï¼Œè‡³äºä½ æœåŠ¡ç«¯åˆ°åº•ä½¿ç”¨äºšé©¬é€Šçš„æœåŠ¡è¿˜æ˜¯é˜¿é‡Œçš„æœåŠ¡ï¼Œå®ƒæ˜¯ä¸careçš„ï¼Œè¿™ä¹Ÿä½“ç°çš„ç­–ç•¥æ¨¡å¼ï¼›  æ‰€ä»¥è¿™ä¸ªä¾‹å­å…¼å¤‡å·¥å‚æ¨¡å¼+ç­–ç•¥æ¨¡å¼+é€‚é…å™¨æ¨¡å¼ï¼›  </p><h3 id="CloudController"><a href="#CloudController" class="headerlink" title="CloudController"></a>CloudController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯Springé¡¹ç›®è¿™é‡Œç›´æ¥æ³¨å…¥å°±å¯ä»¥äº†ï¼Œæ²¡å¿…è¦è¿™ä¹ˆéº»çƒ¦</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CloudController</span><span class="params">(CloudService cloudService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cloudService = cloudService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CloudService cloudService;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadFile</span><span class="params">(String fileName)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;invoke upload file service!&quot;</span> + fileName);</span><br><span class="line">        cloudService.uploadFile(fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CloudController cloudController = <span class="keyword">new</span> CloudController(<span class="keyword">new</span> CloudService(<span class="string">&quot;ali&quot;</span>));</span><br><span class="line">        cloudController.uploadFile(<span class="string">&quot;think in java&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CloudService"><a href="#CloudService" class="headerlink" title="CloudService"></a>CloudService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CloudSDK cloudSDK;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CloudService</span><span class="params">(String cloudStorage)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨å·¥å‚æ¥åˆ›å»ºå…·ä½“çš„SDK</span></span><br><span class="line">        <span class="keyword">this</span>.cloudSDK = CloudFactory.create(cloudStorage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadFile</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        cloudSDK.putObject(fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="CloudSDK-å®šä¹‰SDKæ ‡å‡†"><a href="#CloudSDK-å®šä¹‰SDKæ ‡å‡†" class="headerlink" title="CloudSDK å®šä¹‰SDKæ ‡å‡†"></a>CloudSDK å®šä¹‰SDKæ ‡å‡†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CloudSDK</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">putObject</span><span class="params">(String fileName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AWSSDKAdapter-é€‚é…CloudSDKæ ‡å‡†"><a href="#AWSSDKAdapter-é€‚é…CloudSDKæ ‡å‡†" class="headerlink" title="AWSSDKAdapter é€‚é…CloudSDKæ ‡å‡†"></a>AWSSDKAdapter é€‚é…CloudSDKæ ‡å‡†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AWSSDKAdapter</span> <span class="keyword">implements</span> <span class="title">CloudSDK</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AWSSDK awssdk;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AWSSDKAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.awssdk = <span class="keyword">new</span> AWSSDK();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        awssdk.putObject(fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AliSDKAdapteré€‚é…CloudSDKæ ‡å‡†"><a href="#AliSDKAdapteré€‚é…CloudSDKæ ‡å‡†" class="headerlink" title="AliSDKAdapteré€‚é…CloudSDKæ ‡å‡†"></a>AliSDKAdapteré€‚é…CloudSDKæ ‡å‡†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliSDKAdapter</span> <span class="keyword">implements</span> <span class="title">CloudSDK</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AliSDK aliSDK;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AliSDKAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.aliSDK = <span class="keyword">new</span> AliSDK();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•å°±æ˜¯é€‚é…å™¨çš„æ ‡å‡† ä¸ç®¡ä½ çš„ä¸‰æ–¹æœåŠ¡éœ€è¦å¤šå°‘æ¥å£ï¼Œæ˜¯è¦å®ç°äº‘ä¸Šä¼ ï¼Œç»Ÿä¸€é€šè¿‡putObjectè¿™ä¸ªæ¥å£å®ç°å°±å¯ä»¥</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        aliSDK.setBucket();</span><br><span class="line">        aliSDK.uploadFile(fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AWSSDK-ä¸‰æ–¹SDK"><a href="#AWSSDK-ä¸‰æ–¹SDK" class="headerlink" title="AWSSDK ä¸‰æ–¹SDK"></a>AWSSDK ä¸‰æ–¹SDK</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AWSSDK</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸€èˆ¬ä»¥JARçš„æ–¹å¼å¼•å…¥åˆ°é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¯èƒ½å»ä¿®æ”¹ä¸‰æ–¹çš„SDK,è¿™æ˜¯å„ä¸ªå‚å•†åˆ¶å®šçš„è‡ªå·±çš„æ ‡å‡†</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(String fileName)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;aws upload file &quot;</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AliSDK-ä¸‰æ–¹SDK"><a href="#AliSDK-ä¸‰æ–¹SDK" class="headerlink" title="AliSDK ä¸‰æ–¹SDK"></a>AliSDK ä¸‰æ–¹SDK</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliSDK</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸€èˆ¬ä»¥JARçš„æ–¹å¼å¼•å…¥åˆ°é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¯èƒ½å»ä¿®æ”¹ä¸‰æ–¹çš„SDK,è¿™æ˜¯å„ä¸ªå‚å•†åˆ¶å®šçš„è‡ªå·±çš„æ ‡å‡†</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBucket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Ali oss set bucket!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadFile</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Ali oss upload file!&quot;</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CloudFactory"><a href="#CloudFactory" class="headerlink" title="CloudFactory"></a>CloudFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯å†™æ­»äº† ç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶çš„æ–¹å¼æˆ–è€…å¯åŠ¨åŠ è½½ç­‰ç­‰æ–¹å¼å®ç°ï¼Œæœ‰å¾ˆå¤š</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, CloudSDK&gt; sdkMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ€»ä¹‹è¦ç¬¦åˆå¼€é—­åŸåˆ™ å¯¹ä¿®æ”¹å…³é—­</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        sdkMap.put(<span class="string">&quot;ali&quot;</span>, <span class="keyword">new</span> AliSDKAdapter());</span><br><span class="line">        sdkMap.put(<span class="string">&quot;aws&quot;</span>, <span class="keyword">new</span> AWSSDKAdapter());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€šè¿‡ä¸åŒçš„ç­–ç•¥ç”Ÿæˆå…·ä½“çš„SDKå®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CloudSDK <span class="title">create</span><span class="params">(String storage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sdkMap.get(storage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é€‚é…å™¨å’Œè£…é¥°å™¨æ¨¡å¼çš„åŒºåˆ«"><a href="#é€‚é…å™¨å’Œè£…é¥°å™¨æ¨¡å¼çš„åŒºåˆ«" class="headerlink" title="é€‚é…å™¨å’Œè£…é¥°å™¨æ¨¡å¼çš„åŒºåˆ«"></a>é€‚é…å™¨å’Œè£…é¥°å™¨æ¨¡å¼çš„åŒºåˆ«</h2><p>é€‚é…å™¨æ¨¡å¼å’Œè£…é¥°å™¨æ¨¡å¼éƒ½æ˜¯åŒ…è£…å™¨æ¨¡å¼ï¼Œè£…é¥°å™¨æ¨¡å¼å…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„ä»£ç†æ¨¡å¼ï¼›</p><table><thead><tr><th>å¯¹æ¯”ç»´åº¦</th><th>é€‚é…å™¨æ¨¡å¼</th><th>è£…é¥°å™¨æ¨¡å¼</th></tr></thead><tbody><tr><td>å½¢å¼</td><td>æ²¡æœ‰å±‚çº§å…³ç³»</td><td>ä¸€ç§éå¸¸ç‰¹åˆ«çš„ä»£ç†æ¨¡å¼ï¼Œå…·æœ‰å±‚çº§å…³ç³»</td></tr><tr><td>å®šä¹‰</td><td>é€‚é…å™¨å’Œè¢«é€‚é…è€…æ²¡æœ‰å¿…ç„¶çš„è”ç³»ï¼Œé€šå¸¸é‡‡ç”¨ç»§æ‰¿æˆ–ä»£ç†çš„æ–¹å¼è¿›è¡ŒåŒ…è£…</td><td>è£…é¥°å™¨å’Œè¢«è£…é¥°è€…éƒ½å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œä¸»è¦ç›®çš„æ˜¯æ‰©å±•ä¹‹åä¾æ—§ä¿ç•™OOPå…³ç³»</td></tr><tr><td>å…³ç³»</td><td>æ²¡æœ‰æ»¡è¶³has-açš„å…³ç³»</td><td>æ»¡è¶³is-aå…³ç³»</td></tr><tr><td>åŠŸèƒ½</td><td>æ³¨é‡å…¼å®¹ã€è½¬æ¢</td><td>æ³¨é‡è¦†ç›–ã€æ‰©å±•</td></tr><tr><td>è®¾è®¡</td><td>åç½®è€ƒè™‘</td><td>å‰ç½®è€ƒè™‘</td></tr></tbody></table><h2 id="é€‚é…å™¨åŠŸèƒ½çš„ä¼˜ç‚¹-âœ…"><a href="#é€‚é…å™¨åŠŸèƒ½çš„ä¼˜ç‚¹-âœ…" class="headerlink" title="é€‚é…å™¨åŠŸèƒ½çš„ä¼˜ç‚¹ âœ…"></a>é€‚é…å™¨åŠŸèƒ½çš„ä¼˜ç‚¹ âœ…</h2><ul><li><strong>èƒ½æé«˜ç±»çš„é€æ˜æ€§å’Œå¤ç”¨ï¼Œä½†ç°æœ‰çš„ç±»å¤ç”¨ä¸éœ€è¦æ”¹å˜</strong>  </li><li><strong>é€‚é…å™¨ç±»å’ŒåŸè§’è‰²è§£è€¦ï¼ŒæŠ•ç¨¿ç¨‹åºçš„æ‰©å±•æ€§</strong></li><li><strong>åœ¨å¾ˆå¤šä¸šåŠ¡ä¸­ç¬¦åˆå¼€é—­åŸåˆ™</strong>  </li></ul><h2 id="é€‚é…å™¨çš„ç¼ºç‚¹"><a href="#é€‚é…å™¨çš„ç¼ºç‚¹" class="headerlink" title="é€‚é…å™¨çš„ç¼ºç‚¹"></a>é€‚é…å™¨çš„ç¼ºç‚¹</h2><ul><li><strong>é€‚é…å™¨ç¼–å†™è¿‡ç¨‹éœ€è¦ç»“åˆä¸šåŠ¡åœºæ™¯ç»¼åˆè€ƒè™‘ï¼Œå¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§</strong></li><li><strong>å¢åŠ ä»£ç é˜…è¯»éš¾åº¦ï¼Œé™ä½ä»£ç å¯è¯»æ€§ï¼Œè¿‡å¤šçš„é€‚é…å™¨ä¼šä½¿å¾—ç³»ç»Ÿä»£ç å˜å¾—ç´Šä¹±</strong></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é€‚é…å™¨æ¨¡å¼&quot;&gt;&lt;a href=&quot;#é€‚é…å™¨æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;é€‚é…å™¨æ¨¡å¼&quot;&gt;&lt;/a&gt;é€‚é…å™¨æ¨¡å¼&lt;/h1&gt;&lt;p&gt;é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰åˆå«åšå˜å‹å™¨æ¨¡å¼ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å°†ä¸€ä¸ªç±»çš„æ¥å£å˜æˆå®¢æˆ·ç«¯æ‰€æœŸæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œ</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-è´£ä»»é“¾æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T12:21:01.000Z</published>
    <updated>2021-08-07T12:23:18.865Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è´£ä»»é“¾æ¨¡å¼"><a href="#è´£ä»»é“¾æ¨¡å¼" class="headerlink" title="è´£ä»»é“¾æ¨¡å¼"></a>è´£ä»»é“¾æ¨¡å¼</h1><p>è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patterï¼‰æ˜¯å°†é“¾ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¤„ç†çš„è¯·æ±‚å‡ä¸ç›¸åŒï¼Œ<br>å¹¶ä¸”å†…éƒ¨è‡ªåŠ¨ç»´æŠ¤ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡ã€‚å½“ä¸€ä¸ªè¯·æ±‚ä»é“¾çš„å¤´éƒ¨å‘å‡ºæ—¶ï¼Œä¼šæ²¿ç€é“¾çš„è·¯å¾„ä¸€æ¬¡ä¼ é€’ç»™æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡ï¼Œç›´åˆ°æœ‰èŠ‚ç‚¹å¤„ç†è¿™ä¸ªè¯·æ±‚ä¸ºæ­¢ï¼›è´£ä»»é“¾æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼</p><h2 id="ç±»å›¾"><a href="#ç±»å›¾" class="headerlink" title="ç±»å›¾"></a>ç±»å›¾</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-346d95211f8ced1530fe1098a480a35a535.png" style="zoom:67%;" />  <h3 id="Handler-è´£ä»»é“¾æŠ½è±¡ç±»-é“¾å¼ç»“æ„"><a href="#Handler-è´£ä»»é“¾æŠ½è±¡ç±»-é“¾å¼ç»“æ„" class="headerlink" title="Handler è´£ä»»é“¾æŠ½è±¡ç±» é“¾å¼ç»“æ„"></a>Handler è´£ä»»é“¾æŠ½è±¡ç±» é“¾å¼ç»“æ„</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Handler nextHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(Handler nextHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextHandler = nextHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(String request)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcreteHandlerA-èŠ‚ç‚¹å¯¹è±¡A"><a href="#ConcreteHandlerA-èŠ‚ç‚¹å¯¹è±¡A" class="headerlink" title="ConcreteHandlerA èŠ‚ç‚¹å¯¹è±¡A"></a>ConcreteHandlerA èŠ‚ç‚¹å¯¹è±¡A</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteHandlerA</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(String request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;reqA&quot;</span>.equals(request)) &#123;</span><br><span class="line">            System.err.println(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">&quot;deal this request &quot;</span> + request);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.nextHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nextHandler.handleRequest(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ConcreteHandlerB-èŠ‚ç‚¹å¯¹è±¡B"><a href="#ConcreteHandlerB-èŠ‚ç‚¹å¯¹è±¡B" class="headerlink" title="ConcreteHandlerB èŠ‚ç‚¹å¯¹è±¡B"></a>ConcreteHandlerB èŠ‚ç‚¹å¯¹è±¡B</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteHandlerB</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(String request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;reqB&quot;</span>.equals(request)) &#123;</span><br><span class="line">            System.err.println(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">&quot;deal this request &quot;</span> + request);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.nextHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nextHandler.handleRequest(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DemoTest-æµ‹è¯•ç±»"><a href="#DemoTest-æµ‹è¯•ç±»" class="headerlink" title="DemoTest æµ‹è¯•ç±»"></a>DemoTest æµ‹è¯•ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Handler handlerA = <span class="keyword">new</span> ConcreteHandlerA();</span><br><span class="line">        Handler handlerB = <span class="keyword">new</span> ConcreteHandlerB();</span><br><span class="line">        handlerA.setNextHandler(handlerB);</span><br><span class="line">        handlerA.handleRequest(<span class="string">&quot;reqB&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">//ConcreteHandlerBdeal this request reqB</span></span><br></pre></td></tr></table></figure><h2 id="ä¸šåŠ¡"><a href="#ä¸šåŠ¡" class="headerlink" title="ä¸šåŠ¡"></a>ä¸šåŠ¡</h2><p>ä¸‹é¢æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¸šåŠ¡åœºæ™¯çš„ä¾‹å­ğŸŒ°æ¥å±•ç¤ºä¸€ä¸‹ä»€ä¹ˆæ˜¯è´£ä»»é“¾æ¨¡å¼ï¼š<br>æˆ‘ä»¬ç™»å½•æ—¶ï¼Œè‚¯å®šè¦æ ¡éªŒç”¨æˆ·åå’Œå¯†ç æœ‰æ²¡æœ‰ä¼ å‚ï¼Œå¦‚æœå‚æ•°éƒ½æ˜¯ç©ºçš„è¯ï¼Œé‚£ä¹Ÿæ²¡æœ‰å¿…è¦æ‰§è¡Œåé¢çš„ç™»å½•éƒ¨åˆ†ï¼Œç›´æ¥è¿”å›äº†ï¼›å¦‚æœå‚æ•°æ˜¯åˆæ³•çš„ï¼Œé‚£æˆ‘ä»¬å°±è¦æ ¡éªŒæ•°æ®åº“æ˜¯å¦å­˜åœ¨è¿™ä¸ªç”¨æˆ·äº†ï¼Œå¦‚æœä¸å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œé‚£å°±ç›´æ¥è¿”å›ï¼›å¦‚æœå­˜åœ¨ï¼Œé‚£å°±è¦æ ¡éªŒç”¨æˆ·æœ‰æ²¡æœ‰æƒé™è®¿é—®æ­£åœ¨è¯·æ±‚çš„èµ„æºï¼Œå¦‚æœæœ‰æƒé™ï¼Œåˆ™å¯ä»¥æ­£å¸¸è®¿é—®èµ„æºï¼Œå¦‚æœæ²¡æœ‰æƒé™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼›  </p><h3 id="éè´£ä»»é“¾æ¨¡å¼å†™æ³•"><a href="#éè´£ä»»é“¾æ¨¡å¼å†™æ³•" class="headerlink" title="éè´£ä»»é“¾æ¨¡å¼å†™æ³•"></a>éè´£ä»»é“¾æ¨¡å¼å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»¥ä¸‹æ˜¯ä¼ªä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(String userName,String pwd)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userName) || StringUtils.isEmpty(pwd))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Member member = selectUser(userName,pwd);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(member))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!validateRoot(member))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        System.err.println(<span class="string">&quot;Login success!&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§å†™æ³•è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å°†æ‰€æœ‰çš„æ“ä½œå…¨éƒ¨æ‚ç³…åœ¨ä¸€èµ·äº†ï¼Œç»“æ„æ˜¯ååˆ†æ··ä¹±çš„ï¼›<br>ä¸‹é¢ğŸ‘‡çœ‹ä¸€ä¸‹å¦‚æœä½¿ç”¨è´£ä»»é“¾æ¨¡å¼è¯¥å¦‚ä½•å®ç°ï¼š<br><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-f94e4e83f493d7a998e1e8bbb36f3c8eb4b.png" style="zoom:67%;" /> </p><h3 id="Handler-æŠ½è±¡è´£ä»»é“¾å¤„ç†å™¨"><a href="#Handler-æŠ½è±¡è´£ä»»é“¾å¤„ç†å™¨" class="headerlink" title="Handler æŠ½è±¡è´£ä»»é“¾å¤„ç†å™¨"></a>Handler æŠ½è±¡è´£ä»»é“¾å¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> Handler next;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">next</span><span class="params">(Handler next)</span></span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.next = next;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doHandler</span><span class="params">(Member member)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ValidateHandler-å‚æ•°æ ¡éªŒå¤„ç†å™¨"><a href="#ValidateHandler-å‚æ•°æ ¡éªŒå¤„ç†å™¨" class="headerlink" title="ValidateHandler å‚æ•°æ ¡éªŒå¤„ç†å™¨"></a>ValidateHandler å‚æ•°æ ¡éªŒå¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHandler</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(member.getLoginName()) || StringUtils.isEmpty(member.getLoginPass()))&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;ç™»å½•åæˆ–è€…å¯†ç ä¸ºç©ºï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.err.println(<span class="string">&quot;å‚æ•°æ ¡éªŒæˆåŠŸï¼&quot;</span>);</span><br><span class="line">        next.doHandler(member);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç™»å½•å¤„ç†å™¨"><a href="#ç™»å½•å¤„ç†å™¨" class="headerlink" title="ç™»å½•å¤„ç†å™¨"></a>ç™»å½•å¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHandler</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;login success!&quot;</span>);</span><br><span class="line">        member.setRoleName(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        next.doHandler(member);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é‰´æƒå¤„ç†å™¨"><a href="#é‰´æƒå¤„ç†å™¨" class="headerlink" title="é‰´æƒå¤„ç†å™¨"></a>é‰´æƒå¤„ç†å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHandler</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;root&quot;</span>.equals(member.getRoleName()))&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Auth success!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.err.println(<span class="string">&quot;Auth failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Memberæˆå‘˜ç±»"><a href="#Memberæˆå‘˜ç±»" class="headerlink" title="Memberæˆå‘˜ç±»"></a>Memberæˆå‘˜ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String loginName;</span><br><span class="line">    <span class="keyword">private</span> String loginPass;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Member</span><span class="params">(String loginName, String loginPass)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.loginName = loginName;</span><br><span class="line">            <span class="keyword">this</span>.loginPass = loginPass;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GETTER SETTER ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DemoTest-æµ‹è¯•ç±»-1"><a href="#DemoTest-æµ‹è¯•ç±»-1" class="headerlink" title="DemoTest æµ‹è¯•ç±»"></a>DemoTest æµ‹è¯•ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆåˆ›å»ºæ‰€æœ‰çš„å¤„ç†å™¨ï¼Œè®¾ç½®åå®ƒä»¬çš„å…ˆåé¡ºåºï¼Œè®¾ç½®nextèŠ‚ç‚¹ï¼Œå®Œæˆä¹‹ååœ¨æ‰§è¡Œé“¾è·¯æ“ä½œï¼›</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ValidateHandler validateHandler = <span class="keyword">new</span> ValidateHandler();</span><br><span class="line">        LoginHandler loginHandler = <span class="keyword">new</span> LoginHandler();</span><br><span class="line">        validateHandler.next(loginHandler);</span><br><span class="line">        AuthHandler authHandler = <span class="keyword">new</span> AuthHandler();</span><br><span class="line">        loginHandler.next(authHandler);</span><br><span class="line">        Member member = <span class="keyword">new</span> Member(<span class="string">&quot;xiaoming&quot;</span>, <span class="string">&quot;222&quot;</span>);</span><br><span class="line">        validateHandler.doHandler(member);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å†™æ³•ï¼Œçœ‹èµ·æ¥æœ‰æ²¡æœ‰æ¯”éè´£ä»»é“¾å†™æ³•è¦Bæ ¼é«˜ä¸€äº›ï¼Œä½†æ˜¯ï¼Œè¿™æ ·æ¯æ¬¡åˆ›å»ºèŠ‚ç‚¹å¯¹è±¡ï¼Œå¥½åƒåˆæ˜¾å¾—ä¸å¤ªçˆ½ï¼Œæœ‰äº›è‡ƒè‚¿çš„æ„æ€ï¼è€Œä¸”è°ƒæ•´èŠ‚ç‚¹ä¹‹é—´çš„é¡ºåºæ—¶ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œå®¹æ˜“æ”¹é”™ï¼ é‚£æˆ‘ä»¬å°±è¿›ä¸€æ­¥ä¼˜åŒ–ä»¥ä¸‹å§ï¼  </p><h2 id="è´£ä»»é“¾æ¨¡å¼-å»ºé€ è€…æ¨¡å¼-ä¼˜åŒ–"><a href="#è´£ä»»é“¾æ¨¡å¼-å»ºé€ è€…æ¨¡å¼-ä¼˜åŒ–" class="headerlink" title="è´£ä»»é“¾æ¨¡å¼+å»ºé€ è€…æ¨¡å¼ ä¼˜åŒ–"></a>è´£ä»»é“¾æ¨¡å¼+å»ºé€ è€…æ¨¡å¼ ä¼˜åŒ–</h2><h3 id="æ·»åŠ å»ºé€ å™¨builder"><a href="#æ·»åŠ å»ºé€ å™¨builder" class="headerlink" title="æ·»åŠ å»ºé€ å™¨builder"></a>æ·»åŠ å»ºé€ å™¨builder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Handler next;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">next</span><span class="params">(Handler next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doHandler</span><span class="params">(Member member)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æš´éœ²å»ºé€ å™¨ï¼Œå°†èŠ‚ç‚¹å¯¹è±¡ä»¥é“¾è¡¨çš„å½¢å¼ä¸²èµ·æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Handler&lt;T&gt; head;</span><br><span class="line">        <span class="keyword">private</span> Handler&lt;T&gt; tail;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Handler&lt;T&gt; <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.head;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder&lt;T&gt; <span class="title">addHandler</span><span class="params">(Handler&lt;T&gt; handler)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.head == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.head = <span class="keyword">this</span>.tail = handler;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.tail.next(handler);</span><br><span class="line">            <span class="keyword">this</span>.tail = handler;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Member member = <span class="keyword">new</span> Member(<span class="string">&quot;xiaoming&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        Handler.Builder&lt;Handler&gt; builder = <span class="keyword">new</span> Handler.Builder();</span><br><span class="line">        builder.addHandler(<span class="keyword">new</span> ValidateHandler())</span><br><span class="line">                .addHandler(<span class="keyword">new</span> LoginHandler())</span><br><span class="line">                .addHandler(<span class="keyword">new</span> AuthHandler())</span><br><span class="line">                .build()</span><br><span class="line">        .doHandler(member);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ·»åŠ å»ºé€ å™¨ä¹‹åï¼Œè´£ä»»é“¾çš„ç»„è£…ä¸è°ƒç”¨æ˜¯ä¸æ˜¯æ˜¾å¾—å¾ˆæ¸…æ™°ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯¹è±¡å„å¸å…¶èŒï¼Œå¦‚æœéœ€è¦æœ¬èŠ‚ç‚¹æ‰§è¡Œï¼Œåˆ™æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™äº¤ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç»§ç»­ï¼  </p><h2 id="è´£ä»»é“¾é€‚ç”¨çš„åœºæ™¯"><a href="#è´£ä»»é“¾é€‚ç”¨çš„åœºæ™¯" class="headerlink" title="è´£ä»»é“¾é€‚ç”¨çš„åœºæ™¯"></a>è´£ä»»é“¾é€‚ç”¨çš„åœºæ™¯</h2><ul><li><strong>å¤šä¸ªå¯¹è±¡å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œä½†å…·ä½“ç”±é‚£ä¸ªå¯¹è±¡å¤„ç†åˆ™åœ¨è¿åŠ¨æ—¶åŠ¨æ€å†³å®š</strong></li><li><strong>åœ¨ä¸æ˜ç¡®ğŸˆ¯æŒ‡å®šæ¥å—è€…çš„æƒ…å†µä¸‹ï¼Œå‘å¤šä¸ªå¯¹è±¡çš„ä¸€ä¸ªæäº¤è¯·æ±‚</strong></li><li><strong>å¯ä»¥åŠ¨æ€æŒ‡å®šä¸€ç»„å¯¹è±¡å¤„ç†è¯·æ±‚</strong></li></ul><blockquote><p>ä¸¾ä¸€äº›å®é™…çš„ä¾‹å­ï¼š<br>javax.servlet.Filterçš„doFilteræ–¹æ³•å°±æ˜¯ä½¿ç”¨çš„è´£ä»»é“¾æ¨¡å¼;</p></blockquote><h3 id="org-springframework-web-filter-CompositeFilter-doFilter"><a href="#org-springframework-web-filter-CompositeFilter-doFilter" class="headerlink" title="org.springframework.web.filter.CompositeFilter#doFilter"></a>org.springframework.web.filter.CompositeFilter#doFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> CompositeFilter.VirtualFilterChain(chain, <span class="keyword">this</span>.filters)).doFilter(request, response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªå®ç°(javax.servlet.Filter),ä¸‹é¢å±•å¼€å…·ä½“çš„ä»£ç ï¼š</p><h3 id="org-springframework-web-filter-CompositeFilter"><a href="#org-springframework-web-filter-CompositeFilter" class="headerlink" title="org.springframework.web.filter.CompositeFilter"></a>org.springframework.web.filter.CompositeFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Filter è¿™é‡Œçš„Filterç›¸å½“äºå¤„ç†èŠ‚ç‚¹ï¼Œå­˜æ”¾åœ¨Listä¸­ï¼Œå’Œæˆ‘ä»¬ä¸Šé¢çš„Handlerå­˜æ”¾åœ¨å»ºé€ è€…çš„é“¾å¼ç»“æ„ä¸­ï¼Œå¼‚æ›²åŒå·¥ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;? extends Filter&gt; filters = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CompositeFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilters</span><span class="params">(List&lt;? extends Filter&gt; filters)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filters = <span class="keyword">new</span> ArrayList(filters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        Iterator var2 = <span class="keyword">this</span>.filters.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">            Filter filter = (Filter)var2.next();</span><br><span class="line">            filter.init(config);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> CompositeFilter.VirtualFilterChain(chain, <span class="keyword">this</span>.filters)).doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="keyword">this</span>.filters.size();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(i-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Filter filter = (Filter)<span class="keyword">this</span>.filters.get(i);</span><br><span class="line">            filter.destroy();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VirtualFilterChain</span> <span class="keyword">implements</span> <span class="title">FilterChain</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FilterChain originalChain;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;? extends Filter&gt; additionalFilters;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> currentPosition = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">VirtualFilterChain</span><span class="params">(FilterChain chain, List&lt;? extends Filter&gt; additionalFilters)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.originalChain = chain;</span><br><span class="line">            <span class="keyword">this</span>.additionalFilters = additionalFilters;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.currentPosition == <span class="keyword">this</span>.additionalFilters.size()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.originalChain.doFilter(request, response);</span><br><span class="line">            <span class="comment">// é€šè¿‡currentPositionçš„ç§»åŠ¨ï¼Œè½¬ç§»åˆ°é“¾è·¯ä¸Šçš„ä¸åŒå¤„ç†èŠ‚ç‚¹ï¼Œè¿™å°±æ˜¯è´£ä»»é“¾æ¨¡å¼çš„ä½“ç°</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ++<span class="keyword">this</span>.currentPosition;</span><br><span class="line">                Filter nextFilter = (Filter)<span class="keyword">this</span>.additionalFilters.get(<span class="keyword">this</span>.currentPosition - <span class="number">1</span>);</span><br><span class="line">                nextFilter.doFilter(request, response, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åƒä¸Šé¢çš„ä¾‹å­è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šï¼Œæ¯”å¦‚Spring Securityå’ŒShiroä¸­çš„æ‹¦æˆªå™¨å°±æ˜¯å¾ˆå…¸å‹çš„è´£ä»»é“¾æ¨¡å¼ï¼Œè¿˜æœ‰Nettyä¸­çš„ io.netty.channel.ChannelPipelineç­‰ç­‰ï¼Œéƒ½æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼›  </p><h2 id="è´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹ğŸ‘ğŸ‘ğŸ‘"><a href="#è´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹ğŸ‘ğŸ‘ğŸ‘" class="headerlink" title="è´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹ğŸ‘ğŸ‘ğŸ‘"></a>è´£ä»»é“¾æ¨¡å¼çš„ä¼˜ç‚¹ğŸ‘ğŸ‘ğŸ‘</h2><ul><li><strong>å°†è¯·æ±‚ä¸å¤„ç†è§£è€¦</strong></li><li><strong>è¯·æ±‚å¤„ç†è€…ï¼ˆèŠ‚ç‚¹å¯¹è±¡ï¼‰åªéœ€è¦å…³æ³¨è‡ªå·±æ„Ÿå…´è¶£çš„è¯·æ±‚è¿›è¡Œå¤„ç†å³å¯ï¼Œå¯¹äºä¸æ„Ÿå…´è¶£çš„è¯·æ±‚ï¼Œç›´æ¥è½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¯¹è±¡</strong></li><li><strong>å…·å¤‡é“¾å¼ä¼ é€’å¤„ç†è¯·æ±‚åŠŸèƒ½ï¼Œè¯·æ±‚å‘é€è€…æ— éœ€çŸ¥æ™“é“¾è·¯ç»“æ„ï¼Œåªéœ€ç­‰å¾…å¤„ç†è¯·æ±‚ç»“æœ</strong></li><li><strong>é“¾è·¯ç»“æ„çµæ´»ï¼Œå¯ä»¥é€šè¿‡æ”¹å˜é“¾è·¯ç»“æœåŠ¨æ€çš„æ–°å¢å’Œåˆ é™¤è´£ä»»</strong></li><li><strong>æ˜“äºæ‰©å±•æ–°çš„è¯·æ±‚èŠ‚ç‚¹ï¼ˆç¬¦åˆå¼€é—­åŸåˆ™ï¼‰</strong></li></ul><h2 id="è´£ä»»é“¾æ¨¡å¼çš„ç¼ºç‚¹"><a href="#è´£ä»»é“¾æ¨¡å¼çš„ç¼ºç‚¹" class="headerlink" title="è´£ä»»é“¾æ¨¡å¼çš„ç¼ºç‚¹"></a>è´£ä»»é“¾æ¨¡å¼çš„ç¼ºç‚¹</h2><ul><li><strong>è´£ä»»é“¾å¤ªé•¿æˆ–è€…å¤„ç†æ—¶é—´å¤ªé•¿ï¼Œå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™</strong></li><li><strong>å¦‚æœèŠ‚ç‚¹å¯¹è±¡å­˜åœ¨å¾ªç¯â™»ï¸å¼•ç”¨æ—¶ï¼Œä¼šé€ æˆæ­»å¾ªç¯ï¼Œå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œæ‰€ä»¥è¿™ä¸ªåœ¨è®¾è®¡çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ä¸èƒ½å½¢æˆé—­ç¯âš ï¸âš ï¸âš ï¸</strong></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è´£ä»»é“¾æ¨¡å¼&quot;&gt;&lt;a href=&quot;#è´£ä»»é“¾æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;è´£ä»»é“¾æ¨¡å¼&quot;&gt;&lt;/a&gt;è´£ä»»é“¾æ¨¡å¼&lt;/h1&gt;&lt;p&gt;è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patterï¼‰æ˜¯å°†é“¾ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹çœ‹æˆæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªèŠ‚</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-è§‚å¯Ÿè€…æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T12:18:40.000Z</published>
    <updated>2021-08-07T12:20:21.869Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h1><h2 id="è§‚å¯Ÿè€…æ¨¡å¼-1"><a href="#è§‚å¯Ÿè€…æ¨¡å¼-1" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h2><p>æŒ‡å¤šä¸ªå¯¹è±¡é—´å­˜åœ¨ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚è¿™ç§æ¨¡å¼æœ‰æ—¶åˆç§°ä½œå‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€æ¨¡å‹-è§†å›¾æ¨¡å¼ï¼Œå®ƒæ˜¯å¯¹è±¡è¡Œä¸ºå‹æ¨¡å¼ã€‚</p><p>å±äºè¡Œä¸ºå‹æ¨¡å¼</p><h2 id="ç±»å›¾"><a href="#ç±»å›¾" class="headerlink" title="ç±»å›¾"></a>ç±»å›¾</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-cc1738bd0907f74ecc63783f3282a9a1aec.png" style="zoom: 50%;" />  <h3 id="ISubject"><a href="#ISubject" class="headerlink" title="ISubject"></a>ISubject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISubject</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">attach</span><span class="params">(IObserver&lt;E&gt; observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">detach</span><span class="params">(IObserver&lt;E&gt; observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notify</span><span class="params">(E event)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ConcreteSubject"><a href="#ConcreteSubject" class="headerlink" title="ConcreteSubject"></a>ConcreteSubject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">ISubject</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;IObserver&lt;E&gt;&gt; observers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">attach</span><span class="params">(IObserver&lt;E&gt; observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.observers.contains(observer)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        observers.add(observer);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">detach</span><span class="params">(IObserver&lt;E&gt; observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.observers.remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (IObserver observer : observers) &#123;</span><br><span class="line">            observer.update(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IObserver"><a href="#IObserver" class="headerlink" title="IObserver"></a>IObserver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span>  <span class="title">IObserver</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(E event)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ConcreteObserver"><a href="#ConcreteObserver" class="headerlink" title="ConcreteObserver"></a>ConcreteObserver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">IObserver</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;receive event  &quot;</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DemoTest"><a href="#DemoTest" class="headerlink" title="DemoTest"></a>DemoTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ISubject&lt;String&gt; subject = <span class="keyword">new</span> ConcreteSubject&lt;String&gt;();</span><br><span class="line">        subject.attach(<span class="keyword">new</span> ConcreteObserver&lt;String&gt;());</span><br><span class="line">        subject.attach(<span class="keyword">new</span> ConcreteObserver&lt;String&gt;());</span><br><span class="line">        subject.attach(<span class="keyword">new</span> ConcreteObserver&lt;String&gt;());</span><br><span class="line">        subject.notify(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="JDKå®ç°è§‚å¯Ÿè€…æ¨¡å¼"><a href="#JDKå®ç°è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="JDKå®ç°è§‚å¯Ÿè€…æ¨¡å¼"></a>JDKå®ç°è§‚å¯Ÿè€…æ¨¡å¼</h2><blockquote><p>æ¯”å¦‚æœ‰ä¸€ä¸ªåšå®¢ç³»ç»Ÿæä¾›äº†é—®é¢˜ç¤¾åŒºï¼Œä¸€ä¸ªäººæå‡ºé—®é¢˜ï¼Œä¼šæœ‰å…¶ä»–äººæ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼›æˆ‘ä»¬ä½¿ç”¨JDKæ¥æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼›</p></blockquote><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-a268997531d268d3ff748a45b29adc83031.png" style="zoom:67%;" />    <h3 id="Blog-è¢«è§‚å¯Ÿå¯¹è±¡"><a href="#Blog-è¢«è§‚å¯Ÿå¯¹è±¡" class="headerlink" title="Blog è¢«è§‚å¯Ÿå¯¹è±¡"></a>Blog è¢«è§‚å¯Ÿå¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blog</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Blog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Blog blog = <span class="keyword">new</span> Blog();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">&quot;IBLi Blog&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Blog <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">question</span><span class="params">(Question question)</span> </span>&#123;</span><br><span class="line">        System.out.println(question.getUserName() + <span class="string">&quot; åœ¨ blog æäº¤äº†é—®é¢˜ ï¼š &quot;</span> + question.getContent());</span><br><span class="line">        setChanged();</span><br><span class="line">        notifyObservers(question);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Question</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Question</span><span class="params">(String userName, String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Student-å­¦ç”Ÿç±»-è¢«é€šçŸ¥å¯¹è±¡"><a href="#Student-å­¦ç”Ÿç±»-è¢«é€šçŸ¥å¯¹è±¡" class="headerlink" title="Student å­¦ç”Ÿç±» è¢«é€šçŸ¥å¯¹è±¡"></a>Student å­¦ç”Ÿç±» è¢«é€šçŸ¥å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This method is called whenever the observed object is changed. An</span></span><br><span class="line"><span class="comment">     * application calls an &lt;tt&gt;Observable&lt;/tt&gt; object&#x27;s</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;notifyObservers&lt;/code&gt; method to have all the object&#x27;s</span></span><br><span class="line"><span class="comment">     * observers notified of the change.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o   the observable object.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arg an argument passed to the &lt;code&gt;notifyObservers&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        Blog blog = (Blog) o;</span><br><span class="line">        Question question = (Question) arg;</span><br><span class="line">        System.out.println(<span class="string">&quot;******************&quot;</span>);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.name + <span class="string">&quot; çœ‹åˆ°äº†  &quot;</span> + question.getUserName() + <span class="string">&quot; çš„é—®é¢˜ \n&quot;</span> + <span class="string">&quot;é—®é¢˜æ˜¯ï¼š &quot;</span> + question.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client-æµ‹è¯•"><a href="#Client-æµ‹è¯•" class="headerlink" title="Client æµ‹è¯•"></a>Client æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Blog blog = Blog.getInstance();</span><br><span class="line"></span><br><span class="line">        blog.addObserver(<span class="keyword">new</span> Student(<span class="string">&quot;Tom&quot;</span>));</span><br><span class="line">        blog.addObserver(<span class="keyword">new</span> Student(<span class="string">&quot;John&quot;</span>));</span><br><span class="line">        Question question = <span class="keyword">new</span> Question(<span class="string">&quot;å°æ˜&quot;</span>,<span class="string">&quot;è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span>);</span><br><span class="line">        blog.question(question);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å°æ˜ åœ¨ blog æäº¤äº†é—®é¢˜ ï¼š è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">******************</span><br><span class="line">Johnçœ‹åˆ°äº†  å°æ˜ çš„é—®é¢˜ </span><br><span class="line">é—®é¢˜æ˜¯ï¼š è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line">******************</span><br><span class="line">Tomçœ‹åˆ°äº†  å°æ˜ çš„é—®é¢˜ </span><br><span class="line">é—®é¢˜æ˜¯ï¼š è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ</span><br></pre></td></tr></table></figure><h2 id="åŸºäºGuavaå®ç°è§‚å¯Ÿè€…æ¨¡å¼"><a href="#åŸºäºGuavaå®ç°è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="åŸºäºGuavaå®ç°è§‚å¯Ÿè€…æ¨¡å¼"></a>åŸºäºGuavaå®ç°è§‚å¯Ÿè€…æ¨¡å¼</h2><h3 id="Student-è¢«è§‚å¯Ÿå¯¹è±¡"><a href="#Student-è¢«è§‚å¯Ÿå¯¹è±¡" class="headerlink" title="Student è¢«è§‚å¯Ÿå¯¹è±¡"></a>Student è¢«è§‚å¯Ÿå¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Observer</span><span class="params">(Student str)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;student invoke method + &quot;</span> + str.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Teacher-è¢«é€šçŸ¥å¯¹è±¡"><a href="#Teacher-è¢«é€šçŸ¥å¯¹è±¡" class="headerlink" title="Teacher è¢«é€šçŸ¥å¯¹è±¡"></a>Teacher è¢«é€šçŸ¥å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Teacher&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Observer</span><span class="params">(Teacher str)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;teacher invoke method + &quot;</span> + str.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client-æµ‹è¯•ç±»"><a href="#Client-æµ‹è¯•ç±»" class="headerlink" title="Client æµ‹è¯•ç±»"></a>Client æµ‹è¯•ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventBus eventBus = <span class="keyword">new</span> EventBus();</span><br><span class="line">        Student student = <span class="keyword">new</span> Student(<span class="string">&quot;Ibli&quot;</span>);</span><br><span class="line">        Teacher teacher = <span class="keyword">new</span> Teacher(<span class="string">&quot;laoshi&quot;</span>);</span><br><span class="line">        eventBus.register(student);</span><br><span class="line">        eventBus.register(teacher);</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> Student(<span class="string">&quot;xuesheng&quot;</span>));</span><br><span class="line">        eventBus.post(<span class="keyword">new</span> Teacher(<span class="string">&quot;teacher&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ-1"><a href="#æµ‹è¯•ç»“æœ-1" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">student invoke method + Student&#123;name=<span class="string">&#x27;xuesheng&#x27;</span>&#125;</span><br><span class="line">teacher invoke method + Teacher&#123;name=<span class="string">&#x27;teacher&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="è§‚å¯Ÿè€…æ¨¡å¼ä½¿ç”¨åœºæ™¯"><a href="#è§‚å¯Ÿè€…æ¨¡å¼ä½¿ç”¨åœºæ™¯" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼ä½¿ç”¨åœºæ™¯"></a>è§‚å¯Ÿè€…æ¨¡å¼ä½¿ç”¨åœºæ™¯</h2><p>1ã€å½“ä¸€ä¸ªæŠ½è±¡æ¨¡å‹åŒ…å«ä¸¤ä¸ªæ–¹é¢å†…å®¹ï¼Œå…¶ä¸­ä¸€ä¸ªæ–¹é¢ä¾èµ–å¦ä¸€ä¸ªæ–¹é¢<br>2ã€å…¶ä»–ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡çš„å˜åŒ–ä¾èµ–å¦ä¸€ä¸ªå¯¹è±¡çš„å˜åŒ–<br>3ã€å®ç°ç±»ä¼¼å¹¿æ’­æœºåˆ¶çš„åŠŸèƒ½ï¼Œæ— éœ€çŸ¥é“å…·ä½“æ”¶å¬è€…ï¼Œåªéœ€è¦å¹¿æ’­ã€‚ç³»ç»Ÿä¸­æ„Ÿå…´è¶£çš„å¯¹è±¡ä¼šè‡ªåŠ¨æ¥å£è¯¥å¹¿æ’­<br>4ã€å¤šå±‚çº§åµŒå¥—æœºåˆ¶ï¼Œå½¢æˆä¸€ç§é“¾å¼å‡ºå‘æœºåˆ¶ï¼Œæ˜¯çš„æ—¶é—´å…·å¤‡è·¨åŸŸï¼ˆè·¨è¶Šä¸¤ç§è§‚å¯Ÿè€…ç±»å‹ï¼‰é€šçŸ¥  </p><h2 id="è§‚å¯Ÿè€…æ¨¡å¼ä¼˜ç‚¹âœ…"><a href="#è§‚å¯Ÿè€…æ¨¡å¼ä¼˜ç‚¹âœ…" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼ä¼˜ç‚¹âœ…"></a>è§‚å¯Ÿè€…æ¨¡å¼ä¼˜ç‚¹âœ…</h2><p>1ã€é™ä½äº†ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„è€¦åˆå…³ç³»ï¼Œä¸¤è€…ä¹‹é—´æ˜¯æŠ½è±¡è€¦åˆå…³ç³»ã€‚ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™ã€‚<br>2ã€ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´å»ºç«‹äº†ä¸€å¥—è§¦å‘æœºåˆ¶ã€‚   </p><h2 id="è§‚å¯Ÿè€…æ¨¡å¼ç¼ºç‚¹"><a href="#è§‚å¯Ÿè€…æ¨¡å¼ç¼ºç‚¹" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼ç¼ºç‚¹"></a>è§‚å¯Ÿè€…æ¨¡å¼ç¼ºç‚¹</h2><p>ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„ä¾èµ–å…³ç³»å¹¶æ²¡æœ‰å®Œå…¨è§£é™¤ï¼Œè€Œä¸”æœ‰å¯èƒ½å‡ºç°å¾ªç¯å¼•ç”¨ã€‚<br>å½“è§‚å¯Ÿè€…å¯¹è±¡å¾ˆå¤šæ—¶ï¼Œé€šçŸ¥çš„å‘å¸ƒä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œå½±å“ç¨‹åºçš„æ•ˆç‡ã€‚  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è§‚å¯Ÿè€…æ¨¡å¼&quot;&gt;&lt;a href=&quot;#è§‚å¯Ÿè€…æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;è§‚å¯Ÿè€…æ¨¡å¼&quot;&gt;&lt;/a&gt;è§‚å¯Ÿè€…æ¨¡å¼&lt;/h1&gt;&lt;h2 id=&quot;è§‚å¯Ÿè€…æ¨¡å¼-1&quot;&gt;&lt;a href=&quot;#è§‚å¯Ÿè€…æ¨¡å¼-1&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-è£…é¥°å™¨æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T12:15:15.000Z</published>
    <updated>2021-08-07T12:17:52.075Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator-Patternï¼‰"><a href="#è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator-Patternï¼‰" class="headerlink" title="è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator Patternï¼‰"></a>è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator Patternï¼‰</h1><p>è£…é¥°å™¨æ¨¡å¼ä¹Ÿå«åšåŒ…è£…æ¨¡å¼ï¼Œæ˜¯æŒ‡åœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œå°†åŠŸèƒ½é™„åŠ åˆ°å¯¹è±¡ä¸Šï¼Œæä¾›æ¯”ç»§æ‰¿æ›´æœ‰å¼¹æ€§çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆæ‰©å±•åŸæœ‰å¯¹è±¡çš„åŠŸèƒ½ï¼‰ï¼Œå¼ºè°ƒä¸€ç‚¹æ˜¯åŸºäºå·²æœ‰å¯¹è±¡çš„åŠŸèƒ½å¢å¼ºï¼›è£…é¥°å™¨æ¨¡å¼å±äºç»“æ„æ€§æ¨¡å¼;</p><h2 id="è£…é¥°å™¨ç±»å›¾"><a href="#è£…é¥°å™¨ç±»å›¾" class="headerlink" title="è£…é¥°å™¨ç±»å›¾"></a>è£…é¥°å™¨ç±»å›¾</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-b2f04bf843bb9c3e787016e216e5fbd91cf.png" style="zoom:67%;" />  <h3 id="Component-æŠ½è±¡æ„ä»¶"><a href="#Component-æŠ½è±¡æ„ä»¶" class="headerlink" title="Component æŠ½è±¡æ„ä»¶"></a>Component æŠ½è±¡æ„ä»¶</h3><blockquote><p>å®šä¹‰ä¸€ä¸ªæŠ½è±¡æ¥å£ä»¥è§„èŒƒå‡†å¤‡æ¥å—é™„åŠ è´£ä»»çš„å¯¹è±¡</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcreteComponent-å…·ä½“çš„æ„ä»¶"><a href="#ConcreteComponent-å…·ä½“çš„æ„ä»¶" class="headerlink" title="ConcreteComponent å…·ä½“çš„æ„ä»¶"></a>ConcreteComponent å…·ä½“çš„æ„ä»¶</h3><blockquote><p>å®ç°æŠ½è±¡æ„ä»¶,é€šè¿‡è£…é¥°è§’è‰²ä¸ºå…¶æ·»åŠ ä¸€äº›èŒè´£</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteComponent</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Do some biz event!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Decorator-æŠ½è±¡è£…é¥°è§’è‰²"><a href="#Decorator-æŠ½è±¡è£…é¥°è§’è‰²" class="headerlink" title="Decorator æŠ½è±¡è£…é¥°è§’è‰²"></a>Decorator æŠ½è±¡è£…é¥°è§’è‰²</h3><blockquote><p>ç»§æ‰¿æŠ½è±¡æ„ä»¶,å¹¶åŒ…å«å…·ä½“æ„ä»¶çš„å®ä¾‹,å¯ä»¥é€šè¿‡å…¶å­ç±»æ‰©å±•å…·ä½“æ„ä»¶çš„åŠŸèƒ½</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŒæœ‰ç»„ä»¶å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">protected</span> Component component;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.component = component;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è½¬å‘è¯·æ±‚ç»™ç»„ä»¶å¯¹è±¡,å¯ä»¥åœ¨è½¬å‘å‰åæ‰§è¡Œä¸€äº›é™„åŠ åŠ¨ä½œ</span></span><br><span class="line">        component.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcreteDecoratorA"><a href="#ConcreteDecoratorA" class="headerlink" title="ConcreteDecoratorA"></a>ConcreteDecoratorA</h3><blockquote><p>å®ç°æŠ½è±¡è£…é¥°çš„ç›¸å…³æ–¹æ³•,å¹¶ç»™å…·ä½“æ„ä»¶å¯¹è±¡æ·»åŠ é™„åŠ çš„è´£ä»»</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteDecoratorA</span> <span class="keyword">extends</span> <span class="title">Decorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteDecoratorA</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ConcreteDecoratorA first!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationLast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ConcreteDecoratorA last!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        operationFirst();</span><br><span class="line">        <span class="keyword">super</span>.operation();</span><br><span class="line">        operationLast();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client-æµ‹è¯•ç±»"><a href="#Client-æµ‹è¯•ç±»" class="headerlink" title="Client æµ‹è¯•ç±»"></a>Client æµ‹è¯•ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Component component = <span class="keyword">new</span> ConcreteComponent();</span><br><span class="line">        Decorator decoratorA = <span class="keyword">new</span> ConcreteDecoratorA(component);</span><br><span class="line">        decoratorA.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸¾ä¸ªä¾‹å­"><a href="#ä¸¾ä¸ªä¾‹å­" class="headerlink" title="ä¸¾ä¸ªä¾‹å­"></a>ä¸¾ä¸ªä¾‹å­</h2><p>ä¹°ç…é¥¼çš„æ—¶å€™,æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¹°ä¸€ä¸ªç…é¥¼,ä½†æœ‰çš„æ—¶å€™è§‰å¾—å‘³é“å•ä¸€æˆ–è€…åƒä¸é¥±,æˆ‘ä»¬å¯ä»¥åŠ ä¸€äº›ä¸œè¥¿,æ¯”å¦‚çƒ¤è‚ ,é¸¡è›‹,é¸¡æ’ç­‰ç­‰;  </p><p><strong>å…ˆçœ‹çœ‹éè£…é¥°å™¨æ¨¡å¼çš„å†™æ³•</strong>  </p><h3 id="BatterCake"><a href="#BatterCake" class="headerlink" title="BatterCake"></a>BatterCake</h3><blockquote><p>å°±ä¸€ä¸ªæ™®é€šçš„ç…é¥¼ç±»ï¼›  </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatterCake</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMsg</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">&quot;ç…é¥¼&quot;</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BatterCakeWithEgg"><a href="#BatterCakeWithEgg" class="headerlink" title="BatterCakeWithEgg"></a>BatterCakeWithEgg</h3><blockquote><p>æ·»åŠ ä¸€ä¸ªé¸¡è›‹çš„ç…é¥¼ï¼›  </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatterCakeWithEgg</span> <span class="keyword">extends</span> <span class="title">BatterCake</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMsg</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getMsg() + <span class="string">&quot; åŠ ä¸€ä¸ªé¸¡è›‹&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getPrice() + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BatterCakeWithEggAndSauage"><a href="#BatterCakeWithEggAndSauage" class="headerlink" title="BatterCakeWithEggAndSauage"></a>BatterCakeWithEggAndSauage</h3><blockquote><p>åŠ ä¸€ä¸ªé¸¡è›‹ å†åŠ ä¸€è·Ÿçƒ¤è‚ çš„ç…é¥¼ï¼›  </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatterCakeWithEggAndSauage</span> <span class="keyword">extends</span> <span class="title">BatterCakeWithEgg</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMsg</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getMsg() + <span class="string">&quot; åŠ ä¸€ä¸ªçƒ¤è‚ &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getPrice() + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client-å®¢æˆ·"><a href="#Client-å®¢æˆ·" class="headerlink" title="Client å®¢æˆ·"></a>Client å®¢æˆ·</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BatterCake batterCake = <span class="keyword">new</span> BatterCake();</span><br><span class="line">        System.err.println(batterCake.getMsg() + <span class="string">&quot;ä»·æ ¼ &quot;</span> + batterCake.getPrice());</span><br><span class="line"></span><br><span class="line">        BatterCakeWithEgg batterCakeWithEgg = <span class="keyword">new</span> BatterCakeWithEgg();</span><br><span class="line">        System.err.println(batterCakeWithEgg.getMsg() + <span class="string">&quot;ä»·æ ¼ &quot;</span> + batterCakeWithEgg.getPrice());</span><br><span class="line"></span><br><span class="line">        BatterCakeWithEggAndSauage batterCakeWithEggAndSauage = <span class="keyword">new</span> BatterCakeWithEggAndSauage();</span><br><span class="line">        System.err.println(batterCakeWithEggAndSauage.getMsg() + <span class="string">&quot;ä»·æ ¼ &quot;</span> + batterCakeWithEggAndSauage.getPrice());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™ç§å†™æ³•ï¼Œåº”è¯¥èƒ½çœ‹å‡ºå®ƒçš„å¼Šç«¯äº†ï¼Œå°±æ˜¯å®ç°å¾ˆç®€å•ï¼Œé€‚åˆäºéœ€æ±‚å›ºå®šçš„ä¸šåŠ¡å’Œå¤šæ ·æ€§æ¯”è¾ƒç®€å•çš„ä¸šåŠ¡ï¼›ä¸€æ—¦å®¢æˆ·éœ€è¦ä¸€ä¸ªé¸¡è›‹ï¼Œä¸¤æ ¹çƒ¤è‚ ï¼Œé‚£æ˜¯ä¸æ˜¯è¿˜è¦åœ¨BatterCakeWithEggAndSauageç±»ä¸Šç»§ç»­æ‰©å±•å‘¢ï¼Œè¿™å…¶å®æ˜¯å¾ˆlowçš„è®¾è®¡ï¼›è€Œä¸”éå¸¸ä¸çµæ´»ï¼Œæ¯”å¦‚å®¢æˆ·åªéœ€è¦ä¸€è·Ÿçƒ¤è‚ çš„ç…é¥¼ã€‚è¿™ä¸ªæ—¶å€™æ€ä¹ˆè§£å†³å‘¢ï¼›</p><p><strong>ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ä¼˜åŒ–</strong>  </p><h3 id="BatterCake-æŠ½è±¡ç»„ä»¶"><a href="#BatterCake-æŠ½è±¡ç»„ä»¶" class="headerlink" title="BatterCake æŠ½è±¡ç»„ä»¶"></a>BatterCake æŠ½è±¡ç»„ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BatterCake</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getMsg</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŸºç¡€ç±»-å®ç°æŠ½è±¡æ¥å£"><a href="#åŸºç¡€ç±»-å®ç°æŠ½è±¡æ¥å£" class="headerlink" title="åŸºç¡€ç±» å®ç°æŠ½è±¡æ¥å£"></a>åŸºç¡€ç±» å®ç°æŠ½è±¡æ¥å£</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseBatterCake</span> <span class="keyword">extends</span> <span class="title">BatterCake</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç…é¥¼&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BatterCakeDecorator-è£…é¥°å™¨"><a href="#BatterCakeDecorator-è£…é¥°å™¨" class="headerlink" title="BatterCakeDecorator è£…é¥°å™¨"></a>BatterCakeDecorator è£…é¥°å™¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatterCakeDecorator</span> <span class="keyword">extends</span> <span class="title">BatterCake</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BatterCake batterCake;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BatterCakeDecorator</span><span class="params">(BatterCake batterCake)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.batterCake = batterCake;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.batterCake.getMsg();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.batterCake.getPrice();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="EggDecorator-å…·ä½“çš„è£…é¥°å™¨å¯¹è±¡"><a href="#EggDecorator-å…·ä½“çš„è£…é¥°å™¨å¯¹è±¡" class="headerlink" title="EggDecorator å…·ä½“çš„è£…é¥°å™¨å¯¹è±¡"></a>EggDecorator å…·ä½“çš„è£…é¥°å™¨å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EggDecorator</span> <span class="keyword">extends</span> <span class="title">BatterCakeDecorator</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EggDecorator</span><span class="params">(BatterCake batterCake)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>(batterCake);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getMsg() + <span class="string">&quot; åŠ ä¸€ä¸ªé¸¡è›‹&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getPrice() + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SauageDecorator-å…·ä½“çš„è£…é¥°å¯¹è±¡"><a href="#SauageDecorator-å…·ä½“çš„è£…é¥°å¯¹è±¡" class="headerlink" title="SauageDecorator å…·ä½“çš„è£…é¥°å¯¹è±¡"></a>SauageDecorator å…·ä½“çš„è£…é¥°å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SauageDecorator</span> <span class="keyword">extends</span> <span class="title">BatterCakeDecorator</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SauageDecorator</span><span class="params">(BatterCake batterCake)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>(batterCake);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getMsg() + <span class="string">&quot; åŠ ä¸€ä¸ªçƒ¤è‚ &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getPrice() + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®¢æˆ·-æµ‹è¯•ç±»"><a href="#å®¢æˆ·-æµ‹è¯•ç±»" class="headerlink" title="å®¢æˆ· æµ‹è¯•ç±»"></a>å®¢æˆ· æµ‹è¯•ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BatterCake batterCake = <span class="keyword">new</span> BaseBatterCake();</span><br><span class="line">        System.err.println(batterCake.getMsg() + <span class="string">&quot;æ€»è®¡ : &quot;</span> + batterCake.getPrice());</span><br><span class="line"></span><br><span class="line">        batterCake = <span class="keyword">new</span> EggDecorator(batterCake);</span><br><span class="line">        System.err.println(batterCake.getMsg() + <span class="string">&quot;æ€»è®¡ : &quot;</span> + batterCake.getPrice());</span><br><span class="line"></span><br><span class="line">        batterCake = <span class="keyword">new</span> SauageDecorator(batterCake);</span><br><span class="line">        System.err.println(batterCake.getMsg() + <span class="string">&quot;æ€»è®¡ : &quot;</span> + batterCake.getPrice());</span><br><span class="line"></span><br><span class="line">        batterCake = <span class="keyword">new</span> EggDecorator(batterCake);</span><br><span class="line">        System.err.println(batterCake.getMsg() + <span class="string">&quot;æ€»è®¡ : &quot;</span> + batterCake.getPrice());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ç§å†™æ³•æ˜¯è¿ç”¨äº†è£…é¥°å™¨æ¨¡å¼çš„å†™æ³•ï¼Œè¿™æ ·ä¼šå¢åŠ ç¨‹åºçš„çµæ´»æ€§ï¼ŒEggDecoratorè¿”å›ä¸€ä¸ªBatterCakeï¼Œåœ¨EggDecoratorä¸­çš„getMsgæ–¹æ³•å’ŒgetPriceæ–¹æ³•ä¸­æ·»åŠ å…³äºEggçš„é€»è¾‘æ¥å®ç°å¯¹BatterCakeçš„å¢å¼ºï¼ŒåŒç†SauageDecoratorä¹Ÿæ˜¯ï¼Œåœ¨å®ƒè‡ªå·±çš„getMsgæ–¹æ³•å’ŒgetPriceæ–¹æ³•ä¸­æ·»åŠ è‡ªå·±çš„é€»è¾‘ï¼Œå½“ç„¶ï¼Œéƒ½æ˜¯åŸºäºè°ƒç”¨superæ–¹æ³•çš„åŸºç¡€ä¸Šæ·»åŠ è‡ªå·±çš„é€»è¾‘ï¼ŒåŒæ—¶å…·ä½“çš„è£…é¥°å¯¹è±¡è¿”å›çˆ¶ç±»ç±»å‹çš„å¯¹è±¡ï¼›  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getPrice() + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œè¿›è¡Œä¸€ä¸‹æ€»ç»“ï¼š</strong><br>1ã€å…·ä½“è£…é¥°å¯¹è±¡(EggDecorator)ä¸€å®šæ˜¯ç»§æ‰¿è‡ªè£…é¥°ç»„ä»¶(BatterCakeDecorator)<br>2ã€ä¸ºäº†å®ç°å¯¹è±¡å¢å¼ºï¼Œå­ç±»ä¸­çš„æ–¹æ³•ä¸€å®šæ˜¯åŸºäºsuperæ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ è‡ªå·±çš„é€»è¾‘çš„  </p><h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><ul><li>ç”¨äºæ‰©å±•ä¸€ä¸ªç±»çš„åŠŸèƒ½æˆ–ç»™ä¸€ä¸ªç±»æ·»åŠ é™„åŠ èŒè´£</li><li>åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ åŠŸèƒ½,è¿™äº›åŠŸèƒ½å¯ä»¥åœ¨åŠ¨æ€çš„æ’¤é”€</li></ul><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><p>Spring TransactionAwareCacheManager<br>JDK FileInputStream   </p><h2 id="è£…é¥°å™¨æ¨¡å¼ä¸ä»£ç†æ¨¡å¼"><a href="#è£…é¥°å™¨æ¨¡å¼ä¸ä»£ç†æ¨¡å¼" class="headerlink" title="è£…é¥°å™¨æ¨¡å¼ä¸ä»£ç†æ¨¡å¼"></a>è£…é¥°å™¨æ¨¡å¼ä¸ä»£ç†æ¨¡å¼</h2><ul><li>è£…é¥°å™¨æ¨¡å¼æ˜¯ä¸€ç§ç‰¹æ®Šçš„ä»£ç†æ¨¡å¼  </li><li>è£…é¥°å™¨æ¨¡å¼å¼ºè°ƒè‡ªèº«çš„åŠŸèƒ½æ‰©å±•,é€æ˜çš„,åŠ¨æ€çš„æ‰©å±•ä¸å¢å¼º  <blockquote><p>é€æ˜æŒ‡çš„æ˜¯åŠŸèƒ½çš„æ‰©å±•ç”±å®¢æˆ·ç«¯æ§åˆ¶  </p></blockquote></li><li>ä»£ç†æ¨¡å¼å¼ºè°ƒä»£ç†è¿‡ç¨‹çš„æ§åˆ¶  </li></ul><h2 id="è£…é¥°å™¨æ¨¡å¼çš„ä¼˜ç‚¹"><a href="#è£…é¥°å™¨æ¨¡å¼çš„ä¼˜ç‚¹" class="headerlink" title="è£…é¥°å™¨æ¨¡å¼çš„ä¼˜ç‚¹"></a>è£…é¥°å™¨æ¨¡å¼çš„ä¼˜ç‚¹</h2><p>1ã€è£…é¥°å™¨æ˜¯ç»§æ‰¿çš„æœ‰åŠ›è¡¥å……ï¼Œæ¯”ç»§æ‰¿çµæ´»ï¼Œåœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€çš„ç»™ä¸€ä¸ªå¯¹è±¡æ‰©å±•åŠŸèƒ½ï¼Œå³æ’å³ç”¨<br>2ã€é€šè¿‡ä½¿ç”¨ä¸ç”¨è£…é¥°ç±»åŠè¿™äº›è£…é¥°ç±»çš„æ’åˆ—ç»„åˆï¼Œå¯ä»¥å®ç°ä¸åŒæ•ˆæœ<br>3ã€è£…é¥°å™¨æ¨¡å¼å®Œå…¨éµå®ˆå¼€é—­åŸåˆ™  </p><h2 id="è£…é¥°å™¨æ¨¡å¼çš„ç¼ºç‚¹"><a href="#è£…é¥°å™¨æ¨¡å¼çš„ç¼ºç‚¹" class="headerlink" title="è£…é¥°å™¨æ¨¡å¼çš„ç¼ºç‚¹"></a>è£…é¥°å™¨æ¨¡å¼çš„ç¼ºç‚¹</h2><p>1ã€å¢åŠ äº†ä¸€äº›å­ç±»ï¼Œç³»ç»Ÿä»£ç ä¼šæ˜¾å¾—è‡ƒè‚¿ã€‚<br>2ã€ç»„åˆæ–¹å¼å®¹æ˜“å‡ºé”™ï¼Œä»£ç å¯è¯»æ€§æ¯”è¾ƒå·®ã€‚   </p><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><p>1ã€<a href="https://juejin.cn/post/6844903603178569741">åŒ…è£…æ¨¡å¼å°±æ˜¯è¿™ä¹ˆç®€å•å•¦</a><br>2ã€<a href="http://c.biancheng.net/view/1366.html">è£…é¥°å™¨æ¨¡å¼ï¼ˆè£…é¥°è®¾è®¡æ¨¡å¼ï¼‰è¯¦è§£</a><br>3ã€<a href="https://www.cnblogs.com/losedMemory/p/6246029.html">javaä¸­çš„è£…é¥°è®¾è®¡æ¨¡å¼ï¼Œæµ…è°ˆä¸ç»§æ‰¿ä¹‹é—´çš„åŒºåˆ«</a><br>4ã€<a href="https://blog.csdn.net/lsgqjh/article/details/63254876">JDK IOä¸­çš„é€‚é…å™¨æ¨¡å¼å’Œè£…é¥°è€…æ¨¡å¼</a>  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator-Patternï¼‰&quot;&gt;&lt;a href=&quot;#è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator-Patternï¼‰&quot; class=&quot;headerlink&quot; title=&quot;è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator Patternï¼‰&quot;&gt;&lt;/a&gt;è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorato</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-ç­–ç•¥æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T12:09:10.000Z</published>
    <updated>2021-08-07T12:14:15.107Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ç­–ç•¥æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h1><p><strong>ç­–ç•¥æ¨¡å¼</strong>ï¼ˆStrategy Patternï¼‰ä¹Ÿå«åšæ”¿ç­–æ¨¡å¼ï¼ˆPolicy Patternï¼‰,å®ƒæ˜¯å°†å®šä¹‰çš„ç®—æ³•å°è£…èµ·æ¥ï¼Œ<br>è®©å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä»è€Œè®©ç®—æ³•çš„å˜åŒ–ä¸å½±å“åˆ°ä½¿ç”¨ç®—æ³•çš„ç”¨æˆ·ï¼›å®ƒå±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§„é¿<br>if-else/switchç­‰<br>ç­–ç•¥æ¨¡å¼ä½¿ç”¨çš„é¢å‘å¯¹è±¡çš„ç»§æ‰¿å’Œå¤šæ€æœºåˆ¶ï¼Œä»è€Œå®ç°åŒä¸€è¡Œä¸ºåœ¨ä¸åŒçš„åœºæ™¯ä¸‹å…·å¤‡ä¸åŒçš„å®ç°ï¼›  </p><h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><p>ç­–ç•¥æ¨¡å¼åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­æœ‰å¾ˆå¤šçš„åº”ç”¨ï¼Œå‡¡æ˜¯è®¾è®¡åˆ°é€‰æ‹©çš„åœºæ™¯åŸºæœ¬éƒ½å¯ä»¥ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ¥å®ç°ï¼›æ¯”å¦‚è´­ä¹°ä¸€ä¸ªå•†å“é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼Œæ˜¯é€‰æ‹©é“¶è¡Œå¡è¿˜æ˜¯å¿«æ·æ”¯ä»˜ï¼Œå¾®ä¿¡ï¼Ÿæ”¯ä»˜å®ç­‰ï¼›  </p><ul><li>å‡å¦‚ä¸€ä¸ªç³»ç»Ÿä¸­æœ‰å¾ˆå¤šç±»ï¼Œè€Œå®ƒä»¬çš„åŒºåˆ«ä»…ä»…åœ¨ä¸å®ƒä»¬çš„è¡Œä¸ºä¸åŒï¼›</li><li>ä¸€ä¸ªç³»ç»Ÿéœ€è¦åŠ¨æ€çš„ä»å‡ ç§ç®—æ³•ä¸­é€‰æ‹©ä¸€ç§ï¼›ä¸€äº›å¹³å°å‹äº§å“ä¸­è‚¯å®šä¼šç”¨åˆ°çš„</li><li>éœ€è¦å±è”½ç®—æ³•è§„åˆ™ï¼›</li></ul><h2 id="ç­–ç•¥æ¨¡å¼ç±»å›¾"><a href="#ç­–ç•¥æ¨¡å¼ç±»å›¾" class="headerlink" title="ç­–ç•¥æ¨¡å¼ç±»å›¾"></a>ç­–ç•¥æ¨¡å¼ç±»å›¾</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-bcd8e7bee16acac3b254b110a2c2f3796b8.png" style="zoom:50%;" />   é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œç­–ç•¥æ¨¡å¼ä¸»è¦åŒ…å«3ä¸ªè§’è‰²ï¼š  <ul><li><strong>ä¸Šä¸‹æ–‡è§’è‰²ï¼ˆContextï¼‰</strong>: ç”¨æ¥æ“ä½œç­–ç•¥çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå±è”½é«˜å±‚æ¨¡å—ï¼ˆå®¢æˆ·ç«¯ï¼‰å¯¹ç­–ç•¥/ç®—æ³•çš„ç›´æ¥è®¿é—®ï¼Œå°è£…å¯èƒ½<br>å­˜åœ¨çš„å˜åŒ–</li><li><strong>æŠ½è±¡ç­–ç•¥è§’è‰²ï¼ˆIStrategyï¼‰</strong>: è§„å®šç­–ç•¥æˆ–ç®—æ³•çš„è¡Œä¸º    </li><li><strong>å…·ä½“çš„ç­–ç•¥è§’è‰²ï¼ˆConcreteStrategyï¼‰</strong>: å…·ä½“çš„ç­–ç•¥é€»è¾‘æˆ–ç®—æ³•  </li></ul><p>è¿™é‡Œçš„ä¸Šä¸‹æ–‡è§’è‰²ä»…ä»…æ˜¯ä¸€ä¸ªç§°è°“ï¼Œå¤§å®¶åªè¦çŸ¥é“ä»–åœ¨ç­–ç•¥æ¨¡å¼ä¸­çš„ä½œç”¨å°±å¯ä»¥äº†ï¼Œå°±æ˜¯æ¡¥æ¥å®¢æˆ·ç«¯å’Œç­–ç•¥/æ–¹æ³•çš„ä½œç”¨ï¼›  </p><h2 id="ä¸¾ä¸ªä¾‹å­"><a href="#ä¸¾ä¸ªä¾‹å­" class="headerlink" title="ä¸¾ä¸ªä¾‹å­"></a>ä¸¾ä¸ªä¾‹å­</h2><blockquote><p>èƒŒæ™¯ï¼š ç”µå•†åœºæ™¯ä¸‹ï¼Œç”¨æˆ·è´­ä¹°ä¸€ä¸ªå•†å“ï¼Œæ”¯ä»˜æ—¶å¯ä»¥é€‰æ‹©ä¸€ç§ä¼˜æƒ ç­–ç•¥ï¼Œå¦‚æœæ²¡æœ‰ä¼˜æƒ ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ç­–ç•¥ï¼Œå³æ— ä»»ä½•ä¼˜æƒ ï¼›  </p></blockquote><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-1f96ebedc89c21db9af9a2ae899918d9fb8.png" style="zoom: 33%;" />  <p>1ã€ä¸Šé¢ä¸¤å±‚æ˜¯å®šä¹‰çš„ä¸€ä¸ªè¥é”€ç­–ç•¥çš„æ¥å£ï¼Œç„¶åæä¾›ä¸åŒçš„ç­–ç•¥æ¥å®ç°ï¼›<br>2ã€ç¬¬ä¸‰å±‚æ˜¯ç­–ç•¥ç”Ÿæˆæ‰€ä½¿ç”¨çš„å·¥å‚å’Œå®¢æˆ·ç«¯è°ƒç”¨ç­–ç•¥ä¸­é—´çš„ä¸Šä¸‹æ–‡ï¼Œæ‰¿æ¥ä¸Šä¸‹ï¼Œæ¡¥æ¥æ¨¡å¼ï¼›<br>3ã€æœ€ä¸‹å±‚çš„Demoå¯ä»¥çœ‹æˆæ˜¯å®¢æˆ·ç«¯ï¼›  </p><h3 id="å®šä¹‰ç­–ç•¥æ¥å£-åˆ¶å®šæ ‡å‡†æ–¹æ³•"><a href="#å®šä¹‰ç­–ç•¥æ¥å£-åˆ¶å®šæ ‡å‡†æ–¹æ³•" class="headerlink" title="å®šä¹‰ç­–ç•¥æ¥å£ åˆ¶å®šæ ‡å‡†æ–¹æ³•"></a>å®šä¹‰ç­–ç•¥æ¥å£ åˆ¶å®šæ ‡å‡†æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPromotionStrategy</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">doPromote</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="CashBackStrategy-ç°é‡‘æŠ˜è¿”ç­–ç•¥"><a href="#CashBackStrategy-ç°é‡‘æŠ˜è¿”ç­–ç•¥" class="headerlink" title="CashBackStrategy ç°é‡‘æŠ˜è¿”ç­–ç•¥"></a>CashBackStrategy ç°é‡‘æŠ˜è¿”ç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CashBackStrategy</span> <span class="keyword">implements</span> <span class="title">IPromotionStrategy</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPromote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç›´æ¥è¿”ç°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CouponStrategy-ä¼˜æƒ åˆ¸ç­–ç•¥"><a href="#CouponStrategy-ä¼˜æƒ åˆ¸ç­–ç•¥" class="headerlink" title="CouponStrategy ä¼˜æƒ åˆ¸ç­–ç•¥"></a>CouponStrategy ä¼˜æƒ åˆ¸ç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CouponStrategy</span> <span class="keyword">implements</span> <span class="title">IPromotionStrategy</span></span>&#123;</span><br><span class="line">    <span class="comment">// ä¼˜æƒ åˆ¸ç­–ç•¥</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPromote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä½¿ç”¨ä¼˜æƒ åˆ¸æŠµæ‰£&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="GroupBuyStrategy-å›¢è´­ä¼˜æƒ ç­–ç•¥"><a href="#GroupBuyStrategy-å›¢è´­ä¼˜æƒ ç­–ç•¥" class="headerlink" title="GroupBuyStrategy å›¢è´­ä¼˜æƒ ç­–ç•¥"></a>GroupBuyStrategy å›¢è´­ä¼˜æƒ ç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupBuyStrategy</span> <span class="keyword">implements</span> <span class="title">IPromotionStrategy</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPromote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å›¢è´­ 5äººæˆå›¢&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EmptyStrategy-é»˜è®¤ç­–ç•¥"><a href="#EmptyStrategy-é»˜è®¤ç­–ç•¥" class="headerlink" title="EmptyStrategy é»˜è®¤ç­–ç•¥"></a>EmptyStrategy é»˜è®¤ç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmptyStrategy</span> <span class="keyword">implements</span> <span class="title">IPromotionStrategy</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPromote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ— ä»»ä½•ä¼˜æƒ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PromoteActivity-å®¢æˆ·ç«¯å’Œå…·ä½“ç®—æ³•ä¹‹é—´çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºæ¡¥æ¥"><a href="#PromoteActivity-å®¢æˆ·ç«¯å’Œå…·ä½“ç®—æ³•ä¹‹é—´çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºæ¡¥æ¥" class="headerlink" title="PromoteActivity å®¢æˆ·ç«¯å’Œå…·ä½“ç®—æ³•ä¹‹é—´çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºæ¡¥æ¥"></a>PromoteActivity å®¢æˆ·ç«¯å’Œå…·ä½“ç®—æ³•ä¹‹é—´çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºæ¡¥æ¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PromoteActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IPromotionStrategy promotionStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PromoteActivity</span><span class="params">(IPromotionStrategy promotionStrategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.promotionStrategy = promotionStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>&#123;</span><br><span class="line">        promotionStrategy.doPromote();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PromoteStrategyFactory-ç­–ç•¥å·¥å‚"><a href="#PromoteStrategyFactory-ç­–ç•¥å·¥å‚" class="headerlink" title="PromoteStrategyFactory ç­–ç•¥å·¥å‚"></a>PromoteStrategyFactory ç­–ç•¥å·¥å‚</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PromoteStrategyFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PromoteStrategyFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­–ç•¥å®¹å™¨  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, IPromotionStrategy&gt; promotionStrategyMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// é»˜è®¤ç©ºç­–ç•¥-æ²¡æœ‰ä»»ä½•ä¼˜æƒ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IPromotionStrategy emptyStrategy = <span class="keyword">new</span> EmptyStrategy();</span><br><span class="line">    <span class="comment">// è¿™ä¸ªå¯ä»¥æ”¾åˆ°é…ç½®æ–‡ä»¶æˆ–è€…æ”¾åˆ°æ•°æ®åº“ï¼Œåœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™åŠ è½½åˆ°æœåŠ¡ä¸­å°±å¯ä»¥äº†</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        promotionStrategyMap.put(PromoteKey.CASH_BACK, <span class="keyword">new</span> CashBackStrategy());</span><br><span class="line">        promotionStrategyMap.put(PromoteKey.COUPON, <span class="keyword">new</span> CouponStrategy());</span><br><span class="line">        promotionStrategyMap.put(PromoteKey.CROUP_BUY, <span class="keyword">new</span> GroupBuyStrategy());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç®€å•å·¥å‚åˆ›å»ºè¥é”€ç­–ç•¥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IPromotionStrategy <span class="title">createPromoteStrategy</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        IPromotionStrategy promotionStrategy = promotionStrategyMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (promotionStrategy == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> emptyStrategy;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> promotionStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰€æœ‰å®šä¹‰å¥½çš„ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">PromoteKey</span> </span>&#123;</span><br><span class="line">        String COUPON = <span class="string">&quot;coupon&quot;</span>;</span><br><span class="line">        String CROUP_BUY = <span class="string">&quot;groupBuy&quot;</span>;</span><br><span class="line">        String CASH_BACK = <span class="string">&quot;cashBack&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å› ä¸ºç­–ç•¥æ¨¡å¼éœ€è¦ç”¨æˆ·çŸ¥é“æ‰€æœ‰å¯ç”¨çš„ç­–ç•¥ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æš´éœ²ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">getPromoteKeySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> promotionStrategyMap.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•"><a href="#ç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•" class="headerlink" title="ç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•"></a>ç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•</h3> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String strategy = PromoteStrategyFactory.getPromoteKeySet().stream().findAny().get();</span><br><span class="line">    IPromotionStrategy promoteStrategy = PromoteStrategyFactory.createPromoteStrategy(strategy);</span><br><span class="line">    promoteStrategy.doPromote();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•"><a href="#éç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•" class="headerlink" title="éç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•"></a>éç­–ç•¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String strategy = <span class="string">&quot;å®¢æˆ·é€‰æ‹©çš„ç­–ç•¥&quot;</span>;</span><br><span class="line">    IPromotionStrategy promotionStrategy;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;å›¢è´­&quot;</span>.equals(strategy))&#123;</span><br><span class="line">         promotionStrategy = <span class="keyword">new</span> GroupBuyStrategy();</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;ä¼˜æƒ åˆ¸&quot;</span>.equals(strategy))&#123;</span><br><span class="line">        promotionStrategy = <span class="keyword">new</span> CouponStrategy();</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;ç°é‡‘æŠ˜è¿”&quot;</span>.equals(strategy))&#123;</span><br><span class="line">        promotionStrategy = <span class="keyword">new</span> CashBackStrategy();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        promotionStrategy = <span class="keyword">new</span> EmptyStrategy();</span><br><span class="line">    &#125;</span><br><span class="line">    promotionStrategy.doPromote();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šçš„å¯¹æ¯”ï¼Œå“ªç§æ–¹å¼æ¯”è¾ƒä¼˜é›…ï¼Œç«‹è§é«˜ä¸‹äº†å§ğŸ˜„ğŸ˜„ğŸ˜„   </p><h2 id="ç­–ç•¥æ¨¡å¼çš„ä¼˜ç‚¹"><a href="#ç­–ç•¥æ¨¡å¼çš„ä¼˜ç‚¹" class="headerlink" title="ç­–ç•¥æ¨¡å¼çš„ä¼˜ç‚¹"></a>ç­–ç•¥æ¨¡å¼çš„ä¼˜ç‚¹</h2><ul><li><strong>ç­–ç•¥æ¨¡å¼æ˜¯ç¬¦åˆå¼€é—­åŸåˆ™çš„</strong></li><li><strong>é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è½¬ç§»è¯­å¥ if-elseè¯­å¥ã€switchè¯­å¥ç­‰</strong></li><li><strong>ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥æé«˜ç®—æ³•çš„ä¿å¯†æ€§å’Œå®‰å…¨æ€§ï¼ˆå®¢æˆ·ç«¯é€šè¿‡ä¸Šä¸‹æ–‡ç»„å»ºæ¥è°ƒç”¨å…·ä½“çš„ç®—æ³•-æ¡¥æ¥ï¼‰</strong></li></ul><h2 id="ç­–ç•¥æ¨¡å¼çš„ç¼ºç‚¹"><a href="#ç­–ç•¥æ¨¡å¼çš„ç¼ºç‚¹" class="headerlink" title="ç­–ç•¥æ¨¡å¼çš„ç¼ºç‚¹"></a>ç­–ç•¥æ¨¡å¼çš„ç¼ºç‚¹</h2><ul><li><strong>å®¢æˆ·ç«¯å¿…é¡»è¦çŸ¥é“å…¨éƒ¨å¯ç”¨çš„ç­–ç•¥ï¼Œç„¶åç”±ç”¨æˆ·å†³å®šä½¿ç”¨é‚£ä¸ªç­–ç•¥ï¼Œå†³å®šæƒåœ¨äºå®¢æˆ·</strong></li><li><strong>ä»£ç ä¸­ä¼šäº§ç”Ÿå¾ˆå¤šçš„ç­–ç•¥ç±»ï¼Œå¢åŠ ä»£ç é‡å’Œç³»ç»Ÿçš„ç»´æŠ¤éš¾åº¦</strong></li></ul><h2 id="ğŸ‘¤ä¸ªäººä½“ä¼š"><a href="#ğŸ‘¤ä¸ªäººä½“ä¼š" class="headerlink" title="ğŸ‘¤ä¸ªäººä½“ä¼š"></a>ğŸ‘¤ä¸ªäººä½“ä¼š</h2><p>1ã€ç»“åˆä¸šåŠ¡åœºæ™¯æ¥è®¾è®¡ï¼Œä½“ä¼šè®¾è®¡æ¨¡å¼çš„æ€è·¯ï¼Œå­¦è®¾è®¡æ¨¡å¼æœ€é‡è¦çš„æ˜¯æ€æƒ³ï¼›<br>2ã€è®¾è®¡æ¨¡å¼ä¸€èˆ¬åœ¨æ¡†æ¶ä¸­ä½“ç°çš„æ¯”è¾ƒå¤šï¼Œå¤§å®¶å¯ä»¥å¤šå­¦ä¹ ä¸€äº›æ¡†æ¶æºç çš„è®¾è®¡ç†å¿µï¼Œå¦‚æœä½ æ˜¯åˆçº§ï¼Œå¯èƒ½ä¸€ä¸‹å­ç†è§£ä¸äº†ï¼Œæ…¢æ…¢ä½“ä¼šå§ï¼Œå½“ä½ å·¥ä½œä¸€æ®µæ—¶é—´ä¹‹åï¼Œè§è¿‡ä¸€äº›å·¥ä¸šç”Ÿäº§çš„é¡¹ç›®ï¼Œçœ‹è¿‡ä¸€äº›ä¼˜ç§€çš„æ¡†æ¶æºç çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ª â€œæŸ³æš—èŠ±æ˜åˆä¸€æ‘â€çš„é˜¶æ®µï¼›<br>3ã€ä¸¾ä¸ªä¾‹å­ï¼ŒControlleræˆ‘ä»¬éƒ½å†™è¿‡çš„ï¼Œä¸€ä¸ªé¡¹ç›®ä¸­çš„æ¥å£è·¯å¾„æ˜¯å”¯ä¸€çš„ï¼Œé¡¹ç›®å¯åŠ¨çš„æ—¶å€™ï¼Œç”±SpringåŠ è½½åˆ°å®¹å™¨ä¸­ï¼Œ<br>å½“ç”±è¯·æ±‚è¿›æ¥æ—¶æ˜¯ï¼ŒSpringæ˜¯æ ¹æ®pathæ¥è¿”å›å…·ä½“çš„æ§åˆ¶å™¨ï¼Œä¹Ÿå°±æ˜¯Controllerå…·ä½“çš„æ–¹æ³•ï¼›<br>4ã€è¿˜æœ‰Comparatoræ¯”è¾ƒå™¨ï¼Œä¸åŒçš„å®¹å™¨å†…éƒ¨åšæ•°æ®æ’åºçš„æ—¶å€™ç”±ä¸åŒçš„å®ç°ï¼Œè¿™ä¹Ÿæ˜¯ç­–ç•¥æ¨¡å¼çš„ä½“ç°ï¼›<br>5ã€æœ¬æ–‡ä¸­çš„ä¾‹å­è™½ç„¶ç®€å•ï¼Œä½†æ˜¯åŒ…å«äº†ç®€å•å·¥å‚æ¨¡å¼ï¼Œæ¡¥æ¥æ¨¡å¼ï¼Œç­–ç•¥æ¨¡å¼ã€‚ä»»ä½•ä¸€ç§è®¾è®¡æ¨¡å¼éƒ½éš¾ä»¥ç‹¬ç«‹å­˜åœ¨ï¼Œè¿™ä¸ªå¤§å®¶è¦æ³¨æ„ï¼›  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ç­–ç•¥æ¨¡å¼&quot;&gt;&lt;a href=&quot;#ç­–ç•¥æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;ç­–ç•¥æ¨¡å¼&quot;&gt;&lt;/a&gt;ç­–ç•¥æ¨¡å¼&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;ç­–ç•¥æ¨¡å¼&lt;/strong&gt;ï¼ˆStrategy Patternï¼‰ä¹Ÿå«åšæ”¿ç­–æ¨¡å¼ï¼ˆPolicy Patternï¼‰</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-æ¡¥æ¥æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T11:59:32.000Z</published>
    <updated>2021-08-07T12:05:24.908Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¡¥æ¥æ¨¡å¼ï¼ˆBridge-Patternï¼‰"><a href="#æ¡¥æ¥æ¨¡å¼ï¼ˆBridge-Patternï¼‰" class="headerlink" title="æ¡¥æ¥æ¨¡å¼ï¼ˆBridge Patternï¼‰"></a>æ¡¥æ¥æ¨¡å¼ï¼ˆBridge Patternï¼‰</h1><p>æ¡¥æ¥æ¨¡å¼ä¹Ÿç§°ä¸ºæ¡¥æ¢æ¨¡å¼ï¼Œæ¥å£ï¼ˆIntegerï¼‰æ¨¡å¼æˆ–è€…æŸ„ä½“ï¼ˆHandle and Bodyï¼‰æ¨¡å¼ï¼Œæ˜¯å°†æŠ½è±¡éƒ¨åˆ†å’Œå®ƒçš„å…·ä½“å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œæ˜¯å®ƒä»¬éƒ½å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–ï¼›</p><p>é€šè¿‡ç»„åˆçš„æ–¹å¼å»ºç«‹ä¸¤ä¸ªç±»ä¹‹é—´çš„è”ç³»ï¼Œè€Œä¸æ˜¯ç»§æ‰¿ï¼› æ¡¥æ¥æ¨¡å¼å±äºç»“æ„å‹æ¨¡å¼ï¼›  </p><p>ç»§æ‰¿ä¸€èˆ¬æ¥ä½œä¸ºå¤šç»§æ‰¿çš„å¤‡ç”¨æ–¹æ¡ˆï¼›  </p><h2 id="æ¡¥æ¥æ¨¡å¼çš„ç»“æ„"><a href="#æ¡¥æ¥æ¨¡å¼çš„ç»“æ„" class="headerlink" title="æ¡¥æ¥æ¨¡å¼çš„ç»“æ„"></a>æ¡¥æ¥æ¨¡å¼çš„ç»“æ„</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-0d535d57f31a3116d90f4022b039595b8cd.png" style="zoom:50%;" />  <p><strong>æ¡¥æ¥æ¨¡å¼ä¸»è¦åŒ…æ‹¬ä¸€ä¸‹å‡ ä¸ªè§’è‰²ï¼š</strong>  </p><p>1ã€<strong>æŠ½è±¡è§’è‰²ï¼ˆAbstractionï¼‰ï¼š</strong> å®šä¹‰æŠ½è±¡ç±»ï¼Œå¹¶åŒ…å«ä¸€ä¸ªå¯¹å®ç°åŒ–å¯¹è±¡çš„å¼•ç”¨ï¼Œæ­£æ˜¯è¿™ä¸ªå¼•ç”¨ï¼Œèµ·ç€æ¡¥æ¢æ€§çš„ä½œç”¨ï¼›<br>2ã€<strong>æ‰©å±•æŠ½è±¡åŒ–ï¼ˆRefined Abstractionï¼‰è§’è‰²</strong>ï¼š</p><h3 id="Abstraction"><a href="#Abstraction" class="headerlink" title="Abstraction"></a>Abstraction</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Abstraction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> IImplementor iImplementor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Abstraction</span><span class="params">(IImplementor iImplementor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iImplementor = iImplementor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iImplementor.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IImplementor"><a href="#IImplementor" class="headerlink" title="IImplementor"></a>IImplementor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IImplementor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcreteImplementA"><a href="#ConcreteImplementA" class="headerlink" title="ConcreteImplementA"></a>ConcreteImplementA</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteImplementA</span> <span class="keyword">implements</span> <span class="title">IImplementor</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcreteImplementB"><a href="#ConcreteImplementB" class="headerlink" title="ConcreteImplementB"></a>ConcreteImplementB</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteImplementB</span> <span class="keyword">implements</span> <span class="title">IImplementor</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="RefinedAbstraction"><a href="#RefinedAbstraction" class="headerlink" title="RefinedAbstraction"></a>RefinedAbstraction</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefinedAbstraction</span> <span class="keyword">extends</span> <span class="title">Abstraction</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RefinedAbstraction</span><span class="params">(IImplementor iImplementor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(iImplementor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸¾ä¸ªä¾‹å­"><a href="#ä¸¾ä¸ªä¾‹å­" class="headerlink" title="ä¸¾ä¸ªä¾‹å­"></a>ä¸¾ä¸ªä¾‹å­</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-e5443bab7294cf3d4213da30e87e593a889.png" style="zoom:50%;" />  <h3 id="AbstractMessage"><a href="#AbstractMessage" class="headerlink" title="AbstractMessage"></a>AbstractMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMessage</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> IMessage message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractMessage</span><span class="params">(IMessage message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg,String toUser)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message.send(msg,toUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IMessage"><a href="#IMessage" class="headerlink" title="IMessage"></a>IMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMessage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(String msg,String toUser)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SmsMessage"><a href="#SmsMessage" class="headerlink" title="SmsMessage"></a>SmsMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsMessage</span> <span class="keyword">implements</span> <span class="title">IMessage</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String msg, String toUser)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ä½¿ç”¨çŸ­ä¿¡æ¶ˆæ¯å‘é€ &quot;</span> + msg + <span class="string">&quot; å‘é€ç»™ &quot;</span> + toUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EmailMessage"><a href="#EmailMessage" class="headerlink" title="EmailMessage"></a>EmailMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailMessage</span> <span class="keyword">implements</span> <span class="title">IMessage</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String msg, String toUser)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ä½¿ç”¨é‚®ä»¶æ¶ˆæ¯å‘é€ &quot;</span> + msg + <span class="string">&quot; å‘é€ç»™ &quot;</span> + toUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NormalMessage"><a href="#NormalMessage" class="headerlink" title="NormalMessage"></a>NormalMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NormalMessage</span> <span class="keyword">extends</span> <span class="title">AbstractMessage</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NormalMessage</span><span class="params">(IMessage message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg, String toUser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.sendMsg(msg, toUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="UegencyMessage"><a href="#UegencyMessage" class="headerlink" title="UegencyMessage"></a>UegencyMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UegencyMessage</span> <span class="keyword">extends</span> <span class="title">AbstractMessage</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg,String toUser)</span></span>&#123;</span><br><span class="line">        msg = <span class="string">&quot;[ åŠ æ€¥]&quot;</span> + msg;</span><br><span class="line">        <span class="keyword">super</span>.sendMsg(msg,toUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UegencyMessage</span><span class="params">(IMessage message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DemoTest"><a href="#DemoTest" class="headerlink" title="DemoTest"></a>DemoTest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IMessage message = <span class="keyword">new</span> SmsMessage();</span><br><span class="line">        AbstractMessage abstractMessage = <span class="keyword">new</span> NormalMessage(message);</span><br><span class="line">        abstractMessage.sendMsg(<span class="string">&quot;åŠ ç­ç”³è¯·&quot;</span>,<span class="string">&quot;è€å¤§&quot;</span>);</span><br><span class="line"></span><br><span class="line">        message = <span class="keyword">new</span> EmailMessage();</span><br><span class="line">        abstractMessage = <span class="keyword">new</span> UegencyMessage(message);</span><br><span class="line">        abstractMessage.sendMsg(<span class="string">&quot;è°ƒä¼‘ç”³è¯·&quot;</span>,<span class="string">&quot;è€æ€»&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨çŸ­ä¿¡æ¶ˆæ¯å‘é€ åŠ ç­ç”³è¯· å‘é€ç»™ è€å¤§</span><br><span class="line">ä½¿ç”¨é‚®ä»¶æ¶ˆæ¯å‘é€ [ åŠ æ€¥]è°ƒä¼‘ç”³è¯· å‘é€ç»™ è€æ€»</span><br></pre></td></tr></table></figure><h2 id="æ¡¥æ¥æ¨¡å¼çš„é€‚ç”¨åœºæ™¯"><a href="#æ¡¥æ¥æ¨¡å¼çš„é€‚ç”¨åœºæ™¯" class="headerlink" title="æ¡¥æ¥æ¨¡å¼çš„é€‚ç”¨åœºæ™¯"></a>æ¡¥æ¥æ¨¡å¼çš„é€‚ç”¨åœºæ™¯</h2><p>1ã€åœ¨æŠ½è±¡å’Œå…·ä½“å®ç°ä¹‹é—´éœ€è¦å¢åŠ æ›´å¤šçš„çµæ´»æ€§çš„åœºæ™¯ï¼›<br>2ã€ä¸€ä¸ªç±»åœ¨ä¸¤ä¸ªæˆ–è€…å¤šä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œè€Œè¿™ä¸¤ä¸ªæˆ–å¤šä¸ªç»´åº¦éƒ½éœ€è¦ç‹¬ç«‹çš„è¿›è¡Œæ‹“å±•<br>3ã€ä¸å¸Œæœ›ä½¿ç”¨ç»§æ‰¿ï¼Œæˆ–è€…å› ä¸ºå¤šå±‚ç»§æ‰¿å¯¼è‡´ç³»ç»Ÿç±»çš„ä¸ªæ•°å‰§å¢ï¼›  </p><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-e40c001a6bb521fdb429fd7436df93981f8.png">  </p><h2 id="æ¡¥æ¥æ¨¡å¼çš„ä¼˜ç‚¹"><a href="#æ¡¥æ¥æ¨¡å¼çš„ä¼˜ç‚¹" class="headerlink" title="æ¡¥æ¥æ¨¡å¼çš„ä¼˜ç‚¹"></a>æ¡¥æ¥æ¨¡å¼çš„ä¼˜ç‚¹</h2><p>1ã€éµå¾ªè½¯ä»¶è®¾è®¡åŸåˆ™ï¼Œåˆ†ç¦»æŠ½è±¡éƒ¨åˆ†å’Œå…·ä½“å®ç°éƒ¨åˆ†<br>2ã€æé«˜äº†ç³»ç»Ÿçš„æ‰©å±•æ€§<br>3ã€ç¬¦åˆå¼€é—­åŸåˆ™<br>4ã€ç¬¦åˆåˆæˆå¤ç”¨åŸåˆ™  ä¸ä½¿ç”¨ç»§æ‰¿è€Œä½¿ç”¨ç»„åˆ  </p><h2 id="æ¡¥æ¥æ¨¡å¼"><a href="#æ¡¥æ¥æ¨¡å¼" class="headerlink" title="æ¡¥æ¥æ¨¡å¼"></a>æ¡¥æ¥æ¨¡å¼</h2><p>1ã€å¢åŠ äº†ç³»ç»Ÿä»£ç å¯è¯»æ€§å’Œå¤æ‚æ€§<br>2ã€éœ€è¦æ­£ç¡®è¯†åˆ«äº¤æ¥çš„ä¸åŒç»´åº¦    </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ¡¥æ¥æ¨¡å¼ï¼ˆBridge-Patternï¼‰&quot;&gt;&lt;a href=&quot;#æ¡¥æ¥æ¨¡å¼ï¼ˆBridge-Patternï¼‰&quot; class=&quot;headerlink&quot; title=&quot;æ¡¥æ¥æ¨¡å¼ï¼ˆBridge Patternï¼‰&quot;&gt;&lt;/a&gt;æ¡¥æ¥æ¨¡å¼ï¼ˆBridge Patternï¼‰&lt;/h1&gt;&lt;</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-å»ºé€ è€…æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T11:55:36.000Z</published>
    <updated>2021-08-07T11:58:49.307Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h1><p> å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰å°†ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹ä¸å®ƒçš„è¡¨ç¤ºï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºå‡ºä¸åŒçš„è¡¨ç¤ºã€‚<br> å»ºé€ è€…æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼›</p><p>å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œä½¿ç”¨å»ºé€ è€…æ¨¡å¼åªéœ€è¦æŒ‡å®šéœ€è¦åˆ›å»ºçš„ç±»å‹å°±å¯ä»¥è·å–å¯¹è±¡ï¼Œåˆ›å»ºçš„è¿‡ç¨‹ä»¥åŠç»†èŠ‚ä¸éœ€è¦äº†è§£ï¼Œæ ¹æ®å»ºé€ è€…æ¨¡å¼çš„å®šä¹‰ï¼Œå¯ä»¥ç®€å•çš„ç†è§£<br>ä¸ºä¸¤å±‚å«ä¹‰ï¼š<br>1ã€æ„å»ºä¸è¡¨ç¤ºåˆ†ç¦»ï¼›æ„å»ºä»£è¡¨å¯¹è±¡åˆ›å»ºï¼Œè¡¨ç¤ºä»£è¡¨å¯¹è±¡è¡Œä¸ºï¼Œæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å°†å¯¹è±¡çš„åˆ›å»ºä¸è¡Œä¸ºåˆ†ç¦»ï¼›ï¼ˆå¯¹åº”åˆ°Javaä»£ç ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨æ¥å£è§„èŒƒè¡Œä¸ºï¼Œ<br>ç„¶åç”±å…·ä½“çš„å®ç°è¿›è¡Œæ„å»ºï¼‰<br>2ã€åˆ›å»ºä¸åŒçš„è¡¨ç¤ºï¼›ä¹Ÿå°±æ˜¯å…·å¤‡åŒæ ·çš„è¡Œä¸ºï¼Œä½†æ˜¯å´ç”±äºæ„å»ºçš„è¡Œä¸ºé¡ºåºä¸åŒæˆ–å…¶ä»–åŸå› å¯ä»¥åˆ›å»ºå‡ºä¸åŒçš„è¡¨ç¤ºï¼›</p><h3 id="Course"><a href="#Course" class="headerlink" title="Course"></a>Course</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Course</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String ppt;</span><br><span class="line">    <span class="keyword">private</span> String video;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    <span class="keyword">private</span> String homework;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CourseBuilder"><a href="#CourseBuilder" class="headerlink" title="CourseBuilder"></a>CourseBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Course course = <span class="keyword">new</span> Course();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CourseBuilder <span class="title">addName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        course.setName(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CourseBuilder <span class="title">addHomework</span><span class="params">(String homework)</span></span>&#123;</span><br><span class="line">        course.setHomework(homework);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CourseBuilder <span class="title">addVideo</span><span class="params">(String video)</span></span>&#123;</span><br><span class="line">        course.setVideo(video);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CourseBuilder <span class="title">addPpt</span><span class="params">(String ppt)</span></span>&#123;</span><br><span class="line">        course.setPpt(ppt);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CourseBuilder <span class="title">addNote</span><span class="params">(String note)</span></span>&#123;</span><br><span class="line">        course.setNote(note);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Course <span class="title">builder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> course;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DomoTest-æµ‹è¯•"><a href="#DomoTest-æµ‹è¯•" class="headerlink" title="DomoTest æµ‹è¯•"></a>DomoTest æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DomoTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CourseBuilder courseBuilder = <span class="keyword">new</span> CourseBuilder();</span><br><span class="line">        courseBuilder.addHomework(<span class="string">&quot;è¯¾åä½œä¸š111&quot;</span>)</span><br><span class="line">        .addName(<span class="string">&quot;è®¾è®¡æ¨¡å¼&quot;</span>)</span><br><span class="line">        .addNote(<span class="string">&quot;è¯¾å ‚ç¬”è®°&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;courseBuilder = &quot;</span> + courseBuilder.builder());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">courseBuilder = Course(name=è®¾è®¡æ¨¡å¼, ppt=null, video=null, note=è¯¾å ‚ç¬”è®°, homework=è¯¾åä½œä¸š111)</span><br></pre></td></tr></table></figure><h2 id="å»ºé€ è€…åœ¨JDKä¸­çš„åº”ç”¨"><a href="#å»ºé€ è€…åœ¨JDKä¸­çš„åº”ç”¨" class="headerlink" title="å»ºé€ è€…åœ¨JDKä¸­çš„åº”ç”¨"></a>å»ºé€ è€…åœ¨JDKä¸­çš„åº”ç”¨</h2><h3 id="StringBuilder"><a href="#StringBuilder" class="headerlink" title="StringBuilder"></a>StringBuilder</h3><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-2381a159db921a2ce7d6b78fac5d7260ffd.png" style="zoom:50%;" /><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StringBuilder</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractStringBuilder</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>, <span class="title">CharSequence</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="java-lang-StringBuilder-append-java-lang-CharSequence"><a href="#java-lang-StringBuilder-append-java-lang-CharSequence" class="headerlink" title="java.lang.StringBuilder.append(java.lang.CharSequence)"></a>java.lang.StringBuilder.append(java.lang.CharSequence)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> StringBuilder <span class="title">append</span><span class="params">(CharSequence s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.append(s);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„StringBuilderå°±æ˜¯ä¸€ä¸ªå®ç°æ„é€ å™¨ï¼Œåªä¸è¿‡å®ƒçš„ä¸Šçº§è¿˜æœ‰ä¸€ä¸ªæŠ½è±¡çš„æ„é€ å™¨AbstractStringBuilder;<br>çœ‹åˆ°è¿™æºç æ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬ä¸Šé¢ä¸¾çš„ä¾‹å­ç±»ä¼¼å‘¢ï¼Œè¿™å°±æ˜¯JDKæºç ä¸­å¾ˆå…¸å‹çš„å»ºé€ è€…æ¨¡å¼çš„åº”ç”¨ï¼›<br>å¤„ç†ä¸Šé¢çš„StringBuilderä¹‹å¤–ï¼Œè¿˜æœ‰åƒMybatisæ¡†æ¶ä¸­çš„CacheBuilderç¼“å­˜æ„é€ å™¨ï¼Œè¿˜æœ‰åƒSqlSessionFactoryè£…è½½æ—¶çš„openSessionæ–¹æ³•éƒ½æ˜¯å»ºé€ è€…æ¨¡å¼ï¼›</p><h2 id="å»ºé€ è€…æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"><a href="#å»ºé€ è€…æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="å»ºé€ è€…æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"></a>å»ºé€ è€…æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯</h2><ul><li><strong>é€‚ç”¨äºåˆ›å»ºå¯¹è±¡éœ€è¦å¾ˆå¤šæ­¥éª¤ï¼Œä½†æ˜¯æ­¥éª¤çš„é¡ºåºä¸ä¸€å®šæ˜¯å›ºå®šçš„</strong></li><li><strong>å¦‚æœä¸€ä¸ªå¯¹è±¡æœ‰éå¸¸å¤æ‚çš„å†…éƒ¨ç»“æ„ï¼ˆæœ‰å¾ˆå¤šçš„æˆå‘˜å˜é‡æˆ–å±æ€§ï¼‰</strong></li><li><strong>æŠŠå¤æ‚å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»</strong></li></ul><h2 id="å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹"><a href="#å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹" class="headerlink" title="å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹"></a>å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹</h2><ul><li><strong>å°è£…è¡Œå¾ˆå¥½ï¼Œä½¿å¾—åˆ›å»ºè¿‡ç¨‹å’Œä½¿ç”¨åˆ†ç¦»å¼€</strong></li><li><strong>æ‰©å±•æ€§å¥½ï¼Œå»ºé€ ç±»ä¹‹é—´ç‹¬ç«‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šè§£è€¦</strong></li><li><strong>ä¾¿äºæ§åˆ¶ç»†èŠ‚ï¼Œå»ºé€ è€…å¯ä»¥å¯¹åˆ›å»ºè¿‡ç¨‹é€æ­¥ç»†åŒ–ï¼Œè€Œä¸å¯¹å…¶ä»–æ¨¡å—äº§ç”Ÿä»»ä½•å½±å“</strong> </li></ul><h2 id="å»ºé€ è€…æ¨¡å¼çš„ç¼ºç‚¹"><a href="#å»ºé€ è€…æ¨¡å¼çš„ç¼ºç‚¹" class="headerlink" title="å»ºé€ è€…æ¨¡å¼çš„ç¼ºç‚¹"></a>å»ºé€ è€…æ¨¡å¼çš„ç¼ºç‚¹</h2><ul><li><strong>äº§ç”Ÿäº†å¯¹äºçš„Builderå¯¹è±¡ï¼Œé€ æˆäº†ç±»çš„å†—ä½™</strong></li><li><strong>å¦‚æœäº§å“å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œå»ºé€ è€…éƒ½è¦ä¿®æ”¹ï¼Œç»´æŠ¤æˆæœ¬æ¯”è¾ƒå¤§ï¼›ä¸é€‚åˆç»å¸¸å˜åŠ¨çš„å¯¹è±¡ï¼Œè¿™æ ·ä¹Ÿæ˜¯ä¸ç¬¦åˆå¼€é—­åŸåˆ™çš„</strong></li></ul><h2 id="å»ºé€ è€…æ¨¡å¼å’Œå·¥å‚æ¨¡å¼çš„å¯¹æ¯”"><a href="#å»ºé€ è€…æ¨¡å¼å’Œå·¥å‚æ¨¡å¼çš„å¯¹æ¯”" class="headerlink" title="å»ºé€ è€…æ¨¡å¼å’Œå·¥å‚æ¨¡å¼çš„å¯¹æ¯”"></a>å»ºé€ è€…æ¨¡å¼å’Œå·¥å‚æ¨¡å¼çš„å¯¹æ¯”</h2><ul><li><strong>å»ºé€ è€…æ¨¡å¼æ›´åŠ æ³¨é‡æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼Œå·¥å‚æ¨¡å¼æ³¨é‡äºå¯¹è±¡çš„åˆ›å»º</strong></li><li><strong>åˆ›å»ºå¯¹è±¡çš„åŠ›åº¦ä¸åŒï¼Œå»ºé€ è€…æ¨¡å¼åˆ›å»ºå¤æ‚çš„å¯¹è±¡ï¼Œç”±å„ç§å¤æ‚çš„ç»„ä»¶ç»„æˆï¼Œå·¥å‚æ¨¡å¼åˆ›å»ºå‡ºæ¥å¯¹è±¡çš„éƒ½ä¸€æ ·</strong></li><li><strong>å…³æ³¨ç‚¹ä¸åŒï¼Œå·¥å‚æ¨¡å¼åªéœ€è¦å§å¯¹è±¡åˆ›å»ºå‡ºæ¥å°±å¯ä»¥äº†ï¼Œè€Œå»ºé€ è€…æ¨¡å¼ä¸­ä¸ä»…è¦åˆ›å»ºå‡ºè¿™ä¸ªå¯¹è±¡ï¼Œè¿˜è¦çŸ¥é“è¿™ä¸ªå¯¹è±¡ç”±é‚£äº›ç»„ä»¶ç»„æˆ</strong></li><li><strong>å»ºé€ è€…æ¨¡å¼æ ¹æ®å»ºé€ è¿‡ç¨‹ä¸­çš„é¡ºåºä¸ä¸€æ ·ï¼Œæœ€ç»ˆçš„å¯¹è±¡ä¸è§ç»„æˆä¹Ÿä¸ä¸€æ ·ï¼Œå¯¹è±¡çš„æ¯ä¸ªéƒ¨ä»¶çš„è®¾ç½®éƒ½æ˜¯å¾ˆçµæ´»çš„</strong></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å»ºé€ è€…æ¨¡å¼&quot;&gt;&lt;a href=&quot;#å»ºé€ è€…æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;å»ºé€ è€…æ¨¡å¼&quot;&gt;&lt;/a&gt;å»ºé€ è€…æ¨¡å¼&lt;/h1&gt;&lt;p&gt; å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰å°†ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹ä¸å®ƒçš„è¡¨ç¤ºï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºå‡ºä¸åŒ</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-å·¥å‚æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T11:40:56.000Z</published>
    <updated>2021-08-07T11:48:14.308Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-ç®€å•å·¥å‚æ¨¡å¼"><a href="#1-ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="1. ç®€å•å·¥å‚æ¨¡å¼"></a>1. ç®€å•å·¥å‚æ¨¡å¼</h2><p>ç®€å•å·¥å‚æ¨¡å¼æ˜¯æŒ‡æœ‰ä¸€ä¸ªå·¥å‚å¯¹è±¡å†³å®šåˆ›å»ºå‡ºå“ªä¸€ä¸ªäº§å“ç±»çš„å®ä¾‹ï¼›å±äº<code>åˆ›å»ºå‹æ¨¡å¼</code>ï¼Œä½†å®ƒä¸å±äºGOF 23ç§è®¾è®¡æ¨¡å¼ã€‚</p><p>UMLç±»å›¾<br><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-2e06fcc599aa2313d88c542a32a125934fc.png" style="zoom:50%;" /></p><p><strong>ç»„æˆè¦ç´ </strong><br>1ã€ä¸€ä¸ªæŠ½è±¡äº§å“ç±»<br>2ã€å…·ä½“äº§å“ç±»<br>3ã€ä¸€ä¸ªå·¥å‚  </p><p><strong>è‚¥å®…å–œçˆ±çš„å„ç§å¿«ä¹æ°´ï¼ˆäº§å“æ¥å£ï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Kls</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è‚¥å®…å¿«ä¹æ°´-å¯ä¹ï¼ˆå…·ä½“äº§å“ï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Coke</span> <span class="keyword">implements</span> <span class="title">Kls</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;è‚¥å®…å¿«ä¹æ°´-å¯ä¹&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¿«ä¹æ°´-é›ªç¢§ï¼ˆå…·ä½“äº§å“ï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sprite</span> <span class="keyword">implements</span> <span class="title">Kls</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;å¿«ä¹æ°´-é›ªç¢§&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¿«ä¹æ°´ç”Ÿäº§å·¥å‚(å·¥å‚ç±»)</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KlsFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Kls <span class="title">getFzs</span><span class="params">(String type)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Kls fzs = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;coke&quot;</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">            fzs = <span class="keyword">new</span> Coke();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;sprite&quot;</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">            fzs = <span class="keyword">new</span> Sprite();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(fzs)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;æ²¡æ‰¾åˆ°å¿«ä¹æ°´~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fzs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®¢æˆ·ç«¯ä½¿ç”¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fz</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drink</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ¶é€ å¯ä¹</span></span><br><span class="line">        Kls coke = KlsFactory.getFzs(<span class="string">&quot;coke&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;è‚¥å®…å¼€å§‹å–ï¼š&quot;</span> + coke.name());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¶é€ é›ªç¢§</span></span><br><span class="line">        Kls sprite = KlsFactory.getFzs(<span class="string">&quot;sprite&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;è‚¥å®…å¼€å§‹å–ï¼š&quot;</span> + sprite.name());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="1-1-ä¼˜ç‚¹"><a href="#1-1-ä¼˜ç‚¹" class="headerlink" title="1.1 ä¼˜ç‚¹"></a>1.1 ä¼˜ç‚¹</h3><ul><li>å¯¹å®¢æˆ·ç«¯éšè—çš„å…·ä½“çš„å®ç°ï¼Œå®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“è¦åˆ›å»ºä»€ä¹ˆå¯¹è±¡å³å¯ï¼Œä¸ç”¨å…³å¿ƒå¯¹è±¡æ˜¯æ€ä¹ˆåˆ›å»ºçš„</li><li>è§£è€¦ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦é€šè¿‡newæ¥åˆ›å»ºå¯¹è±¡ï¼Œå¦‚æœåæœŸäº§å“ç±»éœ€è¦ä¿®æ”¹ï¼Œåˆ™åªéœ€è¦ä¿®æ”¹å·¥å‚ç±»å³å¯ï¼Œä¸ç”¨æ•´ä¸ªé¡¹ç›®éåœ°å»å¯»æ‰¾å“ªé‡Œæœ‰new </li></ul><h3 id="1-2-ç¼ºç‚¹"><a href="#1-2-ç¼ºç‚¹" class="headerlink" title="1.2 ç¼ºç‚¹"></a>1.2 ç¼ºç‚¹</h3><ul><li>ç”±ä¸€ä¸ªä¸“é—¨çš„å·¥å‚è´Ÿè´£ç”Ÿäº§ï¼Œå¦‚æœä¸šåŠ¡å˜å¾—å¤æ‚ï¼Œè¿™ä¸ªç±»å°†å˜å¾—ååˆ†è‡ƒè‚¿</li><li>å·¥å‚ç±»ç”Ÿäº§ä»€ä¹ˆäº§å“éƒ½æ˜¯å†™æ­»åœ¨å·¥å‚ä¸­çš„ï¼Œå¦‚æœå¢åŠ æ–°çš„äº§å“ï¼Œè¿˜è¦ä¿®æ”¹å·¥å‚ç±»çš„ç”Ÿäº§é€»è¾‘</li></ul><h2 id="2-å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#2-å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="2. å·¥å‚æ–¹æ³•æ¨¡å¼"></a>2. å·¥å‚æ–¹æ³•æ¨¡å¼</h2><p>å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory Methodï¼‰æ˜¯ç®€å•å·¥å‚çš„ä»…ä¸€æ­¥æ·±åŒ–ï¼Œ åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬ä¸å†æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å·¥å‚ç±»æ¥åˆ›å»ºæ‰€æœ‰çš„å¯¹è±¡ï¼Œè€Œæ˜¯é’ˆå¯¹ä¸åŒçš„å¯¹è±¡æä¾›ä¸åŒçš„å·¥å‚ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„å·¥å‚ã€‚<br><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-11fa4bfb1062c445c055e49bc1d00b7d9cf.png" style="zoom:50%;" /></p><p><strong>ç»„æˆè¦ç´ </strong><br>1ã€ä¸€ä¸ªæŠ½è±¡äº§å“ç±»<br>2ã€å¤šä¸ªå…·ä½“äº§å“ç±»<br>3ã€ä¸€ä¸ªæŠ½è±¡å·¥å‚<br>4ã€å¤šä¸ªå…·ä½“å·¥å‚ - æ¯ä¸€ä¸ªå…·ä½“äº§å“å¯¹åº”ä¸€ä¸ªå…·ä½“å·¥å‚<br>5ã€ç¬¦åˆ - OCPå¼€æ”¾å°é—­åŸåˆ™  </p><p>æ¥ç€ä¸Šé¢å¿«ä¹æ°´çš„ä¾‹å­ã€‚å°† å¿«ä¹æ°´å·¥å‚ ï¼ˆKlsFactoryï¼‰ æŠ½è±¡å‡ºå…±æœ‰æ–¹æ³•ï¼Œå†åˆ†åˆ«å®ç°å…·ä½“çš„å¿«ä¹æ°´ç”Ÿäº§å·¥å‚ã€‚</p><p><strong>å¿«ä¹æ°´æ€»å·¥å‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¶é€ å¿«ä¹æ°´</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Kls</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Kls <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¯ä¹å·¥å‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CokeFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Kls <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Coke();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é›ªç¢§å·¥å‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpriteFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Kls <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Sprite();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è‚¥å®…(å®¢æˆ·ç«¯)</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fz</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drink</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ¶é€ å¯ä¹</span></span><br><span class="line">        CokeFactory cokeFactory = <span class="keyword">new</span> CokeFactory();</span><br><span class="line">        Kls coke = cokeFactory.create();</span><br><span class="line">        System.out.println(<span class="string">&quot;è‚¥å®…å¼€å§‹å–ï¼š&quot;</span> + coke.name());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¶é€ é›ªç¢§</span></span><br><span class="line">        SpriteFactory spriteFactory = <span class="keyword">new</span> SpriteFactory();</span><br><span class="line">        Kls sprite = spriteFactory.create();</span><br><span class="line">        System.out.println(<span class="string">&quot;è‚¥å®…å¼€å§‹å–ï¼š&quot;</span> + sprite.name());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰©å±•èŠ¬è¾¾å¿«ä¹æ°´</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fanta</span> <span class="keyword">implements</span> <span class="title">Kls</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;å¿«ä¹æ°´-èŠ¬è¾¾&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¤åˆ¶ä»£ç èŠ¬è¾¾å·¥å‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FantaFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Kls <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Fanta();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è‚¥å®…ä½¿ç”¨æ·»åŠ </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FantaFactory fantaFactory = <span class="keyword">new</span> FantaFactory();</span><br><span class="line">Kls fanta = fantaFactory.create();</span><br><span class="line">System.out.println(<span class="string">&quot;è‚¥å®…å¼€å§‹å–ï¼š&quot;</span> + fanta.name());</span><br></pre></td></tr></table></figure><h3 id="2-1-ä¼˜ç‚¹"><a href="#2-1-ä¼˜ç‚¹" class="headerlink" title="2.1 ä¼˜ç‚¹"></a>2.1 ä¼˜ç‚¹</h3><p>1ã€é™ä½äº†ä»£ç è€¦åˆåº¦ï¼Œå¯¹è±¡çš„ç”Ÿæˆäº¤ç»™å­ç±»å»å®Œæˆï¼ˆè¿™é‡Œçš„è€¦åˆåº¦æ˜¯ç›¸å¯¹äºç®€å•å·¥å‚æ¨¡å¼çš„å·¥å‚ç±»æ¯”è¾ƒçš„ï¼‰<br>2ã€é™ä½äº†ä»£ç è€¦åˆåº¦ï¼Œå¯¹è±¡çš„ç”Ÿæˆäº¤ç»™å­ç±»å»å®Œæˆ  </p><h3 id="2-2-ç¼ºç‚¹"><a href="#2-2-ç¼ºç‚¹" class="headerlink" title="2.2 ç¼ºç‚¹"></a>2.2 ç¼ºç‚¹</h3><p>1ã€å¢åŠ äº†ä»£ç é‡ï¼Œæ¯ä¸ªå…·ä½“äº§å“éƒ½éœ€è¦ä¸€ä¸ªå…·ä½“å·¥å‚ï¼ˆåœ¨å…·ä½“çš„ä¸šåŠ¡ä¸­å¯èƒ½ä¼šäº§ç”Ÿå¤§é‡çš„é‡å¤ä»£ç ï¼‰<br>2ã€å½“å¢åŠ æŠ½è±¡äº§å“ ä¹Ÿå°±æ˜¯æ·»åŠ ä¸€ä¸ªå…¶ä»–äº§å“æ— éœ€è¦ä¿®æ”¹å·¥å‚ è¿èƒŒOCP</p><h2 id="3-æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#3-æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="3. æŠ½è±¡å·¥å‚æ¨¡å¼"></a>3. æŠ½è±¡å·¥å‚æ¨¡å¼</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-9121de8d650bac2739bb7ad27f1f4174a0c.png" style="zoom:50%;" /><p><strong>ç»„æˆè¦ç´ </strong><br>1ã€å¤šä¸ªæŠ½è±¡äº§å“ç±»<br>2ã€å…·ä½“äº§å“ç±»<br>3ã€æŠ½è±¡å·¥å‚ç±» - å£°æ˜(ä¸€ç»„)è¿”å›æŠ½è±¡äº§å“çš„æ–¹æ³•<br>4ã€å…·ä½“å·¥å‚ç±» - ç”Ÿæˆ(ä¸€ç»„)å…·ä½“äº§å“  </p><p><strong>ä¸€ä¸ªæŠ½è±¡äº§å“ç±»å’Œä¸¤ä¸ªå…·ä½“çš„äº§å“ï¼ˆå¯ä¹ï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Coke</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doCreate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalCoke</span> <span class="keyword">extends</span> <span class="title">Coke</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ç”Ÿäº§æœ¬åœŸå¯ä¹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForeignCoke</span> <span class="keyword">extends</span> <span class="title">Coke</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”Ÿäº§å¤–å›½å¯ä¹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæŠ½è±¡äº§å“ç±»å’Œä¸¤ä¸ªå…·ä½“çš„äº§å“ï¼ˆé›ªç¢§ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Sprite</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doCreate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalSprite</span> <span class="keyword">extends</span> <span class="title">Sprite</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ç”Ÿäº§æœ¬åœ°é›ªç¢§&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForeignSprite</span> <span class="keyword">extends</span> <span class="title">Sprite</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;ç”Ÿäº§å¤–å›½é›ªç¢§&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸€ä¸ªæŠ½è±¡å·¥å‚å’Œä¸¤ä¸ªå…·ä½“çš„å·¥å‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IAbstractFactory</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æˆäº§å¯ä¹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å£°æ˜(ä¸€ç»„)è¿”å›æŠ½è±¡äº§å“çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Coke <span class="title">createCoke</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿäº§é›ªç¢§</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å£°æ˜(ä¸€ç»„)è¿”å›æŠ½è±¡äº§å“çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Sprite <span class="title">createSprite</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalFactory</span> <span class="keyword">implements</span> <span class="title">IAbstractFactory</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æˆäº§å¯ä¹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç”Ÿæˆ(ä¸€ç»„)å…·ä½“äº§å“  </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalCoke <span class="title">createCoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LocalCoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿäº§é›ªç¢§</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç”Ÿæˆ(ä¸€ç»„)å…·ä½“äº§å“  </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalSprite <span class="title">createSprite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LocalSprite();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForeignFactory</span> <span class="keyword">implements</span> <span class="title">IAbstractFactory</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æˆäº§å¯ä¹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç”Ÿæˆ(ä¸€ç»„)å…·ä½“äº§å“  </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ForeignCoke <span class="title">createCoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ForeignCoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿäº§é›ªç¢§</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç”Ÿæˆ(ä¸€ç»„)å…·ä½“äº§å“  </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ForeignSprite <span class="title">createSprite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ForeignSprite();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-1-æŠ½è±¡å·¥å‚çš„ä½¿ç”¨"><a href="#3-1-æŠ½è±¡å·¥å‚çš„ä½¿ç”¨" class="headerlink" title="3.1 æŠ½è±¡å·¥å‚çš„ä½¿ç”¨"></a>3.1 æŠ½è±¡å·¥å‚çš„ä½¿ç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LocalFactory localFactory = <span class="keyword">new</span> LocalFactory();</span><br><span class="line">        LocalCoke localCoke = localFactory.createCoke();</span><br><span class="line">        localCoke.doCreate();</span><br><span class="line"></span><br><span class="line">        ForeignFactory foreignFactory = <span class="keyword">new</span> ForeignFactory();</span><br><span class="line">        ForeignSprite foreignSprite = foreignFactory.createSprite();</span><br><span class="line">        foreignSprite.doCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-ä¼˜ç‚¹"><a href="#3-2-ä¼˜ç‚¹" class="headerlink" title="3.2 ä¼˜ç‚¹"></a>3.2 ä¼˜ç‚¹</h3><p>1ã€ä»£ç è§£è€¦<br>2ã€å¾ˆå¥½çš„æ»¡è¶³OCPå¼€æ”¾å°é—­åŸåˆ™<br>3ã€æŠ½è±¡å·¥å‚æ¨¡å¼ä¸­æˆ‘ä»¬å¯ä»¥å®šä¹‰å®ç°ä¸æ­¢ä¸€ä¸ªæ¥å£ï¼Œä¸€ä¸ªå·¥å‚ä¹Ÿå¯ä»¥ç”Ÿæˆä¸æ­¢ä¸€ä¸ªäº§å“ç±» å¯¹äºå¤æ‚å¯¹è±¡çš„ç”Ÿäº§ç›¸å½“çµæ´»æ˜“æ‰©å±•<br>(ç›¸å¯¹äºå·¥å‚æ–¹æ³•æ¨¡å¼çš„ä¼˜åŒ–)  </p><h3 id="3-3-ç¼ºç‚¹"><a href="#3-3-ç¼ºç‚¹" class="headerlink" title="3.3 ç¼ºç‚¹"></a>3.3 ç¼ºç‚¹</h3><p>1ã€æ‰©å±•äº§å“æ˜¯éœ€è¦ä¿®æ”¹æ‰€æœ‰å·¥å‚ï¼Œè¿åè¿åOCPåŸåˆ™<br>2ã€æ•´ä½“å®ç°ä¹Ÿæ¯”è¾ƒå¤æ‚  </p><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><blockquote><ul><li><a href="https://juejin.im/post/6844903650641330189">è®¾è®¡æ¨¡å¼-ç®€å•å·¥å‚ã€å·¥å‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼</a></li><li><a href="https://juejin.im/post/6844903780819927054">è®¾è®¡æ¨¡å¼ â€”â€” å·¥å‚æ¨¡å¼</a></li></ul></blockquote><p align="middle" > è¿˜æœ‰å¤šå°‘ä¸ªåå¹´ ç»§ç»­åšçƒ­è¡€å°‘å¹´ </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-ç®€å•å·¥å‚æ¨¡å¼&quot;&gt;&lt;a href=&quot;#1-ç®€å•å·¥å‚æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;1. ç®€å•å·¥å‚æ¨¡å¼&quot;&gt;&lt;/a&gt;1. ç®€å•å·¥å‚æ¨¡å¼&lt;/h2&gt;&lt;p&gt;ç®€å•å·¥å‚æ¨¡å¼æ˜¯æŒ‡æœ‰ä¸€ä¸ªå·¥å‚å¯¹è±¡å†³å®šåˆ›å»ºå‡ºå“ªä¸€ä¸ªäº§å“ç±»çš„å®ä¾‹ï¼›å±äº&lt;code&gt;åˆ›å»ºå‹æ¨¡å¼&lt;</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-åŸå‹æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T11:31:43.000Z</published>
    <updated>2021-08-07T11:39:12.030Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŸå‹æ¨¡å¼"><a href="#åŸå‹æ¨¡å¼" class="headerlink" title="åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h1><p>åŸå‹æ¨¡å¼ï¼ˆPrototype Patternï¼‰æŒ‡åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡å¤åˆ¶è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œå±äºåˆ›<br>å»ºå‹æ¨¡å¼ï¼›</p><p>åŸå‹æ¨¡å¼çš„æ ¸å¿ƒåœ¨äºå¤åˆ¶åŸå‹å¯¹è±¡ã€‚ä»¥ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„ä¸€ä¸ªå¯¹è±¡ä¸ºåŸå‹ï¼Œç›´æ¥åŸºäºå†…å­˜äºŒè¿›åˆ¶æµè¿›è¡Œå¤åˆ¶ï¼Œä¸éœ€è¦<br>å†ç²¾åŠ›è€—æ—¶çš„å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ï¼ˆä¸è°ƒç”¨æ„é€ å‡½æ•°ï¼‰ï¼Œæ€§èƒ½æå‡å¾ˆå¤šã€‚å½“å¯¹è±¡çš„æ„é€ è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶æ—¶ï¼Œå¯ä»¥æŠŠå½“å‰ç³»ç»Ÿ<br>å·²å­˜åœ¨çš„å¯¹è±¡ä½œä¸ºåŸå‹ï¼Œå¯¹å…¶è¿›è¡Œå¤åˆ¶ï¼ˆä¸€èˆ¬æ˜¯åŸºäºäºŒè¿›åˆ¶æµçš„å¤åˆ¶ï¼‰ï¼Œèº²é¿åˆå§‹åŒ–è¿‡ç¨‹ï¼Œä½¿å¾—æ–°å¯¹è±¡çš„åˆ›å»ºæ—¶é—´å¤§å¤§ç¼©çŸ­ï¼›</p><h2 id="åŸå‹æ¨¡å¼ç±»å›¾"><a href="#åŸå‹æ¨¡å¼ç±»å›¾" class="headerlink" title="åŸå‹æ¨¡å¼ç±»å›¾"></a>åŸå‹æ¨¡å¼ç±»å›¾</h2><p><img src="https://oscimg.oschina.net/oscnet/up-85e3522fe29b05e31c4957bbcdf82eeba4c.png"></p><h3 id="IPrototype-å®šä¹‰å…‹éš†çš„æ–¹æ³•-ç±»ä¼¼äºJDKè‡ªå¸¦çš„Cloneable"><a href="#IPrototype-å®šä¹‰å…‹éš†çš„æ–¹æ³•-ç±»ä¼¼äºJDKè‡ªå¸¦çš„Cloneable" class="headerlink" title="IPrototype å®šä¹‰å…‹éš†çš„æ–¹æ³• ç±»ä¼¼äºJDKè‡ªå¸¦çš„Cloneable"></a>IPrototype å®šä¹‰å…‹éš†çš„æ–¹æ³• ç±»ä¼¼äºJDKè‡ªå¸¦çš„Cloneable</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPrototype</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">clone</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcretePrototype-å…·ä½“çš„è¦å…‹éš†çš„å¯¹è±¡"><a href="#ConcretePrototype-å…·ä½“çš„è¦å…‹éš†çš„å¯¹è±¡" class="headerlink" title="ConcretePrototype å…·ä½“çš„è¦å…‹éš†çš„å¯¹è±¡"></a>ConcretePrototype å…·ä½“çš„è¦å…‹éš†çš„å¯¹è±¡</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcretePrototype</span> <span class="keyword">implements</span> <span class="title">IPrototype</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯èƒ½æˆ‘ä»¬å¹³æ—¶éƒ½è¿™ä¹ˆå»å¤åˆ¶å¯¹è±¡</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcretePrototype <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConcretePrototype concretePrototype = <span class="keyword">new</span> ConcretePrototype();</span><br><span class="line">        concretePrototype.setAge(<span class="keyword">this</span>.age);</span><br><span class="line">        concretePrototype.setName(<span class="keyword">this</span>.name);</span><br><span class="line">        <span class="keyword">return</span> concretePrototype;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ConcretePrototype&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client-å®¢æˆ·ç«¯-æµ‹è¯•"><a href="#Client-å®¢æˆ·ç«¯-æµ‹è¯•" class="headerlink" title="Client å®¢æˆ·ç«¯ æµ‹è¯•"></a>Client å®¢æˆ·ç«¯ æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//åˆ›å»ºåŸå‹å¯¹è±¡</span></span><br><span class="line">     ConcretePrototype prototype = <span class="keyword">new</span> ConcretePrototype();</span><br><span class="line">     prototype.setAge(<span class="number">18</span>);</span><br><span class="line">     prototype.setName(<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">     System.out.println(prototype);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//æ‹·è´åŸå‹å¯¹è±¡</span></span><br><span class="line">     ConcretePrototype cloneType = prototype.clone();</span><br><span class="line">     System.out.println(cloneType);</span><br><span class="line">     System.err.println(cloneType == prototype);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ConcretePrototype&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>&#125;</span><br><span class="line">ConcretePrototype&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">false</span> </span><br></pre></td></tr></table></figure><h3 id="å®ç°JDK-Cloneableçš„å…‹éš†å¯¹è±¡å†™æ³•"><a href="#å®ç°JDK-Cloneableçš„å…‹éš†å¯¹è±¡å†™æ³•" class="headerlink" title="å®ç°JDK Cloneableçš„å…‹éš†å¯¹è±¡å†™æ³•"></a>å®ç°JDK Cloneableçš„å…‹éš†å¯¹è±¡å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcretePrototype1</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcretePrototype1 <span class="title">clone</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        Object clone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clone = <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.err.println(<span class="string">&quot;Clone Error!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (ConcretePrototype1) clone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ConcretePrototype&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœåŒä¸Šï¼›ä»¥ä¸Šçš„ä¸¤ä¸ªå±æ€§éƒ½æ˜¯åŸºæœ¬æ•°æ®ç±»å‹å’ŒStringï¼Œå¹¶æ²¡æœ‰å¼•ç”¨ç±»å‹ï¼Œä¸‹é¢æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å±æ€§æµ‹è¯•ä»¥ä¸‹ğŸ‘‡ğŸ‘‡  </p><h3 id="ConcretePrototypeæ·»åŠ ä¸€ä¸ªListç±»å‹å±æ€§"><a href="#ConcretePrototypeæ·»åŠ ä¸€ä¸ªListç±»å‹å±æ€§" class="headerlink" title="ConcretePrototypeæ·»åŠ ä¸€ä¸ªListç±»å‹å±æ€§"></a>ConcretePrototypeæ·»åŠ ä¸€ä¸ªListç±»å‹å±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcretePrototype</span> <span class="keyword">implements</span> <span class="title">IPrototype</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; hobbies;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHobbies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hobbies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHobbies</span><span class="params">(List&lt;String&gt; hobbies)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hobbies = hobbies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcretePrototype <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConcretePrototype concretePrototype = <span class="keyword">new</span> ConcretePrototype();</span><br><span class="line">        concretePrototype.setAge(<span class="keyword">this</span>.age);</span><br><span class="line">        concretePrototype.setName(<span class="keyword">this</span>.name);</span><br><span class="line">        concretePrototype.setHobbies(<span class="keyword">this</span>.hobbies);</span><br><span class="line">        <span class="keyword">return</span> concretePrototype;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ConcretePrototype&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, hobbies=&quot;</span> + hobbies +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SETTERæ–¹æ³•å®ç°æµ…å…‹éš†"><a href="#SETTERæ–¹æ³•å®ç°æµ…å…‹éš†" class="headerlink" title="SETTERæ–¹æ³•å®ç°æµ…å…‹éš†"></a>SETTERæ–¹æ³•å®ç°æµ…å…‹éš†</h3><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-569ebf8ef5519ace6b434b1301d87165f2c.png" style="zoom:50%;" /><blockquote><p>æµ…å…‹éš†ä¹Ÿå«æµ…æ‹·è´ï¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ–°å¯¹è±¡çš„å±æ€§å’ŒåŸæ¥å¯¹è±¡å®Œå…¨ç›¸åŒï¼Œå¯¹äºéåŸºæœ¬ç±»å‹å±æ€§ï¼Œä»æŒ‡å‘åŸæœ‰å±æ€§æ‰€æŒ‡å‘çš„å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚  </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºåŸå‹å¯¹è±¡</span></span><br><span class="line">        ConcretePrototype1 prototype = <span class="keyword">new</span> ConcretePrototype1();</span><br><span class="line">        prototype.setAge(<span class="number">18</span>);</span><br><span class="line">        prototype.setName(<span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        ArrayList&lt;String&gt; strings = Lists.newArrayList(<span class="string">&quot;æ•°å­¦&quot;</span>, <span class="string">&quot;è‹±è¯­&quot;</span>);</span><br><span class="line">        prototype.setHobbies(strings);</span><br><span class="line">        System.out.println(prototype);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ‹·è´åŸå‹å¯¹è±¡</span></span><br><span class="line">        ConcretePrototype1 cloneType = prototype.clone();</span><br><span class="line">        cloneType.getHobbies().add(<span class="string">&quot;è¯­æ–‡&quot;</span>);</span><br><span class="line">        System.out.println(cloneType);</span><br><span class="line">        System.out.println(prototype);</span><br><span class="line">        System.err.println(cloneType == prototype);</span><br><span class="line">        System.err.println(cloneType.getHobbies() == prototype.getHobbies());</span><br><span class="line">    &#125;</span><br><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">ConcretePrototype1&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>, hobbies=[æ•°å­¦, è‹±è¯­]&#125;</span><br><span class="line">ConcretePrototype1&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>, hobbies=[æ•°å­¦, è‹±è¯­, è¯­æ–‡]&#125;</span><br><span class="line">ConcretePrototype1&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>, hobbies=[æ•°å­¦, è‹±è¯­, è¯­æ–‡]&#125;</span><br><span class="line"><span class="keyword">false</span></span><br><span class="line"><span class="comment">// è¿™é‡Œä¸ºä»€ä¹ˆç»“æœæ˜¯trueçœ‹åˆ°ä¸Šé¢ç”»çš„å›¾åº”è¯¥å¯ä»¥çœ‹æ‡‚å§ï¼Œsetæ–¹æ³•å…¶å®æ˜¯å°†listçš„å¼•ç”¨è®¾ç½®è¿‡å»ï¼Œå¹¶ä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„listå†èµ‹å€¼ï¼</span></span><br><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡å†…å­˜å­—èŠ‚æµâ€å…‹éš†â€å¯¹è±¡ï¼Œå®ç°æ·±å…‹éš†"><a href="#é€šè¿‡å†…å­˜å­—èŠ‚æµâ€å…‹éš†â€å¯¹è±¡ï¼Œå®ç°æ·±å…‹éš†" class="headerlink" title="é€šè¿‡å†…å­˜å­—èŠ‚æµâ€å…‹éš†â€å¯¹è±¡ï¼Œå®ç°æ·±å…‹éš†"></a>é€šè¿‡å†…å­˜å­—èŠ‚æµâ€å…‹éš†â€å¯¹è±¡ï¼Œå®ç°æ·±å…‹éš†</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/up-41df4d66a80f2d0c2bfd87b7fea52ca9ddd.png" style="zoom:50%;" /><blockquote><p>æ·±å…‹éš†ä¹Ÿå«æ·±æ‹·è´ï¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå±æ€§ä¸­å¼•ç”¨çš„å…¶ä»–å¯¹è±¡ä¹Ÿä¼šè¢«å…‹éš†ï¼Œä¸å†æŒ‡å‘åŸæœ‰å¯¹è±¡åœ°å€ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcretePrototypeDeep</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>,<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; hobbies;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getHobbies</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hobbies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHobbies</span><span class="params">(List&lt;String&gt; hobbies)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hobbies = hobbies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºäºå†…å­˜å­—èŠ‚æµç”Ÿæˆå¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcretePrototypeDeep <span class="title">deepClone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å°†å½“å‰å¯¹è±¡ä¿¡æ¯å†™åˆ°å†…å­˜</span></span><br><span class="line">            ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">            objectOutputStream.writeObject(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//ä»å†…å­˜ä¸­è¯»å–å¯¹è±¡ä¿¡æ¯ï¼Œå¼ºåˆ¶è½¬æ¢æˆå½“å‰ç±»å‹</span></span><br><span class="line">            ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray());</span><br><span class="line">            ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(byteArrayInputStream);</span><br><span class="line">            <span class="keyword">return</span> (ConcretePrototypeDeep) objectInputStream.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioException) &#123;</span><br><span class="line">            ioException.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ConcretePrototype&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, hobbies=&quot;</span> + hobbies +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ConcretePrototype&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>, hobbies=[æ•°å­¦, è‹±è¯­]&#125;</span><br><span class="line">ConcretePrototype&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>, hobbies=[æ•°å­¦, è‹±è¯­, è¯­æ–‡]&#125;</span><br><span class="line">ConcretePrototype&#123;age=<span class="number">18</span>, name=<span class="string">&#x27;Tom&#x27;</span>, hobbies=[æ•°å­¦, è‹±è¯­]&#125;</span><br><span class="line"><span class="keyword">false</span></span><br><span class="line"><span class="keyword">false</span></span><br></pre></td></tr></table></figure><p>åœ¨Javaè¯­è¨€ä¸­ï¼Œå¦‚æœéœ€è¦å®ç°æ·±å…‹éš†ï¼Œå¯ä»¥é€šè¿‡è¦†ç›–Objectç±»çš„clone()æ–¹æ³•å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åºåˆ—åŒ–(Serialization)ç­‰æ–¹å¼æ¥å®ç°ã€‚</p><blockquote><p>è¦å®ç°æ·±æ‹·è´ï¼Œå¿…é¡»å®ç°Cloneableæ¥å£ï¼Œå»é‡å†™cloneæ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡ºCloneNotSupportedExceptionå¼‚å¸¸ï¼Œ<br>ä½†æ˜¯å¦‚æœå¯¹è±¡ä¸­åŒ…å«å¾ˆå¤šå¼•ç”¨ç±»å‹çš„å±æ€§ï¼Œè¿™æ ·å»è¦†ç›–cloneæ–¹æ³•å…¶å®æ˜¯å¾ˆéº»çƒ¦çš„ï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨åºåˆ—åŒ–çš„æ–¹å¼å®ç°ï¼    </p></blockquote><h2 id="å…‹éš†ç ´åå•ä¾‹æ¨¡å¼"><a href="#å…‹éš†ç ´åå•ä¾‹æ¨¡å¼" class="headerlink" title="å…‹éš†ç ´åå•ä¾‹æ¨¡å¼"></a>å…‹éš†ç ´åå•ä¾‹æ¨¡å¼</h2><p>å¦‚æœæˆ‘ä»¬å…‹éš†çš„ç›®æ ‡çš„å¯¹è±¡æ˜¯å•ä¾‹å¯¹è±¡ï¼Œè¿™ä¾¿æ„å‘³ç€ï¼Œæ·±å…‹éš†ä¼šç ´åå•ä¾‹ã€‚è§£å†³ä»¥ä¸Šé—®é¢˜çš„æ€è·¯ï¼š</p><ul><li><strong>ç¦æ­¢æ·±å…‹éš†</strong></li><li><strong>åœ¨å•ä¾‹å¯¹è±¡çš„getInstanceæ–¹æ³•ï¼Œè¿”å›å½“å‰å¯¹è±¡ï¼Œè€Œä¸æ˜¯å»æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡æˆ–è€…é€šè¿‡å†…å­˜å­—èŠ‚æµç­‰æ–¹æ³•ç”Ÿæˆå¯¹è±¡</strong></li></ul><h2 id="åŸå‹æ¨¡å¼åœ¨Javaä¸­çš„åº”ç”¨"><a href="#åŸå‹æ¨¡å¼åœ¨Javaä¸­çš„åº”ç”¨" class="headerlink" title="åŸå‹æ¨¡å¼åœ¨Javaä¸­çš„åº”ç”¨"></a>åŸå‹æ¨¡å¼åœ¨Javaä¸­çš„åº”ç”¨</h2><p>ArrayListåº•å±‚æ˜¯åŸºäºæ•°ç»„ç»“æœçš„ï¼Œå®ƒçš„åŠ¨æ€æ‰©å®¹è¿‡ç¨‹æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå¹¶æŠŠæ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´è¿‡å»ï¼Œç”¨æ–°çš„æ•°ç»„æ¥ç»§ç»­å­˜æ”¾å…ƒç´ ï¼›<br>åœ¨åˆ›å»ºæ–°æ•°ç»„çš„è¿‡ç¨‹ä¸­ä¾¿ä½¿ç”¨äº†åŸå‹æ¨¡å¼ã€‚</p><h3 id="java-util-ArrayList-clone"><a href="#java-util-ArrayList-clone" class="headerlink" title="java.util.ArrayList.clone"></a>java.util.ArrayList.clone</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ArrayList&lt;?&gt; v = (ArrayList&lt;?&gt;) <span class="keyword">super</span>.clone();</span><br><span class="line">        v.elementData = Arrays.copyOf(elementData, size);</span><br><span class="line">        v.modCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        <span class="comment">// this shouldn&#x27;t happen, since we are Cloneable</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="java-util-Arrays-copyOf-T-int"><a href="#java-util-Arrays-copyOf-T-int" class="headerlink" title="java.util.Arrays.copyOf(T[], int)"></a>java.util.Arrays.copyOf(T[], int)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T[] copyOf(T[] original, <span class="keyword">int</span> newLength) &#123;</span><br><span class="line">       <span class="keyword">return</span> (T[]) copyOf(original, newLength, original.getClass());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="java-util-Arrays-copyOf-U-int-java-lang-Class-lt-extends-T-gt"><a href="#java-util-Arrays-copyOf-U-int-java-lang-Class-lt-extends-T-gt" class="headerlink" title="java.util.Arrays.copyOf(U[], int, java.lang.Class&lt;? extends T[]&gt;)"></a>java.util.Arrays.copyOf(U[], int, java.lang.Class&lt;? extends T[]&gt;)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T,U&gt; T[] copyOf(U[] original, <span class="keyword">int</span> newLength, Class&lt;? extends T[]&gt; newType) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        T[] copy = ((Object)newType == (Object)Object[].class)</span><br><span class="line">            ? (T[]) <span class="keyword">new</span> Object[newLength]</span><br><span class="line">            : (T[]) Array.newInstance(newType.getComponentType(), newLength);</span><br><span class="line">        System.arraycopy(original, <span class="number">0</span>, copy, <span class="number">0</span>,</span><br><span class="line">                         Math.min(original.length, newLength));</span><br><span class="line">        <span class="keyword">return</span> copy;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯System.arraycopy(original, 0, copy, 0,<br>                             Math.min(original.length, newLength));è¿™ä¸ªæ–¹æ³•æ¥å®Œæˆæ•°ç»„çš„æ‹·è´ï¼<br>åƒæˆ‘ä»¬ä½¿ç”¨çš„ </p><p><code>com.alibaba.fastjson.JSON#parseObject</code></p><p>org.springframework.beans.BeanUtils#copyProperties(java.lang.Object, java.lang.Object)`</p><p>ç­‰éƒ½æ˜¯åŸå‹æ¨¡å¼ï¼›</p><h2 id="åŸå‹æ¨¡å¼é€‚ç”¨åœºæ™¯"><a href="#åŸå‹æ¨¡å¼é€‚ç”¨åœºæ™¯" class="headerlink" title="åŸå‹æ¨¡å¼é€‚ç”¨åœºæ™¯"></a>åŸå‹æ¨¡å¼é€‚ç”¨åœºæ™¯</h2><ul><li><strong>ç±»åˆå§‹åŒ–æ¶ˆè€—èµ„æºè¿‡å¤š</strong>  </li><li><strong>newä¸€ä¸ªå¯¹è±¡éœ€è¦å¾ˆå¤šç¹ççš„è¿‡ç¨‹ï¼ˆæ•°æ®å‡†å¤‡ï¼Œè®¿é—®æƒé™ç­‰ï¼‰</strong>  </li><li><strong>æ„é€ å‡½æ•°æ¯”è¾ƒå¤æ‚</strong></li><li><strong>å¾ªç¯ä½“å†…äº§ç”Ÿå¤§é‡å¯¹è±¡æ—¶</strong></li></ul><h2 id="åŸå‹æ¨¡å¼çš„ä¼˜ç‚¹"><a href="#åŸå‹æ¨¡å¼çš„ä¼˜ç‚¹" class="headerlink" title="åŸå‹æ¨¡å¼çš„ä¼˜ç‚¹"></a>åŸå‹æ¨¡å¼çš„ä¼˜ç‚¹</h2><ul><li><strong>Javaè‡ªå¸¦çš„åŸå‹æ¨¡å¼æ˜¯åŸºäºå†…å­˜äºŒè¿›åˆ¶æµçš„å¤åˆ¶ï¼Œåœ¨æ€§èƒ½ä¸Šæ¯”ç›´æ¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ›´åŠ ä¼˜è‰¯</strong></li><li><strong>å¯ä»¥ä½¿ç”¨æ·±å…‹éš†çš„æ–¹å¼ä¿å­˜å¯¹è±¡çš„çŠ¶æ€ï¼Œä½¿ç”¨åŸå‹æ¨¡å¼å°†å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œå¹¶å°†å…¶çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œç®€åŒ–äº†åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼Œ<br>ä»¥ä¾¿åœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨ï¼Œå¯è¾…åŠ©å®ç°æ’¤é”€æ“ä½œã€‚</strong></li></ul><h2 id="åŸå‹æ¨¡å¼çš„ç¼ºç‚¹"><a href="#åŸå‹æ¨¡å¼çš„ç¼ºç‚¹" class="headerlink" title="åŸå‹æ¨¡å¼çš„ç¼ºç‚¹"></a>åŸå‹æ¨¡å¼çš„ç¼ºç‚¹</h2><ul><li><strong>éœ€è¦ä¸ºæ¯ä¸€ä¸ªç±»éƒ½é…ç½®ä¸€ä¸ª clone æ–¹æ³•</strong></li><li><strong>clone æ–¹æ³•ä½äºç±»çš„å†…éƒ¨ï¼Œå½“å¯¹å·²æœ‰ç±»è¿›è¡Œæ”¹é€ çš„æ—¶å€™ï¼Œéœ€è¦ä¿®æ”¹ä»£ç ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™</strong></li><li><strong>å½“å®ç°æ·±å…‹éš†æ—¶ï¼Œéœ€è¦ç¼–å†™è¾ƒä¸ºå¤æ‚çš„ä»£ç ï¼Œè€Œä¸”å½“å¯¹è±¡ä¹‹é—´å­˜åœ¨å¤šé‡åµŒå¥—å¼•ç”¨æ—¶ï¼Œä¸ºäº†å®ç°æ·±å…‹éš†ï¼Œæ¯ä¸€å±‚å¯¹è±¡å¯¹åº”çš„ç±»éƒ½å¿…é¡»æ”¯æŒæ·±å…‹éš†ï¼Œ<br>å®ç°èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œæ·±å…‹éš†ã€æµ…å…‹éš†éœ€è¦è¿ç”¨å¾—å½“</strong></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;åŸå‹æ¨¡å¼&quot;&gt;&lt;a href=&quot;#åŸå‹æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;åŸå‹æ¨¡å¼&quot;&gt;&lt;/a&gt;åŸå‹æ¨¡å¼&lt;/h1&gt;&lt;p&gt;åŸå‹æ¨¡å¼ï¼ˆPrototype Patternï¼‰æŒ‡åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡å¤åˆ¶è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œå±äºåˆ›&lt;br&gt;</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-å•ä¾‹æ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T11:22:11.000Z</published>
    <updated>2021-08-07T11:31:08.826Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>å•ä¾‹æ¨¡å¼ï¼šæŒ‡ä¸€ä¸ªç±»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ç»å¯¹åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ï¼ˆgetInstanceæ–¹æ³•ï¼‰ã€‚<br>å¤§æ¦‚å®ç°å°±æ˜¯éšè—å…¶æ„é€ æ–¹æ³•ï¼Œå•ä¾‹æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ã€‚<br>ä¸€äº›å®é™…çš„åº”ç”¨åœºæ™¯æ¯”å¦‚ï¼ŒDBpool, ServletContext,ServletConfigç­‰</p><h2 id="å•ä¾‹æ¨¡å¼å†™æ³•"><a href="#å•ä¾‹æ¨¡å¼å†™æ³•" class="headerlink" title="å•ä¾‹æ¨¡å¼å†™æ³•"></a>å•ä¾‹æ¨¡å¼å†™æ³•</h2><h3 id="é¥¿æ±‰å¼å•ä¾‹"><a href="#é¥¿æ±‰å¼å•ä¾‹" class="headerlink" title="é¥¿æ±‰å¼å•ä¾‹"></a>é¥¿æ±‰å¼å•ä¾‹</h3><p>åœ¨å•ä¾‹ç±»é¦–æ¬¡åŠ è½½æ—¶åˆ›å»ºå®ä¾‹ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungrySingleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HungrySingleton hungrySingleton = <span class="keyword">new</span> HungrySingleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungrySingleton</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungrySingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hungrySingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><p>æ‰§è¡Œæ•ˆç‡é«˜ï¼Œæ²¡æœ‰åŠ ä»»ä½•é”  </p><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>ç±»åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æµªè´¹ï¼›å¦‚æœå‡ºç°ç±»çš„æ•°é‡å¾ˆå¤šçš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–å¾ˆå¤šç±»ï¼Œå ç”¨å¤§é‡å†…å­˜ï¼›</p><h4 id="å±€é™æ€§"><a href="#å±€é™æ€§" class="headerlink" title="å±€é™æ€§"></a>å±€é™æ€§</h4><p>Springå°±ä¸èƒ½ä½¿ç”¨ï¼ŒSpringå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæœ‰å¤§é‡çš„ç±»åŠ è½½ã€‚</p><p><strong>é¥¿æ±‰å¼çš„ç¬¬äºŒç§å†™æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungryStaticSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HungryStaticSingleton hungrySingleton ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        hungrySingleton = <span class="keyword">new</span> HungryStaticSingleton();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungryStaticSingleton</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungryStaticSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hungrySingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒºåˆ«ä»…ä»…å®åœ¨ä¸ç±»åŠ è½½çš„é¡ºåºä¸åŒã€‚ğŸ‘‡</p><h3 id="æ‡’æ±‰å¼å•ä¾‹"><a href="#æ‡’æ±‰å¼å•ä¾‹" class="headerlink" title="æ‡’æ±‰å¼å•ä¾‹"></a>æ‡’æ±‰å¼å•ä¾‹</h3><p>è¢«å¤–éƒ¨ç±»è°ƒç”¨æ—¶æ‰åˆ›å»ºå®ä¾‹ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazySingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazySingleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  LazySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> LazySingleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><p>èŠ‚çœäº†å†…å­˜</p><h4 id="ç¼ºç‚¹-1"><a href="#ç¼ºç‚¹-1" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>ä¸èƒ½ä¿è¯çœŸå®å•ä¾‹ï¼Œçº¿ç¨‹ä¸å®‰å…¨</p><h4 id="çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› "><a href="#çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› " class="headerlink" title="çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› "></a><strong>çº¿ç¨‹ä¸å®‰å…¨çš„åŸå› </strong></h4><ul><li>åé¢çš„çº¿ç¨‹è¦†ç›–æ‰å‰é¢çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹</li><li>åŒæ—¶è¿›å…¥åˆ¤æ–­æ¡ä»¶ï¼ŒæŒ‰é¡ºåºè¿”å›ï¼Œæ²¡æœ‰è¦†ç›–çš„æ—¶å€™ï¼Œå°±è¿”å›å®ä¾‹</li></ul><p><strong>è§£å†³æ–¹æ³•</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> synchorized LazySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        instance = <span class="keyword">new</span> LazySingleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯getInstanceæ–¹æ³•æ·»åŠ ä¸Šé”ä¹‹åï¼Œæ€§èƒ½ä¸‹é™ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¯·æ±‚è®¿é—®ï¼Œé™¤äº†è·å¾—é”çš„çº¿ç¨‹ä¹‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹éƒ½è¦ç­‰å¾…ã€‚</p><p><strong>å¦‚ä½•ä¼˜åŒ–ï¼Ÿ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyDclSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazyDclSingleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyDclSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åé¢çš„çº¿ç¨‹è¦†ç›–æ‰å‰é¢çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyDclSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazyDclSingleton.class) &#123;</span><br><span class="line">                instance = <span class="keyword">new</span> LazyDclSingleton();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒé‡æ£€æŸ¥é”"><a href="#åŒé‡æ£€æŸ¥é”" class="headerlink" title="åŒé‡æ£€æŸ¥é”"></a>åŒé‡æ£€æŸ¥é”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyDclSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazyDclSingleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyDclSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyDclSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦è¦é˜»å¡</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LazyDclSingleton.class) &#123;</span><br><span class="line">                <span class="comment">// æ£€æŸ¥æ˜¯å¦è¦åˆ›å»ºå®ä¾‹</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> LazyDclSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å±€é™æ€§-1"><a href="#å±€é™æ€§-1" class="headerlink" title="å±€é™æ€§"></a>å±€é™æ€§</h4><p>ä¼šå‡ºç°æŒ‡ä»¤é‡æ’åºçš„é—®é¢˜ï¼Œæœ‰å¯èƒ½è¿”å›ä¸€ä¸ªä¸å®Œæ•´çš„å®ä¾‹<br>è§£å†³æ–¹æ¡ˆï¼šprivate static volatile LazyDclSingleton instance = null;ï¼ˆvolatileç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼‰</p><h4 id="ä¼˜ç‚¹-2"><a href="#ä¼˜ç‚¹-2" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><p>æ€§èƒ½é«˜ï¼Œèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨</p><h4 id="ç¼ºç‚¹-2"><a href="#ç¼ºç‚¹-2" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>ä»£ç å¯è¯»æ€§æŸ¥ï¼Œä¸å¤Ÿç¾è§‚ï¼Œä»£ç ä¸å¤Ÿä¼˜é›…  </p><h3 id="é™æ€å†…éƒ¨ç±»å†™æ³•"><a href="#é™æ€å†…éƒ¨ç±»å†™æ³•" class="headerlink" title="é™æ€å†…éƒ¨ç±»å†™æ³•"></a>é™æ€å†…éƒ¨ç±»å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é™æ€å†…éƒ¨ç±»</span></span><br><span class="line"><span class="comment"> * é™æ€å†…éƒ¨ç±»åœ¨ä½¿ç”¨æ—¶æ‰è¿›è¡Œæ„å»º</span></span><br><span class="line"><span class="comment"> * classPath: ../LazyInnerClassSingleton.class</span></span><br><span class="line"><span class="comment"> *            ../LazyInnerClassSingleton$LazyHolder.class</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä¼˜ç‚¹ï¼šå†™æ³•ä¼˜é›…ï¼Œåˆ©ç”¨äº†javaè¯­è¨€è¯­æ³•ï¼Œæ€§èƒ½ä¹Ÿé«˜ï¼Œé¿å…å†…å­˜çš„æµªè´¹</span></span><br><span class="line"><span class="comment"> * ç¼ºç‚¹ï¼šèƒ½å¤Ÿè¢«åå°„ç ´å</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyInnerClassSingleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyInnerClassSingleton</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyInnerClassSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyHolder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LazyInnerClassSingleton instance = <span class="keyword">new</span> LazyInnerClassSingleton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¼˜ç‚¹-3"><a href="#ä¼˜ç‚¹-3" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><p>1ã€å†™æ³•ä¼˜é›…ï¼Œåˆ©ç”¨äº†javaè¯­è¨€è¯­æ³•<br>2ã€æ€§èƒ½ä¹Ÿé«˜<br>3ã€é¿å…å†…å­˜çš„æµªè´¹  </p><h4 id="ç¼ºç‚¹-3"><a href="#ç¼ºç‚¹-3" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>1ã€èƒ½å¤Ÿè¢«åå°„ç ´åå•ä¾‹  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åå°„ç ´åå•ä¾‹æ¨¡å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = LazyInnerClassSingleton.class;</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = clazz.getDeclaredConstructor(<span class="keyword">null</span>);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object instance = declaredConstructor.newInstance();</span><br><span class="line">        System.err.println(instance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰“å°ç»“æœ com.ibli.javaBase.pattern.singleton.LazyInnerClassSingleton@38af3868</span></span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•ï¼š åœ¨æ„é€ å™¨ä¸­æ·»åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå®ä¾‹å·²ç»åˆ›å»ºï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢åˆ›å»ºï¼›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private LazyInnerClassSingleton()&#123;</span><br><span class="line">       if (LazyHolder.instance != null)&#123;</span><br><span class="line">           throw new IllegalArgumentException();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="æ³¨å†Œå¼å•ä¾‹"><a href="#æ³¨å†Œå¼å•ä¾‹" class="headerlink" title="æ³¨å†Œå¼å•ä¾‹"></a>æ³¨å†Œå¼å•ä¾‹</h2><blockquote><p>å°†æ¯ä¸€ä¸ªå®ä¾‹éƒ½ç¼“å­˜åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä½¿ç”¨å”¯ä¸€æ ‡å¿—è·å–å®ä¾‹</p></blockquote><h3 id="æšä¸¾å†™æ³•"><a href="#æšä¸¾å†™æ³•" class="headerlink" title="æšä¸¾å†™æ³•"></a>æšä¸¾å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span>  <span class="title">EnumSingleton</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObject</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EnumSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ä¸æµ‹è¯•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumSingletonTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span>&#123;</span><br><span class="line">        EnumSingleton enumSingleton =   EnumSingleton.getInstance();</span><br><span class="line">        enumSingleton.setObject(<span class="keyword">new</span> Object());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°è¯•ä½¿ç”¨åå°„ç ´å</span></span><br><span class="line">        Class&lt;?&gt; clazz = EnumSingleton.class;</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = clazz.getDeclaredConstructor(String.class,<span class="keyword">int</span>.class);</span><br><span class="line">        System.err.println(declaredConstructor);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object object = declaredConstructor.newInstance();</span><br><span class="line">        System.err.println(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•ç»“æœ</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> com.ibli.javaBase.pattern.singleton.EnumSingleton(java.lang.String,<span class="keyword">int</span>)</span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalArgumentException: Cannot reflectively create <span class="class"><span class="keyword">enum</span> <span class="title">objects</span></span></span><br><span class="line"><span class="class"><span class="title">at</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">reflect</span>.<span class="title">Constructor</span>.<span class="title">newInstance</span>(<span class="title">Constructor</span>.<span class="title">java</span>:417)</span></span><br><span class="line"><span class="class"><span class="title">at</span> <span class="title">com</span>.<span class="title">ibli</span>.<span class="title">javaBase</span>.<span class="title">pattern</span>.<span class="title">singleton</span>.<span class="title">EnumSingletonTest</span>.<span class="title">main</span>(<span class="title">EnumSingletonTest</span>.<span class="title">java</span>:17)</span></span><br></pre></td></tr></table></figure><p><strong>åŸå› åœ¨JDKåº•å±‚æºç ä¸­å·²ç»åšäº†é™åˆ¶</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(Object ... initargs)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">               IllegalArgumentException, InvocationTargetException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!override) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123;</span><br><span class="line">                Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">                checkAccess(caller, clazz, <span class="keyword">null</span>, modifiers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸èƒ½åˆ›å»ºæšä¸¾ç±»å‹</span></span><br><span class="line">        <span class="keyword">if</span> ((clazz.getModifiers() &amp; Modifier.ENUM) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot reflectively create enum objects&quot;</span>);</span><br><span class="line">        ConstructorAccessor ca = constructorAccessor;   <span class="comment">// read volatile</span></span><br><span class="line">        <span class="keyword">if</span> (ca == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ca = acquireConstructorAccessor();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        T inst = (T) ca.newInstance(initargs);</span><br><span class="line">        <span class="keyword">return</span> inst;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="ä¼˜ç‚¹-4"><a href="#ä¼˜ç‚¹-4" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><p>å†™æ³•ä¼˜é›…ï¼Œä½¿ç”¨æ–¹ä¾¿</p><h4 id="ç¼ºç‚¹-4"><a href="#ç¼ºç‚¹-4" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>å’Œé¥¿æ±‰å¼ä¸€æ ·ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€ æˆå¤§é‡å†…å­˜æµªè´¹  </p><h3 id="å®¹å™¨å¼å•ä¾‹å†™æ³•"><a href="#å®¹å™¨å¼å•ä¾‹å†™æ³•" class="headerlink" title="å®¹å™¨å¼å•ä¾‹å†™æ³•"></a>å®¹å™¨å¼å•ä¾‹å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContainerSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ContainerSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; ioc = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getInstance</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">        Object instance = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!ioc.containsKey(className)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                instance = Class.forName(className).newInstance();</span><br><span class="line">                ioc.put(className, instance);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ioc.get(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContainerSingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Object o1 = ContainerSingleton.getInstance(<span class="string">&quot;com.ibli.javaBase.pattern.singleton.Pojo&quot;</span>);</span><br><span class="line">        Object o2 = ContainerSingleton.getInstance(<span class="string">&quot;com.ibli.javaBase.pattern.singleton.Pojo&quot;</span>);</span><br><span class="line">        System.err.println(o1 == o2); <span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¹å™¨å¼å•ä¾‹å†™æ³•é€‚åˆåˆ›å»ºå¤§é‡å•ä¾‹å®ä¾‹çš„åœºæ™¯ï¼Œç±»ä¼¼ä¸Springçš„IOCå®¹å™¨ã€‚<br>å½“ç„¶ä¸Šé¢çš„å†™æ³•ä¹Ÿä¼šå­˜åœ¨ä¸€ä¸ªçº¿ç¨‹å®‰å…¨é—®é¢˜</p><h2 id="åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼"><a href="#åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼" class="headerlink" title="åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼"></a>åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—åŒ–ï¼šæŠŠå†…å­˜ä¸­å¯¹è±¡çš„çŠ¶æ€è½¬æ¢ä¸ºå­—èŠ‚ç çš„å½¢å¼ï¼Œç„¶ååœ¨æŠŠå­—èŠ‚ç ä»¥IOè¾“å‡ºæµå†™åˆ°ç£ç›˜ä¸Š</span></span><br><span class="line"><span class="comment"> * ååºåˆ—åŒ–ï¼š å°†æŒä¹…åŒ–çš„å­—èŠ‚ç å†…å®¹ï¼Œé€šè¿‡IOæµçš„æ–¹å¼è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç„¶ååœ¨è½¬æ¢æˆJavaå¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializableSingleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SerializableSingleton serializableSingleton = <span class="keyword">new</span> SerializableSingleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SerializableSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SerializableSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serializableSingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializableSingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SerializableSingleton s1;</span><br><span class="line">        SerializableSingleton s2 = SerializableSingleton.getInstance();</span><br><span class="line"></span><br><span class="line">        FileOutputStream fos;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;SerializableSingleton.obj&quot;</span>);</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            oos.writeObject(s2);</span><br><span class="line">            oos.flush();</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;SerializableSingleton.obj&quot;</span>);</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">            s1 = (SerializableSingleton) ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line"></span><br><span class="line">            System.out.println(s1);</span><br><span class="line">            System.out.println(s2);</span><br><span class="line">            System.out.println(s1 == s2);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»“æœï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.ibli.javaBase.pattern.singleton.SerializableSingleton@20ad9418</span><br><span class="line">com.ibli.javaBase.pattern.singleton.SerializableSingleton@681a9515</span><br><span class="line"><span class="keyword">false</span></span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ³•ï¼šåœ¨SerializableSingletonä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¡¥æ¥æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serializableSingleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»“æœ:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.ibli.javaBase.pattern.singleton.SerializableSingleton@681a9515</span><br><span class="line">com.ibli.javaBase.pattern.singleton.SerializableSingleton@681a9515</span><br><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure><p>åŸå› ï¼šois.readObject();æ–¹æ³•åº•å±‚æœ‰å¯¹readResolveæ–¹æ³•çš„åˆ¤æ–­ï¼Œå¦‚æœä¸å­˜åœ¨è¿™ä¸ªæ–¹æ³•ï¼Œä¼šåˆ©ç”¨åå°„ç”Ÿæˆä¸€ä¸ªæ–°çš„å®ä¾‹ï¼›</p><h2 id="ThreadLocalå•ä¾‹"><a href="#ThreadLocalå•ä¾‹" class="headerlink" title="ThreadLocalå•ä¾‹"></a>ThreadLocalå•ä¾‹</h2><p>ä¸‹é¢ä»‹ç»ä¸€ç§æ¯”è¾ƒå°‘è§çš„ä¸€ç§å•ä¾‹æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalSingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;ThreadLocalSingleton&gt; threadLocalSingleton =</span><br><span class="line">            <span class="keyword">new</span> ThreadLocal&lt;ThreadLocalSingleton&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> ThreadLocalSingleton <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ThreadLocalSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ThreadLocalSingleton</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadLocalSingleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocalSingleton.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalExector</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.err.println(ThreadLocalSingleton.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalSingletonTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(ThreadLocalSingleton.getInstance());</span><br><span class="line">        System.out.println(ThreadLocalSingleton.getInstance());</span><br><span class="line"></span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadLocalExector());</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadLocalExector());</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»“æœï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@38af3868  <span class="number">1</span></span><br><span class="line">com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@38af3868  <span class="number">2</span></span><br><span class="line"></span><br><span class="line">com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@10c69a60  <span class="number">3</span></span><br><span class="line">com.ibli.javaBase.pattern.singleton.ThreadLocalSingleton@2f1eeb2f  <span class="number">4</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Š3å’Œ4çš„ç»“æœè™½ç„¶ä¸ä¸€æ ·ï¼Œä½†æ˜¯å…¶å®ä¹Ÿæ˜¯å®ç°äº†ã€å•ä¾‹ã€‘çš„æ•ˆæœã€‚</p><p align="middle"> å±±è„šå¤ªæ‹¥æŒ¤ æˆ‘ä»¬æ›´é«˜å¤„è§ã€‚ </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å•ä¾‹æ¨¡å¼&quot;&gt;&lt;a href=&quot;#å•ä¾‹æ¨¡å¼&quot; class=&quot;headerlink&quot; title=&quot;å•ä¾‹æ¨¡å¼&quot;&gt;&lt;/a&gt;å•ä¾‹æ¨¡å¼&lt;/h1&gt;&lt;h2 id=&quot;æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚å¿µ&quot;&gt;&lt;/a&gt;æ¦‚å¿µ&lt;/h</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>è®¾è®¡æ¨¡å¼ä¹‹ç¾-äº«å…ƒæ¨¡å¼</title>
    <link href="http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/"/>
    <id>http://example.com/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F/</id>
    <published>2021-08-07T11:16:35.000Z</published>
    <updated>2021-08-07T11:21:07.191Z</updated>
    
    <content type="html"><![CDATA[<h1 id="äº«å…ƒæ¨¡å¼ï¼ˆFlyweight-Patternï¼‰"><a href="#äº«å…ƒæ¨¡å¼ï¼ˆFlyweight-Patternï¼‰" class="headerlink" title="äº«å…ƒæ¨¡å¼ï¼ˆFlyweight Patternï¼‰"></a>äº«å…ƒæ¨¡å¼ï¼ˆFlyweight Patternï¼‰</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶ä¼šé¢ä¸´è¦åˆ›å»ºå¤§é‡ç›¸åŒæˆ–ç›¸ä¼¼å¯¹è±¡å®ä¾‹çš„é—®é¢˜ã€‚åˆ›å»ºé‚£ä¹ˆå¤šçš„å¯¹è±¡å°†ä¼šè€—è´¹å¾ˆå¤šçš„ç³»ç»Ÿèµ„æºï¼Œå®ƒæ˜¯ç³»ç»Ÿæ€§èƒ½æé«˜çš„ä¸€ä¸ªç“¶é¢ˆã€‚  </p><h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>äº«å…ƒæ¨¡å¼ï¼Œåˆç§°ä¸ºè½»é‡çº§æ¨¡å¼ï¼Œè¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚å®ƒé€šè¿‡å…±äº«å·²ç»å­˜åœ¨çš„å¯¹è±¡æ¥å¤§å¹…åº¦å‡å°‘éœ€è¦åˆ›å»ºçš„å¯¹è±¡æ•°é‡ã€<br>é¿å…å¤§é‡ç›¸ä¼¼ç±»çš„å¼€é”€ï¼Œä»è€Œæé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡ã€‚å®ƒæ˜¯å¯¹è±¡æ± çš„ä¸€ç§å®ç°ï¼Œç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± å¯ä»¥é¿å…ä¸åœçš„åˆ›å»ºä¸ªé”€æ¯å¤šä¸ªå¯¹è±¡ï¼Œæ¶ˆè€—æ€§èƒ½ï¼ˆç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼‰ï¼›<br><strong>ã€å®—æ—¨ã€‘</strong>ï¼šå…±äº«ç»†ç²’åº¦å¯¹è±¡ï¼Œå°†å¤šä¸ªå¯¹åŒä¸€å¯¹è±¡çš„è®¿é—®é›†ä¸­èµ·æ¥ï¼›å±äºç»“æ„æ€§æ¨¡å¼ï¼›       </p><h2 id="å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€"><a href="#å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€" class="headerlink" title="å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€"></a>å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€</h2><p>åœ¨å…±äº«å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œåˆä¸¤ç§çŠ¶æ€ï¼š<br><strong>å†…éƒ¨çŠ¶æ€ï¼š</strong> å†…éƒ¨çŠ¶æ€æŒ‡å¯¹è±¡å…±äº«å‡ºæ¥çš„ä¿¡æ¯ï¼Œå­˜å‚¨åœ¨äº«å…ƒä¿¡æ¯å†…éƒ¨ï¼Œå¹¶ä¸”ä¸å›éšç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜ï¼›  </p><blockquote><p>å°±æ˜¯å¯¹è±¡æ‰€å…±æœ‰çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç«è½¦ç¥¨ï¼Œå¤šæœ‰ä»åŒ—äº¬-ä¸Šæµ·çš„å¯¹è±¡å¯ä»¥å…±ç”¨ä¸€ä¸ªï¼Œè€Œä¸æ˜¯æœ‰1000å¼ ç¥¨ï¼Œåˆ›å»º1000ä¸ªå¯¹è±¡ï¼›    </p></blockquote><p><strong>å¤–éƒ¨çŠ¶æ€ï¼š</strong> å¤–éƒ¨çŠ¶æ€æŒ‡å¯¹è±¡å¾—ä»¥ä¾èµ–çš„ä¸€ä¸ªæ ‡è®°ï¼Œéšç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜ï¼Œä¸å¯å…±äº«ï¼›  </p><blockquote><p>ä¹Ÿæ˜¯ä¸å«å¥½ç†è§£çš„ï¼Œå½“ç«è½¦ç¥¨è¢«ä½ è´­ä¹°ä¹‹åï¼Œå°±å’Œä½ çš„èº«ä»½è¯å·ï¼ˆå”¯ä¸€ï¼‰ç»‘å®šäº†ï¼Œè¿™å±äºå¤–éƒ¨çŠ¶æ€ï¼›    </p></blockquote><h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><p>1ã€å¸¸å¸¸åº”ç”¨äºç³»ç»Ÿåº•å±‚çš„å¼€å‘ï¼Œä»¥ä¾¿è§£å†³ç³»ç»Ÿçš„æ€§èƒ½é—®é¢˜ï¼›<br>2ã€ç³»ç»Ÿæœ‰å¤§é‡ç›¸ä¼¼å¯¹è±¡ï¼Œéœ€è¦ç¼“å†²æ± çš„åœ°æ–¹ï¼›  </p><h2 id="ä¸¾ä¸ªä¾‹å­ğŸŒ°"><a href="#ä¸¾ä¸ªä¾‹å­ğŸŒ°" class="headerlink" title="ä¸¾ä¸ªä¾‹å­ğŸŒ°"></a>ä¸¾ä¸ªä¾‹å­ğŸŒ°</h2><h3 id="äº«å…ƒå®ä½“ç±»"><a href="#äº«å…ƒå®ä½“ç±»" class="headerlink" title="äº«å…ƒå®ä½“ç±»"></a>äº«å…ƒå®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Examination</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Examination</span><span class="params">(String subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhone</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.phone = phone;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Examination [name=&quot;</span> + name + <span class="string">&quot;, phone=&quot;</span> + phone + <span class="string">&quot;, subject=&quot;</span> + subject + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äº«å…ƒå·¥å‚"><a href="#äº«å…ƒå·¥å‚" class="headerlink" title="äº«å…ƒå·¥å‚"></a>äº«å…ƒå·¥å‚</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExaminationFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¯¹è±¡æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Examination&gt; pool = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Examination <span class="title">getexExamination</span><span class="params">(String name, String phone, String subject)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡å­¦ç§‘åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (pool.containsKey(subject)) &#123;</span><br><span class="line">            Examination examination = pool.get(subject);</span><br><span class="line">            examination.setName(name);</span><br><span class="line">            examination.setPhone(phone);</span><br><span class="line">            System.out.println(<span class="string">&quot;åœ¨ç¼“å­˜æ± å–ç”¨å¯¹è±¡:&quot;</span> + examination.toString());</span><br><span class="line">            <span class="keyword">return</span> examination;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Examination examination = <span class="keyword">new</span> Examination(subject);</span><br><span class="line">            pool.put(subject, examination);</span><br><span class="line">            examination.setName(name);</span><br><span class="line">            examination.setPhone(phone);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ–°å»ºå¯¹è±¡:&quot;</span> + examination.toString());</span><br><span class="line">            <span class="keyword">return</span> examination;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç±»"><a href="#æµ‹è¯•ç±»" class="headerlink" title="æµ‹è¯•ç±»"></a>æµ‹è¯•ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Examination A = ExaminationFactory.getexExamination(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;13812345678&quot;</span>, <span class="string">&quot;è½¯ä»¶å·¥ç¨‹&quot;</span>);</span><br><span class="line">        Examination B = ExaminationFactory.getexExamination(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;13812341234&quot;</span>, <span class="string">&quot;è½¯ä»¶å·¥ç¨‹&quot;</span>);</span><br><span class="line">        Examination C = ExaminationFactory.getexExamination(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;13812341328&quot;</span>, <span class="string">&quot;ç”µå­ä¿¡æ¯å·¥ç¨‹&quot;</span>);</span><br><span class="line">        Examination D = ExaminationFactory.getexExamination(<span class="string">&quot;D&quot;</span>, <span class="string">&quot;13812345111&quot;</span>, <span class="string">&quot;æ¡¥æ¢å·¥ç¨‹å·¥ç¨‹&quot;</span>);</span><br><span class="line">        Examination E = ExaminationFactory.getexExamination(<span class="string">&quot;E&quot;</span>, <span class="string">&quot;13812345444&quot;</span>, <span class="string">&quot;è½¯ä»¶å·¥ç¨‹&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.err.println(A.hashCode());</span><br><span class="line">        System.err.println(B.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æ–°å»ºå¯¹è±¡:Examination [name=A, phone=<span class="number">13812345678</span>, subject=è½¯ä»¶å·¥ç¨‹]</span><br><span class="line">åœ¨ç¼“å­˜æ± å–ç”¨å¯¹è±¡:Examination [name=B, phone=<span class="number">13812341234</span>, subject=è½¯ä»¶å·¥ç¨‹]</span><br><span class="line">æ–°å»ºå¯¹è±¡:Examination [name=C, phone=<span class="number">13812341328</span>, subject=ç”µå­ä¿¡æ¯å·¥ç¨‹]</span><br><span class="line">æ–°å»ºå¯¹è±¡:Examination [name=D, phone=<span class="number">13812345111</span>, subject=æ¡¥æ¢å·¥ç¨‹å·¥ç¨‹]</span><br><span class="line">åœ¨ç¼“å­˜æ± å–ç”¨å¯¹è±¡:Examination [name=E, phone=<span class="number">13812345444</span>, subject=è½¯ä»¶å·¥ç¨‹]</span><br><span class="line"><span class="number">1528902577</span></span><br><span class="line"><span class="number">1528902577</span></span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><p>1ã€JDK â€“ String  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// &quot;hello&quot;æ˜¯ç¼–è¯‘å™¨å¸¸é‡ï¼Œ String s1æ˜¯è¿è¡Œæ—¶ï¼ŒæŠŠå¸¸é‡åœ°å€èµ‹å€¼ç»™ä»–&lt;br&gt;</span></span><br><span class="line">      String s1 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">      String s2 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="comment">// &quot;he&quot; + &quot;llo&quot; ä¸¤ä¸ªå¸¸é‡ç›¸åŠ ï¼Œä¼šåœ¨ç¼–è¯‘æœŸå¤„ç†&lt;br&gt;</span></span><br><span class="line">      String s3 = <span class="string">&quot;he&quot;</span> + <span class="string">&quot;llo&quot;</span>; </span><br><span class="line">    <span class="comment">// &quot;hel&quot; &quot;lo&quot; new String å…±å»ºäº†3ä¸ªç©ºé—´ï¼Œç„¶åæ‹¼æ¥èµ·æ¥æ˜¯ä¸€ä¸ªæ–°çš„ç©ºé—´ï¼ˆwhy?ï¼‰</span></span><br><span class="line">      String s4 = <span class="string">&quot;hel&quot;</span> + <span class="keyword">new</span> String(<span class="string">&quot;lo&quot;</span>); </span><br><span class="line">      String s5 = <span class="keyword">new</span> String(<span class="string">&quot;hello&quot;</span>); <span class="comment">// s5å­˜æ”¾çš„æ˜¯å †ä¸­ä¸­é—´</span></span><br><span class="line">      String s6 = s5.intern();  <span class="comment">//æ‹¿åˆ°å¸¸é‡ä¸­çš„åœ°å€ï¼Œ</span></span><br><span class="line">      String s7 = <span class="string">&quot;h&quot;</span>;</span><br><span class="line">      String s8 = <span class="string">&quot;ello&quot;</span>;</span><br><span class="line">      String s9 = s7 + s8; <span class="comment">//ä¸ºä»€ä¹ˆè¿™ä¸ªä¸ä¸€æ ·ï¼Œå› ä¸ºæ˜¯å˜é‡ç›¸åŠ æ‰€ä»¥ç¼–è¯‘æœŸæ²¡æœ‰åšä¼˜åŒ–</span></span><br><span class="line"></span><br><span class="line">      System.out.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">      System.out.println(<span class="string">&quot;s1 &quot;</span> + System.identityHashCode(s1));</span><br><span class="line">      System.out.println(<span class="string">&quot;s2 &quot;</span> + System.identityHashCode(s2));</span><br><span class="line">      System.out.println(<span class="string">&quot;s3 &quot;</span> + System.identityHashCode(s3));</span><br><span class="line">      System.out.println(<span class="string">&quot;s4 &quot;</span> + System.identityHashCode(s4));</span><br><span class="line">      System.out.println(<span class="string">&quot;s5 &quot;</span> + System.identityHashCode(s5));</span><br><span class="line">   <span class="comment">//s6ä¸ºs5.intern()æ‹¿åˆ°çš„æ˜¯å¸¸é‡æ± é‡Œçš„â€œhelloâ€</span></span><br><span class="line">      System.out.println(<span class="string">&quot;s6 &quot;</span> + System.identityHashCode(s6));</span><br><span class="line">      System.out.println(<span class="string">&quot;s7 &quot;</span> + System.identityHashCode(s7));</span><br><span class="line">      System.out.println(<span class="string">&quot;s8 &quot;</span> + System.identityHashCode(s8));</span><br><span class="line">      System.out.println(<span class="string">&quot;s9 &quot;</span> + System.identityHashCode(s9));</span><br><span class="line">      System.out.print(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">      System.out.println(s1==s2);<span class="comment">//true</span></span><br><span class="line">      System.out.println(s1==s3);<span class="comment">//true</span></span><br><span class="line">      System.out.println(s1==s4);<span class="comment">//false</span></span><br><span class="line">      System.out.println(s1==s9);<span class="comment">//false</span></span><br><span class="line">      System.out.println(s4==s5);<span class="comment">//false</span></span><br><span class="line">      System.out.println(s1==s6);<span class="comment">//true</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/7689e9454c9140819c515317ba2f3da8~tplv-k3u1fbpfcp-zoom-1.image" style="zoom:50%;" />  <p>2ã€JDK â€“ Integer  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerCache</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> low = -<span class="number">128</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> high;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Integer cache[];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            <span class="comment">// high value may be configured by property</span></span><br><span class="line">            <span class="keyword">int</span> h = <span class="number">127</span>;</span><br><span class="line">            String integerCacheHighPropValue =</span><br><span class="line">                sun.misc.VM.getSavedProperty(<span class="string">&quot;java.lang.Integer.IntegerCache.high&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (integerCacheHighPropValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> i = parseInt(integerCacheHighPropValue);</span><br><span class="line">                    i = Math.max(i, <span class="number">127</span>);</span><br><span class="line">                    <span class="comment">// Maximum array size is Integer.MAX_VALUE</span></span><br><span class="line">                    h = Math.min(i, Integer.MAX_VALUE - (-low) -<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span>( NumberFormatException nfe) &#123;</span><br><span class="line">                    <span class="comment">// If the property cannot be parsed into an int, ignore it.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            high = h;</span><br><span class="line"></span><br><span class="line">            cache = <span class="keyword">new</span> Integer[(high - low) + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">int</span> j = low;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; cache.length; k++)</span><br><span class="line">                cache[k] = <span class="keyword">new</span> Integer(j++);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span></span><br><span class="line">            <span class="keyword">assert</span> IntegerCache.high &gt;= <span class="number">127</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">IntegerCache</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>3ã€çº¿ç¨‹æ± <br>4ã€Tomcatè¿æ¥æ±   </p><h2 id="äº«å…ƒæ¨¡å¼çš„ä¼˜ç‚¹âœ…"><a href="#äº«å…ƒæ¨¡å¼çš„ä¼˜ç‚¹âœ…" class="headerlink" title="äº«å…ƒæ¨¡å¼çš„ä¼˜ç‚¹âœ…"></a>äº«å…ƒæ¨¡å¼çš„ä¼˜ç‚¹âœ…</h2><p>1ã€å‡å°‘å¯¹è±¡çš„åˆ›å»ºï¼Œé™ä½å†…å­˜ä¸­å¯¹è±¡çš„æ•°é‡ï¼Œé™ä½ç³»ç»Ÿçš„å†…å­˜ä½¿ç”¨ï¼Œæå‡æ•ˆç‡ï¼›<br>2ã€å‡å°‘å†…å­˜ä¹‹å¤–çš„å…¶ä»–èµ„æºå ç”¨ï¼ŒIO,å¸¦å®½ç­‰ï¼›  </p><h2 id="äº«å…ƒæ¨¡å¼çš„ç¼ºç‚¹"><a href="#äº«å…ƒæ¨¡å¼çš„ç¼ºç‚¹" class="headerlink" title="äº«å…ƒæ¨¡å¼çš„ç¼ºç‚¹"></a>äº«å…ƒæ¨¡å¼çš„ç¼ºç‚¹</h2><p>1ã€å…³æ³¨å†…éƒ¨ï¼Œå¤–éƒ¨çŠ¶æ€ï¼Œå…³æ³¨ç¨‹åºçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›<br>2ã€ä½¿ç³»ç»Ÿã€ç¨‹åºçš„é€»è¾‘å˜å¾—å¤æ‚ï¼›  </p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>1ã€<a href="https://juejin.cn/post/6924611630391115783">[è®¾è®¡æ¨¡å¼] - äº«å…ƒæ¨¡å¼</a><br>2ã€<a href="https://juejin.cn/post/6914489741706526734">è®¾è®¡æ¨¡å¼-äº«å…ƒæ¨¡å¼</a><br>3ã€<a href="https://juejin.cn/post/6844903841188577288">è®¾è®¡æ¨¡å¼-äº«å…ƒè®¾è®¡æ¨¡å¼</a>    </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;äº«å…ƒæ¨¡å¼ï¼ˆFlyweight-Patternï¼‰&quot;&gt;&lt;a href=&quot;#äº«å…ƒæ¨¡å¼ï¼ˆFlyweight-Patternï¼‰&quot; class=&quot;headerlink&quot; title=&quot;äº«å…ƒæ¨¡å¼ï¼ˆFlyweight Patternï¼‰&quot;&gt;&lt;/a&gt;äº«å…ƒæ¨¡å¼ï¼ˆFlyweight Pa</summary>
      
    
    
    
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://example.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹ConcurrentHashMapå®ç°åŸç†</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BConcurrentHashMap%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BConcurrentHashMap%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</id>
    <published>2021-08-05T07:35:46.000Z</published>
    <updated>2021-08-05T09:42:44.580Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h1><p>Mapåº”è¯¥æ˜¯æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­é™¤äº†Listä½¿ç”¨çš„ç¬¬äºŒé¢‘ç¹çš„æ•°æ®ç»“æ„äº†å§ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“HashMapæ— æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¿è¯å®‰å…¨ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»€ä¹ˆæ¥ä»£æ›¿HashMapå‘¢ï¼Œæœ‰ä¸¤ä¸ªé€‰æ‹©ï¼ŒHashTableå’ŒConcurrentHashMap,ç”±äºHashTableçš„æ€§èƒ½ç›¸å¯¹æ¯”è¾ƒä½ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä½¿ç”¨ConcurrentHashMapæ¥ä»£æ›¿HashMapã€‚</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><h3 id="HashTable-amp-HashMap"><a href="#HashTable-amp-HashMap" class="headerlink" title="HashTable&amp;HashMap"></a>HashTable&amp;HashMap</h3><p><code>HashTable</code>çš„<code>put</code>, <code>get</code>,<code>remove</code>ç­‰æ–¹æ³•æ˜¯é€šè¿‡<code>synchronized</code>æ¥ä¿®é¥°ä¿è¯å…¶çº¿ç¨‹å®‰å…¨æ€§çš„ã€‚</p><p><code>HashTable</code>æ˜¯ ä¸å…è®¸keyè·Ÿvalueä¸ºnullçš„ã€‚</p><p>é—®é¢˜æ˜¯<code>synchronized</code>æ˜¯ä¸ªå…³é”®å­—çº§åˆ«çš„==é‡é‡é”==ï¼Œåœ¨getæ•°æ®çš„æ—¶å€™ä»»ä½•å†™å…¥æ“ä½œéƒ½ä¸å…è®¸ã€‚ç›¸å¯¹æ¥è¯´æ€§èƒ½ä¸å¥½ã€‚</p><h3 id="ConcurrentHashMapæ¦‚è¿°"><a href="#ConcurrentHashMapæ¦‚è¿°" class="headerlink" title="ConcurrentHashMapæ¦‚è¿°"></a>ConcurrentHashMapæ¦‚è¿°</h3><p>åœ¨ConcurrentHashMapä¸­é€šè¿‡ä¸€ä¸ªNode&lt;K,V&gt;[]æ•°ç»„æ¥ä¿å­˜æ·»åŠ åˆ°mapä¸­çš„é”®å€¼å¯¹ï¼Œè€Œåœ¨åŒä¸€ä¸ªæ•°ç»„ä½ç½®æ˜¯é€šè¿‡é“¾è¡¨å’Œçº¢é»‘æ ‘çš„å½¢å¼æ¥ä¿å­˜çš„ã€‚ä½†æ˜¯è¿™ä¸ªæ•°ç»„åªæœ‰åœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–ï¼Œå¦åˆ™åªæ˜¯åˆå§‹åŒ–ä¸€ä¸ªConcurrentHashMapå¯¹è±¡çš„è¯ï¼Œåªæ˜¯è®¾å®šäº†ä¸€ä¸ªsizeCtlå˜é‡ï¼Œè¿™ä¸ªå˜é‡ç”¨æ¥åˆ¤æ–­å¯¹è±¡çš„ä¸€äº›çŠ¶æ€å’Œæ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Šã€‚</p><p>ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé»˜è®¤åˆæœŸé•¿åº¦ä¸º16ï¼Œå½“å¾€mapä¸­ç»§ç»­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé€šè¿‡hashå€¼è·Ÿæ•°ç»„é•¿åº¦å–ä¸æ¥å†³å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®ï¼Œå¦‚æœå‡ºç°æ”¾åœ¨åŒä¸€ä¸ªä½ç½®çš„æ—¶å€™ï¼Œä¼˜å…ˆä»¥é“¾è¡¨çš„å½¢å¼å­˜æ”¾ï¼Œåœ¨åŒä¸€ä¸ªä½ç½®çš„ä¸ªæ•°åˆè¾¾åˆ°äº†8ä¸ªä»¥ä¸Šï¼Œå¦‚æœæ•°ç»„çš„é•¿åº¦è¿˜å°äº64çš„æ—¶å€™ï¼Œåˆ™ä¼šæ‰©å®¹æ•°ç»„ã€‚å¦‚æœæ•°ç»„çš„é•¿åº¦å¤§äºç­‰äº64äº†çš„è¯ï¼Œåœ¨ä¼šå°†è¯¥èŠ‚ç‚¹çš„é“¾è¡¨è½¬æ¢æˆæ ‘ã€‚</p><p>é€šè¿‡æ‰©å®¹æ•°ç»„çš„æ–¹å¼æ¥æŠŠè¿™äº›èŠ‚ç‚¹ç»™åˆ†æ•£å¼€ã€‚ç„¶åå°†è¿™äº›å…ƒç´ å¤åˆ¶åˆ°æ‰©å®¹åçš„æ–°çš„æ•°ç»„ä¸­ï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ é€šè¿‡hashå€¼çš„æ•°ç»„é•¿åº¦ä½æ¥åŒºåˆ†ï¼Œæ˜¯è¿˜æ˜¯æ”¾åœ¨åŸæ¥çš„ä½ç½®è¿˜æ˜¯æ”¾åˆ°æ‰©å®¹çš„é•¿åº¦çš„ç›¸åŒä½ç½®å» ã€‚åœ¨æ‰©å®¹å®Œæˆä¹‹åï¼Œå¦‚æœæŸä¸ªèŠ‚ç‚¹çš„æ˜¯æ ‘ï¼ŒåŒæ—¶ç°åœ¨è¯¥èŠ‚ç‚¹çš„ä¸ªæ•°åˆå°äºç­‰äº6ä¸ªäº†ï¼Œåˆ™ä¼šå°†è¯¥æ ‘è½¬ä¸ºé“¾è¡¨ã€‚</p><p>å–å…ƒç´ çš„æ—¶å€™ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œé€šè¿‡è®¡ç®—hashæ¥ç¡®å®šè¯¥å…ƒç´ åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®ï¼Œç„¶ååœ¨é€šè¿‡éå†é“¾è¡¨æˆ–æ ‘æ¥åˆ¤æ–­keyå’Œkeyçš„hashï¼Œå–å‡ºvalueå€¼ã€‚</p><h2 id="ConcurrentHashMap-åŸç†è§£æ"><a href="#ConcurrentHashMap-åŸç†è§£æ" class="headerlink" title="ConcurrentHashMap åŸç†è§£æ"></a>ConcurrentHashMap åŸç†è§£æ</h2><h3 id="ConcurrentHashMapå±æ€§"><a href="#ConcurrentHashMapå±æ€§" class="headerlink" title="ConcurrentHashMapå±æ€§"></a>ConcurrentHashMapå±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// è¡¨ç¤ºæ­£åœ¨è½¬ç§»</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// è¡¨ç¤ºå·²ç»è½¬æ¢æˆæ ‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;<span class="comment">//é»˜è®¤æ²¡åˆå§‹åŒ–çš„æ•°ç»„ï¼Œç”¨æ¥ä¿å­˜å…ƒç´ </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;<span class="comment">//è½¬ç§»çš„æ—¶å€™ç”¨çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æ¥æ§åˆ¶è¡¨åˆå§‹åŒ–å’Œæ‰©å®¹çš„ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œå½“åœ¨åˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šäº†å¤§å°ï¼Œè¿™ä¼šå°†è¿™ä¸ªå¤§å°ä¿å­˜åœ¨sizeCtlä¸­ï¼Œå¤§å°ä¸ºæ•°ç»„çš„0.75</span></span><br><span class="line"><span class="comment">     * å½“ä¸ºè´Ÿçš„æ—¶å€™ï¼Œè¯´æ˜è¡¨æ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å¼ ï¼Œ</span></span><br><span class="line"><span class="comment">     *     -1è¡¨ç¤ºåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     *     -(1+n) n:è¡¨ç¤ºæ´»åŠ¨çš„æ‰©å¼ çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br></pre></td></tr></table></figure><h4 id="Node-lt-K-V-gt-è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚"><a href="#Node-lt-K-V-gt-è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚" class="headerlink" title="Node&lt;K,V&gt;,è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚"></a><strong>Node&lt;K,V&gt;,è¿™æ˜¯æ„æˆæ¯ä¸ªå…ƒç´ çš„åŸºæœ¬ç±»ã€‚</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> hash;    <span class="comment">//keyçš„hashå€¼</span></span><br><span class="line">  <span class="keyword">final</span> K key;       <span class="comment">//key</span></span><br><span class="line">  <span class="keyword">volatile</span> V val;    <span class="comment">//value</span></span><br><span class="line">  <span class="keyword">volatile</span> Node&lt;K,V&gt; next; <span class="comment">//è¡¨ç¤ºé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">  Node(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hash = hash;</span><br><span class="line">    <span class="keyword">this</span>.key = key;</span><br><span class="line">    <span class="keyword">this</span>.val = val;</span><br><span class="line">    <span class="keyword">this</span>.next = next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> val; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹"><a href="#TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹" class="headerlink" title="TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹"></a><strong>TreeNodeï¼Œæ„é€ æ ‘çš„èŠ‚ç‚¹</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">  TreeNode&lt;K,V&gt; left;</span><br><span class="line">  TreeNode&lt;K,V&gt; right;</span><br><span class="line">  TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">  <span class="keyword">boolean</span> red;</span><br><span class="line"></span><br><span class="line">  TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next,</span><br><span class="line">           TreeNode&lt;K,V&gt; parent) &#123;</span><br><span class="line">    <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">    <span class="keyword">this</span>.parent = parent;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TreeBin-ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹"><a href="#TreeBin-ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹" class="headerlink" title="TreeBin ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹"></a><strong>TreeBin ç”¨ä½œæ ‘çš„å¤´ç»“ç‚¹</strong></h4><p><strong>åªå­˜å‚¨rootå’ŒfirstèŠ‚ç‚¹ï¼Œä¸å­˜å‚¨èŠ‚ç‚¹çš„keyã€valueå€¼ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeBin</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  TreeNode&lt;K,V&gt; root;</span><br><span class="line">  <span class="keyword">volatile</span> TreeNode&lt;K,V&gt; first;</span><br><span class="line">  <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">int</span> lockState;</span><br><span class="line">  <span class="comment">// values for lockState</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITER = <span class="number">1</span>; <span class="comment">// set while holding write lock</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WAITER = <span class="number">2</span>; <span class="comment">// set when waiting for write lock</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READER = <span class="number">4</span>; <span class="comment">// increment value for setting read lock</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ForwardingNode"><a href="#ForwardingNode" class="headerlink" title="ForwardingNode"></a><strong>ForwardingNode</strong></h4><p><strong>åœ¨è½¬ç§»çš„æ—¶å€™æ”¾åœ¨å¤´éƒ¨çš„èŠ‚ç‚¹ï¼Œæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">  ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">    <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•"><a href="#ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•" class="headerlink" title="ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•"></a><strong>ConcurrentHashMapå‡ ä¸ªé‡è¦æ–¹æ³•</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ç”¨æ¥è¿”å›èŠ‚ç‚¹æ•°ç»„çš„æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹çš„åŸå­æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * casåŸå­æ“ä½œï¼Œåœ¨æŒ‡å®šä½ç½®è®¾å®šå€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * åŸå­æ“ä½œï¼Œåœ¨æŒ‡å®šä½ç½®è®¾å®šå€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">  U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcurrentHashMapçš„åˆå§‹åŒ–"><a href="#ConcurrentHashMapçš„åˆå§‹åŒ–" class="headerlink" title="ConcurrentHashMapçš„åˆå§‹åŒ–"></a><strong>ConcurrentHashMapçš„åˆå§‹åŒ–</strong></h3><p>å…ˆçœ‹ä¸€ä¸‹ConcurrentHashMapçš„æ„é€ å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç©ºçš„æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¦‚æœåœ¨å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™æŒ‡å®šäº†å®¹é‡ï¼Œåˆ™åˆå§‹åŒ–sizeCtl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">  <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">             MAXIMUM_CAPACITY :</span><br><span class="line">             tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">  <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å½“å‡ºå…¥ä¸€ä¸ªMapçš„æ—¶å€™ï¼Œå…ˆè®¾å®šsizeCtlä¸ºé»˜è®¤å®¹é‡ï¼Œåœ¨æ·»åŠ å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.sizeCtl = DEFAULT_CAPACITY;</span><br><span class="line">  putAll(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªæ„é€ æ–¹æ³•ä¸­ï¼Œéƒ½æ²¡æœ‰å¯¹å­˜å‚¨Mapå…ƒç´ Nodeçš„tableå˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚è€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡putæ“ä½œçš„æ—¶å€™åœ¨è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>ä¸‹é¢æ¥çœ‹çœ‹æ•°ç»„çš„åˆå§‹åŒ–æ–¹æ³•initTable</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–æ•°ç»„tableï¼Œ</span></span><br><span class="line"><span class="comment">     * å¦‚æœsizeCtlå°äº0ï¼Œè¯´æ˜åˆ«çš„æ•°ç»„æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™è®©å‡ºæ‰§è¡Œæƒ</span></span><br><span class="line"><span class="comment">     * å¦‚æœsizeCtlå¤§äº0çš„è¯ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªå¤§å°ä¸ºsizeCtlçš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * å¦åˆ™çš„è¯åˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤å¤§å°(16)çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * ç„¶åè®¾ç½®sizeCtlçš„å€¼ä¸ºæ•°ç»„é•¿åº¦çš„3/4</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">  Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">  <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;    <span class="comment">//ç¬¬ä¸€æ¬¡putçš„æ—¶å€™ï¼Œtableè¿˜æ²¡è¢«åˆå§‹åŒ–ï¼Œè¿›å…¥while</span></span><br><span class="line">    <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)                            <span class="comment">//sizeCtlåˆå§‹å€¼ä¸º0ï¼Œå½“å°äº0çš„æ—¶å€™è¡¨ç¤ºåœ¨åˆ«çš„çº¿ç¨‹åœ¨åˆå§‹åŒ–è¡¨æˆ–æ‰©å±•è¡¨</span></span><br><span class="line">      Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;    <span class="comment">//SIZECTLï¼šè¡¨ç¤ºå½“å‰å¯¹è±¡çš„å†…å­˜åç§»é‡ï¼Œscè¡¨ç¤ºæœŸæœ›å€¼ï¼Œ-1è¡¨ç¤ºè¦æ›¿æ¢çš„å€¼ï¼Œè®¾å®šä¸º-1è¡¨ç¤ºè¦åˆå§‹åŒ–è¡¨äº†</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;        <span class="comment">//æŒ‡å®šäº†å¤§å°çš„æ—¶å€™å°±åˆ›å»ºæŒ‡å®šå¤§å°çš„Nodeæ•°ç»„ï¼Œå¦åˆ™åˆ›å»ºæŒ‡å®šå¤§å°(16)çš„Nodeæ•°ç»„</span></span><br><span class="line">          <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">          Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">          table = tab = nt;</span><br><span class="line">          sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        sizeCtl = sc;            <span class="comment">//åˆå§‹åŒ–åï¼ŒsizeCtlé•¿åº¦ä¸ºæ•°ç»„é•¿åº¦çš„3/4</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcurrentHashMapçš„putæ“ä½œè¯¦è§£"><a href="#ConcurrentHashMapçš„putæ“ä½œè¯¦è§£" class="headerlink" title="ConcurrentHashMapçš„putæ“ä½œè¯¦è§£"></a>ConcurrentHashMapçš„putæ“ä½œè¯¦è§£</h3><p>ğŸ‘‡ä¸‹é¢æ˜¯putæ–¹æ³•çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  å•çº¯çš„é¢è°ƒç”¨putValæ–¹æ³•ï¼Œå¹¶ä¸”putValçš„ç¬¬ä¸‰ä¸ªå‚æ•°è®¾ç½®ä¸ºfalse</span></span><br><span class="line"><span class="comment">     *  å½“è®¾ç½®ä¸ºfalseçš„æ—¶å€™è¡¨ç¤ºè¿™ä¸ªvalueä¸€å®šä¼šè®¾ç½®</span></span><br><span class="line"><span class="comment">     *  trueçš„æ—¶å€™ï¼Œåªæœ‰å½“è¿™ä¸ªkeyçš„valueä¸ºç©ºçš„æ—¶å€™æ‰ä¼šè®¾ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸‹é¢çœ‹ä¸€ä¸‹putValæ–¹æ³•å®ç°ï¼š</strong></p><p>å½“æ·»åŠ ä¸€å¯¹é”®å€¼å¯¹çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå»åˆ¤æ–­ä¿å­˜è¿™äº›é”®å€¼å¯¹çš„æ•°ç»„æ˜¯ä¸æ˜¯åˆå§‹åŒ–äº†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±åˆå§‹åŒ–æ•°ç»„, ç„¶åé€šè¿‡è®¡ç®—hashå€¼æ¥ç¡®å®šæ”¾åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®ã€‚</p><p>å¦‚æœè¿™ä¸ªä½ç½®ä¸ºç©ºåˆ™ç›´æ¥æ·»åŠ ï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™å–å‡ºè¿™ä¸ªèŠ‚ç‚¹æ¥ï¼Œå–å‡ºæ¥çš„èŠ‚ç‚¹çš„hashå€¼æ˜¯MOVED(-1)çš„è¯ï¼Œåˆ™è¡¨ç¤ºå½“å‰æ­£åœ¨å¯¹è¿™ä¸ªæ•°ç»„è¿›è¡Œæ‰©å®¹ï¼Œå¤åˆ¶åˆ°æ–°çš„æ•°ç»„ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿå»å¸®åŠ©å¤åˆ¶ã€‚</p><p>å¦‚æœè¿™ä¸ªèŠ‚ç‚¹ï¼Œä¸ä¸ºç©ºï¼Œä¹Ÿä¸åœ¨æ‰©å®¹ï¼Œåˆ™é€šè¿‡synchronizedæ¥åŠ é”ï¼Œè¿›è¡Œæ·»åŠ æ“ä½œã€‚</p><p>ç„¶ååˆ¤æ–­å½“å‰å–å‡ºçš„èŠ‚ç‚¹ä½ç½®å­˜æ”¾çš„æ˜¯é“¾è¡¨è¿˜æ˜¯æ ‘ï¼Œå¦‚æœæ˜¯é“¾è¡¨çš„è¯ï¼Œåˆ™éå†æ•´ä¸ªé“¾è¡¨ï¼Œç›´åˆ°å–å‡ºæ¥çš„èŠ‚ç‚¹çš„keyæ¥ä¸ªè¦æ”¾çš„keyè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœkeyç›¸ç­‰ï¼Œå¹¶ä¸”keyçš„hashå€¼ä¹Ÿç›¸ç­‰çš„è¯ï¼Œåˆ™è¯´æ˜æ˜¯åŒä¸€ä¸ªkeyï¼Œåˆ™è¦†ç›–æ‰valueï¼Œå¦åˆ™çš„è¯åˆ™æ·»åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚å¦‚æœæ˜¯æ ‘çš„è¯ï¼Œåˆ™è°ƒç”¨putTreeValæ–¹æ³•æŠŠè¿™ä¸ªå…ƒç´ æ·»åŠ åˆ°æ ‘ä¸­å»ã€‚</p><p>æœ€ååœ¨æ·»åŠ å®Œæˆä¹‹åï¼Œä¼šåˆ¤æ–­åœ¨è¯¥èŠ‚ç‚¹å¤„å…±æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹ï¼ˆæ³¨æ„æ˜¯æ·»åŠ å‰çš„ä¸ªæ•°ï¼‰ï¼Œå¦‚æœè¾¾åˆ°8ä¸ªä»¥ä¸Šäº†çš„è¯ï¼Œåˆ™è°ƒç”¨treeifyBinæ–¹æ³•æ¥å°è¯•å°†å¤„çš„é“¾è¡¨è½¬ä¸ºæ ‘ï¼Œæˆ–è€…æ‰©å®¹æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span> <span class="params">(K key, V value,<span class="keyword">boolean</span> onlyIfAbsent)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  <span class="comment">//å–å¾—keyçš„hashå€¼</span></span><br><span class="line">  <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">  <span class="comment">//ç”¨æ¥è®¡ç®—åœ¨è¿™ä¸ªèŠ‚ç‚¹æ€»å…±æœ‰å¤šå°‘ä¸ªå…ƒç´ ï¼Œç”¨æ¥æ§åˆ¶æ‰©å®¹æˆ–è€…è½¬ç§»ä¸ºæ ‘</span></span><br><span class="line">  <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (Node&lt;K, V&gt;[] tab = table; ; ) &#123;</span><br><span class="line">    Node&lt;K, V&gt; f;</span><br><span class="line">    <span class="keyword">int</span> n, i, fh;</span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">      <span class="comment">//ç¬¬ä¸€æ¬¡putçš„æ—¶å€™tableæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–table</span></span><br><span class="line">      tab = initTable();</span><br><span class="line">    <span class="comment">//é€šè¿‡å“ˆå¸Œè®¡ç®—å‡ºä¸€ä¸ªè¡¨ä¸­çš„ä½ç½®å› ä¸ºnæ˜¯æ•°ç»„çš„é•¿åº¦ï¼Œæ‰€ä»¥(n-1)&amp;hashè‚¯å®šä¸ä¼šå‡ºç°æ•°ç»„è¶Šç•Œ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">//å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰å…ƒç´ çš„è¯ï¼Œåˆ™é€šè¿‡casçš„æ–¹å¼å°è¯•æ·»åŠ ï¼Œæ³¨æ„è¿™ä¸ªæ—¶å€™æ˜¯æ²¡æœ‰åŠ é”çš„</span></span><br><span class="line">      <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                   <span class="comment">//åˆ›å»ºä¸€ä¸ªNodeæ·»åŠ åˆ°æ•°ç»„ä¸­åŒºï¼Œnullè¡¨ç¤ºçš„æ˜¯ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©º</span></span><br><span class="line">                   <span class="keyword">new</span> Node&lt;K, V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">        <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * å¦‚æœæ£€æµ‹åˆ°æŸä¸ªèŠ‚ç‚¹çš„hashå€¼æ˜¯MOVEDï¼Œåˆ™è¡¨ç¤ºæ­£åœ¨è¿›è¡Œæ•°ç»„æ‰©å¼ çš„æ•°æ®å¤åˆ¶é˜¶æ®µï¼Œ</span></span><br><span class="line"><span class="comment">                 * åˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¼šå‚ä¸å»å¤åˆ¶ï¼Œé€šè¿‡å…è®¸å¤šçº¿ç¨‹å¤åˆ¶çš„åŠŸèƒ½ï¼Œä¸€æ¬¡æ¥å‡å°‘æ•°ç»„çš„å¤åˆ¶æ‰€å¸¦æ¥çš„æ€§èƒ½æŸå¤±</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">      tab = helpTransfer(tab, f);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * å¦‚æœåœ¨è¿™ä¸ªä½ç½®æœ‰å…ƒç´ çš„è¯ï¼Œå°±é‡‡ç”¨synchronizedçš„æ–¹å¼åŠ é”ï¼Œ</span></span><br><span class="line"><span class="comment">                     *     å¦‚æœæ˜¯é“¾è¡¨çš„è¯(hashå¤§äº0)ï¼Œå°±å¯¹è¿™ä¸ªé“¾è¡¨çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œéå†ï¼Œ</span></span><br><span class="line"><span class="comment">                     *         å¦‚æœæ‰¾åˆ°äº†keyå’Œkeyçš„hashå€¼éƒ½ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œåˆ™æŠŠå®ƒçš„å€¼æ›¿æ¢åˆ°</span></span><br><span class="line"><span class="comment">                     *         å¦‚æœæ²¡æ‰¾åˆ°çš„è¯ï¼Œåˆ™æ·»åŠ åœ¨é“¾è¡¨çš„æœ€åé¢</span></span><br><span class="line"><span class="comment">                     *  å¦åˆ™ï¼Œæ˜¯æ ‘çš„è¯ï¼Œåˆ™è°ƒç”¨putTreeValæ–¹æ³•æ·»åŠ åˆ°æ ‘ä¸­å»</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     *  åœ¨æ·»åŠ å®Œä¹‹åï¼Œä¼šå¯¹è¯¥èŠ‚ç‚¹ä¸Šå…³è”çš„çš„æ•°ç›®è¿›è¡Œåˆ¤æ–­ï¼Œ</span></span><br><span class="line"><span class="comment">                     *  å¦‚æœåœ¨8ä¸ªä»¥ä¸Šçš„è¯ï¼Œåˆ™ä¼šè°ƒç”¨treeifyBinæ–¹æ³•ï¼Œæ¥å°è¯•è½¬åŒ–ä¸ºæ ‘ï¼Œæˆ–è€…æ˜¯æ‰©å®¹</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">      V oldVal = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">        <span class="comment">//å†æ¬¡å–å‡ºè¦å­˜å‚¨çš„ä½ç½®çš„å…ƒç´ ï¼Œè·Ÿå‰é¢å–å‡ºæ¥çš„æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">          <span class="comment">//å–å‡ºæ¥çš„å…ƒç´ çš„hashå€¼å¤§äº0ï¼Œå½“è½¬æ¢ä¸ºæ ‘ä¹‹åï¼Œhashå€¼ä¸º-2</span></span><br><span class="line">          <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            binCount = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//éå†è¿™ä¸ªé“¾è¡¨</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K, V&gt; e = f; ; ++binCount) &#123;</span><br><span class="line">              K ek;</span><br><span class="line">              <span class="comment">//è¦å­˜çš„å…ƒç´ çš„hashï¼Œkeyè·Ÿè¦å­˜å‚¨çš„ä½ç½®çš„èŠ‚ç‚¹çš„ç›¸åŒçš„æ—¶å€™ï¼Œæ›¿æ¢æ‰è¯¥èŠ‚ç‚¹çš„valueå³å¯</span></span><br><span class="line">              <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                  ((ek = e.key) == key ||</span><br><span class="line">                   (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                oldVal = e.val;</span><br><span class="line">                <span class="comment">//å½“ä½¿ç”¨putIfAbsentçš„æ—¶å€™ï¼Œåªæœ‰åœ¨è¿™ä¸ªkeyæ²¡æœ‰è®¾ç½®å€¼å¾—æ—¶å€™æ‰è®¾ç½®</span></span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                  e.val = value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              Node&lt;K, V&gt; pred = e;</span><br><span class="line">              <span class="comment">//å¦‚æœä¸æ˜¯åŒæ ·çš„hashï¼ŒåŒæ ·çš„keyçš„æ—¶å€™ï¼Œåˆ™åˆ¤æ–­è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œ</span></span><br><span class="line">              <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//ä¸ºç©ºçš„è¯æŠŠè¿™ä¸ªè¦åŠ å…¥çš„èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                pred.next = <span class="keyword">new</span> Node&lt;K, V&gt;(hash, key,</span><br><span class="line">                                           value, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¡¨ç¤ºå·²ç»è½¬åŒ–æˆçº¢é»‘æ ‘ç±»å‹äº†</span></span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">            Node&lt;K, V&gt; p;</span><br><span class="line">            binCount = <span class="number">2</span>;</span><br><span class="line">            <span class="comment">//è°ƒç”¨putTreeValæ–¹æ³•ï¼Œå°†è¯¥å…ƒç´ æ·»åŠ åˆ°æ ‘ä¸­å»</span></span><br><span class="line">            <span class="keyword">if</span> ((p = ((TreeBin&lt;K, V&gt;) f).putTreeVal(hash, key,</span><br><span class="line">                                                    value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">              oldVal = p.val;</span><br><span class="line">              <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                p.val = value;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å½“åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹çš„æ•°ç›®è¾¾åˆ°8ä¸ªçš„æ—¶å€™ï¼Œåˆ™æ‰©å¼ æ•°ç»„æˆ–å°†ç»™èŠ‚ç‚¹çš„æ•°æ®è½¬ä¸ºtree</span></span><br><span class="line">        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">          treeifyBin(tab, i);</span><br><span class="line">        <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">return</span> oldVal;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  addCount(<span class="number">1L</span>, binCount);    <span class="comment">//è®¡æ•°</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£"><a href="#ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£" class="headerlink" title="ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£"></a><strong>ConcurrentHashMapçš„æ‰©å®¹è¯¦è§£</strong></h3><p>åœ¨putæ–¹æ³•çš„è¯¦è§£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹çš„ä¸ªæ•°è¶…è¿‡8ä¸ªçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨treeifyBinæ–¹æ³•æ¥çœ‹çœ‹æ˜¯æ‰©å®¹è¿˜æ˜¯è½¬åŒ–ä¸ºä¸€æ£µæ ‘ï¼ŒåŒæ—¶åœ¨æ¯æ¬¡æ·»åŠ å®Œå…ƒç´ çš„addCountæ–¹æ³•ä¸­ï¼Œä¹Ÿä¼šåˆ¤æ–­å½“å‰æ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¦è¾¾åˆ°äº†sizeCtlçš„é‡ï¼Œå¦‚æœè¾¾åˆ°äº†çš„è¯ï¼Œåˆ™ä¼šè¿›å…¥transferæ–¹æ³•å»æ‰©å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Replaces all linked nodes in bin at given index unless table is</span></span><br><span class="line"><span class="comment">     * too small, in which case resizes instead.</span></span><br><span class="line"><span class="comment">     * å½“æ•°ç»„é•¿åº¦å°äº64çš„æ—¶å€™ï¼Œæ‰©å¼ æ•°ç»„é•¿åº¦ä¸€å€ï¼Œå¦åˆ™çš„è¯æŠŠé“¾è¡¨è½¬ä¸ºæ ‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">  <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;treeifyBinæ–¹\t==&gt;æ•°ç»„é•¿ï¼š&quot;</span>+tab.length);</span><br><span class="line">    <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)    <span class="comment">//MIN_TREEIFY_CAPACITY 64</span></span><br><span class="line">      tryPresize(n &lt;&lt; <span class="number">1</span>);        <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (b) &#123;    <span class="comment">//ä½¿ç”¨synchronizedåŒæ­¥å™¨ï¼Œå°†è¯¥èŠ‚ç‚¹å‡ºçš„é“¾è¡¨è½¬ä¸ºæ ‘</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">          TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;    <span class="comment">//hdï¼šæ ‘çš„å¤´(head)</span></span><br><span class="line">          <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; p =</span><br><span class="line">              <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)        <span class="comment">//æŠŠNodeç»„æˆçš„é“¾è¡¨ï¼Œè½¬åŒ–ä¸ºTreeNodeçš„é“¾è¡¨ï¼Œå¤´ç»“ç‚¹ä»»ç„¶æ”¾åœ¨ç›¸åŒçš„ä½ç½®</span></span><br><span class="line">              hd = p;    <span class="comment">//è®¾ç½®head</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              tl.next = p;</span><br><span class="line">            tl = p;</span><br><span class="line">          &#125;</span><br><span class="line">          setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));<span class="comment">//æŠŠTreeNodeçš„é“¾è¡¨æ”¾å…¥å®¹å™¨TreeBinä¸­</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“éœ€è¦æ‰©å®¹çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ—¶å€™tryPresizeæ–¹æ³•ï¼Œçœ‹çœ‹trePresizeçš„æºç </p><h3 id="trePresizeçš„æºç "><a href="#trePresizeçš„æºç " class="headerlink" title="trePresizeçš„æºç "></a>trePresizeçš„æºç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰©å®¹è¡¨ä¸ºæŒ‡å¯ä»¥å®¹çº³æŒ‡å®šä¸ªæ•°çš„å¤§å°ï¼ˆæ€»æ˜¯2çš„Næ¬¡æ–¹ï¼‰</span></span><br><span class="line"><span class="comment">     * å‡è®¾åŸæ¥çš„æ•°ç»„é•¿åº¦ä¸º16ï¼Œåˆ™åœ¨è°ƒç”¨tryPresizeçš„æ—¶å€™ï¼Œsizeå‚æ•°çš„å€¼ä¸º16&lt;&lt;1(32)ï¼Œæ­¤æ—¶sizeCtlçš„å€¼ä¸º12</span></span><br><span class="line"><span class="comment">     * è®¡ç®—å‡ºæ¥cçš„å€¼ä¸º64,åˆ™è¦æ‰©å®¹åˆ°sizeCtlâ‰¥ä¸ºæ­¢</span></span><br><span class="line"><span class="comment">     *  ç¬¬ä¸€æ¬¡æ‰©å®¹ä¹‹å æ•°ç»„é•¿ï¼š32 sizeCtlï¼š24</span></span><br><span class="line"><span class="comment">     *  ç¬¬äºŒæ¬¡æ‰©å®¹ä¹‹å æ•°ç»„é•¿ï¼š64 sizeCtlï¼š48</span></span><br><span class="line"><span class="comment">     *  ç¬¬äºŒæ¬¡æ‰©å®¹ä¹‹å æ•°ç»„é•¿ï¼š128 sizeCtlï¼š94 --&gt; è¿™ä¸ªæ—¶å€™æ‰ä¼šé€€å‡ºæ‰©å®¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * MAXIMUM_CAPACITY = 1 &lt;&lt; 30</span></span><br><span class="line"><span class="comment">             * å¦‚æœç»™å®šçš„å¤§å°å¤§äºç­‰äºæ•°ç»„å®¹é‡çš„ä¸€åŠï¼Œåˆ™ç›´æ¥ä½¿ç”¨æœ€å¤§å®¹é‡ï¼Œ</span></span><br><span class="line"><span class="comment">             * å¦åˆ™ä½¿ç”¨tableSizeForç®—å‡ºæ¥</span></span><br><span class="line"><span class="comment">             * åé¢tableä¸€ç›´è¦æ‰©å®¹åˆ°è¿™ä¸ªå€¼å°äºç­‰äºsizeCtrl(æ•°ç»„é•¿åº¦çš„3/4)æ‰é€€å‡ºæ‰©å®¹</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">  <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">  tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">int</span> sc;</span><br><span class="line">  <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">    <span class="comment">//            printTable(tab);    è°ƒè¯•ç”¨çš„</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * å¦‚æœæ•°ç»„tableè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªå¤§å°ä¸ºsizeCtrlå’Œåˆšåˆšç®—å‡ºæ¥çš„cä¸­è¾ƒå¤§çš„ä¸€ä¸ªå¤§å°çš„æ•°ç»„</span></span><br><span class="line"><span class="comment">             * åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè®¾ç½®sizeCtrlä¸º-1ï¼Œåˆå§‹åŒ–å®Œæˆä¹‹åæŠŠsizeCtrlè®¾ç½®ä¸ºæ•°ç»„é•¿åº¦çš„3/4</span></span><br><span class="line"><span class="comment">             * ä¸ºä»€ä¹ˆè¦åœ¨æ‰©å¼ çš„åœ°æ–¹æ¥åˆå§‹åŒ–æ•°ç»„å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå¦‚æœç¬¬ä¸€æ¬¡putçš„æ—¶å€™ä¸æ˜¯putå•ä¸ªå…ƒç´ ï¼Œ</span></span><br><span class="line"><span class="comment">             * è€Œæ˜¯è°ƒç”¨putAllæ–¹æ³•ç›´æ¥putä¸€ä¸ªmapçš„è¯ï¼Œåœ¨putALlæ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨initTableæ–¹æ³•å»åˆå§‹åŒ–tableï¼Œ</span></span><br><span class="line"><span class="comment">             * è€Œæ˜¯ç›´æ¥è°ƒç”¨äº†tryPresizeæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åšä¸€ä¸ªæ˜¯ä¸æ˜¯éœ€è¦åˆå§‹åŒ–tableçš„åˆ¤æ–­</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">      n = (sc &gt; c) ? sc : c;</span><br><span class="line">      <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;    <span class="comment">//åˆå§‹åŒ–tabçš„æ—¶å€™ï¼ŒæŠŠsizeCtlè®¾ä¸º-1</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">            table = nt;</span><br><span class="line">            sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          sizeCtl = sc;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ä¸€ç›´æ‰©å®¹åˆ°çš„cå°äºç­‰äºsizeCtlæˆ–è€…æ•°ç»„é•¿åº¦å¤§äºæœ€å¤§é•¿åº¦çš„æ—¶å€™ï¼Œåˆ™é€€å‡º</span></span><br><span class="line"><span class="comment">             * æ‰€ä»¥åœ¨ä¸€æ¬¡æ‰©å®¹ä¹‹åï¼Œä¸æ˜¯åŸæ¥é•¿åº¦çš„ä¸¤å€ï¼Œè€Œæ˜¯2çš„næ¬¡æ–¹å€</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">      <span class="keyword">break</span>;    <span class="comment">//é€€å‡ºæ‰©å¼ </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">      <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * å¦‚æœæ­£åœ¨æ‰©å®¹Tableçš„è¯ï¼Œåˆ™å¸®åŠ©æ‰©å®¹</span></span><br><span class="line"><span class="comment">                 * å¦åˆ™çš„è¯ï¼Œå¼€å§‹æ–°çš„æ‰©å®¹</span></span><br><span class="line"><span class="comment">                 * åœ¨transferæ“ä½œï¼Œå°†ç¬¬ä¸€ä¸ªå‚æ•°çš„tableä¸­çš„å…ƒç´ ï¼Œç§»åŠ¨åˆ°ç¬¬äºŒä¸ªå…ƒç´ çš„tableä¸­å»ï¼Œ</span></span><br><span class="line"><span class="comment">                 * è™½ç„¶æ­¤æ—¶ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®çš„æ˜¯nullï¼Œä½†æ˜¯ï¼Œåœ¨transferæ–¹æ³•ä¸­ï¼Œå½“ç¬¬äºŒä¸ªå‚æ•°ä¸ºnullçš„æ—¶å€™ï¼Œ</span></span><br><span class="line"><span class="comment">                 * ä¼šåˆ›å»ºä¸€ä¸ªä¸¤å€å¤§å°çš„table</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] nt;</span><br><span class="line">        <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">            sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">            transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * transferçš„çº¿ç¨‹æ•°åŠ ä¸€,è¯¥çº¿ç¨‹å°†è¿›è¡Œtransferçš„å¸®å¿™</span></span><br><span class="line"><span class="comment">                     * åœ¨transferçš„æ—¶å€™ï¼Œscè¡¨ç¤ºåœ¨transferå·¥ä½œçš„çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">        <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">          transfer(tab, nt);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * æ²¡æœ‰åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹ï¼Œåˆ™å¼€å§‹æ‰©å®¹</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                   (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>)) &#123;</span><br><span class="line">        transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨tryPresizeæ–¹æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰åŠ é”ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹è¿›å…¥ï¼Œå¦‚æœæ•°ç»„æ­£åœ¨æ‰©å¼ ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿå»å¸®åŠ©æ‰©å®¹ã€‚</p><h3 id="transferæ–¹æ³•"><a href="#transferæ–¹æ³•" class="headerlink" title="transferæ–¹æ³•"></a>transferæ–¹æ³•</h3><p>æ•°ç»„æ‰©å®¹çš„ä¸»è¦æ–¹æ³•å°±æ˜¯transferæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Moves and/or copies the nodes in each bin to new table. See</span></span><br><span class="line"><span class="comment">     * above for explanation.</span></span><br><span class="line"><span class="comment">     * æŠŠæ•°ç»„ä¸­çš„èŠ‚ç‚¹å¤åˆ¶åˆ°æ–°çš„æ•°ç»„çš„ç›¸åŒä½ç½®ï¼Œæˆ–è€…ç§»åŠ¨åˆ°æ‰©å¼ éƒ¨åˆ†çš„ç›¸åŒä½ç½®</span></span><br><span class="line"><span class="comment">     * åœ¨è¿™é‡Œé¦–å…ˆä¼šè®¡ç®—ä¸€ä¸ªæ­¥é•¿ï¼Œè¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹å¤„ç†çš„æ•°ç»„é•¿åº¦ï¼Œç”¨æ¥æ§åˆ¶å¯¹CPUçš„ä½¿ç”¨ï¼Œ</span></span><br><span class="line"><span class="comment">     * æ¯ä¸ªCPUæœ€å°‘å¤„ç†16ä¸ªé•¿åº¦çš„æ•°ç»„å…ƒç´ ,ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªæ•°ç»„çš„é•¿åº¦åªæœ‰16ï¼Œé‚£åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹å…¶è¿›è¡Œæ‰©å®¹çš„å¤åˆ¶ç§»åŠ¨æ“ä½œ</span></span><br><span class="line"><span class="comment">     * æ‰©å®¹çš„æ—¶å€™ä¼šä¸€ç›´éå†ï¼ŒçŸ¥é“å¤åˆ¶å®Œæ‰€æœ‰èŠ‚ç‚¹ï¼Œæ²¡å¤„ç†ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ä¼šåœ¨é“¾è¡¨çš„å¤´éƒ¨è®¾ç½®ä¸€ä¸ªfwdèŠ‚ç‚¹ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹å°±ä¼šè·³è¿‡ä»–ï¼Œ</span></span><br><span class="line"><span class="comment">     * å¤åˆ¶ååœ¨æ–°æ•°ç»„ä¸­çš„é“¾è¡¨ä¸æ˜¯ç»å¯¹çš„ååºçš„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">  <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)    <span class="comment">//MIN_TRANSFER_STRIDE ç”¨æ¥æ§åˆ¶ä¸è¦å ç”¨å¤ªå¤šCPU</span></span><br><span class="line">    stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range    //MIN_TRANSFER_STRIDE=16</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å¦‚æœå¤åˆ¶çš„ç›®æ ‡nextTabä¸ºnullçš„è¯ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªtableä¸¤å€é•¿çš„nextTab</span></span><br><span class="line"><span class="comment">         * æ­¤æ—¶nextTableè¢«è®¾ç½®å€¼äº†(åœ¨åˆå§‹æƒ…å†µä¸‹æ˜¯ä¸ºnullçš„)</span></span><br><span class="line"><span class="comment">         * å› ä¸ºå¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹å¼€å§‹äº†è¡¨çš„æ‰©å¼ çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¼šè¿›æ¥å¸®å¿™æ‰©å¼ ï¼Œ</span></span><br><span class="line"><span class="comment">         * è€Œåªæ˜¯ç¬¬ä¸€ä¸ªå¼€å§‹æ‰©å¼ çš„çº¿ç¨‹éœ€è¦åˆå§‹åŒ–ä¸‹ç›®æ ‡æ•°ç»„</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">      Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">      nextTab = nt;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">      sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nextTable = nextTab;</span><br><span class="line">    transferIndex = n;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * åˆ›å»ºä¸€ä¸ªfwdèŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥æ§åˆ¶å¹¶å‘çš„ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæˆ–å·²ç»è¢«è½¬ç§»ä¹‹åï¼Œå°±è®¾ç½®ä¸ºfwdèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * è¿™æ˜¯ä¸€ä¸ªç©ºçš„æ ‡å¿—èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">  <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;    <span class="comment">//æ˜¯å¦ç»§ç»­å‘å‰æŸ¥æ‰¾çš„æ ‡å¿—ä½</span></span><br><span class="line">  <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep(æ¸…æ‰«) before committing nextTab,åœ¨å®Œæˆä¹‹å‰é‡æ–°åœ¨æ‰«æä¸€éæ•°ç»„ï¼Œçœ‹çœ‹æœ‰æ²¡å®Œæˆçš„æ²¡</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">    Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">    <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">      <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">      <span class="keyword">if</span> (--i &gt;= bound || finishing) &#123;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        i = -<span class="number">1</span>;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">               (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                             nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">        bound = nextBound;</span><br><span class="line">        i = nextIndex - <span class="number">1</span>;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">      <span class="keyword">int</span> sc;</span><br><span class="line">      <span class="keyword">if</span> (finishing) &#123;        <span class="comment">//å·²ç»å®Œæˆè½¬ç§»</span></span><br><span class="line">        nextTable = <span class="keyword">null</span>;</span><br><span class="line">        table = nextTab;</span><br><span class="line">        sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);    <span class="comment">//è®¾ç½®sizeCtlä¸ºæ‰©å®¹åçš„0.75</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">        i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)            <span class="comment">//æ•°ç»„ä¸­æŠŠnullçš„å…ƒç´ è®¾ç½®ä¸ºForwardingNodeèŠ‚ç‚¹(hashå€¼ä¸ºMOVED[-1])</span></span><br><span class="line">      advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">      advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (f) &#123;                <span class="comment">//åŠ é”æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">          Node&lt;K,V&gt; ln, hn;</span><br><span class="line">          <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;        <span class="comment">//è¯¥èŠ‚ç‚¹çš„hashå€¼å¤§äºç­‰äº0ï¼Œè¯´æ˜æ˜¯ä¸€ä¸ªNodeèŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                 * å› ä¸ºnçš„å€¼ä¸ºæ•°ç»„çš„é•¿åº¦ï¼Œä¸”æ˜¯power(2,x)çš„ï¼Œæ‰€ä»¥ï¼Œåœ¨&amp;æ“ä½œçš„ç»“æœåªå¯èƒ½æ˜¯0æˆ–è€…n</span></span><br><span class="line"><span class="comment">                                 * æ ¹æ®è¿™ä¸ªè§„åˆ™</span></span><br><span class="line"><span class="comment">                                 *         0--&gt;  æ”¾åœ¨æ–°è¡¨çš„ç›¸åŒä½ç½®</span></span><br><span class="line"><span class="comment">                                 *         n--&gt;  æ”¾åœ¨æ–°è¡¨çš„ï¼ˆn+åŸæ¥ä½ç½®ï¼‰</span></span><br><span class="line"><span class="comment">                                 */</span></span><br><span class="line">            <span class="keyword">int</span> runBit = fh &amp; n; </span><br><span class="line">            Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             * lastRun è¡¨ç¤ºçš„æ˜¯éœ€è¦å¤åˆ¶çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                             * æ¯å½“æ–°èŠ‚ç‚¹çš„hash&amp;n -&gt; b å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå°±æŠŠrunBitè®¾ç½®ä¸ºè¿™ä¸ªç»“æœb</span></span><br><span class="line"><span class="comment">                             * è¿™æ ·forå¾ªç¯ä¹‹åï¼ŒrunBitçš„å€¼å°±æ˜¯æœ€åä¸å˜çš„hash&amp;nçš„å€¼</span></span><br><span class="line"><span class="comment">                             * è€ŒlastRunçš„å€¼å°±æ˜¯æœ€åä¸€æ¬¡å¯¼è‡´hash&amp;n å‘ç”Ÿå˜åŒ–çš„èŠ‚ç‚¹(å‡è®¾ä¸ºpèŠ‚ç‚¹)</span></span><br><span class="line"><span class="comment">                             * ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºpèŠ‚ç‚¹åé¢çš„èŠ‚ç‚¹çš„hash&amp;n å€¼è·ŸpèŠ‚ç‚¹æ˜¯ä¸€æ ·çš„ï¼Œ</span></span><br><span class="line"><span class="comment">                             * æ‰€ä»¥åœ¨å¤åˆ¶åˆ°æ–°çš„tableçš„æ—¶å€™ï¼Œå®ƒè‚¯å®šè¿˜æ˜¯è·ŸpèŠ‚ç‚¹åœ¨åŒä¸€ä¸ªä½ç½®</span></span><br><span class="line"><span class="comment">                             * åœ¨å¤åˆ¶å®ŒpèŠ‚ç‚¹ä¹‹åï¼ŒpèŠ‚ç‚¹çš„nextèŠ‚ç‚¹è¿˜æ˜¯æŒ‡å‘å®ƒåŸæ¥çš„èŠ‚ç‚¹ï¼Œå°±ä¸éœ€è¦è¿›è¡Œå¤åˆ¶äº†ï¼Œè‡ªå·±å°±è¢«å¸¦è¿‡å»äº†</span></span><br><span class="line"><span class="comment">                             * è¿™ä¹Ÿå°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¤åˆ¶åçš„é“¾è¡¨çš„é¡ºåºå¹¶ä¸ä¸€å®šæ˜¯åŸæ¥çš„å€’åº</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">              <span class="keyword">int</span> b = p.hash &amp; n;    <span class="comment">//nçš„å€¼ä¸ºæ‰©å¼ å‰çš„æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">              <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                runBit = b;</span><br><span class="line">                lastRun = p;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">              ln = lastRun;</span><br><span class="line">              hn = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">              hn = lastRun;</span><br><span class="line">              ln = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             * æ„é€ ä¸¤ä¸ªé“¾è¡¨ï¼Œé¡ºåºå¤§éƒ¨åˆ†å’ŒåŸæ¥æ˜¯åçš„</span></span><br><span class="line"><span class="comment">                             * åˆ†åˆ«æ”¾åˆ°åŸæ¥çš„ä½ç½®å’Œæ–°å¢åŠ çš„é•¿åº¦çš„ç›¸åŒä½ç½®(i/n+i)</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">              <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">              <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                         * å‡è®¾runBitçš„å€¼ä¸º0ï¼Œ</span></span><br><span class="line"><span class="comment">                                         * åˆ™ç¬¬ä¸€æ¬¡è¿›å…¥è¿™ä¸ªè®¾ç½®çš„æ—¶å€™ç›¸å½“äºæŠŠæ—§çš„åºåˆ—çš„æœ€åä¸€æ¬¡å‘ç”Ÿhashå˜åŒ–çš„èŠ‚ç‚¹(è¯¥èŠ‚ç‚¹åé¢å¯èƒ½è¿˜æœ‰hashè®¡ç®—ååŒä¸º0çš„èŠ‚ç‚¹)è®¾ç½®åˆ°æ—§çš„tableçš„ç¬¬ä¸€ä¸ªhashè®¡ç®—åä¸º0çš„èŠ‚ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         * å¹¶ä¸”æŠŠè‡ªå·±è¿”å›ï¼Œç„¶ååœ¨ä¸‹æ¬¡è¿›æ¥çš„æ—¶å€™æŠŠå®ƒè‡ªå·±è®¾ç½®ä¸ºåé¢èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         */</span></span><br><span class="line">                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                                         * å‡è®¾runBitçš„å€¼ä¸ä¸º0ï¼Œ</span></span><br><span class="line"><span class="comment">                                         * åˆ™ç¬¬ä¸€æ¬¡è¿›å…¥è¿™ä¸ªè®¾ç½®çš„æ—¶å€™ç›¸å½“äºæŠŠæ—§çš„åºåˆ—çš„æœ€åä¸€æ¬¡å‘ç”Ÿhashå˜åŒ–çš„èŠ‚ç‚¹(è¯¥èŠ‚ç‚¹åé¢å¯èƒ½è¿˜æœ‰hashè®¡ç®—ååŒä¸ä¸º0çš„èŠ‚ç‚¹)è®¾ç½®åˆ°æ—§çš„tableçš„ç¬¬ä¸€ä¸ªhashè®¡ç®—åä¸ä¸º0çš„èŠ‚ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         * å¹¶ä¸”æŠŠè‡ªå·±è¿”å›ï¼Œç„¶ååœ¨ä¸‹æ¬¡è¿›æ¥çš„æ—¶å€™æŠŠå®ƒè‡ªå·±è®¾ç½®ä¸ºåé¢èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                                         */</span></span><br><span class="line">                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);    </span><br><span class="line">            &#125;</span><br><span class="line">            setTabAt(nextTab, i, ln);    </span><br><span class="line">            setTabAt(nextTab, i + n, hn);</span><br><span class="line">            setTabAt(tab, i, fwd);</span><br><span class="line">            advance = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;    <span class="comment">//å¦åˆ™çš„è¯æ˜¯ä¸€ä¸ªæ ‘èŠ‚ç‚¹</span></span><br><span class="line">            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">            TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">            TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">              <span class="keyword">int</span> h = e.hash;</span><br><span class="line">              TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">              <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                  lo = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                  loTail.next = p;</span><br><span class="line">                loTail = p;</span><br><span class="line">                ++lc;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                  hi = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                  hiTail.next = p;</span><br><span class="line">                hiTail = p;</span><br><span class="line">                ++hc;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             * åœ¨å¤åˆ¶å®Œæ ‘èŠ‚ç‚¹ä¹‹åï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹å¤„æ„æˆçš„æ ‘è¿˜æœ‰å‡ ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line"><span class="comment">                             * å¦‚æœâ‰¤6ä¸ªçš„è¯ï¼Œå°±è½¬å›ä¸ºä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">            setTabAt(nextTab, i, ln);</span><br><span class="line">            setTabAt(nextTab, i + n, hn);</span><br><span class="line">            setTabAt(tab, i, fwd);</span><br><span class="line">            advance = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼ŒConcurrentHashMapçš„putæ“ä½œå’Œæ‰©å®¹éƒ½ä»‹ç»çš„å·®ä¸å¤šäº†ï¼Œ</p><p>ä¸‹é¢çš„ä¸¤ç‚¹ä¸€å®šè¦æ³¨æ„ï¼š</p><p>1ã€å¤åˆ¶ä¹‹åçš„æ–°é“¾è¡¨ä¸æ˜¯æ—§é“¾è¡¨çš„ç»å¯¹å€’åº</p><p>2ã€åœ¨æ‰©å®¹çš„æ—¶å€™æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å¤„ç†çš„æ­¥é•¿ï¼Œæœ€å°‘ä¸º16ï¼Œåœ¨è¿™ä¸ªæ­¥é•¿èŒƒå›´å†…çš„æ•°ç»„èŠ‚ç‚¹åªæœ‰è‡ªå·±ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†</p><h3 id="ConcurrentHashMapçš„getæ“ä½œè¯¦è§£"><a href="#ConcurrentHashMapçš„getæ“ä½œè¯¦è§£" class="headerlink" title="ConcurrentHashMapçš„getæ“ä½œè¯¦è§£"></a><strong>ConcurrentHashMapçš„getæ“ä½œè¯¦è§£</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ç›¸æ¯”putæ–¹æ³•ï¼Œgetå°±å¾ˆå•çº¯äº†ï¼Œæ”¯æŒå¹¶å‘æ“ä½œï¼Œ</span></span><br><span class="line"><span class="comment">     * å½“keyä¸ºnullçš„æ—¶å€™å›æŠ›å‡ºNullPointerExceptionçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * getæ“ä½œé€šè¿‡é¦–å…ˆè®¡ç®—keyçš„hashå€¼æ¥ç¡®å®šè¯¥å…ƒç´ æ”¾åœ¨æ•°ç»„çš„å“ªä¸ªä½ç½®</span></span><br><span class="line"><span class="comment">     * ç„¶åéå†è¯¥ä½ç½®çš„æ‰€æœ‰èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸å­˜åœ¨çš„è¯è¿”å›null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">  <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">  <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">      (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">        <span class="keyword">return</span> e.val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">          ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">        <span class="keyword">return</span> e.val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹"><a href="#é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹" class="headerlink" title="é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹"></a><strong>é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„è¿‡ç¨‹</strong></h3><p>å‰é¢åœ¨è®²è§£tryifyBinçš„æºç çš„æ—¶å€™è®²åˆ°è¿‡ï¼Œå¦‚æœåœ¨å½“ä¸ªbinä¸Šçš„å…ƒç´ è¶…è¿‡äº†8ä¸ªçš„æ—¶å€™ï¼Œå°±ä¼šå°è¯•å»æ‰©å®¹æ•°ç»„æˆ–è€…æ˜¯å°†é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘ã€‚</p><p>æºç ï¼šğŸ‘‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">  <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)    <span class="comment">//MIN_TREEIFY_CAPACITY 64</span></span><br><span class="line">      tryPresize(n &lt;&lt; <span class="number">1</span>);        <span class="comment">// æ•°ç»„æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//ä½¿ç”¨synchronizedåŒæ­¥å™¨ï¼Œå°†è¯¥èŠ‚ç‚¹å‡ºçš„é“¾è¡¨è½¬ä¸ºæ ‘</span></span><br><span class="line">      <span class="keyword">synchronized</span> (b) &#123;   </span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">          TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;    <span class="comment">//hdï¼šæ ‘çš„å¤´(head)</span></span><br><span class="line">          <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; p =</span><br><span class="line">              <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//æŠŠNodeç»„æˆçš„é“¾è¡¨ï¼Œè½¬åŒ–ä¸ºTreeNodeçš„é“¾è¡¨ï¼Œå¤´ç»“ç‚¹ä»»ç„¶æ”¾åœ¨ç›¸åŒçš„ä½ç½®</span></span><br><span class="line">            <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)        </span><br><span class="line">              hd = p;    <span class="comment">//è®¾ç½®head</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              tl.next = p;</span><br><span class="line">            tl = p;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//æŠŠTreeNodeçš„é“¾è¡¨æ”¾å…¥å®¹å™¨TreeBin</span></span><br><span class="line">          setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));ä¸­</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå°†Nodeçš„é“¾è¡¨è½¬åŒ–ä¸ºä¸€ä¸ªTreeNodeçš„é“¾è¡¨ï¼Œç„¶åå°†TreeNodeé“¾è¡¨çš„å¤´ç»“ç‚¹æ¥æ„é€ ä¸€ä¸ªTreeBinã€‚ä¸‹é¢æ˜¯TreeBinæ„é€ æ–¹æ³•çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">  <span class="comment">//åˆ›å»ºçš„TreeBinæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œhashå€¼ä¸ºTREEBINï¼ˆ-2ï¼‰</span></span><br><span class="line">  <span class="keyword">super</span>(TREEBIN, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);    </span><br><span class="line">  <span class="keyword">this</span>.first = b;</span><br><span class="line">  TreeNode&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = b, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">    next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">    x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">      x.parent = <span class="keyword">null</span>;</span><br><span class="line">      x.red = <span class="keyword">false</span>;</span><br><span class="line">      r = x;</span><br><span class="line">    &#125;<span class="comment">//</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      K k = x.key;</span><br><span class="line">      <span class="keyword">int</span> h = x.hash;</span><br><span class="line">      Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">//xä»£è¡¨çš„æ˜¯è½¬æ¢ä¸ºæ ‘ä¹‹å‰çš„é¡ºåºéå†åˆ°é“¾è¡¨çš„ä½ç½®çš„èŠ‚ç‚¹ï¼Œrä»£è¡¨çš„æ˜¯æ ¹èŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> dir, ph;</span><br><span class="line">        K pk = p.key;</span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)    <span class="comment">//</span></span><br><span class="line">          dir = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">          dir = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                  (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                 (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">          <span class="comment">//å½“keyä¸å¯ä»¥æ¯”è¾ƒï¼Œæˆ–è€…ç›¸ç­‰çš„æ—¶å€™é‡‡å–çš„ä¸€ç§æ’åºæªæ–½</span></span><br><span class="line">          dir = tieBreakOrder(k, pk);   </span><br><span class="line">        TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œåˆ¤æ–­è¦æ”¾çš„left/rightæ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºç»§ç»­ç”¨left/rightèŠ‚ç‚¹æ¥åˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">          x.parent = xp;</span><br><span class="line">          <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">            xp.left = x;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            xp.right = x;</span><br><span class="line">          <span class="comment">//æ¯æ¬¡æ’å…¥ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™éƒ½è°ƒç”¨balanceInsertionæ¥ä¿æŒçº¢é»‘æ ‘çš„å¹³è¡¡</span></span><br><span class="line">          r = balanceInsertion(r, x); </span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.root = r;</span><br><span class="line">  <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶"><a href="#ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶" class="headerlink" title="ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶"></a>ConcurrentHashMapçš„åŒæ­¥æœºåˆ¶</h2><p>å‰é¢åˆ†æäº†ä¸‹ConcurrentHashMapçš„æºç ï¼Œé‚£ä¹ˆï¼Œå¯¹äºä¸€ä¸ªæ˜ å°„é›†åˆæ¥è¯´ï¼ŒConcurrentHashMapæ˜¯å¦‚æœæ¥åšåˆ°å¹¶å‘å®‰å…¨ï¼Œåˆæ˜¯å¦‚ä½•åšåˆ°é«˜æ•ˆçš„å¹¶å‘çš„å‘¢ï¼Ÿ</p><p>é¦–å…ˆæ˜¯è¯»æ“ä½œï¼Œä»æºç ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨getæ“ä½œä¸­ï¼Œæ ¹æœ¬æ²¡æœ‰ä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨unsafeæ–¹æ³•ï¼Œæ‰€ä»¥è¯»æ“ä½œæ˜¯æ”¯æŒå¹¶å‘æ“ä½œçš„ã€‚é‚£ä¹ˆå†™æ“ä½œå‘¢ï¼Ÿ</p><p>åˆ†æè¿™ä¸ªä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¼•èµ·æ•°ç»„çš„æ‰©å®¹ï¼Œæ‰©å®¹æ˜¯é€šè¿‡transferæ–¹æ³•æ¥è¿›è¡Œçš„ã€‚è€Œè°ƒç”¨transferæ–¹æ³•çš„åªæœ‰<code>trePresize</code>ã€<code>helpTransfer</code>å’Œ<code>addCount</code>ä¸‰ä¸ªæ–¹æ³•ã€‚</p><p>è¿™ä¸‰ä¸ªæ–¹æ³•åˆæ˜¯åˆ†åˆ«åœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¿›è¡Œè°ƒç”¨çš„å‘¢ï¼Ÿ</p><p>tryPresizeæ˜¯åœ¨treeIfybinå’ŒputAllæ–¹æ³•ä¸­è°ƒç”¨ï¼ŒtreeIfybinä¸»è¦æ˜¯åœ¨putæ·»åŠ å…ƒç´ å®Œä¹‹åï¼Œåˆ¤æ–­è¯¥æ•°ç»„èŠ‚ç‚¹ç›¸å…³å…ƒç´ æ˜¯ä¸æ˜¯å·²ç»è¶…è¿‡8ä¸ªçš„æ—¶å€™ï¼Œå¦‚æœè¶…è¿‡åˆ™ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥æ‰©å®¹æ•°ç»„æˆ–è€…æŠŠé“¾è¡¨è½¬ä¸ºæ ‘ã€‚</p><p>helpTransferæ˜¯åœ¨å½“ä¸€ä¸ªçº¿ç¨‹è¦å¯¹tableä¸­å…ƒç´ è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœæ£€æµ‹åˆ°èŠ‚ç‚¹çš„HASHå€¼ä¸ºMOVEDçš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨helpTransferæ–¹æ³•ï¼Œåœ¨helpTransferä¸­å†è°ƒç”¨transferæ–¹æ³•æ¥å¸®åŠ©å®Œæˆæ•°ç»„çš„æ‰©å®¹</p><p>addCountæ˜¯åœ¨å½“å¯¹æ•°ç»„è¿›è¡Œæ“ä½œï¼Œä½¿å¾—æ•°ç»„ä¸­å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°å‘ç”Ÿäº†å˜åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨çš„æ–¹æ³•ã€‚</p><p><strong>æ‰€ä»¥å¼•èµ·æ•°ç»„æ‰©å®¹çš„æƒ…å†µå¦‚ä¸‹</strong>ï¼š</p><p>1ã€åªæœ‰åœ¨å¾€mapä¸­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œåœ¨æŸä¸€ä¸ªèŠ‚ç‚¹çš„æ•°ç›®å·²ç»è¶…è¿‡äº†8ä¸ªï¼ŒåŒæ—¶æ•°ç»„çš„é•¿åº¦åˆå°äº64çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘æ•°ç»„çš„æ‰©å®¹ã€‚</p><p>2ã€å½“æ•°ç»„ä¸­å…ƒç´ è¾¾åˆ°äº†sizeCtlçš„æ•°é‡çš„æ—¶å€™ï¼Œåˆ™ä¼šè°ƒç”¨transferæ–¹æ³•æ¥è¿›è¡Œæ‰©å®¹</p><p><strong>é‚£ä¹ˆåœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œå¯ä»¥ä¸å¯ä»¥å¯¹æ•°ç»„è¿›è¡Œè¯»å†™æ“ä½œå‘¢ï¼Ÿ</strong></p><p>äº‹å®ä¸Šæ˜¯å¯ä»¥çš„ã€‚å½“åœ¨è¿›è¡Œæ•°ç»„æ‰©å®¹çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹è¿˜æ²¡æœ‰è¢«å¤„ç†ï¼ˆä¹Ÿå°±æ˜¯è¯´è¿˜æ²¡æœ‰è®¾ç½®ä¸ºfwdèŠ‚ç‚¹ï¼‰ï¼Œé‚£å°±å¯ä»¥è¿›è¡Œè®¾ç½®æ“ä½œã€‚å¦‚æœè¯¥èŠ‚ç‚¹å·²ç»è¢«å¤„ç†äº†ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¹Ÿä¼šåŠ å…¥åˆ°æ‰©å®¹çš„æ“ä½œä¸­å»ã€‚</p><p><strong>é‚£ä¹ˆï¼Œå¤šä¸ªçº¿ç¨‹åˆæ˜¯å¦‚ä½•åŒæ­¥å¤„ç†çš„å‘¢ï¼Ÿ</strong></p><p>åœ¨ConcurrentHashMapä¸­ï¼ŒåŒæ­¥å¤„ç†ä¸»è¦æ˜¯é€šè¿‡Synchronizedå’Œunsafeä¸¤ç§æ–¹å¼æ¥å®Œæˆçš„ã€‚</p><p>1ã€åœ¨å–å¾—sizeCtlã€æŸä¸ªä½ç½®çš„Nodeçš„æ—¶å€™ï¼Œä½¿ç”¨çš„éƒ½æ˜¯unsafeçš„æ–¹æ³•ï¼Œæ¥è¾¾åˆ°å¹¶å‘å®‰å…¨çš„ç›®çš„</p><p>2ã€å½“éœ€è¦åœ¨æŸä¸ªä½ç½®è®¾ç½®èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåˆ™ä¼šé€šè¿‡Synchronizedçš„åŒæ­¥æœºåˆ¶æ¥é”å®šè¯¥ä½ç½®çš„èŠ‚ç‚¹ã€‚</p><p>3ã€åœ¨æ•°ç»„æ‰©å®¹çš„æ—¶å€™ï¼Œåˆ™é€šè¿‡å¤„ç†çš„æ­¥é•¿å’ŒfwdèŠ‚ç‚¹æ¥è¾¾åˆ°å¹¶å‘å®‰å…¨çš„ç›®çš„ï¼Œé€šè¿‡è®¾ç½®hashå€¼ä¸ºMOVED</p><p>4ã€å½“æŠŠæŸä¸ªä½ç½®çš„èŠ‚ç‚¹å¤åˆ¶åˆ°æ‰©å¼ åçš„tableçš„æ—¶å€™ï¼Œä¹Ÿé€šè¿‡Synchronizedçš„åŒæ­¥æœºåˆ¶æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://juejin.cn/search?query=concurrenthashmap&amp;utm_source=gold_browser_extension&amp;utm_medium=search">https://juejin.cn/search?query=concurrenthashmap&amp;utm_source=gold_browser_extension&amp;utm_medium=search</a></p><p><a href="https://juejin.cn/post/6844904136937308168">https://juejin.cn/post/6844904136937308168</a></p><p><a href="https://www.cnblogs.com/zerotomax/p/8687425.html#go0">https://www.cnblogs.com/zerotomax/p/8687425.html#go0</a></p><p><a href="https://juejin.cn/post/6844903520957644808">https://juejin.cn/post/6844903520957644808</a></p><p><a href="https://processon.com/view/6049998ae401fd39d6fffbaa?fromnew=1">https://processon.com/view/6049998ae401fd39d6fffbaa?fromnew=1</a></p><p><a href="https://juejin.cn/post/6871793103020556295">https://juejin.cn/post/6871793103020556295</a></p><p><a href="https://juejin.cn/post/6844903641866846222">https://juejin.cn/post/6844903641866846222</a></p><p><a href="https://juejin.cn/post/6844903602423595015">https://juejin.cn/post/6844903602423595015</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ConcurrentHashMap&quot;&gt;&lt;a href=&quot;#ConcurrentHashMap&quot; class=&quot;headerlink&quot; title=&quot;ConcurrentHashMap&quot;&gt;&lt;/a&gt;ConcurrentHashMap&lt;/h1&gt;&lt;p&gt;Mapåº”è¯¥æ˜¯æˆ‘ä»¬å¹³æ—¶</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹CountDownLatchå·¥å…·</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCountDownLatch%E5%B7%A5%E5%85%B7/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCountDownLatch%E5%B7%A5%E5%85%B7/</id>
    <published>2021-08-04T09:00:07.000Z</published>
    <updated>2021-08-05T09:11:41.525Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h1><p>ä½ è¦é—®ä»€ä¹ˆæ˜¯CountDownLatch? é‚£æˆ‘å¯æœ‰çš„è¯´äº†ã€‚</p><p>ä¹‹å‰å¹²æ´»çš„æ—¶å€™ï¼Œæœ‰å¾ˆå¤šå¤„ç†æ•°æ®çš„ä»»åŠ¡ï¼Œä½†æ˜¯å‘¢ï¼Œæ•°æ®é‡å¾ˆå¤§ï¼Œå†™çš„javaè„šæœ¬æ‰§è¡Œä¸‹æ¥è‚¯å®šä¼šæ¯”è¾ƒæ…¢ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Œæƒ³èµ·æ¥åˆšæ¯•ä¸šé‚£ä¼šï¼Œæœ‰ä¸ªåŒäº‹å†™äº†ä¸€ä¸ªå¹¶å‘è°ƒç”¨çš„å·¥å…·ï¼Œå½“æ—¶æ„Ÿè§‰ç¢‰å ¡äº†ã€‚</p><p>å½“æˆ‘æŸ¥çœ‹è¿™ä¸ªå·¥å…·çš„å…·ä½“å®ç°æ—¶ï¼Œå‘ç°å®ƒæ˜¯åŸºäºCountDownLatchæ¥å°è£…çš„ï¼Œå’±å½“æ—¶ä¹Ÿæ²¡ç”¨è¿‡CountDownLatchï¼Œæ„Ÿè§‰åº”è¯¥æŒºéš¾ï¼Œå°±ç›´æ¥ç”¨äº†é‚£ä¸ªå·¥å…·ã€‚</p><p>åæ¥å‘ç°é‚£ä¸ªå·¥å…·ä½¿ç”¨èµ·æ¥æœ‰äº›ç¹çï¼Œå°±æ¯”å¦‚æˆ‘åˆ·æ•°æ®è¿™ä¸ªäº‹ï¼ŒCountDownLatchç›´æ¥å¹²æ˜¯æœ€ç®€å•çš„ã€‚</p><h2 id="CountDownLatchæ˜¯ä»€ä¹ˆ"><a href="#CountDownLatchæ˜¯ä»€ä¹ˆ" class="headerlink" title="CountDownLatchæ˜¯ä»€ä¹ˆ"></a>CountDownLatchæ˜¯ä»€ä¹ˆ</h2><p>A synchronization aid that allows one or more threads to wait until a set of operations being performed in other threads completes.</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210804172448596.png" alt="image-20210804172448596" style="zoom:50%;" /><p>æŒ‰ç…§å®˜æ–¹APIæ–‡æ¡£ä¸Šçš„ä»‹ç»å‘¢ï¼ŒCountDownLatchå°±æ˜¯ä¸€ä¸ªåŒæ­¥æœºåˆ¶ï¼Œç”¨æ¥å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸€ç›´waitçŸ¥é“å¦ä¸€ä¸ªçº¿ç¨‹å®Œæˆä¸€ç³»åˆ—åŠ¨ä½œã€‚</p><h2 id="CountDownLatchä½¿ç”¨"><a href="#CountDownLatchä½¿ç”¨" class="headerlink" title="CountDownLatchä½¿ç”¨"></a>CountDownLatchä½¿ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                latch.countDown();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; execute 111&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; execute 222&quot;</span>);</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;main thread invoke await&quot;</span>);</span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(<span class="string">&quot;subThread execute end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">main thread invoke await</span><br><span class="line">Thread-0 execute 111</span><br><span class="line">Thread-1 execute 222</span><br><span class="line">subThread execute end</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å°±ä»countDownå’Œawaitä¸¤ä¸ªæ–¹æ³•è§£æCountDownLatchçš„è¿è¡Œæœºåˆ¶å§</p><h2 id="CountDownLatchå®ç°åŸç†"><a href="#CountDownLatchå®ç°åŸç†" class="headerlink" title="CountDownLatchå®ç°åŸç†"></a>CountDownLatchå®ç°åŸç†</h2><p>å’ŒReentrantLockå®ç°ç‹¬å é”ä¸åŒçš„æ˜¯ï¼ŒCountDownLatchæ˜¯å…¸å‹çš„å…±äº«é”ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒCountDownLatchçš„é™æ€å†…éƒ¨ç±»Syncç»§æ‰¿äº†AbstractQueuedSynchronizerå¹¶å®ç°äº†tryAcquireSharedæ–¹æ³•å’ŒtryReleaseSharedæ–¹æ³•ã€‚</p><p>ä¸‹é¢å…ˆä»æ„é€ æ–¹æ³•å…¥æ‰‹å¼€å§‹å­¦ä¹  ğŸ‘‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;count &lt; 0&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.sync = <span class="keyword">new</span> Sync(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–countå­—æ®µï¼Œå…¶å€¼æ˜¯è®¾ç½®åœ¨AQSçš„stateå­—æ®µä¸Šé¢çš„ï¼Œå½“æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œäº†countDown()ä¹‹åï¼Œ<code>state = state - 1</code></p><p>å½“state = 0 æ—¶ï¼Œå”¤é†’ä¹‹å‰awaitçš„çº¿ç¨‹ã€‚</p><h3 id="await"><a href="#await" class="headerlink" title="await()"></a>await()</h3><p><strong>ä¸‹é¢æ˜¯awaitæ–¹æ³•ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AQS#acquireSharedInterruptibly(int arg)</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">    <span class="comment">// è·å–ä¸­æ–­æ ‡å¿—ï¼ŒæŠŠä¸­æ–­æ ‡å¿—å¤ä½ï¼Œç„¶åæŠŠä¸­æ–­å¼‚å¸¸å¾€ä¸Šå±‚æŠ›</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">    doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tryAcquireShared(arg)è¿™ä¸ªæ–¹æ³•å’Œä¹‹å‰å­¦ä¹ ReentrantLockæ—¶æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ˜¯AQSæä¾›çš„æ¨¡ç‰ˆæ–¹æ³•ã€‚</p><p>AQSæä¾›æ¨¡ç‰ˆæ–¹æ³•ï¼Œæœ‰æ¯ä¸ªå­ç±»è‡ªå·±å»å®ç°é€»è¾‘ï¼Œç„¶åå†ç”±AQSæœ¬èº«è°ƒç”¨ã€‚</p><p><strong>CountDownLatch#tryAcquireShared(int acquires)</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getState()è¿”å›çš„æ˜¯AQSçš„stateå€¼ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è·å–æ˜¯è‚¯å®šä¸æ˜¯0</p><p>å¦‚æœgetState()æ–¹æ³•è¿”å›-1çš„è¯ï¼Œä¼šæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•ï¼š</p><p><strong>AQS#doAcquireSharedInterruptibly</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">  <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">      <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">        <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">        <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// è¡¨ç¤ºaqs state = 0</span></span><br><span class="line">          <span class="comment">// éœ€è¦æŠŠå½“å‰çº¿ç¨‹è®¾ç½®æˆå¤´èŠ‚ç‚¹ï¼Œå¹¶å‘ä¸‹ä¼ æ’­</span></span><br><span class="line">          setHeadAndPropagate(node, r);</span><br><span class="line">          p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">          failed = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// é¿å…ä¸€ç›´ç©ºè½¬ï¼Œå°†å‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€è®¾ç½®æˆSIGNAL,ç„¶åæŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">      <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">          parkAndCheckInterrupt())</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹ä¸­æ–­ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (failed)</span><br><span class="line">      cancelAcquire(node);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“countDownLatchçš„countå˜æˆ0çš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹awaitå®Œæˆï¼Œç„¶åè¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œã€‚</p><p><strong>setHeadAndPropagate(Node node, int propagate)</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHeadAndPropagate</span><span class="params">(Node node, <span class="keyword">int</span> propagate)</span> </span>&#123;</span><br><span class="line">  Node h = head; <span class="comment">// Record old head for check below</span></span><br><span class="line">  setHead(node);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Try to signal next queued node if:</span></span><br><span class="line"><span class="comment">     *   Propagation was indicated by caller,</span></span><br><span class="line"><span class="comment">     *     or was recorded (as h.waitStatus either before</span></span><br><span class="line"><span class="comment">     *     or after setHead) by a previous operation</span></span><br><span class="line"><span class="comment">     *     (note: this uses sign-check of waitStatus because</span></span><br><span class="line"><span class="comment">     *      PROPAGATE status may transition to SIGNAL.)</span></span><br><span class="line"><span class="comment">     * and</span></span><br><span class="line"><span class="comment">     *   The next node is waiting in shared mode,</span></span><br><span class="line"><span class="comment">     *     or we don&#x27;t know, because it appears null</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The conservatism in both of these checks may cause</span></span><br><span class="line"><span class="comment">     * unnecessary wake-ups, but only when there are multiple</span></span><br><span class="line"><span class="comment">     * racing acquires/releases, so most need signals now or soon</span></span><br><span class="line"><span class="comment">     * anyway.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">      (h = head) == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.isShared())</span><br><span class="line">      <span class="comment">// å¦‚æœåç»­èŠ‚ç‚¹æ˜¯shardèŠ‚ç‚¹ï¼Œé‡Šæ”¾</span></span><br><span class="line">      doReleaseShared();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="countDown"><a href="#countDown" class="headerlink" title="countDown()"></a>countDown()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AQS#releaseShared(int arg) é‡Šæ”¾å…±äº«é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æœ‰å­ç±»å®ç°</span></span><br><span class="line">  <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">    doReleaseShared();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CountDownLatch#tryReleaseShared(int releases)</strong></p><p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡countDown(), state = state - 1</p><p>æœ€åè¿”å›stateæ˜¯å¦ç­‰äº0 å¦‚æœä¸ç­‰äº0 è¯´æ˜å…±äº«é”ä¸èƒ½é‡Šæ”¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Decrement count; signal when transition to zero</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> nextc = c-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">      <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doReleaseShared() é‡Šæ”¾å…±äº«é”æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Ensure that a release propagates, even if there are other</span></span><br><span class="line"><span class="comment">         * in-progress acquires/releases.  This proceeds in the usual</span></span><br><span class="line"><span class="comment">         * way of trying to unparkSuccessor of head if it needs</span></span><br><span class="line"><span class="comment">         * signal. But if it does not, status is set to PROPAGATE to</span></span><br><span class="line"><span class="comment">         * ensure that upon release, propagation continues.</span></span><br><span class="line"><span class="comment">         * Additionally, we must loop in case a new node is added</span></span><br><span class="line"><span class="comment">         * while we are doing this. Also, unlike other uses of</span></span><br><span class="line"><span class="comment">         * unparkSuccessor, we need to know if CAS to reset status</span></span><br><span class="line"><span class="comment">         * fails, if so rechecking.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    Node h = head;</span><br><span class="line">    <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">      <span class="comment">// è·å–å¤´ç»“ç‚¹çš„ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">      <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">      <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">          <span class="keyword">continue</span>;            <span class="comment">// loop to recheck cases</span></span><br><span class="line">        <span class="comment">// é‡Šæ”¾åç»§ç»“ç‚¹</span></span><br><span class="line">        unparkSuccessor(h);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">               !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">        <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>unparkSuccessor()æ‰§è¡Œçº¿ç¨‹å”¤é†’çš„æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">  <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">    compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  Node s = node.next;</span><br><span class="line">  <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    s = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">      <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">        s = t;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">    LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a href="https://www.jianshu.com/p/128476015902">https://www.jianshu.com/p/128476015902</a></p><p><a href="https://segmentfault.com/a/1190000015807573">https://segmentfault.com/a/1190000015807573</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CountDownLatch&quot;&gt;&lt;a href=&quot;#CountDownLatch&quot; class=&quot;headerlink&quot; title=&quot;CountDownLatch&quot;&gt;&lt;/a&gt;CountDownLatch&lt;/h1&gt;&lt;p&gt;ä½ è¦é—®ä»€ä¹ˆæ˜¯CountDownLatch? </summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹ææ‡‚çº¿ç¨‹æ± </title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%90%9E%E6%87%82%E7%BA%BF%E7%A8%8B%E6%B1%A0-1/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%90%9E%E6%87%82%E7%BA%BF%E7%A8%8B%E6%B1%A0-1/</id>
    <published>2021-08-04T08:43:19.000Z</published>
    <updated>2021-08-04T08:45:12.386Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ThreadPool"><a href="#ThreadPool" class="headerlink" title="ThreadPool"></a>ThreadPool</h1><h2 id="1-ä¸ºä»€ä¹ˆå­˜åœ¨çº¿ç¨‹æ± "><a href="#1-ä¸ºä»€ä¹ˆå­˜åœ¨çº¿ç¨‹æ± " class="headerlink" title="1. ä¸ºä»€ä¹ˆå­˜åœ¨çº¿ç¨‹æ± "></a>1. ä¸ºä»€ä¹ˆå­˜åœ¨çº¿ç¨‹æ± </h2><h3 id="1-1-é™ä½èµ„æºæ¶ˆè€—"><a href="#1-1-é™ä½èµ„æºæ¶ˆè€—" class="headerlink" title="1.1 é™ä½èµ„æºæ¶ˆè€—"></a>1.1 <strong>é™ä½èµ„æºæ¶ˆè€—</strong></h3><p>é€šè¿‡å¤ç”¨å·²å­˜åœ¨çš„çº¿ç¨‹å’Œé™ä½çº¿ç¨‹å…³é—­çš„æ¬¡æ•°æ¥å°½å¯èƒ½é™ä½ç³»ç»Ÿæ€§èƒ½æŸè€—ï¼›ï¼ˆäº«å…ƒæ¨¡å¼ï¼‰</p><h3 id="1-2-æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦"><a href="#1-2-æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦" class="headerlink" title="1.2 æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦"></a>1.2 <strong>æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦</strong></h3><p>é€šè¿‡å¤ç”¨çº¿ç¨‹ï¼Œçœå»åˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œå› æ­¤æ•´ä½“ä¸Šæå‡äº†ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ï¼›</p><h3 id="1-3-æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§"><a href="#1-3-æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§" class="headerlink" title="1.3 æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§"></a>1.3 <strong>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§</strong></h3><p>çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œå› æ­¤ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹ã€‚</p><p>è‡³äºä¸ºä»€ä¹ˆä¸å…è®¸æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¯·å‚è§<a href="https://dayarch.top/p/why-we-need-to-use-threadpool.html">https://dayarch.top/p/why-we-need-to-use-threadpool.html</a></p><h2 id="2-çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹"><a href="#2-çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹" class="headerlink" title="2. çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹"></a>2. çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹</h2><p>çº¿ç¨‹æ± é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç”±å¾ˆå¤šçº¿ç¨‹æ„æˆçš„æ± å­ï¼Œæ¥ä¸€ä¸ªä»»åŠ¡ï¼Œå°±ä»æ± å­ä¸­å–ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†è¿™ä¸ªä»»åŠ¡ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç†è§£ï¼Œå®é™…ä¸Šçº¿ç¨‹æ± çš„å®ç°å’Œè¿è½¬æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„è¿‡ç¨‹ã€‚</p><p>ä¾‹å¦‚çº¿ç¨‹æ± è‚¯å®šä¸ä¼šæ— é™æ‰©å¤§çš„ï¼Œå¦åˆ™èµ„æºä¼šè€—å°½ï¼›å½“çº¿ç¨‹æ•°åˆ°è¾¾ä¸€ä¸ªé˜¶æ®µï¼Œæäº¤çš„ä»»åŠ¡ä¼šè¢«æš‚æ—¶å­˜å‚¨åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¦‚æœé˜Ÿåˆ—å†…å®¹å¯ä»¥ä¸æ–­æ‰©å¤§ï¼Œæç«¯ä¸‹ä¹Ÿä¼šè€—å°½èµ„æºï¼Œé‚£é€‰æ‹©ä»€ä¹ˆç±»å‹çš„é˜Ÿåˆ—ï¼Œå½“é˜Ÿåˆ—æ»¡å¦‚ä½•å¤„ç†ä»»åŠ¡ï¼Œéƒ½æœ‰æ¶‰åŠå¾ˆå¤šå†…å®¹ã€‚çº¿ç¨‹æ± æ€»ä½“çš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210804144852252.png" alt="image-20210804144852252" style="zoom: 50%;" /><p>çº¿ç¨‹æ± å†…çš„çº¿ç¨‹æ•°çš„å¤§å°ç›¸å…³çš„æ¦‚å¿µæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æ ¸å¿ƒæ± å¤§å°ï¼Œè¿˜æœ‰æœ€å¤§æ± å¤§å°ã€‚å¦‚æœå½“å‰çš„çº¿ç¨‹ä¸ªæ•°æ¯”æ ¸å¿ƒæ± ä¸ªæ•°å°ï¼Œå½“ä»»åŠ¡åˆ°æ¥ï¼Œä¼šä¼˜å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å¹¶æ‰§è¡Œä»»åŠ¡ã€‚å½“å·²ç»åˆ°è¾¾æ ¸å¿ƒæ± å¤§å°ï¼Œåˆ™æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œä¸ºäº†èµ„æºä¸è¢«è€—å°½ï¼Œé˜Ÿåˆ—çš„æœ€å¤§å®¹é‡å¯èƒ½ä¹Ÿæ˜¯æœ‰ä¸Šé™çš„ï¼Œå¦‚æœè¾¾åˆ°é˜Ÿåˆ—ä¸Šé™åˆ™è€ƒè™‘ç»§ç»­åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœæ­¤åˆ»çº¿ç¨‹çš„ä¸ªæ•°å·²ç»åˆ°è¾¾æœ€å¤§æ± ä¸Šé™ï¼Œåˆ™è€ƒè™‘æŠŠä»»åŠ¡ä¸¢å¼ƒã€‚</p><p>åœ¨ java.util.concurrent åŒ…ä¸­ï¼Œæä¾›äº† ThreadPoolExecutor çš„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="params"><span class="function">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="params"><span class="function">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">                              RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h2 id="3-çº¿ç¨‹æ± å‚æ•°"><a href="#3-çº¿ç¨‹æ± å‚æ•°" class="headerlink" title="3. çº¿ç¨‹æ± å‚æ•°"></a>3. çº¿ç¨‹æ± å‚æ•°</h2><p>æ—¢ç„¶æœ‰äº†åˆšåˆšå¯¹çº¿ç¨‹æ± å·¥ä½œåŸç†å¯¹æ¦‚è¿°ï¼Œè¿™äº›å‚æ•°å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼š</p><h3 id="3-1-corePoolSize"><a href="#3-1-corePoolSize" class="headerlink" title="3.1 corePoolSize"></a>3.1 corePoolSize</h3><p> æ ¸å¿ƒæ± å¤§å°ï¼Œæ—¢ç„¶å¦‚å‰åŸç†éƒ¨åˆ†æ‰€è¿°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨åˆåˆ›å»ºçº¿ç¨‹æ± æ—¶çº¿ç¨‹ä¸ä¼šç«‹å³å¯åŠ¨ï¼Œç›´åˆ°æœ‰ä»»åŠ¡æäº¤æ‰å¼€å§‹å¯åŠ¨çº¿ç¨‹å¹¶é€æ¸æ—¶çº¿ç¨‹æ•°ç›®è¾¾åˆ°corePoolSizeã€‚è‹¥æƒ³ä¸€å¼€å§‹å°±åˆ›å»ºæ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹éœ€è°ƒç”¨prestartAllCoreThreadsæ–¹æ³•ã€‚</p><h3 id="3-2-maximumPoolSize"><a href="#3-2-maximumPoolSize" class="headerlink" title="3.2 maximumPoolSize"></a>3.2 maximumPoolSize</h3><p>æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å½“æ ¸å¿ƒçº¿ç¨‹æ»¡ä¸”é˜»å¡é˜Ÿåˆ—ä¹Ÿæ»¡æ—¶æ‰ä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯å¦å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¹¶å†³å®šæ˜¯å¦åˆ›å»ºæ–°çº¿ç¨‹ã€‚</p><h3 id="3-3-keepAliveTime"><a href="#3-3-keepAliveTime" class="headerlink" title="3.3 keepAliveTime"></a>3.3 keepAliveTime</h3><p>å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ—¶ï¼Œå¤šäºçš„ç©ºé—²çº¿ç¨‹æœ€å¤šå­˜æ´»æ—¶é—´</p><h3 id="3-4-unit"><a href="#3-4-unit" class="headerlink" title="3.4 unit"></a>3.4 unit</h3><p>keepAliveTime å‚æ•°çš„æ—¶é—´å•ä½ã€‚</p><h3 id="3-5-workQueue"><a href="#3-5-workQueue" class="headerlink" title="3.5 workQueue"></a>3.5 workQueue</h3><p>å½“çº¿ç¨‹æ•°ç›®è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ç”¨äºä¿å­˜ä»»åŠ¡çš„é˜Ÿåˆ—ã€‚ä¸»è¦æœ‰3ç§ç±»å‹çš„BlockingQueueå¯ä¾›é€‰æ‹©ï¼šæ— ç•Œé˜Ÿåˆ—ï¼Œæœ‰ç•Œé˜Ÿåˆ—å’ŒåŒæ­¥ç§»äº¤ã€‚å°†åœ¨ä¸‹æ–‡ä¸­è¯¦ç»†é˜è¿°ã€‚ä»å‚æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ­¤é˜Ÿåˆ—ä»…ä¿å­˜å®ç°Runnableæ¥å£çš„ä»»åŠ¡ã€‚ åˆ«çœ‹è¿™ä¸ªå‚æ•°ä½ç½®å¾ˆé åï¼Œä½†æ˜¯çœŸçš„å¾ˆé‡è¦ï¼Œå› ä¸ºæ¥¼ä¸»çš„å‘å°±å› è¿™ä¸ªå‚æ•°è€Œèµ·ï¼Œè¿™äº›ç»†èŠ‚æœ‰å¿…è¦ä»”ç»†äº†è§£æ¸…æ¥šã€‚</p><h3 id="3-6-threadFactory"><a href="#3-6-threadFactory" class="headerlink" title="3.6 threadFactory"></a>3.6 threadFactory</h3><p>æ‰§è¡Œç¨‹åºåˆ›å»ºæ–°çº¿ç¨‹æ—¶ä½¿ç”¨çš„å·¥å‚ã€‚</p><h3 id="3-7-handler"><a href="#3-7-handler" class="headerlink" title="3.7 handler"></a>3.7 handler</h3><p>é˜»å¡é˜Ÿåˆ—å·²æ»¡ä¸”çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼æ—¶æ‰€é‡‡å–çš„é¥±å’Œç­–ç•¥ã€‚javaé»˜è®¤æä¾›äº†4ç§é¥±å’Œç­–ç•¥çš„å®ç°æ–¹å¼ï¼šä¸­æ­¢ã€æŠ›å¼ƒã€æŠ›å¼ƒæœ€æ—§çš„ã€è°ƒç”¨è€…è¿è¡Œã€‚å°†åœ¨ä¸‹æ–‡ä¸­è¯¦ç»†é˜è¿°ã€‚</p><h2 id="4-å¯é€‰æ‹©çš„é˜»å¡é˜Ÿåˆ—BlockingQueueè¯¦è§£"><a href="#4-å¯é€‰æ‹©çš„é˜»å¡é˜Ÿåˆ—BlockingQueueè¯¦è§£" class="headerlink" title="4. å¯é€‰æ‹©çš„é˜»å¡é˜Ÿåˆ—BlockingQueueè¯¦è§£"></a>4. å¯é€‰æ‹©çš„é˜»å¡é˜Ÿåˆ—BlockingQueueè¯¦è§£</h2><p>å†é‡å¤ä¸€ä¸‹æ–°ä»»åŠ¡è¿›å…¥æ—¶çº¿ç¨‹æ± çš„æ‰§è¡Œç­–ç•¥ï¼š<br>1ã€å¦‚æœè¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™ Executorå§‹ç»ˆé¦–é€‰æ·»åŠ æ–°çš„çº¿ç¨‹ï¼Œè€Œä¸è¿›è¡Œæ’é˜Ÿã€‚ï¼ˆå¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹å°äºcorePoolSizeï¼Œåˆ™ä»»åŠ¡æ ¹æœ¬ä¸ä¼šå­˜å…¥queueä¸­ï¼Œè€Œæ˜¯ç›´æ¥è¿è¡Œï¼‰</p><p>2ã€å¦‚æœè¿è¡Œçš„çº¿ç¨‹å¤§äºç­‰äº corePoolSizeï¼Œåˆ™ Executorå§‹ç»ˆé¦–é€‰å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œè€Œä¸æ·»åŠ æ–°çš„çº¿ç¨‹ã€‚<br>å¦‚æœæ— æ³•å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œé™¤éåˆ›å»ºæ­¤çº¿ç¨‹è¶…å‡º maximumPoolSizeï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†è¢«æ‹’ç»ã€‚<br>ä¸»è¦æœ‰3ç§ç±»å‹çš„BlockingQueueï¼š</p><h3 id="4-1-æ— ç•Œé˜Ÿåˆ—"><a href="#4-1-æ— ç•Œé˜Ÿåˆ—" class="headerlink" title="4.1 æ— ç•Œé˜Ÿåˆ—"></a>4.1 æ— ç•Œé˜Ÿåˆ—</h3><p>é˜Ÿåˆ—å¤§å°æ— é™åˆ¶ï¼Œå¸¸ç”¨çš„ä¸ºæ— ç•Œçš„LinkedBlockingQueueï¼Œä½¿ç”¨è¯¥é˜Ÿåˆ—åšä¸ºé˜»å¡é˜Ÿåˆ—æ—¶è¦å°¤å…¶å½“å¿ƒï¼Œå½“ä»»åŠ¡è€—æ—¶è¾ƒé•¿æ—¶å¯èƒ½ä¼šå¯¼è‡´å¤§é‡æ–°ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­å †ç§¯æœ€ç»ˆå¯¼è‡´OOMã€‚é˜…è¯»ä»£ç å‘ç°ï¼ŒExecutors.newFixedThreadPool é‡‡ç”¨å°±æ˜¯ LinkedBlockingQueueï¼Œè€Œæ¥¼ä¸»è¸©åˆ°çš„å°±æ˜¯è¿™ä¸ªå‘ï¼Œå½“QPSå¾ˆé«˜ï¼Œå‘é€æ•°æ®å¾ˆå¤§ï¼Œå¤§é‡çš„ä»»åŠ¡è¢«æ·»åŠ åˆ°è¿™ä¸ªæ— ç•ŒLinkedBlockingQueue ä¸­ï¼Œå¯¼è‡´cpuå’Œå†…å­˜é£™å‡æœåŠ¡å™¨æŒ‚æ‰ã€‚</p><h3 id="4-2-æœ‰ç•Œé˜Ÿåˆ—"><a href="#4-2-æœ‰ç•Œé˜Ÿåˆ—" class="headerlink" title="4.2 æœ‰ç•Œé˜Ÿåˆ—"></a>4.2 æœ‰ç•Œé˜Ÿåˆ—</h3><p>å¸¸ç”¨çš„æœ‰ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯éµå¾ªFIFOåŸåˆ™çš„é˜Ÿåˆ—å¦‚ArrayBlockingQueueä¸æœ‰ç•Œçš„LinkedBlockingQueueï¼Œå¦ä¸€ç±»æ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ—å¦‚PriorityBlockingQueueã€‚PriorityBlockingQueueä¸­çš„ä¼˜å…ˆçº§ç”±ä»»åŠ¡çš„Comparatorå†³å®šã€‚<br>ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—æ—¶é˜Ÿåˆ—å¤§å°éœ€å’Œçº¿ç¨‹æ± å¤§å°äº’ç›¸é…åˆï¼Œçº¿ç¨‹æ± è¾ƒå°æœ‰ç•Œé˜Ÿåˆ—è¾ƒå¤§æ—¶å¯å‡å°‘å†…å­˜æ¶ˆè€—ï¼Œé™ä½cpuä½¿ç”¨ç‡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯å¯èƒ½ä¼šé™åˆ¶ç³»ç»Ÿååé‡ã€‚</p><p>åœ¨æˆ‘ä»¬çš„ä¿®å¤æ–¹æ¡ˆä¸­ï¼Œé€‰æ‹©çš„å°±æ˜¯è¿™ä¸ªç±»å‹çš„é˜Ÿåˆ—ï¼Œè™½ç„¶ä¼šæœ‰éƒ¨åˆ†ä»»åŠ¡è¢«ä¸¢å¤±ï¼Œä½†æ˜¯æˆ‘ä»¬çº¿ä¸Šæ˜¯æ’åºæ—¥å¿—æœé›†ä»»åŠ¡ï¼Œæ‰€ä»¥å¯¹éƒ¨åˆ†å¯¹ä¸¢å¤±æ˜¯å¯ä»¥å®¹å¿çš„ã€‚</p><h3 id="4-3-åŒæ­¥ç§»äº¤é˜Ÿåˆ—"><a href="#4-3-åŒæ­¥ç§»äº¤é˜Ÿåˆ—" class="headerlink" title="4.3 åŒæ­¥ç§»äº¤é˜Ÿåˆ—"></a>4.3 åŒæ­¥ç§»äº¤é˜Ÿåˆ—</h3><p>å¦‚æœä¸å¸Œæœ›ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è€Œæ˜¯å¸Œæœ›å°†ä»»åŠ¡ç›´æ¥ç§»äº¤ç»™å·¥ä½œçº¿ç¨‹ï¼Œå¯ä½¿ç”¨SynchronousQueueä½œä¸ºç­‰å¾…é˜Ÿåˆ—ã€‚SynchronousQueueä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯ä¸€ç§çº¿ç¨‹ä¹‹é—´ç§»äº¤çš„æœºåˆ¶ã€‚è¦å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥SynchronousQueueä¸­ï¼Œå¿…é¡»æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¥æ”¶è¿™ä¸ªå…ƒç´ ã€‚åªæœ‰åœ¨ä½¿ç”¨æ— ç•Œçº¿ç¨‹æ± æˆ–è€…æœ‰é¥±å’Œç­–ç•¥æ—¶æ‰å»ºè®®ä½¿ç”¨è¯¥é˜Ÿåˆ—ã€‚</p><h2 id="5-å¯é€‰æ‹©çš„é¥±å’Œç­–ç•¥RejectedExecutionHandlerè¯¦è§£"><a href="#5-å¯é€‰æ‹©çš„é¥±å’Œç­–ç•¥RejectedExecutionHandlerè¯¦è§£" class="headerlink" title="5. å¯é€‰æ‹©çš„é¥±å’Œç­–ç•¥RejectedExecutionHandlerè¯¦è§£"></a>5. å¯é€‰æ‹©çš„é¥±å’Œç­–ç•¥RejectedExecutionHandlerè¯¦è§£</h2><p>JDKä¸»è¦æä¾›äº†4ç§é¥±å’Œç­–ç•¥ä¾›é€‰æ‹©ã€‚4ç§ç­–ç•¥éƒ½åšä¸ºé™æ€å†…éƒ¨ç±»åœ¨ThreadPoolExcutorä¸­è¿›è¡Œå®ç°ã€‚</p><h3 id="5-1-AbortPolicyä¸­æ­¢ç­–ç•¥"><a href="#5-1-AbortPolicyä¸­æ­¢ç­–ç•¥" class="headerlink" title="5.1 AbortPolicyä¸­æ­¢ç­–ç•¥"></a>5.1 AbortPolicyä¸­æ­¢ç­–ç•¥</h3><p>è¯¥ç­–ç•¥æ˜¯é»˜è®¤é¥±å’Œç­–ç•¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">&quot;Task &quot;</span> + r.toString() +</span><br><span class="line">                                                 <span class="string">&quot; rejected from &quot;</span> +</span><br><span class="line">                                                 e.toString());</span><br><span class="line"> &#125; </span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¯¥ç­–ç•¥æ—¶åœ¨é¥±å’Œæ—¶ä¼šæŠ›å‡ºRejectedExecutionExceptionï¼ˆç»§æ‰¿è‡ªRuntimeExceptionï¼‰ï¼Œè°ƒç”¨è€…å¯æ•è·è¯¥å¼‚å¸¸è‡ªè¡Œå¤„ç†ã€‚</p><h3 id="5-2-DiscardPolicyæŠ›å¼ƒç­–ç•¥"><a href="#5-2-DiscardPolicyæŠ›å¼ƒç­–ç•¥" class="headerlink" title="5.2 DiscardPolicyæŠ›å¼ƒç­–ç•¥"></a>5.2 DiscardPolicyæŠ›å¼ƒç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚</p><h3 id="5-3-DiscardOldestPolicyæŠ›å¼ƒæ—§ä»»åŠ¡ç­–ç•¥"><a href="#5-3-DiscardOldestPolicyæŠ›å¼ƒæ—§ä»»åŠ¡ç­–ç•¥" class="headerlink" title="5.3 DiscardOldestPolicyæŠ›å¼ƒæ—§ä»»åŠ¡ç­–ç•¥"></a>5.3 DiscardOldestPolicyæŠ›å¼ƒæ—§ä»»åŠ¡ç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">                e.getQueue().poll();</span><br><span class="line">                e.execute(r);</span><br><span class="line">            &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>å¦‚ä»£ç ï¼Œå…ˆå°†é˜»å¡é˜Ÿåˆ—ä¸­çš„å¤´å…ƒç´ å‡ºé˜ŸæŠ›å¼ƒï¼Œå†å°è¯•æäº¤ä»»åŠ¡ã€‚å¦‚æœæ­¤æ—¶é˜»å¡é˜Ÿåˆ—ä½¿ç”¨PriorityBlockingQueueä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå°†ä¼šå¯¼è‡´ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡è¢«æŠ›å¼ƒï¼Œå› æ­¤ä¸å»ºè®®å°†è¯¥ç§ç­–ç•¥é…åˆä¼˜å…ˆçº§é˜Ÿåˆ—ä½¿ç”¨ã€‚</p><h3 id="5-4-CallerRunsPolicyè°ƒç”¨è€…è¿è¡Œ"><a href="#5-4-CallerRunsPolicyè°ƒç”¨è€…è¿è¡Œ" class="headerlink" title="5.4 CallerRunsPolicyè°ƒç”¨è€…è¿è¡Œ"></a>5.4 CallerRunsPolicyè°ƒç”¨è€…è¿è¡Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">            &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>æ—¢ä¸æŠ›å¼ƒä»»åŠ¡ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ï¼Œç›´æ¥è¿è¡Œä»»åŠ¡çš„runæ–¹æ³•ï¼Œæ¢è¨€ä¹‹å°†ä»»åŠ¡å›é€€ç»™è°ƒç”¨è€…æ¥ç›´æ¥è¿è¡Œã€‚ä½¿ç”¨è¯¥ç­–ç•¥æ—¶çº¿ç¨‹æ± é¥±å’Œåå°†ç”±è°ƒç”¨çº¿ç¨‹æ± çš„ä¸»çº¿ç¨‹è‡ªå·±æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå› æ­¤åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿™æ®µæ—¶é—´é‡Œä¸»çº¿ç¨‹æ— æ³•å†æäº¤æ–°ä»»åŠ¡ï¼Œä»è€Œä½¿çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹æœ‰æ—¶é—´å°†æ­£åœ¨å¤„ç†çš„ä»»åŠ¡å¤„ç†å®Œæˆã€‚</p><h2 id="6-Javaæä¾›çš„å››ç§å¸¸ç”¨çº¿ç¨‹æ± è§£æ"><a href="#6-Javaæä¾›çš„å››ç§å¸¸ç”¨çº¿ç¨‹æ± è§£æ" class="headerlink" title="6. Javaæä¾›çš„å››ç§å¸¸ç”¨çº¿ç¨‹æ± è§£æ"></a>6. Javaæä¾›çš„å››ç§å¸¸ç”¨çº¿ç¨‹æ± è§£æ</h2><p>æ—¢ç„¶æ¥¼ä¸»è¸©å‘å°±æ˜¯ä½¿ç”¨äº† JDK çš„é»˜è®¤å®ç°ï¼Œé‚£ä¹ˆå†æ¥çœ‹çœ‹è¿™äº›é»˜è®¤å®ç°åˆ°åº•å¹²äº†ä»€ä¹ˆï¼Œå°è£…äº†å“ªäº›å‚æ•°ã€‚ç®€è€Œè¨€ä¹‹ Executors å·¥å‚æ–¹æ³•Executors.newCachedThreadPool() æä¾›äº†æ— ç•Œçº¿ç¨‹æ± ï¼Œå¯ä»¥è¿›è¡Œè‡ªåŠ¨çº¿ç¨‹å›æ”¶ï¼›Executors.newFixedThreadPool(int) æä¾›äº†å›ºå®šå¤§å°çº¿ç¨‹æ± ï¼Œå†…éƒ¨ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ï¼›Executors.newSingleThreadExecutor() æä¾›äº†å•ä¸ªåå°çº¿ç¨‹ã€‚</p><p>è¯¦ç»†ä»‹ç»ä¸€ä¸‹ä¸Šè¿°å››ç§çº¿ç¨‹æ± ã€‚</p><h3 id="6-1-newCachedThreadPool"><a href="#6-1-newCachedThreadPool" class="headerlink" title="6.1 newCachedThreadPool"></a>6.1 newCachedThreadPool</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                      <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>åœ¨newCachedThreadPoolä¸­å¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œè‹¥æ— å¯å›æ”¶ï¼Œåˆ™æ–°å»ºçº¿ç¨‹ã€‚<br>åˆçœ‹è¯¥æ„é€ å‡½æ•°æ—¶æˆ‘æœ‰è¿™æ ·çš„ç–‘æƒ‘ï¼šæ ¸å¿ƒçº¿ç¨‹æ± ä¸º0ï¼Œé‚£æŒ‰ç…§å‰é¢æ‰€è®²çš„çº¿ç¨‹æ± ç­–ç•¥æ–°ä»»åŠ¡æ¥ä¸´æ—¶æ— æ³•è¿›å…¥æ ¸å¿ƒçº¿ç¨‹æ± ï¼Œåªèƒ½è¿›å…¥ SynchronousQueueä¸­è¿›è¡Œç­‰å¾…ï¼Œè€ŒSynchronousQueueçš„å¤§å°ä¸º1ï¼Œé‚£å²‚ä¸æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡åˆ°è¾¾æ—¶åªèƒ½ç­‰å¾…åœ¨é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°ç¬¬äºŒä¸ªä»»åŠ¡åˆ°è¾¾å‘ç°æ— æ³•è¿›å…¥é˜Ÿåˆ—æ‰èƒ½åˆ›å»ºç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Ÿ<br>è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆåœ¨ä¸Šé¢è®²SynchronousQueueæ—¶å…¶å®å·²ç»ç»™å‡ºäº†ï¼Œè¦å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥SynchronousQueueä¸­ï¼Œå¿…é¡»æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¥æ”¶è¿™ä¸ªå…ƒç´ ã€‚å› æ­¤å³ä¾¿SynchronousQueueä¸€å¼€å§‹ä¸ºç©ºä¸”å¤§å°ä¸º1ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡ä¹Ÿæ— æ³•æ”¾å…¥å…¶ä¸­ï¼Œå› ä¸ºæ²¡æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ä»SynchronousQueueä¸­å–èµ°å…ƒç´ ã€‚å› æ­¤ç¬¬ä¸€ä¸ªä»»åŠ¡åˆ°è¾¾æ—¶ä¾¿ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚</p><h3 id="6-2-newFixedThreadPool"><a href="#6-2-newFixedThreadPool" class="headerlink" title="6.2 newFixedThreadPool"></a>6.2 newFixedThreadPool</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                     <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                     <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä»£ç ä¸€ç›®äº†ç„¶äº†ï¼Œçº¿ç¨‹æ•°é‡å›ºå®šï¼Œä½¿ç”¨æ— é™å¤§çš„é˜Ÿåˆ—ã€‚</p><h3 id="6-3-newScheduledThreadPool"><a href="#6-3-newScheduledThreadPool" class="headerlink" title="6.3 newScheduledThreadPool"></a>6.3 newScheduledThreadPool</h3><p>åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ¥çœ‹çœ‹ScheduledThreadPoolExecutorï¼ˆï¼‰çš„æ„é€ å‡½æ•°</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScheduledThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">             <span class="keyword">new</span> DelayedWorkQueue());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>ScheduledThreadPoolExecutorçš„çˆ¶ç±»å³ThreadPoolExecutorï¼Œå› æ­¤è¿™é‡Œå„å‚æ•°å«ä¹‰å’Œä¸Šé¢ä¸€æ ·ã€‚å€¼å¾—å…³å¿ƒçš„æ˜¯DelayedWorkQueueè¿™ä¸ªé˜»å¡å¯¹åˆ—ï¼Œåœ¨ä¸Šé¢æ²¡æœ‰ä»‹ç»ï¼Œå®ƒä½œä¸ºé™æ€å†…éƒ¨ç±»å°±åœ¨ScheduledThreadPoolExecutorä¸­è¿›è¡Œäº†å®ç°ã€‚ç®€å•çš„è¯´ï¼ŒDelayedWorkQueueæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼Œå®ƒèƒ½æŒ‰ä¸€å®šçš„é¡ºåºå¯¹å·¥ä½œé˜Ÿåˆ—ä¸­çš„å…ƒç´ è¿›è¡Œæ’åˆ—ã€‚</p><h3 id="6-4-newSingleThreadExecutor"><a href="#6-4-newSingleThreadExecutor" class="headerlink" title="6.4 newSingleThreadExecutor"></a>6.4 newSingleThreadExecutor</h3><p>åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåº(FIFO, LIFO, ä¼˜å…ˆçº§)æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newSingleThreadScheduledExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DelegatedScheduledExecutorService</span><br><span class="line">            (<span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">1</span>));</span><br><span class="line"> &#125; </span><br></pre></td></tr></table></figure><p>é¦–å…ˆnewäº†ä¸€ä¸ªçº¿ç¨‹æ•°ç›®ä¸º 1 çš„ScheduledThreadPoolExecutorï¼Œå†æŠŠè¯¥å¯¹è±¡ä¼ å…¥DelegatedScheduledExecutorServiceä¸­ï¼Œçœ‹çœ‹DelegatedScheduledExecutorServiceçš„å®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DelegatedScheduledExecutorService(ScheduledExecutorService executor) &#123;</span><br><span class="line">            <span class="keyword">super</span>(executor);</span><br><span class="line">            e = executor;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>åœ¨çœ‹çœ‹å®ƒçš„çˆ¶ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DelegatedExecutorService(ExecutorService executor) &#123; </span><br><span class="line">           e = executor; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯ä½¿ç”¨è£…é¥°æ¨¡å¼å¢å¼ºäº†ScheduledExecutorServiceï¼ˆ1ï¼‰çš„åŠŸèƒ½ï¼Œä¸ä»…ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œä¹Ÿä¿è¯çº¿ç¨‹æ„å¤–ç»ˆæ­¢åä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚</p><h2 id="7-ä¸ºä»€ä¹ˆç¦æ­¢ä½¿ç”¨-Executors-åˆ›å»ºçº¿ç¨‹æ± "><a href="#7-ä¸ºä»€ä¹ˆç¦æ­¢ä½¿ç”¨-Executors-åˆ›å»ºçº¿ç¨‹æ± " class="headerlink" title="7. ä¸ºä»€ä¹ˆç¦æ­¢ä½¿ç”¨ Executors åˆ›å»ºçº¿ç¨‹æ± ?"></a>7. ä¸ºä»€ä¹ˆç¦æ­¢ä½¿ç”¨ Executors åˆ›å»ºçº¿ç¨‹æ± ?</h2><img src='https://oscimg.oschina.net/oscnet/up-9d0200e116259f64c5485a1bbf0d4265c31.png'><h3 id="7-1-å®éªŒè¯æ˜Executorsç¼ºé™·"><a href="#7-1-å®éªŒè¯æ˜Executorsç¼ºé™·" class="headerlink" title="7.1 å®éªŒè¯æ˜Executorsç¼ºé™·"></a>7.1 å®éªŒè¯æ˜Executorsç¼ºé™·</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorsDemo</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> ExecutorService executor = Executors.newFixedThreadPool(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Integer.MAX_VALUE; i++) &#123;</span><br><span class="line">               executor.execute(<span class="keyword">new</span> SubThread());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">       <span class="comment">//do nothing &#125;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æŒ‡å®šJVMå‚æ•°:-Xmx8m -Xms8mè¿è¡Œä»¥ä¸Šä»£ç ï¼Œä¼šæŠ›å‡ºOOM:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.OutOfMemoryError: GC overhead limit exceeded</span><br><span class="line">at java.util.concurrent.LinkedBlockingQueue.offer(LinkedBlockingQueue. java:<span class="number">416</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor. java:<span class="number">1371</span>)</span><br><span class="line">at com.hollis.ExecutorsDemo.main(ExecutorsDemo.java:<span class="number">16</span>)</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç æŒ‡å‡ºï¼ŒExecutorsDemo.java çš„ç¬¬ 16 è¡Œï¼Œå°±æ˜¯ä»£ç ä¸­çš„ execu- tor.execute(new SubThread());ã€‚</p><h3 id="7-2-Executors-ä¸ºä»€ä¹ˆå­˜åœ¨ç¼ºé™·"><a href="#7-2-Executors-ä¸ºä»€ä¹ˆå­˜åœ¨ç¼ºé™·" class="headerlink" title="7.2 Executors ä¸ºä»€ä¹ˆå­˜åœ¨ç¼ºé™·"></a>7.2 Executors ä¸ºä»€ä¹ˆå­˜åœ¨ç¼ºé™·</h3><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬çŸ¥é“äº† Executors åˆ›å»ºçš„çº¿ç¨‹æ± å­˜åœ¨ OOM çš„é£é™©ï¼Œé‚£ ä¹ˆåˆ°åº•æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„å‘¢?æˆ‘ä»¬éœ€è¦æ·±å…¥ Executors çš„æºç æ¥åˆ†æä¸€ä¸‹ã€‚</p><p>å…¶å®ï¼Œåœ¨ä¸Šé¢çš„æŠ¥é”™ä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥çœ‹å‡ºè››ä¸é©¬è¿¹çš„ï¼Œåœ¨ä»¥ä¸Šçš„ä»£ç ä¸­å…¶å® å·²ç»è¯´äº†ï¼ŒçœŸæ­£çš„å¯¼è‡´ OOM çš„å…¶å®æ˜¯ LinkedBlockingQueue.offer æ–¹æ³•ã€‚</p><p>å¦‚æœè¯»è€…ç¿»çœ‹ä»£ç çš„è¯ï¼Œä¹Ÿå¯ä»¥å‘ç°ï¼Œå…¶å®åº•å±‚ç¡®å®æ˜¯é€šè¿‡ LinkedBlock- ingQueue å®ç°çš„:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">        <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br></pre></td></tr></table></figure><p>å¦‚æœè¯»è€…å¯¹ Java ä¸­çš„é˜»å¡é˜Ÿåˆ—æœ‰æ‰€äº†è§£çš„è¯ï¼Œçœ‹åˆ°è¿™é‡Œæˆ–è®¸å°±èƒ½å¤Ÿæ˜ç™½åŸå› äº†ã€‚</p><p>Java ä¸­ çš„ BlockingQueue ä¸» è¦ æœ‰ ä¸¤ ç§ å® ç°ï¼Œ åˆ† åˆ« æ˜¯ ArrayBlockingQ- ueue å’Œ LinkedBlockingQueueã€‚</p><ul><li>ArrayBlockingQueue æ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œå¿…é¡»è®¾ç½®å®¹é‡ã€‚</li><li>LinkedBlockingQueue æ˜¯ä¸€ä¸ªç”¨é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œå®¹é‡å¯ä»¥é€‰æ‹© è¿›è¡Œè®¾ç½®ï¼Œä¸è®¾ç½®çš„è¯ï¼Œå°†æ˜¯ä¸€ä¸ªæ— è¾¹ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œæœ€å¤§é•¿åº¦ä¸º Integer.MAX_ VALUEã€‚  </li></ul><p>è¿™é‡Œçš„é—®é¢˜å°±å‡ºåœ¨:ä¸è®¾ç½®çš„è¯ï¼Œå°†æ˜¯ä¸€ä¸ªæ— è¾¹ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œæœ€å¤§é•¿åº¦ä¸ºInteger.MAX_VALUEã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸è®¾ç½® LinkedBlockingQueue çš„ å®¹é‡çš„è¯ï¼Œå…¶é»˜è®¤å®¹é‡å°†ä¼šæ˜¯ Integer.MAX_VALUEã€‚</p><p>è€Œ newFixedThreadPool ä¸­åˆ›å»º LinkedBlockingQueue æ—¶ï¼Œå¹¶æœªæŒ‡å®šå®¹ é‡ã€‚æ­¤æ—¶ï¼ŒLinkedBlockingQueue å°±æ˜¯ä¸€ä¸ªæ— è¾¹ç•Œé˜Ÿåˆ—ï¼Œå¯¹äºä¸€ä¸ªæ— è¾¹ç•Œé˜Ÿåˆ— æ¥è¯´ï¼Œæ˜¯å¯ä»¥ä¸æ–­çš„å‘é˜Ÿåˆ—ä¸­åŠ å…¥ä»»åŠ¡çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å°±æœ‰å¯èƒ½å› ä¸ºä»»åŠ¡è¿‡å¤šè€Œå¯¼ è‡´å†…å­˜æº¢å‡ºé—®é¢˜ã€‚</p><p>ä¸Šé¢æåˆ°çš„é—®é¢˜ä¸»è¦ä½“ç°åœ¨newFixedThreadPool å’Œ newSingleThreadExecutor ä¸¤ä¸ªå·¥å‚æ–¹æ³•ä¸Šï¼Œå¹¶ä¸æ˜¯è¯´ newCachedThreadPool å’Œ newScheduledThreadPool è¿™ä¸¤ä¸ªæ–¹æ³•å°±å®‰å…¨äº†ï¼Œè¿™ä¸¤ç§æ–¹å¼åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°å¯èƒ½æ˜¯ Integer.MAX_VALUEï¼Œè€Œåˆ›å»ºè¿™ä¹ˆå¤šçº¿ç¨‹ï¼Œå¿…ç„¶å°±æœ‰å¯èƒ½å¯¼è‡´ OOMã€‚</p><h3 id="7-3-åˆ›å»ºçº¿ç¨‹æ± çš„æ­£ç¡®å§¿åŠ¿"><a href="#7-3-åˆ›å»ºçº¿ç¨‹æ± çš„æ­£ç¡®å§¿åŠ¿" class="headerlink" title="7.3 åˆ›å»ºçº¿ç¨‹æ± çš„æ­£ç¡®å§¿åŠ¿"></a>7.3 åˆ›å»ºçº¿ç¨‹æ± çš„æ­£ç¡®å§¿åŠ¿</h3><p>é¿å…ä½¿ç”¨ Executors åˆ›å»ºçº¿ç¨‹æ± ï¼Œä¸»è¦æ˜¯é¿å…ä½¿ç”¨å…¶ä¸­çš„é»˜è®¤å®ç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ å¯ä»¥è‡ªå·±ç›´æ¥è°ƒç”¨ ThreadPoolExecutor çš„æ„é€ å‡½æ•°æ¥è‡ªå·±åˆ›å»ºçº¿ç¨‹æ± ã€‚åœ¨åˆ›å»ºçš„ åŒæ—¶ï¼Œç»™ BlockQueue æŒ‡å®šå®¹é‡å°±å¯ä»¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ExecutorService executor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">10</span>, <span class="number">10</span>, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">        <span class="keyword">new</span> ArrayBlockingQueue(<span class="number">10</span>));</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€æ—¦æäº¤çš„çº¿ç¨‹æ•°è¶…è¿‡å½“å‰å¯ç”¨çº¿ç¨‹æ•°æ—¶ï¼Œå°±ä¼šæŠ›å‡º java.util. concurrent.RejectedExecutionExceptionï¼Œè¿™æ˜¯å› ä¸ºå½“å‰çº¿ç¨‹æ± ä½¿ç”¨çš„é˜Ÿåˆ— æ˜¯æœ‰è¾¹ç•Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å·²ç»æ»¡äº†ä¾¿æ— æ³•ç»§ç»­å¤„ç†æ–°çš„è¯·æ±‚ã€‚ä½†æ˜¯å¼‚å¸¸(Exception)æ€»æ¯” å‘ç”Ÿé”™è¯¯(Error)è¦å¥½ã€‚</p><p>é™¤äº†è‡ªå·±å®šä¹‰ ThreadPoolExecutor å¤–ã€‚è¿˜æœ‰å…¶ä»–æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™ç¬¬ä¸€æ—¶é—´ å°±åº”è¯¥æƒ³åˆ°å¼€æºç±»åº“ï¼Œå¦‚ apache å’Œ guava ç­‰ã€‚</p><p>ä½œè€…æ¨èä½¿ç”¨ guava æä¾›çš„ ThreadFactoryBuilder æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorsDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadFactory namedThreadFactory = <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">            .setNameFormat(<span class="string">&quot;demo-pool-%d&quot;</span>).build();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExecutorService pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>, <span class="number">200</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">1024</span>), namedThreadFactory, <span class="keyword">new</span></span><br><span class="line">            ThreadPoolExecutor. AbortPolicy());</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Integer.MAX_VALUE; i++) &#123; pool.execute(<span class="keyword">new</span> SubThread());</span><br><span class="line">        &#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°æ–¹å¼åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¸ä»…å¯ä»¥é¿å… OOM çš„é—®é¢˜ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹å ç§°ï¼Œæ›´åŠ æ–¹ä¾¿çš„å‡ºé”™çš„æ—¶å€™æº¯æºã€‚</p><h2 id="8ã€ThreadPoolExecutoræºç è§£æ"><a href="#8ã€ThreadPoolExecutoræºç è§£æ" class="headerlink" title="8ã€ThreadPoolExecutoræºç è§£æ"></a>8ã€ThreadPoolExecutoræºç è§£æ</h2><h3 id="8-1-ThreadPoolExecutorç±»é‡è¦å±æ€§"><a href="#8-1-ThreadPoolExecutorç±»é‡è¦å±æ€§" class="headerlink" title="8.1 ThreadPoolExecutorç±»é‡è¦å±æ€§"></a>8.1 ThreadPoolExecutorç±»é‡è¦å±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™ä¸ªå±æ€§æ˜¯ç”¨æ¥å­˜æ”¾ å½“å‰è¿è¡Œçš„workeræ•°é‡ä»¥åŠçº¿ç¨‹æ± çŠ¶æ€çš„</span></span><br><span class="line"><span class="comment">//intæ˜¯32ä½çš„ï¼Œè¿™é‡ŒæŠŠintçš„é«˜3ä½æ‹¿æ¥è®°å½•çº¿ç¨‹æ± çŠ¶æ€çš„æ ‡å¿—ä½,å29ä½æ‹¿æ¥è®°å½•å½“å‰è¿è¡Œworkerçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">//å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"><span class="comment">//workerçš„é›†åˆ,ç”¨setæ¥å­˜æ”¾</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;Worker&gt;();</span><br><span class="line"><span class="comment">//å†å²è¾¾åˆ°çš„workeræ•°æœ€å¤§å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> largestPoolSize;</span><br><span class="line"><span class="comment">//å½“é˜Ÿåˆ—æ»¡äº†å¹¶ä¸”workerçš„æ•°é‡è¾¾åˆ°maxSizeçš„æ—¶å€™,æ‰§è¡Œå…·ä½“çš„æ‹’ç»ç­–ç•¥</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line"><span class="comment">//è¶…å‡ºcoreSizeçš„workerçš„ç”Ÿå­˜æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> keepAliveTime;</span><br><span class="line"><span class="comment">//å¸¸é©»workerçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> corePoolSize;</span><br><span class="line"><span class="comment">//æœ€å¤§workerçš„æ•°é‡,ä¸€èˆ¬å½“workQueueæ»¡äº†æ‰ä¼šç”¨åˆ°è¿™ä¸ªå‚æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> maximumPoolSize;</span><br></pre></td></tr></table></figure><h3 id="8-2-ThreadPoolExecutorå®šä¹‰çš„å†…éƒ¨çŠ¶æ€"><a href="#8-2-ThreadPoolExecutorå®šä¹‰çš„å†…éƒ¨çŠ¶æ€" class="headerlink" title="8.2 ThreadPoolExecutorå®šä¹‰çš„å†…éƒ¨çŠ¶æ€"></a>8.2 ThreadPoolExecutorå®šä¹‰çš„å†…éƒ¨çŠ¶æ€</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// runState is stored in the high-order bits</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Packing and unpacking ctl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…¶ä¸­AtomicIntegerå˜é‡ctlçš„åŠŸèƒ½éå¸¸å¼ºå¤§: åˆ©ç”¨ä½29ä½è¡¨ç¤ºçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°ï¼Œé€šè¿‡é«˜3ä½è¡¨ç¤ºçº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€:</p><ul><li>RUNNING: -1 &lt;&lt; COUNT_BITSï¼Œå³é«˜3ä½ä¸º111ï¼Œè¯¥çŠ¶æ€çš„çº¿ç¨‹æ± ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œå¹¶å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›</li><li>SHUTDOWN:  0 &lt;&lt; COUNT_BITSï¼Œå³é«˜3ä½ä¸º000ï¼Œè¯¥çŠ¶æ€çš„çº¿ç¨‹æ± ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›</li><li>STOP :  1 &lt;&lt; COUNT_BITSï¼Œå³é«˜3ä½ä¸º001ï¼Œè¯¥çŠ¶æ€çš„çº¿ç¨‹ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè€Œä¸”ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼›</li><li>TIDYING :  2 &lt;&lt; COUNT_BITSï¼Œå³é«˜3ä½ä¸º010, æ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²ç»ç»ˆæ­¢ï¼›</li><li>TERMINATED:  3 &lt;&lt; COUNT_BITSï¼Œå³é«˜3ä½ä¸º011, terminated()æ–¹æ³•å·²ç»æ‰§è¡Œå®Œæˆ</li></ul><h3 id="8-3-executeæºç è§£æ"><a href="#8-3-executeæºç è§£æ" class="headerlink" title="8.3 executeæºç è§£æ"></a>8.3 executeæºç è§£æ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ ä»»åŠ¡é˜Ÿåˆ—å¹¶åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹ï¼Œç„¶ååœ¨æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// çº¿ç¨‹æ± æ˜¯è¿è¡ŒçŠ¶æ€å¹¶ä¸”ä»»åŠ¡æˆåŠŸæ·»åŠ åˆ°é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line"><span class="comment">// recheck and if necessary å›æ»šåˆ°å…¥é˜Ÿæ“ä½œå‰ï¼Œå³å€˜è‹¥çº¿ç¨‹æ± shutdownçŠ¶æ€ï¼Œå°±remove(command)</span></span><br><span class="line">        <span class="comment">//å¦‚æœçº¿ç¨‹æ± æ²¡æœ‰RUNNINGï¼ŒæˆåŠŸä»é˜»å¡é˜Ÿåˆ—ä¸­åˆ é™¤ä»»åŠ¡ï¼Œæ‰§è¡Œrejectæ–¹æ³•å¤„ç†ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ™®é€šçº¿ç¨‹è¿è¡Œä»»åŠ¡</span></span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// å¾€çº¿ç¨‹æ± ä¸­åˆ›å»ºæ–°çš„çº¿ç¨‹å¤±è´¥ï¼Œåˆ™rejectä»»åŠ¡</span></span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€è€ƒğŸ¤”</strong>      <strong>ä¸ºä»€ä¹ˆéœ€è¦double checkçº¿ç¨‹æ± çš„çŠ¶æ€?</strong></p><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€æ—¶åˆ»åœ¨å˜åŒ–ï¼Œè€Œctl.get()æ˜¯éåŸå­æ“ä½œï¼Œå¾ˆæœ‰å¯èƒ½åˆšè·å–äº†çº¿ç¨‹æ± çŠ¶æ€åçº¿ç¨‹æ± çŠ¶æ€å°±æ”¹å˜äº†ã€‚åˆ¤æ–­æ˜¯å¦å°†commandåŠ å…¥workqueæ˜¯çº¿ç¨‹æ± ä¹‹å‰çš„çŠ¶æ€ã€‚å€˜è‹¥æ²¡æœ‰double checkï¼Œä¸‡ä¸€çº¿ç¨‹æ± å¤„äºérunningçŠ¶æ€(åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¾ˆæœ‰å¯èƒ½å‘ç”Ÿ)ï¼Œé‚£ä¹ˆcommandæ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚</p><p><strong>addWorkeræ–¹æ³•</strong></p><p>å…ˆçœ‹çœ‹addWorkeræ–¹æ³•çš„æ³¨é‡Šï¼Œæ–¹ä¾¿æˆ‘ä»¬ç†è§£æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Checks <span class="keyword">if</span> a <span class="keyword">new</span> worker can be added with respect to current</span><br><span class="line">     * <span class="function">pool state and the given <span class="title">bound</span> <span class="params">(either core or maximum)</span>. If so,</span></span><br><span class="line"><span class="function">     * the worker count is adjusted accordingly, and, <span class="keyword">if</span> possible, a</span></span><br><span class="line"><span class="function">     * new worker is created and started, running firstTask as its</span></span><br><span class="line"><span class="function">     * first task. This method returns <span class="keyword">false</span> <span class="keyword">if</span> the pool is stopped or</span></span><br><span class="line"><span class="function">     * eligible to shut down. It also returns <span class="keyword">false</span> <span class="keyword">if</span> the thread</span></span><br><span class="line"><span class="function">     * factory fails to create a thread when asked.  If the thread</span></span><br><span class="line"><span class="function">     * creation fails, either due to the thread factory returning</span></span><br><span class="line"><span class="function">     * <span class="keyword">null</span>, or due to an <span class="title">exception</span> <span class="params">(typically OutOfMemoryError in</span></span></span><br><span class="line"><span class="params"><span class="function">     * Thread.start()</span>), we roll back cleanly.</span></span><br><span class="line"><span class="function">     *</span></span><br><span class="line"><span class="function">     </span></span><br><span class="line"><span class="function">     <span class="comment">// å¤§æ¦‚ç¿»è¯‘å¦‚ä¸‹ï¼š</span></span></span><br><span class="line"><span class="function">     <span class="comment">//1ã€é¦–å…ˆå…ˆæ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€å’Œçº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡ç•Œé™</span></span></span><br><span class="line"><span class="function"> <span class="comment">//2ã€å¦‚æœå¯ä»¥åˆ›å»ºçš„è¯ï¼Œéœ€è¦æ›´æ–°ä»»åŠ¡çš„æ•°é‡ï¼Œç„¶åè¿è¡Œä»»åŠ¡</span></span></span><br><span class="line"><span class="function"> <span class="comment">//3ã€æœ‰ä¸¤ç§æƒ…å†µè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›falseï¼Œçº¿ç¨‹æ± stopçŠ¶æ€æˆ–è€…shut downçŠ¶æ€ </span></span></span><br><span class="line"><span class="function"> <span class="comment">//è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯å…±åˆ›åˆ›å»ºçº¿ç¨‹å¤±è´¥</span></span></span><br><span class="line"><span class="function">     4ã€ä¸ç®¡æ˜¯å‘ç”Ÿä»€ä¹ˆå¼‚å¸¸ï¼Œä¾‹å¦‚çº¿ç¨‹å·¥å‚è¿”å›<span class="keyword">null</span>æˆ–è€…æ˜¯å‘ç”Ÿäº†OOM,ç›´æ¥å›æ»š</span></span><br><span class="line"><span class="function">     </span></span><br><span class="line"><span class="function">     * @param firstTask the task the new thread should run <span class="title">first</span> <span class="params">(or</span></span></span><br><span class="line"><span class="params"><span class="function">     * <span class="keyword">null</span> <span class="keyword">if</span> none)</span>. Workers are created with an initial first task</span></span><br><span class="line"><span class="function">     * <span class="params">(in method execute()</span>) to bypass queuing when there are fewer</span></span><br><span class="line"><span class="function">     * than corePoolSize <span class="title">threads</span> <span class="params">(in which <span class="keyword">case</span> we always start one)</span>,</span></span><br><span class="line"><span class="function">     * or when the queue is <span class="title">full</span> <span class="params">(in which <span class="keyword">case</span> we must bypass queue)</span>.</span></span><br><span class="line"><span class="function">     * Initially idle threads are usually created via</span></span><br><span class="line"><span class="function">     * prestartCoreThread or to replace other dying workers.</span></span><br><span class="line"><span class="function">     *</span></span><br><span class="line"><span class="function">     * @param core <span class="keyword">if</span> <span class="keyword">true</span> use corePoolSize as bound, <span class="keyword">else</span></span></span><br><span class="line"><span class="function">     * maximumPoolSize. <span class="params">(A <span class="keyword">boolean</span> indicator is used here rather than a</span></span></span><br><span class="line"><span class="params"><span class="function">     * value to ensure reads of fresh values after checking other pool</span></span></span><br><span class="line"><span class="params"><span class="function">     * state)</span>.</span></span><br><span class="line"><span class="function">     * @return <span class="keyword">true</span> <span class="keyword">if</span> successful</span></span><br></pre></td></tr></table></figure><p><strong>ä¸‹é¢æ˜¯æºç </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">            ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">               firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">          <span class="comment">// casä¿®æ”¹cçš„å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">    Worker w = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">        <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Recheck while holding lock.</span></span><br><span class="line">                <span class="comment">// Back out on ThreadFactory failure or if</span></span><br><span class="line">                <span class="comment">// shut down before lock acquired.</span></span><br><span class="line">                <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                  <span class="comment">// largestPoolSizeè®°å½•çš„æœ€å¤§workersé•¿åº¦</span></span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">               <span class="comment">// çº¿ç¨‹å¯åŠ¨ï¼Œæ‰§è¡Œä»»åŠ¡(Worker.thread(firstTask).start());</span></span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹startä¹‹åä¼šæ‰§è¡Œå¦‚ä¸‹runæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/** Delegates main run loop to outer runWorker  */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            runWorker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸‹é¢æ˜¯runWorkeræ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">        Thread wt = Thread.currentThread();</span><br><span class="line">        Runnable task = w.firstTask;</span><br><span class="line">        w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">        w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">        <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                w.lock();</span><br><span class="line">                <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">                <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">                <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">                <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">                <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                     (Thread.interrupted() &amp;&amp;</span><br><span class="line">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                    !wt.isInterrupted())</span><br><span class="line">                    wt.interrupt();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beforeExecute(wt, task);</span><br><span class="line">                    Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        task.run();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                        thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                        thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                        thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        afterExecute(task, thrown);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="keyword">null</span>;</span><br><span class="line">                    w.completedTasks++;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            processWorkerExit(w, completedAbruptly);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡getTaskæ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ç­‰å¾…çš„ä»»åŠ¡ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼ŒgetTaskæ–¹æ³•ä¼šè¢«é˜»å¡å¹¶æŒ‚èµ·ï¼Œä¸ä¼šå ç”¨cpuèµ„æºï¼›</strong></p><p><strong>getTask()æ–¹æ³•æºç å¦‚ä¸‹</strong></p><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹getTask()æ–¹æ³•ï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°keepAliveTimeçš„ä½¿ç”¨ï¼Œä»è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå…ˆåƒæ± æ˜¯æ€ä¹ˆè®©è¶…è¿‡corePoolSizeçš„é‚£éƒ¨åˆ†workeré”€æ¯çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">        <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runnable r = timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take();</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            timedOut = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            timedOut = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>allowCoreThreadTimeOutä¸ºfalseï¼Œçº¿ç¨‹å³ä½¿ç©ºé—²ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼›å€˜è‹¥ä¸ºtureï¼Œåœ¨keepAliveTimeå†…ä»ç©ºé—²åˆ™ä¼šè¢«é”€æ¯ã€‚</p><p>å¦‚æœçº¿ç¨‹å…è®¸ç©ºé—²ç­‰å¾…è€Œä¸è¢«é”€æ¯timed == falseï¼ŒworkQueue.takeä»»åŠ¡:</p><p>å¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ç­‰å¾…ï¼›å½“é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡åŠ å…¥æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œtakeæ–¹æ³•è¿”å›ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œï¼›</p><p>å¦‚æœçº¿ç¨‹ä¸å…è®¸æ— ä¼‘æ­¢ç©ºé—²timed == true, workQueue.pollä»»åŠ¡: </p><p>å¦‚æœåœ¨keepAliveTimeæ—¶é—´å†…ï¼Œé˜»å¡é˜Ÿåˆ—è¿˜æ˜¯æ²¡æœ‰ä»»åŠ¡ï¼Œåˆ™è¿”å›nullï¼›</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ThreadPool&quot;&gt;&lt;a href=&quot;#ThreadPool&quot; class=&quot;headerlink&quot; title=&quot;ThreadPool&quot;&gt;&lt;/a&gt;ThreadPool&lt;/h1&gt;&lt;h2 id=&quot;1-ä¸ºä»€ä¹ˆå­˜åœ¨çº¿ç¨‹æ± &quot;&gt;&lt;a href=&quot;#1-ä¸ºä»€ä¹ˆå­˜åœ¨çº¿ç¨‹æ± &quot;</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹Blocking Queue</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BBlocking-Queue/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BBlocking-Queue/</id>
    <published>2021-08-03T08:48:32.000Z</published>
    <updated>2021-08-04T06:17:49.104Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Blocking-Queue"><a href="#Blocking-Queue" class="headerlink" title="Blocking Queue"></a>Blocking Queue</h1><p>A blocking queue is a queue that blocks when you try to dequeue from it and the queue is empty, or if you try to enqueue items to it and the queue is already full. A thread trying to dequeue from an empty queue is blocked until some other thread inserts an item into the queue. A thread trying to enqueue an item in a full queue is blocked until some other thread makes space in the queue, either by dequeuing one or more items or clearing the queue completely.</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210804131939043.png" alt="image-20210804131939043" style="zoom:50%;" /><p>é˜»å¡é˜Ÿåˆ—ä¸¤å¤§ç‰¹æ€§ï¼š</p><ul><li>å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœ<strong>ç”Ÿäº§è€…çº¿ç¨‹</strong>å‘é˜Ÿåˆ— put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨æˆ–è€…å“åº”ä¸­æ–­é€€å‡º</li><li>å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå¦‚æœ<strong>æ¶ˆè´¹è€…çº¿ç¨‹</strong> ä»é˜Ÿåˆ—é‡Œé¢ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©º</li></ul><p>é˜»å¡é˜Ÿåˆ—æœ€å¸¸ä½¿ç”¨åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ•°æ®ï¼Œå°†æ•°æ®å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ï¼Œåœ¨é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ã€‚</p><p>é˜»å¡é˜Ÿåˆ—åœ¨ä¸å¯ç”¨æ—¶ï¼Œä¸‹é¢æ˜¯å„ç§å¤„ç†æ“ä½œçš„ç»“æœï¼šğŸ‘‡</p><table><thead><tr><th align="center">æ–¹æ³•/å¤„ç†æ–¹å¼</th><th align="center">æŠ›å‡ºå¼‚å¸¸</th><th align="center">è¿”å›ç‰¹æ®Šå€¼</th><th align="center">ä¸€ç›´é˜»å¡</th><th align="center">è¶…æ—¶é€€å‡º</th></tr></thead><tbody><tr><td align="center">æ’å…¥æ–¹æ³•</td><td align="center">add(e)</td><td align="center">offer(e)</td><td align="center">put(e)</td><td align="center">offer(e, time,unit)</td></tr><tr><td align="center">ç§»é™¤æ–¹æ³•</td><td align="center">remove()</td><td align="center">poll()</td><td align="center">take()</td><td align="center">poll(time,unit)</td></tr><tr><td align="center">æ£€æŸ¥æ–¹æ³•</td><td align="center">element()</td><td align="center">peek()</td><td align="center">ä¸å¯ç”¨</td><td align="center">ä¸å¯ç”¨</td></tr></tbody></table><h3 id="add-æŠ›å‡ºå¼‚å¸¸IllegalStateException"><a href="#add-æŠ›å‡ºå¼‚å¸¸IllegalStateException" class="headerlink" title="add æŠ›å‡ºå¼‚å¸¸IllegalStateException"></a>add æŠ›å‡ºå¼‚å¸¸IllegalStateException</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayBlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;queue size -&gt; &quot;</span> + queue.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼‚å¸¸ä¿¡æ¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalStateException: Queue full</span><br><span class="line">at java.util.AbstractQueue.add(AbstractQueue.java:<span class="number">98</span>)</span><br><span class="line">at java.util.concurrent.ArrayBlockingQueue.add(ArrayBlockingQueue.java:<span class="number">312</span>)</span><br><span class="line">at com.ibli.note.ArrayBlockingQueueDemo.main(ArrayBlockingQueueDemo.java:<span class="number">15</span>)</span><br></pre></td></tr></table></figure><h3 id="elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException"><a href="#elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException" class="headerlink" title="elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException"></a>elementæŠ›å‡ºå¼‚å¸¸NoSuchElementException</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayBlockingQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayBlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;queue size -&gt; &quot;</span> + queue.size());</span><br><span class="line">        queue.element();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼‚å¸¸ä¿¡æ¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">queue size -&gt; <span class="number">0</span></span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.util.NoSuchElementException</span><br><span class="line">at java.util.AbstractQueue.element(AbstractQueue.java:<span class="number">136</span>)</span><br><span class="line">at com.ibli.note.ArrayBlockingQueueDemo.main(ArrayBlockingQueueDemo.java:<span class="number">14</span>)</span><br></pre></td></tr></table></figure><h2 id="ArrayBlockingQueue"><a href="#ArrayBlockingQueue" class="headerlink" title="ArrayBlockingQueue"></a>ArrayBlockingQueue</h2><p>åº•å±‚ç”±æ•°ç»„å®ç°çš„æœ‰ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ƒçš„å®¹é‡åœ¨åˆ›å»ºçš„æ—¶å€™å°±å·²ç»ç¡®è®¤äº†ï¼Œå¹¶ä¸”ä¸èƒ½ä¿®æ”¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.items = <span class="keyword">new</span> Object[capacity];</span><br><span class="line">    lock = <span class="keyword">new</span> ReentrantLock(fair);</span><br><span class="line">    notEmpty = lock.newCondition();</span><br><span class="line">    notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒArrayBlockingQueueæ˜¯ä¸ä¿è¯çº¿ç¨‹å…¬å¹³è®¿é—®é˜Ÿåˆ—çš„ï¼Œè¿™é‡Œæ‰€è°“çš„å…¬å¹³ä¸å¦æ˜¯æŒ‡ï¼Œé˜»å¡çš„çº¿ç¨‹èƒ½å¦æŒ‰ç…§é˜»å¡çš„å…ˆåé¡ºåºè®¿é—®é˜Ÿåˆ—ï¼Œå…ˆé˜»å¡å…ˆè®¿é—®ï¼Œåé˜»å¡åè®¿é—®ã€‚</p><p>æ€è€ƒä¸ºä»€ä¹ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯éå…¬å¹³çš„æ–¹å¼è®¿é—®å‘¢ï¼Ÿ ğŸ¤”</p><blockquote><p>è¿™ä¸ªæ˜¯ä¸ºäº†å¢åŠ ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡ï¼Œåœ¨ä¸ä¿è¯å…¬å¹³çš„æƒ…å†µä¸‹ï¼Œå¤šçº¿ç¨‹ä¹‹é—´ä¹‹é—´æ‰§è¡Œçš„æ•ˆç‡è¦æ¯”å…¬å¹³æ¨¡å¼ä¸‹é«˜çš„å¤šã€‚</p></blockquote><h3 id="ArrayBlovkingQueue-putæ–¹æ³•"><a href="#ArrayBlovkingQueue-putæ–¹æ³•" class="headerlink" title="ArrayBlovkingQueue#putæ–¹æ³•"></a>ArrayBlovkingQueue#putæ–¹æ³•</h3><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210804140652447.png" alt="image-20210804140652447"></p><p>ä¸‹é¢æ˜¯putæ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">  <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (count == items.length)</span><br><span class="line">          <span class="comment">// é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œé˜»å¡</span></span><br><span class="line">            notFull.await();</span><br><span class="line">      <span class="comment">// å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ </span></span><br><span class="line">        enqueue(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// æ‰§è¡Œå®Œæœ€åé‡Šæ”¾é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ·»åŠ æ•°æ®çš„æ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(E x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert lock.getHoldCount() == 1;</span></span><br><span class="line">    <span class="comment">// assert items[putIndex] == null;</span></span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">    items[putIndex] = x;</span><br><span class="line">    <span class="keyword">if</span> (++putIndex == items.length)</span><br><span class="line">        putIndex = <span class="number">0</span>;</span><br><span class="line">    count++;</span><br><span class="line">  <span class="comment">// æ•°æ®æ·»åŠ å®Œä¹‹åï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹åˆ°åŒæ­¥é˜Ÿåˆ—</span></span><br><span class="line">    notEmpty.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€¼ï¸å”¤é†’çš„çº¿ç¨‹èƒ½å¤ŸæŠ¢åˆ°é”æ˜¯ä¸ç¡®å®šçš„ï¼Œsignalä¼šæ·»åŠ èŠ‚ç‚¹åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…è·å–é”ã€‚è¿™ä¸ªå¯ä»¥çœ‹ä¸€ä¸‹Conditioné‚£ç¯‡æ–‡ç« ã€‚</p><p>ArrayBlockingQueueæ›´å¤šè¯¦ç»†ç»†èŠ‚ä»¥åŠåŸç†è·³è½¬é“¾æ¥<a href="https://www.jianshu.com/p/a636b3d83911">https://www.jianshu.com/p/a636b3d83911</a></p><h2 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h2><p>LinkedBlockingQueueæ˜¯ç”¨é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒåŒæ ·æ»¡è¶³FIFOçš„ç‰¹æ€§ï¼Œä¸ArrayBlockingQueueç›¸æ¯”èµ·æ¥å…·æœ‰æ›´é«˜çš„ååé‡ï¼Œä¸ºäº†é˜²æ­¢LinkedBlockingQueueå®¹é‡è¿…é€Ÿå¢ï¼ŒæŸè€—å¤§é‡å†…å­˜ã€‚é€šå¸¸åœ¨åˆ›å»ºLinkedBlockingQueueå¯¹è±¡æ—¶ï¼Œä¼šæŒ‡å®šå…¶å¤§å°ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œå®¹é‡ç­‰äºInteger.MAX_VALUE;</p><blockquote><p>Executors.newFixedThreadPool é˜¿é‡Œå·´å·´ç¦æ­¢ä½¿ç”¨Executorsæ¥åˆ›å»ºçº¿ç¨‹æ± </p></blockquote><p>é˜Ÿåˆ—å¤§å°æ— é™åˆ¶ï¼Œå¸¸ç”¨çš„ä¸ºæ— ç•Œçš„LinkedBlockingQueueï¼Œä½¿ç”¨è¯¥é˜Ÿåˆ—åšä¸ºé˜»å¡é˜Ÿåˆ—æ—¶è¦å°¤å…¶å½“å¿ƒï¼Œå½“ä»»åŠ¡è€—æ—¶è¾ƒé•¿æ—¶å¯èƒ½ä¼šå¯¼è‡´å¤§é‡æ–°ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­å †ç§¯æœ€ç»ˆå¯¼è‡´OOMã€‚é˜…è¯»ä»£ç å‘ç°ï¼ŒExecutors.newFixedThreadPool é‡‡ç”¨å°±æ˜¯ LinkedBlockingQueueï¼Œå½“QPSå¾ˆé«˜ï¼Œå‘é€æ•°æ®å¾ˆå¤§ï¼Œå¤§é‡çš„ä»»åŠ¡è¢«æ·»åŠ åˆ°è¿™ä¸ªæ— ç•ŒLinkedBlockingQueue ä¸­ï¼Œå¯¼è‡´cpuå’Œå†…å­˜é£™å‡æœåŠ¡å™¨æŒ‚æ‰ã€‚</p><h3 id="å±æ€§ä¿¡æ¯"><a href="#å±æ€§ä¿¡æ¯" class="headerlink" title="å±æ€§ä¿¡æ¯"></a>å±æ€§ä¿¡æ¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èŠ‚ç‚¹ç±»ï¼Œç”¨äºå­˜å‚¨æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    E item;</span><br><span class="line">    Node&lt;E&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(E x) &#123; item = x; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é˜»å¡é˜Ÿåˆ—çš„å¤§å°ï¼Œé»˜è®¤ä¸ºInteger.MAX_VALUE */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å½“å‰é˜»å¡é˜Ÿåˆ—ä¸­çš„å…ƒç´ ä¸ªæ•° */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜»å¡é˜Ÿåˆ—çš„å¤´ç»“ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è·å–å¹¶ç§»é™¤å…ƒç´ æ—¶ä½¿ç”¨çš„é”ï¼Œå¦‚take, poll, etc */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** notEmptyæ¡ä»¶å¯¹è±¡ï¼Œå½“é˜Ÿåˆ—æ²¡æœ‰æ•°æ®æ—¶ç”¨äºæŒ‚èµ·æ‰§è¡Œåˆ é™¤çš„çº¿ç¨‹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty = takeLock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ·»åŠ å…ƒç´ æ—¶ä½¿ç”¨çš„é”å¦‚ put, offer, etc */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** notFullæ¡ä»¶å¯¹è±¡ï¼Œå½“é˜Ÿåˆ—æ•°æ®å·²æ»¡æ—¶ç”¨äºæŒ‚èµ·æ‰§è¡Œæ·»åŠ çš„çº¿ç¨‹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull = putLock.newCondition();</span><br></pre></td></tr></table></figure><h3 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤å¤§å°ä¸ºInteger.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">this</span>(Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">    last = head = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(Integer.MAX_VALUE);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    putLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">if</span> (n == capacity)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Queue full&quot;</span>);</span><br><span class="line">            enqueue(<span class="keyword">new</span> Node&lt;E&gt;(e));</span><br><span class="line">            ++n;</span><br><span class="line">        &#125;</span><br><span class="line">        count.set(n);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LinkedBlockingQueue-putæ–¹æ³•"><a href="#LinkedBlockingQueue-putæ–¹æ³•" class="headerlink" title="LinkedBlockingQueue#putæ–¹æ³•"></a>LinkedBlockingQueue#putæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="comment">// è·å–é”ä¸­æ–­</span></span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œå¦‚æœå·²æ»¡é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠnodeæ”¾å…¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">        enqueue(node);</span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        <span class="comment">// å†æ¬¡åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æœ‰å¯ç”¨ç©ºé—´ï¼Œå¦‚æœæœ‰å”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œæ·»åŠ æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ä¸€æ¡æ•°æ®ï¼Œå”¤é†’æ¶ˆè´¹çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é˜Ÿåˆ—å·²æ»¡ï¼Œé˜»å¡ç­‰å¾…ã€‚</li><li>é˜Ÿåˆ—æœªæ»¡ï¼Œåˆ›å»ºä¸€ä¸ªnodeèŠ‚ç‚¹æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæ”¾å®Œä»¥åé˜Ÿåˆ—è¿˜æœ‰å‰©ä½™ç©ºé—´ï¼Œç»§ç»­å”¤é†’ä¸‹ä¸€ä¸ªæ·»åŠ çº¿ç¨‹è¿›è¡Œæ·»åŠ ã€‚å¦‚æœæ”¾ä¹‹å‰é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ ï¼Œæ”¾å®Œä»¥åè¦å”¤é†’æ¶ˆè´¹çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹ã€‚</li></ul><h3 id="ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ"><a href="#ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ" class="headerlink" title="ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ"></a>ArrayBlockingQueueä¸LinkedBlockingQueueçš„æ¯”è¾ƒ</h3><p><strong>ç›¸åŒç‚¹</strong>ï¼šArrayBlockingQueueå’ŒLinkedBlockingQueueéƒ½æ˜¯é€šè¿‡conditioné€šçŸ¥æœºåˆ¶æ¥å®ç°å¯é˜»å¡å¼æ’å…¥å’Œåˆ é™¤å…ƒç´ ï¼Œå¹¶æ»¡è¶³çº¿ç¨‹å®‰å…¨çš„ç‰¹æ€§ï¼›</p><p><strong>ä¸åŒç‚¹</strong>ï¼š</p><p>1ã€ArrayBlockingQueueåº•å±‚æ˜¯é‡‡ç”¨çš„æ•°ç»„è¿›è¡Œå®ç°ï¼Œè€ŒLinkedBlockingQueueåˆ™æ˜¯é‡‡ç”¨é“¾è¡¨æ•°æ®ç»“æ„ï¼›</p><p>2ã€ArrayBlockingQueueæ’å…¥å’Œåˆ é™¤æ•°æ®ï¼Œåªé‡‡ç”¨äº†ä¸€ä¸ªlockï¼Œè€ŒLinkedBlockingQueueåˆ™æ˜¯åœ¨æ’å…¥å’Œåˆ é™¤åˆ†åˆ«é‡‡ç”¨äº†<code>putLock</code>å’Œ<code>takeLock</code>ï¼Œè¿™æ ·å¯ä»¥é™ä½çº¿ç¨‹ç”±äºçº¿ç¨‹æ— æ³•è·å–åˆ°lockè€Œè¿›å…¥WAITINGçŠ¶æ€çš„å¯èƒ½æ€§ï¼Œä»è€Œæé«˜äº†çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æ•ˆç‡</p><p>æ›´å¤šLinkedBlockingQueueçš„å®ç°ç»†èŠ‚å‚è§<a href="https://blog.csdn.net/tonywu1992/article/details/83419448">https://blog.csdn.net/tonywu1992/article/details/83419448</a></p><h2 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h2><p>PriorityBlockingQueueæ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„<strong>æ— ç•Œé˜»å¡</strong>é˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡ç”¨è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»å®ç°compareTo()æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ–æ—¶é€šè¿‡æ„é€ å™¨å‚æ•°Comparatoræ¥æŒ‡å®šæ’åºè§„åˆ™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PriorityBlockingQueue</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 Comparator&lt;? <span class="keyword">super</span> E&gt; comparator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">this</span>.lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">this</span>.notEmpty = lock.newCondition();</span><br><span class="line">        <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p><p>1ã€é˜Ÿåˆ—ä¸­ä¸å…è®¸å‡ºç°nullå€¼ï¼Œä¹Ÿä¸å…è®¸å‡ºç°ä¸èƒ½æ’åºçš„å…ƒç´ ã€‚</p><p>2ã€é˜Ÿåˆ—å®¹é‡æ˜¯æ²¡æœ‰ä¸Šé™çš„ï¼Œä½†æ˜¯å¦‚æœæ’å…¥çš„å…ƒç´ è¶…è¿‡è´Ÿè½½ï¼Œæœ‰å¯èƒ½ä¼šå¼•èµ·OutOfMemoryå¼‚å¸¸ã€‚</p><blockquote><p>å½“æˆ‘ä»¬ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ˜¯éƒ½åº”è¯¥æ³¨æ„çš„ç‚¹ï¼Œä¸èƒ½åœ¨é˜Ÿåˆ—ä¸­æ— é™å­˜æ”¾æ•°æ®</p></blockquote><p>3ã€PriorityBlockingQueueç”±äºæ˜¯æ— ç•Œçš„ï¼Œæ‰€ä»¥putæ–¹æ³•æ˜¯éé˜»å¡çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    offer(e); <span class="comment">// never need to block  è¯·è‡ªè¡Œå¯¹ç…§ä¸Šé¢è¡¨æ ¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç»™å®šåˆå§‹å®¹é‡ï¼Œè¿™ä¸ªå®¹é‡ä¼šæŒ‰ç…§ä¸€å®šçš„ç®—æ³•è‡ªåŠ¨æ‰©å……</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Default array capacity.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PriorityBlockingQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé»˜è®¤çš„å®¹é‡æ˜¯ 11ï¼Œç”±äºä¹Ÿæ˜¯åŸºäºæ•°ç»„ã€‚</p><p>4ã€<code>å†…éƒ¨åªæœ‰ä¸€ä¸ªLockï¼Œæ‰€ä»¥ç”Ÿäº§æ¶ˆè´¹è€…ä¸èƒ½åŒæ—¶ä½œä¸š</code></p><p>è¯¦æƒ…å¯ä»¥å‚ç…§<a href="https://www.cnblogs.com/wyq1995/p/12289462.html">https://www.cnblogs.com/wyq1995/p/12289462.html</a></p><h2 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h2><p>DelayQueueé¡¾åæ€ä¹‰ï¼Œå…·æœ‰å»¶æ—¶ä½œç”¨çš„é˜Ÿåˆ—ã€‚</p><p>è®°å¾—ç¬¬ä¸€æ¬¡æ¥è§¦å»¶æ—¶é˜Ÿåˆ—çš„æ—¶å€™æ˜¯åœ¨çœ‹åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ—¶çœ‹åˆ°åº•å±‚æœ‰å…³å»¶æ—¶é˜Ÿåˆ—çš„å®ç°ã€‚</p><p>DelayQueue ä¹Ÿæ˜¯ä¸€ä¸ªæ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨æ—¶è¦æ³¨æ„OOMã€‚</p><p><code>åªæœ‰delayæ—¶é—´å°äº0çš„å…ƒç´ æ‰èƒ½å¤Ÿè¢«å–å‡ºã€‚</code></p><h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h3><p>åˆ›å»ºä¸€ä¸ªç±»ï¼Œå®ç°Delayedæ–¹æ³•ï¼Œé‡å†™getDelayæ–¹æ³•å’ŒcompareToæ–¹æ³•ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayData</span> <span class="keyword">implements</span> <span class="title">Delayed</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> second;</span><br><span class="line">    <span class="keyword">private</span> String val;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DelayData</span><span class="params">(<span class="keyword">long</span> second, String val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">        System.err.println(second + <span class="string">&quot; &quot;</span> + l);</span><br><span class="line">        <span class="keyword">this</span>.second = second + l;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getSecond</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> diffTime = second - System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">return</span> unit.convert(diffTime,TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>&#123;</span><br><span class="line">        DelayData tmp = (DelayData) o;</span><br><span class="line">        <span class="keyword">long</span> result =  second - tmp.getSecond() ;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DelayData&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;second=&quot;</span> + second +</span><br><span class="line">                <span class="string">&quot;, val=&#x27;&quot;</span> + val + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç„¶ååˆ›å»ºä¸¤ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueueDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        DelayQueue&lt;DelayData&gt; delayQueue = <span class="keyword">new</span> DelayQueue&lt;DelayData&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> DelayData(<span class="number">5000</span>, <span class="string">&quot;a&quot;</span>));</span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> DelayData(<span class="number">10000</span>, <span class="string">&quot;b&quot;</span>));</span><br><span class="line">            delayQueue.put(<span class="keyword">new</span> DelayData(<span class="number">15000</span>, <span class="string">&quot;c&quot;</span>));</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span> &amp;&amp; flag) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.err.println(<span class="string">&quot;æ‰§è¡Œä¸€æ¬¡å¾ªç¯  é˜Ÿåˆ—é•¿åº¦&quot;</span> + delayQueue.size());</span><br><span class="line">                    DelayData poll = delayQueue.take();</span><br><span class="line">                    <span class="keyword">if</span> (poll != <span class="keyword">null</span>)&#123;</span><br><span class="line">                        System.err.println(poll.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (delayQueue.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                        flag = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SynchronousQueue"><a href="#SynchronousQueue" class="headerlink" title="SynchronousQueue"></a>SynchronousQueue</h2><p><strong>SynchronousQueue</strong>å®é™…ä¸Šå®ƒä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„é˜Ÿåˆ—ï¼Œå› ä¸ºå®ƒä¸ä¼šç»´æŠ¤é˜Ÿåˆ—ä¸­å…ƒç´ çš„å­˜å‚¨ç©ºé—´ï¼Œä¸å…¶ä»–é˜Ÿåˆ—ä¸åŒçš„æ˜¯ï¼Œå®ƒç»´æŠ¤ä¸€ç»„çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹åœ¨ç­‰å¾…æŠŠå…ƒç´ åŠ å…¥æˆ–ç§»é™¤é˜Ÿåˆ—ã€‚é€‚ç”¨äºç”Ÿäº§è€…å°‘æ¶ˆè´¹è€…å¤šçš„æƒ…å†µã€‚</p><p>SynchronousQueueæ˜¯ç”Ÿäº§è€…ç›´æ¥æŠŠæ•°æ®ç»™æ¶ˆè´¹è€…ï¼ˆæ¶ˆè´¹è€…ç›´æ¥ä»ç”Ÿäº§è€…è¿™é‡Œæ‹¿æ•°æ®ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œ<strong>æ¯ä¸€ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªçº¿ç¨‹å¯¹åº”çš„ç§»é™¤æ“ä½œ</strong>ã€‚SynchronousQueueåˆæœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><p>1ã€å…¬å¹³æ¨¡å¼</p><p>ã€€ã€€é‡‡ç”¨å…¬å¹³é”ï¼Œå¹¶é…åˆä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼ˆQueueï¼‰æ¥ç®¡ç†å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</p><p>2ã€éå…¬å¹³æ¨¡å¼</p><p>ã€€ã€€é‡‡ç”¨éå…¬å¹³é”ï¼Œå¹¶é…åˆä¸€ä¸ªLIFOæ ˆï¼ˆStackï¼‰æ¥ç®¡ç†å¤šä½™çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œè¿™ä¹Ÿæ˜¯SynchronousQueueé»˜è®¤çš„æ¨¡å¼</p><h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">SynchronousQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SynchronousQueue</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">        transferer = fair ? <span class="keyword">new</span> TransferQueue() : <span class="keyword">new</span> TransferStack();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>transferer æ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ç”¨äºåœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¼ é€’æ•°æ®</p><h3 id="å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…"><a href="#å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…" class="headerlink" title="å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…"></a>å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…</h3><p>ä¸‹é¢æ¨¡æ‹Ÿä¸€ä¸ªç”Ÿäº§è€…ç”Ÿäº§æ•°æ®ï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronousQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        SynchronousQueue queue = <span class="keyword">new</span> SynchronousQueue();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000L</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    <span class="keyword">long</span> l = System.currentTimeMillis();</span><br><span class="line">                    queue.put(l);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :&quot;</span> + l);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">300</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š &quot;</span> + queue.take());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">300</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š &quot;</span> + queue.take());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç è¿è¡Œç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947404</span><br><span class="line">Thread-1æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š 1628055947404</span><br><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947506</span><br><span class="line">Thread-2æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š 1628055947506</span><br><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947608</span><br><span class="line">Thread-2æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ® ï¼š 1628055947608</span><br><span class="line">Thread-0 ç”Ÿäº§è€…ç”Ÿäº§æ•°æ® :1628055947713</span><br></pre></td></tr></table></figure><p>SynchronousQueueè¯¦ç»†å®ç°ç»†èŠ‚å‚è§<a href="https://blog.csdn.net/yanyan19880509/article/details/52562039">https://blog.csdn.net/yanyan19880509/article/details/52562039</a></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html">https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html</a></p><p><a href="http://tutorials.jenkov.com/java-concurrency/index.html">http://tutorials.jenkov.com/java-concurrency/index.html</a></p><p><a href="https://www.baeldung.com/java-blocking-queue">https://www.baeldung.com/java-blocking-queue</a></p><p><a href="https://blog.csdn.net/tonywu1992/article/details/83419448">https://blog.csdn.net/tonywu1992/article/details/83419448</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Blocking-Queue&quot;&gt;&lt;a href=&quot;#Blocking-Queue&quot; class=&quot;headerlink&quot; title=&quot;Blocking Queue&quot;&gt;&lt;/a&gt;Blocking Queue&lt;/h1&gt;&lt;p&gt;A blocking queue is a </summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹ä¸­æ–­æœºåˆ¶</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%9C%BA%E5%88%B6/</id>
    <published>2021-08-03T07:56:37.000Z</published>
    <updated>2021-08-03T08:43:17.432Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸­æ–­æœºåˆ¶"><a href="#ä¸­æ–­æœºåˆ¶" class="headerlink" title="ä¸­æ–­æœºåˆ¶"></a>ä¸­æ–­æœºåˆ¶</h1><p>Javaè¯­è¨€æä¾›ä¸€ç§æœºåˆ¶æ¥è¯•å›¾â€œç»ˆæ­¢â€ä¸€äº›ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œæ¯”å¦‚ä¸€ä¸‹ç©ºè½¬çš„çº¿ç¨‹ä¸€ç›´æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ä¸­æ–­çš„æ–¹å¼æ¥åœæ­¢è¿™ä¸€ç±»çš„çº¿ç¨‹ï¼Œè¿™å°±æ˜¯Javaä¸­æ–­æœºåˆ¶ã€‚</p><h2 id="1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹"><a href="#1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹" class="headerlink" title="1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹"></a>1ã€ä¸­æ–­æ³¨æ„çš„åœ°æ–¹</h2><p>1ã€<strong>Javaä¸­çº¿ç¨‹é—´æ˜¯åä½œå¼ï¼Œè€ŒéæŠ¢å å¼</strong>. è°ƒç”¨ä¸€ä¸ªçº¿ç¨‹çš„interrupt() æ–¹æ³•ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸æ˜¯å¼ºè¡Œå…³é—­è¿™ä¸ªçº¿ç¨‹ï¼Œåªæ˜¯è·Ÿè¿™ä¸ªçº¿ç¨‹æ‰“ä¸ªæ‹›å‘¼ï¼Œå°†çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ç½®ä¸ºtrueï¼Œçº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œç”±çº¿ç¨‹æœ¬èº«å†³å®šã€‚</p><p>2ã€isInterrupted() åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ã€‚</p><p>3ã€é™æ€æ–¹æ³• interrupted() åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ï¼ŒåŒæ—¶ä¸­æ–­æ ‡å¿—ä½æ”¹ä¸º falseã€‚</p><p>4ã€<strong>å¦‚æœæ–¹æ³•é‡Œå¦‚æœæŠ›å‡ºä¸­æ–­å¼‚å¸¸ InterruptedExceptionï¼Œåˆ™çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¼šè¢«å¤ä½æˆfalse</strong>ï¼Œå¦‚æœç¡®å®æ˜¯éœ€è¦ä¸­æ–­çº¿ç¨‹ï¼Œè¦æ±‚æˆ‘ä»¬è‡ªå·±åœ¨catchè¯­å¥å—é‡Œå†æ¬¡è°ƒç”¨interrupt()ã€‚</p><p>5ã€Java ä¸­æ‰€æœ‰çš„é˜»å¡æ–¹æ³•éƒ½ä¼šæŠ›å‡º InterruptedExceptionï¼Œæ¯”å¦‚wait(), join(),sleep()ã€‚</p><h2 id="2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•"><a href="#2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•" class="headerlink" title="2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•"></a>2ã€Javaä¸­æ–­æä¾›çš„æ–¹æ³•</h2><p>åœ¨Javaä¸­æä¾›äº†3ä¸ªæœ‰å…³ä¸­æ–­çš„æ–¹æ³•ï¼š</p><h3 id="Thread-currentThread-isInterrupted"><a href="#Thread-currentThread-isInterrupted" class="headerlink" title="Thread.currentThread().isInterrupted()"></a>Thread.currentThread().isInterrupted()</h3><blockquote><p>åˆ¤æ–­å½“å‰çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</p></blockquote><h3 id="thread-interrupt"><a href="#thread-interrupt" class="headerlink" title="thread.interrupt();"></a>thread.interrupt();</h3><blockquote><p>ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œå°†ä¸­æ–­æ ‡å¿—è®¾ç½®æˆtrue</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != Thread.currentThread())</span><br><span class="line">            checkAccess();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (blockerLock) &#123;</span><br><span class="line">            Interruptible b = blocker;</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">                interrupt0();           <span class="comment">// Just to set the interrupt flag</span></span><br><span class="line">                b.interrupt(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        interrupt0();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Thread-interrupted"><a href="#Thread-interrupted" class="headerlink" title="Thread.interrupted()"></a>Thread.interrupted()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">interrupted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentThread().isInterrupted(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œæ”¹æˆfalseï¼›</p></blockquote><p>éªŒè¯ä¸€ä¸‹å°±å¯ä»¥äº† ğŸ‘‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.err.println(Thread.currentThread().isInterrupted());</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">    System.err.println(Thread.currentThread().isInterrupted());</span><br><span class="line">    <span class="keyword">boolean</span> interrupted = Thread.interrupted();</span><br><span class="line">    System.err.println(<span class="string">&quot;interrupted &quot;</span> + interrupted);</span><br><span class="line">    System.err.println(Thread.currentThread().isInterrupted());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3ã€ä¸­æ–­ä¾‹å­"><a href="#3ã€ä¸­æ–­ä¾‹å­" class="headerlink" title="3ã€ä¸­æ–­ä¾‹å­"></a>3ã€ä¸­æ–­ä¾‹å­</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterrupterDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span> &amp;&amp; !Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">                System.err.println(<span class="number">1</span>);</span><br><span class="line">                System.err.println(Thread.interrupted());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;after sleep &quot;</span>+ Thread.currentThread().isInterrupted());</span><br><span class="line">                  Thread.currentThread().interrupt();</span><br><span class="line">                    <span class="keyword">boolean</span> interrupted = Thread.interrupted();</span><br><span class="line">                    System.err.println(<span class="string">&quot;interrupted &quot;</span>+ Thread.currentThread().isInterrupted() + <span class="string">&quot;/ &quot;</span> + interrupted);</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                    System.err.println(<span class="string">&quot;final sleep &quot;</span>+ Thread.currentThread().isInterrupted());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸­æ–­ä¸€åœºä¸è¦ã€ åæ‰ ã€‘ï¼Œè¦ä¸åœ¨ç¨‹åºä¸­ç›¸åº”ä¸­æ–­ä¸€åœºï¼Œè¿›è¡Œç›¸åº”çš„é€»è¾‘å¤„ç†ï¼Œæˆ–è€…å°†ä¸€åœºç»§ç»­å‘ä¸ŠæŠ›ï¼Œç”±ä¸Šå±‚å¤„ç†ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://dayarch.top/p/java-concurrency-interrupt-mechnism.html">https://dayarch.top/p/java-concurrency-interrupt-mechnism.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸­æ–­æœºåˆ¶&quot;&gt;&lt;a href=&quot;#ä¸­æ–­æœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;ä¸­æ–­æœºåˆ¶&quot;&gt;&lt;/a&gt;ä¸­æ–­æœºåˆ¶&lt;/h1&gt;&lt;p&gt;Javaè¯­è¨€æä¾›ä¸€ç§æœºåˆ¶æ¥è¯•å›¾â€œç»ˆæ­¢â€ä¸€äº›ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œæ¯”å¦‚ä¸€ä¸‹ç©ºè½¬çš„çº¿ç¨‹ä¸€ç›´æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ä¸­æ–­çš„æ–¹å¼æ¥åœæ­¢è¿™ä¸€ç±»çš„çº¿</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹Conditionæœºåˆ¶åº•å±‚</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCondition%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BCondition%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82/</id>
    <published>2021-08-03T04:00:16.000Z</published>
    <updated>2021-08-07T09:36:44.494Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶"><a href="#Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶" class="headerlink" title="Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶"></a>Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶</h1><p>è¿˜æ˜¯çœ‹ä¸€ä¸‹ä¹‹å‰ReentrantLockä¸­è°ƒç”¨conditionæ–¹æ³•çš„æµç¨‹å›¾ ğŸ‘‡</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210803140956785.png" alt="image-20210803140956785" style="zoom:40%;" /><p>ä»»ä½•ä¸€ä¸ªjavaå¯¹è±¡éƒ½å¤©ç„¶ç»§æ‰¿äºObjectç±»ï¼Œåœ¨çº¿ç¨‹é—´å®ç°é€šä¿¡çš„å¾€å¾€ä¼šåº”ç”¨åˆ°Objectçš„å‡ ä¸ªæ–¹æ³•ï¼Œæ¯”å¦‚wait(),wait(long timeout),wait(long timeout, int nanos)ä¸notify(),notifyAll()å‡ ä¸ªæ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ŒåŒæ ·çš„ï¼Œ åœ¨java Lockä½“ç³»ä¸‹ä¾ç„¶ä¼šæœ‰åŒæ ·çš„æ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚</p><p>ä»æ•´ä½“ä¸Šæ¥çœ‹<strong>Objectçš„waitå’Œnotify/notifyæ˜¯ä¸å¯¹è±¡ç›‘è§†å™¨é…åˆå®Œæˆçº¿ç¨‹é—´çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œè€ŒConditionä¸Locké…åˆå®Œæˆç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œå‰è€…æ˜¯javaåº•å±‚çº§åˆ«çš„ï¼Œåè€…æ˜¯è¯­è¨€çº§åˆ«çš„ï¼Œå…·æœ‰æ›´é«˜çš„å¯æ§åˆ¶æ€§å’Œæ‰©å±•æ€§</strong>ã€‚ä¸¤è€…é™¤äº†åœ¨ä½¿ç”¨æ–¹å¼ä¸Šä¸åŒå¤–ï¼Œåœ¨<strong>åŠŸèƒ½ç‰¹æ€§</strong>ä¸Šè¿˜æ˜¯æœ‰å¾ˆå¤šçš„ä¸åŒï¼š</p><ol><li>Conditionèƒ½å¤Ÿæ”¯æŒä¸å“åº”ä¸­æ–­ï¼Œè€Œé€šè¿‡ä½¿ç”¨Objectæ–¹å¼ä¸æ”¯æŒï¼›</li><li>Conditionèƒ½å¤Ÿæ”¯æŒå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ˆnew å¤šä¸ªConditionå¯¹è±¡ï¼‰ï¼Œè€ŒObjectæ–¹å¼åªèƒ½æ”¯æŒä¸€ä¸ªï¼›</li><li>Conditionèƒ½å¤Ÿæ”¯æŒè¶…æ—¶æ—¶é—´çš„è®¾ç½®ï¼Œè€ŒObjectä¸æ”¯æŒ</li></ol><h2 id="1-Conditionæ¥å£æä¾›çš„æ–¹æ³•"><a href="#1-Conditionæ¥å£æä¾›çš„æ–¹æ³•" class="headerlink" title="1. Conditionæ¥å£æä¾›çš„æ–¹æ³•"></a>1. Conditionæ¥å£æä¾›çš„æ–¹æ³•</h2><h3 id="1-1-awaitæ–¹æ³•"><a href="#1-1-awaitæ–¹æ³•" class="headerlink" title="1.1 awaitæ–¹æ³•"></a>1.1 awaitæ–¹æ³•</h3><p><strong>void await() throws InterruptedException</strong></p><p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è°ƒç”¨conditionçš„signalæˆ–è€…signalAllæ–¹æ³•å¹¶ä¸”å½“å‰çº¿ç¨‹è·å–Lockä»awaitæ–¹æ³•è¿”å›ï¼Œå¦‚æœåœ¨ç­‰å¾…çŠ¶æ€ä¸­è¢«ä¸­æ–­ä¼šæŠ›å‡ºè¢«ä¸­æ–­å¼‚å¸¸ï¼›</p><p><strong>long awaitNanos(long nanosTimeout)</strong></p><p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ï¼Œä¸­æ–­æˆ–è€…<strong>è¶…æ—¶</strong>ï¼›</p><p><strong>boolean await(long time, TimeUnit unit)throws InterruptedException</strong></p><p>åŒç¬¬äºŒç§ï¼Œæ”¯æŒè‡ªå®šä¹‰æ—¶é—´å•ä½</p><p><strong>boolean awaitUntil(Date deadline) throws InterruptedException</strong></p><p>å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«é€šçŸ¥ï¼Œä¸­æ–­æˆ–è€…<strong>åˆ°äº†æŸä¸ªæ—¶é—´</strong></p><h3 id="1-2-signalæ–¹æ³•"><a href="#1-2-signalæ–¹æ³•" class="headerlink" title="1.2 signalæ–¹æ³•"></a>1.2 signalæ–¹æ³•</h3><p><strong>void signal()</strong></p><p>å”¤é†’ä¸€ä¸ªç­‰å¾…åœ¨conditionä¸Šçš„çº¿ç¨‹ï¼Œå°†è¯¥çº¿ç¨‹ä»<strong>ç­‰å¾…é˜Ÿåˆ—</strong>ä¸­è½¬ç§»åˆ°<strong>åŒæ­¥é˜Ÿåˆ—</strong>ä¸­ï¼Œå¦‚æœåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­èƒ½å¤Ÿç«äº‰åˆ°Lockåˆ™å¯ä»¥ä»ç­‰å¾…æ–¹æ³•ä¸­è¿”å›ã€‚</p><p><strong>void signalAll()</strong></p><p>ä¸1çš„åŒºåˆ«åœ¨äºèƒ½å¤Ÿå”¤é†’æ‰€æœ‰ç­‰å¾…åœ¨conditionä¸Šçš„çº¿ç¨‹ã€‚</p><h2 id="2-Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨"><a href="#2-Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨" class="headerlink" title="2. Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨"></a>2. Conditionåœ¨ReentrantLockä¸­çš„ä½¿ç”¨</h2><p>ä¸‹é¢å…ˆé€šè¿‡ä¸€ä¸ªä¾‹å­çœ‹ä¸€ä¸‹Conditionçš„ä½¿ç”¨ ğŸ‘‡</p><p>1ã€å¤§è‡´æµç¨‹å°±æ˜¯çº¿ç¨‹1å…ˆè·å–lockä¹‹åï¼Œæ‰§è¡Œçº¿ç¨‹1çš„æ–¹æ³•ï¼Œç„¶åè°ƒç”¨condition.await();æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ï¼›åŒæ—¶åŠ å…¥Conditionç­‰å¾…é˜Ÿåˆ—</p><p>2ã€çº¿ç¨‹1é‡Šæ”¾lockä¹‹åï¼Œçº¿ç¨‹2è€Œå·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­äº†ï¼Œçº¿ç¨‹2è·å–lockæ‰§è¡Œæƒï¼Œæ‰§è¡Œcondition.signal()æ–¹æ³•å”¤é†’çº¿ç¨‹1</p><p>3ã€çº¿ç¨‹1è¢«å”¤é†’ä¹‹åï¼ŒnodeèŠ‚ç‚¹é‡æ–°æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è·å–æ‰§è¡Œæƒé™ï¼Œåœ¨çº¿ç¨‹2è°ƒç”¨äº†unlock()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹1é‡æ–°è·å–åˆ°lockä¹‹åï¼Œæ‰§è¡Œåç»­æµç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Condition condition = lock.newCondition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;enter thread 1 &quot;</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;thread 1 invoke await&quot;</span>);</span><br><span class="line">                    condition.await();</span><br><span class="line">                    System.err.println(<span class="string">&quot;thread 1 invoked signal&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(<span class="string">&quot;exit thread 1 &quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;enter thread 2 &quot;</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.err.println(<span class="string">&quot;thread 2 invoke signal&quot;</span>);</span><br><span class="line">                condition.signal();</span><br><span class="line">                System.err.println(<span class="string">&quot;exit thread 2 &quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„æ‰§è¡Œç»“æœå¯ä»¥çŒœæƒ³ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enter thread <span class="number">1</span> </span><br><span class="line">thread <span class="number">1</span> invoke await</span><br><span class="line">enter thread <span class="number">2</span> </span><br><span class="line">thread <span class="number">2</span> invoke signal</span><br><span class="line">exit thread <span class="number">2</span> </span><br><span class="line">thread <span class="number">1</span> invoked signal</span><br><span class="line">exit thread <span class="number">1</span> </span><br></pre></td></tr></table></figure><h2 id="3-Conditionç­‰å¾…-é€šçŸ¥å®ç°åŸç†"><a href="#3-Conditionç­‰å¾…-é€šçŸ¥å®ç°åŸç†" class="headerlink" title="3. Conditionç­‰å¾…/é€šçŸ¥å®ç°åŸç†"></a>3. Conditionç­‰å¾…/é€šçŸ¥å®ç°åŸç†</h2><p>è¦æƒ³èƒ½å¤Ÿæ·±å…¥çš„æŒæ¡conditionè¿˜æ˜¯åº”è¯¥çŸ¥é“å®ƒçš„å®ç°åŸç†ï¼Œç°åœ¨æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹condiitonçš„æºç ã€‚åˆ›å»ºä¸€ä¸ªconditionå¯¹è±¡æ˜¯é€šè¿‡<code>lock.newCondition()</code>,è€Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ä¼šnewå‡ºä¸€ä¸ª<strong>ConditionObject</strong>å¯¹è±¡ï¼Œè¯¥ç±»æ˜¯AQSçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå’ŒNodeç±»ä¸€æ ·ï¼Œéå¸¸é‡è¦ã€‚</p><p>conditionæ˜¯è¦å’Œlocké…åˆä½¿ç”¨çš„ä¹Ÿå°±æ˜¯conditionå’ŒLockæ˜¯ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œè€Œlockçš„å®ç°åŸç†åˆä¾èµ–äºAQSï¼Œè‡ªç„¶è€Œç„¶ConditionObjectä½œä¸ºAQSçš„ä¸€ä¸ªå†…éƒ¨ç±»æ— å¯åšéã€‚</p><p>æˆ‘ä»¬çŸ¥é“åœ¨é”æœºåˆ¶çš„å®ç°ä¸Šï¼ŒAQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯ç‹¬å å¼é”çš„è¯ï¼Œæ‰€æœ‰è·å–é”å¤±è´¥çš„çº¿ç¨‹çš„å°¾æ’å…¥åˆ°<strong>åŒæ­¥é˜Ÿåˆ—</strong>ï¼ŒåŒæ ·çš„ï¼Œconditionå†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨åŒæ ·çš„æ–¹å¼ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª <strong>ç­‰å¾…é˜Ÿåˆ—</strong>ï¼Œæ‰€æœ‰è°ƒç”¨condition.awaitæ–¹æ³•çš„çº¿ç¨‹ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”çº¿ç¨‹çŠ¶æ€è½¬æ¢ä¸ºç­‰å¾…çŠ¶æ€ã€‚</p><p>å¦å¤–æ³¨æ„åˆ°ConditionObjectä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š</p><p><code>private transient Node firstWaiter;</code></p><p><code>private transient Node lastWaiter;</code></p><p>åœ¨AQSä¸­conditioné˜Ÿåˆ—å¯ä»¥å­˜åœ¨å¤šä¸ªå¦‚ä¸‹æ‰€ç¤ºï¼Œä½†æ˜¯åŒæ­¥é˜Ÿåˆ—ä¹‹å¯èƒ½æ˜¯ä¸€ä¸ªï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŒæ­¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨é˜Ÿåˆ—ï¼Œè€Œç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘çš„é˜Ÿåˆ—ã€‚</p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210803142409623.png" alt="image-20210803142409623" style="zoom:33%;" /><p>ä¸‹é¢ä»awaitæ–¹æ³•å…¥æ‰‹æ¥å­¦ä¹ Conditionçš„æœºåˆ¶æ˜¯å¦‚ä½•è¿è½¬çš„ã€‚</p><h3 id="3-1-ç­‰å¾…await"><a href="#3-1-ç­‰å¾…await" class="headerlink" title="3.1 ç­‰å¾…await"></a>3.1 ç­‰å¾…await</h3><p><code>public class ConditionObject implements Condition</code></p><p>AQS#ConditionObjectå†…éƒ¨ç±»å®ç°äº†Conditionæ¥å£çš„awaitæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  <span class="comment">// å°†èŠ‚ç‚¹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">  <span class="comment">// è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹éœ€è¦é‡Šæ”¾lockè®©ç»™åˆ«çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// å¦‚æœèŠ‚ç‚¹ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ŒçŸ¥é“è¿›å…¥åŒæ­¥é˜Ÿåˆ—æˆ–è€…è¢«ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨awaitçš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡åœ¨ä¸Šé¢çš„whileå¾ªç¯ï¼ŒçŸ¥é“è¢«å”¤é†’æˆ–è€…ç›¸åº”ä¸­æ–­ï¼Œæ‰ä¼šæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•</span></span><br><span class="line">  <span class="comment">// è¿›å…¥åŒæ­¥é˜Ÿåˆ—å°è¯•è·å–lockï¼Œå’Œä¹‹å‰ä¸€æ ·ï¼Œä¸ºäº†é™åˆ¶ä¸€ç›´ç©ºè½¬ï¼Œä¼šåœ¨ç¬¬äºŒæ¬¡å¾ªç¯ä¹‹åï¼Œparkæ­¤èŠ‚ç‚¹ï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸­è½®åˆ°è¿™ä¸ªçº¿ç¨‹å‡ºé˜Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">      <span class="comment">// æ¸…é™¤æ‰å–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè¸¢å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">  <span class="comment">//å¤„ç†è¢«ä¸­æ–­çš„æƒ…å†µ</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AQS#addConditionWaiter</strong> <strong>æ·»åŠ èŠ‚ç‚¹åˆ°ç­‰å¾…é˜Ÿåˆ—</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•åº”è¯¥æ¯”è¾ƒå¥½ç†è§£å§ï¼Œå°±æ˜¯æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚</p><p>âš ï¸ è¿™é‡Œå’ŒæŠŠèŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—è¿˜æœ‰ç‚¹åŒºåˆ«ï¼Œä¸çŸ¥é“å¤§å®¶è¿˜æœ‰æ²¡æœ‰å°è±¡ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå…ˆåˆ¤æ–­tailæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸æ˜¯ç©ºï¼Œåˆ™ç›´æ¥æ·»åŠ ï¼›å¦‚æœæ˜¯ç©ºï¼Œåˆ™è°ƒç”¨äº†<code>enq(Node node)</code>æ–¹æ³•ï¼Œå…ˆç”Ÿæˆä¸€ä¸ªheadèŠ‚ç‚¹ï¼Œç„¶ååœ¨æŠŠå½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°åé¢ï¼Œå¾ªç¯äº†ä¸¤éçš„ã€‚</p><p>è¿™é‡Œæ˜¯ç›´æ¥åˆ›å»ºå½“å‰èŠ‚ç‚¹ï¼Œç„¶åå°†firstWaiteræŒ‡é’ˆæŒ‡å‘äº†nodeï¼›</p><p><strong>AQS#fullyRelease é‡Šæ”¾lock</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> savedState = getState();</span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿä¸éš¾ï¼Œæƒ³ä¸€ä¸‹ï¼Œçº¿ç¨‹éƒ½å·²ç»è°ƒç”¨awaitæ–¹æ³•äº†ï¼Œè€Œä¸”ä¸Šä¸€æ­¥å°±å·²ç»æŠŠèŠ‚ç‚¹æ·»åŠ åˆ°äº†ç­‰å¾…é˜Ÿåˆ—ä¸­äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦åšä»€ä¹ˆå‘¢ï¼Ÿé‚£è‚¯å®šæ˜¯é‡Šæ”¾é”lockäº†ã€‚å¯¹ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯åšè¿™ä¸ªçš„ã€‚releaseæ–¹æ³•ä¹‹å‰å·²ç»ä»‹ç»äº†ï¼Œæ— éå°±æ˜¯å¯¹stateåšä¸€ä¸‹å‡æ³•ï¼ŒæŠŠå¯¹æˆ˜çº¿ç¨‹æ¸…ç©ºä¸€ä¸‹ï¼Œç»™æ–°æ¥çš„çº¿ç¨‹è…¾åœ°æ–¹ã€‚</p><p><strong>ä¸‹é¢æ‰æ˜¯awaitçš„å…³é”®æ ¸å¿ƒä»£ç </strong>ï¼šâ€¼ï¸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">while (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(this);</span><br><span class="line">        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>isOnSyncQueue(node)</code>åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¸ªåˆ¤æ–­å‘¢ï¼ŸåŸå› å¾ˆç®€å•ï¼Œå½“åˆ«çš„çº¿ç¨‹æˆ–è€…è‡ªå·±è°ƒç”¨äº†signalæ–¹æ³•ä¹‹åï¼Œä¼šæŠŠå½“å‰èŠ‚ç‚¹è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è¯´æ˜ä»€ä¹ˆå‘¢ï¼Œè¯´æ˜æ¥ä¸‹æ¥è¿™ä¸ªçº¿ç¨‹è¦å»ç«äº‰é”äº†ï¼Œä¹Ÿå°±æ˜¯è¢«å”¤é†’äº†ï¼Œå½“ç«äº‰é”æˆåŠŸä¹‹åï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¯ä»¥awaitåé¢çš„æ–¹æ³•äº†ã€‚</p><p><code>(interruptMode = checkInterruptWhileWaiting(node)) != 0</code></p><p>å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™å¯ä»¥ç›´æ¥è·³å‡ºå¾ªç¯ï¼Œå»ç«äº‰é”ã€‚</p><h3 id="3-2-é€šçŸ¥signal"><a href="#3-2-é€šçŸ¥signal" class="headerlink" title="3.2 é€šçŸ¥signal"></a>3.2 é€šçŸ¥signal</h3><p><strong>è°ƒç”¨conditionçš„signalæˆ–è€…signalAllæ–¹æ³•å¯ä»¥å°†ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</strong>ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹èƒ½å¤Ÿæœ‰æœºä¼šè·å¾—lockã€‚æŒ‰ç…§ç­‰å¾…é˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„ï¼Œæ‰€ä»¥ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹å¿…ç„¶ä¼šæ˜¯ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡è°ƒç”¨conditionçš„signalæ–¹æ³•æ˜¯å°†å¤´èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚signalæ–¹æ³•æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1. å…ˆæ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å–lockï¼Œå¦‚æœæ²¡æœ‰è·å¾—é”ï¼Œè‚¯å®šæ˜¯è¯´ä¸é€šçš„</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">//2. è·å–ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹‹åçš„æ“ä½œéƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">Node first = firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>signalæ–¹æ³•é¦–å…ˆä¼šæ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»è·å–lockï¼Œå¦‚æœæ²¡æœ‰è·å–lockä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœè·å–çš„è¯å†å¾—åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å¤´æŒ‡é’ˆå¼•ç”¨çš„èŠ‚ç‚¹ï¼Œä¹‹åçš„æ“ä½œçš„doSignalæ–¹æ³•ä¹Ÿæ˜¯åŸºäºè¯¥èŠ‚ç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹doSignalæ–¹æ³•åšäº†äº›ä»€ä¹ˆäº‹æƒ…ã€‚</p><p><strong>AQS#doSignal</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//1. å°†å¤´ç»“ç‚¹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//2. whileä¸­transferForSignalæ–¹æ³•å¯¹å¤´ç»“ç‚¹åšçœŸæ­£çš„å¤„ç†</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">             (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼ŒçœŸæ­£å¯¹å¤´èŠ‚ç‚¹åšå¤„ç†çš„é€»è¾‘åœ¨<strong>transferForSignal</strong>æ”¾ï¼Œè¯¥æ–¹æ³•æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If cannot change waitStatus, the node has been cancelled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="comment">//1. æ›´æ–°çŠ¶æ€ä¸º0ï¼ŒåŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„èŠ‚ç‚¹çš„åˆå§‹çŠ¶æ€æ˜¯0</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Splice onto queue and try to set waitStatus of predecessor to</span></span><br><span class="line"><span class="comment">     * indicate that thread is (probably) waiting. If cancelled or</span></span><br><span class="line"><span class="comment">     * attempt to set waitStatus fails, wake up to resync (in which</span></span><br><span class="line"><span class="comment">     * case the waitStatus can be transiently and harmlessly wrong).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//2.å°†è¯¥èŠ‚ç‚¹ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­å»</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">  <span class="comment">// pèŠ‚ç‚¹æ˜¯nodeçš„å‰ç½®èŠ‚ç‚¹ï¼Œéœ€è¦å°†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNAL</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼Œè¿™æ®µä»£ç ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…</p><p>1.å°†å¤´ç»“ç‚¹çš„çŠ¶æ€æ›´æ”¹ä¸ºCONDITIONï¼›</p><p>2.è°ƒç”¨enqæ–¹æ³•ï¼Œå°†è¯¥èŠ‚ç‚¹å°¾æ’å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNAL</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š<strong>è°ƒç”¨conditionçš„signalçš„å‰ææ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹å·²ç»è·å–äº†lockï¼Œè¯¥æ–¹æ³•ä¼šä½¿å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹å³ç­‰å¾…æ—¶é—´æœ€é•¿çš„é‚£ä¸ªèŠ‚ç‚¹ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè€Œç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—åæ‰æœ‰æœºä¼šä½¿å¾—ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ï¼Œå³ä»awaitæ–¹æ³•ä¸­çš„LockSupport.park(this)æ–¹æ³•ä¸­è¿”å›ï¼Œä»è€Œæ‰æœ‰æœºä¼šä½¿å¾—è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æˆåŠŸé€€å‡º</strong>ã€‚</p><p><strong>signalAllæ–¹æ³•é€šçŸ¥æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</strong></p><p>sigllAllä¸sigalæ–¹æ³•çš„åŒºåˆ«ä½“ç°åœ¨doSignalAllæ–¹æ³•ä¸Šï¼Œå‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“doSignalæ–¹æ³•åªä¼šå¯¹ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œè€ŒdoSignalAllçš„æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignalAll</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    lastWaiter = firstWaiter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        Node next = first.nextWaiter;</span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">        transferForSignal(first);</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (first != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•åªä¸è¿‡æ—¶é—´ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ç§»å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå³â€œé€šçŸ¥â€å½“å‰è°ƒç”¨condition.await()æ–¹æ³•çš„æ¯ä¸€ä¸ªçº¿ç¨‹ã€‚</p><h2 id="é¢è¯•é¢˜-ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100"><a href="#é¢è¯•é¢˜-ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100" class="headerlink" title="é¢è¯•é¢˜ ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100"></a>é¢è¯•é¢˜ ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿é¡ºåºæ‰“å°1ï½100</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ibli.note;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitNotifyDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> Condition condition;</span><br><span class="line">    <span class="keyword">private</span> Lock lock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaitNotifyDemo</span><span class="params">(Condition condition, Lock lock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.condition = condition;</span><br><span class="line">        <span class="keyword">this</span>.lock = lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                condition.signal();</span><br><span class="line">                <span class="keyword">if</span> (count &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.err.println(Thread.currentThread().getName() + <span class="string">&quot; =&gt; &quot;</span> + count);</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    condition.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        Condition condition = lock.newCondition();</span><br><span class="line">        WaitNotifyDemo waitNotifyDemo = <span class="keyword">new</span> WaitNotifyDemo(condition, lock);</span><br><span class="line">        <span class="keyword">new</span> Thread(waitNotifyDemo).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(waitNotifyDemo).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://juejin.cn/post/6844903602419400718">https://juejin.cn/post/6844903602419400718</a></p><p><a href="https://juejin.cn/post/6844903654873382925">https://juejin.cn/post/6844903654873382925</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&quot;&gt;&lt;a href=&quot;#Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&quot;&gt;&lt;/a&gt;Lockæ¡†æ¶ä¸­çš„Conditionæœºåˆ¶&lt;/h1&gt;&lt;p&gt;è¿˜æ˜¯</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹æ·±å…¥ç†è§£ReentrantLock</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ReetrantLock/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ReetrantLock/</id>
    <published>2021-08-02T08:00:33.000Z</published>
    <updated>2021-08-03T03:54:52.341Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h1><p>ReentrantLocké‡å…¥é”ï¼Œæ˜¯å®ç°Lockæ¥å£çš„ä¸€ä¸ªç±»ï¼Œä¹Ÿæ˜¯åœ¨å®é™…ç¼–ç¨‹ä¸­ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ä¸€ä¸ªé”ï¼Œ<strong>æ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡</strong></p><h2 id="åŠ é”æ“ä½œ"><a href="#åŠ é”æ“ä½œ" class="headerlink" title="åŠ é”æ“ä½œ"></a>åŠ é”æ“ä½œ</h2><p><strong>æ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡</strong></p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802160050888.png" alt="image-20210802160050888" style="zoom:50%;" /><p>ä¸‹é¢ä»¥éå…¬å¹³é”çš„lockæ–¹æ³•ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ReentrantLockæºç çš„å®ç° ğŸ‘‡</p><h3 id="é¦–å…ˆæ˜¯lockæ–¹æ³•"><a href="#é¦–å…ˆæ˜¯lockæ–¹æ³•" class="headerlink" title="é¦–å…ˆæ˜¯lockæ–¹æ³•"></a>é¦–å…ˆæ˜¯lockæ–¹æ³•</h3><p>1ã€è¿›å…¥lockæ–¹æ³•é¦–å…ˆå¯¹è°ƒç”¨compareAndSetState(0,1)å»å°è¯•è·å–é”ï¼Œè¿™ä¸€ç‚¹æ­£æ˜¯ä½“ç°äº†éå…¬å¹³é”</p><p>2ã€å¦‚æœç¬¬ä¸€æ­¥æ²¡æœ‰è·å–åˆ°é”ï¼Œç„¶åæ‰§è¡Œç¬¬äºŒæ­¥acquire(1)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// éå…¬å¹³é”</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>lockæ–¹æ³•é¦–å…ˆä¼šå»casä¿®æ”¹AQSçš„stateçŠ¶æ€ï¼Œç‹¬å é”æ¨¡å¼ä¸‹stateå¢åŠ 1è¡¨ç¤ºè·å–é”æˆåŠŸï¼›stateè®¾ç½®æˆåŠŸä¹‹åï¼Œéœ€è¦å°†ç‹¬å çº¿ç¨‹å­—æ®µè®¾ç½®æˆå½“å‰çº¿ç¨‹ï¼š<code>exclusiveOwnerThread = thread;</code></p><h3 id="AQS-acquire-1"><a href="#AQS-acquire-1" class="headerlink" title="AQS#acquire(1)"></a>AQS#acquire(1)</h3><p>å¦‚æœæ²¡æœ‰æŠ¢å åˆ°é”ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸‹é¢çš„acquireæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨AQSç±»ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">            selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tryAcquireæ–¹æ³•æ˜¯åœ¨å­ç±»å®ç°çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ReentrantLockçš„nonfairTryAcquireï¼Œä¹Ÿå°±æ˜¯éå…¬å¹³é”çš„å®ç°ã€‚</p><h3 id="nonfairTryAcquire-int-acquires-æ–¹æ³•"><a href="#nonfairTryAcquire-int-acquires-æ–¹æ³•" class="headerlink" title="nonfairTryAcquire(int acquires)æ–¹æ³•"></a>nonfairTryAcquire(int acquires)æ–¹æ³•</h3><p>ä¸‹é¢æ˜¯ReentrantLockï¼Œéå…¬å¹³é”çš„lockå®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">            <span class="keyword">int</span> c = getState();</span><br><span class="line">  <span class="comment">// è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">  <span class="comment">// é”å†²å…¥</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>int c = getState() == 0 åˆ™è¡¨ç¤ºæ²¡æœ‰çº¿ç¨‹å æœ‰é”ï¼Œå½“å‰çº¿ç¨‹æ¥åŠ é”æ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨caså°è¯•è·å–é”ã€‚</p><p>current == getExclusiveOwnerThread() è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰çº¿ç¨‹é”äº†ï¼Œ<code> int nextc = c + acquires;</code>åˆ™è¡¨ç¤ºæ”¯æŒé”é‡å…¥ï¼Œnextcçš„å€¼åˆ™è¡¨ç¤ºé”é‡å…¥çš„æ¬¡æ•°ï¼›</p><p>ä»¥ä¸Šå¦‚æœæ²¡æœ‰åŠ é”æˆåŠŸï¼Œåˆ™è¿”å›falseï¼Œç„¶åæ‰§è¡ŒAQSçš„acquireQueueæ–¹æ³•ï¼Œé¦–å…ˆå°†å½“å‰èŠ‚ç‚¹å°è£…æˆ<code>addWaiter(Node.EXCLUSIVE), arg)</code> æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶åˆ¤æ–­å¤´èŠ‚ç‚¹æ˜¯å¦è·å–é”æˆåŠŸï¼Œå¦‚æœæˆåŠŸäº†ï¼Œå°†å½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°å¤´ä¸Šï¼›</p><h3 id="AQS-addWaiter-Node-mode"><a href="#AQS-addWaiter-Node-mode" class="headerlink" title="AQS#addWaiter(Node mode)"></a>AQS#addWaiter(Node mode)</h3><p>æ·»åŠ èŠ‚ç‚¹åˆ°é˜Ÿåˆ—ä¸­ï¼ŒNode.EXCLUSIVEç‹¬å é”ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯<strong>å°¾æ’æ³•</strong>ï¼Œåœ¨é˜Ÿåˆ—çš„é˜Ÿå°¾æ·»åŠ æ–°çš„èŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸æ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç©ºçš„ï¼Œåˆ™è°ƒç”¨enqæ–¹æ³•ï¼Œåˆ›å»ºé˜Ÿåˆ—ï¼Œå¹¶æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-enq-final-Node-node"><a href="#AQS-enq-final-Node-node" class="headerlink" title="AQS#enq(final Node node)"></a>AQS#enq(final Node node)</h3><p>ç¬¬ä¸€ä¸ªçº¿ç¨‹è·å–é”çš„æ—¶å€™ï¼Œè‚¯å®šæ˜¯æ— é”çš„çŠ¶æ€ï¼Œæ ¹æœ¬èµ°ä¸åˆ°è¿™ä¸€æ­¥ï¼Œæœ€æ—©èµ°åˆ°è¿™é‡Œçš„æ˜¯ç¬¬äºŒä¸ªå»è·å–é”çš„çº¿ç¨‹ã€‚</p><p>å½“ç¬¬äºŒä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°è¯¥æ–¹æ³•æ˜¯éœ€è¦æ‰§è¡Œ<strong>ä¸¤æ¬¡å¾ªç¯</strong>ï¼š</p><p>1ã€t == nullæ—¶ï¼Œéœ€è¦åˆå§‹åŒ–é˜Ÿåˆ—</p><p>2ã€æ‰§è¡Œä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå°†nodeæ·»åŠ åˆ°tail,ç”±äºè¿™ä¸ªæ–¹æ³•è¿˜æ˜¯å¤„åœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„ï¼Œæ‰€ä»¥ï¼Œè®¾ç½®é˜Ÿå°¾çš„æ—¶å€™è¿˜æ˜¯éœ€è¦casæ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-acquireQueued-final-Node-node-int-arg"><a href="#AQS-acquireQueued-final-Node-node-int-arg" class="headerlink" title="AQS#acquireQueued(final Node node, int arg)"></a>AQS#acquireQueued(final Node node, int arg)</h3><p><font color=red>è¿™ä¸ªæ–¹æ³•ç»å¯¹æ˜¯ç»å¯¹çš„AQSæ ¸å¿ƒæ–¹æ³•Â </font> â€¼ï¸</p><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æœ‰3ä¸ªé‡è¦æ“ä½œï¼š</p><p>1ã€åˆ¤æ–­å‰ç½®èŠ‚ç‚¹æ˜¯ä¸æ˜¯headï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå»å°è¯•è·å–é”ï¼›</p><p>2ã€å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸æ˜¯headï¼Œè¦æŠŠå‰ç½®èŠ‚ç‚¹çš„waitStateè®¾ç½®æˆSIGNALï¼ŒåŒæ—¶parkå½“å‰çº¿ç¨‹ï¼Œé¿å…ä¸€ç›´ç©ºè½¬ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ç”¨çš„  for (;;) {}</p><p>3ã€å¦‚æœè·å–é”å’Œparkéƒ½å¤±è´¥äº†ï¼Œåˆ™æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®æˆcancelçŠ¶æ€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-cancelAcquire-Node-node"><a href="#AQS-cancelAcquire-Node-node" class="headerlink" title="AQS.cancelAcquire(Node node)"></a>AQS.cancelAcquire(Node node)</h3><p><code>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒéš¾ç†è§£ï¼Œæ€»ç»“ä¸€ä¸‹å°±å¹²äº†ä¸‹é¢å‡ ä¸ªäº‹ï¼š</code></p><p>1ã€æ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•çš„nodeè‚¯å®šæ˜¯è¦å–æ¶ˆçš„ï¼Œé‚£ä¸ªéœ€è¦threadè®¾ç½®æˆnull</p><p>2ã€æŸ¥çœ‹å½“å‰èŠ‚ç‚¹ä¹‹å‰çš„èŠ‚ç‚¹æœ‰æ²¡æœ‰æ˜¯å–æ¶ˆçŠ¶æ€çš„ï¼Œä¸€èµ·è¸¢å‡ºé˜Ÿåˆ—</p><p>3ã€æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®æˆNode.CANCELLEDçŠ¶æ€</p><p>4ã€åˆ¤æ–­nodeåœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®ï¼Œå¦‚æœæ˜¯é˜Ÿå°¾çš„è¯ï¼ŒæŠŠtailæŒ‡å‘nodeçš„å‰ç½®èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠå‰é©±èŠ‚ç‚¹çš„nextæŒ‡å‘null</p><p>5ã€å¦‚æœä¸æ˜¯tailèŠ‚ç‚¹ï¼Œé‚£ä¹ˆåˆ¤æ–­æ˜¯ä¸æ˜¯headï¼Œå¦‚æœä¸æ˜¯headï¼Œé‚£ä¹ˆï¼Œå°†nodeçš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆNode.SIGNALï¼Œå¹¶ä¸”æŠŠnodeçš„å‰é©±èŠ‚ç‚¹nodeçš„nextèŠ‚ç‚¹</p><p>6ã€å¦‚æœnodeæ˜¯headèŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥unparkæ­¤çº¿ç¨‹å»æ‰§è¡Œacquire</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Ignore if node doesn&#x27;t exist</span></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Skip cancelled predecessors</span></span><br><span class="line">        Node pred = node.prev;</span><br><span class="line">        <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>) <span class="comment">//cancelled</span></span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// predNext is the apparent node to unsplice. CASes below will</span></span><br><span class="line">        <span class="comment">// fail if not, in which case, we lost race vs another cancel</span></span><br><span class="line">        <span class="comment">// or signal, so no further action is necessary.</span></span><br><span class="line">        Node predNext = pred.next;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can use unconditional write instead of CAS here.</span></span><br><span class="line">        <span class="comment">// After this atomic step, other Nodes can skip past us.</span></span><br><span class="line">        <span class="comment">// Before, we are free of interference from other threads.</span></span><br><span class="line">        node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we are the tail, remove ourselves.</span></span><br><span class="line">        <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">            compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If successor needs signal, try to set pred&#x27;s next-link</span></span><br><span class="line">            <span class="comment">// so it will get one. Otherwise wake it up to propagate.</span></span><br><span class="line">            <span class="keyword">int</span> ws;</span><br><span class="line">            <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">                ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">                 (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">                pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// ifæ‰§è¡Œçš„é€»è¾‘æ˜¯æŠŠå‰ç½®èŠ‚ç‚¹è®¾ç½®æˆNode.SIGNAL</span></span><br><span class="line">                Node next = node.next;</span><br><span class="line">                <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                  <span class="comment">// æŠŠnodeçš„å‰ç½®å‰ç½®èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘nodeçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå› ä¸ºä¸Šé¢nodeå·²ç»æ˜¯Node.CANCELLEDçŠ¶æ€äº†ï¼Œéœ€è¦è¸¢å‡ºé˜Ÿåˆ—</span></span><br><span class="line">                    compareAndSetNext(pred, predNext, next);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å‰ç½®èŠ‚ç‚¹æ˜¯headï¼Œæ­¤æ—¶æ²¡æœ‰è¢«äººç«äº‰é”èµ„æºï¼Œç›´æ¥å”¤é†’å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            node.next = node; <span class="comment">// help GC</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä»¥ReentrantLockçš„éå…¬å¹³é”ä¸ºä¾‹å­¦ä¹ äº†ä¸€ä¸‹ReentrantLockåŠ é”çš„è¿‡ç¨‹ã€‚é‚£ä¹ˆæ€è€ƒä¸€ä¸‹å…¬å¹³é”å’Œéå…¬å¹³é”çš„æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼ŸğŸ¤”</p><p>ç†è§£äº†ä¸Šé¢çš„æµç¨‹ä¹‹åï¼Œä¸‹é¢ç›´æ¥æ¯”è¾ƒæºç éå¾ˆå¥½ç†è§£ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ï¼</p><h2 id="å…¬å¹³é”å’Œéå…¬å¹³é”"><a href="#å…¬å¹³é”å’Œéå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”å’Œéå…¬å¹³é”"></a>å…¬å¹³é”å’Œéå…¬å¹³é”</h2><p>å¦‚ä½•åˆ¶å®šReentarntLockçš„å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çœ‹äº†NonfairSync#lockçš„å®ç°ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹FairSync#lockçš„å®ç°ï¼šğŸ‘‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3000897897090466540L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fair version of tryAcquire.  Don&#x27;t grant access unless</span></span><br><span class="line"><span class="comment">     * recursive call or no waiters or is first.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FairSyncå’ŒNonfairSyncéƒ½æ˜¯ReentrantLockçš„é™æ€å†…éƒ¨ç±»ï¼Œåœ¨FairSyncçš„lockæ–¹æ³•ä¸­ï¼Œæ²¡æœ‰ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">   setExclusiveOwnerThread(Thread.currentThread());</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç›´æ¥è°ƒç”¨AQS#acquire(1)æ–¹æ³•ï¼Œè€Œä¸”åœ¨ReentrantLock#FairSync#FairSync(int acquires)çš„å®ç°ä¸­ï¼Œæ·»åŠ äº†ä¸€ä¸ªåˆ¤æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">               compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">               setExclusiveOwnerThread(current);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯<code>hasQueuedPredecessors</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰èŠ‚ç‚¹åœ¨ç­‰å¾…ï¼Œå¦‚æœæœ‰çš„è¯ï¼ŒReentrantLock#FairSync#FairSync(int acquires)ç›´æ¥è¿”å›falseï¼Œå½“å‰èŠ‚ç‚¹æ™ºèƒ½è¿›å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™ä¸¤ç‚¹å°±æ˜¯å…¬å¹³é”å’Œéå…¬å¹³é”çš„æ˜æ˜¾åŒºåˆ«ä½“ç°ã€‚</p><h2 id="é‡Šæ”¾é”æ“ä½œ"><a href="#é‡Šæ”¾é”æ“ä½œ" class="headerlink" title="é‡Šæ”¾é”æ“ä½œ"></a>é‡Šæ”¾é”æ“ä½œ</h2><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802205517221.png" alt="image-20210802205517221"></p><h3 id="unlock"><a href="#unlock" class="headerlink" title="unlock()"></a>unlock()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AQS-release-int-arg"><a href="#AQS-release-int-arg" class="headerlink" title="AQS#release(int arg)"></a>AQS#release(int arg)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tryReleaseçš„å…·ä½“å®ç°ä»æ˜¯æœ‰å…·ä½“çš„å­ç±»æ¥å®ç°çš„ã€‚</p><h3 id="ReentrantLock-tryRelease-int-releases-æ–¹æ³•"><a href="#ReentrantLock-tryRelease-int-releases-æ–¹æ³•" class="headerlink" title="ReentrantLock#tryRelease(int releases)æ–¹æ³•"></a>ReentrantLock#tryRelease(int releases)æ–¹æ³•</h3><p>1ã€é‡Šæ”¾é”çš„é€»è¾‘åº”è¯¥æ¯”è¾ƒå¥½ç†è§£ï¼Œæ˜¯å°†stateåšå‡æ³•ã€‚</p><p>2ã€åˆ¤æ–­state == 0 , åˆ™è¡¨ç¤ºæ— é”çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯0ï¼Œåˆ™è¡¨ç¤ºè¿˜åœ¨çº¿ç¨‹é‡å…¥çš„çŠ¶æ€ä¸‹ï¼ŒåŒæ—¶è®¾ç½®state</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼Œè®¾ç½®stateçš„æ—¶å€™æ˜¯ç›´æ¥èµ‹å€¼çš„ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨casï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(<span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">    state = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è€ƒè™‘åˆ°ä¸Šä¸‹æ–‡å°±å¾ˆç®€å•äº†ï¼Œæ­¤æ—¶è®¾ç½®stateçš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§çŠ¶æ€ï¼Œæ— é”å’Œé‡å…¥é”ï¼Œè‚¯å®šä¸ä¼šæ˜¯å¤šçº¿ç¨‹çš„åœºæ™¯ã€‚æ‰€ä»¥ä¸éœ€è¦casæ“ä½œã€‚</p><p>æ¥ç€åˆ†æä¸Šé¢çš„AQS#releaseæ–¹æ³•:</p><p>å½“stateè®¾ç½®æˆåŠŸä¹‹åï¼Œéœ€è¦åˆ¤æ–­headèŠ‚ç‚¹ï¼Œç„¶åå”¤é†’headçš„åé©±èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œå¦‚æœå­˜åœ¨çš„è¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// è¿™é‡Œæ˜¯å…±äº«é”ï¼Œåœ¨ReentarntLockå…ˆè·³è¿‡</span></span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="tryLock-long-time-TimeUnit-unit"><a href="#tryLock-long-time-TimeUnit-unit" class="headerlink" title="tryLock(long time, TimeUnit unit)"></a>tryLock(long time, TimeUnit unit)</h2><p><strong>æ–¹æ³•æè¿°å¦‚ä¸‹ï¼š</strong><br><font color=blue>åœ¨ç»™å®šçš„ç­‰å¾…æ—¶é—´å†…å¹¶ä¸”çº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­ä»¥åŠé”å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œå»è·å–é”ã€‚</font><br>å¦‚æœé”å¯ç”¨ï¼Œæ–¹æ³•ä¼šç›´æ¥è¿”å›ã€‚<br>å¦‚æœé”ä¸å¯ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹å°†ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€ä»¥è¾¾åˆ°çº¿ç¨‹è°ƒåº¦ç›®çš„ï¼Œå¹¶ä¸”ä¼‘çœ ç›´åˆ°ä¸‹é¢ä¸‰ä¸ªäº‹ä»¶ä¸­çš„ä¸€ä¸ªå‘ç”Ÿï¼š<br>â‘ ã€å½“å‰çº¿ç¨‹è·å–åˆ°é”<br>â‘¡ã€å…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹<br>â‘¢ã€æŒ‡å®šçš„ç­‰å¾…æ—¶é—´å·²è¿‡<br>å‡å¦‚å½“å‰çº¿ç¨‹ï¼š<br>åœ¨è¯¥æ–¹æ³•çš„æ¡ç›®ä¸Šè®¾ç½®å…¶ä¸­æ–­çŠ¶æ€æˆ–åœ¨è·å–é”æ—¶ä¸­æ–­ï¼Œå¹¶ä¸”æ”¯æŒé”è·å–ä¸­æ–­æ—¶ï¼Œå°†æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œå½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€ä¼šè¢«æ¸…é™¤ã€‚<br>å‡å¦‚ç»™å®šçš„ç­‰å¾…æ—¶é—´å·²è¿‡ï¼Œå°†ä¼šè¿”å›falseã€‚</p><p>ä¸‹é¢å…·ä½“é˜…è¯»æºç å®ç°,æ–¹æ³•çš„å…¥å‚æŒ‡å®šäº†ç­‰å¾…æ—¶é—´ï¼Œå’Œæ—¶é—´çš„å•ä½ï¼Œæœ‰<code>NANOSECONDS</code>ã€<code>MICROSECONDS</code>ã€<code>MILLISECONDS</code>ã€<code>SECONDS</code>â€¦ç­‰å•ä½ã€‚</p><p>ä¸‹é¢å…·ä½“é˜…è¯»æºç å®ç°,æ–¹æ³•çš„å…¥å‚æŒ‡å®šäº†ç­‰å¾…æ—¶é—´ï¼Œå’Œæ—¶é—´çš„å•ä½ï¼Œæœ‰<code>NANOSECONDS</code>ã€<code>MICROSECONDS</code>ã€<code>MILLISECONDS</code>ã€<code>SECONDS</code>â€¦ç­‰å•ä½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(timeout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•çš„å†…éƒ¨è°ƒç”¨äº†<code>Sync</code>çš„<code>tryAcquireNanos</code>ï¼Œç»§ç»­å¾€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquireNanos</span><span class="params">(<span class="keyword">int</span> arg, <span class="keyword">long</span> nanosTimeout)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­ä¸­æ–­çŠ¶æ€å¹¶å†³å®šæ˜¯å¦æŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è°ƒç”¨doAcquireNanosè¿›è¡Œç­‰å¾…</span></span><br><span class="line">    <span class="keyword">return</span> tryAcquire(arg) ||</span><br><span class="line">        doAcquireNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tryAcqure</code>å’Œä¹‹å‰åˆ†æçš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œä¸å†èµ˜è¿°ã€‚<br>æ¥ä¸‹æ¥æ˜¯<code>doAcquireNanos</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">doAcquireNanos</span><span class="params">(<span class="keyword">int</span> arg, <span class="keyword">long</span> nanosTimeout)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœç»™å®šçš„æ—¶é—´å€¼å°äºç­‰äº0ï¼Œåˆ™ç›´æ¥è¿”å›false</span></span><br><span class="line">    <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//æ ¹æ®ç»™å®šå‚æ•°è®¡ç®—æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deadline = System.nanoTime() + nanosTimeout;</span><br><span class="line">    <span class="comment">//å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°CLHç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="comment">//åˆå§‹å¤±è´¥æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åœ¨ç»™å®šæ—¶é—´å†…å¾ªç¯/è‡ªæ—‹å°è¯•è·å–é”</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//å–å‡ºå‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">//å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸ºé¦–èŠ‚ç‚¹ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC å‰é¦–èŠ‚ç‚¹å‡ºé˜Ÿï¼Œå¸®åŠ©GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åˆ¤æ–­æ˜¯å¦ç­‰å¾…è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™è¿”å›false</span></span><br><span class="line">            nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//è¿™é‡Œåˆ¤æ–­æ˜¯å¦å¯ä»¥é˜»å¡çº¿ç¨‹å¹¶åšç›¸åº”æ“ä½œï¼Œè·Ÿä¹‹å‰åˆ†æçš„å‡ ä¸ªæ–¹æ³•ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡Œçš„é˜»å¡å¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¹¶ä¸”æ˜¯åœ¨æœ‰é™æ—¶é—´å†…é˜»å¡ï¼Œç±»ä¼¼äºsleep</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                nanosTimeout &gt; spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(<span class="keyword">this</span>, nanosTimeout);</span><br><span class="line">            <span class="comment">//åˆ¤æ–­ä¸­æ–­çŠ¶æ€ï¼Œå¹¶å†³å®šæ˜¯å¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>doAcquireNanos</code>çš„é˜»å¡æ˜¯æœ‰æ—¶é—´é™åˆ¶çš„ï¼Œæ‰€ä»¥èƒ½åœ¨ç»™å®šçš„æ—¶é—´å†…ï¼Œè¿”å›è·å–é”çš„æ“ä½œç»“æœã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://juejin.cn/post/6870099231361728525">https://juejin.cn/post/6870099231361728525</a></p><p><a href="https://www.processon.com/view/5f047c16f346fb1ae598b4dd?fromnew=1">https://www.processon.com/view/5f047c16f346fb1ae598b4dd?fromnew=1</a></p><p><a href="https://www.imooc.com/article/51118">https://www.imooc.com/article/51118</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ReentrantLock&quot;&gt;&lt;a href=&quot;#ReentrantLock&quot; class=&quot;headerlink&quot; title=&quot;ReentrantLock&quot;&gt;&lt;/a&gt;ReentrantLock&lt;/h1&gt;&lt;p&gt;ReentrantLocké‡å…¥é”ï¼Œæ˜¯å®ç°Lockæ¥å£</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¹¶å‘ç¼–ç¨‹ä¹‹AQSåº•å±‚å®ç°ä¸åŸç†</title>
    <link href="http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BAQS%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%8E%9F%E7%90%86/"/>
    <id>http://example.com/wiki/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8BAQS%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%8E%9F%E7%90%86/</id>
    <published>2021-08-02T07:17:07.000Z</published>
    <updated>2021-08-03T01:45:36.985Z</updated>
    
    <content type="html"><![CDATA[<p>AQSé”é™æ—¶ç­‰å¾…æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p><p>å…¬å¹³é”ä¸éå…¬å¹³é”æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</p><h1 id="ç‹¬å é”-amp-å…±äº«é”"><a href="#ç‹¬å é”-amp-å…±äº«é”" class="headerlink" title="ç‹¬å é”&amp;å…±äº«é”"></a>ç‹¬å é”&amp;å…±äº«é”</h1><h2 id="ç‹¬å é”"><a href="#ç‹¬å é”" class="headerlink" title="ç‹¬å é”"></a>ç‹¬å é”</h2><p>å³åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ï¼Œå½“è¿™ä¸ªçº¿ç¨‹è¿˜æ²¡æœ‰é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯è·å–ä¸äº†çš„ï¼Œåªèƒ½åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè¿›è¡Œç­‰å¾…ã€‚</p><h1 id="å…¬å¹³é”-amp-éå…¬å¹³é”"><a href="#å…¬å¹³é”-amp-éå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”&amp;éå…¬å¹³é”"></a>å…¬å¹³é”&amp;éå…¬å¹³é”</h1><h2 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h2><p><strong>å…¬å¹³ç­–ç•¥ï¼š</strong>åœ¨å¤šä¸ªçº¿ç¨‹äº‰ç”¨é”çš„æƒ…å†µä¸‹ï¼Œå…¬å¹³ç­–ç•¥å€¾å‘äºå°†è®¿é—®æƒæˆäºˆç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç›¸å½“äºæœ‰ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼Œå…ˆè¿›å…¥ç­‰å¾…é˜Ÿåˆ—çš„çº¿ç¨‹åç»­ä¼šå…ˆè·å¾—é”ï¼Œè¿™æ ·æŒ‰ç…§â€œå…ˆæ¥ååˆ°â€çš„åŸåˆ™ï¼Œå¯¹äºæ¯ä¸€ä¸ªç­‰å¾…çº¿ç¨‹éƒ½æ˜¯å…¬å¹³çš„ã€‚</p><h2 id="éå…¬å¹³é”"><a href="#éå…¬å¹³é”" class="headerlink" title="éå…¬å¹³é”"></a>éå…¬å¹³é”</h2><p>åœ¨å¤šä¸ªçº¿ç¨‹äº‰ç”¨é”çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿæœ€ç»ˆè·å¾—é”çš„çº¿ç¨‹æ˜¯éšæœºçš„ï¼ˆç”±åº•å±‚OSè°ƒåº¦ï¼‰ã€‚</p><blockquote><p><em>æ³¨æ„ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…¬å¹³ç­–ç•¥çš„ç¨‹åºåœ¨å¤šçº¿ç¨‹è®¿é—®æ—¶ï¼Œæ€»ä½“ååé‡ï¼ˆå³é€Ÿåº¦å¾ˆæ…¢ï¼Œå¸¸å¸¸æå…¶æ…¢ï¼‰æ¯”è¾ƒä½ï¼Œå› ä¸ºæ­¤æ—¶åœ¨çº¿ç¨‹è°ƒåº¦ä¸Šé¢çš„å¼€é”€æ¯”è¾ƒå¤§ã€‚</em></p></blockquote><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802175827435.png" alt="image-20210802175827435" style="zoom:50%;" /><h1 id="AQSæ˜¯ä»€ä¹ˆ"><a href="#AQSæ˜¯ä»€ä¹ˆ" class="headerlink" title="AQSæ˜¯ä»€ä¹ˆ"></a>AQSæ˜¯ä»€ä¹ˆ</h1><p>åŒæ­¥å™¨æ˜¯ç”¨æ¥æ„å»ºé”å’Œå…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒçš„å®ç°ä¸»è¦ä¾èµ–äºä¸€ä¸ªintç±»å‹çš„æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ä»¥åŠä¸€ä¸ªFIFOé˜Ÿåˆ—æ„å»ºç­‰å¾…é˜Ÿåˆ—ã€‚å®ƒçš„å­ç±»å¿…é¡»é‡å†™AQSå®šä¹‰çš„å‡ ä¸ªprotectedä¿®é¥°çš„ç”¨æ¥æ”¹å˜åŒæ­¥çŠ¶æ€çš„æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•ä¸»è¦æ˜¯ç”¨æ¥å®ç°æ’é˜Ÿå’Œé˜»å¡æœºåˆ¶çš„ã€‚</p><p>åŒæ­¥å™¨æ˜¯å®ç°é”çš„å…³é”®ï¼Œåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨ï¼Œåˆ©ç”¨åŒæ­¥å™¨å®ç°é”çš„è¯­ä¹‰ï¼Œå¯ä»¥è¿™æ ·ç†è§£ä¸¤è€…çš„å…³ç³»ï¼š</p><p>é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…å’Œé”äº¤äº’çš„æ¥å£ï¼Œéšè—äº†å®ç°çš„ç»†èŠ‚ï¼ŒåŒæ­¥å™¨æ˜¯é¢å‘é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼Œçº¿ç¨‹çš„æ’é˜Ÿï¼Œç­‰å¾…å’Œå”¤é†’ç­‰åº•å±‚æ“ä½œã€‚</p><p><strong>AQSçš„è®¾è®¡æ˜¯ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œå®ƒå°†ä¸€ä¸ªæ–¹æ³•å¼€æ”¾ç»™å­ç±»é‡å†™ï¼Œè€ŒåŒæ­¥å™¨ç»™åŒæ­¥ç»„ä»¶æ‰€æä¾›çš„æ¨¡ç‰ˆæ–¹æ³•åˆä¼šé‡æ–°è°ƒç”¨å­ç±»æ‰€é‡å†™çš„æ–¹æ³•ã€‚</strong></p><h1 id="AQSæ ¸å¿ƒæ€æƒ³"><a href="#AQSæ ¸å¿ƒæ€æƒ³" class="headerlink" title="AQSæ ¸å¿ƒæ€æƒ³"></a>AQSæ ¸å¿ƒæ€æƒ³</h1><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚</p><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶AQSæ˜¯ç”¨CLHé˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚</p><p>1ã€AQSä½¿ç”¨ä¸€ä¸ªintæˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€</p><p>2ã€ä½¿ç”¨Nodeå®ç°FIFOé˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨äºæ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥è£…ç½®</p><p>AQSèµ„æºå…±äº«æ–¹å¼ï¼šç‹¬å Exclusiveï¼ˆæ’å®ƒé”æ¨¡å¼ï¼‰å’Œå…±äº«Shareï¼ˆå…±äº«é”æ¨¡å¼ï¼‰</p><blockquote><p>AQSå®ƒçš„æ‰€æœ‰å­ç±»ä¸­ï¼Œè¦ä¹ˆå®ç°å¹¶ä½¿ç”¨äº†å®ƒçš„ç‹¬å åŠŸèƒ½çš„apiï¼Œè¦ä¹ˆä½¿ç”¨äº†å…±äº«é”çš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šåŒæ—¶ä½¿ç”¨ä¸¤å¥—apiï¼Œå³ä¾¿æ˜¯æœ€æœ‰åçš„å­ç±»ReentrantReadWriteLockä¹Ÿæ˜¯é€šè¿‡ä¸¤ä¸ªå†…éƒ¨ç±»è¯»é”å’Œå†™é”åˆ†åˆ«å®ç°äº†ä¸¤å¥—apiæ¥å®ç°çš„</p></blockquote><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802175542181.png" alt="image-20210802175542181" style="zoom:50%;" /><h2 id="stateçŠ¶æ€"><a href="#stateçŠ¶æ€" class="headerlink" title="stateçŠ¶æ€"></a>stateçŠ¶æ€</h2><p>stateçŠ¶æ€ä½¿ç”¨volatile intç±»å‹çš„å˜é‡ï¼Œè¡¨ç¤ºå½“å‰åŒæ­¥çŠ¶æ€ã€‚stateçš„è®¿é—®æ–¹å¼æœ‰ä¸‰ç§:</p><p><code>getState()</code><br> <code>setState()</code><br> <code>compareAndSetState()</code></p><h2 id="Nodeå†…éƒ¨ç±»"><a href="#Nodeå†…éƒ¨ç±»" class="headerlink" title="Nodeå†…éƒ¨ç±»"></a>Nodeå†…éƒ¨ç±»</h2><p>Nodeç±»æ˜¯AQSçš„ç»å¯¹æ ¸å¿ƒç±»ï¼ŒAQSåŸºäºNodeæ¥æ„å»ºåŒæ­¥é˜Ÿåˆ—å’ŒConditioné˜Ÿåˆ—ï¼›</p><p><strong>æºç å¦‚ä¸‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** Marker to indicate a node is waiting in shared mode */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">        <span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/** waitStatus value to indicate successor&#x27;s thread needs unparking */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment">         * unconditionally propagate</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line">        <span class="keyword">volatile</span> Node prev;</span><br><span class="line">        <span class="keyword">volatile</span> Node next;</span><br><span class="line">        <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">        Node nextWaiter;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Returns true if node is waiting in shared mode.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// è·å–å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">        <span class="function"><span class="keyword">final</span> Node <span class="title">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">            Node p = prev;</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node() &#123;    <span class="comment">// Used to establish initial head or SHARED marker</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">            <span class="keyword">this</span>.nextWaiter = mode;</span><br><span class="line">            <span class="keyword">this</span>.thread = thread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Node(Thread thread, <span class="keyword">int</span> waitStatus) &#123; <span class="comment">// Used by Condition</span></span><br><span class="line">            <span class="keyword">this</span>.waitStatus = waitStatus;</span><br><span class="line">            <span class="keyword">this</span>.thread = thread;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>CANCELLED</strong><br> waitStatuså€¼ä¸º1æ—¶è¡¨ç¤ºè¯¥çº¿ç¨‹èŠ‚ç‚¹å·²é‡Šæ”¾ï¼ˆè¶…æ—¶ã€ä¸­æ–­ï¼‰ï¼Œå·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸ä¼šå†é˜»å¡ã€‚</p><p><strong>SIGNAL</strong><br> waitStatusä¸º-1æ—¶è¡¨ç¤ºè¯¥çº¿ç¨‹çš„åç»­çº¿ç¨‹éœ€è¦é˜»å¡ï¼Œå³åªè¦å‰ç½®èŠ‚ç‚¹é‡Šæ”¾é”ï¼Œå°±ä¼šé€šçŸ¥æ ‡è¯†ä¸º SIGNAL çŠ¶æ€çš„åç»­èŠ‚ç‚¹çš„çº¿ç¨‹</p><p><strong>CONDITION</strong><br> waitStatusä¸º-2æ—¶ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹åœ¨conditioné˜Ÿåˆ—ä¸­é˜»å¡ï¼ˆConditionæœ‰ä½¿ç”¨ï¼‰</p><p><strong>PROPAGATE</strong><br> waitStatusä¸º-3æ—¶ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹ä»¥åŠåç»­çº¿ç¨‹è¿›è¡Œæ— æ¡ä»¶ä¼ æ’­ï¼ˆCountDownLatchä¸­æœ‰ä½¿ç”¨ï¼‰å…±äº«æ¨¡å¼ä¸‹ï¼Œ PROPAGATE çŠ¶æ€çš„çº¿ç¨‹å¤„äºå¯è¿è¡ŒçŠ¶æ€</p><h1 id="AQSä¹‹ç‹¬å -éå…¬å¹³"><a href="#AQSä¹‹ç‹¬å -éå…¬å¹³" class="headerlink" title="AQSä¹‹ç‹¬å +éå…¬å¹³"></a>AQSä¹‹ç‹¬å +éå…¬å¹³</h1><h2 id="è·å–é”acquire"><a href="#è·å–é”acquire" class="headerlink" title="è·å–é”acquire"></a>è·å–é”acquire</h2><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802195409121.png" alt="image-20210802195409121" style="zoom:50%;" /><p>ReentrantLockæ˜¯AQSç‹¬å æ¨¡å¼çš„ç»å…¸å®ç°ï¼ŒReentrantLockåœ¨æ„é€ å®ä¾‹æ˜¯å¯ä»¥æŒ‡å®šæ˜¯å¦æ˜¯fair lockã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates an instance of &#123;<span class="doctag">@code</span> ReentrantLock&#125; with the</span></span><br><span class="line"><span class="comment">    * given fairness policy.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fair &#123;<span class="doctag">@code</span> true&#125; if this lock should use a fair ordering policy</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">       sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="acquireæ–¹æ³•è·å–è®¸å¯"><a href="#acquireæ–¹æ³•è·å–è®¸å¯" class="headerlink" title="acquireæ–¹æ³•è·å–è®¸å¯"></a>acquireæ–¹æ³•è·å–è®¸å¯</h3><p>ä¸‹é¢æˆ‘ä»¬å°±ä»é”çš„è·å–å…¥æ‰‹å¼€å§‹è§£è¯»AQSï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="tryAcquireæŠ½è±¡æ–¹æ³•"><a href="#tryAcquireæŠ½è±¡æ–¹æ³•" class="headerlink" title="tryAcquireæŠ½è±¡æ–¹æ³•"></a>tryAcquireæŠ½è±¡æ–¹æ³•</h3><p>tryAcquireæ˜¯ä¸ªprotectedæ–¹æ³•ï¼Œå…·ä½“æ˜¯å®ç°åœ¨å¯¹åº”çš„å­ç±»ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½å°±æ˜¯å°è¯•å»ä¿®æ”¹stateçš„çŠ¶æ€å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯"><a href="#nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯" class="headerlink" title="nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯"></a>nonfairTryAcquireéå…¬å¹³é”è·å–è®¸å¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock éå…¬å¹³é”è¿›æ¥å°±å¼€å§‹æŠ¢å é”ï¼Œä½“ç°éå…¬å¹³æ€§</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                acquire(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä»¥ReentrantLockæ–¹æ³•çš„å®ç°ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line"><span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">            <span class="comment">// getState()è¿”å›çš„å°±æ˜¯AQSç±»ä¸­çš„stateå­—æ®µçš„å€¼</span></span><br><span class="line">            <span class="keyword">int</span> c = getState();</span><br><span class="line">            <span class="comment">// c == 0 è¯´æ˜å½“å‰é”æ²¡æœ‰è¢«ä»»ä½•çº¿ç¨‹å æœ‰</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨caså»ä¿®æ”¹stateçš„å€¼ï¼Œç‹¬å æ¨¡å¼ä¸‹acquires = 1</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                <span class="comment">// ä¿®æ”¹stateæˆåŠŸä¹‹åï¼Œå°†ç‹¬å çº¿ç¨‹è®¾ç½®æˆå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”è¿”å›trueï¼Œè¡¨ç¤ºæŠ¢å é”æˆåŠŸ</span></span><br><span class="line">                    setExclusiveOwnerThread(current);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœstate ï¼= 0 å¹¶ä¸”ç‹¬å çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æŒæœ‰å¯¹è±¡çš„é”ï¼Œæ­¤æ—¶ï¼Œéœ€è¦é”é‡å…¥ï¼Œstateç»§ç»­ç´¯åŠ </span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">                setState(nextc);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>AQSçš„acquire(int arg)æ–¹æ³•ä¸­è¿˜æœ‰ä¸€éƒ¨åˆ†å°±æ˜¯ <code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code></p><h3 id="addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—"><a href="#addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—"></a>addWaiteræ·»åŠ ç­‰å¾…é˜Ÿåˆ—</h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹addWaiteræ–¹æ³•ï¼Œjava.util.concurrent.locks.AbstractQueuedSynchronizer#addWaiter</p><p>å¦‚æœtryAcquireè¿”å›FALSEï¼ˆè·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼‰ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°CLHåŒæ­¥é˜Ÿåˆ—å°¾éƒ¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line"><span class="comment">// é¦–å…ˆåˆ›å»ºä¸€ä¸ªNodeèŠ‚ç‚¹</span></span><br><span class="line">        Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">        <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">        Node pred = tail;</span><br><span class="line">        <span class="comment">// cas å°†å½“å‰èŠ‚ç‚¹è®¾ç½®åˆ°åŒæ­¥é˜Ÿåˆ—çš„é˜Ÿå°¾</span></span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸Šé¢casè®¾ç½®æ²¡æœ‰æˆåŠŸï¼Œåˆ™é€šè¿‡enqæ–¹æ³•å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>java.util.concurrent.locks.AbstractQueuedSynchronizer#enq</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           Node t = tail;</span><br><span class="line">           <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; </span><br><span class="line">               <span class="comment">// Must initialize åˆå§‹åŒ–å¤´èŠ‚ç‚¹</span></span><br><span class="line">               <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                   tail = head;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               node.prev = t;</span><br><span class="line">               <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                   t.next = node;</span><br><span class="line">                   <span class="keyword">return</span> t;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è‡ªæ—‹ï¼Œæœ€ç»ˆå°†nodeèŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p><h3 id="acquireQueuedè·å–è®¸å¯"><a href="#acquireQueuedè·å–è®¸å¯" class="headerlink" title="acquireQueuedè·å–è®¸å¯"></a>acquireQueuedè·å–è®¸å¯</h3><p>èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¹‹ä¸­ï¼Œç„¶åæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³• â€¼ï¸</p><p>acquireQueuedæ–¹æ³•ä¸ºä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰çº¿ç¨‹ï¼ˆNodeï¼‰è¿›å…¥åŒæ­¥é˜Ÿåˆ—åï¼Œå°±ä¼šè¿›å…¥ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè‡ªçœåœ°è§‚å¯Ÿï¼Œå½“æ¡ä»¶æ»¡è¶³ï¼Œè·å–åˆ°åŒæ­¥çŠ¶æ€åï¼Œå°±å¯ä»¥ä»è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºï¼Œå¦åˆ™ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">              <span class="comment">// å¦‚æœnodeèŠ‚ç‚¹æ˜¯é˜Ÿåˆ—ä¸­ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼ˆå› ä¸ºç¬¬ä¸€ä¸ªæ­£åœ¨æ‰§è¡ŒçŠ¶æ€ï¼‰è‚¯å®šè¦é˜Ÿåˆ—ä¸­ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹å°è¯•è·å–é”</span></span><br><span class="line">                <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">              <span class="comment">// ç¬¬äºŒä¸ªèŠ‚ç‚¹è°ƒç”¨tryAcquireæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                   <span class="comment">//æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®æˆé˜Ÿåˆ—å¤´èŠ‚ç‚¹</span></span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·é˜Ÿåˆ—ä¸­åç»­çš„èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    interrupted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœè·å–é”å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="shouldParkAfterFailedAcquireæ–¹æ³•"><a href="#shouldParkAfterFailedAcquireæ–¹æ³•" class="headerlink" title="shouldParkAfterFailedAcquireæ–¹æ³•"></a>shouldParkAfterFailedAcquireæ–¹æ³•</h3><p>shouldParkAfterFailedAcquireå°†é˜Ÿåˆ—åç»­èŠ‚ç‚¹æŒ‚èµ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">       <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">         <span class="comment">// å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„waitStatus == Node.SIGNAL åˆ™ç›´æ¥è¿”å›true</span></span><br><span class="line">         <span class="comment">// å› ä¸ºå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯Node.SIGNALæ—¶ï¼Œæ‰ä¼šé€šçŸ¥åç»­èŠ‚ç‚¹è¿›è¡Œparkæˆ–è€…unpark</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">//  static final int CANCELLED =  1;</span></span><br><span class="line">         <span class="comment">// å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ç›´æ¥åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­å»é™¤</span></span><br><span class="line">           <span class="keyword">do</span> &#123;</span><br><span class="line">               node.prev = pred = pred.prev;</span><br><span class="line">           &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">           pred.next = node;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// å°†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„waitStatusè®¾ç½®æˆNode.SIGNAL</span></span><br><span class="line">           compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private final boolean parkAndCheckInterrupt() &#123;</span><br><span class="line">// æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œèµ°åˆ°è¿™è‚¯å®šæ˜¯æ²¡æœ‰æ‹¿åˆ°æ‰§è¡Œæƒçš„ï¼Œçº¿ç¨‹éœ€è¦æŒ‚èµ·ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”</span><br><span class="line">    LockSupport.park(this);</span><br><span class="line">    return Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå¦‚æœè·å–å¤±è´¥çš„è¯ï¼Œä¼šè°ƒç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š</p><h3 id="cancelAcquireå–æ¶ˆè·å–"><a href="#cancelAcquireå–æ¶ˆè·å–" class="headerlink" title="cancelAcquireå–æ¶ˆè·å–"></a>cancelAcquireå–æ¶ˆè·å–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœèŠ‚ç‚¹ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// ç”±äºçº¿ç¨‹è¦è¢«å–æ¶ˆäº†ï¼Œæ‰€ä»¥å°† thread çº¿ç¨‹æ¸…æ‰</span></span><br><span class="line">    node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢è¿™æ­¥è¡¨ç¤ºå°† node çš„ pre æŒ‡å‘ä¹‹å‰ç¬¬ä¸€ä¸ªéå–æ¶ˆçŠ¶æ€çš„ç»“ç‚¹ï¼ˆå³è·³è¿‡æ‰€æœ‰å–æ¶ˆçŠ¶æ€çš„ç»“ç‚¹ï¼‰,waitStatus &gt; 0 è¡¨ç¤ºå½“å‰ç»“ç‚¹çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç»è¿‡è¿‡æ»¤åçš„ pre çš„ next ç»“ç‚¹ï¼Œè¿™ä¸€æ­¥ä¸»è¦ç”¨åœ¨åé¢çš„ CAS è®¾ç½® pre çš„ next èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line">    <span class="comment">// å°†å½“å‰ç»“ç‚¹è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å–æ¶ˆç»“ç‚¹ä¸ºå°¾ç»“ç‚¹ï¼Œä½¿ç”¨ CAS åˆ™å°†å°¾ç»“ç‚¹è®¾ç½®ä¸ºå…¶å‰é©±èŠ‚ç‚¹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™å°¾ç»“ç‚¹çš„ next æŒ‡é’ˆè®¾ç½®ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸€æ­¥çœ‹å¾—æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æƒ³æƒ³ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œé‚£æ˜¯ä¸æ˜¯è¦æŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// ä½†æ˜¯æˆ‘ä»¬ä¹‹å‰ä¹Ÿè¯´äº†ï¼Œè¦å”¤é†’æˆ–é˜»å¡ç»“ç‚¹ï¼Œé¡»åœ¨å…¶å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNAL çš„æ¡ä»¶æ‰èƒ½æ“ä½œï¼Œ</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥åœ¨è®¾ç½® pre çš„ next èŠ‚ç‚¹æ—¶è¦ä¿è¯ pre ç»“ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œæƒ³é€šäº†è¿™ä¸€ç‚¹ç›¸ä¿¡ä½ ä¸éš¾ç†è§£ä»¥ä¸‹ä»£ç ã€‚</span></span><br><span class="line">        <span class="keyword">int</span> ws;</span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Node next = node.next;</span><br><span class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ pre ä¸º headï¼Œæˆ–è€…  pre çš„çŠ¶æ€è®¾ç½® SIGNAL å¤±è´¥ï¼Œåˆ™ç›´æ¥å”¤é†’åç»§ç»“ç‚¹å»ç«äº‰é”ï¼Œä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ SIGNAL çš„ç»“ç‚¹å–æ¶ˆï¼ˆæˆ–é‡Šæ”¾é”ï¼‰åå¯ä»¥å”¤é†’åç»§ç»“ç‚¹</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é‡Šæ”¾é”release"><a href="#é‡Šæ”¾é”release" class="headerlink" title="é‡Šæ”¾é”release"></a>é‡Šæ”¾é”release</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tryReleaseæ–¹æ³•ä¹Ÿæ˜¯ç”±å­ç±»æ¥å®ç°çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">            <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                free = <span class="keyword">true</span>;</span><br><span class="line">              <span class="comment">// å°†ç‹¬å çº¿ç¨‹è®¾ç½®æˆnullï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”æ—¶ä¼šè®¾ç½®æˆè‡ªå·±çš„</span></span><br><span class="line">                setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setState(c);</span><br><span class="line">            <span class="keyword">return</span> free;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ‰§è¡ŒunparkSuccessor(h);æ–¹æ³•äº†ï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾äº†é”ä¹‹åï¼Œéœ€è¦å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹ã€‚è¿™é‡Œæ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œè¦æ‰§è¡Œçš„NodeèŠ‚ç‚¹çš„waitStatusè‚¯å®šæ˜¯0ï¼›ï¼Ÿï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">       <span class="comment">//ç½®é›¶å½“å‰çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹çŠ¶æ€ï¼Œå…è®¸å¤±è´¥</span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// ä»ç¬¬äºŒä¸ªèŠ‚ç‚¹å¼€å§‹å¾€åæ‰¾waitStatus&lt;=0çš„èŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡Œunpark</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">  <span class="comment">// æ‰¾åˆ°ä¸‹ä¸€ä¸ªéœ€è¦å”¤é†’çš„ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Conditionåœ¨AQSä¸­çš„å®ç°"><a href="#Conditionåœ¨AQSä¸­çš„å®ç°" class="headerlink" title="Conditionåœ¨AQSä¸­çš„å®ç°"></a>Conditionåœ¨AQSä¸­çš„å®ç°</h1><p>ä¸Šé¢å·²ç»ä»‹ç»äº†<code>AQS</code>æ‰€æä¾›çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå½“ç„¶å®ƒè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç‰¹æ€§ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥ç»§ç»­è¯´ä¸‹<code>Condition</code>è¿™ä¸ªç»„ä»¶ã€‚</p><p>Conditionæ˜¯åœ¨java 1.5ä¸­æ‰å‡ºç°çš„ï¼Œå®ƒç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„<code>Object</code>çš„<code>wait()</code>ã€<code>notify()</code>å®ç°çº¿ç¨‹é—´çš„åä½œï¼Œç›¸æ¯”ä½¿ç”¨<code>Object</code>çš„<code>wait()</code>ã€<code>notify()</code>ï¼Œä½¿ç”¨<code>Condition</code>ä¸­çš„<code>await()</code>ã€<code>signal()</code>è¿™ç§æ–¹å¼å®ç°çº¿ç¨‹é—´åä½œæ›´åŠ å®‰å…¨å’Œé«˜æ•ˆã€‚å› æ­¤é€šå¸¸æ¥è¯´æ¯”è¾ƒæ¨èä½¿ç”¨`Condition</p><p>å…¶ä¸­<code>AbstractQueueSynchronizer</code>ä¸­å®ç°äº†<code>Condition</code>ä¸­çš„æ–¹æ³•ï¼Œä¸»è¦å¯¹å¤–æä¾›<code>awaite(Object.wait())</code>å’Œ<code>signal(Object.notify())</code>è°ƒç”¨ã€‚</p><h2 id="Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨"><a href="#Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨" class="headerlink" title="Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨"></a>Conditionåœ¨javaä»£ç ä¸­çš„åº”ç”¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Condition condition = lock.newCondition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€åŠ é”æˆåŠŸ&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€æ‰§è¡Œawaitè¢«æŒ‚èµ·&quot;</span>);</span><br><span class="line">                condition.await();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€è¢«å”¤é†’æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€é‡Šæ”¾é”æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒåŠ é”æˆåŠŸ&quot;</span>);</span><br><span class="line">                condition.signal();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒå”¤é†’çº¿ç¨‹ä¸€&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒé‡Šæ”¾é”æˆåŠŸ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹ä¸€è°ƒç”¨äº†condition.await();ä¹‹åï¼Œçº¿ç¨‹äºŒæ‰å¯ä»¥è·å–åˆ°é”å¹¶ä¸”æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼Œçº¿ç¨‹äºŒè°ƒç”¨ condition.signal();ä¹‹åå”¤é†’çº¿ç¨‹ä¸€ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œåªæœ‰åœ¨çº¿ç¨‹äºŒæ‰§è¡Œå®Œæˆä¹‹åè°ƒç”¨lock.unlock();ä¹‹åï¼Œçº¿ç¨‹ä¸€é‡æ–°å›å»åˆ°é”ï¼Œç„¶åæ‰§è¡Œçº¿ç¨‹ä¸€åç»­çš„æµç¨‹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210802183143055.png" alt="image-20210802183143055"></p><h2 id="awaitæ–¹æ³•"><a href="#awaitæ–¹æ³•" class="headerlink" title="awaitæ–¹æ³•"></a>awaitæ–¹æ³•</h2><p>awaitä½¿å½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè®¸å¯ï¼Œç„¶åè¿›å…¥Conditioné˜Ÿåˆ—ï¼Œç­‰å¾…åœ¨æŸä¸ªæ—¶åˆ»è¢«æŸä¸ªçº¿ç¨‹å”¤é†’ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  <span class="comment">// å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeèŠ‚ç‚¹æ·»åŠ çš„Conditioné˜Ÿåˆ—ä¸­</span></span><br><span class="line">            Node node = addConditionWaiter();</span><br><span class="line">  <span class="comment">// æ·»åŠ åˆ°Conditioné˜Ÿåˆ—ä¸­çš„çº¿ç¨‹éœ€è¦é‡Šæ”¾é”èµ„æº</span></span><br><span class="line">            <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">            <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ˜¯ä¸æ˜¯åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">            <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">              <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆç›´æ¥parkæŒ‚èµ·</span></span><br><span class="line">                LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">  <span class="comment">//  è¡¨æ˜å·²ç»æœ‰çš„çº¿ç¨‹è°ƒç”¨äº†signalå”¤é†’å½“å‰çº¿ç¨‹ï¼Œ</span></span><br><span class="line">  <span class="comment">// å¹¶ä¸”èŠ‚ç‚¹å·²ç»å­˜æ”¾åˆ°äº†åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨å¦‚æœacquireQueuedè¯·æ±‚è®¸å¯äº†</span></span><br><span class="line">  <span class="comment">// savedStateæ˜¯è·å–è®¸å¯çš„ä¸ªæ•° è¿™ä¸ªè¦å’Œä¹‹å‰é‡Šæ”¾çš„è®¸å¯ä¸ªæ•°ä¸€è‡´</span></span><br><span class="line">            <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">                interruptMode = REINTERRUPT;</span><br><span class="line">            <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">                unlinkCancelledWaiters();</span><br><span class="line">            <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">                reportInterruptAfterWait(interruptMode);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><strong>addConditionWaiteræ–¹æ³•æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹åˆ°Conditioné˜Ÿåˆ—ä¸­</strong></p><p>java.util.concurrent.locks.AbstractQueuedSynchronizer.ConditionObject#addConditionWaiter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Node t = lastWaiter;</span><br><span class="line">            <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">              <span class="comment">// å…ˆæ£€æŸ¥ä¸€éæœ‰æ²¡æœ‰å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæ¸…é™¤æ‰</span></span><br><span class="line">                unlinkCancelledWaiters();</span><br><span class="line">                t = lastWaiter;</span><br><span class="line">            &#125;</span><br><span class="line">  <span class="comment">// å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeæ·»åŠ åˆ°Conditioné˜Ÿåˆ—ä¸­</span></span><br><span class="line">            Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">                firstWaiter = node;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                t.nextWaiter = node;</span><br><span class="line">            lastWaiter = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2 id="signalæ–¹æ³•"><a href="#signalæ–¹æ³•" class="headerlink" title="signalæ–¹æ³•"></a>signalæ–¹æ³•</h2><p>å”¤é†’ä¸€ä¸ªçº¿ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">            Node first = firstWaiter;</span><br><span class="line">            <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">                doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="doSignalæ–¹æ³•"><a href="#doSignalæ–¹æ³•" class="headerlink" title="doSignalæ–¹æ³•"></a>doSignalæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">                    lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">                first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">              <span class="comment">// å°†Conditioné˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹çŠ¶æ€è®¾ç½®æˆSIGNALï¼Œå¹¶å°†èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">            &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">                     (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="transferForSignalæ–¹æ³•"><a href="#transferForSignalæ–¹æ³•" class="headerlink" title="transferForSignalæ–¹æ³•"></a>transferForSignalæ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If cannot change waitStatus, the node has been cancelled.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">         <span class="comment">// å°†èŠ‚ç‚¹çŠ¶æ€æ”¹æˆ0 </span></span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Splice onto queue and try to set waitStatus of predecessor to</span></span><br><span class="line"><span class="comment">         * indicate that thread is (probably) waiting. If cancelled or</span></span><br><span class="line"><span class="comment">         * attempt to set waitStatus fails, wake up to resync (in which</span></span><br><span class="line"><span class="comment">         * case the waitStatus can be transiently and harmlessly wrong).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">         <span class="comment">// æŠŠå½“å‰æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿”å›å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        Node p = enq(node);</span><br><span class="line">        <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">        <span class="comment">// è®¾ç½®å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸ºSIGNAL</span></span><br><span class="line">        <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        <span class="comment">// å”¤é†’å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">            LockSupport.unpark(node.thread);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://mp.weixin.qq.com/s/hB5ncpe7_tVovQj1sNlDRA">https://mp.weixin.qq.com/s/hB5ncpe7_tVovQj1sNlDRA</a></p><p><a href="https://mp.weixin.qq.com/s/iNz6sTen2CSOdLE0j7qu9A">https://mp.weixin.qq.com/s/iNz6sTen2CSOdLE0j7qu9A</a></p><p><a href="https://github.com/AobingJava/JavaFamily">https://github.com/AobingJava/JavaFamily</a></p><p><a href="https://segmentfault.com/a/1190000015804888/">https://segmentfault.com/a/1190000015804888/</a></p><p><a href="https://juejin.cn/post/6844903997438951437">https://juejin.cn/post/6844903997438951437</a></p><p><a href="https://juejin.cn/post/6870099231361728525">https://juejin.cn/post/6870099231361728525</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;AQSé”é™æ—¶ç­‰å¾…æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å…¬å¹³é”ä¸éå…¬å¹³é”æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ&lt;/p&gt;
&lt;h1 id=&quot;ç‹¬å é”-amp-å…±äº«é”&quot;&gt;&lt;a href=&quot;#ç‹¬å é”-amp-å…±äº«é”&quot; class=&quot;headerlink&quot; title=&quot;ç‹¬å é”&amp;amp;å…±äº«é”&quot;&gt;&lt;/a&gt;ç‹¬å é”&amp;amp</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
</feed>
