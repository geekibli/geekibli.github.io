<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>GeekIBLi</title>
  
  <subtitle>For Coder</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2022-01-18T06:14:30.636Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>gaolei</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æ·±å…¥å­¦ä¹ jvmï¼ˆå›¾çµ-è¯¸è‘›ï¼‰</title>
    <link href="http://example.com/wiki/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0jvm%EF%BC%88%E5%9B%BE%E7%81%B5-%E8%AF%B8%E8%91%9B%EF%BC%89/"/>
    <id>http://example.com/wiki/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0jvm%EF%BC%88%E5%9B%BE%E7%81%B5-%E8%AF%B8%E8%91%9B%EF%BC%89/</id>
    <published>2022-01-13T09:20:49.000Z</published>
    <updated>2022-01-18T06:14:30.636Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶"><a href="#1-ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶" class="headerlink" title="1. ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶"></a>1. ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶</h1><h2 id="1-1-ä¸ºä»€ä¹ˆéœ€è¦ç±»åŠ è½½ï¼Ÿ"><a href="#1-1-ä¸ºä»€ä¹ˆéœ€è¦ç±»åŠ è½½ï¼Ÿ" class="headerlink" title="1.1 ä¸ºä»€ä¹ˆéœ€è¦ç±»åŠ è½½ï¼Ÿ"></a>1.1 ä¸ºä»€ä¹ˆéœ€è¦ç±»åŠ è½½ï¼Ÿ</h2><p>æˆ‘ä»¬ç¼–å†™çš„ç¨‹åºä»£ç éƒ½æ˜¯å­˜æ”¾åœ¨ç£ç›˜ä¸Šé¢çš„ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œéœ€è¦æŠŠæˆ‘ä»¬çš„classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ç±»åŠ è½½ã€‚</p><h2 id="1-2-javaä»£ç åˆ°åº•æ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢"><a href="#1-2-javaä»£ç åˆ°åº•æ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢" class="headerlink" title="1.2 javaä»£ç åˆ°åº•æ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢"></a>1.2 javaä»£ç åˆ°åº•æ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œæˆ‘ä»¬å¹³æ—¶éƒ½ä¼šå®šä¹‰çš„ï¼Œé‚£ä¹ˆä»–ä»¬æ˜¯æ€ä¹ˆåŠ è½½çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Math</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> initData = <span class="number">666</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> User user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compute</span><span class="params">()</span> </span>&#123; <span class="comment">//ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€å—æ ˆå¸§å†…å­˜åŒºåŸŸ</span></span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> c = (a + b) * <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Math math = <span class="keyword">new</span> Math();</span><br><span class="line">        math.compute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„mainæ–¹æ³•æ˜¯å¦‚ä½•è¿è¡Œçš„å§ ğŸ‘‡</p><img src="https://oscimg.oschina.net/oscnet/up-10964428d2deadcb19af7dea03f8b40fe4a.png" style="zoom:50%;" /><ul><li>javaç¨‹åºä¼šè°ƒç”¨åº•å±‚çš„jvmç±»åº“æ–‡ä»¶ä¸­çš„å‡½æ•°æ¥åˆ›å»ºjavaè™šæ‹Ÿæœºï¼ˆC++ä¸­å®ç°ï¼‰</li><li>jvmå¯åŠ¨ä¹‹ååˆ›å»ºä¸€ä¸ªå¼•å¯¼ç±»åŠ è½½å®ä¾‹ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ç±»åŠ è½½å™¨ä¸­çš„BootstartClassLoaderï¼‰</li><li>C++è°ƒç”¨javaä»£ç åˆ›å»ºjvmå¯åŠ¨å™¨ï¼Œ<code>sun.misc.Launcher</code>è¯¥ç±»æ¥åˆ›å»ºå…¶ä»–çš„ç±»åŠ è½½å™¨ï¼ˆExtClassLoader, AppClassLoaderï¼‰</li><li>ç±»åŠ è½½å™¨éƒ½åˆ›å»ºå®Œæˆä¹‹åï¼Œè¿™äº›ç±»åŠ è½½å™¨å°±å¯ä»¥åˆ°æŒ‡å®šè·¯å¾„ä¸‹é¢å»åŠ è½½ç±»ä¿¡æ¯äº†ï¼Œè‡³äºåŠ è½½åˆ°å“ªé‡Œï¼ˆæ–¹æ³•åŒºï¼‰åé¢å†è¯´</li><li>å½“ç±»åŠ è½½éƒ½å®Œæˆä¹‹åï¼ˆå½“ç„¶è¿™é‡Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç»†èŠ‚ï¼‰ï¼Œè°ƒç”¨å¯åŠ¨ç±»çš„mainæ–¹æ³•æ‰§è¡Œjavaç¨‹åº</li></ul><h2 id="1-3-ç±»åŠ è½½è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-3-ç±»åŠ è½½è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.3 ç±»åŠ è½½è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1.3 ç±»åŠ è½½è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>åŠ è½½ &gt;&gt; éªŒè¯ &gt;&gt; å‡†å¤‡ &gt;&gt; è§£æ &gt;&gt; åˆå§‹åŒ– &gt;&gt; ä½¿ç”¨ &gt;&gt; å¸è½½</p><h3 id="1-3-1-ç±»åŠ è½½çš„æµç¨‹å›¾"><a href="#1-3-1-ç±»åŠ è½½çš„æµç¨‹å›¾" class="headerlink" title="1.3.1 ç±»åŠ è½½çš„æµç¨‹å›¾"></a>1.3.1 ç±»åŠ è½½çš„æµç¨‹å›¾</h3><img src="https://oscimg.oschina.net/oscnet/up-e1d5215968dd20b4c65191197b08b8470f9.png" style="zoom:50%;" /><h3 id="1-3-2-åŠ è½½"><a href="#1-3-2-åŠ è½½" class="headerlink" title="1.3.2 åŠ è½½"></a>1.3.2 åŠ è½½</h3><p>åŠ è½½:åœ¨ç¡¬ç›˜ä¸ŠæŸ¥æ‰¾å¹¶é€šè¿‡IOè¯»å…¥å­—èŠ‚ç æ–‡ä»¶ï¼Œä½¿ç”¨åˆ°ç±»æ—¶æ‰ä¼šåŠ è½½ï¼Œä¾‹å¦‚è°ƒç”¨ç±»çš„ main()æ–¹æ³•ï¼Œnewå¯¹è±¡ç­‰ç­‰ï¼Œåœ¨åŠ è½½é˜¶æ®µä¼šåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„ java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚</p><h4 id="1-3-2-1-å¦‚ä½•éªŒè¯ç±»åœ¨ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šåŠ è½½"><a href="#1-3-2-1-å¦‚ä½•éªŒè¯ç±»åœ¨ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šåŠ è½½" class="headerlink" title="1.3.2.1 å¦‚ä½•éªŒè¯ç±»åœ¨ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šåŠ è½½"></a>1.3.2.1 å¦‚ä½•éªŒè¯ç±»åœ¨ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šåŠ è½½</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDynamicLoad</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;*************load TestDynamicLoad************&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> A();</span><br><span class="line">        System.out.println(<span class="string">&quot;*************load test************&quot;</span>);</span><br><span class="line">         B b = <span class="keyword">null</span>; <span class="comment">//Bä¸ä¼šåŠ è½½ï¼Œé™¤éè¿™é‡Œæ‰§è¡Œ new B()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;*************load A************&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">A</span> <span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;*************initial A************&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;*************load B************&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">B</span> <span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;*************initial B************&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*************load TestDynamicLoad************</span><br><span class="line">*************load A************</span><br><span class="line">*************initial A************</span><br><span class="line">*************load test************</span><br></pre></td></tr></table></figure><h3 id="1-3-3-éªŒè¯"><a href="#1-3-3-éªŒè¯" class="headerlink" title="1.3.3 éªŒè¯"></a>1.3.3 éªŒè¯</h3><p>éªŒè¯:æ ¡éªŒå­—èŠ‚ç æ–‡ä»¶çš„æ­£ç¡®æ€§</p><h4 id="1-3-3-1-éªŒè¯çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-3-3-1-éªŒè¯çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.3.3.1 éªŒè¯çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1.3.3.1 éªŒè¯çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ</h4><ul><li>æ ¡éªŒå­—èŠ‚ç æ ¼å¼ç­‰ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦ç¬¦åˆå­—èŠ‚ç è§„èŒƒ</li><li>ä¿æŠ¤jvm</li></ul><h3 id="1-3-4-å‡†å¤‡"><a href="#1-3-4-å‡†å¤‡" class="headerlink" title="1.3.4 å‡†å¤‡"></a>1.3.4 å‡†å¤‡</h3><p>ç»™ç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶èµ‹äºˆé»˜è®¤å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finalä¿®é¥°çš„æ˜¯é™æ€å˜é‡ï¼Œç›´æ¥èµ‹å€¼ï¼Œè€Œstaticä¿®é¥°çš„å˜é‡ï¼Œåˆ™åœ¨å‡†å¤‡é˜¶æ®µèµ‹äºˆé»˜è®¤å€¼ã€‚</span><br></pre></td></tr></table></figure><h3 id="1-3-5-è§£æ"><a href="#1-3-5-è§£æ" class="headerlink" title="1.3.5 è§£æ"></a>1.3.5 è§£æ</h3><p>å°†ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œè¯¥é˜¶æ®µä¼šæŠŠä¸€äº›é™æ€æ–¹æ³•(ç¬¦å·å¼•ç”¨ï¼Œæ¯”å¦‚main()æ–¹æ³•)æ›¿æ¢ä¸ºæŒ‡å‘æ•°æ®æ‰€å­˜å†…å­˜çš„æŒ‡é’ˆæˆ–å¥æŸ„ç­‰(ç›´æ¥å¼•ç”¨)ï¼Œè¿™æ˜¯æ‰€è°“çš„é™æ€é“¾æ¥è¿‡ ç¨‹(ç±»åŠ è½½æœŸé—´å®Œæˆ)ï¼ŒåŠ¨æ€é“¾æ¥æ˜¯åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å®Œæˆçš„å°†ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚</p><h4 id="1-3-5-1-ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥ï¼Ÿ"><a href="#1-3-5-1-ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥ï¼Ÿ" class="headerlink" title="1.3.5.1 ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥ï¼Ÿ"></a>1.3.5.1 ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥ï¼Ÿ</h4><p>åƒç±»ä¿¡æ¯æ˜¯ç¡®å®šçš„ï¼Œè¿™ç§å±äºé™æ€ç¬¦å·ã€‚</p><p>æ–¹æ³•å¯èƒ½ä¼šè®¾è®¡åˆ°å¤šæ€ï¼Œä¸ç¡®å®šï¼Œåªèƒ½åŠ¨æ€è¿è¡Œæ—¶ç¡®å®šï¼Œè¿è¡Œæ—¶æ‰èƒ½ç¡®å®šå†…å­˜ä¸­çš„ä½ç½®ã€‚</p><h3 id="1-3-6-åˆå§‹åŒ–"><a href="#1-3-6-åˆå§‹åŒ–" class="headerlink" title="1.3.6 åˆå§‹åŒ–"></a>1.3.6 åˆå§‹åŒ–</h3><p>å¯¹ç±»çš„é™æ€å˜é‡åˆå§‹åŒ–ä¸ºæŒ‡å®šçš„å€¼ï¼Œæ‰§è¡Œé™æ€ä»£ç å—ï¼Œæ„é€ å‡½æ•°ã€‚</p><h3 id="1-3-6-1-åˆå§‹åŒ–é¡ºåº"><a href="#1-3-6-1-åˆå§‹åŒ–é¡ºåº" class="headerlink" title="1.3.6.1 åˆå§‹åŒ–é¡ºåº"></a>1.3.6.1 åˆå§‹åŒ–é¡ºåº</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;superclass static ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SuperClass</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;superclass constructor ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChildClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;childclass static ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChildClass</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;childclass constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ChildClass();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">superclass <span class="keyword">static</span> ...</span><br><span class="line">childclass <span class="keyword">static</span> ...</span><br><span class="line">superclass constructor ...</span><br><span class="line">childclass constructor</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼š</p><ul><li>é™æ€åˆå§‹åŒ–å—ä¼˜å…ˆåŠ è½½</li><li>æ„é€ å™¨å‡½æ•°å†åŠ è½½</li><li>çˆ¶ç±»åŠ è½½ä¼˜å…ˆå­ç±»</li></ul><h2 id="1-4-ç±»åŠ è½½å™¨"><a href="#1-4-ç±»åŠ è½½å™¨" class="headerlink" title="1.4 ç±»åŠ è½½å™¨"></a>1.4 ç±»åŠ è½½å™¨</h2><h3 id="1-4-1-ç±»åŠ è½½å™¨ç§ç±»"><a href="#1-4-1-ç±»åŠ è½½å™¨ç§ç±»" class="headerlink" title="1.4.1 ç±»åŠ è½½å™¨ç§ç±»"></a>1.4.1 ç±»åŠ è½½å™¨ç§ç±»</h3><ul><li><p>å¼•å¯¼ç±»åŠ è½½å™¨ï¼š bootstarpClassLoader (C++ä¸­å®ç°) </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è´Ÿè´£åŠ è½½æ”¯æ’‘JVMè¿è¡Œçš„ä½äºJREçš„libç›®å½•ä¸‹çš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚ rt.jarã€charsets.jarç­‰</span><br></pre></td></tr></table></figure></li><li><p>æ‰©å±•ç±»åŠ è½½å™¨ï¼š static class ExtClassLoader extends URLClassLoader</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è´Ÿè´£åŠ è½½æ”¯æ’‘JVMè¿è¡Œçš„ä½äºJREçš„libç›®å½•ä¸‹çš„extæ‰©å±•ç›®å½•ä¸­çš„JAR ç±»åŒ…</span><br></pre></td></tr></table></figure></li><li><p>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼š static class AppClassLoader extends URLClassLoader</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è´Ÿè´£åŠ è½½ClassPathè·¯å¾„ä¸‹çš„ç±»åŒ…ï¼Œä¸»è¦å°±æ˜¯åŠ è½½ä½ è‡ªå·±å†™çš„é‚£ äº›ç±»</span><br></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰ç±»åŠ è½½å™¨ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è´Ÿè´£åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰è·¯å¾„ä¸‹çš„ç±»åŒ…</span><br></pre></td></tr></table></figure></li></ul><h4 id="1-4-1-1-å¦‚ä½•éªŒè¯åŠ è½½çš„path"><a href="#1-4-1-1-å¦‚ä½•éªŒè¯åŠ è½½çš„path" class="headerlink" title="1.4.1.1 å¦‚ä½•éªŒè¯åŠ è½½çš„path"></a>1.4.1.1 å¦‚ä½•éªŒè¯åŠ è½½çš„path</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(String.class.getClassLoader());</span><br><span class="line">System.out.println(com.sun.crypto.provider.DESKeyFactory.class.getClassLoader().getClass().getName());</span><br><span class="line">System.out.println(User.class.getClassLoader().getClass().getName());</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡ºç»“æœ</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">null</span></span><br><span class="line">sun.misc.Launcher$ExtClassLoader</span><br><span class="line">sun.misc.Launcher$AppClassLoader</span><br></pre></td></tr></table></figure><p><code>String.class.getClassLoader()</code> ä¸ºä»€ä¹ˆæ˜¯nullå‘¢ï¼Ÿ</p><p>å› ä¸ºStringæ˜¯jdkåŸç”Ÿçš„ç±»ï¼Œåœ¨åŠ è½½å¿…é¡»éœ€è¦å¼•å¯¼ç±»åŠ è½½å™¨æ¥åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨æ˜¯åœ¨C++ä¸­å®šä¹‰çš„ï¼Œæ‰€ä»¥javaä»£ç ä¸­è‚¯å®šæ‹¿ä¸åˆ°ã€‚</p><p>å¦‚ä½•è¯æ˜å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExtClassLoader</span><span class="params">(File[] var1)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(getExtURLs(var1), (ClassLoader)<span class="keyword">null</span>, Launcher.factory);</span><br><span class="line">            SharedSecrets.getJavaNetAccess().getURLClassPath(<span class="keyword">this</span>).initLookupCache(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ExtClassLoaderçš„çˆ¶åŠ è½½å™¨æ˜¯BootstarpClassLoaderï¼Œè¿™é‡Œåœ¨åˆå§‹åŒ–ExtClassLoaderçš„æ—¶å€™ï¼Œè®¾ç½®çˆ¶åŠ è½½å™¨çš„æ—¶å€™ä¼ çš„å€¼æ˜¯nullã€‚</p><h3 id="1-4-2-ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»"><a href="#1-4-2-ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»" class="headerlink" title="1.4.2 ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»"></a>1.4.2 ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»</h3><ul><li>ExtClassLoader æ˜¯ AppClassLoader çš„çˆ¶åŠ è½½å™¨ï¼Œè€Œä¸æ˜¯çˆ¶ç±»ï¼</li><li>è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯ AppClassLoader</li></ul><h3 id="1-4-3-ç±»åŠ è½½å™¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„"><a href="#1-4-3-ç±»åŠ è½½å™¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„" class="headerlink" title="1.4.3 ç±»åŠ è½½å™¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„"></a>1.4.3 ç±»åŠ è½½å™¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„</h3><p>ä¸Šé¢å·²ç»æåˆ°ï¼Œåœ¨C++ç¨‹åºåˆ›å»ºäº†å¼•å¯¼ç±»åŠ è½½å™¨ä¹‹åï¼Œæˆ–åˆ›å»ºjavaçš„Launcherç±»ï¼Œåœ¨æ„é€ è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œåˆ›å»ºçš„ExtClassLoaderå’ŒAppClassLoaderã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Launcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Launcher.ExtClassLoader var1;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var1 = Launcher.ExtClassLoader.getExtClassLoader();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var10) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">&quot;Could not create extension class loader&quot;</span>, var10);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.loader = Launcher.AppClassLoader.getAppClassLoader(var1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">&quot;Could not create application class loader&quot;</span>, var9);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Launcheræ˜¯å•ä¾‹çš„ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> URLStreamHandlerFactory factory = <span class="keyword">new</span> Launcher.Factory();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Launcher launcher = <span class="keyword">new</span> Launcher();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String bootClassPath = System.getProperty(<span class="string">&quot;sun.boot.class.path&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> ClassLoader loader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> URLStreamHandler fileHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Launcher <span class="title">getLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> launcher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-5-åŒäº²å§”æ´¾æœºåˆ¶"><a href="#1-5-åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="1.5 åŒäº²å§”æ´¾æœºåˆ¶"></a>1.5 åŒäº²å§”æ´¾æœºåˆ¶</h2><img src="https://oscimg.oschina.net/oscnet/up-3f17f266b143eaf2705ce60de4d09324e1f.png" style="zoom:50%;" /><h3 id="1-5-1-ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾ï¼Ÿ"><a href="#1-5-1-ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾ï¼Ÿ" class="headerlink" title="1.5.1 ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾ï¼Ÿ"></a>1.5.1 ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾ï¼Ÿ</h3><p>è¿™é‡Œç±»åŠ è½½å…¶å®å°±æœ‰ä¸€ä¸ªåŒäº²å§”æ´¾æœºåˆ¶ï¼ŒåŠ è½½æŸä¸ªç±»æ—¶ä¼šå…ˆåˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡åŠ è½½è¿‡ï¼Œå…ˆå§”æ‰˜çˆ¶åŠ è½½å™¨å¯»æ‰¾ç›®æ ‡ç±»ï¼Œçˆ¶åŠ è½½å™¨æ‰¾ä¸åˆ°å†å§”æ‰˜ä¸Šå±‚çˆ¶åŠ è½½å™¨åŠ è½½ï¼Œå¦‚æœæ‰€æœ‰çˆ¶åŠ è½½å™¨åœ¨è‡ªå·±çš„åŠ è½½ç±»è·¯å¾„ä¸‹éƒ½æ‰¾ä¸åˆ°ç›®æ ‡ç±»ï¼Œåˆ™åœ¨è‡ªå·±çš„ ç±»åŠ è½½è·¯å¾„ä¸­æŸ¥æ‰¾å¹¶è½½å…¥ç›®æ ‡ç±»ã€‚ </p><p>æ¯”å¦‚æˆ‘ä»¬çš„Mathç±»ï¼Œæœ€å…ˆä¼šæ‰¾åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨åŠ è½½ï¼Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ä¼šå…ˆå§”æ‰˜æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ï¼Œæ‰©å±•ç±»åŠ è½½å™¨å†å§”æ‰˜å¼•å¯¼ç±»åŠ è½½å™¨ï¼Œé¡¶å±‚å¼•å¯¼ç±»åŠ è½½å™¨åœ¨è‡ªå·±çš„ç±»åŠ è½½è·¯å¾„é‡Œæ‰¾äº†åŠå¤©æ²¡æ‰¾åˆ°Mathç±»ï¼Œåˆ™å‘ä¸‹é€€å›åŠ è½½Mathç±»çš„è¯·æ±‚ï¼Œæ‰©å±•ç±»åŠ è½½å™¨æ”¶åˆ°å›å¤å°±è‡ªå·±åŠ è½½ï¼Œåœ¨è‡ªå·±çš„ç±»åŠ è½½è·¯å¾„é‡Œæ‰¾äº†åŠå¤©ä¹Ÿæ²¡æ‰¾åˆ°Mathç±»ï¼Œåˆå‘ä¸‹é€€å›Mathç±»çš„åŠ è½½è¯·æ±‚ç»™åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œ åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨äºæ˜¯åœ¨è‡ªå·±çš„ç±»åŠ è½½è·¯å¾„é‡Œæ‰¾Mathç±»ï¼Œç»“æœæ‰¾åˆ°äº†å°±è‡ªå·±åŠ è½½äº†ã€‚ </p><p><strong>åŒäº²å§”æ´¾æœºåˆ¶è¯´ç®€å•ç‚¹å°±æ˜¯ï¼Œå…ˆæ‰¾çˆ¶äº²åŠ è½½ï¼Œä¸è¡Œå†ç”±å„¿å­è‡ªå·±åŠ è½½ã€‚</strong></p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoaderåŠ è½½ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶æºç ï¼ŒAppClassLoader çš„loadClassæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨å…¶çˆ¶ç±»ClassLoaderçš„loadClassæ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å¤§ä½“é€»è¾‘å¦‚ä¸‹:</p><ul><li>é¦–å…ˆï¼Œæ£€æŸ¥ä¸€ä¸‹æŒ‡å®šåç§°çš„ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœåŠ è½½è¿‡äº†ï¼Œå°±ä¸éœ€è¦å†åŠ è½½ï¼Œç›´æ¥ è¿”å›ã€‚</li><li>å¦‚æœæ­¤ç±»æ²¡æœ‰åŠ è½½è¿‡ï¼Œé‚£ä¹ˆï¼Œå†åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æœ‰çˆ¶åŠ è½½å™¨;å¦‚æœæœ‰çˆ¶åŠ è½½å™¨ï¼Œåˆ™ç”±çˆ¶åŠ  è½½å™¨åŠ è½½(å³è°ƒç”¨parent.loadClass(name, false);).æˆ–è€…æ˜¯è°ƒç”¨bootstrapç±»åŠ è½½å™¨æ¥åŠ è½½ã€‚</li><li>å¦‚æœçˆ¶åŠ è½½å™¨åŠbootstrapç±»åŠ è½½å™¨éƒ½æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„ç±»ï¼Œé‚£ä¹ˆè°ƒç”¨å½“å‰ç±»åŠ è½½å™¨çš„ findClassæ–¹æ³•æ¥å®Œæˆç±»åŠ è½½ã€‚</li></ul><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name); </span><br><span class="line">          <span class="comment">// å¦‚æœå·²ç»åŠ è½½äº†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// å¦‚æœçˆ¶åŠ è½½å™¨ä¸æ˜¯nullï¼Œç”±ä¸Šå±‚åŠ è½½å™¨è´Ÿè´£åŠ è½½</span></span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰åŠ è½½è¿‡ï¼Œåˆ™å»å½“å‰åŠ è½½å™¨çš„æ‰§è¡Œè·¯å¾„ä¸‹å¯»æ‰¾</span></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                    c = findClass(name);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                    sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-2-ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾ï¼Ÿ"><a href="#1-5-2-ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾ï¼Ÿ" class="headerlink" title="1.5.2 ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾ï¼Ÿ"></a>1.5.2 ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾ï¼Ÿ</h3><ul><li>æ²™ç®±å®‰å…¨æœºåˆ¶:è‡ªå·±å†™çš„java.lang.String.classç±»ä¸ä¼šè¢«åŠ è½½ï¼Œè¿™æ ·ä¾¿å¯ä»¥é˜²æ­¢æ ¸å¿ƒ</li><li>APIåº“è¢«éšæ„ç¯¡æ”¹ é¿å…ç±»çš„é‡å¤åŠ è½½:å½“çˆ¶äº²å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å­ClassLoaderå†åŠ è½½ä¸€æ¬¡ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„å”¯ä¸€æ€§</li></ul><h4 id="1-5-2-1-è‡ªå®šä¹‰çš„-java-lang-Stringèƒ½å¦è¢«åŠ è½½"><a href="#1-5-2-1-è‡ªå®šä¹‰çš„-java-lang-Stringèƒ½å¦è¢«åŠ è½½" class="headerlink" title="1.5.2.1 è‡ªå®šä¹‰çš„ java.lang.Stringèƒ½å¦è¢«åŠ è½½"></a>1.5.2.1 è‡ªå®šä¹‰çš„ java.lang.Stringèƒ½å¦è¢«åŠ è½½</h4><p>è‚¯å®šæ˜¯ä¸èƒ½åŠ è½½çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.lang;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line">System.out.println(<span class="string">&quot;**************My String Class**************&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">é”™è¯¯: åœ¨ç±» java.lang.String ä¸­æ‰¾ä¸åˆ° main æ–¹æ³•, è¯·å°† main æ–¹æ³•å®šä¹‰ä¸º: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">å¦åˆ™ JavaFX åº”ç”¨ç¨‹åºç±»å¿…é¡»æ‰©å±•javafx.application.Application</span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæç¤ºçš„æ˜¯æ‰¾ä¸åˆ°mainæ–¹æ³•è¿™ä¸ªé”™è¯¯å‘¢ï¼Ÿ</p><p>å› ä¸ºç±»åŠ è½½åŠ è½½çš„Stringç±»æ ¹æœ¬å°±ä¸æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„è¿™ä¸ªç±»ï¼Œè€Œæ˜¯JDKçš„Stringï¼ŒJDKä¸­Stringçš„ç±»ä¸­æœ‰æ²¡æœ‰mainæ–¹æ³•ã€‚</p><h4 id="1-5-2-2-ä¸ºä»€ä¹ˆåŠ è½½å…ˆæ˜¯åœ¨appåŠ è½½å™¨è€Œä¸æ˜¯bootstrapåŠ è½½å™¨ï¼Ÿ"><a href="#1-5-2-2-ä¸ºä»€ä¹ˆåŠ è½½å…ˆæ˜¯åœ¨appåŠ è½½å™¨è€Œä¸æ˜¯bootstrapåŠ è½½å™¨ï¼Ÿ" class="headerlink" title="1.5.2.2 ä¸ºä»€ä¹ˆåŠ è½½å…ˆæ˜¯åœ¨appåŠ è½½å™¨è€Œä¸æ˜¯bootstrapåŠ è½½å™¨ï¼Ÿ"></a>1.5.2.2 ä¸ºä»€ä¹ˆåŠ è½½å…ˆæ˜¯åœ¨appåŠ è½½å™¨è€Œä¸æ˜¯bootstrapåŠ è½½å™¨ï¼Ÿ</h4><p>å› ä¸ºå¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯éœ€è¦appåŠ è½½å™¨æ¥åŠ è½½ã€‚</p><h3 id="1-5-3-å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#1-5-3-å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="1.5.3 å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>1.5.3 å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h3><p>è‡ªå®šä¹‰ç±»åŠ è½½å™¨åªéœ€è¦ç»§æ‰¿ java.lang.ClassLoader ç±»ï¼Œè¯¥ç±»æœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ loadClass(String, boolean)ï¼Œå®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯findClassï¼Œé»˜è®¤å®ç°æ˜¯ç©ºæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸»è¦æ˜¯é‡å†™ æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String classPath;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(String classPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classPath = classPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] loadByte(String name) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        name = name.replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(classPath + <span class="string">&quot;/&quot;</span> + name</span><br><span class="line">                + <span class="string">&quot;.class&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> len = fis.available();</span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">        fis.read(data);</span><br><span class="line">        fis.close();</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] data = loadByte(name);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, data, <span class="number">0</span>, data.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ClassLoaderï¼Œå…¶ä¸­ä¼šæŠŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoader</span></span><br><span class="line">        MyClassLoader classLoader = <span class="keyword">new</span> MyClassLoader(<span class="string">&quot;/export/data&quot;</span>);</span><br><span class="line">        <span class="comment">//export/data/com/ibli/jvm å‡ çº§ç›®å½•ï¼Œå°†Userç±»çš„å¤åˆ¶ç±»User.classä¸¢å…¥è¯¥ç›®å½•</span></span><br><span class="line">        Class clazz = classLoader.loadClass(<span class="string">&quot;com.ibli.jvm.User&quot;</span>);</span><br><span class="line">        Object obj = clazz.newInstance();</span><br><span class="line">        Method method = clazz.getDeclaredMethod(<span class="string">&quot;sout&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        method.invoke(obj, <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(clazz.getClassLoader().getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªUserç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;user sout ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user sout ...</span><br><span class="line">com.ibli.jvm.MyClassLoader</span><br></pre></td></tr></table></figure><p>æˆ‘ç°åœ¨è¦åŠ è½½ <code>com.ibli.jvm.User</code>ç±»ï¼Œåœ¨ <code>/export/data/com/ibli/jvm</code>ä¸‹æœ‰ä¸€ä¸ª<code>User.class</code>ã€‚</p><p>æˆ‘å®šä¹‰çš„åŠ è½½å™¨å»åŠ è½½çš„æ—¶å€™ï¼Œä¸Šå±‚çš„åŠ è½½å™¨ä»¬çš„å„è‡ªè·¯å¾„ä¸‹éƒ½æ²¡æœ‰è¿™ä¸ªç±»ï¼Œæ‰€ä»¥æœ€ç»ˆè‚¯å®šæ˜¯ç”±æˆ‘è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ¥åŠ è½½ã€‚</p><h3 id="1-5-4-å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾"><a href="#1-5-4-å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾" class="headerlink" title="1.5.4 å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾"></a>1.5.4 å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾</h3><h4 id="1-5-4-1-ä»€ä¹ˆæ˜¯æ‰“ç ´åŒäº²å§”æ´¾"><a href="#1-5-4-1-ä»€ä¹ˆæ˜¯æ‰“ç ´åŒäº²å§”æ´¾" class="headerlink" title="1.5.4.1 ä»€ä¹ˆæ˜¯æ‰“ç ´åŒäº²å§”æ´¾"></a>1.5.4.1 ä»€ä¹ˆæ˜¯æ‰“ç ´åŒäº²å§”æ´¾</h4><p>ç±»é€šè¿‡å­åŠ è½½å™¨åŠ è½½ ä¸ç”¨çˆ¶åŠ è½½å™¨åŠ è½½ã€‚</p><h4 id="1-5-4-2-å¦‚ä½•æ‰“ç ´"><a href="#1-5-4-2-å¦‚ä½•æ‰“ç ´" class="headerlink" title="1.5.4.2 å¦‚ä½•æ‰“ç ´"></a>1.5.4.2 å¦‚ä½•æ‰“ç ´</h4><p>é‡å†™loadClassæ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">            <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                <span class="comment">// to find the class.</span></span><br><span class="line">                <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line">                c = findClass(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å°±é‡å†™ä¸€ä¸‹loadClassæ–¹æ³•ï¼Œé‚£ä½¿ç”¨çˆ¶åŠ è½½å™¨çš„é€»è¾‘åˆ é™¤æ‰å°±å¯ä»¥äº†ã€‚</p><p>ä½†æ˜¯ä¼šä¿ä¸€ä¸ªé”™è¯¯ï¼Œæ‰¾ä¸åˆ°Objectç±»æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.io.FileNotFoundException: /export/data/java/lang/Object.class (No such file or directory)</span><br><span class="line">at java.io.FileInputStream.open0(Native Method)</span><br><span class="line">at java.io.FileInputStream.open(FileInputStream.java:<span class="number">195</span>)</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ å› ä¸ºåœ¨javaä¸­æ‰€æœ‰çš„ç±»éƒ½æœ‰ä¸€ä¸ªå…¬å…±çš„åŸºç±» Objectï¼ŒåŠ è½½çš„æ—¶å€™ï¼Œå¦‚æœæœ‰çˆ¶ç±»ï¼Œè‚¯å®šä¼˜å…ˆåŠ è½½çˆ¶ç±»ã€‚</p><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å°è¯•ä¸€ä¸‹åœ¨ <code>/export/data/java/lang/</code>è·¯å¾„ä¸‹æ·»åŠ ä¸€ä¸‹è¿™ä¸ªç±»ï¼Œå†æ¬¡å°è¯•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.SecurityException: Prohibited package name: java.lang</span><br><span class="line">at java.lang.ClassLoader.preDefineClass(ClassLoader.java:662)</span><br><span class="line">at java.lang.ClassLoader.defineClass(ClassLoader.java:761)</span><br><span class="line">at java.lang.ClassLoader.defineClass(ClassLoader.java:642)</span><br><span class="line">at com.ibli.jvm.MyClassLoader.findClass(MyClassLoader.java:32)</span><br><span class="line">at com.ibli.jvm.MyClassLoader.loadClass(MyClassLoader.java:59)</span><br></pre></td></tr></table></figure><p>ä¾ç„¶æ˜¯ä¸å¯ä»¥çš„ï¼Œè¿™é‡ŒæŠ¥é”™ä¿¡æ¯æç¤ºçš„æ˜¯ <code>Prohibited package name: java.lang</code>ã€‚</p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>è¿™é‡Œå†ä¸€æ¬¡å°è¯äº†ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ï¼ŒJDKè‡ªå·±å®šä¹‰çš„ç±»æ–‡ä»¶ç»å¯¹ä¸å…è®¸è‡ªå®šä¹‰åŠ è½½çš„ï¼Œè¿™ä¸ªæˆ‘ä»¬è‡ªå·±çš„Objectæ˜¯ä¸å¯èƒ½è¢«åŠ è½½çš„ã€‚</p><p>å¦‚ä½•è§£å†³ä¸Šé¢çš„é—®é¢˜å‘¢ï¼Ÿ</p><p>è¿™é‡Œéœ€è¦å¯¹Objectç‰¹æ®Šå¤„ç†ä¸€ä¸‹ï¼ŒObjectå°±æ˜¯ç”¨AppClassLoaderæ¥åŠ è½½å°±è¡Œäº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!name.startsWith(<span class="string">&quot;com.ibli.jvm&quot;</span>)) &#123;</span><br><span class="line">      c = Launcher.getLauncher().getClassLoader().loadClass(name);</span><br><span class="line">      <span class="comment">// æˆ–è€… c = this.getParent().loadClass(name);</span></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">       c = findClass(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœæ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user sout ...</span><br><span class="line">com.ibli.jvm.MyClassLoader</span><br></pre></td></tr></table></figure><h3 id="1-5-5-Tomcatæ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ"><a href="#1-5-5-Tomcatæ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ" class="headerlink" title="1.5.5 Tomcatæ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ"></a>1.5.5 Tomcatæ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ</h3><h4 id="1-5-5-1-Tomcat-å¦‚æœä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾ç±»åŠ è½½æœºåˆ¶è¡Œä¸è¡Œ"><a href="#1-5-5-1-Tomcat-å¦‚æœä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾ç±»åŠ è½½æœºåˆ¶è¡Œä¸è¡Œ" class="headerlink" title="1.5.5.1 Tomcat å¦‚æœä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾ç±»åŠ è½½æœºåˆ¶è¡Œä¸è¡Œ?"></a>1.5.5.1 Tomcat å¦‚æœä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾ç±»åŠ è½½æœºåˆ¶è¡Œä¸è¡Œ?</h4><p>æˆ‘ä»¬æ€è€ƒä¸€ä¸‹: Tomcatæ˜¯ä¸ªwebå®¹å™¨ï¼Œ é‚£ä¹ˆå®ƒè¦è§£å†³ä»€ä¹ˆé—®é¢˜:</p><ul><li>ä¸€ä¸ªwebå®¹å™¨å¯èƒ½éœ€è¦éƒ¨ç½²ä¸¤ä¸ªåº”ç”¨ç¨‹åºï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šä¾èµ–åŒä¸€ä¸ªç¬¬ä¸‰æ–¹ç±»åº“çš„ä¸åŒç‰ˆæœ¬ï¼Œä¸èƒ½è¦æ±‚åŒä¸€ä¸ªç±»åº“åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨åªæœ‰ä¸€ä»½ï¼Œå› æ­¤è¦ä¿è¯æ¯ä¸ªåº”ç”¨ç¨‹åºçš„ç±»åº“éƒ½æ˜¯ ç‹¬ç«‹çš„ï¼Œä¿è¯ç›¸äº’éš”ç¦»ã€‚</li><li>éƒ¨ç½²åœ¨åŒä¸€ä¸ªwebå®¹å™¨ä¸­<strong>ç›¸åŒçš„ç±»åº“ç›¸åŒçš„ç‰ˆæœ¬</strong>å¯ä»¥å…±äº«ã€‚å¦åˆ™ï¼Œå¦‚æœæœåŠ¡å™¨æœ‰10ä¸ªåº”ç”¨ç¨‹ åºï¼Œé‚£ä¹ˆè¦æœ‰10ä»½ç›¸åŒçš„ç±»åº“åŠ è½½è¿›è™šæ‹Ÿæœºã€‚</li><li> webå®¹å™¨ä¹Ÿæœ‰è‡ªå·±ä¾èµ–çš„ç±»åº“ï¼Œä¸èƒ½ä¸åº”ç”¨ç¨‹åºçš„ç±»åº“æ··æ·†ã€‚åŸºäºå®‰å…¨è€ƒè™‘ï¼Œåº”è¯¥è®©å®¹å™¨çš„ç±»åº“å’Œç¨‹åºçš„ç±»åº“éš”ç¦»å¼€æ¥ã€‚</li><li>webå®¹å™¨è¦æ”¯æŒjspçš„ä¿®æ”¹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œjsp æ–‡ä»¶æœ€ç»ˆä¹Ÿæ˜¯è¦ç¼–è¯‘æˆclassæ–‡ä»¶æ‰èƒ½åœ¨è™šæ‹Ÿæœºä¸­ è¿è¡Œï¼Œä½†ç¨‹åºè¿è¡Œåä¿®æ”¹jspå·²ç»æ˜¯å¸ç©ºè§æƒ¯çš„äº‹æƒ…ï¼Œ webå®¹å™¨éœ€è¦æ”¯æŒ jsp ä¿®æ”¹åä¸ç”¨é‡å¯ã€‚</li></ul><h4 id="1-5-5-2-Tomcatä¸ºä»€ä¹ˆä¸ä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾"><a href="#1-5-5-2-Tomcatä¸ºä»€ä¹ˆä¸ä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾" class="headerlink" title="1.5.5.2 Tomcatä¸ºä»€ä¹ˆä¸ä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾"></a>1.5.5.2 Tomcatä¸ºä»€ä¹ˆä¸ä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾</h4><p>å¦‚æœtomcatä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾ä¼šæœ‰å“ªäº›é—®é¢˜ï¼š</p><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œ**<font color=green>å¦‚æœä½¿ç”¨é»˜è®¤çš„ç±»åŠ è½½å™¨æœºåˆ¶ï¼Œé‚£ä¹ˆæ˜¯æ— æ³•åŠ è½½ä¸¤ä¸ªç›¸åŒç±»åº“çš„ä¸åŒç‰ˆæœ¬çš„ï¼Œé»˜è®¤çš„ç±»åŠ å™¨æ˜¯ä¸ç®¡ä½ æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„ï¼Œåªåœ¨ä¹ä½ çš„å…¨é™å®šç±»åï¼Œå¹¶ä¸”åªæœ‰ä¸€ä»½</font>**ã€‚ </p><p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œé»˜è®¤çš„ç±»åŠ è½½å™¨æ˜¯èƒ½å¤Ÿå®ç°çš„ï¼Œå› ä¸ºä»–çš„èŒè´£å°±æ˜¯ä¿è¯å”¯ä¸€æ€§ã€‚ </p><p>ç¬¬ä¸‰ä¸ªé—®é¢˜å’Œç¬¬ä¸€ä¸ªé—®é¢˜ä¸€æ ·ã€‚ </p><p>æˆ‘ä»¬å†çœ‹ç¬¬å››ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æƒ³æˆ‘ä»¬è¦æ€ä¹ˆå®ç°jspæ–‡ä»¶çš„çƒ­åŠ è½½ï¼Œjsp æ–‡ä»¶å…¶å®ä¹Ÿå°±æ˜¯classæ–‡ä»¶ï¼Œé‚£ä¹ˆå¦‚æœä¿®æ”¹äº†ï¼Œä½†ç±»åè¿˜æ˜¯ä¸€æ ·ï¼Œç±»åŠ è½½å™¨ä¼šç›´æ¥å–æ–¹æ³•åŒºä¸­å·²ç»å­˜åœ¨çš„ï¼Œä¿®æ”¹åçš„jspæ˜¯ä¸ä¼šé‡æ–°åŠ è½½çš„ã€‚é‚£ä¹ˆæ€ä¹ˆåŠå‘¢? æˆ‘ä»¬å¯ä»¥ç›´æ¥å¸è½½æ‰è¿™jspæ–‡ä»¶çš„ç±»åŠ è½½å™¨ï¼Œæ‰€ä»¥ä½ åº”è¯¥æƒ³åˆ°äº†ï¼Œæ¯ä¸ªjspæ–‡ä»¶å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„ç±»åŠ è½½å™¨ï¼Œå½“ä¸€ä¸ªjspæ–‡ä»¶ä¿®æ”¹äº†ï¼Œå°±ç›´æ¥å¸è½½è¿™ä¸ªjspç±»åŠ è½½å™¨ã€‚é‡æ–°åˆ›å»ºç±»åŠ è½½å™¨ï¼Œé‡æ–°åŠ è½½jspæ–‡ä»¶ã€‚</p><h4 id="1-5-5-3-tomcatç±»åŠ è½½æµç¨‹"><a href="#1-5-5-3-tomcatç±»åŠ è½½æµç¨‹" class="headerlink" title="1.5.5.3 tomcatç±»åŠ è½½æµç¨‹"></a>1.5.5.3 tomcatç±»åŠ è½½æµç¨‹</h4><p><img src="https://oscimg.oschina.net/oscnet/up-73a62d636202f492f8da71a9246c6d6639e.png"></p><p>Tomcatçš„å‡ ä¸ªä¸»è¦ç±»åŠ è½½å™¨:</p><ul><li><p>commonLoader: Tomcatæœ€åŸºæœ¬çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯ä»¥è¢«Tomcatå®¹å™¨æœ¬èº«ä»¥åŠå„ä¸ªWebappè®¿é—®; </p></li><li><p>catalinaLoader: Tomcatå®¹å™¨ç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºWebappä¸å¯è§; </p></li><li><p>sharedLoader: å„ä¸ªWebappå…±äº«çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºæ‰€æœ‰Webappå¯è§ï¼Œä½†æ˜¯å¯¹äºTomcatå®¹å™¨ä¸å¯è§; </p></li><li><p>WebappClassLoader:å„ä¸ªWebappç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classåªå¯¹å½“å‰Webappå¯è§ï¼Œæ¯”å¦‚åŠ è½½waråŒ…é‡Œç›¸å…³çš„ç±»ï¼Œæ¯ä¸ªwaråŒ…åº”ç”¨éƒ½æœ‰è‡ªå·±çš„WebappClassLoaderï¼Œå®ç°ç›¸äº’éš”ç¦»ï¼Œæ¯”å¦‚ä¸åŒwaråŒ…åº”ç”¨å¼•å…¥äº†ä¸åŒçš„springç‰ˆæœ¬ï¼Œ è¿™æ ·å®ç°å°±èƒ½åŠ è½½å„è‡ªçš„springç‰ˆæœ¬;</p></li></ul><p>ä»å›¾ä¸­çš„å§”æ´¾å…³ç³»ä¸­å¯ä»¥çœ‹å‡º: </p><ul><li>CommonClassLoaderèƒ½åŠ è½½çš„ç±»éƒ½å¯ä»¥è¢«CatalinaClassLoaderå’ŒSharedClassLoaderä½¿ç”¨ï¼Œ ä»è€Œå®ç°äº†å…¬æœ‰ç±»åº“çš„å…±ç”¨</li><li>CatalinaClassLoaderå’ŒSharedClassLoaderè‡ªå·±èƒ½åŠ è½½çš„ç±»åˆ™ä¸å¯¹æ–¹ç›¸äº’éš”ç¦»ã€‚</li><li> WebAppClassLoaderå¯ä»¥ä½¿ç”¨SharedClassLoaderåŠ è½½åˆ°çš„ç±»ï¼Œä½†å„ä¸ªWebAppClassLoader å®ä¾‹ä¹‹é—´ç›¸äº’éš”ç¦»ã€‚ </li><li>è€ŒJasperLoaderçš„åŠ è½½èŒƒå›´ä»…ä»…æ˜¯è¿™ä¸ªJSPæ–‡ä»¶æ‰€ç¼–è¯‘å‡ºæ¥çš„é‚£ä¸€ä¸ª.Classæ–‡ä»¶ï¼Œå®ƒå‡ºç°çš„ç›®çš„å°±æ˜¯ä¸ºäº†è¢«ä¸¢å¼ƒ: <strong><font color=red>å½“Webå®¹å™¨æ£€æµ‹åˆ°JSPæ–‡ä»¶è¢«ä¿®æ”¹æ—¶ï¼Œä¼šæ›¿æ¢æ‰ç›®å‰çš„JasperLoaderçš„å®ä¾‹ï¼Œ å¹¶é€šè¿‡å†å»ºç«‹ä¸€ä¸ªæ–°çš„Jspç±»åŠ è½½å™¨æ¥å®ç°JSPæ–‡ä»¶çš„çƒ­åŠ è½½åŠŸèƒ½ã€‚</font></strong></li></ul><p>tomcat è¿™ç§ç±»åŠ è½½æœºåˆ¶è¿èƒŒäº†java æ¨èçš„åŒäº²å§”æ´¾æ¨¡å‹äº†å—? ç­”æ¡ˆæ˜¯:è¿èƒŒäº†ã€‚</p><p><strong><font color=blue> å¾ˆæ˜¾ç„¶ï¼Œtomcat ä¸ºäº†å®ç°éš”ç¦»æ€§ï¼Œæ¯ä¸ª webappClassLoaderåŠ è½½è‡ªå·±çš„ç›®å½•ä¸‹çš„classæ–‡ä»¶ï¼Œä¸ä¼šä¼ é€’ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚</font></strong></p><p>å¦‚ä½•å®ç°Tomcatçš„åŠ è½½webappçš„æ•ˆæœå‘¢ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ClassLoaderï¼Œå…¶ä¸­ä¼šæŠŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoader</span></span><br><span class="line">        MyClassLoader classLoader = <span class="keyword">new</span> MyClassLoader(<span class="string">&quot;/export/data/&quot;</span>);</span><br><span class="line">        Class clazz = classLoader.loadClass(<span class="string">&quot;com.ibli.jvm.User&quot;</span>);</span><br><span class="line">        Object obj = clazz.newInstance();</span><br><span class="line">        Method method = clazz.getDeclaredMethod(<span class="string">&quot;sout&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        method.invoke(obj, <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(clazz.getClassLoader().getClass().getName());</span><br><span class="line"></span><br><span class="line">        MyClassLoader classLoader1 = <span class="keyword">new</span> MyClassLoader(<span class="string">&quot;/export/data1/&quot;</span>);</span><br><span class="line">        Class clazz1 = classLoader.loadClass(<span class="string">&quot;com.ibli.jvm.User&quot;</span>);</span><br><span class="line">        Object obj1 = clazz.newInstance();</span><br><span class="line">        Method method1 = clazz.getDeclaredMethod(<span class="string">&quot;sout&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        method.invoke(obj, <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(clazz.getClassLoader().getClass().getName());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><ul><li>ä¸¤ä¸ªUserç±»çš„æ–‡ä»¶åç›¸åŒï¼Œä½†æ˜¯ç¼–è¯‘çš„æ—¶å€™é‡Œé¢çš„soutæ–¹æ³•è¾“å‡ºçš„å†…å®¹æ˜¯ä¸åŒçš„ï¼Œæ–¹ä¾¿åŒºåˆ†</li><li>æ„å»ºäº†ä¸¤ä¸ªåŠ è½½å™¨</li></ul><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user sout ...</span><br><span class="line">com.ibli.jvm.MyClassLoader</span><br><span class="line"></span><br><span class="line">user1 sout ...</span><br><span class="line">com.ibli.jvm.MyClassLoader</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸¤ä¸ªåŠ è½½å™¨å…¶å®ä¸æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œæ³¨æ„å‘¦ï¼</p><p>æ³¨æ„:<strong>åŒä¸€ä¸ªJVMå†…ï¼Œä¸¤ä¸ªç›¸åŒåŒ…åå’Œç±»åçš„ç±»å¯¹è±¡å¯ä»¥å…±å­˜ï¼Œå› ä¸ºä»–ä»¬çš„ç±»åŠ è½½å™¨å¯ä»¥ä¸ä¸€æ ·ï¼Œæ‰€ä»¥çœ‹ä¸¤ä¸ªç±»å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼Œé™¤äº†çœ‹ç±»çš„åŒ…åå’Œç±»åæ˜¯å¦éƒ½ç›¸åŒä¹‹å¤–ï¼Œè¿˜éœ€è¦ä»–ä»¬çš„ç±» åŠ è½½å™¨ä¹Ÿæ˜¯åŒä¸€ä¸ªæ‰èƒ½è®¤ä¸ºä»–ä»¬æ˜¯åŒä¸€ä¸ª</strong>ã€‚</p><h1 id="2-JVMæ•´ä½“ç»“æ„çš„æ·±åº¦å‰–æ"><a href="#2-JVMæ•´ä½“ç»“æ„çš„æ·±åº¦å‰–æ" class="headerlink" title="2. JVMæ•´ä½“ç»“æ„çš„æ·±åº¦å‰–æ"></a>2. JVMæ•´ä½“ç»“æ„çš„æ·±åº¦å‰–æ</h1><h2 id="2-1-JVMæ•´ä½“ç»“æ„å›¾"><a href="#2-1-JVMæ•´ä½“ç»“æ„å›¾" class="headerlink" title="2.1 JVMæ•´ä½“ç»“æ„å›¾"></a>2.1 JVMæ•´ä½“ç»“æ„å›¾</h2><p><img src="https://oscimg.oschina.net/oscnet/up-1cba664a7c4e0078f707899a9ee33412c3b.png"></p><p>JVMçš„æ•´ä½“ç»“æ„å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œä¸»è¦åˆ†æˆ3å¤§éƒ¨åˆ†ï¼š</p><ul><li>ç±»åŠ è½½å­ç³»ç»Ÿ</li><li>è¿è¡Œæ—¶æ•°æ®åŒº</li><li>å­—èŠ‚ç æ‰§è¡Œå¼•æ“</li></ul><p>æˆ‘ä»¬ç¼–å†™çš„ç¨‹åºï¼Œé€šè¿‡ç±»åŠ è½½å­ç³»ç»ŸåŠ è½½åˆ°è¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡å­—èŠ‚ç æ‰§è¡Œå¼•æ“æ¥æ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¤§ä½“æè¿°ã€‚å…¶ä¸­ï¼Œæœ€ä¸ºé‡è¦çš„ä¹Ÿå°±æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºè¿™ä¸€éƒ¨åˆ†ï¼Œä¸œè¥¿éå¸¸é‡è¦ï¼Œä¹Ÿéå¸¸å¤šï¼Œå’Œæˆ‘ä»¬å¹³æ—¶çš„ä¼˜åŒ–ä¹Ÿæ¯æ¯ç›¸å…³ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“çš„å®ä¾‹æ¥å±•å¼€åˆ†åˆ«å­¦ä¹ ä¸€ä¸‹è¿è¡Œæ—¶æ•°æ®åŒºçš„æ¯ä¸ªéƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Math</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> initData = <span class="number">666</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> User1 user1 = <span class="keyword">new</span> User1();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compute</span><span class="params">()</span> </span>&#123; <span class="comment">//ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€å—æ ˆå¸§å†…å­˜åŒºåŸŸ</span></span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> c = (a + b) * <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Math math = <span class="keyword">new</span> Math();</span><br><span class="line">        math.compute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-è™šæ‹Ÿæœºæ ˆ"><a href="#2-2-è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="2.2 è™šæ‹Ÿæœºæ ˆ"></a>2.2 è™šæ‹Ÿæœºæ ˆ</h2><p>é¦–å…ˆæ˜¯è™šæ‹Ÿæœºæ ˆä¹Ÿå«åšçº¿ç¨‹æ ˆï¼Œå…¶å®å°±æ˜¯ä¹‹å‰æˆ‘ä»¬ç»å¸¸è¯´çš„ï¼Œåˆ›å»ºjavaçº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åœ¨å†…å­˜ä¸­å­˜æ”¾ä¸€ä¸ªå•ç‹¬çš„ç©ºé—´æ¥å­˜å‚¨çº¿ç¨‹ç§æœ‰çš„æ•°æ®ï¼Œå…¶å®å°±æ˜¯çº¿ç¨‹æ ˆã€‚</p><p>Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stackï¼‰<strong>æ˜¯çº¿ç¨‹ç§æœ‰çš„</strong>ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒã€‚è™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯Javaæ–¹æ³•æ‰§è¡Œçš„çº¿ç¨‹å†…å­˜æ¨¡å‹ï¼šæ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™ï¼ŒJavaè™šæ‹Ÿæœºéƒ½ä¼šåŒæ­¥åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€è¿æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæ¯•çš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-8bae23ae1d35aef8a88ea582d816340ed96.png"></p><h3 id="2-2-1-å±€éƒ¨å˜é‡è¡¨"><a href="#2-2-1-å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="2.2.1 å±€éƒ¨å˜é‡è¡¨"></a>2.2.1 å±€éƒ¨å˜é‡è¡¨</h3><p>å±€éƒ¨å˜é‡è¡¨å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§Javaè™šæ‹ŸæœºåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceç±»å‹ï¼Œå®ƒå¹¶ä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–è€…å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰å’ŒreturnAddressç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚</p><blockquote><p>å¯¹äºå¼•ç”¨ç±»å‹çš„å¯¹è±¡ï¼Œé€šå¸¸çš„è¯´æ³•æ˜¯ï¼Œå¯¹è±¡çš„å®ä¾‹æ•°æ®å­˜æ”¾åœ¨å †ä¸­ï¼Œè€Œçº¿ç¨‹æ ˆä¸­å­˜æ”¾çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯æ ˆä¸­å­˜æ”¾çš„æ˜¯è¿™ä¸ªå¯¹è±¡åœ¨å †å†…å­˜ä¸­å®é™…çš„å†…å­˜åœ°å€ã€‚</p><p>è¿™ç§è¯´æ³•å¹¶éååˆ†å‡†ç¡®ï¼Œå®é™…çœŸæ˜¯çš„æ˜¯ï¼Œæ ˆä¸­å­˜å‚¨çš„æ˜¯è¿™ä¸ªå¯¹è±¡åœ¨C++ä¸­å¯¹åº”å¯¹è±¡çš„åœ°å€ï¼Œç„¶åé‚£ä¸ªC++å¯¹è±¡æ‰æ˜¯çœŸå®æŒ‡å‘å¯¹ä¸­çš„åœ°å€ã€‚</p></blockquote><h4 id="2-2-1-1-å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®æ€ä¹ˆå­˜å‚¨çš„ï¼Ÿ"><a href="#2-2-1-1-å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®æ€ä¹ˆå­˜å‚¨çš„ï¼Ÿ" class="headerlink" title="2.2.1.1 å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®æ€ä¹ˆå­˜å‚¨çš„ï¼Ÿ"></a>2.2.1.1 å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®æ€ä¹ˆå­˜å‚¨çš„ï¼Ÿ</h4><p>è¿™äº›æ•°æ®ç±»å‹åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„å­˜å‚¨ç©ºé—´ä»¥ <strong><font color=red>å±€éƒ¨å˜é‡æ§½ï¼ˆSlotï¼‰</font></strong> æ¥è¡¨ç¤ºï¼Œå…¶ä¸­64ä½é•¿åº¦çš„longå’Œdoubleç±»å‹çš„æ•°æ®ä¼šå ç”¨ä¸¤ä¸ªå˜é‡æ§½ï¼Œå…¶ä½™çš„æ•°æ®ç±»å‹åªå ç”¨ä¸€ä¸ªã€‚å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æœŸé—´å®Œæˆåˆ†é…ï¼Œå½“è¿›å…¥ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨æ ˆå¸§ä¸­åˆ†é…å¤šå¤§çš„å±€éƒ¨å˜é‡ç©ºé—´æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œåœ¨æ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚</p><h4 id="2-2-1-2-Slotæ§½çš„ç‰¹ç‚¹"><a href="#2-2-1-2-Slotæ§½çš„ç‰¹ç‚¹" class="headerlink" title="2.2.1.2 Slotæ§½çš„ç‰¹ç‚¹"></a>2.2.1.2 Slotæ§½çš„ç‰¹ç‚¹</h4><ul><li><p>å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡å°†ä¼šæŒ‰ç…§å£°æ˜é¡ºåºè¢«å¤åˆ¶åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªslotä¸Š</p></li><li><p>å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯ã€‚ï¼ˆæ¯”å¦‚ï¼šè®¿é—®longæˆ–è€…doubleç±»å‹å˜é‡ï¼‰</p></li><li><p>å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼ˆæ„æ€æ˜¯å½“å‰å¸§æ‰€å¯¹åº”çš„æ–¹æ³•æ˜¯æ„é€ å™¨æ–¹æ³•æˆ–è€…æ˜¯æ™®é€šçš„å®ä¾‹æ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„slotå¤„,å…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºæ’åˆ—ã€‚**(éé™æ€æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨index=0çš„ä½ç½®å­˜æ”¾thisæŒ‡é’ˆ)**</p></li><li><p>é™æ€æ–¹æ³•ä¸­ä¸èƒ½å¼•ç”¨thisï¼Œæ˜¯å› ä¸ºé™æ€æ–¹æ³•æ‰€å¯¹åº”çš„æ ˆå¸§å½“ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­ä¸å­˜åœ¨this</p></li></ul><h4 id="2-2-1-3-Slotæ§½çš„é‡å¤åˆ©ç”¨"><a href="#2-2-1-3-Slotæ§½çš„é‡å¤åˆ©ç”¨" class="headerlink" title="2.2.1.3 Slotæ§½çš„é‡å¤åˆ©ç”¨"></a>2.2.1.3 Slotæ§½çš„é‡å¤åˆ©ç”¨</h4><p>æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥é‡å¤åˆ©ç”¨çš„ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜é‡å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œè¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> b = <span class="number">0</span>;</span><br><span class="line">            b = a+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å˜é‡cä½¿ç”¨ä¹‹å‰ä»¥åŠç»é”€æ¯çš„å˜é‡bå æ®çš„slotä½ç½®</span></span><br><span class="line">        <span class="keyword">int</span> c = a+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»¥ä¸Šæƒ…å†µä¸‹ä½¿ç”¨slotçš„æ•°é‡ä¸º3ä¸ª,thiså 0å·ã€aå•ç‹¬å 1ä¸ªæ§½å·ã€cé‡å¤ä½¿ç”¨äº†bçš„æ§½å·ã€‚</p><h3 id="2-2-2-æ“ä½œæ•°æ ˆ"><a href="#2-2-2-æ“ä½œæ•°æ ˆ" class="headerlink" title="2.2.2 æ“ä½œæ•°æ ˆ"></a>2.2.2 æ“ä½œæ•°æ ˆ</h3><h4 id="2-2-2-1-ä»€ä¹ˆæ˜¯æ“ä½œæ•°æ ˆ"><a href="#2-2-2-1-ä»€ä¹ˆæ˜¯æ“ä½œæ•°æ ˆ" class="headerlink" title="2.2.2.1 ä»€ä¹ˆæ˜¯æ“ä½œæ•°æ ˆ"></a>2.2.2.1 ä»€ä¹ˆæ˜¯æ“ä½œæ•°æ ˆ</h4><p>ç›¸å¯¹äºæˆå‘˜å˜é‡ï¼ˆæˆ–å±æ€§ï¼‰ï¼Œå¦‚æœæ˜¯åŸºæœ¬æ•°æ®å˜é‡ï¼Œåˆ™åœ¨æ ˆä¸­åˆ›å»ºï¼Œéšæ ˆé”€æ¯è€Œé”€æ¯ã€‚å¯¹è±¡ä¸€èˆ¬åœ¨å †ä¸­åˆ›å»ºï¼Œæ ˆä¸­å¯¹è±¡å¥æŸ„ä¸ºå †ä¸­å¯¹è±¡çš„å¼•ç”¨ã€‚</p><blockquote><p> <strong>é€ƒé€¸åˆ†æå¯åœ¨æ ˆä¸­åˆ›å»ºå¯¹è±¡</strong> é€ƒé€¸åˆ†æå¤§æ¦‚å€¼çš„æ˜¯å¯¹è±¡æ°¸è¿œåªä½œç”¨äºå½“å‰æ–¹æ³•ï¼ˆæ ˆæ¡¢ï¼‰çš„æ—¶å€™ï¼Œå¯¹è±¡çš„åˆ›å»ºä¼šé€‰æ‹©ç›´æ¥åœ¨æ ˆä¸Šï¼Œè€Œä¸ä¼šåœ¨å †ä¸Šåˆ›å»ºã€‚</p></blockquote><p>æ˜¯ä¸€ä¸ªå…ˆè¿›åå‡ºçš„æ ˆç»“æ„,åªè¦çš„ä½œç”¨æ˜¯åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å­˜å‚¨è®¡ç®—æ‰€éœ€è¦çš„å€¼æˆ–è€…ä¸´æ—¶ç»“æœ</p><p>åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆï¼ˆpushï¼‰æˆ–å‡ºæ ˆï¼ˆpopï¼‰,æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆï¼Œä½¿ç”¨ä»–ä»¬åå†æŠŠç»“æœå‹å…¥æ ˆã€‚ï¼ˆå¦‚å­—èŠ‚ç æŒ‡ä»¤bipushæ“ä½œï¼‰æ¯”å¦‚ï¼šæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">iconst_5 å°†<span class="keyword">int</span>ç±»å‹å¸¸é‡<span class="number">5</span>å‹å…¥æ ˆ</span><br><span class="line">lconst_0 å°†<span class="keyword">long</span>ç±»å‹å¸¸é‡<span class="number">0</span>å‹å…¥æ ˆ</span><br><span class="line">lconst_1 å°†<span class="keyword">long</span>ç±»å‹å¸¸é‡<span class="number">1</span>å‹å…¥æ ˆ</span><br><span class="line">fconst_0 å°†<span class="keyword">float</span>ç±»å‹å¸¸é‡<span class="number">0</span>å‹å…¥æ ˆ</span><br><span class="line">fconst_1 å°†<span class="keyword">float</span>ç±»å‹å¸¸é‡<span class="number">1</span>å‹å…¥æ ˆ</span><br><span class="line">dconst_0 å°†<span class="keyword">double</span>ç±»å‹å¸¸é‡<span class="number">0</span>å‹å…¥æ ˆ</span><br><span class="line">dconst_1 å°†<span class="keyword">double</span>ç±»å‹å¸¸é‡<span class="number">1</span>å‹å…¥æ ˆ</span><br><span class="line">bipush å°†ä¸€ä¸ª<span class="number">8</span>ä½å¸¦ç¬¦å·æ•´æ•°å‹å…¥æ ˆ</span><br><span class="line">sipush å°†<span class="number">16</span>ä½å¸¦ç¬¦å·æ•´æ•°å‹å…¥æ ˆ</span><br><span class="line">ldc æŠŠå¸¸é‡æ± ä¸­çš„é¡¹å‹å…¥æ ˆ</span><br><span class="line">ldc_w æŠŠå¸¸é‡æ± ä¸­çš„é¡¹å‹å…¥æ ˆ(ä½¿ç”¨å®½ç´¢å¼•)</span><br><span class="line">ldc2_w æŠŠå¸¸é‡æ± ä¸­<span class="keyword">long</span>ç±»å‹æˆ–è€…<span class="keyword">double</span>ç±»å‹çš„é¡¹å‹å…¥æ ˆ(ä½¿ç”¨å®½ç´¢å¼•) ä»æ ˆä¸­çš„å±€éƒ¨å˜é‡ä¸­è£…è½½å€¼çš„æŒ‡ä»¤</span><br><span class="line">iload ä»å±€éƒ¨å˜é‡ä¸­è£…è½½<span class="keyword">int</span>ç±»å‹å€¼</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä¸€äº›å±€éƒ¨å˜é‡çš„æ“ä½œæŒ‡ä»¤ã€‚</p><p>æ¯”å¦‚ä¸Šé¢Mathçš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compute</span><span class="params">()</span> </span>&#123; <span class="comment">//ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€å—æ ˆå¸§å†…å­˜åŒºåŸŸ</span></span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> c = (a + b) * <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡åæ±‡ç¼–ä¹‹åå¯ä»¥çœ‹åˆ°è¿™ä¸ªjavaä»£ç å¯¹åº”çš„jvmæŒ‡ä»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compute</span><span class="params">()</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: iconst_1</span><br><span class="line">       <span class="number">1</span>: istore_1</span><br><span class="line">       <span class="number">2</span>: iconst_2</span><br><span class="line">       <span class="number">3</span>: istore_2</span><br><span class="line">       <span class="number">4</span>: iload_1</span><br><span class="line">       <span class="number">5</span>: iload_2</span><br><span class="line">       <span class="number">6</span>: iadd</span><br><span class="line">       <span class="number">7</span>: bipush        <span class="number">10</span></span><br><span class="line">       <span class="number">9</span>: imul</span><br><span class="line">      <span class="number">10</span>: istore_3</span><br><span class="line">      <span class="number">11</span>: iload_3</span><br><span class="line">      <span class="number">12</span>: ireturn</span><br></pre></td></tr></table></figure><h4 id="2-2-2-2-æ“ä½œæ•°æ ˆæœ‰ä»€ä¹ˆç‰¹ç‚¹"><a href="#2-2-2-2-æ“ä½œæ•°æ ˆæœ‰ä»€ä¹ˆç‰¹ç‚¹" class="headerlink" title="2.2.2.2 æ“ä½œæ•°æ ˆæœ‰ä»€ä¹ˆç‰¹ç‚¹"></a>2.2.2.2 æ“ä½œæ•°æ ˆæœ‰ä»€ä¹ˆç‰¹ç‚¹</h4><ul><li><p>æ“ä½œæ•°æ ˆï¼Œ<strong>ä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´</strong>ã€‚</p></li><li><p>æ“ä½œæ•°æ ˆå°±æ˜¯jvmæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„</p></li><li><p>æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„<strong>æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†</strong>ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„codeå±æ€§ä¸­ï¼Œä¸ºmax_stackçš„å€¼ã€‚</p></li><li><p>æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯å¯ä»¥ä»»æ„çš„javaæ•°æ®ç±»å‹.32bitçš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦,64bitçš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆæ·±åº¦å•ä½</p></li><li><p>æ“ä½œæ•°æ ˆå¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆpushå’Œå‡ºæ ˆpopæ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®</p></li><li><p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­ï¼Œå¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</p></li><li><p>æ“ä½œæ•°æ ˆä¸­çš„å…ƒç´ çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ï¼Œè¿™ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»éªŒè¯é˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µè¦å†æ¬¡éªŒè¯ã€‚</p></li></ul><h3 id="2-2-3-åŠ¨æ€é“¾æ¥"><a href="#2-2-3-åŠ¨æ€é“¾æ¥" class="headerlink" title="2.2.3 åŠ¨æ€é“¾æ¥"></a>2.2.3 åŠ¨æ€é“¾æ¥</h3><p>ä¸Šé¢è®²ç±»åŠ è½½çš„æ—¶å€™åº”è¯¥æåˆ°è¿‡ï¼Œåœ¨è§£æé˜¶æ®µ ï¼Œä¼šæŠŠç¬¦å·å¼•ç”¨è®¾ç½®æˆç›´æ¥å¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Math math = <span class="keyword">new</span> Math();</span><br><span class="line">        math.compute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚mainæ–¹æ³•ï¼Œå°±æ˜¯é™æ€ç¬¦å· ï¼Œè€Œ <code>math.compute();</code>åˆ™åªèƒ½åœ¨è¿è¡Œæ—¶åŠ¨æ€è·å–ã€‚</p><blockquote><p>è¿™éƒ¨åˆ†æ¶‰åŠåˆ°äº†javaç‰¹æ€§ä¸­çš„ <strong>å¤šæ€</strong></p></blockquote><h4 id="2-2-3-1-ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥"><a href="#2-2-3-1-ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥" class="headerlink" title="2.2.3.1 ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥"></a>2.2.3.1 ä»€ä¹ˆæ˜¯é™æ€é“¾æ¥ï½œåŠ¨æ€é“¾æ¥</h4><ul><li><strong>é™æ€é“¾æ¥</strong></li></ul><p>å½“ä¸€ä¸ª å­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿›JVMå†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ã€‚è¿™ç§æƒ…å†µä¸‹å°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥ã€‚</p><ul><li><strong>åŠ¨æ€é“¾æ¥</strong></li></ul><p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥ã€‚</p><h4 id="2-2-3-2-ä»€ä¹ˆæ˜¯ç»‘å®šï¼Ÿ"><a href="#2-2-3-2-ä»€ä¹ˆæ˜¯ç»‘å®šï¼Ÿ" class="headerlink" title="2.2.3.2 ä»€ä¹ˆæ˜¯ç»‘å®šï¼Ÿ"></a>2.2.3.2 ä»€ä¹ˆæ˜¯ç»‘å®šï¼Ÿ</h4><p>å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸ºï¼š<strong>æ—©èµ·ç»‘å®š</strong>ï¼ˆEarly Bindingï¼‰å’Œ<strong>æ™šæœŸç»‘å®š</strong>ï¼ˆLate Bingdingï¼‰ã€‚ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡ã€‚</p><ul><li><strong>æ—©æœŸç»‘å®š</strong></li></ul><p>æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ï¼Œå³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚</p><ul><li><strong>æ™šæœŸç»‘å®š</strong></li></ul><p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ç§ç»‘å®šæ–¹å¼ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºæ™šæœŸç»‘å®šã€‚</p><h4 id="2-2-3-3-æ–¹æ³•è°ƒç”¨æ˜¯æ€ä¹ˆå®ç°çš„"><a href="#2-2-3-3-æ–¹æ³•è°ƒç”¨æ˜¯æ€ä¹ˆå®ç°çš„" class="headerlink" title="2.2.3.3 æ–¹æ³•è°ƒç”¨æ˜¯æ€ä¹ˆå®ç°çš„"></a>2.2.3.3 æ–¹æ³•è°ƒç”¨æ˜¯æ€ä¹ˆå®ç°çš„</h4><ul><li><p>æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š</p><ul><li><p>1.<code>invokestatic</code>ï¼šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬ï¼›</p></li><li><p>2.<code>invokespecial</code>:è°ƒç”¨æ–¹æ³•ã€ç§æœ‰åŠçˆ¶ç±»æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬ï¼›</p></li><li><p>3.<code>invokevirtual</code>è°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•ï¼›</p></li><li><p>4.<code>invokeinterface</code>ï¼šè°ƒç”¨æ¥å£æ–¹æ³•ï¼›</p></li></ul></li><li><p>åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼ˆJava7æ–°å¢ï¼‰ï¼š</p><ul><li>5.<code>invokedynamic</code>ï¼šåŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ</li></ul></li></ul><p>å‰å››æ¡æŒ‡ä»¤å›ºåŒ–åœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œæ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œä¸å¯äººä¸ºå¹²é¢„ï¼Œè€Œ<code>invokedynamic</code>æŒ‡ä»¤åˆ™æ”¯æŒç”±ç”¨æˆ·ç¡®å®šæ–¹æ³•ç‰ˆæœ¬ã€‚</p><p>å…¶ä¸­invokestaticæŒ‡ä»¤å’ŒinvokespecialæŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ï¼›</p><p>å…¶ä¸­invokevirtualï¼ˆfinalä¿®é¥°çš„é™¤å¤–ï¼ŒJVMä¼šæŠŠfinalæ–¹æ³•è°ƒç”¨ä¹Ÿå½’ä¸ºinvokevirtualæŒ‡ä»¤ï¼Œä½†è¦æ³¨æ„finalæ–¹æ³•è°ƒç”¨ä¸æ˜¯è™šæ–¹æ³•ï¼‰ã€invokeinterfaceæŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ç§°ä¸ºè™šæ–¹æ³•ã€‚</p><p>å¦‚ä½•éªŒè¯ä¸Šé¢æ‰€è¯´çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è§£æè°ƒç”¨ä¸­éè™šæ–¹æ³•ã€è™šæ–¹æ³•çš„æµ‹è¯•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Father</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Fatheré»˜è®¤æ„é€ å™¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showStatic</span><span class="params">(String s)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Father show static&quot;</span>+s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">showFinal</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Father show final&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showCommon</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Father show common&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Son</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Son</span><span class="params">(<span class="keyword">int</span> age)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Son son = <span class="keyword">new</span> Son();</span><br><span class="line">        son.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸æ˜¯é‡å†™çš„çˆ¶ç±»æ–¹æ³•ï¼Œå› ä¸ºé™æ€æ–¹æ³•ä¸èƒ½è¢«é‡å†™</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showStatic</span><span class="params">(String s)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Son show static&quot;</span>+s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPrivate</span><span class="params">(String s)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Son show private&quot;</span>+s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//invokestatic</span></span><br><span class="line">        showStatic(<span class="string">&quot; å¤§å¤´å„¿å­&quot;</span>);</span><br><span class="line">        <span class="comment">//invokestatic</span></span><br><span class="line">        <span class="keyword">super</span>.showStatic(<span class="string">&quot; å¤§å¤´å„¿å­&quot;</span>);</span><br><span class="line">        <span class="comment">//invokespecial</span></span><br><span class="line">        showPrivate(<span class="string">&quot; hello!&quot;</span>);</span><br><span class="line">        <span class="comment">//invokespecial</span></span><br><span class="line">        <span class="keyword">super</span>.showCommon();</span><br><span class="line">        <span class="comment">//invokevirtual å› ä¸ºæ­¤æ–¹æ³•å£°æ˜æœ‰final ä¸èƒ½è¢«å­ç±»é‡å†™ï¼Œæ‰€ä»¥ä¹Ÿè®¤ä¸ºè¯¥æ–¹æ³•æ˜¯éè™šæ–¹æ³•</span></span><br><span class="line">        showFinal();</span><br><span class="line">        <span class="comment">//è™šæ–¹æ³•å¦‚ä¸‹</span></span><br><span class="line">        <span class="comment">//invokevirtual</span></span><br><span class="line">        showCommon();<span class="comment">//æ²¡æœ‰æ˜¾å¼åŠ superï¼Œè¢«è®¤ä¸ºæ˜¯è™šæ–¹æ³•ï¼Œå› ä¸ºå­ç±»å¯èƒ½é‡å†™showCommon</span></span><br><span class="line">        info();</span><br><span class="line"></span><br><span class="line">        MethodInterface in = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//invokeinterface  ä¸ç¡®å®šæ¥å£å®ç°ç±»æ˜¯å“ªä¸€ä¸ª éœ€è¦é‡å†™</span></span><br><span class="line">        in.methodA();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MethodInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶ååæ±‡ç¼–Son.class ï¼Œ å¾—åˆ°å¦‚ä¸‹å­—èŠ‚ç æŒ‡ä»¤æ–‡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">Compiled from <span class="string">&quot;Son.java&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">ibli</span>.<span class="title">jvm</span>.<span class="title">Son</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">ibli</span>.<span class="title">jvm</span>.<span class="title">Father</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> com.ibli.jvm.Son();</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method com/ibli/jvm/Father.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> com.ibli.jvm.Son(<span class="keyword">int</span>);</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       <span class="number">1</span>: invokespecial #<span class="number">2</span>                  <span class="comment">// Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: <span class="keyword">new</span>           #<span class="number">3</span>                  <span class="comment">// class com/ibli/jvm/Son</span></span><br><span class="line">       <span class="number">3</span>: dup</span><br><span class="line">       <span class="number">4</span>: invokespecial #<span class="number">2</span>                  <span class="comment">// Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">       <span class="number">7</span>: astore_1</span><br><span class="line">       <span class="number">8</span>: aload_1</span><br><span class="line">       <span class="number">9</span>: invokevirtual #<span class="number">4</span>                  <span class="comment">// Method show:()V</span></span><br><span class="line">      <span class="number">12</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showStatic</span><span class="params">(java.lang.String)</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: getstatic     #<span class="number">5</span>                  <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">       <span class="number">3</span>: <span class="keyword">new</span>           #<span class="number">6</span>                  <span class="comment">// class java/lang/StringBuilder</span></span><br><span class="line">       <span class="number">6</span>: dup</span><br><span class="line">       <span class="number">7</span>: invokespecial #<span class="number">7</span>                  <span class="comment">// Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">      <span class="number">10</span>: ldc           #<span class="number">8</span>                  <span class="comment">// String Son show static</span></span><br><span class="line">      <span class="number">12</span>: invokevirtual #<span class="number">9</span>                  <span class="comment">// Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line">      <span class="number">15</span>: aload_0</span><br><span class="line">      <span class="number">16</span>: invokevirtual #<span class="number">9</span>                  <span class="comment">// Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line">      <span class="number">19</span>: invokevirtual #<span class="number">10</span>                 <span class="comment">// Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span></span><br><span class="line">      <span class="number">22</span>: invokevirtual #<span class="number">11</span>                 <span class="comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">      <span class="number">25</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: ldc           #<span class="number">13</span>                 <span class="comment">// String  å¤§å¤´å„¿å­</span></span><br><span class="line">       <span class="number">2</span>: invokestatic  #<span class="number">14</span>                 <span class="comment">// Method showStatic:(Ljava/lang/String;)V</span></span><br><span class="line">       <span class="number">5</span>: ldc           #<span class="number">13</span>                 <span class="comment">// String  å¤§å¤´å„¿å­</span></span><br><span class="line">       <span class="number">7</span>: invokestatic  #<span class="number">15</span>                 <span class="comment">// Method com/ibli/jvm/Father.showStatic:(Ljava/lang/String;)V</span></span><br><span class="line">      <span class="number">10</span>: aload_0</span><br><span class="line">      <span class="number">11</span>: ldc           #<span class="number">16</span>                 <span class="comment">// String  hello!</span></span><br><span class="line">      <span class="number">13</span>: invokespecial #<span class="number">17</span>                 <span class="comment">// Method showPrivate:(Ljava/lang/String;)V</span></span><br><span class="line">      <span class="number">16</span>: aload_0</span><br><span class="line">      <span class="number">17</span>: invokespecial #<span class="number">18</span>                 <span class="comment">// Method com/ibli/jvm/Father.showCommon:()V</span></span><br><span class="line">      <span class="number">20</span>: aload_0</span><br><span class="line">      <span class="number">21</span>: invokevirtual #<span class="number">19</span>                 <span class="comment">// Method showFinal:()V</span></span><br><span class="line">      <span class="number">24</span>: aload_0</span><br><span class="line">      <span class="number">25</span>: invokevirtual #<span class="number">20</span>                 <span class="comment">// Method showCommon:()V</span></span><br><span class="line">      <span class="number">28</span>: aload_0</span><br><span class="line">      <span class="number">29</span>: invokevirtual #<span class="number">21</span>                 <span class="comment">// Method info:()V</span></span><br><span class="line">      <span class="number">32</span>: aconst_null</span><br><span class="line">      <span class="number">33</span>: astore_1</span><br><span class="line">      <span class="number">34</span>: aload_1</span><br><span class="line">      <span class="number">35</span>: invokeinterface #<span class="number">22</span>,  <span class="number">1</span>           <span class="comment">// InterfaceMethod com/ibli/jvm/MethodInterface.methodA:()V</span></span><br><span class="line">      <span class="number">40</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">()</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-4-æ–¹æ³•å‡ºå£"><a href="#2-2-4-æ–¹æ³•å‡ºå£" class="headerlink" title="2.2.4 æ–¹æ³•å‡ºå£"></a>2.2.4 æ–¹æ³•å‡ºå£</h3><p>1.è°ƒç”¨è€…ï¼ˆæ–¹æ³•çš„è°ƒç”¨è€…å¯èƒ½ä¹Ÿæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼‰çš„pcè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºæ—¶ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚</p><p>2.åœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼ˆExceptionï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯åªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´ åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºï¼Œç®€ç§°å¼‚å¸¸å®Œæˆå‡ºå£æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨ï¼Œæ–¹ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰¾åˆ°å¤„ç†å¼‚å¸¸çš„ä»£ç ã€‚</p><h2 id="2-2-ç¨‹åºè®¡æ•°å™¨"><a href="#2-2-ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="2.2 ç¨‹åºè®¡æ•°å™¨"></a>2.2 ç¨‹åºè®¡æ•°å™¨</h2><p>ç¨‹åºè®¡æ•°å™¨ä¹‹å‰ä¹Ÿè¢«ç§°ä¸ºPCå¯„å­˜å™¨ã€‚</p><p>ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚åœ¨Javaè™šæ‹Ÿæœºçš„æ¦‚å¿µæ¨¡å‹é‡Œ ï¼Œå­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œå®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚</p><p>ç”±äºJavaè™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢ã€åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨ï¼ˆå¯¹äºå¤šæ ¸å¤„ç†å™¨æ¥è¯´æ˜¯ä¸€ä¸ªå†…æ ¸ï¼‰éƒ½åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ã€‚å› æ­¤ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„æ¡çº¿ç¨‹ä¹‹é—´è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸ºâ€œçº¿ç¨‹ç§æœ‰â€çš„å†…å­˜ã€‚</p><p>å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªJavaæ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼›å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•ï¼Œ<strong>è¿™ä¸ªè®¡æ•°å™¨å€¼åˆ™åº”ä¸ºç©º</strong>ï¼ˆUndefinedï¼‰ã€‚</p><p><strong><font color=red>æ­¤å†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ²¡æœ‰è§„å®šä»»ä½•OutOfMemoryErroræƒ…å†µçš„åŒºåŸŸã€‚</font></strong></p><h2 id="2-3-æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#2-3-æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="2.3 æœ¬åœ°æ–¹æ³•æ ˆ"></a>2.3 æœ¬åœ°æ–¹æ³•æ ˆ</h2><p>æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stacksï¼‰ä¸è™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œå…¶åŒºåˆ«åªæ˜¯è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™æ˜¯ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•æœåŠ¡ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-8bae23ae1d35aef8a88ea582d816340ed96.png"></p><p><strong>æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</strong></p><h2 id="2-4-æ–¹æ³•åŒº"><a href="#2-4-æ–¹æ³•åŒº" class="headerlink" title="2.4 æ–¹æ³•åŒº"></a>2.4 æ–¹æ³•åŒº</h2><h3 id="2-4-1-ä»€ä¹ˆæ˜¯æ–¹æ³•åŒº"><a href="#2-4-1-ä»€ä¹ˆæ˜¯æ–¹æ³•åŒº" class="headerlink" title="2.4.1 ä»€ä¹ˆæ˜¯æ–¹æ³•åŒº"></a>2.4.1 ä»€ä¹ˆæ˜¯æ–¹æ³•åŒº</h3><p>æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰ä¸Javaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰æ•°æ®ã€‚è™½ç„¶ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå«ä½œâ€œéå †â€ï¼ˆNon-Heapï¼‰ï¼Œç›®çš„æ˜¯ä¸Javaå †åŒºåˆ†å¼€æ¥ã€‚</p><h3 id="2-4-2-æ–¹æ³•åŒºçš„å‚æ•°é…ç½®"><a href="#2-4-2-æ–¹æ³•åŒºçš„å‚æ•°é…ç½®" class="headerlink" title="2.4.2 æ–¹æ³•åŒºçš„å‚æ•°é…ç½®"></a>2.4.2 æ–¹æ³•åŒºçš„å‚æ•°é…ç½®</h3><p>å…³äºå…ƒç©ºé—´çš„JVMå‚æ•°æœ‰ä¸¤ä¸ªï¼š-XX:MetaspaceSize=Nå’Œ -XX:MaxMetaspaceSize=N<br>-XXï¼šMaxMetaspaceSizeï¼š è®¾ç½®å…ƒç©ºé—´æœ€å¤§å€¼ï¼Œ é»˜è®¤æ˜¯-1ï¼Œ å³ä¸é™åˆ¶ï¼Œ æˆ–è€…è¯´åªå—é™äºæœ¬åœ°å†…å­˜å¤§å°ã€‚<br>-XXï¼šMetaspaceSizeï¼š æŒ‡å®šå…ƒç©ºé—´è§¦å‘Fullgcçš„åˆå§‹é˜ˆå€¼(å…ƒç©ºé—´æ— å›ºå®šåˆå§‹å¤§å°)ï¼Œ ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œé»˜è®¤æ˜¯21Må·¦å³ï¼Œè¾¾åˆ°è¯¥å€¼å°±ä¼šè§¦å‘full gcè¿›è¡Œç±»å‹å¸è½½ï¼Œ åŒæ—¶æ”¶é›†å™¨ä¼šå¯¹è¯¥å€¼è¿›è¡Œè°ƒæ•´ï¼š å¦‚æœé‡Šæ”¾äº†å¤§é‡çš„ç©ºé—´ï¼Œ å°±é€‚å½“é™ä½è¯¥å€¼ï¼› å¦‚æœé‡Šæ”¾äº†å¾ˆå°‘çš„ç©ºé—´ï¼Œ é‚£ä¹ˆåœ¨ä¸è¶…è¿‡-XXï¼šMaxMetaspaceSizeï¼ˆå¦‚æœè®¾ç½®äº†çš„è¯ï¼‰ çš„æƒ…å†µä¸‹ï¼Œ é€‚å½“æé«˜è¯¥å€¼ã€‚</p><blockquote><p>è¿™ä¸ªè·Ÿæ—©æœŸjdkç‰ˆæœ¬çš„-XX:PermSizeå‚æ•°æ„æ€ä¸ä¸€æ ·ï¼Œ-XX:PermSizeä»£è¡¨æ°¸ä¹…ä»£çš„åˆå§‹å®¹é‡ã€‚</p></blockquote><p>ç”±äºè°ƒæ•´å…ƒç©ºé—´çš„å¤§å°éœ€è¦Full GCï¼Œè¿™æ˜¯éå¸¸æ˜‚è´µçš„æ“ä½œï¼Œå¦‚æœåº”ç”¨åœ¨å¯åŠ¨çš„æ—¶å€™å‘ç”Ÿå¤§é‡Full GCï¼Œé€šå¸¸éƒ½æ˜¯ç”±äºæ°¸ä¹…ä»£æˆ–å…ƒç©ºé—´å‘ç”Ÿäº†å¤§å°è°ƒæ•´ï¼ŒåŸºäºè¿™ç§æƒ…å†µï¼Œä¸€èˆ¬å»ºè®®åœ¨JVMå‚æ•°ä¸­å°†MetaspaceSizeå’ŒMaxMetaspaceSizeè®¾ç½®æˆä¸€æ ·çš„å€¼ï¼Œå¹¶è®¾ç½®å¾—æ¯”åˆå§‹å€¼è¦å¤§ï¼Œå¯¹äº8Gç‰©ç†å†…å­˜çš„æœºå™¨æ¥è¯´ï¼Œä¸€èˆ¬æˆ‘ä¼šå°†è¿™ä¸¤ä¸ªå€¼éƒ½è®¾ç½®ä¸º256Mã€‚</p><p><strong>Full GCä¼šåŒæ—¶æ”¶é›†æ–¹æ³•åŒºå’Œå †</strong></p><h2 id="2-5-å †"><a href="#2-5-å †" class="headerlink" title="2.5 å †"></a>2.5 å †</h2><h3 id="2-5-1-å †çš„åˆ†åŒºç»“æ„"><a href="#2-5-1-å †çš„åˆ†åŒºç»“æ„" class="headerlink" title="2.5.1 å †çš„åˆ†åŒºç»“æ„"></a>2.5.1 å †çš„åˆ†åŒºç»“æ„</h3><p><img src="https://oscimg.oschina.net/oscnet/up-b0c839ade955bb783a355f34bf004bdab86.png"></p><p>Javaå †ï¼ˆJava Heapï¼‰æ˜¯è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚Javaå †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼ŒJavaä¸–ç•Œé‡Œâ€œå‡ ä¹â€æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚</p><p>Javaå †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„å†…å­˜åŒºåŸŸï¼Œå› æ­¤ä¸€äº›èµ„æ–™ä¸­å®ƒä¹Ÿè¢«ç§°ä½œâ€œGCå †</p><blockquote><p>å¦‚æœä»åˆ†é…å†…å­˜çš„è§’åº¦çœ‹ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«çš„Javaå †ä¸­å¯ä»¥åˆ’åˆ†å‡ºå¤šä¸ªçº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ï¼Œä»¥æå‡å¯¹è±¡åˆ†é…æ—¶çš„æ•ˆç‡ã€‚</p></blockquote><h3 id="2-5-2-ä¸ºä»€ä¹ˆedenå’Œserviceçš„é…æ¯”æ˜¯8-1"><a href="#2-5-2-ä¸ºä»€ä¹ˆedenå’Œserviceçš„é…æ¯”æ˜¯8-1" class="headerlink" title="2.5.2 ä¸ºä»€ä¹ˆedenå’Œserviceçš„é…æ¯”æ˜¯8:1"></a>2.5.2 ä¸ºä»€ä¹ˆedenå’Œserviceçš„é…æ¯”æ˜¯8:1</h3><p> è¿™ä¸ªå’Œåƒåœ¾å›æ”¶æœºåˆ¶æœ‰å…³ï¼Œä¸»è¦è€ƒè™‘åˆ°å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯â€œæœç”Ÿæš®æ­»â€ï¼Œæ¯æ¬¡åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œéƒ½å›æ”¶ eden + 1ä¸ªserviceåŒºçš„å¯¹è±¡ï¼Œè€Œå‰©ä½™çš„å¯¹è±¡ç§»åŠ¨åˆ°å¦ä¸€ä¸ªserviceåŒºã€‚</p><p>ä¹Ÿæœ‰ä¸€äº›å¯¹è±¡å› ä¸ºæŸäº›åŸå› ï¼Œæ¯”å¦‚åˆ†ä»£å¹´é¾„è¾¾åˆ°15ï¼Œä¼šè¢«ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚</p><p>è¿™ä¸ª8:1èƒ½å¤Ÿæ›´å¤§é™åº¦çš„åˆ©ç”¨å †çš„èµ„æºã€‚</p><h3 id="2-5-3-ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"><a href="#2-5-3-ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶" class="headerlink" title="2.5.3 ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"></a>2.5.3 ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶</h3><p>è¿™ä¸ªä¸‹é¢ä¼šæœ‰ä¸“é—¨çš„åƒåœ¾å›æ”¶ç« èŠ‚å±•å¼€ã€‚ä¸»è¦æ˜¯æ¸…ç†å†…å­˜ä¸­æ²¡ç”¨çš„å¯¹è±¡ï¼Œæ˜¯é‡Šæ”¾å†…å­˜ã€‚è‡³äºåˆ¤æ–­å“ªäº›å¯¹è±¡æ˜¯â€œåƒåœ¾â€ï¼Œæœ‰å¼•ç”¨è®¡æ•°æ³•å’Œå¯è¾¾æ€§åˆ†æç­‰ã€‚</p><p>ä¸åŒåˆ†åŒºçš„å¯¹è±¡ï¼Œæ ¹æ®å®ƒçš„ç‰¹æ€§ä¹Ÿæœ‰ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾æ”¶é›†å™¨ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å †æ˜¯åƒåœ¾å›æ”¶çš„ä¸»è¦åŒºåŸŸï¼Œå½“ç„¶æ–¹æ³•åŒºä¹Ÿä¼šè¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p><h3 id="2-5-4-å¤§åé¼é¼çš„STW"><a href="#2-5-4-å¤§åé¼é¼çš„STW" class="headerlink" title="2.5.4 å¤§åé¼é¼çš„STW"></a>2.5.4 å¤§åé¼é¼çš„STW</h3><h4 id="2-5-4-1-ä»€ä¹ˆæ˜¯stwï¼Ÿ"><a href="#2-5-4-1-ä»€ä¹ˆæ˜¯stwï¼Ÿ" class="headerlink" title="2.5.4.1 ä»€ä¹ˆæ˜¯stwï¼Ÿ"></a>2.5.4.1 ä»€ä¹ˆæ˜¯stwï¼Ÿ</h4><p>Stop the world çš„ç®€ç§°ã€‚å°±æ˜¯åœ¨åƒåœ¾æ”¶é›†å™¨è¿›è¡ŒFull GCçš„æ—¶å€™ï¼Œéœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå¥½åƒæœåŠ¡åœæ­¢äº†ä¸€æ ·ã€‚</p><p>å½“ç„¶è¿™ä¸ªæ—¶é—´æ˜¯å¾ˆçŸ­æš‚çš„ã€‚æˆ‘ä»¬è¿›è¡Œè°ƒä¼˜çš„æ—¶å€™ï¼Œä¸»è¦çš„ç›®æ ‡å°±æ˜¯ä¸ºäº†å°½é‡ç¼©çŸ­STWçš„æ—¶é—´é—´éš”å’Œå‡å°‘Young GCçš„æ¬¡æ•°ã€‚</p><h4 id="2-5-4-2-ä¸ºä»€ä¹ˆä¼šæœ‰stwï¼Ÿ"><a href="#2-5-4-2-ä¸ºä»€ä¹ˆä¼šæœ‰stwï¼Ÿ" class="headerlink" title="2.5.4.2 ä¸ºä»€ä¹ˆä¼šæœ‰stwï¼Ÿ"></a>2.5.4.2 ä¸ºä»€ä¹ˆä¼šæœ‰stwï¼Ÿ</h4><p>å› ä¸ºGCçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿˜æœ‰ç”¨æˆ·çº¿ç¨‹å·¥ä½œçš„è¯ï¼ŒåŠ¿å¿…ä¼šäº§ç”Ÿæ–°çš„å¯¹è±¡ï¼Œç”šè‡³æ–°çš„åƒåœ¾ã€‚è¿™æ ·ä¼šå¯¹åƒåœ¾å›æ”¶è¿‡ç¨‹é€ æˆå¹²æ‰°ï¼Œæ— æ³•åˆ¤æ–­å“ªäº›æ˜¯æ–°ç”Ÿæˆçš„åƒåœ¾å¯¹è±¡ã€‚</p><p><strong><font color=red>é™æ€çš„å¯¹è±¡æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ å¼•ç”¨æ˜¯å­˜å‚¨åœ¨æ–¹æ³•åŒºçš„  å¯¹è±¡å®é™…æ˜¯å­˜å‚¨åœ¨å †çš„</font></strong></p><h2 id="2-6-ç›´æ¥å†…å­˜"><a href="#2-6-ç›´æ¥å†…å­˜" class="headerlink" title="2.6 ç›´æ¥å†…å­˜"></a>2.6 ç›´æ¥å†…å­˜</h2><p>ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚<strong>ä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹åœ°ä½¿ç”¨ï¼Œè€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´OutOfMemoryErrorå¼‚å¸¸å‡ºç°</strong>ã€‚</p><p>åœ¨JDK 1.4ä¸­æ–°åŠ å…¥äº†NIOï¼ˆNew Input/Outputï¼‰ç±»ï¼Œå¼•å…¥äº†ä¸€ç§åŸºäºé€šé“ï¼ˆChannelï¼‰ä¸ç¼“å†²åŒºï¼ˆBufferï¼‰çš„I/Oæ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨Nativeå‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨Javaå †é‡Œé¢çš„DirectByteBufferå¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·èƒ½åœ¨ä¸€äº›åœºæ™¯ä¸­æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†åœ¨Javaå †å’ŒNativeå †ä¸­æ¥å›å¤åˆ¶æ•°æ®ã€‚</p><p>æ˜¾ç„¶ï¼Œæœ¬æœºç›´æ¥å†…å­˜çš„åˆ†é…ä¸ä¼šå—åˆ°Javaå †å¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯ï¼Œæ—¢ç„¶æ˜¯å†…å­˜ï¼Œåˆ™è‚¯å®šè¿˜æ˜¯ä¼šå—åˆ°æœ¬æœºæ€»å†…å­˜ï¼ˆåŒ…æ‹¬ç‰©ç†å†…å­˜ã€SWAPåˆ†åŒºæˆ–è€…åˆ†é¡µæ–‡ä»¶ï¼‰å¤§å°ä»¥åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ï¼Œä¸€èˆ¬æœåŠ¡å™¨ç®¡ç†å‘˜é…ç½®è™šæ‹Ÿæœºå‚æ•°æ—¶ï¼Œä¼šæ ¹æ®å®é™…å†…å­˜å»è®¾ç½®-Xmxç­‰å‚æ•°ä¿¡æ¯ï¼Œä½†ç»å¸¸å¿½ç•¥æ‰ç›´æ¥å†…å­˜ï¼Œä½¿å¾—å„ä¸ªå†…å­˜åŒºåŸŸæ€»å’Œå¤§äºç‰©ç†å†…å­˜é™åˆ¶ï¼ˆåŒ…æ‹¬ç‰©ç†çš„å’Œæ“ä½œç³»ç»Ÿçº§çš„é™åˆ¶ï¼‰ï¼Œä»è€Œå¯¼è‡´åŠ¨æ€æ‰©å±•æ—¶å‡ºç°OutOfMemoryErrorå¼‚å¸¸ã€‚</p><h2 id="2-7-è¿è¡Œæ—¶é”™è¯¯"><a href="#2-7-è¿è¡Œæ—¶é”™è¯¯" class="headerlink" title="2.7 è¿è¡Œæ—¶é”™è¯¯"></a>2.7 è¿è¡Œæ—¶é”™è¯¯</h2><h3 id="2-7-1-OOM"><a href="#2-7-1-OOM" class="headerlink" title="2.7.1 OOM"></a>2.7.1 OOM</h3><h4 id="2-7-1-1-ä»€ä¹ˆæ˜¯OOM"><a href="#2-7-1-1-ä»€ä¹ˆæ˜¯OOM" class="headerlink" title="2.7.1.1 ä»€ä¹ˆæ˜¯OOM"></a>2.7.1.1 ä»€ä¹ˆæ˜¯OOM</h4><p>OOMï¼Œå…¨ç§°â€œOut Of Memoryâ€ï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯â€œå†…å­˜ç”¨å®Œäº†â€ï¼Œæ¥æºäºjava.lang.OutOfMemoryErrorã€‚çœ‹ä¸‹å…³äºçš„å®˜æ–¹è¯´æ˜ï¼š Thrown when the Java Virtual Machine cannot allocate an object because it is out of memory, and no more memory could be made available by the garbage collector. æ„æ€å°±æ˜¯è¯´ï¼Œå½“JVMå› ä¸ºæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥ä¸ºå¯¹è±¡åˆ†é…ç©ºé—´å¹¶ä¸”åƒåœ¾å›æ”¶å™¨ä¹Ÿå·²ç»æ²¡æœ‰ç©ºé—´å¯å›æ”¶æ—¶ï¼Œå°±ä¼šæŠ›å‡ºè¿™ä¸ª<strong>error</strong>ï¼ˆæ³¨ï¼šéexceptionï¼Œå› ä¸ºè¿™ä¸ªé—®é¢˜å·²ç»ä¸¥é‡åˆ°ä¸è¶³ä»¥è¢«åº”ç”¨å¤„ç†ï¼‰ã€‚</p><h4 id="2-7-1-2-å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸOOM"><a href="#2-7-1-2-å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸOOM" class="headerlink" title="2.7.1.2 å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸOOM"></a>2.7.1.2 å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸOOM</h4><p>æŒ‰ç…§JVMè§„èŒƒï¼ŒJAVAè™šæ‹Ÿæœºåœ¨è¿è¡Œæ—¶ä¼šç®¡ç†ä»¥ä¸‹çš„å†…å­˜åŒºåŸŸï¼š</p><ul><li>JAVAè™šæ‹Ÿæœºæ ˆï¼šJavaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼Œæ¯ä¸ªJavaæ–¹æ³•çš„æ‰§è¡Œå¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§çš„è¿›æ ˆå’Œå‡ºæ ˆçš„æ“ä½œã€‚</li><li>æœ¬åœ°æ–¹æ³•æ ˆï¼šç±»ä¼¼â€œ JAVAè™šæ‹Ÿæœºæ ˆ â€ï¼Œä½†æ˜¯ä¸ºnativeæ–¹æ³•çš„è¿è¡Œæä¾›å†…å­˜ç¯å¢ƒã€‚</li><li>JAVAå †ï¼šå¯¹è±¡å†…å­˜åˆ†é…çš„åœ°æ–¹ï¼Œå†…å­˜åƒåœ¾å›æ”¶çš„ä¸»è¦åŒºåŸŸï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«ã€‚å¯åˆ†ä¸ºæ–°ç”Ÿä»£ï¼Œè€ç”Ÿä»£ã€‚</li><li>æ–¹æ³•åŒºï¼šç”¨äºå­˜å‚¨å·²ç»è¢«JVMåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚Hotspotä¸­çš„â€œæ°¸ä¹…ä»£â€ã€‚</li><li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼šæ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œå­˜å‚¨å¸¸é‡ä¿¡æ¯ï¼Œå¦‚å„ç§å­—é¢é‡ã€ç¬¦å·å¼•ç”¨ç­‰ã€‚</li><li>ç›´æ¥å†…å­˜ï¼šå¹¶ä¸æ˜¯JVMè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œ å¯ç›´æ¥è®¿é—®çš„å†…å­˜ï¼Œ æ¯”å¦‚NIOä¼šç”¨åˆ°è¿™éƒ¨åˆ†ã€‚</li></ul><p>ç¨‹åºè®¡æ•°å™¨ï¼šå½“å‰çº¿ç¨‹æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ï¼Œçº¿ç¨‹ç§æœ‰ï¼ŒæŒ‰ç…§JVMè§„èŒƒï¼Œé™¤äº†ç¨‹åºè®¡æ•°å™¨ä¸ä¼šæŠ›å‡ºOOMå¤–ï¼Œå…¶ä»–å„ä¸ªå†…å­˜åŒºåŸŸéƒ½å¯èƒ½ä¼šæŠ›å‡ºOOMã€‚</p><h4 id="2-7-1-3-ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸOOM"><a href="#2-7-1-3-ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸOOM" class="headerlink" title="2.7.1.3 ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸOOM"></a>2.7.1.3 ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸOOM</h4><p><strong>å†…å­˜æ³„éœ²</strong>ï¼šç”³è¯·ä½¿ç”¨å®Œçš„å†…å­˜æ²¡æœ‰é‡Šæ”¾ï¼Œå¯¼è‡´è™šæ‹Ÿæœºä¸èƒ½å†æ¬¡ä½¿ç”¨è¯¥å†…å­˜ï¼Œæ­¤æ—¶è¿™æ®µå†…å­˜å°±æ³„éœ²äº†ï¼Œå› ä¸ºç”³è¯·è€…ä¸ç”¨äº†ï¼Œè€Œåˆä¸èƒ½è¢«è™šæ‹Ÿæœºåˆ†é…ç»™åˆ«äººç”¨ã€‚</p><p><strong>å†…å­˜æº¢å‡º</strong>ï¼šç”³è¯·çš„å†…å­˜è¶…å‡ºäº†JVMèƒ½æä¾›çš„å†…å­˜å¤§å°ï¼Œæ­¤æ—¶ç§°ä¹‹ä¸ºæº¢å‡ºã€‚</p><p><strong>è¶…å¤§å¯¹è±¡</strong>ï¼šé€šå¸¸æ˜¯ä¸€ä¸ªå¤§çš„æ•°ç»„</p><h4 id="2-7-1-4-è§£å†³åŠæ³•"><a href="#2-7-1-4-è§£å†³åŠæ³•" class="headerlink" title="2.7.1.4 è§£å†³åŠæ³•"></a>2.7.1.4 è§£å†³åŠæ³•</h4><ul><li>å¦‚æœæ˜¯è¶…å¤§å¯¹è±¡ï¼Œå¯ä»¥æ£€æŸ¥å…¶åˆç†æ€§ï¼Œæ¯”å¦‚æ˜¯å¦ä¸€æ¬¡æ€§æŸ¥è¯¢äº†æ•°æ®åº“å…¨éƒ¨ç»“æœï¼Œè€Œæ²¡æœ‰åšç»“æœæ•°é™åˆ¶</li><li>å¦‚æœæ˜¯ä¸šåŠ¡å³°å€¼å‹åŠ›ï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ æœºå™¨èµ„æºï¼Œæˆ–è€…åšé™æµé™çº§ã€‚</li><li>å¦‚æœæ˜¯å†…å­˜æ³„æ¼ï¼Œéœ€è¦æ‰¾åˆ°æŒæœ‰çš„å¯¹è±¡ï¼Œä¿®æ”¹ä»£ç è®¾è®¡ï¼Œæ¯”å¦‚å…³é—­æ²¡æœ‰é‡Šæ”¾çš„è¿æ¥ã€‚</li><li>æ ¹æ®ä¸šåŠ¡åˆç†é…ç½®å †å†…å­˜å‚æ•°</li></ul><h3 id="2-7-2-StackOverFlow"><a href="#2-7-2-StackOverFlow" class="headerlink" title="2.7.2 StackOverFlow"></a>2.7.2 StackOverFlow</h3><h4 id="2-7-2-1-ä»€ä¹ˆæ˜¯StackOverFlow"><a href="#2-7-2-1-ä»€ä¹ˆæ˜¯StackOverFlow" class="headerlink" title="2.7.2.1 ä»€ä¹ˆæ˜¯StackOverFlow"></a>2.7.2.1 ä»€ä¹ˆæ˜¯StackOverFlow</h4><p>StackOverflowError æ˜¯ä¸€ä¸ªjavaä¸­å¸¸å‡ºç°çš„é”™è¯¯ï¼šåœ¨jvmè¿è¡Œæ—¶çš„æ•°æ®åŒºåŸŸä¸­æœ‰ä¸€ä¸ªjavaè™šæ‹Ÿæœºæ ˆï¼Œå½“æ‰§è¡Œjavaæ–¹æ³•æ—¶ä¼šè¿›è¡Œå‹æ ˆå¼¹æ ˆçš„æ“ä½œã€‚åœ¨æ ˆä¸­ä¼šä¿å­˜å±€éƒ¨å˜é‡ï¼Œæ“ä½œæ•°æ ˆï¼Œæ–¹æ³•å‡ºå£ç­‰ç­‰ã€‚jvmè§„å®šäº†æ ˆçš„æœ€å¤§æ·±åº¦ï¼Œå½“æ‰§è¡Œæ—¶æ ˆçš„æ·±åº¦å¤§äºäº†è§„å®šçš„æ·±åº¦ï¼Œå°±ä¼šæŠ›å‡ºStackOverflowErroré”™è¯¯ã€‚</p><h4 id="2-7-2-2-å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸStackOverFlow"><a href="#2-7-2-2-å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸStackOverFlow" class="headerlink" title="2.7.2.2 å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸStackOverFlow"></a>2.7.2.2 å“ªäº›åœ°æ–¹ä¼šå‘ç”ŸStackOverFlow</h4><ul><li>è™šæ‹Ÿæœºæ ˆ/çº¿ç¨‹æ ˆ</li><li>æœ¬åœ°æ–¹æ³•æ ˆ</li></ul><h4 id="2-7-2-3-ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸStackOverFlow"><a href="#2-7-2-3-ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸStackOverFlow" class="headerlink" title="2.7.2.3 ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸStackOverFlow"></a>2.7.2.3 ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”ŸStackOverFlow</h4><ul><li>æ— é™é€’å½’å¾ªç¯è°ƒç”¨ï¼ˆæœ€å¸¸è§ï¼‰ã€‚</li><li>æ‰§è¡Œäº†å¤§é‡æ–¹æ³•ï¼Œå¯¼è‡´çº¿ç¨‹æ ˆç©ºé—´è€—å°½ã€‚</li><li>æ–¹æ³•å†…å£°æ˜äº†æµ·é‡çš„å±€éƒ¨å˜é‡ã€‚</li><li>native ä»£ç æœ‰æ ˆä¸Šåˆ†é…çš„é€»è¾‘ï¼Œå¹¶ä¸”è¦æ±‚çš„å†…å­˜è¿˜ä¸å°ï¼Œæ¯”å¦‚ java.net.SocketInputStream.read0 ä¼šåœ¨æ ˆä¸Šè¦æ±‚åˆ†é…ä¸€ä¸ª 64KB çš„ç¼“å­˜ï¼ˆ64ä½ Linuxï¼‰ã€‚</li></ul><h4 id="2-7-2-4-è§£å†³åŠæ³•"><a href="#2-7-2-4-è§£å†³åŠæ³•" class="headerlink" title="2.7.2.4 è§£å†³åŠæ³•"></a>2.7.2.4 è§£å†³åŠæ³•</h4><p>å¸¸è§çš„è§£å†³æ–¹æ³•åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>ä¿®å¤å¼•å‘æ— é™é€’å½’è°ƒç”¨çš„å¼‚å¸¸ä»£ç ï¼Œ é€šè¿‡ç¨‹åºæŠ›å‡ºçš„å¼‚å¸¸å †æ ˆï¼Œæ‰¾å‡ºä¸æ–­é‡å¤çš„ä»£ç è¡Œï¼ŒæŒ‰å›¾ç´¢éª¥ï¼Œä¿®å¤æ— é™é€’å½’ Bugã€‚</li><li>æ’æŸ¥æ˜¯å¦å­˜åœ¨ç±»ä¹‹é—´çš„å¾ªç¯ä¾èµ–ã€‚</li><li>æ’æŸ¥æ˜¯å¦å­˜åœ¨åœ¨ä¸€ä¸ªç±»ä¸­å¯¹å½“å‰ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶ä½œä¸ºè¯¥ç±»çš„å®ä¾‹å˜é‡ã€‚</li><li>é€šè¿‡ JVM å¯åŠ¨å‚æ•° -Xss å¢åŠ çº¿ç¨‹æ ˆå†…å­˜ç©ºé—´ï¼Œ æŸäº›æ­£å¸¸ä½¿ç”¨åœºæ™¯éœ€è¦æ‰§è¡Œå¤§é‡æ–¹æ³•æˆ–åŒ…å«å¤§é‡å±€éƒ¨å˜é‡ï¼Œè¿™æ—¶å¯ä»¥é€‚å½“åœ°æé«˜çº¿ç¨‹æ ˆç©ºé—´é™åˆ¶ï¼Œä¾‹å¦‚é€šè¿‡é…ç½® -Xss2m å°†çº¿ç¨‹æ ˆç©ºé—´è°ƒæ•´ä¸º 2 mbã€‚</li></ul><p>æ–¹æ³•åŒºæ˜¯å†…å­˜è¿ç»­çš„å—ï¼Ÿ</p><h1 id="3-Javaå†…å­˜åˆ†é…æœºåˆ¶"><a href="#3-Javaå†…å­˜åˆ†é…æœºåˆ¶" class="headerlink" title="3.Javaå†…å­˜åˆ†é…æœºåˆ¶"></a>3.Javaå†…å­˜åˆ†é…æœºåˆ¶</h1><p>ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æ é»˜è®¤å¼€å¯</p><p>ä»€ä¹ˆæ˜¯æ ‡é‡æ›¿æ¢</p><p>å¯¹è±¡çš„å±æ€§æ‹†æ•£ æ ˆæ¡¢åªå­˜å‡ºå±æ€§ </p><p>å¯¹è±¡åˆ›å»ºåˆ†é…çš„å†…å­˜æ˜¯è¿ç»­çš„å—</p><p>ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p><p>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Ÿä»€ä¹ˆæ˜¯å¤§å¯¹è±¡ï¼Ÿ</p><p>edenéƒ½æ”¾ä¸ä¸‹ ï¼Ÿæœ‰ä¸ªå‚æ•°å»æ§åˆ¶</p><p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ</p><p>æœ‰ä¸¤ç§åƒåœ¾æ”¶é›†å™¨æ”¯æŒæ”¶é›†å¤§å¯¹è±¡ series parNew</p><p>é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£ï¼Ÿ</p><p>å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­</p><p>å¦‚ä½•è®¾ç½®jvmå‚æ•°</p><p>å‚è€ƒå› ç´ ï¼šç³»ç»Ÿç¡¬ä»¶å‚æ•°  è¿˜è¦è€ƒè™‘å‹åŠ›å‚æ•° å¹¶å‘é‡</p><p>å¹´é¾„åŠ¨æ€åˆ¤æ–­æœºåˆ¶</p><p>ç©ºé—´æ‹…ä¿æœºåˆ¶</p><p>å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯åƒåœ¾ </p><p>å¼•ç”¨è®¡æ•°ç®—æ³• ä»¥åŠ å››ç§å¼•ç”¨</p><p><a href="https://www.processon.com/view/5fb5d9e4e0b34d0d2241b8ac?fromnew=1">jvmç»“æ„</a></p><p><a href="https://www.processon.com/view/5f781d8763768906e65d5b4d?fromnew=1">JVM æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></p><p><strong><a href="https://juejin.cn/post/6935362175322030088">JVM (ä¸‰)è¿è¡Œæ—¶æ•°æ®åŒº</a></strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶&quot;&gt;&lt;a href=&quot;#1-ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;1. ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶&quot;&gt;&lt;/a&gt;1. ä»JDKæºç å‰–æç±»åŠ è½½æœºåˆ¶&lt;/h1&gt;&lt;h2 id=&quot;1-1-ä¸ºä»€ä¹ˆéœ€è¦ç±»åŠ </summary>
      
    
    
    
    
    <category term="JVM" scheme="http://example.com/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥å­¦ä¹ å¹¶å‘ç¼–ç¨‹ï¼ˆå›¾çµ-æ¨è¿‡ï¼‰</title>
    <link href="http://example.com/wiki/%E5%B9%B6%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/"/>
    <id>http://example.com/wiki/%E5%B9%B6%E5%8F%91%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/</id>
    <published>2022-01-04T03:48:18.000Z</published>
    <updated>2022-01-13T09:21:30.535Z</updated>
    
    <content type="html"><![CDATA[<h2 id="2-volatileå…³é”®å­—"><a href="#2-volatileå…³é”®å­—" class="headerlink" title="2. volatileå…³é”®å­—"></a>2. volatileå…³é”®å­—</h2><h3 id="2-1-volatileçš„ä½œç”¨"><a href="#2-1-volatileçš„ä½œç”¨" class="headerlink" title="2.1 volatileçš„ä½œç”¨"></a>2.1 volatileçš„ä½œç”¨</h3><p><font color=red>Volatile åªèƒ½ä¿®é¥°æˆå‘˜å˜é‡ï¼Œä¸èƒ½ä¿®é¥°å±€éƒ¨å˜é‡ã€‚</font></p><blockquote><p>1ã€åŠæ—¶å¯è§æ€§   </p><p>2ã€æŒ‡ä»¤é‡æ’åº</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jmm04_CodeAtomic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> Object object = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (object)&#123;</span><br><span class="line">                        counter++;<span class="comment">//åˆ†ä¸‰æ­¥- è¯»ï¼Œè‡ªåŠ ï¼Œå†™å›</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>âš ï¸ <strong>volatileæ— æ³•ä¿è¯åŸå­æ“ä½œ</strong></p><h3 id="2-2-volatile-count-ä¸ºä»€ä¹ˆä¼šå°äºæ­£ç¡®çš„ç»“æœï¼Ÿ"><a href="#2-2-volatile-count-ä¸ºä»€ä¹ˆä¼šå°äºæ­£ç¡®çš„ç»“æœï¼Ÿ" class="headerlink" title="2.2 volatile count++ä¸ºä»€ä¹ˆä¼šå°äºæ­£ç¡®çš„ç»“æœï¼Ÿ"></a>2.2 volatile count++ä¸ºä»€ä¹ˆä¼šå°äºæ­£ç¡®çš„ç»“æœï¼Ÿ</h3><p>count++ ä¸æ˜¯åŸå­æ“ä½œï¼count = count + 1;</p><ul><li>è¯»count</li><li>è®¡ç®—count + 1</li><li>é‡æ–°èµ‹å€¼count</li></ul><blockquote><p>så¤šä¸ªçº¿ç¨‹ä¸‹å¯èƒ½ä¼šå‡ºç°å°‘åŠ çš„æƒ…å†µã€‚</p></blockquote><h4 id="2-2-1-è¿™ä¸ªæ•°æ®æ˜¯è¢«ä¸¢å¤±äº†å‘¢-è¿˜æ˜¯è¢«è¦†ç›–äº†å‘¢ï¼Ÿ"><a href="#2-2-1-è¿™ä¸ªæ•°æ®æ˜¯è¢«ä¸¢å¤±äº†å‘¢-è¿˜æ˜¯è¢«è¦†ç›–äº†å‘¢ï¼Ÿ" class="headerlink" title="2.2.1 è¿™ä¸ªæ•°æ®æ˜¯è¢«ä¸¢å¤±äº†å‘¢ è¿˜æ˜¯è¢«è¦†ç›–äº†å‘¢ï¼Ÿ"></a>2.2.1 è¿™ä¸ªæ•°æ®æ˜¯è¢«ä¸¢å¤±äº†å‘¢ è¿˜æ˜¯è¢«è¦†ç›–äº†å‘¢ï¼Ÿ</h4><p>mesiåè®®</p><h4 id="2-2-2-å¦‚ä½•ä¿è¯count-æ­£ç¡®å‘¢ï¼Ÿ"><a href="#2-2-2-å¦‚ä½•ä¿è¯count-æ­£ç¡®å‘¢ï¼Ÿ" class="headerlink" title="2.2.2 å¦‚ä½•ä¿è¯count++æ­£ç¡®å‘¢ï¼Ÿ"></a>2.2.2 å¦‚ä½•ä¿è¯count++æ­£ç¡®å‘¢ï¼Ÿ</h4><p>åŒæ­¥é” synchronized</p><h3 id="2-3-ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ"><a href="#2-3-ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ" class="headerlink" title="2.3 ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ"></a>2.3 ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ</h3><p>åœ¨ä¿è¯ç»“æœæ­£ç¡®æ€§çš„å‰æä¸‹ï¼ŒæŒ‡ä»¤ä»å†…å­˜ä¸­åŠ è½½ï¼Œé‡æ’åºä¹‹åï¼Œå¯ä»¥å‡å°‘å†…å­˜æ•°æ®åŠ è½½çš„æ¬¡æ•°ã€‚</p><p>ç¼–è¯‘å™¨é‡æ’  æŒ‡ä»¤çº§é‡æ’åº æ‰§è¡Œå™¨é‡æ’</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jmm05_CodeReorder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">0</span>, b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">            i++;</span><br><span class="line">            x = <span class="number">0</span>; y = <span class="number">0</span>;</span><br><span class="line">            a = <span class="number">0</span>; b = <span class="number">0</span>;</span><br><span class="line">            Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    shortWait(<span class="number">10000</span>);</span><br><span class="line">                    a = <span class="number">1</span>;</span><br><span class="line">                    x = b;</span><br><span class="line">                    UnsafeInstance.reflectGetUnsafe().fullFence();</span><br><span class="line">                    <span class="comment">///</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    b = <span class="number">1</span>;</span><br><span class="line">                    UnsafeInstance.reflectGetUnsafe().fullFence();</span><br><span class="line">                    y = a;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            t1.start();</span><br><span class="line">            t2.start();</span><br><span class="line">            t1.join();</span><br><span class="line">            t2.join();</span><br><span class="line"></span><br><span class="line">            String result = <span class="string">&quot;ç¬¬&quot;</span> + i + <span class="string">&quot;æ¬¡ (&quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;ï¼‰&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(x == <span class="number">0</span> &amp;&amp; y == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œæ—¶é—´å•ä½çº³ç§’</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interval</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shortWait</span><span class="params">(<span class="keyword">long</span> interval)</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        <span class="keyword">long</span> end;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            end = System.nanoTime();</span><br><span class="line">        &#125;<span class="keyword">while</span>(start + interval &gt;= end);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸è€ƒè™‘æŒ‡ä»¤é‡æ‹çš„æƒ…å†µä¸‹æœ‰å‡ ç§ç»“æœå‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = 1, y = 0;</span><br><span class="line">x = 0, y = 1;</span><br><span class="line">x = 1, y = 1;</span><br><span class="line">x = 0, y = 0; volatileç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Œä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼</span><br></pre></td></tr></table></figure><h3 id="2-4-ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„å®ç°åŸç†ï¼Ÿ"><a href="#2-4-ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„å®ç°åŸç†ï¼Ÿ" class="headerlink" title="2.4 ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„å®ç°åŸç†ï¼Ÿ"></a>2.4 ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„å®ç°åŸç†ï¼Ÿ</h3><h4 id="2-4-1-å†…å­˜å±éšœ"><a href="#2-4-1-å†…å­˜å±éšœ" class="headerlink" title="2.4.1 å†…å­˜å±éšœ"></a>2.4.1 <strong>å†…å­˜å±éšœ</strong></h4><p><img src="https://oscimg.oschina.net/oscnet/up-19f862e1ab685fc440550c90b9e3a46066b.png"></p><h3 id="2-5-æŒ‡ä»¤é‡æ’æœ‰å“ªäº›ç°å®ä¸­çš„ä¾‹å­"><a href="#2-5-æŒ‡ä»¤é‡æ’æœ‰å“ªäº›ç°å®ä¸­çš„ä¾‹å­" class="headerlink" title="2.5 æŒ‡ä»¤é‡æ’æœ‰å“ªäº›ç°å®ä¸­çš„ä¾‹å­"></a>2.5 æŒ‡ä»¤é‡æ’æœ‰å“ªäº›ç°å®ä¸­çš„ä¾‹å­</h3><h4 id="2-5-1-DCL"><a href="#2-5-1-DCL" class="headerlink" title="2.5.1 DCL"></a>2.5.1 <strong>DCL</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤</span></span><br><span class="line"><span class="comment">     * -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -Xcomp</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton myinstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒé‡é”æœºåˆ¶ä¿è¯å•ä¾‹å®‰å…¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (myinstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (myinstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    myinstance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> myinstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Singleton.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”å­—èŠ‚ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">L8</span><br><span class="line">    LINENUMBER <span class="number">26</span> L8</span><br><span class="line">    NEW com/yg/edu/jmm/dcl/Singleton</span><br><span class="line">    DUP</span><br><span class="line">    INVOKESPECIAL com/yg/edu/jmm/dcl/Singleton.&lt;init&gt; ()V</span><br><span class="line">    PUTSTATIC com/yg/edu/jmm/dcl/Singleton.myinstance : Lcom/yg/edu/jmm/dcl/Singleton;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸€ä¸ªç»å…¸çš„å•ä¾‹çš„åŒé‡æ£€æµ‹çš„ä»£ç ï¼Œè¿™æ®µä»£ç åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†å¦‚æœåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å°±å¯ä»¥å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚åŸå› åœ¨äºæŸä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°ç¬¬ä¸€æ¬¡æ£€æµ‹ï¼Œè¯»å–åˆ°çš„instanceä¸ä¸ºnullæ—¶ï¼Œinstanceçš„å¼•ç”¨å¯¹è±¡å¯èƒ½æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚</p><blockquote><p>å› ä¸ºinstance = new DoubleCheckLock();å¯ä»¥åˆ†ä¸ºä»¥ä¸‹3æ­¥å®Œæˆ(ä¼ªä»£ç )       </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memory = allocate();<span class="comment">//1.åˆ†é…å¯¹è±¡å†…å­˜ç©ºé—´ </span></span><br><span class="line">instance(memory);<span class="comment">//2.åˆå§‹åŒ–å¯¹è±¡ </span></span><br><span class="line">instance = memory;<span class="comment">//3.è®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶instanceï¼=null   </span></span><br></pre></td></tr></table></figure><p>ç”±äºæ­¥éª¤1å’Œæ­¥éª¤2é—´å¯èƒ½ä¼šé‡æ’åºï¼Œå¦‚ä¸‹ï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">memory=allocate();<span class="comment">//1.åˆ†é…å¯¹è±¡å†…å­˜ç©ºé—´ </span></span><br><span class="line">instance=memory;<span class="comment">//3.è®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶instanceï¼=nullï¼Œä½†æ˜¯å¯¹è±¡è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼ instance(memory);//2.åˆå§‹åŒ–å¯¹è±¡       </span></span><br></pre></td></tr></table></figure><p>ç”±äºæ­¥éª¤2å’Œæ­¥éª¤3ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè€Œä¸”æ— è®ºé‡æ’å‰è¿˜æ˜¯é‡æ’åç¨‹åºçš„æ‰§è¡Œç»“æœåœ¨å•çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤è¿™ç§é‡æ’ä¼˜åŒ–æ˜¯å…è®¸çš„ã€‚ä½†æ˜¯æŒ‡ä»¤é‡æ’åªä¼šä¿è¯ä¸²è¡Œè¯­ä¹‰çš„æ‰§è¡Œçš„ä¸€è‡´æ€§(å•çº¿ç¨‹)ï¼Œä½†å¹¶ä¸ä¼šå…³å¿ƒå¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¸€è‡´æ€§ã€‚æ‰€ä»¥å½“ä¸€æ¡çº¿ç¨‹è®¿é—®instanceä¸ä¸ºnullæ—¶ï¼Œç”±äºinstanceå®ä¾‹æœªå¿…å·²åˆå§‹åŒ–å®Œæˆï¼Œä¹Ÿå°±é€ æˆäº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Œå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨volatileç¦æ­¢instanceå˜é‡è¢«æ‰§è¡ŒæŒ‡ä»¤é‡æ’ä¼˜åŒ–å³å¯ã€‚</p><blockquote><p> //ç¦æ­¢æŒ‡ä»¤é‡æ’ä¼˜åŒ– private volatile static DoubleCheckLock instance; </p></blockquote><h3 id="2-6-volatileå†…å­˜è¯­ä¹‰çš„å®ç°"><a href="#2-6-volatileå†…å­˜è¯­ä¹‰çš„å®ç°" class="headerlink" title="2.6 volatileå†…å­˜è¯­ä¹‰çš„å®ç°"></a>2.6 <strong>volatileå†…å­˜è¯­ä¹‰çš„å®ç°</strong></h3><p><img src="https://oscimg.oschina.net/oscnet/up-506a15a3e2902d645d3b418d7af730b8bc0.png"></p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œç¬¬äºŒè¡Œæœ€åä¸€ä¸ªå•å…ƒæ ¼çš„æ„æ€æ˜¯ï¼šåœ¨ç¨‹åºä¸­ï¼Œå½“ç¬¬ä¸€ä¸ªæ“ä½œä¸ºæ™®é€šå˜é‡çš„è¯»æˆ–å†™æ—¶ï¼Œå¦‚æœç¬¬äºŒä¸ªæ“ä½œä¸ºvolatileå†™ï¼Œåˆ™ç¼–è¯‘å™¨ä¸èƒ½é‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚</p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼š</p><ul><li><ul><li>å½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileå†™ä¹‹åã€‚</li><li>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileè¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°volatileè¯»ä¹‹å‰ã€‚</li><li>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileå†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileè¯»æˆ–å†™æ—¶ï¼Œä¸èƒ½é‡æ’åºã€‚</li></ul></li></ul><p>ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå‘ç°ä¸€ä¸ªæœ€ä¼˜å¸ƒç½®æ¥æœ€å°åŒ–æ’å…¥å±éšœçš„æ€»æ•°å‡ ä¹ä¸å¯èƒ½ã€‚ä¸ºæ­¤ï¼ŒJMMé‡‡å–ä¿å®ˆç­–ç•¥ã€‚ä¸‹é¢æ˜¯åŸºäºä¿å®ˆç­–ç•¥çš„JMMå†…å­˜å±éšœæ’å…¥ç­–ç•¥ã€‚</p><ul><li><ul><li>Â·åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœã€‚</li><li>Â·åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœã€‚</li><li>Â·åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœã€‚</li><li>Â·åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadStoreå±éšœã€‚</li></ul></li></ul><p>ä¸Šè¿°å†…å­˜å±éšœæ’å…¥ç­–ç•¥éå¸¸ä¿å®ˆï¼Œä½†å®ƒå¯ä»¥ä¿è¯åœ¨ä»»æ„å¤„ç†å™¨å¹³å°ï¼Œä»»æ„çš„ç¨‹åºä¸­éƒ½èƒ½å¾—åˆ°æ­£ç¡®çš„volatileå†…å­˜è¯­ä¹‰ã€‚</p><h3 id="2-7-synchronizedèƒ½å¦ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ"><a href="#2-7-synchronizedèƒ½å¦ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ" class="headerlink" title="2.7 synchronizedèƒ½å¦ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ"></a>2.7 synchronizedèƒ½å¦ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Ÿ</h3><p>ä¸èƒ½</p><h3 id="2-8-å¦‚ä½•åœ¨javaä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ å†…å­˜å±éšœï¼Ÿ"><a href="#2-8-å¦‚ä½•åœ¨javaä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ å†…å­˜å±éšœï¼Ÿ" class="headerlink" title="2.8 å¦‚ä½•åœ¨javaä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ å†…å­˜å±éšœï¼Ÿ"></a>2.8 å¦‚ä½•åœ¨javaä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ å†…å­˜å±éšœï¼Ÿ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeInstance</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">reflectGetUnsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field field = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> (Unsafe) field.get(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨çš„æ—¶å€™å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    b = <span class="number">1</span>;</span><br><span class="line">    UnsafeInstance.reflectGetUnsafe().fullFence();</span><br><span class="line">    y = a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="3-MESIåè®®"><a href="#3-MESIåè®®" class="headerlink" title="3. MESIåè®®"></a>3. MESIåè®®</h2><h3 id="3-1-javaä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ"><a href="#3-1-javaä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ" class="headerlink" title="3.1 javaä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ"></a>3.1 javaä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ</h3><img src="https://oscimg.oschina.net/oscnet/up-5e2b4236c26b626b78e0a5c54ffd60478eb.png" style="zoom:50%;" /><h3 id="3-2-CPUæ˜¯å¦‚ä½•ä¸å†…å­˜äº¤äº’çš„ï¼Ÿ"><a href="#3-2-CPUæ˜¯å¦‚ä½•ä¸å†…å­˜äº¤äº’çš„ï¼Ÿ" class="headerlink" title="3.2 CPUæ˜¯å¦‚ä½•ä¸å†…å­˜äº¤äº’çš„ï¼Ÿ"></a>3.2 CPUæ˜¯å¦‚ä½•ä¸å†…å­˜äº¤äº’çš„ï¼Ÿ</h3><img src="https://oscimg.oschina.net/oscnet/up-da07e86004a11f1c46c1734fa59ba63daac.png" style="zoom:50%;" /><p><font color=red>CPUè®¿é—®å†…å­˜æ˜¯é€šè¿‡æ€»çº¿ï¼Œè€Œè®¿é—®æ€»çº¿ï¼Œå¿…é¡»å…ˆè·å–æ€»çº¿ç´¢ï¼Œè€Œlockå‰ç¼€çš„æ‰§è¡Œï¼Œå¯ä»¥è·å–æ€»çº¿é”ï¼Œé˜»å¡å…¶ä»–CPUè¿›è¡Œè®¿é—®ã€‚</font>è¿™æ˜¯æœ€åˆçš„ä¸€ç§è®¾è®¡ï¼Œè¿™ç§æ–¹å¼çš„æ•ˆç‡æ˜¾ç„¶æ˜¯å¾ˆå·®çš„ã€‚</p><h3 id="3-3-MESIåè®®å·¥ä½œæµç¨‹ï¼Ÿ"><a href="#3-3-MESIåè®®å·¥ä½œæµç¨‹ï¼Ÿ" class="headerlink" title="3.3 MESIåè®®å·¥ä½œæµç¨‹ï¼Ÿ"></a>3.3 MESIåè®®å·¥ä½œæµç¨‹ï¼Ÿ</h3><img src="https://oscimg.oschina.net/oscnet/up-8b18e489f07c8be3db2b26eb2e90524ca1b.png" style="zoom:50%;" /><h3 id="3-4-ä»€ä¹ˆæ˜¯æ€»çº¿è£å†³ï¼Ÿ"><a href="#3-4-ä»€ä¹ˆæ˜¯æ€»çº¿è£å†³ï¼Ÿ" class="headerlink" title="3.4 ä»€ä¹ˆæ˜¯æ€»çº¿è£å†³ï¼Ÿ"></a>3.4 ä»€ä¹ˆæ˜¯æ€»çº¿è£å†³ï¼Ÿ</h3><p>å¤šä¸ªcpuæ“ä½œä¸€ä¸ªæ•°æ®çš„æ—¶å€™ï¼Œå»å¯¹ç¼“å­˜è¡ŒåŠ é”çš„æ—¶å€™ï¼Œéœ€è¦æ€»çº¿æ¥åˆ¤æ–­ç»™é‚£ä¸ªcpuåŠ é”ã€‚è·å–é”çš„ç¼“å­˜è¡Œå˜æˆmçŠ¶æ€ï¼Œå…¶ä»–çš„ç¼“å­˜è¡Œå˜æˆiçŠ¶æ€ã€‚</p><h3 id="3-5-ç¼“å­˜è¡Œæ˜¯å‡ çº§ç¼“å­˜çš„ï¼Ÿ"><a href="#3-5-ç¼“å­˜è¡Œæ˜¯å‡ çº§ç¼“å­˜çš„ï¼Ÿ" class="headerlink" title="3.5 ç¼“å­˜è¡Œæ˜¯å‡ çº§ç¼“å­˜çš„ï¼Ÿ"></a>3.5 ç¼“å­˜è¡Œæ˜¯å‡ çº§ç¼“å­˜çš„ï¼Ÿ</h3><p>L1 Cache</p><h3 id="3-6-ä¸€ä¸ªç¼“å­˜è¡Œ64å­—èŠ‚è£…ä¸ä¸‹æ•°æ®ä¼šæ€æ ·ï¼Ÿ"><a href="#3-6-ä¸€ä¸ªç¼“å­˜è¡Œ64å­—èŠ‚è£…ä¸ä¸‹æ•°æ®ä¼šæ€æ ·ï¼Ÿ" class="headerlink" title="3.6 ä¸€ä¸ªç¼“å­˜è¡Œ64å­—èŠ‚è£…ä¸ä¸‹æ•°æ®ä¼šæ€æ ·ï¼Ÿ"></a>3.6 ä¸€ä¸ªç¼“å­˜è¡Œ64å­—èŠ‚è£…ä¸ä¸‹æ•°æ®ä¼šæ€æ ·ï¼Ÿ</h3><p><font color=red>å‡çº§æˆæ€»çº¿é”</font></p><h3 id="3-7-ç¼“å­˜è¡Œä¸ŠåŠ é”ä¼šå½±å“åˆ°å…¶ä»–çš„æ•°æ®å—ï¼Ÿ"><a href="#3-7-ç¼“å­˜è¡Œä¸ŠåŠ é”ä¼šå½±å“åˆ°å…¶ä»–çš„æ•°æ®å—ï¼Ÿ" class="headerlink" title="3.7 ç¼“å­˜è¡Œä¸ŠåŠ é”ä¼šå½±å“åˆ°å…¶ä»–çš„æ•°æ®å—ï¼Ÿ"></a>3.7 ç¼“å­˜è¡Œä¸ŠåŠ é”ä¼šå½±å“åˆ°å…¶ä»–çš„æ•°æ®å—ï¼Ÿ</h3><p>ï¼Ÿï¼Ÿï¼Ÿ</p><h3 id="3-8-MESIåè®®ä¸èƒ½å¯¹å¯„å­˜å™¨å¤±æ•ˆ"><a href="#3-8-MESIåè®®ä¸èƒ½å¯¹å¯„å­˜å™¨å¤±æ•ˆ" class="headerlink" title="3.8 MESIåè®®ä¸èƒ½å¯¹å¯„å­˜å™¨å¤±æ•ˆ"></a>3.8 MESIåè®®ä¸èƒ½å¯¹å¯„å­˜å™¨å¤±æ•ˆ</h3><p>å·²ç»åŠ è½½åˆ°å¯„å­˜å™¨çš„æŒ‡ä»¤ä¸èƒ½å¤±æ•ˆï¼Œæ¯”å¦‚count++æ“ä½œä¸èƒ½ä¿è¯åŸå­æ€§</p><h3 id="3-9-MESI-æ•°æ®å¤±æ•ˆä¹‹åï¼Œæ€ä¹ˆè¯»æ­£ç¡®çš„æ•°æ®å‘¢ï¼Ÿ"><a href="#3-9-MESI-æ•°æ®å¤±æ•ˆä¹‹åï¼Œæ€ä¹ˆè¯»æ­£ç¡®çš„æ•°æ®å‘¢ï¼Ÿ" class="headerlink" title="3.9 MESI æ•°æ®å¤±æ•ˆä¹‹åï¼Œæ€ä¹ˆè¯»æ­£ç¡®çš„æ•°æ®å‘¢ï¼Ÿ"></a>3.9 MESI æ•°æ®å¤±æ•ˆä¹‹åï¼Œæ€ä¹ˆè¯»æ­£ç¡®çš„æ•°æ®å‘¢ï¼Ÿ</h3><p>æ˜¯å®æ—¶å»å†…å­˜ä¸­è¯»å–æ•°æ®å—ï¼Ÿ ä¸æ˜¯çš„ã€‚</p><img src="https://oscimg.oschina.net/oscnet/up-c037376bafc96bbbe79db73378d27e402c2.png" style="zoom:50%;" /><ul><li>è·å–åˆ°lockçš„æ•°æ®ä¿®æ”¹ä¹‹åï¼Œå¹¶ä¸æ˜¯ç›´æ¥æŠŠæ•°æ®å†™åˆ°ç¼“å­˜è¡Œä¸­ï¼Œè€Œæ˜¯å†™åˆ°äº†store bufferä¸­ã€‚</li><li>è·å–lockçš„cpuåœ¨ä¿®æ”¹æ•°æ®æ˜¯ï¼Œä¼šæŠŠå½“å‰ç¼“å­˜è¡Œè®¾ç½®æˆmçŠ¶æ€ï¼ŒåŒæ—¶å‘é€ä¸€ä¸ªæ¶ˆæ¯åˆ°å…¶ä»–cpu</li><li>å…¶ä»–æ²¡æœ‰è·å–åˆ°lockçš„ç¼“å­˜è¡Œä¸­çš„æ•°æ®å°±å¤±æ•ˆäº†ï¼Œå˜æˆiçŠ¶æ€ï¼ŒåŒæ—¶æŠŠå¤±æ•ˆçš„æ•°æ®æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­</li><li>å½“å¤±æ•ˆæ•°æ®éƒ½æ”¾åˆ°ç¼“å†²é˜Ÿåˆ—ä¹‹åï¼Œè·å–lockçš„cpuæŠŠstore bufferä¸­çš„æ•°æ®åˆ·åˆ°ç¼“å­˜è¡Œä¸­ã€‚æœ€ååœ¨æ›´æ–°åˆ°å†…å­˜ä¸­ã€‚</li><li>åœ¨Cpuç©ºé—²çš„æ—¶å€™ï¼Œå°†å¤±æ•ˆçš„æ•°æ®åœ¨é˜Ÿåˆ—ä¸­æ¸…é™¤ï¼Œä¹‹å‰ä»…ä»…æ˜¯æŠŠæ•°æ®æ”¾åˆ°å¤±æ•ˆé˜Ÿåˆ—ä¸­ï¼Œç¼“å­˜è¡Œä¸­çš„æ•°æ®å…¶å®è¿˜åœ¨</li></ul><h3 id="3-10-happens-beforeåŸåˆ™"><a href="#3-10-happens-beforeåŸåˆ™" class="headerlink" title="3.10 happens-beforeåŸåˆ™"></a>3.10 happens-beforeåŸåˆ™</h3><p><img src="https://oscimg.oschina.net/oscnet/up-f9a3b32c0737241fdbbe79d7bf104de61b4.png"></p><h2 id="4ã€Synchronizedå…³é”®å­—"><a href="#4ã€Synchronizedå…³é”®å­—" class="headerlink" title="4ã€Synchronizedå…³é”®å­—"></a>4ã€Synchronizedå…³é”®å­—</h2><h3 id="4-1-synchronized-1-6ä¹‹å‰å’Œä¹‹åæœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#4-1-synchronized-1-6ä¹‹å‰å’Œä¹‹åæœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="4.1 synchronized 1.6ä¹‹å‰å’Œä¹‹åæœ‰ä»€ä¹ˆåŒºåˆ«"></a>4.1 synchronized 1.6ä¹‹å‰å’Œä¹‹åæœ‰ä»€ä¹ˆåŒºåˆ«</h3><img src="https://oscimg.oschina.net/oscnet/up-b88652d8e316f622103f29c5c917e92f5c6.png" style="zoom:50%;" /><ul><li>åå‘é”åªé’ˆå¯¹æœ‰ä¸€ä¸ªçº¿ç¨‹åŠ é”çš„æƒ…å†µ</li><li>è½»é‡çº§é”é’ˆå¯¹æœ‰å°‘æ•°çº¿ç¨‹ç«äº‰ï¼Œä½†æ˜¯ç«äº‰ä¸å¼ºçƒˆï¼ˆå¦‚ä½•å®šä¹‰ä¸å¼ºçƒˆï¼Ÿ é”å ç”¨æ—¶é—´çŸ­ï¼Œçº¿ç¨‹å¯äº¤æ›¿æ‰§è¡Œï¼‰</li><li>é‡é‡çº§é” ä¾èµ–ç®¡ç¨‹ ä¾é æ“ä½œç³»ç»Ÿåº•å±‚çš„äº’æ–¥é‡Mutex, ç”±æ“ä½œç³»ç»Ÿç»´æŠ¤ï¼Œæ¶‰åŠåˆ°CPUç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ¯”è¾ƒé‡</li></ul><h3 id="4-2-ä»€ä¹ˆæ˜¯è‡ªæ—‹é”"><a href="#4-2-ä»€ä¹ˆæ˜¯è‡ªæ—‹é”" class="headerlink" title="4.2 ä»€ä¹ˆæ˜¯è‡ªæ—‹é”"></a>4.2 ä»€ä¹ˆæ˜¯è‡ªæ—‹é”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line"><span class="keyword">do</span>....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å¤šä¸ªçº¿ç¨‹ç«äº‰é”èµ„æºçš„æ—¶å€™ï¼Œååˆ°çš„çº¿ç¨‹è‡ªæ—‹ç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹é‡Šæ”¾é”èµ„æºï¼Œç„¶åè‡ªå·±å»ç«äº‰ï¼Œè‡ªæ—‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸€ç›´å ç”¨CPUã€‚</p><p><font color=red>è‡ªæ—‹é”ä½¿ç”¨äºåŒæ­¥ä»£ç å—é‡Œé¢æ‰§è¡Œé€»è¾‘å¾ˆç®€å•æˆ–è€…æ¯”è¾ƒå¿«çš„åœºæ™¯ã€‚è¿™æ ·å¦ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¾ˆå¿«è·å¾—é”ã€‚</font></p><p><strong>è‡ªæ—‹é”æ˜¯å¤„äºæ€§èƒ½çš„è€ƒè™‘ã€‚é¿å…è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç­‰å¾…çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„æ€§èƒ½å¼€é”€ã€‚</strong></p><p>è‡ªæ—‹é”æˆåŠŸä¹‹åå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå¦‚æœè‡ªæ—‹æ¬¡æ•°å¤Ÿäº†ä¾æ—§æ²¡æœ‰è·å–åˆ°é”ï¼Œä¾¿å‡çº§æˆä¸ºé‡é‡çº§é”ã€‚</p><h3 id="4-3-é”å‡çº§çš„è¿‡ç¨‹æ˜¯å¦å¯é€†ï¼Ÿ"><a href="#4-3-é”å‡çº§çš„è¿‡ç¨‹æ˜¯å¦å¯é€†ï¼Ÿ" class="headerlink" title="4.3 é”å‡çº§çš„è¿‡ç¨‹æ˜¯å¦å¯é€†ï¼Ÿ"></a><strong>4.3 é”å‡çº§çš„è¿‡ç¨‹æ˜¯å¦å¯é€†ï¼Ÿ</strong></h3><p>ä¸å¯é€†</p><h3 id="4-4-synchronizedå¦‚ä½•ä½¿ç”¨ï¼Ÿ"><a href="#4-4-synchronizedå¦‚ä½•ä½¿ç”¨ï¼Ÿ" class="headerlink" title="4.4 synchronizedå¦‚ä½•ä½¿ç”¨ï¼Ÿ"></a>4.4 synchronizedå¦‚ä½•ä½¿ç”¨ï¼Ÿ</h3><ul><li>æ™®é€šæ–¹æ³•<ul><li>é”çš„æ˜¯å½“å‰çš„å¯¹è±¡ï¼Œå‡¡æ˜¯è¿™ä¸ªå®ä¾‹å¯¹è±¡ç›¸å…³çš„æ–¹æ³•éƒ½äº’æ–¥</li><li>å³ä¾¿è¿™ä¸ªç±»å­˜åœ¨staticçš„åŒæ­¥æ–¹æ³•ï¼Œä¸å’Œè¿™ä¸ªå®ä¾‹å¯¹è±¡ç›¸å…³çš„ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸ä¼šå†²çª</li></ul></li><li>é™æ€æ–¹æ³•<ul><li>é”èŒƒå›´æ˜¯å½“å‰ç±»å®ä¾‹</li><li>æ³¨æ„æ‰€çš„èŒƒå›´æ‰å¥½å¼„æ¸…æ¥šæ˜¯å¦å†²çª</li><li>æ™®é€šåŒæ­¥æ–¹æ³•å’Œé™æ€åŒæ­¥æ–¹æ³•ä¸å†²çªï¼Œå› ä¸ºä¸æ˜¯æ‰€çš„ä¸€ä¸ªå®ä¾‹</li></ul></li><li>æ–¹æ³•å†…éƒ¨åŒæ­¥å—<ul><li>é”çš„èŒƒå›´æœ€å°</li><li>é”å®ä¾‹ä¸€èˆ¬æ˜¯æˆå‘˜å¯¹è±¡ï¼Œä¸åŒæˆå‘˜å¯¹è±¡çš„åŒæ­¥ä»£ç å—æ‰§è¡Œä¸å†²çª</li></ul></li></ul><h3 id="4-5-synchronizedåº•å±‚åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ"><a href="#4-5-synchronizedåº•å±‚åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ" class="headerlink" title="4.5 synchronizedåº•å±‚åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ"></a>4.5 synchronizedåº•å±‚åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ</h3><p><strong>synchronizedå†…ç½®é”æ˜¯ä¸€ç§å¯¹è±¡é”(é”çš„æ˜¯å¯¹è±¡è€Œéå¼•ç”¨)ï¼Œä½œç”¨ç²’åº¦æ˜¯å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥å®ç°å¯¹ä¸´ç•Œèµ„æºçš„åŒæ­¥äº’æ–¥è®¿é—®ï¼Œæ˜¯å¯é‡å…¥çš„ã€‚</strong></p><p>synchronizedåŠ é”çš„æ–¹å¼å¦‚ä¸Šå·²ç»é˜è¿°ã€‚</p><p><strong>synchronizedæ˜¯åŸºäºJVM</strong>å†…ç½®é”å®ç°ï¼Œé€šè¿‡å†…éƒ¨å¯¹è±¡<strong>Monitor</strong>(ç›‘è§†å™¨é”)å®ç°ï¼ŒåŸºäºè¿›å…¥ä¸é€€å‡º<strong>Monitor</strong>å¯¹è±¡å®ç°æ–¹æ³•ä¸ä»£ç å—åŒæ­¥ï¼Œç›‘è§†å™¨é”çš„å®ç°ä¾èµ–åº•å±‚æ“ä½œç³»ç»Ÿçš„<strong>Mutex lock</strong>ï¼ˆäº’æ–¥é”ï¼‰å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªé‡é‡çº§é”æ€§èƒ½è¾ƒä½ã€‚å½“ç„¶ï¼Œ<strong>JVMå†…ç½®é”åœ¨1.5ä¹‹åç‰ˆæœ¬åšäº†é‡å¤§çš„ä¼˜åŒ–ï¼Œ</strong>å¦‚é”ç²—åŒ–ï¼ˆLock Coarseningï¼‰ã€é”æ¶ˆé™¤ï¼ˆLock Eliminationï¼‰ã€è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰ã€åå‘é”ï¼ˆBiased Lockingï¼‰ã€é€‚åº”æ€§è‡ªæ—‹ï¼ˆAdaptive Spinningï¼‰ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ï¼Œï¼Œå†…ç½®é”çš„å¹¶å‘æ€§èƒ½å·²ç»åŸºæœ¬ä¸LockæŒå¹³ã€‚</p><p><font color=red>synchronizedå…³é”®å­—è¢«ç¼–è¯‘æˆå­—èŠ‚ç åä¼šè¢«ç¿»è¯‘æˆmonitorenter å’Œ monitorexit ä¸¤æ¡æŒ‡ä»¤åˆ†åˆ«åœ¨åŒæ­¥å—é€»è¾‘ä»£ç çš„èµ·å§‹ä½ç½®ä¸ç»“æŸä½ç½®ã€‚</font></p><img src="https://oscimg.oschina.net/oscnet/up-53aba5e9abb1ea04b386b23591a04372c6a.png" style="zoom:50%;" /><h3 id="4-6ä»€ä¹ˆæ˜¯Monitorç›‘è§†å™¨é”ï¼Ÿ"><a href="#4-6ä»€ä¹ˆæ˜¯Monitorç›‘è§†å™¨é”ï¼Ÿ" class="headerlink" title="4.6ä»€ä¹ˆæ˜¯Monitorç›‘è§†å™¨é”ï¼Ÿ"></a>4.6ä»€ä¹ˆæ˜¯<strong>Monitorç›‘è§†å™¨é”</strong>ï¼Ÿ</h3><p><strong>Monitorç›‘è§†å™¨é”</strong></p><p>â€‹    <strong>ä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªMonitorä¸ä¹‹å…³è”ï¼Œå½“ä¸”ä¸€ä¸ªMonitorè¢«æŒæœ‰åï¼Œå®ƒå°†å¤„äºé”å®šçŠ¶æ€</strong>ã€‚Synchronizedåœ¨JVMé‡Œçš„å®ç°éƒ½æ˜¯ <strong>åŸºäºè¿›å…¥å’Œé€€å‡ºMonitorå¯¹è±¡æ¥å®ç°æ–¹æ³•åŒæ­¥å’Œä»£ç å—åŒæ­¥</strong>ï¼Œè™½ç„¶å…·ä½“å®ç°ç»†èŠ‚ä¸ä¸€æ ·ï¼Œä½†æ˜¯éƒ½å¯ä»¥é€šè¿‡æˆå¯¹çš„MonitorEnterå’ŒMonitorExitæŒ‡ä»¤æ¥å®ç°ã€‚</p><ul><li><p><strong>monitorenter</strong>ï¼šæ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªç›‘è§†å™¨é”ï¼ˆmonitorï¼‰ã€‚å½“monitorè¢«å ç”¨æ—¶å°±ä¼šå¤„äºé”å®šçŠ¶æ€ï¼Œçº¿ç¨‹æ‰§è¡ŒmonitorenteræŒ‡ä»¤æ—¶å°è¯•è·å–monitorçš„æ‰€æœ‰æƒï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p></li><li><ol><li><strong>å¦‚æœmonitorçš„è¿›å…¥æ•°ä¸º0</strong>ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥monitorï¼Œç„¶åå°†è¿›å…¥æ•°è®¾ç½®ä¸º1ï¼Œè¯¥çº¿ç¨‹å³ä¸ºmonitorçš„æ‰€æœ‰è€…ï¼›</li><li><strong>å¦‚æœçº¿ç¨‹å·²ç»å æœ‰è¯¥monitor</strong>ï¼Œåªæ˜¯é‡æ–°è¿›å…¥ï¼Œåˆ™è¿›å…¥monitorçš„è¿›å…¥æ•°åŠ 1ï¼›</li><li><strong>å¦‚æœå…¶ä»–çº¿ç¨‹å·²ç»å ç”¨äº†monitor</strong>ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°monitorçš„è¿›å…¥æ•°ä¸º0ï¼Œå†é‡æ–°å°è¯•è·å–monitorçš„æ‰€æœ‰æƒï¼›</li></ol></li><li><p><strong>monitorexit</strong>ï¼šæ‰§è¡Œmonitorexitçš„çº¿ç¨‹å¿…é¡»æ˜¯objectrefæ‰€å¯¹åº”çš„monitorçš„æ‰€æœ‰è€…ã€‚<strong>æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œmonitorçš„è¿›å…¥æ•°å‡1ï¼Œå¦‚æœå‡1åè¿›å…¥æ•°ä¸º0ï¼Œé‚£çº¿ç¨‹é€€å‡ºmonitorï¼Œä¸å†æ˜¯è¿™ä¸ªmonitorçš„æ‰€æœ‰è€…</strong>ã€‚å…¶ä»–è¢«è¿™ä¸ªmonitoré˜»å¡çš„çº¿ç¨‹å¯ä»¥å°è¯•å»è·å–è¿™ä¸ª monitor çš„æ‰€æœ‰æƒã€‚</p></li></ul><p><strong>monitorexitï¼ŒæŒ‡ä»¤å‡ºç°äº†ä¸¤æ¬¡ï¼Œç¬¬1æ¬¡ä¸ºåŒæ­¥æ­£å¸¸é€€å‡ºé‡Šæ”¾é”ï¼›ç¬¬2æ¬¡ä¸ºå‘ç”Ÿå¼‚æ­¥é€€å‡ºé‡Šæ”¾é”</strong>ï¼›</p><p>é€šè¿‡ä¸Šé¢ä¸¤æ®µæè¿°ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¾ˆæ¸…æ¥šçš„çœ‹å‡ºSynchronizedçš„å®ç°åŸç†ï¼Œ<strong>Synchronizedçš„è¯­ä¹‰åº•å±‚æ˜¯é€šè¿‡ä¸€ä¸ªmonitorçš„å¯¹è±¡æ¥å®Œæˆï¼Œå…¶å®wait/notifyç­‰æ–¹æ³•ä¹Ÿä¾èµ–äºmonitorå¯¹è±¡</strong>ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨wait/notifyç­‰æ–¹æ³•ï¼Œ<strong>å¦åˆ™ä¼šæŠ›å‡ºjava.lang.IllegalMonitorStateExceptionçš„å¼‚å¸¸çš„åŸå› </strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedMethod</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç¼–è¯‘å¦‚ä¸‹ï¼š</p><p><img src="https://oscimg.oschina.net/oscnet/up-e69029578748db53d6ce688c724f4771610.png"></p><p>ä»ç¼–è¯‘çš„ç»“æœæ¥çœ‹ï¼Œæ–¹æ³•çš„åŒæ­¥å¹¶æ²¡æœ‰é€šè¿‡æŒ‡ä»¤ <strong>monitorenter</strong> å’Œ <strong>monitorexit</strong> æ¥å®Œæˆï¼ˆç†è®ºä¸Šå…¶å®ä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸¤æ¡æŒ‡ä»¤æ¥å®ç°ï¼‰ï¼Œä¸è¿‡ç›¸å¯¹äºæ™®é€šæ–¹æ³•ï¼Œå…¶å¸¸é‡æ± ä¸­å¤šäº† <strong>ACC_SYNCHRONIZED</strong> æ ‡ç¤ºç¬¦ã€‚<strong>JVMå°±æ˜¯æ ¹æ®è¯¥æ ‡ç¤ºç¬¦æ¥å®ç°æ–¹æ³•çš„åŒæ­¥çš„</strong>ï¼š</p><p><font color=red>å½“æ–¹æ³•è°ƒç”¨æ—¶ï¼Œ<strong>è°ƒç”¨æŒ‡ä»¤å°†ä¼šæ£€æŸ¥æ–¹æ³•çš„ ACC_SYNCHRONIZED è®¿é—®æ ‡å¿—æ˜¯å¦è¢«è®¾ç½®</strong>ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œ<strong>æ‰§è¡Œçº¿ç¨‹å°†å…ˆè·å–monitor</strong>ï¼Œè·å–æˆåŠŸä¹‹åæ‰èƒ½æ‰§è¡Œæ–¹æ³•ä½“ï¼Œ<strong>æ–¹æ³•æ‰§è¡Œå®Œåå†é‡Šæ”¾monitor</strong>ã€‚åœ¨æ–¹æ³•æ‰§è¡ŒæœŸé—´ï¼Œå…¶ä»–ä»»ä½•çº¿ç¨‹éƒ½æ— æ³•å†è·å¾—åŒä¸€ä¸ªmonitorå¯¹è±¡ã€‚</font></p><p>ä¸¤ç§åŒæ­¥æ–¹å¼æœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯æ–¹æ³•çš„åŒæ­¥æ˜¯ä¸€ç§éšå¼çš„æ–¹å¼æ¥å®ç°ï¼Œæ— éœ€é€šè¿‡å­—èŠ‚ç æ¥å®Œæˆã€‚<strong>ä¸¤ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œæ˜¯JVMé€šè¿‡è°ƒç”¨æ“ä½œç³»ç»Ÿçš„äº’æ–¥åŸè¯­mutexæ¥å®ç°ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ã€ç­‰å¾…é‡æ–°è°ƒåº¦</strong>ï¼Œä¼šå¯¼è‡´â€œç”¨æˆ·æ€å’Œå†…æ ¸æ€â€ä¸¤ä¸ªæ€ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œå¯¹æ€§èƒ½æœ‰è¾ƒå¤§å½±å“ã€‚</p><h4 id="ä»€ä¹ˆæ˜¯monitorï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯monitorï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯monitorï¼Ÿ"></a><strong>ä»€ä¹ˆæ˜¯monitorï¼Ÿ</strong></h4><p>å¯ä»¥æŠŠå®ƒç†è§£ä¸º <strong>ä¸€ä¸ªåŒæ­¥å·¥å…·</strong>ï¼Œä¹Ÿå¯ä»¥æè¿°ä¸º <strong>ä¸€ç§åŒæ­¥æœºåˆ¶</strong>ï¼Œå®ƒé€šå¸¸è¢« <strong>æè¿°ä¸ºä¸€ä¸ªå¯¹è±¡</strong>ã€‚ä¸ä¸€åˆ‡çš†å¯¹è±¡ä¸€æ ·ï¼Œæ‰€æœ‰çš„Javaå¯¹è±¡æ˜¯å¤©ç”Ÿçš„Monitorï¼Œæ¯ä¸€ä¸ªJavaå¯¹è±¡éƒ½æœ‰æˆä¸ºMonitorçš„æ½œè´¨ï¼Œ<strong>å› ä¸ºåœ¨Javaçš„è®¾è®¡ä¸­ ï¼Œæ¯ä¸€ä¸ªJavaå¯¹è±¡è‡ªæ‰“å¨˜èƒé‡Œå‡ºæ¥å°±å¸¦äº†ä¸€æŠŠçœ‹ä¸è§çš„é”ï¼Œå®ƒå«åšå†…éƒ¨é”æˆ–è€…Monitoré”</strong>ã€‚<strong>ä¹Ÿå°±æ˜¯é€šå¸¸è¯´Synchronizedçš„å¯¹è±¡é”ï¼ŒMarkWordé”æ ‡è¯†ä½ä¸º10ï¼Œå…¶ä¸­æŒ‡é’ˆæŒ‡å‘çš„æ˜¯Monitorå¯¹è±¡çš„èµ·å§‹åœ°å€</strong>ã€‚åœ¨Javaè™šæ‹Ÿæœºï¼ˆHotSpotï¼‰ä¸­ï¼Œ<strong>Monitoræ˜¯ç”±ObjectMonitorå®ç°çš„</strong>ï¼Œå…¶ä¸»è¦æ•°æ®ç»“æ„å¦‚ä¸‹ï¼ˆä½äºHotSpotè™šæ‹Ÿæœºæºç ObjectMonitor.hppæ–‡ä»¶ï¼ŒC++å®ç°çš„ï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ObjectMonitor</span>() &#123;</span><br><span class="line">    _header       = <span class="literal">NULL</span>;</span><br><span class="line">    _count        = <span class="number">0</span>; <span class="comment">// è®°å½•ä¸ªæ•°</span></span><br><span class="line">    _waiters      = <span class="number">0</span>,</span><br><span class="line">    _recursions   = <span class="number">0</span>;</span><br><span class="line">    _object       = <span class="literal">NULL</span>;</span><br><span class="line">    _owner        = <span class="literal">NULL</span>;</span><br><span class="line">    _WaitSet      = <span class="literal">NULL</span>; <span class="comment">// å¤„äºwaitçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°_WaitSet</span></span><br><span class="line">    _WaitSetLock  = <span class="number">0</span> ;</span><br><span class="line">    _Responsible  = <span class="literal">NULL</span> ;</span><br><span class="line">    _succ         = <span class="literal">NULL</span> ;</span><br><span class="line">    _cxq          = <span class="literal">NULL</span> ;</span><br><span class="line">    FreeNext      = <span class="literal">NULL</span> ;</span><br><span class="line">    _EntryList    = <span class="literal">NULL</span> ; <span class="comment">// å¤„äºç­‰å¾…é”blockçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°è¯¥åˆ—è¡¨</span></span><br><span class="line">    _SpinFreq     = <span class="number">0</span> ;</span><br><span class="line">    _SpinClock    = <span class="number">0</span> ;</span><br><span class="line">    OwnerIsThread = <span class="number">0</span> ;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ObjectMonitorä¸­æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œ**_WaitSet å’Œ _EntryList<strong>ï¼Œç”¨æ¥ä¿å­˜ObjectWaiterå¯¹è±¡åˆ—è¡¨ï¼ˆ <strong>æ¯ä¸ªç­‰å¾…é”çš„çº¿ç¨‹éƒ½ä¼šè¢«å°è£…æˆObjectWaiterå¯¹è±¡</strong> ï¼‰ï¼Œ</strong>_owneræŒ‡å‘æŒæœ‰ObjectMonitorå¯¹è±¡çš„çº¿ç¨‹**ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€æ®µåŒæ­¥ä»£ç æ—¶ï¼š</p><ol><li>é¦–å…ˆä¼šè¿›å…¥ _EntryList é›†åˆï¼Œ<strong>å½“çº¿ç¨‹è·å–åˆ°å¯¹è±¡çš„monitoråï¼Œè¿›å…¥ _OwneråŒºåŸŸå¹¶æŠŠmonitorä¸­çš„ownerå˜é‡è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼ŒåŒæ—¶monitorä¸­çš„è®¡æ•°å™¨countåŠ 1</strong>ï¼›</li><li>è‹¥çº¿ç¨‹è°ƒç”¨ wait() æ–¹æ³•ï¼Œ<strong>å°†é‡Šæ”¾å½“å‰æŒæœ‰çš„monitorï¼Œownerå˜é‡æ¢å¤ä¸ºnullï¼Œcountè‡ªå‡1ï¼ŒåŒæ—¶è¯¥çº¿ç¨‹è¿›å…¥ WaitSeté›†åˆä¸­ç­‰å¾…è¢«å”¤é†’</strong>ï¼›</li><li>è‹¥å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œ**ä¹Ÿå°†é‡Šæ”¾monitorï¼ˆé”ï¼‰å¹¶å¤ä½countçš„å€¼ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹è¿›å…¥è·å–monitor(é”)**ï¼›</li></ol><p>åŒæ—¶ï¼Œ<strong>Monitorå¯¹è±¡å­˜åœ¨äºæ¯ä¸ªJavaå¯¹è±¡çš„å¯¹è±¡å¤´Mark Wordä¸­ï¼ˆå­˜å‚¨çš„æŒ‡é’ˆçš„æŒ‡å‘ï¼‰ï¼ŒSynchronizedé”ä¾¿æ˜¯é€šè¿‡è¿™ç§æ–¹å¼è·å–é”çš„</strong>ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆJavaä¸­ä»»æ„å¯¹è±¡å¯ä»¥ä½œä¸ºé”çš„åŸå› ï¼Œ<strong>åŒæ—¶notify/notifyAll/waitç­‰æ–¹æ³•ä¼šä½¿ç”¨åˆ°Monitoré”å¯¹è±¡ï¼Œæ‰€ä»¥å¿…é¡»åœ¨åŒæ­¥ä»£ç å—ä¸­ä½¿ç”¨</strong>ã€‚ç›‘è§†å™¨Monitoræœ‰ä¸¤ç§åŒæ­¥æ–¹å¼ï¼š<strong>äº’æ–¥ä¸åä½œ</strong>ã€‚å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çº¿ç¨‹ä¹‹é—´å¦‚æœéœ€è¦å…±äº«æ•°æ®ï¼Œéœ€è¦è§£å†³äº’æ–¥è®¿é—®æ•°æ®çš„é—®é¢˜ï¼Œ<strong>ç›‘è§†å™¨å¯ä»¥ç¡®ä¿ç›‘è§†å™¨ä¸Šçš„æ•°æ®åœ¨åŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®</strong>ã€‚</p><h3 id="4-7-å¯¹è±¡å¤´ä¸­é”æ˜¯å¦‚ä½•æ ‡è®°çš„ï¼Ÿ"><a href="#4-7-å¯¹è±¡å¤´ä¸­é”æ˜¯å¦‚ä½•æ ‡è®°çš„ï¼Ÿ" class="headerlink" title="4.7 å¯¹è±¡å¤´ä¸­é”æ˜¯å¦‚ä½•æ ‡è®°çš„ï¼Ÿ"></a>4.7 å¯¹è±¡å¤´ä¸­é”æ˜¯å¦‚ä½•æ ‡è®°çš„ï¼Ÿ</h3><p>32ä½è™šæ‹Ÿæœºçš„å¯¹è±¡å¤´å¦‚ä¸‹ğŸ‘‡</p><p><img src="https://oscimg.oschina.net/oscnet/up-f5d9bf5e5d69b16c4201310d0401065d8b0.png"></p><h3 id="4-8-é”å¯¹è±¡hashCodeåœ¨å„ç§çŠ¶æ€ä¸‹éƒ½å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ"><a href="#4-8-é”å¯¹è±¡hashCodeåœ¨å„ç§çŠ¶æ€ä¸‹éƒ½å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ" class="headerlink" title="4.8 é”å¯¹è±¡hashCodeåœ¨å„ç§çŠ¶æ€ä¸‹éƒ½å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ"></a>4.8 é”å¯¹è±¡hashCodeåœ¨å„ç§çŠ¶æ€ä¸‹éƒ½å­˜æ”¾åœ¨é‚£é‡Œï¼Ÿ</h3><ul><li>æ— é”çŠ¶æ€ä¸‹hashcodeå­˜æ”¾åœ¨markwordä¸­</li><li>åå‘é”è°ƒç”¨hashcodeä¼šå‡çº§æˆè½»é‡çº§é”</li><li>è½»é‡çº§é”çš„hashCodeå­˜æ”¾åœ¨çº¿ç¨‹æ ˆçš„Lock Recordä¸­</li><li>é‡é‡çº§é”çš„hashCodeå­˜æ”¾åœ¨Monitorä¸­</li></ul><h3 id="4-9-éªŒè¯é”æ ‡å¿—"><a href="#4-9-éªŒè¯é”æ ‡å¿—" class="headerlink" title="4.9 éªŒè¯é”æ ‡å¿—"></a>4.9 éªŒè¯é”æ ‡å¿—</h3><p>é¡¹ç›®ä¸­å¼•å…¥ä¸€ä¸‹ä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.openjdk.jol&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;jol-core&lt;/artifactId&gt;</span><br><span class="line">   &lt;version&gt;<span class="number">0.10</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>æ‰“å°é”å¯¹è±¡çš„å¯¹è±¡å¤´ï¼Œå¦‚ä¸‹ï¼š </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"><span class="comment">//  TimeUnit.SECONDS.sleep(5);</span></span><br><span class="line">    Object o = <span class="keyword">new</span> Object();</span><br><span class="line">    System.out.println(<span class="string">&quot;a   &quot;</span> + ClassLayout.parseInstance(o).toPrintable());</span><br><span class="line">    o.hashCode();</span><br><span class="line">    System.out.println(<span class="string">&quot;b    &quot;</span> + ClassLayout.parseInstance(o).toPrintable());</span><br><span class="line">    <span class="keyword">synchronized</span> (o)&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;c   &quot;</span> + ClassLayout.parseInstance(o).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-9-ä¸€å¼€å§‹è¦sleep5-ç§’æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ"><a href="#4-9-ä¸€å¼€å§‹è¦sleep5-ç§’æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ" class="headerlink" title="4.9 ä¸€å¼€å§‹è¦sleep5 ç§’æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ"></a>4.9 ä¸€å¼€å§‹è¦sleep5 ç§’æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</h3><p>å› ä¸ºjvmåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œè¦åˆå§‹åŒ–å¾ˆå¤šçš„æ•°æ®ï¼Œä¼šæ¶‰åŠåˆ°å¾ˆå¤šå¯¹è±¡å¤„äºåå‘é”ã€‚</p><ul><li>å¦‚æœä¸€å¼€å§‹ä¸sleepï¼Œç¬¬ä¸€æ¬¡æ‰“å°æ˜¯æ— é”çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡æ‰“å°ï¼Œæ˜¯è½»é‡çº§é”ï¼Œå› ä¸ºæ­¤æ—¶è¿›ç¨‹ä¸­å¯èƒ½æœ‰å¾ˆå¤šåå‘é”å ç”¨CPU,è¿™é‡Œç›´æ¥å‡çº§ä¸ºè½»é‡çº§é”</li><li>ä¸€å¼€å§‹sleepï¼Œé”å¯¹è±¡ä¼šæ˜¯åå‘é”çš„çŠ¶æ€ï¼Œç„¶ååªæœ‰ä¸€ä¸ªçº¿ç¨‹ç«äº‰ï¼Œç¬¬äºŒæ¬¡æ‰“å°ä¹Ÿè¿˜æ˜¯åå‘é”</li></ul><h3 id="4-10-ä»€ä¹ˆæ˜¯åŒ¿ååå‘ï¼Ÿ"><a href="#4-10-ä»€ä¹ˆæ˜¯åŒ¿ååå‘ï¼Ÿ" class="headerlink" title="4.10 ä»€ä¹ˆæ˜¯åŒ¿ååå‘ï¼Ÿ"></a>4.10 ä»€ä¹ˆæ˜¯åŒ¿ååå‘ï¼Ÿ</h3><h3 id="4-11-ä¸ºä»€ä¹ˆåå‘é”çš„å¯¹è±¡è°ƒç”¨hashCodeæ–¹æ³•ä¹‹åï¼Œä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Ÿ"><a href="#4-11-ä¸ºä»€ä¹ˆåå‘é”çš„å¯¹è±¡è°ƒç”¨hashCodeæ–¹æ³•ä¹‹åï¼Œä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Ÿ" class="headerlink" title="4.11 ä¸ºä»€ä¹ˆåå‘é”çš„å¯¹è±¡è°ƒç”¨hashCodeæ–¹æ³•ä¹‹åï¼Œä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Ÿ"></a>4.11 ä¸ºä»€ä¹ˆåå‘é”çš„å¯¹è±¡è°ƒç”¨hashCodeæ–¹æ³•ä¹‹åï¼Œä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Ÿ</h3><p>å¯èƒ½æ˜¯å› ä¸ºè½»é‡çº§é”çš„å¯¹è±¡å¤´markwordä¸­ï¼Œæ²¡æœ‰åœ°æ–¹å­˜æ”¾åå‘é”çš„æ ‡å¿—å’Œhashcodeï¼Œè€Œè½»é‡çº§é”åˆ™ç”±åœ°æ–¹å­˜å‚¨ï¼Œåœ¨çº¿ç¨‹æ ˆçš„Lock recordä¸­è®°å½•</p><h3 id="4-12-é”å‡çº§è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ"><a href="#4-12-é”å‡çº§è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ" class="headerlink" title="4.12 é”å‡çº§è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ"></a>4.12 é”å‡çº§è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</h3><p><img src="https://oscimg.oschina.net/oscnet/up-c4d41493d771bf980f88488c2a928e23439.png"></p><h4 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a><strong>åå‘é”</strong></h4><p>åå‘é”æ˜¯Java 6ä¹‹ååŠ å…¥çš„æ–°é”ï¼Œå®ƒæ˜¯ä¸€ç§é’ˆå¯¹åŠ é”æ“ä½œçš„ä¼˜åŒ–æ‰‹æ®µï¼Œç»è¿‡ç ”ç©¶å‘ç°ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œå› æ­¤ä¸ºäº†å‡å°‘åŒä¸€çº¿ç¨‹è·å–é”(ä¼šæ¶‰åŠåˆ°ä¸€äº›CASæ“ä½œ,è€—æ—¶)çš„ä»£ä»·è€Œå¼•å…¥åå‘é”ã€‚\</p><p>åå‘é”çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è·å¾—äº†é”ï¼Œé‚£ä¹ˆé”å°±è¿›å…¥åå‘æ¨¡å¼ï¼Œæ­¤æ—¶Mark Word çš„ç»“æ„ä¹Ÿå˜ä¸ºåå‘é”ç»“æ„ï¼Œå½“è¿™ä¸ªçº¿ç¨‹å†æ¬¡è¯·æ±‚é”æ—¶ï¼Œæ— éœ€å†åšä»»ä½•åŒæ­¥æ“ä½œï¼Œå³è·å–é”çš„è¿‡ç¨‹ï¼Œè¿™æ ·å°±çœå»äº†å¤§é‡æœ‰å…³é”ç”³è¯·çš„æ“ä½œï¼Œä»è€Œä¹Ÿå°±æä¾›ç¨‹åºçš„æ€§èƒ½ã€‚æ‰€ä»¥ï¼Œå¯¹äºæ²¡æœ‰é”ç«äº‰çš„åœºåˆï¼Œåå‘é”æœ‰å¾ˆå¥½çš„ä¼˜åŒ–æ•ˆæœï¼Œæ¯•ç«Ÿææœ‰å¯èƒ½è¿ç»­å¤šæ¬¡æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ç”³è¯·ç›¸åŒçš„é”ã€‚</p><p>ä½†æ˜¯å¯¹äºé”ç«äº‰æ¯”è¾ƒæ¿€çƒˆçš„åœºåˆï¼Œåå‘é”å°±å¤±æ•ˆäº†ï¼Œå› ä¸ºè¿™æ ·åœºåˆææœ‰å¯èƒ½æ¯æ¬¡ç”³è¯·é”çš„çº¿ç¨‹éƒ½æ˜¯ä¸ç›¸åŒçš„ï¼Œå› æ­¤è¿™ç§åœºåˆä¸‹ä¸åº”è¯¥ä½¿ç”¨åå‘é”ï¼Œå¦åˆ™ä¼šå¾—ä¸å¿å¤±ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåå‘é”å¤±è´¥åï¼Œå¹¶ä¸ä¼šç«‹å³è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œè€Œæ˜¯å…ˆå‡çº§ä¸ºè½»é‡çº§é”ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€äº†è§£è½»é‡çº§é”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">é»˜è®¤å¼€å¯åå‘é”</span><br><span class="line">å¼€å¯åå‘é”ï¼š-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay=0</span><br><span class="line">å…³é—­åå‘é”ï¼š-XX:-UseBiasedLocking</span><br></pre></td></tr></table></figure><h4 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a><strong>è½»é‡çº§é”</strong></h4><p>å€˜è‹¥åå‘é”å¤±è´¥ï¼Œè™šæ‹Ÿæœºå¹¶ä¸ä¼šç«‹å³å‡çº§ä¸ºé‡é‡çº§é”ï¼Œå®ƒè¿˜ä¼šå°è¯•ä½¿ç”¨ä¸€ç§ç§°ä¸ºè½»é‡çº§é”çš„ä¼˜åŒ–æ‰‹æ®µ(1.6ä¹‹ååŠ å…¥çš„)ï¼Œæ­¤æ—¶Mark Word çš„ç»“æ„ä¹Ÿå˜ä¸ºè½»é‡çº§é”çš„ç»“æ„ã€‚è½»é‡çº§é”èƒ½å¤Ÿæå‡ç¨‹åºæ€§èƒ½çš„ä¾æ®æ˜¯â€œå¯¹ç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½ä¸å­˜åœ¨ç«äº‰â€ï¼Œæ³¨æ„è¿™æ˜¯ç»éªŒæ•°æ®ã€‚éœ€è¦äº†è§£çš„æ˜¯ï¼Œè½»é‡çº§é”æ‰€é€‚åº”çš„åœºæ™¯æ˜¯çº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—çš„åœºåˆï¼Œå¦‚æœå­˜åœ¨åŒä¸€æ—¶é—´è®¿é—®åŒä¸€é”çš„åœºåˆï¼Œå°±ä¼šå¯¼è‡´è½»é‡çº§é”è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚</p><h4 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a><strong>è‡ªæ—‹é”</strong></h4><p>è½»é‡çº§é”å¤±è´¥åï¼Œè™šæ‹Ÿæœºä¸ºäº†é¿å…çº¿ç¨‹çœŸå®åœ°åœ¨æ“ä½œç³»ç»Ÿå±‚é¢æŒ‚èµ·ï¼Œè¿˜ä¼šè¿›è¡Œä¸€é¡¹ç§°ä¸ºè‡ªæ—‹é”çš„ä¼˜åŒ–æ‰‹æ®µã€‚<strong>è¿™æ˜¯åŸºäºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´éƒ½ä¸ä¼šå¤ªé•¿ï¼Œå¦‚æœç›´æ¥æŒ‚èµ·æ“ä½œç³»ç»Ÿå±‚é¢çš„çº¿ç¨‹å¯èƒ½ä¼šå¾—ä¸å¿å¤±ï¼Œæ¯•ç«Ÿæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œ</strong>å› æ­¤è‡ªæ—‹é”ä¼šå‡è®¾åœ¨ä¸ä¹…å°†æ¥ï¼Œå½“å‰çš„çº¿ç¨‹å¯ä»¥è·å¾—é”ï¼Œå› æ­¤è™šæ‹Ÿæœºä¼šè®©å½“å‰æƒ³è¦è·å–é”çš„çº¿ç¨‹åšå‡ ä¸ªç©ºå¾ªç¯(è¿™ä¹Ÿæ˜¯ç§°ä¸ºè‡ªæ—‹çš„åŸå› )ï¼Œä¸€èˆ¬ä¸ä¼šå¤ªä¹…ï¼Œå¯èƒ½æ˜¯50ä¸ªå¾ªç¯æˆ–100å¾ªç¯ï¼Œåœ¨ç»è¿‡è‹¥å¹²æ¬¡å¾ªç¯åï¼Œå¦‚æœå¾—åˆ°é”ï¼Œå°±é¡ºåˆ©è¿›å…¥ä¸´ç•ŒåŒºã€‚å¦‚æœè¿˜ä¸èƒ½è·å¾—é”ï¼Œé‚£å°±ä¼šå°†çº¿ç¨‹åœ¨æ“ä½œç³»ç»Ÿå±‚é¢æŒ‚èµ·ï¼Œè¿™å°±æ˜¯è‡ªæ—‹é”çš„ä¼˜åŒ–æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ç¡®å®ä¹Ÿæ˜¯å¯ä»¥æå‡æ•ˆç‡çš„ã€‚æœ€åæ²¡åŠæ³•ä¹Ÿå°±åªèƒ½å‡çº§ä¸ºé‡é‡çº§é”äº†ã€‚</p><h4 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a><strong>é”æ¶ˆé™¤</strong></h4><p>æ¶ˆé™¤é”æ˜¯è™šæ‹Ÿæœºå¦å¤–ä¸€ç§é”çš„ä¼˜åŒ–ï¼Œè¿™ç§ä¼˜åŒ–æ›´å½»åº•ï¼ŒJavaè™šæ‹Ÿæœºåœ¨JITç¼–è¯‘æ—¶(å¯ä»¥ç®€å•ç†è§£ä¸ºå½“æŸæ®µä»£ç å³å°†ç¬¬ä¸€æ¬¡è¢«æ‰§è¡Œæ—¶è¿›è¡Œç¼–è¯‘ï¼Œåˆç§°å³æ—¶ç¼–è¯‘)ï¼Œé€šè¿‡å¯¹è¿è¡Œä¸Šä¸‹æ–‡çš„æ‰«æï¼Œå»é™¤ä¸å¯èƒ½å­˜åœ¨å…±äº«èµ„æºç«äº‰çš„é”ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¶ˆé™¤æ²¡æœ‰å¿…è¦çš„é”ï¼Œå¯ä»¥èŠ‚çœæ¯«æ— æ„ä¹‰çš„è¯·æ±‚é”æ—¶é—´ï¼Œå¦‚ä¸‹StringBufferçš„appendæ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œä½†æ˜¯åœ¨addæ–¹æ³•ä¸­çš„StringBufferå±äºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå¹¶ä¸”ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰€ä½¿ç”¨ï¼Œå› æ­¤StringBufferä¸å¯èƒ½å­˜åœ¨å…±äº«èµ„æºç«äº‰çš„æƒ…æ™¯ï¼ŒJVMä¼šè‡ªåŠ¨å°†å…¶é”æ¶ˆé™¤ã€‚<strong>é”æ¶ˆé™¤çš„ä¾æ®æ˜¯é€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒã€‚</strong></p><p>é”æ¶ˆé™¤ï¼Œå‰ææ˜¯javaå¿…é¡»è¿è¡Œåœ¨serveræ¨¡å¼ï¼ˆserveræ¨¡å¼ä¼šæ¯”clientæ¨¡å¼ä½œæ›´å¤šçš„ä¼˜åŒ–ï¼‰ï¼ŒåŒæ—¶å¿…é¡»å¼€å¯é€ƒé€¸åˆ†æ</p><p>:-XX:+DoEscapeAnalysis å¼€å¯é€ƒé€¸åˆ†æ</p><p>-XX:+EliminateLocks è¡¨ç¤ºå¼€å¯é”æ¶ˆé™¤ã€‚</p><h4 id="é”è†¨èƒ€"><a href="#é”è†¨èƒ€" class="headerlink" title="é”è†¨èƒ€"></a>é”è†¨èƒ€</h4><p><a href="https://geekibli.github.io/wiki/Java-%E9%94%81%E6%B6%88%E9%99%A4%E5%92%8C%E9%94%81%E8%86%A8%E8%83%80/">Java-é”æ¶ˆé™¤å’Œé”è†¨èƒ€</a></p><h3 id="4-13-ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æï¼Ÿ"><a href="#4-13-ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æï¼Ÿ" class="headerlink" title="4.13 ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æï¼Ÿ"></a>4.13 ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æï¼Ÿ</h3><p>ä½¿ç”¨é€ƒé€¸åˆ†æï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç åšå¦‚ä¸‹ä¼˜åŒ–ï¼š</p><p>ä¸€ã€åŒæ­¥çœç•¥ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªèƒ½ä»ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥ã€‚</p><p>äºŒã€<strong>å°†å †åˆ†é…è½¬åŒ–ä¸ºæ ˆåˆ†é…</strong>ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †åˆ†é…ã€‚</p><p>ä¸‰ã€åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡(åŸºæœ¬æ•°æ®ç±»å‹)æ›¿æ¢ã€‚æœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ã€‚</p><p>æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å’Œæ•°ç»„éƒ½ä¼šåœ¨å †å†…å­˜åˆ†é…ç©ºé—´ï¼Ÿ</p><p><strong>ä¸ä¸€å®š</strong></p><p>åœ¨Javaä»£ç è¿è¡Œæ—¶ï¼Œé€šè¿‡JVMå‚æ•°å¯æŒ‡å®šæ˜¯å¦å¼€å¯é€ƒé€¸åˆ†æï¼Œ</p><p> -XX:+DoEscapeAnalysis ï¼š è¡¨ç¤ºå¼€å¯é€ƒé€¸åˆ†æ</p><p> -XX:-DoEscapeAnalysis ï¼š è¡¨ç¤ºå…³é—­é€ƒé€¸åˆ†æã€‚</p><p>ä»jdk 1.7å¼€å§‹å·²ç»é»˜è®¤å¼€å¯é€ƒé€¸åˆ†æï¼Œå¦‚éœ€å…³é—­ï¼Œéœ€è¦æŒ‡å®š-XX:-DoEscapeAnalysis</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T0_ObjectStackAlloc</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿›è¡Œä¸¤ç§æµ‹è¯•</span></span><br><span class="line"><span class="comment">     * å…³é—­é€ƒé€¸åˆ†æï¼ŒåŒæ—¶è°ƒå¤§å †ç©ºé—´ï¼Œé¿å…å †å†…GCçš„å‘ç”Ÿï¼Œå¦‚æœæœ‰GCä¿¡æ¯å°†ä¼šè¢«æ‰“å°å‡ºæ¥</span></span><br><span class="line"><span class="comment">     * VMè¿è¡Œå‚æ•°ï¼š-Xmx4G -Xms4G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å¼€å¯é€ƒé€¸åˆ†æ</span></span><br><span class="line"><span class="comment">     * VMè¿è¡Œå‚æ•°ï¼š-Xmx4G -Xms4G -XX:+DoEscapeAnalysis -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æ‰§è¡Œmainæ–¹æ³•å</span></span><br><span class="line"><span class="comment">     * jps æŸ¥çœ‹è¿›ç¨‹</span></span><br><span class="line"><span class="comment">     * jmap -histo è¿›ç¨‹ID</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++) &#123;</span><br><span class="line">            alloc();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//æŸ¥çœ‹æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        System.out.println(<span class="string">&quot;cost-time &quot;</span> + (end - start) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> TulingStudent <span class="title">alloc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Jitå¯¹ç¼–è¯‘æ—¶ä¼šå¯¹ä»£ç è¿›è¡Œ é€ƒé€¸åˆ†æ</span></span><br><span class="line">        <span class="comment">//å¹¶ä¸æ˜¯æ‰€æœ‰å¯¹è±¡å­˜æ”¾åœ¨å †åŒºï¼Œæœ‰çš„ä¸€éƒ¨åˆ†å­˜åœ¨çº¿ç¨‹æ ˆç©ºé—´</span></span><br><span class="line">        TulingStudent student = <span class="keyword">new</span> TulingStudent();</span><br><span class="line">        <span class="keyword">return</span> student;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TulingStudent</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨jmapæŸ¥çœ‹å¯¹è±¡åˆ›å»ºæƒ…å†µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo pid</span><br></pre></td></tr></table></figure><blockquote><p><strong>é€ƒé€¸åˆ†æå¯ä»¥èŠ‚çœå †ç©ºé—´ï¼Œæœ‰åˆ©äºGC</strong></p></blockquote><h2 id="5-AQSæ¡†æ¶Lockè¯¦è§£"><a href="#5-AQSæ¡†æ¶Lockè¯¦è§£" class="headerlink" title="5. AQSæ¡†æ¶Lockè¯¦è§£"></a>5. AQSæ¡†æ¶Lockè¯¦è§£</h2><h3 id="5-1-Lockçš„æ ¸å¿ƒç‚¹"><a href="#5-1-Lockçš„æ ¸å¿ƒç‚¹" class="headerlink" title="5.1 Lockçš„æ ¸å¿ƒç‚¹"></a>5.1 Lockçš„æ ¸å¿ƒç‚¹</h3><ul><li>å¾ªç¯ </li><li>CAS å¤šçº¿ç¨‹ç«äº‰é”</li><li>é˜Ÿåˆ— ï¼ˆå…¬å¹³å’Œéå…¬å¹³ï¼‰å­˜å‚¨é˜»å¡çš„çº¿ç¨‹ä»¬</li><li>é˜»å¡å’Œå”¤é†’</li></ul><h3 id="5-2-LockSupport-park-å’Œ-object-notify-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#5-2-LockSupport-park-å’Œ-object-notify-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="5.2 LockSupport.park()  å’Œ object.notify() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>5.2 LockSupport.park()  å’Œ object.notify() æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>å¦‚æœå¤§é‡çº¿ç¨‹é˜»å¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è‡ªå·±çš„çº¿ç¨‹æ ˆï¼Œè¿™æ ·ä¼šå ç”¨å¤§é‡çš„å†…å­˜ã€‚å¯èƒ½ä¼šå¯¼è‡´æ ˆæº¢å‡ºã€‚</p><p>LockSupport.unparkå¯ä»¥å”¤é†’ç‰¹å®šçš„çº¿ç¨‹ï¼Œè€Œobject.notifyæ˜¯éšæœºçš„å”¤é†’</p><p><strong>puckæœ‰å‚å’Œæ— å‚æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><p>Puckæ— å‚æ•°ï¼Œé˜»å¡ä¸€æ¬¡</p><p>puckæœ‰å‚æ•°ï¼Œæœªè¢«å”¤é†’ï¼Œä¸€ç›´é˜»å¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t0 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Thread current = Thread.currentThread();</span><br><span class="line">                log.info(<span class="string">&quot;&#123;&#125;,å¼€å§‹æ‰§è¡Œ!&quot;</span>,current.getName());</span><br><span class="line">                <span class="keyword">for</span>(;;)&#123;<span class="comment">//spin è‡ªæ—‹</span></span><br><span class="line">                    log.info(<span class="string">&quot;å‡†å¤‡parkä½å½“å‰çº¿ç¨‹ï¼š&#123;&#125;....&quot;</span>,current.getName());</span><br><span class="line">                    LockSupport.park();</span><br><span class="line">                    System.out.println(Thread.interrupted());</span><br><span class="line">                    log.info(<span class="string">&quot;å½“å‰çº¿ç¨‹&#123;&#125;å·²ç»è¢«å”¤é†’....&quot;</span>,current.getName());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t0.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">&quot;å‡†å¤‡å”¤é†’&#123;&#125;çº¿ç¨‹!&quot;</span>,t0.getName());</span><br><span class="line">            LockSupport.unpark(t0);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            t0.interrupt();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-CASæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#5-3-CASæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="5.3 CASæ˜¯ä»€ä¹ˆï¼Ÿ"></a>5.3 CASæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>A: å†…å­˜ä¸­å®é™…å­˜å‚¨çš„å€¼ï¼ŒBï¼š æœŸæœ›å†…å­˜ä¸­çš„å€¼ï¼Œ C: ä¿®æ”¹ä¹‹åçš„å€¼</p><p>å¦‚æœ A = B , åˆ™ä¿®æ”¹ï¼›å¦åˆ™é‡æ–°è¯»åŒºå†…å­˜ä¸­çš„å€¼ï¼Œä¸æ–­å¾ªç¯ä¸Šé¢çš„è¿‡ç¨‹ã€‚</p><blockquote><p>å…¶å®è¿™ä¸ªæ˜¯å’ŒJMMæ¯æ¯ç›¸å…³çš„ã€‚<strong>æ•´ä¸ªæ¯”è¾ƒå¹¶äº¤æ¢çš„æ“ä½œæ˜¯åŸå­æ“ä½œ</strong></p></blockquote><p>åœ¨javaä¸­æ˜¯ç”¨åˆ°äº†Unsafeç±»ä¸‹çš„æ–¹æ³•ã€‚åº•å±‚å…¶å®æ˜¯ç”¨åˆ°äº†æ±‡ç¼– <code>cmpxchg</code>æŒ‡ä»¤</p><p>javaä»£ç æ¼”ç»casåŸç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Juc04_Thread_Cas</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰åŠ é”çŠ¶æ€,è®°å½•åŠ é”çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Juc04_Thread_Cas cas = <span class="keyword">new</span> Juc04_Thread_Cas();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Worker(),<span class="string">&quot;t-0&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Worker(),<span class="string">&quot;t-1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Worker(),<span class="string">&quot;t-2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Worker(),<span class="string">&quot;t-3&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Worker(),<span class="string">&quot;t-4&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;è¯·æ±‚:&#123;&#125;åˆ°è¾¾é¢„å®šç‚¹,å‡†å¤‡å¼€å§‹æŠ¢state:)&quot;</span>,Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                cyclicBarrier.await();</span><br><span class="line">                <span class="keyword">if</span>(cas.compareAndSwapState(<span class="number">0</span>,<span class="number">1</span>))&#123;</span><br><span class="line">                    log.info(<span class="string">&quot;å½“å‰è¯·æ±‚:&#123;&#125;,æŠ¢åˆ°é”!&quot;</span>,Thread.currentThread().getName());</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    log.info(<span class="string">&quot;å½“å‰è¯·æ±‚:&#123;&#125;,æŠ¢é”å¤±è´¥!&quot;</span>,Thread.currentThread().getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException|BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŸå­æ“ä½œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> oldValue</span></span><br><span class="line"><span class="comment">     *        oldvalue:çº¿ç¨‹å·¥ä½œå†…å­˜å½“ä¸­çš„å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     *        newValue:è¦æ›¿æ¢çš„æ–°å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapState</span><span class="params">(<span class="keyword">int</span> oldValue,<span class="keyword">int</span> newValue)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>,stateOffset,oldValue,newValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = UnsafeInstance.reflectGetUnsafe();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> stateOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stateOffset = unsafe.objectFieldOffset(Juc04_Thread_Cas.class.getDeclaredField(<span class="string">&quot;state&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-4-ä»€ä¹ˆæ˜¯å…¬å¹³é”ä»€ä¹ˆæ˜¯éå…¬å¹³é”"><a href="#5-4-ä»€ä¹ˆæ˜¯å…¬å¹³é”ä»€ä¹ˆæ˜¯éå…¬å¹³é”" class="headerlink" title="5.4 ä»€ä¹ˆæ˜¯å…¬å¹³é”ä»€ä¹ˆæ˜¯éå…¬å¹³é”"></a>5.4 ä»€ä¹ˆæ˜¯å…¬å¹³é”ä»€ä¹ˆæ˜¯éå…¬å¹³é”</h3><ul><li>å…¬å¹³é” ï¼š æŒ‰ç…§é˜Ÿåˆ—çš„é¡ºåºè·å–é”ï¼Œæ–°æ¥çš„çº¿ç¨‹è¿›å…¥é˜Ÿåˆ—æ’é˜Ÿ</li><li>éå…¬å¹³é” ï¼š è·å–é”çš„æ—¶å€™ï¼Œæ–°æ¥çš„çº¿ç¨‹ä¹Ÿå¯ä»¥å‚ä¸ç«äº‰é”</li></ul><blockquote><p>é’ˆå¯¹çš„æ˜¯ <strong>æ–°æ¥çš„çº¿ç¨‹</strong>æ˜¯å¦é©¬ä¸Šå¯ä»¥ç«äº‰é”èµ„æºï¼Œå…¶å®å°±æ˜¯æ˜¯å¦ç ´åäº†<strong>å…ˆæ¥ååˆ°ï¼Œå…ˆæ¥å…ˆçš„</strong>çš„å…¬å¹³æ€§ã€‚</p></blockquote><h3 id="5-5-åœ¨reentrantLockä»£ç ä¸­å¦‚ä½•ä½“ç°ï¼Ÿ"><a href="#5-5-åœ¨reentrantLockä»£ç ä¸­å¦‚ä½•ä½“ç°ï¼Ÿ" class="headerlink" title="5.5 åœ¨reentrantLockä»£ç ä¸­å¦‚ä½•ä½“ç°ï¼Ÿ"></a>5.5 åœ¨reentrantLockä»£ç ä¸­å¦‚ä½•ä½“ç°ï¼Ÿ</h3><p>é»˜è®¤éå…¬å¹³</p><h3 id="5-6-å¦‚ä½•åˆ¤æ–­é‚£ä¸ªçº¿ç¨‹è·å–äº†é”ï¼Ÿ"><a href="#5-6-å¦‚ä½•åˆ¤æ–­é‚£ä¸ªçº¿ç¨‹è·å–äº†é”ï¼Ÿ" class="headerlink" title="5.6 å¦‚ä½•åˆ¤æ–­é‚£ä¸ªçº¿ç¨‹è·å–äº†é”ï¼Ÿ"></a>5.6 å¦‚ä½•åˆ¤æ–­é‚£ä¸ªçº¿ç¨‹è·å–äº†é”ï¼Ÿ</h3><p>AQSçš„å±æ€§ <code>exclusiceOwnerThread</code>  æŒ‡å‘å½“å‰è·å–é”çš„çº¿ç¨‹ã€‚</p><h3 id="5-7-é”åˆ°åº•åŠ åˆ°äº†å“ªé‡Œï¼ŒåŠ äº†å¤šå°‘æ¬¡ï¼Ÿ"><a href="#5-7-é”åˆ°åº•åŠ åˆ°äº†å“ªé‡Œï¼ŒåŠ äº†å¤šå°‘æ¬¡ï¼Ÿ" class="headerlink" title="5.7 é”åˆ°åº•åŠ åˆ°äº†å“ªé‡Œï¼ŒåŠ äº†å¤šå°‘æ¬¡ï¼Ÿ"></a>5.7 é”åˆ°åº•åŠ åˆ°äº†å“ªé‡Œï¼ŒåŠ äº†å¤šå°‘æ¬¡ï¼Ÿ</h3><p>AQS çš„å±æ€§ int <code>status</code> = 0; 0 è¡¨ç¤ºæ²¡æœ‰åŠ é”ï¼Œ&gt;0 è¡¨ç¤ºé”é‡å…¥çš„æ¬¡æ•°ã€‚</p><h3 id="5-8-é˜Ÿåˆ—æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ"><a href="#5-8-é˜Ÿåˆ—æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ" class="headerlink" title="5.8 é˜Ÿåˆ—æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ"></a>5.8 é˜Ÿåˆ—æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ</h3><p>CLHé˜Ÿåˆ— ï¼š Nodeç±»å‹ï¼Œæœ¬è´¨æ˜¯åŒå‘é“¾è¡¨çš„ç»“æ„ ã€‚ ä¸‰ä¸ªäººåã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">Node pre;</span><br><span class="line">Node next;</span><br><span class="line">Node head;</span><br><span class="line">Node tail;</span><br><span class="line">  Thread thread; <span class="comment">// å¯¹çº¿ç¨‹çš„å¼•ç”¨</span></span><br><span class="line">  <span class="keyword">int</span> waitStatus; <span class="comment">// çŠ¶æ€ ä¿¡å·é‡ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>waitStatuså˜é‡çš„çŠ¶æ€:</strong></p><ul><li>Init = 0 åˆå§‹çŠ¶æ€</li><li>singal = -1 <strong>ä¸‹ä¸€ä¸ªç»“ç‚¹</strong>å¯è¢«å”¤é†’</li><li>cancled = 1 å¯èƒ½å‘ç”Ÿäº†å¼‚å¸¸ æ¯”å¦‚ç»ˆç«¯æˆ–è€…å…¶ä»–å› ç´ ï¼Œéœ€è¦è¢«åºŸå¼ƒæ‰è¿™æ ·çš„ç»“ç‚¹</li><li>condition = -2  </li><li>propagate(å¹¿æ’­) = -3</li></ul><p><img src="https://oscimg.oschina.net/oscnet/up-743aa07d2d8916013c231dbbfaacfd623ca.png"></p><h3 id="5-9-å…¬å¹³é”åŠ é”æµç¨‹"><a href="#5-9-å…¬å¹³é”åŠ é”æµç¨‹" class="headerlink" title="5.9 å…¬å¹³é”åŠ é”æµç¨‹"></a>5.9 å…¬å¹³é”åŠ é”æµç¨‹</h3><ul><li>å…ˆåˆ¤æ–­status == 0</li><li>åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º ï¼ˆhead == tailï¼‰</li><li>casä¿®æ”¹status = 1 &amp;&amp; exclusiveOwnerThread = curThread</li><li>å¦‚æœstatus ï¼= 0  æœ‰ä¸¤ç§æƒ…å†µï¼Œåˆ¤æ–­ exclusiveOwnerThread == curThread ï¼Ÿ å¦‚æœæ˜¯curThread ï¼Œ status +1 ï¼Œ å¦‚æœä¸æ˜¯ï¼ŒåŠ å…¥CLHé˜Ÿåˆ—</li></ul><h4 id="5-9-1-å¦‚æœT0è·å–äº†é”ï¼ŒT1-T2â€¦çº¿ç¨‹æ€ä¹ˆåŠï¼Ÿ"><a href="#5-9-1-å¦‚æœT0è·å–äº†é”ï¼ŒT1-T2â€¦çº¿ç¨‹æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="5.9.1 å¦‚æœT0è·å–äº†é”ï¼ŒT1 T2â€¦çº¿ç¨‹æ€ä¹ˆåŠï¼Ÿ"></a>5.9.1 å¦‚æœT0è·å–äº†é”ï¼ŒT1 T2â€¦çº¿ç¨‹æ€ä¹ˆåŠï¼Ÿ</h4><h5 id="5-9-1-1-å°è¯•åŠ å…¥CLHé˜Ÿåˆ—"><a href="#5-9-1-1-å°è¯•åŠ å…¥CLHé˜Ÿåˆ—" class="headerlink" title="5.9.1.1 å°è¯•åŠ å…¥CLHé˜Ÿåˆ—"></a>5.9.1.1 å°è¯•åŠ å…¥CLHé˜Ÿåˆ—</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>java.util.concurrent.locks.ReentrantLock.FairSync#tryAcquire</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// å¯èƒ½å¤šçº¿ç¨‹è¿›å…¥</span></span><br><span class="line">      <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">          <span class="comment">// casåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸ</span></span><br><span class="line">          compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">        setExclusiveOwnerThread(current);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹å†æ¬¡è·å–é”çš„æ—¶å€™ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰å¹¶å‘é—®é¢˜</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">      <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">      <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">      setState(nextc);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œæ€§èƒ½ä¼šæ¯”è¾ƒé«˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">        Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">        <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">        Node pred = tail;</span><br><span class="line">  <span class="comment">// é˜Ÿåˆ—ä¸æ˜¯ç©ºçš„æ—¶å€™èµ°ä¸‹é¢</span></span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  <span class="comment">// é˜Ÿåˆ—æ˜¯ç©ºçš„æ—¶å€™ï¼Œèµ°è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é˜Ÿåˆ—æ˜¯ç©ºçš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡æƒ³é˜Ÿåˆ—ä¸­æ·»åŠ ç­‰å¾…çš„ç»“ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            Node t = tail;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                    tail = head;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                node.prev = t;</span><br><span class="line">                <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                    t.next = node;</span><br><span class="line">                    <span class="keyword">return</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸ºä»€ä¹ˆå¾ªç¯ç­‰å¾…å‘¢ï¼Ÿ è¦ç¡®ä¿ç»“ç‚¹ä¸€å®šè¦æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨</li><li><code>if (t == null) &#123; // Must initialize </code> æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ</li></ul><blockquote><p>ç¬¬ä¸€æ¬¡åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¤´ç»“ç‚¹æä¸€ä¸ªç©ºçš„Nodeå¯¹è±¡ï¼Œç„¶åä¸‹ä¸€æ¬¡å¾ªç¯çš„æ—¶å€™æŠŠç»“ç‚¹æ·»åŠ åˆ°å°¾éƒ¨ã€‚</p></blockquote><p><strong>å¦‚æœä¸å¾ªç¯ï¼Œå¯èƒ½å¯¼è‡´çº¿ç¨‹ç»“ç‚¹ä¸¢å¤±ï¼Œæ°¸è¿œæ— æ³•å”¤é†’ï¼Œä½†æ˜¯å†…å­˜ç©ºé—´ä¸­è¿˜å­˜åœ¨è¯¥çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ã€‚</strong></p><h5 id="5-9-1-2-åŠ å…¥é˜Ÿåˆ—åï¼Œè¯¥æŠŠçº¿ç¨‹é˜»å¡äº†"><a href="#5-9-1-2-åŠ å…¥é˜Ÿåˆ—åï¼Œè¯¥æŠŠçº¿ç¨‹é˜»å¡äº†" class="headerlink" title="5.9.1.2 åŠ å…¥é˜Ÿåˆ—åï¼Œè¯¥æŠŠçº¿ç¨‹é˜»å¡äº†"></a>5.9.1.2 åŠ å…¥é˜Ÿåˆ—åï¼Œè¯¥æŠŠçº¿ç¨‹é˜»å¡äº†</h5><p><font color=red>æ‰§è¡Œåˆ°è¿™çš„è¯ï¼Œåªæ˜¯æŠŠçº¿ç¨‹æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­äº†ï¼Œä½†æ˜¯æ˜¾ç¤ºè¿˜æ²¡æœ‰é˜»å¡ï¼Œä¸‹é¢å°±æ˜¯å»é˜»å¡çš„é€»è¾‘</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">           <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å‰ä¸€ä¸ªç»“ç‚¹</span></span><br><span class="line">               <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">             <span class="comment">// å¦‚æœå‰ä¸€ä¸ªç»“ç‚¹æ˜¯å¤´ç»“ç‚¹ï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹è·å–æˆåŠŸäº†</span></span><br><span class="line">             <span class="comment">// å› ä¸ºå¯èƒ½åœ¨å…¥é˜Ÿå‰çš„ç¬é—´ï¼Œå¤´ç»“ç‚¹çš„çº¿ç¨‹é‡Šæ”¾é”äº†</span></span><br><span class="line">               <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                 <span class="comment">// å½“å‰è·å–é”çš„çº¿ç¨‹çš„nodeæ˜¯ç¬¬ä¸€ä¸ªï¼Œè€Œä¸”æ˜¯ç©ºçš„nodeï¼Œè¿™ä¸ªenqæ–¹æ³•å‘¼åº”ï¼</span></span><br><span class="line">                  setHead(node);</span><br><span class="line">                   p.next = <span class="keyword">null</span>; <span class="comment">// help GC æŠŠä¹‹å‰çš„ç»“ç‚¹è®¾ç½®æˆnull</span></span><br><span class="line">                   failed = <span class="keyword">false</span>;</span><br><span class="line">                   <span class="keyword">return</span> interrupted;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                   parkAndCheckInterrupt())</span><br><span class="line">                   interrupted = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (failed)</span><br><span class="line">               cancelAcquire(node);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>è¡¥å……ï¼š</strong>  âš ï¸ âš ï¸ âš ï¸</p><p><code>if (p == head &amp;&amp; tryAcquire(arg)) </code></p><ul><li>å¦‚æœæ˜¯å…¬å¹³é”ï¼Œåˆ™ä¸€å®šå¯ä»¥tryAcquire è·å–åˆ°é”</li><li>å¦‚æœæ˜¯éå…¬å¹³é”ï¼Œåˆ™ if ä¸ä¸€å®šä¸ºtrue</li></ul><h5 id="5-9-1-3-ç»“ç‚¹é˜»å¡ä¹‹å‰ï¼Œè¿˜ä¼šå†æ¬¡å°è¯•è·å–é”"><a href="#5-9-1-3-ç»“ç‚¹é˜»å¡ä¹‹å‰ï¼Œè¿˜ä¼šå†æ¬¡å°è¯•è·å–é”" class="headerlink" title="5.9.1.3 ç»“ç‚¹é˜»å¡ä¹‹å‰ï¼Œè¿˜ä¼šå†æ¬¡å°è¯•è·å–é”"></a>5.9.1.3 ç»“ç‚¹é˜»å¡ä¹‹å‰ï¼Œè¿˜ä¼šå†æ¬¡å°è¯•è·å–é”</h5><p>ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç»“ç‚¹ï¼‰</p><h5 id="5-9-1-4-å¦‚æœè·å–é”æˆåŠŸï¼Œè®¾ç½®æˆå¤´ç»“ç‚¹"><a href="#5-9-1-4-å¦‚æœè·å–é”æˆåŠŸï¼Œè®¾ç½®æˆå¤´ç»“ç‚¹" class="headerlink" title="5.9.1.4 å¦‚æœè·å–é”æˆåŠŸï¼Œè®¾ç½®æˆå¤´ç»“ç‚¹"></a>5.9.1.4 å¦‚æœè·å–é”æˆåŠŸï¼Œè®¾ç½®æˆå¤´ç»“ç‚¹</h5><p><img src="https://oscimg.oschina.net/oscnet/up-3d3f02435ab216e6de2b04ac13fa4385508.png"></p><p>è®¾ç½®æˆå¤´ç»“ç‚¹çš„æ—¶å€™ï¼Œä¹‹å‰çš„å¤´ç»“ç‚¹ï¼ˆè‚¯å®šæ˜¯ä¸ª â€œç©ºç»“ç‚¹â€ï¼‰æ–­å¼€ï¼Œå¹¶ä¸”è®¾ç½®æˆnullï¼Œæ–¹ä¾¿GC. ç„¶åæŠŠå½“å‰çº¿ç¨‹çš„Nodeç»“ç‚¹è®¾ç½®æˆheadç»“ç‚¹ï¼ŒåŒæ—¶æŠŠNodeè®¾ç½®æˆ â€œç©ºç»“ç‚¹â€ã€‚ æ€ä¹ˆè®¾ç½®çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHead</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        head = node;</span><br><span class="line">        node.thread = <span class="keyword">null</span>;</span><br><span class="line">        node.prev = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¤´æŒ‡é’ˆæŒ‡å‘å½“å‰ç»“ç‚¹</li><li>æŠŠçº¿ç¨‹è®¾ç½®æˆnullï¼Œå› ä¸ºå½“å‰çº¿ç¨‹å·²ç»è·å–åˆ°é”äº†ï¼Œè¿™é‡Œæ²¡æœ‰å¿…è¦è¿˜ç»§ç»­å ç€å¼•ç”¨</li><li>æŠŠå½“å‰ç»“ç‚¹çš„å‰æŒ‡é’ˆæ–­å¼€ï¼ˆå› ä¸ºåœ¨enqæ–¹æ³•é‡Œé¢ï¼Œè¦é˜»å¡çš„ç»“ç‚¹éƒ½æ˜¯æ·»åŠ åœ¨tailï¼Œæ‰€ä»¥å®ƒçš„prevè‚¯å®šæ˜¯æœ‰çš„ï¼Œè¿™é‡Œè¦æ–­å¼€å¤´ç»“ç‚¹ï¼‰</li></ul><h5 id="5-9-1-5-å¦‚æœæ²¡æœ‰è·å–æˆåŠŸï¼Œæ‰§è¡Œé˜»å¡"><a href="#5-9-1-5-å¦‚æœæ²¡æœ‰è·å–æˆåŠŸï¼Œæ‰§è¡Œé˜»å¡" class="headerlink" title="5.9.1.5 å¦‚æœæ²¡æœ‰è·å–æˆåŠŸï¼Œæ‰§è¡Œé˜»å¡"></a>5.9.1.5 å¦‚æœæ²¡æœ‰è·å–æˆåŠŸï¼Œæ‰§è¡Œé˜»å¡</h5><ul><li><p>ç¬¬ä¸€è½®å¾ªç¯ï¼ŒshouldParkAfterFailedAcquire(p, node)  è¿”å›false ï¼Œä¿®æ”¹headçš„waitStatus = singal = -1ï¼Œä¸‹ä¸€ä¸ªç»“ç‚¹å¯ä»¥è¢«å”¤é†’</p></li><li><p>ç¬¬äºŒæ¬¡å¾ªç¯è¿›è¡Œé˜»å¡æ“ä½œï¼ŒshouldParkAfterFailedAcquire(p, node) è¿”å›true ï¼Œ æ‰§è¡ŒparkAndCheckInterrupt()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é˜»å¡å½“å‰çº¿ç¨‹ã€‚æ­¤æ—¶å½“å‰ç»“ç‚¹çš„waitStatus = 0. å’Œä¸Šé¢ä¹‹å‰çš„æ“ä½œä¸€æ ·äº†ï¼Œç­‰å¾…è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ—¶å€™ï¼Œåˆå¼€å§‹äº†ä¸Šé¢çš„æ“ä½œï¼Œè®¾ç½®headç»“ç‚¹çš„waitStatus = signal = -1 ç­‰ç­‰ã€‚</p></li></ul><h4 id="5-9-2-è¢«é˜»å¡çš„çº¿ç¨‹ä»€ä¹ˆæ—¶å€™ä¼šå”¤é†’å‘¢ï¼Ÿ"><a href="#5-9-2-è¢«é˜»å¡çš„çº¿ç¨‹ä»€ä¹ˆæ—¶å€™ä¼šå”¤é†’å‘¢ï¼Ÿ" class="headerlink" title="5.9.2 è¢«é˜»å¡çš„çº¿ç¨‹ä»€ä¹ˆæ—¶å€™ä¼šå”¤é†’å‘¢ï¼Ÿ"></a>5.9.2 è¢«é˜»å¡çš„çº¿ç¨‹ä»€ä¹ˆæ—¶å€™ä¼šå”¤é†’å‘¢ï¼Ÿ</h4><p><strong>åœ¨è·å–é”çš„çº¿ç¨‹æ‰§è¡Œ <code>unlock</code> çš„æ—¶å€™ã€‚</strong></p><p>ä¸‹é¢æ˜¯AQSçš„æ¨¡ç‰ˆæ–¹æ³•ï¼ŒtryReleaseåœ¨å­ç±»å®ç°ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line"><span class="comment">// å…ˆå‡AQSçš„ state</span></span><br><span class="line">  <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">            Node h = head;</span><br><span class="line">          <span class="comment">// h.waitStatus != 0 ä¸èƒ½ä¸º0 åœ¨reentrantLockä¸­ï¼ŒwaitStatus = -1, å”¤é†’CLHé˜Ÿåˆ—ä¸‹ä¸€ä¸ªç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯tryReleaseåœ¨ReentrantLockæ–¹æ³•ä¸­çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">            <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                free = <span class="keyword">true</span>;</span><br><span class="line">                setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setState(c);</span><br><span class="line">            <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœstate - 1 æˆåŠŸï¼Œåˆ™æ¥ä¸‹æ¥æ‰§è¡Œå”¤é†’æ“ä½œã€‚</p><p><strong>AQS# unparkSuccessorå”¤é†’æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“</p><ul><li>headç»“ç‚¹çš„çŠ¶æ€è‚¯å®šæ˜¯ â€œç©ºç»“ç‚¹â€ï¼Œ waitStatus çŠ¶æ€=-1 ï¼Œè¯´æ˜çº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå½“çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œåœ¨unlockçš„æ—¶å€™ï¼Œå†æŠŠwaitStatusæ”¹æˆ0</li><li>ä¸ºä»€ä¹ˆwaitStatusçš„çŠ¶æ€åœ¨unlockçš„æ—¶å€™è¦ â€˜æ¢å¤â€™ æˆ 0 å‘¢ï¼Ÿ<ul><li>å› ä¸ºåœ¨éå…¬å¹³é”çš„æƒ…å†µä¸‹ï¼Œä¸ä¸€å®šæ˜¯åç»­ç»“ç‚¹ä¸€å®šèƒ½è·å¾—é”</li><li>è€Œä¸”node çš„waitStatusçš„çŠ¶æ€è®¾ç½®æˆ-1æ˜¯æœ‰å›ºå®šæ–¹æ³•å›ºå®šçš„æ—¶å€™</li></ul></li></ul><h3 id="5-10-ä»€ä¹ˆæ˜¯å¯é‡å…¥é”"><a href="#5-10-ä»€ä¹ˆæ˜¯å¯é‡å…¥é”" class="headerlink" title="5.10 ä»€ä¹ˆæ˜¯å¯é‡å…¥é”"></a>5.10 ä»€ä¹ˆæ˜¯å¯é‡å…¥é”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lock.lock()</span><br><span class="line">...</span><br><span class="line">lock.lock()</span><br><span class="line">...</span><br><span class="line">lock.unlock()</span><br><span class="line">...</span><br><span class="line">lock.unlock()</span><br></pre></td></tr></table></figure><h3 id="5-11-ä»€ä¹ˆæ˜¯ä¸­æ–­"><a href="#5-11-ä»€ä¹ˆæ˜¯ä¸­æ–­" class="headerlink" title="5.11 ä»€ä¹ˆæ˜¯ä¸­æ–­"></a>5.11 ä»€ä¹ˆæ˜¯ä¸­æ–­</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">          <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">              System.out.println(<span class="string">&quot;in thread 111&quot;</span> + Thread.currentThread().isInterrupted());</span><br><span class="line">              <span class="keyword">if</span> (Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                  System.out.println(<span class="string">&quot;å“åº”ä¸­æ–­&quot;</span>);</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;, <span class="string">&quot;thread1&quot;</span>);</span><br><span class="line"></span><br><span class="line">      thread.start();</span><br><span class="line">      System.err.println(<span class="string">&quot;before interrupt &quot;</span> + thread.isInterrupted());</span><br><span class="line">      thread.interrupt();</span><br><span class="line">      System.err.println(<span class="string">&quot;after interrupt &quot;</span> + thread.isInterrupted());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸­æ–­çš„ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>Thread.interrupted(); ä¸­æ–­çº¿ç¨‹å¹¶ä¸”æ¸…é™¤ä¸­æ–­æ ‡è®°</li><li>Thread.currentThread().interrupt();  ä¸­æ–­çº¿ç¨‹</li><li>Thread.currentThread().isInterrupted();  åˆ¤æ–­ä¸­æ–­æ ‡è®°ï¼Œå¹¶ä¸æ¸…é™¤</li></ul><blockquote><p>ç”¨æˆ·ç¨‹åºè‡ªå·±å“åº”ä¸­æ–­ï¼Œæ¯”ç›´æ¥è°ƒç”¨stopæ–¹æ³•è¦å‹å¥½çš„å¤š</p></blockquote><h4 id="å¦‚æœè·å–é”çš„çº¿ç¨‹è°ƒç”¨äº†waitæ–¹æ³•ä¼šæ€æ ·ï¼Ÿ"><a href="#å¦‚æœè·å–é”çš„çº¿ç¨‹è°ƒç”¨äº†waitæ–¹æ³•ä¼šæ€æ ·ï¼Ÿ" class="headerlink" title="å¦‚æœè·å–é”çš„çº¿ç¨‹è°ƒç”¨äº†waitæ–¹æ³•ä¼šæ€æ ·ï¼Ÿ"></a><strong><font color=red>å¦‚æœè·å–é”çš„çº¿ç¨‹è°ƒç”¨äº†waitæ–¹æ³•ä¼šæ€æ ·ï¼Ÿ</font></strong></h4><h3 id="5-12-waitStatus-cancel-1-çŠ¶æ€"><a href="#5-12-waitStatus-cancel-1-çŠ¶æ€" class="headerlink" title="5.12 waitStatus = cancel = 1 çŠ¶æ€"></a>5.12 waitStatus = cancel = 1 çŠ¶æ€</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Ignore if node doesn&#x27;t exist</span></span><br><span class="line">       <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">       node.thread = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Skip cancelled predecessors</span></span><br><span class="line">       Node pred = node.prev;</span><br><span class="line">       <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">           node.prev = pred = pred.prev;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// predNext is the apparent node to unsplice. CASes below will</span></span><br><span class="line">       <span class="comment">// fail if not, in which case, we lost race vs another cancel</span></span><br><span class="line">       <span class="comment">// or signal, so no further action is necessary.</span></span><br><span class="line">       Node predNext = pred.next;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Can use unconditional write instead of CAS here.</span></span><br><span class="line">       <span class="comment">// After this atomic step, other Nodes can skip past us.</span></span><br><span class="line">       <span class="comment">// Before, we are free of interference from other threads.</span></span><br><span class="line">       node.waitStatus = Node.CANCELLED;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// If we are the tail, remove ourselves.</span></span><br><span class="line">       <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">           compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// If successor needs signal, try to set pred&#x27;s next-link</span></span><br><span class="line">           <span class="comment">// so it will get one. Otherwise wake it up to propagate.</span></span><br><span class="line">           <span class="keyword">int</span> ws;</span><br><span class="line">           <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">               ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">                (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">               pred.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">               Node next = node.next;</span><br><span class="line">               <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                   compareAndSetNext(pred, predNext, next);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               unparkSuccessor(node);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           node.next = node; <span class="comment">// help GC</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å½“nodeæ˜¯cancelçŠ¶æ€çš„æ—¶å€™ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ²¡ç”¨äº†ï¼Œä½†æ˜¯ä¹‹å‰å‘¢ï¼Œå·²ç»æŠŠnodeæ·»åŠ åˆ°äº†é˜Ÿåˆ—é‡Œé¢äº†ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-b9d30c07b820fa121616ea71504a08148f2.png"></p><p>åˆ†æˆ3ç§æƒ…å†µ</p><ul><li>ç¬¬ä¸€ç§ï¼Œå¦‚æœç»“ç‚¹æ˜¯tail, æŠŠå½“å‰ç»“ç‚¹å»æ‰</li><li>å¦‚æœæ˜¯headåé¢çš„ç¬¬ä¸€ä¸ªç»“ç‚¹ï¼Œé‚£ä¹ˆï¼Œç›´æ¥å”¤é†’è¯¥ç»“ç‚¹åé¢çš„ç»“ç‚¹</li><li>å¦‚æœæ˜¯é˜Ÿåˆ—ä¸­é—´ï¼Œæ¯”å¦‚å›¾ä¸­çº¢è‰²çš„ä½ç½®ï¼Œåˆ™å»æ‰å°±è¡Œäº†</li></ul><p>è¿™é‡Œå‘¢ è¿˜æœ‰ä¸€äº›ç»†èŠ‚ï¼Œnodeçš„thread = nullï¼Œè¿™æ ·æ–¹ä¾¿GC, å› ä¸ºçº¿ç¨‹æ ˆä¹Ÿæ˜¯å ç”¨å†…å­˜ç©ºé—´çš„ã€‚</p><h2 id="6-AQSæ¡†æ¶Blocking-Queueè¯¦è§£"><a href="#6-AQSæ¡†æ¶Blocking-Queueè¯¦è§£" class="headerlink" title="6. AQSæ¡†æ¶Blocking Queueè¯¦è§£"></a>6. AQSæ¡†æ¶Blocking Queueè¯¦è§£</h2><p>ä»»æ„æ—¶åˆ»ï¼Œæ— è®ºå¹¶å‘å¤šé«˜ï¼Œåœ¨å•æœºjvmä¸Šé¢ï¼ŒåŒä¸€æ—¶é—´ï¼Œæ°¸è¿œéƒ½åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œå…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œ</p><h3 id="6-1-é˜»å¡é˜Ÿåˆ—ç‰¹æ€§"><a href="#6-1-é˜»å¡é˜Ÿåˆ—ç‰¹æ€§" class="headerlink" title="6.1 é˜»å¡é˜Ÿåˆ—ç‰¹æ€§"></a>6.1 é˜»å¡é˜Ÿåˆ—ç‰¹æ€§</h3><ul><li>çº¿ç¨‹å®‰å…¨</li><li>æœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—</li><li>é˜Ÿåˆ—æ»¡ æ·»åŠ é˜»å¡ é˜Ÿåˆ—ç©º è¯»å–é˜»å¡</li></ul><h3 id="6-2-ä½¿ç”¨åœºæ™¯"><a href="#6-2-ä½¿ç”¨åœºæ™¯" class="headerlink" title="6.2 ä½¿ç”¨åœºæ™¯"></a>6.2 ä½¿ç”¨åœºæ™¯</h3><ul><li>çº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—</li><li>æ³¨å†Œä¸­å¿ƒåº•å±‚</li><li>å¸¸ç”¨è¯­ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</li></ul><h2 id="7-Semaphoreä¿¡å·é‡"><a href="#7-Semaphoreä¿¡å·é‡" class="headerlink" title="7. Semaphoreä¿¡å·é‡"></a>7. Semaphoreä¿¡å·é‡</h2><p>Semaphore å­—é¢æ„æ€æ˜¯ä¿¡å·é‡çš„æ„æ€ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ§åˆ¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°ç›®ï¼Œåº•å±‚ä¾èµ–AQSçš„çŠ¶æ€Stateï¼Œæ˜¯åœ¨ç”Ÿäº§å½“ä¸­æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªå·¥å…·ç±»ã€‚</p><h3 id="7-1-semaphoreDemo"><a href="#7-1-semaphoreDemo" class="headerlink" title="7.1 semaphoreDemo"></a>7.1 semaphoreDemo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Task(semaphore,<span class="string">&quot;yangguo+&quot;</span>+i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        Semaphore semaphore;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Task</span><span class="params">(Semaphore semaphore,String tname)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(tname);</span><br><span class="line">            <span class="keyword">this</span>.semaphore = semaphore;</span><br><span class="line">            <span class="comment">//this.setName(tname);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//semaphore.acquireUninterruptibly();</span></span><br><span class="line">                semaphore.acquire();<span class="comment">//è·å–å…¬å…±èµ„æº</span></span><br><span class="line"></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;:aquire() at time:&quot;</span>+System.currentTimeMillis());</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">                semaphore.release();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*if(semaphore.tryAcquire(500,TimeUnit.MILLISECONDS))&#123;</span></span><br><span class="line"><span class="comment">                    System.out.println(Thread.currentThread().getName()+&quot;:aquire() at time:&quot;+System.currentTimeMillis());</span></span><br><span class="line"><span class="comment">                    Thread.sleep(5000);</span></span><br><span class="line"><span class="comment">                    semaphore.release();//é‡Šæ”¾å…¬å…±èµ„æº</span></span><br><span class="line"><span class="comment">                &#125;else&#123;</span></span><br><span class="line"><span class="comment">                    fallback();</span></span><br><span class="line"><span class="comment">                &#125;*/</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fallback</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;é™çº§&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Thread-0:aquire() at time:1641623552311</span><br><span class="line">Thread-1:aquire() at time:1641623552311</span><br><span class="line">Thread-3:aquire() at time:1641623557312</span><br><span class="line">Thread-2:aquire() at time:1641623557312</span><br><span class="line">Thread-4:aquire() at time:1641623562317</span><br><span class="line">Thread-5:aquire() at time:1641623562317</span><br><span class="line">Thread-6:aquire() at time:1641623567322</span><br><span class="line">Thread-7:aquire() at time:1641623567322</span><br><span class="line">Thread-8:aquire() at time:1641623572325</span><br><span class="line">Thread-9:aquire() at time:1641623572325</span><br></pre></td></tr></table></figure><h3 id="7-2-é‡è¦API"><a href="#7-2-é‡è¦API" class="headerlink" title="7.2 é‡è¦API"></a>7.2 é‡è¦API</h3><h4 id="tryAcquire-long-timeout-TimeUnit-unit"><a href="#tryAcquire-long-timeout-TimeUnit-unit" class="headerlink" title="tryAcquire(long timeout, TimeUnit unit)"></a>tryAcquire(long timeout, TimeUnit unit)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(semaphore.tryAcquire(<span class="number">500</span>,TimeUnit.MILLISECONDS))&#123;</span><br><span class="line">System.out.println(Thread.currentThread().getName()+<span class="string">&quot;:aquire() at time:&quot;</span>+System.currentTimeMillis());</span><br><span class="line">    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    semaphore.release();<span class="comment">//é‡Šæ”¾å…¬å…±èµ„æº</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    fallback();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ–¹æ³•æºç ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquireSharedNanos(<span class="number">1</span>, unit.toNanos(timeout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="semaphore-acquire"><a href="#semaphore-acquire" class="headerlink" title="semaphore.acquire();"></a>semaphore.acquire();</h3><p><strong><font color=red>ä¹‹å‰reentrantLock blocking queueéƒ½æ˜¯ç‹¬å æ¨¡å¼ï¼Œè€Œsemaphoreçš„lockåˆ™æ˜¯å…±äº«çš„æ¨¡å¼</font></strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void acquire() throws InterruptedException &#123;</span><br><span class="line">        sync.acquireSharedInterruptibly(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AQSæ¨¡ç‰ˆæ–¹æ³•ï¼ŒtryAcquireShared(arg) åœ¨å­ç±»ä¸­æœ‰å…·ä½“çš„å®ç°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final void acquireSharedInterruptibly(int arg)</span><br><span class="line">            throws InterruptedException &#123;</span><br><span class="line">        if (Thread.interrupted())</span><br><span class="line">            throw new InterruptedException();</span><br><span class="line">        if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">            doAcquireSharedInterruptibly(arg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2014338818796000944L</span>;</span><br><span class="line"></span><br><span class="line">        FairSync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">            <span class="keyword">super</span>(permits);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (hasQueuedPredecessors())</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">int</span> available = getState();</span><br><span class="line">                <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">                <span class="comment">// å¦‚æœremaining &gt;= 0 é€šè¿‡casè¿›è¡Œä¿®æ”¹</span></span><br><span class="line">                <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">                    compareAndSetState(available, remaining))</span><br><span class="line">                    <span class="keyword">return</span> remaining;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">        <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                    <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">                    <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        setHeadAndPropagate(node, r);</span><br><span class="line">                        p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                        failed = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™è¾¹å’Œç‹¬å é”çš„åŒºåˆ«åœ¨äºå¤šäº†ä¸€ä¸ª <code>setHeadAndPropagate(node, r);</code>æ–¹æ³•ã€‚</p><h2 id="8-CountDownLatch"><a href="#8-CountDownLatch" class="headerlink" title="8. CountDownLatch"></a>8. CountDownLatch</h2><h2 id="9-CyclicBarrier"><a href="#9-CyclicBarrier" class="headerlink" title="9. CyclicBarrier"></a>9. CyclicBarrier</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CyclicBarrier cyclicBarrier;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrierRunner</span><span class="params">(CyclicBarrier cyclicBarrier, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cyclicBarrier = cyclicBarrier;</span><br><span class="line">        <span class="keyword">this</span>.index = index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;index: &quot;</span> + index);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">11</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ‰€æœ‰ç‰¹å·¥åˆ°è¾¾å±éšœï¼Œå‡†å¤‡å¼€å§‹æ‰§è¡Œç§˜å¯†ä»»åŠ¡&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> CyclicBarrierRunner(cyclicBarrier, i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">        cyclicBarrier.await();</span><br><span class="line">        System.out.println(<span class="string">&quot;å…¨éƒ¨åˆ°è¾¾å±éšœ....1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> CyclicBarrierRunner(cyclicBarrier, i)).start();</span><br><span class="line">        &#125;</span><br><span class="line">        cyclicBarrier.await();</span><br><span class="line">        System.out.println(<span class="string">&quot;å…¨éƒ¨åˆ°è¾¾å±éšœ....1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-1-CyclicBarrier-å’Œ-CountDownLatchçš„åŒºåˆ«"><a href="#9-1-CyclicBarrier-å’Œ-CountDownLatchçš„åŒºåˆ«" class="headerlink" title="9.1 CyclicBarrier å’Œ CountDownLatchçš„åŒºåˆ«"></a>9.1 CyclicBarrier å’Œ CountDownLatchçš„åŒºåˆ«</h3><ul><li>åŠŸèƒ½ä¸ä¸€æ ·</li><li>CyclicBarrierå¯å¤ç”¨ï¼ŒCountDownLatchä¸å¯å¤ç”¨</li><li>CyclicBarrier å’Œ CountDownLatch å€’è¿‡æ¥ç”¨æ•ˆæœç±»ä¼¼</li></ul><h2 id="10-Atomicç±»"><a href="#10-Atomicç±»" class="headerlink" title="10. Atomicç±»"></a>10. Atomicç±»</h2><blockquote><p> åŸå­ï¼ˆatomï¼‰æœ¬æ„æ˜¯â€œä¸èƒ½è¢«è¿›ä¸€æ­¥åˆ†å‰²çš„æœ€å°ç²’å­â€ï¼Œè€ŒåŸå­æ“ä½œï¼ˆatomic operationï¼‰æ„ä¸ºâ€ä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œâ€ ã€‚åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°åŸå­æ“ä½œå°±å˜å¾—æœ‰ç‚¹å¤æ‚ã€‚æœ¬æ–‡è®©æˆ‘ä»¬ä¸€èµ·æ¥èŠä¸€èŠåœ¨Interå¤„ç†å™¨å’ŒJavaé‡Œæ˜¯å¦‚ä½•å®ç°åŸå­æ“ä½œçš„ã€‚</p></blockquote><p><img src="https://oscimg.oschina.net/oscnet/up-c4e798c80f82c9b025c51ce57f80ed88e02.png"></p><p>Atomic åº•å±‚æ˜¯åŸºäºæ— é”åŒ–çš„casç®—æ³•ã€‚åŸºäºé­”æœ¯ç±»Unsafeæä¾›çš„ä¸‰å¤§cas-apiå®Œæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">compareAndSwapObject</span><br><span class="line"></span><br><span class="line">compareAndSwapInt</span><br><span class="line"></span><br><span class="line">compareAndSwapLong</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŸºäºç¡¬ä»¶åŸè¯­-CMPXCHGå®ç°åŸå­æ“ä½œcas </span></span><br></pre></td></tr></table></figure><p><strong><font color=red>åŸºäºç¡¬ä»¶åŸè¯­-CMPXCHGå®ç°åŸå­æ“ä½œcas  åœ¨ç”¨æˆ·æ€å°±å¯ä»¥å®Œæˆçš„æ“ä½œï¼Œä¸ä¼šæœ‰åˆ‡æ¢çš„å¼€é”€</font></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">  oldvalue = <span class="keyword">this</span>.getIntVolatile(var1, var2);<span class="comment">//è¯»AtomicIntegerçš„valueå€¼</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">///valueOffset---valueå±æ€§åœ¨å¯¹è±¡å†…å­˜å½“ä¸­çš„åç§»é‡</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(AtomicInteger, valueOffset, oldvalue, oldvalue + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> var5;</span><br></pre></td></tr></table></figure><h3 id="10-1-ä»€ä¹ˆå«åç§»é‡ï¼Ÿ"><a href="#10-1-ä»€ä¹ˆå«åç§»é‡ï¼Ÿ" class="headerlink" title="10.1 ä»€ä¹ˆå«åç§»é‡ï¼Ÿ"></a>10.1 <strong>ä»€ä¹ˆå«åç§»é‡ï¼Ÿ</strong></h3><p>è¦ç”¨casä¿®æ”¹æŸä¸ªå¯¹è±¡å±æ€§çš„å€¼-&gt;ï¼Œé¦–å…ˆè¦çŸ¥é“å±æ€§åœ¨å¯¹è±¡çš„å†…å­˜ç©ºé—´çš„å“ªä¸ªä½ç½®ï¼Œå¿…é¡»çŸ¥é“å±æ€§çš„åç§»é‡</p><h3 id="10-2-å¦‚ä½•é€šè¿‡åŸå­æ“ä½œä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„å±æ€§"><a href="#10-2-å¦‚ä½•é€šè¿‡åŸå­æ“ä½œä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„å±æ€§" class="headerlink" title="10.2 å¦‚ä½•é€šè¿‡åŸå­æ“ä½œä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„å±æ€§"></a>10.2 å¦‚ä½•é€šè¿‡åŸå­æ“ä½œä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„å±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicStudentAgeUpdater</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AtomicStudentAgeUpdater</span><span class="params">(String name,<span class="keyword">int</span> age)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AtomicStudentAgeUpdater updater = <span class="keyword">new</span> AtomicStudentAgeUpdater(<span class="string">&quot;æ¨è¿‡&quot;</span>,<span class="number">18</span>);</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(updater).toPrintable());</span><br><span class="line">        updater.compareAndSwapAge(<span class="number">18</span>,<span class="number">56</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;çœŸå®çš„æ¨è¿‡å¹´é¾„---&quot;</span>+updater.getAge());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = UnsafeInstance.reflectGetUnsafe();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            valueOffset = unsafe.objectFieldOffset(AtomicStudentAgeUpdater.class.getDeclaredField(<span class="string">&quot;age&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;valueOffset:---&gt;&quot;</span>+valueOffset);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compareAndSwapAge</span><span class="params">(<span class="keyword">int</span> old,<span class="keyword">int</span> target)</span></span>&#123;</span><br><span class="line">        unsafe.compareAndSwapInt(<span class="keyword">this</span>,valueOffset,old,target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><p>è¿™é‡Œæˆ‘ä»¬æ˜¯é€šè¿‡ Unsafe ç±»å»æ“ä½œä¿®æ”¹å¯¹è±¡çš„å±æ€§ã€‚éœ€è¦æ‹¿åˆ°è¿™ä¸ªå±æ€§çš„ <strong><font color=blue>åç§»é‡</font></strong></p><img src="https://oscimg.oschina.net/oscnet/up-f55fe0652c7614bde5802d3470ecdb3cf7c.png" style="zoom:50%;" /><h3 id="10-3-å¦‚æœéœ€è¦åŸå­æ“ä½œçš„æ˜¯æ•°ç»„ï¼Œæ€ä¹ˆåŠï¼Ÿ"><a href="#10-3-å¦‚æœéœ€è¦åŸå­æ“ä½œçš„æ˜¯æ•°ç»„ï¼Œæ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="10.3 å¦‚æœéœ€è¦åŸå­æ“ä½œçš„æ˜¯æ•°ç»„ï¼Œæ€ä¹ˆåŠï¼Ÿ"></a>10.3 å¦‚æœéœ€è¦åŸå­æ“ä½œçš„æ˜¯æ•°ç»„ï¼Œæ€ä¹ˆåŠï¼Ÿ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerArrayRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span>[] value = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line">    <span class="keyword">static</span> AtomicIntegerArray aiArray = <span class="keyword">new</span> AtomicIntegerArray(value);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//todo åŸå­ä¿®æ”¹æ•°ç»„ä¸‹æ ‡0çš„æ•°å€¼</span></span><br><span class="line">        aiArray.getAndSet(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">        System.out.println(aiArray.get(<span class="number">0</span>));</span><br><span class="line">        System.out.println(value[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="åº•å±‚åŸç†"><a href="#åº•å±‚åŸç†" class="headerlink" title="åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">AtomicIntegerArray</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Visibility guaranteed by final field guarantees</span></span><br><span class="line">   <span class="keyword">this</span>.array = array.clone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-4-å¦‚æœåŸå­æ“ä½œä¿®æ”¹çš„æ˜¯å¯¹è±¡ç±»å‹æ•°ç»„å‘¢ï¼Ÿ"><a href="#10-4-å¦‚æœåŸå­æ“ä½œä¿®æ”¹çš„æ˜¯å¯¹è±¡ç±»å‹æ•°ç»„å‘¢ï¼Ÿ" class="headerlink" title="10.4 å¦‚æœåŸå­æ“ä½œä¿®æ”¹çš„æ˜¯å¯¹è±¡ç±»å‹æ•°ç»„å‘¢ï¼Ÿ"></a>10.4 å¦‚æœåŸå­æ“ä½œä¿®æ”¹çš„æ˜¯å¯¹è±¡ç±»å‹æ•°ç»„å‘¢ï¼Ÿ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicReferenceArrayRunner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Tuling[] ovalue = <span class="keyword">new</span> Tuling[]&#123;<span class="keyword">new</span> Tuling(<span class="number">1</span>),<span class="keyword">new</span> Tuling(<span class="number">2</span>)&#125;;</span><br><span class="line">    <span class="keyword">static</span> AtomicReferenceArray&lt;Tuling&gt; objarray = <span class="keyword">new</span> AtomicReferenceArray(ovalue);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(objarray.get(<span class="number">0</span>).getSequence());</span><br><span class="line">        objarray.set(<span class="number">0</span>,<span class="keyword">new</span> Tuling(<span class="number">3</span>));</span><br><span class="line">        System.out.println(objarray.get(<span class="number">0</span>).getSequence());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure><p>åº•å±‚åŸç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AtomicReferenceArray</span><span class="params">(E[] array)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Visibility guaranteed by final field guarantees</span></span><br><span class="line">    <span class="keyword">this</span>.array = Arrays.copyOf(array, array.length, Object[].class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-5-AtomicIntegerFieldUpdaterä¿®æ”¹å¯¹è±¡çš„å±æ€§"><a href="#10-5-AtomicIntegerFieldUpdaterä¿®æ”¹å¯¹è±¡çš„å±æ€§" class="headerlink" title="10.5 AtomicIntegerFieldUpdaterä¿®æ”¹å¯¹è±¡çš„å±æ€§"></a>10.5 AtomicIntegerFieldUpdaterä¿®æ”¹å¯¹è±¡çš„å±æ€§</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerFieldUpdateRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicIntegerFieldUpdater aifu = AtomicIntegerFieldUpdater.newUpdater(Student.class,<span class="string">&quot;old&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Student stu = <span class="keyword">new</span> Student(<span class="string">&quot;æ¨è¿‡&quot;</span>,<span class="number">18</span>);</span><br><span class="line">        System.out.println(aifu.getAndIncrement(stu));</span><br><span class="line">        System.out.println(aifu.getAndIncrement(stu));</span><br><span class="line">        System.out.println(aifu.incrementAndGet(stu));</span><br><span class="line">        System.out.println(aifu.get(stu));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> old;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String name ,<span class="keyword">int</span> old)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">            <span class="keyword">this</span>.old = old;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Int ç±»å‹å±æ€§çš„åç§»é‡ä¸éœ€è¦æˆ‘ä»¬ç¨‹åºå‘˜è‡ªå·±è°ƒç”¨apiè®¡ç®—ï¼ŒAtomicIntegerFieldUpdaterè¿™ä¸ªåº•å±‚ä¼šè‡ªå·±è®¡ç®—ã€‚</p><h3 id="10-6-å¦‚æœéœ€è¦ä¿®æ”¹çš„å±æ€§ä¸æ˜¯integerç±»å‹çš„å‘¢ï¼Ÿ"><a href="#10-6-å¦‚æœéœ€è¦ä¿®æ”¹çš„å±æ€§ä¸æ˜¯integerç±»å‹çš„å‘¢ï¼Ÿ" class="headerlink" title="10.6 å¦‚æœéœ€è¦ä¿®æ”¹çš„å±æ€§ä¸æ˜¯integerç±»å‹çš„å‘¢ï¼Ÿ"></a>10.6 å¦‚æœéœ€è¦ä¿®æ”¹çš„å±æ€§ä¸æ˜¯integerç±»å‹çš„å‘¢ï¼Ÿ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicReferenceFieldUpdaterRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicReferenceFieldUpdater atomic = AtomicReferenceFieldUpdater.newUpdater(Document.class, String.class, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Document document = <span class="keyword">new</span> Document(<span class="string">&quot;æ¨è¿‡&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        System.out.println(atomic.get(document));</span><br><span class="line">        atomic.getAndSet(document, <span class="string">&quot;xiaolongnv&quot;</span>);</span><br><span class="line">        System.out.println(atomic.get(document));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦ä¸€ç§æ–¹å¼ä¿®æ”¹</span></span><br><span class="line">        UnaryOperator&lt;String&gt; uo = s -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;UnaryOperator:--&gt;&quot;</span> + s);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;å°é¾™å¥³&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(atomic.getAndUpdate(document, uo));</span><br><span class="line">        System.out.println(atomic.get(document));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Document</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> version;</span><br><span class="line"></span><br><span class="line">        Document(String obj, <span class="keyword">int</span> v) &#123;</span><br><span class="line">            name = obj;</span><br><span class="line">            version = v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h4><ul><li>Name å±æ€§å¿…é¡»æ˜¯ public</li><li>Name å±æ€§å¿…é¡»æ˜¯ volatile</li></ul><h3 id="10-7-å¤§åé¼é¼çš„ABAé—®é¢˜"><a href="#10-7-å¤§åé¼é¼çš„ABAé—®é¢˜" class="headerlink" title="10.7 å¤§åé¼é¼çš„ABAé—®é¢˜"></a>10.7 å¤§åé¼é¼çš„ABAé—®é¢˜</h3><p>æ·»åŠ ç‰ˆæœ¬å·è§£å†³ABAé—®é¢˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicStampedRerenceRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicStampedReference&lt;Integer&gt; atomicStampedRef =</span><br><span class="line">            <span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Thread main = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> stamp = atomicStampedRef.getStamp(); <span class="comment">//è·å–å½“å‰æ ‡è¯†åˆ«</span></span><br><span class="line">            System.out.println(<span class="string">&quot;æ“ä½œçº¿ç¨‹&quot;</span> + Thread.currentThread()+ <span class="string">&quot;stamp=&quot;</span>+stamp + <span class="string">&quot;,åˆå§‹å€¼ a = &quot;</span> + atomicStampedRef.getReference());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>); <span class="comment">//ç­‰å¾…1ç§’ ï¼Œä»¥ä¾¿è®©å¹²æ‰°çº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> isCASSuccess = atomicStampedRef.compareAndSet(<span class="number">1</span>,<span class="number">2</span>,stamp,stamp +<span class="number">1</span>);  <span class="comment">//æ­¤æ—¶expectedReferenceæœªå‘ç”Ÿæ”¹å˜ï¼Œä½†æ˜¯stampå·²ç»è¢«ä¿®æ”¹äº†,æ‰€ä»¥CASå¤±è´¥</span></span><br><span class="line">            System.out.println(<span class="string">&quot;æ“ä½œçº¿ç¨‹&quot;</span> + Thread.currentThread() + <span class="string">&quot;stamp=&quot;</span>+stamp + <span class="string">&quot;,CASæ“ä½œç»“æœ: &quot;</span> + isCASSuccess);</span><br><span class="line">        &#125;,<span class="string">&quot;ä¸»æ“ä½œçº¿ç¨‹&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Thread other = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> stamp = atomicStampedRef.getStamp();</span><br><span class="line">            atomicStampedRef.compareAndSet(<span class="number">1</span>,<span class="number">2</span>,stamp,stamp+<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ“ä½œçº¿ç¨‹&quot;</span> + Thread.currentThread() + <span class="string">&quot;stamp=&quot;</span>+atomicStampedRef.getStamp() +<span class="string">&quot;,ã€incrementã€‘ ,å€¼ a= &quot;</span>+ atomicStampedRef.getReference());</span><br><span class="line">            stamp = atomicStampedRef.getStamp();</span><br><span class="line">            atomicStampedRef.compareAndSet(<span class="number">2</span>,<span class="number">1</span>,stamp,stamp+<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;æ“ä½œçº¿ç¨‹&quot;</span> + Thread.currentThread() + <span class="string">&quot;stamp=&quot;</span>+atomicStampedRef.getStamp() +<span class="string">&quot;,ã€decrementã€‘ ,å€¼ a= &quot;</span>+ atomicStampedRef.getReference());</span><br><span class="line">        &#125;,<span class="string">&quot;å¹²æ‰°çº¿ç¨‹&quot;</span>);</span><br><span class="line"></span><br><span class="line">        main.start();</span><br><span class="line">        LockSupport.parkNanos(<span class="number">1000000</span>);</span><br><span class="line">        other.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="11-Unsafeç±»"><a href="#11-Unsafeç±»" class="headerlink" title="11. Unsafeç±»"></a>11. Unsafeç±»</h2><p>Unsafeæ˜¯ä½äºsun.miscåŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦æä¾›ä¸€äº›ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚<strong>ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æº</strong>ã€<strong>è‡ªä¸»ç®¡ç†å†…å­˜èµ„æº</strong>ç­‰ï¼Œè¿™äº›æ–¹æ³•åœ¨æå‡Javaè¿è¡Œæ•ˆç‡ã€å¢å¼ºJavaè¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚</p><p>ä½†ç”±äºUnsafeç±»ä½¿Javaè¯­è¨€æ‹¥æœ‰äº†ç±»ä¼¼Cè¯­è¨€æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼Œè¿™æ— ç–‘ä¹Ÿå¢åŠ äº†ç¨‹åºå‘ç”Ÿç›¸å…³æŒ‡é’ˆé—®é¢˜çš„é£é™©ã€‚åœ¨ç¨‹åºä¸­è¿‡åº¦ã€ä¸æ­£ç¡®ä½¿ç”¨Unsafeç±»ä¼šä½¿å¾—ç¨‹åºå‡ºé”™çš„æ¦‚ç‡å˜å¤§ï¼Œä½¿å¾—Javaè¿™ç§å®‰å…¨çš„è¯­è¨€å˜å¾—ä¸å†â€œå®‰å…¨â€ï¼Œå› æ­¤å¯¹Unsafeçš„ä½¿ç”¨ä¸€å®šè¦æ…é‡ã€‚</p><p>Unsafeç±»ä¸ºä¸€<strong>å•ä¾‹</strong>å®ç°ï¼Œæä¾›é™æ€æ–¹æ³•getUnsafeè·å–Unsafeå®ä¾‹ï¼Œå½“ä¸”ä»…å½“è°ƒç”¨getUnsafeæ–¹æ³•çš„ç±»ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨æ‰€åŠ è½½æ—¶æ‰åˆæ³•ï¼Œå¦åˆ™æŠ›å‡ºSecurityExceptionå¼‚å¸¸ã€‚</p><h3 id="11-1-Unsafe-class"><a href="#11-1-Unsafe-class" class="headerlink" title="11.1 Unsafe.class"></a>11.1 Unsafe.class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Unsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Class var0 = Reflection.getCallerClass();</span><br><span class="line"><span class="keyword">if</span> (!VM.isSystemDomainLoader(var0.getClassLoader())) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">&quot;Unsafe&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> theUnsafe;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="11-2-unsafe-å †å¤–å†…å­˜ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ "><a href="#11-2-unsafe-å †å¤–å†…å­˜ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="11.2 unsafe å †å¤–å†…å­˜ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ "></a>11.2 unsafe å †å¤–å†…å­˜ä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ </h3><p><strong>Java é¢‘ç¹æ“ä½œæ–‡ä»¶ï¼Œå¯èƒ½é€ æˆå†…å­˜ä½¿ç”¨éª¤å¢ï¼Œjvmé¢‘ç¹GCã€‚</strong> <font color=red>å¦‚ä½•ä¼˜åŒ–ï¼Ÿ</font></p><ul><li><strong><font color=blue>å¯ä»¥ä½¿ç”¨å †å¤–å†…å­˜</font></strong>     è¿™æ ·å¯ä»¥ä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡çš„è¯·æ±‚ï¼Œjvmå¯ä»¥æ­£å¸¸æ‰§è¡Œå…¶ä»–ä¸šåŠ¡</li><li>å †å¤–å†…å­˜ä¸å±äºjvmç®¡ï¼Œä½¿ç”¨å®Œä¹‹åï¼Œ<strong>éœ€è¦æ‰‹åŠ¨é‡Šæ”¾</strong>ï¼Œå¦åˆ™å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼ã€‚</li></ul><p>ä»£ç æ¼”ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMemoryAccess</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Unsafe unsafe = UnsafeInstance.reflectGetUnsafe();</span><br><span class="line">        <span class="keyword">long</span> oneHundred = <span class="number">1193123491341341234L</span>;</span><br><span class="line">        <span class="keyword">byte</span> size = <span class="number">8</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è°ƒç”¨allocateMemoryåˆ†é…å†…å­˜</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">long</span> memoryAddress = unsafe.allocateMemory(size);</span><br><span class="line">        System.out.println(<span class="string">&quot;address:-&gt;&quot;</span>+memoryAddress);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å°†1å†™å…¥åˆ°å†…å­˜ä¸­</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        unsafe.putAddress(memoryAddress, oneHundred);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å†…å­˜ä¸­è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">long</span> readValue = unsafe.getAddress(memoryAddress);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;value : &quot;</span> + readValue);</span><br><span class="line"></span><br><span class="line">        unsafe.freeMemory(memoryAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.finalize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="11-3-monitorå¯¹è±¡é”"><a href="#11-3-monitorå¯¹è±¡é”" class="headerlink" title="11.3 monitorå¯¹è±¡é”"></a>11.3 monitorå¯¹è±¡é”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectMonitorRunner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Object object = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">static</span> Unsafe unsafe = UnsafeInstance.reflectGetUnsafe();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        unsafe.monitorEnter(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        unsafe.monitorExit(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//jvmå†…ç½®é”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (object)&#123;</span><br><span class="line">            <span class="comment">//å†™é€»è¾‘</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ObjectMonitorRunner objectMonitorRunner = <span class="keyword">new</span> ObjectMonitorRunner();</span><br><span class="line">        objectMonitorRunner.method1();</span><br><span class="line">        objectMonitorRunner.method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥è·¨æ–¹æ³•åŠ é”å’Œé‡Šæ”¾é”ã€‚ </li><li>æ³¨æ„æ­»é”é—®é¢˜</li></ul><h3 id="11-4-çº¿ç¨‹é˜»å¡å’Œå”¤é†’"><a href="#11-4-çº¿ç¨‹é˜»å¡å’Œå”¤é†’" class="headerlink" title="11.4 çº¿ç¨‹é˜»å¡å’Œå”¤é†’"></a>11.4 çº¿ç¨‹é˜»å¡å’Œå”¤é†’</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadParkerRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Unsafe unsafe = UnsafeInstance.reflectGetUnsafe();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;thread - is running----&quot;</span>);</span><br><span class="line">                <span class="comment">//trueåˆ™ä¼šå®ç°mså®šæ—¶,falseåˆ™ä¼šå®ç°nså®šæ—¶ã€‚</span></span><br><span class="line">                unsafe.park(<span class="keyword">false</span>,<span class="number">0L</span>); <span class="comment">//é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">                System.out.println(<span class="string">&quot;thread is over-----&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;å”¤é†’Thread-t&quot;</span>);</span><br><span class="line">        unsafe.unpark(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AQSä¸­å¤§é‡ä½¿ç”¨äº† <code>public native void unpark(Object var1);</code> æ–¹æ³•ï¼›</p><h2 id="12-å¹¶å‘å®¹å™¨ä¹‹ConcurrentHashMap"><a href="#12-å¹¶å‘å®¹å™¨ä¹‹ConcurrentHashMap" class="headerlink" title="12. å¹¶å‘å®¹å™¨ä¹‹ConcurrentHashMap"></a>12. å¹¶å‘å®¹å™¨ä¹‹ConcurrentHashMap</h2><h3 id="12-1-é‡è¦æˆå‘˜å±æ€§"><a href="#12-1-é‡è¦æˆå‘˜å±æ€§" class="headerlink" title="12.1 é‡è¦æˆå‘˜å±æ€§"></a>12.1 é‡è¦æˆå‘˜å±æ€§</h3><ul><li>DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; Hashè¡¨é»˜è®¤åˆå§‹å®¹é‡</li><li>MAXIMUM_CAPACITY = 1 &lt;&lt; 30; æœ€å¤§Hashè¡¨å®¹é‡</li><li>DEFAULT_LOAD_FACTOR = 0.75fï¼›é»˜è®¤åŠ è½½å› å­</li><li>TREEIFY_THRESHOLD = 8ï¼›é“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼</li><li>UNTREEIFY_THRESHOLD = 6ï¼›çº¢é»‘æ ‘è½¬é“¾è¡¨é˜ˆå€¼</li><li>MIN_TREEIFY_CAPACITY = 64ï¼›é“¾è¡¨è½¬çº¢é»‘æ ‘æ—¶hashè¡¨æœ€å°å®¹é‡é˜ˆå€¼ï¼Œè¾¾ä¸åˆ°ä¼˜å…ˆæ‰©å®¹ã€‚</li></ul><h3 id="12-2-hashMapåº•å±‚ç»“æ„"><a href="#12-2-hashMapåº•å±‚ç»“æ„" class="headerlink" title="12.2 hashMapåº•å±‚ç»“æ„"></a>12.2 hashMapåº•å±‚ç»“æ„</h3><ul><li>1.7 æ•°ç»„ + é“¾è¡¨</li><li>1.8ä¹‹å æ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘</li></ul><h3 id="12-3-hashmapå®¹é‡"><a href="#12-3-hashmapå®¹é‡" class="headerlink" title="12.3 hashmapå®¹é‡"></a>12.3 hashmapå®¹é‡</h3><p>hashmapçš„å®¹é‡ï¼Œå€¼çš„æ˜¯æ•°ç»„çš„é•¿åº¦ã€‚å¦‚æœä¸è€ƒè™‘hash ç¢°æ’çš„æƒ…å†µä¸‹ï¼Œhash map å­˜æ”¾æ•°æ®é‡ = æ•°ç»„çš„é•¿åº¦ = å®¹é‡</p><h4 id="12-3-1-å®¹é‡æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Ÿ"><a href="#12-3-1-å®¹é‡æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Ÿ" class="headerlink" title="12.3.1 å®¹é‡æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Ÿ"></a>12.3.1 å®¹é‡æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">11</span>); <span class="comment">// åˆå§‹å®¹é‡å°±æ˜¯11 ï¼Ÿ</span></span><br></pre></td></tr></table></figure><ul><li>å¿…é¡»å¤§äºè®¾ç½®çš„size</li><li>å¿…é¡»æ˜¯2çš„æŒ‡æ•°å¹‚</li><li>å¿…é¡»å¤§äºsize</li></ul><p><strong>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬åˆå§‹åŒ–å®¹é‡è®¾ç½®æˆ11ï¼Œå®é™…åˆå§‹åŒ–å®¹é‡ä¸º16. å¦‚æœsize = 17å‘¢ï¼Ÿ å®é™…åˆå§‹åŒ–å®¹é‡åˆ™æ˜¯32ï¼›</strong></p><h4 id="12-3-2-hashmapçš„é»˜è®¤å®¹é‡ä¸ºä»€ä¹ˆæ˜¯16ï¼Ÿ"><a href="#12-3-2-hashmapçš„é»˜è®¤å®¹é‡ä¸ºä»€ä¹ˆæ˜¯16ï¼Ÿ" class="headerlink" title="12.3.2 hashmapçš„é»˜è®¤å®¹é‡ä¸ºä»€ä¹ˆæ˜¯16ï¼Ÿ"></a>12.3.2 hashmapçš„é»˜è®¤å®¹é‡ä¸ºä»€ä¹ˆæ˜¯16ï¼Ÿ</h4><ul><li>16çš„å®¹é‡åŸºæœ¬å¤Ÿç”¨äº†</li><li>å®¹é‡å¿…é¡»æ˜¯2çš„æŒ‡æ•°å€</li></ul><h4 id="12-3-3-hashCode-å¯ä»¥å°äº0å—ï¼Ÿ"><a href="#12-3-3-hashCode-å¯ä»¥å°äº0å—ï¼Ÿ" class="headerlink" title="12.3.3 hashCode å¯ä»¥å°äº0å—ï¼Ÿ"></a>12.3.3 hashCode å¯ä»¥å°äº0å—ï¼Ÿ</h4><p>å¯ä»¥çš„</p><h4 id="12-3-4-å®¹é‡ä¸ºä»€ä¹ˆä¸€å®šæ˜¯2çš„æŒ‡æ•°æ¬¡å¹‚ï¼Ÿ"><a href="#12-3-4-å®¹é‡ä¸ºä»€ä¹ˆä¸€å®šæ˜¯2çš„æŒ‡æ•°æ¬¡å¹‚ï¼Ÿ" class="headerlink" title="12.3.4 å®¹é‡ä¸ºä»€ä¹ˆä¸€å®šæ˜¯2çš„æŒ‡æ•°æ¬¡å¹‚ï¼Ÿ"></a>12.3.4 å®¹é‡ä¸ºä»€ä¹ˆä¸€å®šæ˜¯2çš„æŒ‡æ•°æ¬¡å¹‚ï¼Ÿ</h4><p>åœ¨ä½¿ç”¨hashCode è®¡ç®—æ•°ç»„ä¸‹æ ‡è¿›è¡Œ ã€Œä½è¿ç®—ã€æ—¶ï¼Œ<code>tab[i = (n - 1) &amp; hash])</code></p><h4 id="12-3-5-keyæ˜¯å¦‚ä½•ä¿è¯å”¯ä¸€çš„ï¼Ÿ"><a href="#12-3-5-keyæ˜¯å¦‚ä½•ä¿è¯å”¯ä¸€çš„ï¼Ÿ" class="headerlink" title="12.3.5 keyæ˜¯å¦‚ä½•ä¿è¯å”¯ä¸€çš„ï¼Ÿ"></a>12.3.5 keyæ˜¯å¦‚ä½•ä¿è¯å”¯ä¸€çš„ï¼Ÿ</h4><p>é‡å¤çš„è¦†ç›–</p><h3 id="12-4-ä»€ä¹ˆæ˜¯hashç¢°æ’ï¼Œå¦‚ä½•è§£å†³hashç¢°æ’ï¼Ÿ"><a href="#12-4-ä»€ä¹ˆæ˜¯hashç¢°æ’ï¼Œå¦‚ä½•è§£å†³hashç¢°æ’ï¼Ÿ" class="headerlink" title="12.4 ä»€ä¹ˆæ˜¯hashç¢°æ’ï¼Œå¦‚ä½•è§£å†³hashç¢°æ’ï¼Ÿ"></a>12.4 ä»€ä¹ˆæ˜¯hashç¢°æ’ï¼Œå¦‚ä½•è§£å†³hashç¢°æ’ï¼Ÿ</h3><img src="https://oscimg.oschina.net/oscnet/up-926da3903444e884ce10b4e9b1b001b4b33.png" style="zoom:50%;" /><p>hashç¢°æ’ï¼Œhashå†²çªã€‚ä¸åŒçš„å€¼ç»è¿‡hashcodeå®šä½æ•°ç»„åˆ°åŒä¸€ä¸ªä¸‹æ ‡ä¸‹ã€‚</p><ul><li>æ‹‰é“¾æ³• ï¼ˆ1.7 å¤´éƒ¨æ’å…¥ 1.8 å°¾éƒ¨æ’å…¥æ³•ï¼‰</li><li>å¼€æ”¾å¯»å€æ³•</li></ul><h3 id="12-5-å…ƒç´ ä¸‹è¡¨å¦‚ä½•è®¡ç®—çš„ï¼Ÿ"><a href="#12-5-å…ƒç´ ä¸‹è¡¨å¦‚ä½•è®¡ç®—çš„ï¼Ÿ" class="headerlink" title="12.5 å…ƒç´ ä¸‹è¡¨å¦‚ä½•è®¡ç®—çš„ï¼Ÿ"></a>12.5 å…ƒç´ ä¸‹è¡¨å¦‚ä½•è®¡ç®—çš„ï¼Ÿ</h3><p><strong>ä½è¿ç®—</strong>   æ•ˆç‡æ¯”å–æ¨¡è¿ç®—æ•ˆç‡è¦é«˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tab[i = (n - <span class="number">1</span>) &amp; hash]</span><br></pre></td></tr></table></figure><h4 id="12-5-1-ä¸ºä»€ä¹ˆç”¨-length-1å»åšä¸è¿ç®—ï¼Ÿ"><a href="#12-5-1-ä¸ºä»€ä¹ˆç”¨-length-1å»åšä¸è¿ç®—ï¼Ÿ" class="headerlink" title="12.5.1 ä¸ºä»€ä¹ˆç”¨ length - 1å»åšä¸è¿ç®—ï¼Ÿ"></a>12.5.1 ä¸ºä»€ä¹ˆç”¨ length - 1å»åšä¸è¿ç®—ï¼Ÿ</h4><ul><li>é˜²æ­¢å‘ç”Ÿè¶Šç•Œ</li><li>ä½ä½å…¨éƒ¨æ˜¯1ï¼Œè®¡ç®—å¿«</li></ul><h3 id="12-6-è®¡ç®—hashCodeçš„æ—¶å€™ï¼Œä¸‹é¢çš„ä¸€äº›æŠ‘æˆ–æ“ä½œæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"><a href="#12-6-è®¡ç®—hashCodeçš„æ—¶å€™ï¼Œä¸‹é¢çš„ä¸€äº›æŠ‘æˆ–æ“ä½œæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ" class="headerlink" title="12.6 è®¡ç®—hashCodeçš„æ—¶å€™ï¼Œä¸‹é¢çš„ä¸€äº›æŠ‘æˆ–æ“ä½œæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"></a>12.6 è®¡ç®—hashCodeçš„æ—¶å€™ï¼Œä¸‹é¢çš„ä¸€äº›æŠ‘æˆ–æ“ä½œæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static final int hash(Object key) &#123;</span><br><span class="line">        int h;</span><br><span class="line">        return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è®©hashå˜å¾—æ›´åŠ æ•£åˆ—ï¼Œé™ä½hashç¢°æ’ã€‚ </p><p><strong><font color=green>Â ä»€ä¹ˆæ˜¯hashæ‰°åŠ¨ ï¼Ÿ ï¼Ÿ ï¼Ÿ</font></strong></p><h3 id="12-7-hashmapæ˜¯å¦‚ä½•æ‰©å®¹çš„ï¼Ÿ"><a href="#12-7-hashmapæ˜¯å¦‚ä½•æ‰©å®¹çš„ï¼Ÿ" class="headerlink" title="12.7 hashmapæ˜¯å¦‚ä½•æ‰©å®¹çš„ï¼Ÿ"></a>12.7 hashmapæ˜¯å¦‚ä½•æ‰©å®¹çš„ï¼Ÿ</h3><h4 id="12-7-1-ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹"><a href="#12-7-1-ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹" class="headerlink" title="12.7.1 ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹"></a>12.7.1 ä»€ä¹ˆæ—¶å€™è§¦å‘æ‰©å®¹</h4><p>size &gt; threshold = capital * loadï¼ˆåŠ è½½å› å­ï¼‰ï¼Œè§¦å‘æ‰©å®¹ã€‚</p><p>13 &gt;= 12 = 16 * 0.75</p><h4 id="12-7-2-æ‰©å®¹æ˜¯æ€ä¹ˆè¿›è¡Œçš„"><a href="#12-7-2-æ‰©å®¹æ˜¯æ€ä¹ˆè¿›è¡Œçš„" class="headerlink" title="12.7.2 æ‰©å®¹æ˜¯æ€ä¹ˆè¿›è¡Œçš„"></a>12.7.2 æ‰©å®¹æ˜¯æ€ä¹ˆè¿›è¡Œçš„</h4><ul><li>æ•°ç»„çš„é•¿åº¦å¿…é¡»è¿˜å¾—æ˜¯2çš„æŒ‡æ•°å¹‚ï¼Œæ‰€ä»¥æ•°ç»„é•¿åº¦ * 2 </li><li>å°†åŸæ¥çš„æ•°æ®è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸Šé¢</li></ul><h4 id="12-7-3-hashmap1-7æ‰©å®¹æœºåˆ¶"><a href="#12-7-3-hashmap1-7æ‰©å®¹æœºåˆ¶" class="headerlink" title="12.7.3 hashmap1.7æ‰©å®¹æœºåˆ¶"></a>12.7.3 hashmap1.7æ‰©å®¹æœºåˆ¶</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable, <span class="keyword">boolean</span> rehash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; next = e.next;<span class="comment">//ç¬¬ä¸€è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                e.hash = <span class="keyword">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);<span class="comment">//ç¬¬äºŒè¡Œ</span></span><br><span class="line">            e.next = newTable[i];<span class="comment">//ç¬¬ä¸‰è¡Œ</span></span><br><span class="line">            newTable[i] = e;<span class="comment">//ç¬¬å››è¡Œ</span></span><br><span class="line">            e = next;<span class="comment">//ç¬¬äº”è¡Œ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å»æ‰äº†ä¸€äº›å†—ä½™çš„ä»£ç ï¼Œ å±‚æ¬¡ç»“æ„æ›´åŠ æ¸…æ™°äº†ã€‚</p><ul><li>ç¬¬ä¸€è¡Œï¼šè®°å½•oldhashè¡¨ä¸­e.next</li><li>ç¬¬äºŒè¡Œï¼šrehashè®¡ç®—å‡ºæ•°ç»„çš„ä½ç½®(hashè¡¨ä¸­æ¡¶çš„ä½ç½®)</li><li>ç¬¬ä¸‰è¡Œï¼šeè¦æ’å…¥é“¾è¡¨çš„å¤´éƒ¨ï¼Œ æ‰€ä»¥è¦å…ˆå°†e.nextæŒ‡å‘new hashè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ </li><li>ç¬¬å››è¡Œï¼šå°†eæ”¾å…¥åˆ°new hashè¡¨çš„å¤´éƒ¨</li><li>ç¬¬äº”è¡Œï¼š è½¬ç§»eåˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ ç»§ç»­å¾ªç¯ä¸‹å»</li></ul><blockquote><p>å¤´æ’æ³•ï¼š åŸæ¥é“¾è¡¨ä¸Šçš„æ•°æ®æ˜¯ A - B - C ï¼Œæ–°æ•°ç»„ä¸Šçš„ç»“ç‚¹æ˜¯ C - B - A</p></blockquote><p>å•çº¿ç¨‹æ‰©å®¹æ—¶æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯å¤šçº¿ç¨‹è¿›è¡Œæ‰©å®¹çš„æƒ…å†µä¸‹ï¼Œä¼šå‘ç”Ÿ<strong>æ­»å¾ªç¯</strong>é—®é¢˜ã€‚</p><h5 id="12-7-3-1-å¤šçº¿ç¨‹æ‰©å®¹çš„æ­»é”é—®é¢˜"><a href="#12-7-3-1-å¤šçº¿ç¨‹æ‰©å®¹çš„æ­»é”é—®é¢˜" class="headerlink" title="12.7.3.1 å¤šçº¿ç¨‹æ‰©å®¹çš„æ­»é”é—®é¢˜"></a>12.7.3.1 å¤šçº¿ç¨‹æ‰©å®¹çš„æ­»é”é—®é¢˜</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">      Entry&lt;K,V&gt; next = e.next;<span class="comment">//ç¬¬ä¸€è¡Œï¼Œçº¿ç¨‹1æ‰§è¡Œåˆ°æ­¤è¢«è°ƒåº¦æŒ‚èµ·</span></span><br><span class="line">      <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);<span class="comment">//ç¬¬äºŒè¡Œ</span></span><br><span class="line">      e.next = newTable[i];<span class="comment">//ç¬¬ä¸‰è¡Œ</span></span><br><span class="line">      newTable[i] = e;<span class="comment">//ç¬¬å››è¡Œ</span></span><br><span class="line">      e = next;<span class="comment">//ç¬¬äº”è¡Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="12-7-3-2-å¤šçº¿ç¨‹æ‰©å®¹æµç¨‹"><a href="#12-7-3-2-å¤šçº¿ç¨‹æ‰©å®¹æµç¨‹" class="headerlink" title="12.7.3.2  å¤šçº¿ç¨‹æ‰©å®¹æµç¨‹"></a>12.7.3.2  å¤šçº¿ç¨‹æ‰©å®¹æµç¨‹</h5><p><strong>æµç¨‹å›¾å¦‚ä¸‹ï¼š</strong></p><img src="https://oscimg.oschina.net/oscnet/up-ff7bdfb24f595d69718aa3c10022dd4f177.png" style="zoom:50%;" /><p><strong>åé¢ä¼šå½¢æˆç¯</strong>ï¼š</p><img src="https://oscimg.oschina.net/oscnet/up-a4c0b912329d188c0e95cf9f4b624717e19.png" style="zoom:50%;" /><p><strong>ä¸‹æ¬¡æ·»åŠ æ•°æ®æˆ–è€…æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ­»å¾ªç¯ï¼›</strong></p><h4 id="12-7-4-hashmap1-8æ‰©å®¹æœºåˆ¶"><a href="#12-7-4-hashmap1-8æ‰©å®¹æœºåˆ¶" class="headerlink" title="12.7.4 hashmap1.8æ‰©å®¹æœºåˆ¶"></a>12.7.4 hashmap1.8æ‰©å®¹æœºåˆ¶</h4><h5 id="12-7-4-1-ä»€ä¹ˆæ—¶å€™é“¾è¡¨å¯ä»¥è½¬çº¢é»‘æ ‘"><a href="#12-7-4-1-ä»€ä¹ˆæ—¶å€™é“¾è¡¨å¯ä»¥è½¬çº¢é»‘æ ‘" class="headerlink" title="12.7.4.1 ä»€ä¹ˆæ—¶å€™é“¾è¡¨å¯ä»¥è½¬çº¢é»‘æ ‘"></a>12.7.4.1 ä»€ä¹ˆæ—¶å€™é“¾è¡¨å¯ä»¥è½¬çº¢é»‘æ ‘</h5><ul><li>é˜ˆå€¼=8 å½“é“¾è¡¨é•¿åº¦ä¸º9çš„æ—¶å€™ï¼Œé“¾è¡¨å¯ä»¥è½¬æ¢æˆçº¢é»‘æ ‘ï¼Œä½†æ˜¯è¿˜æœ‰ä¸‹é¢è¿™ä¸ªæ¡ä»¶çš„é™åˆ¶</li><li>å®¹é‡å¤§äºç­‰äº 64ï¼Œ<strong>å¦åˆ™ä¼˜å…ˆæ‰©å®¹</strong></li></ul><h5 id="12-7-4-2-ä¸ºä»€ä¹ˆé•¿åº¦æ˜¯8-é“¾è¡¨è½¬çº¢é»‘æ ‘ï¼Ÿ"><a href="#12-7-4-2-ä¸ºä»€ä¹ˆé•¿åº¦æ˜¯8-é“¾è¡¨è½¬çº¢é»‘æ ‘ï¼Ÿ" class="headerlink" title="12.7.4.2 ä¸ºä»€ä¹ˆé•¿åº¦æ˜¯8 é“¾è¡¨è½¬çº¢é»‘æ ‘ï¼Ÿ"></a>12.7.4.2 ä¸ºä»€ä¹ˆé•¿åº¦æ˜¯8 é“¾è¡¨è½¬çº¢é»‘æ ‘ï¼Ÿ</h5><p><a href="https://note.youdao.com/ynoteshare1/index.html?id=8695e2cbdb8dd5b333b65f3cf53d1673&type=note">ã€æ³Šæ¾åˆ†å¸ƒã€‘</a></p><blockquote><p><strong>ä¸€å¥è¯æ€»ç»“ï¼šæ³Šæ¾åˆ†å¸ƒæ˜¯å•ä½æ—¶é—´å†…ç‹¬ç«‹äº‹ä»¶å‘ç”Ÿæ¬¡æ•°çš„æ¦‚ç‡åˆ†å¸ƒï¼ŒæŒ‡æ•°åˆ†å¸ƒæ˜¯ç‹¬ç«‹äº‹ä»¶çš„æ—¶é—´é—´éš”çš„æ¦‚ç‡åˆ†å¸ƒã€‚</strong></p><p>è¯·æ³¨æ„æ˜¯â€ç‹¬ç«‹äº‹ä»¶â€ï¼Œæ³Šæ¾åˆ†å¸ƒå’ŒæŒ‡æ•°åˆ†å¸ƒçš„å‰ææ˜¯ï¼Œäº‹ä»¶ä¹‹é—´ä¸èƒ½æœ‰å…³è”ï¼Œå¦åˆ™å°±ä¸èƒ½è¿ç”¨ä¸Šé¢çš„å…¬å¼ã€‚</p></blockquote><p><strong>å¤§å¤šæ•°æƒ…å†µä¸‹ä¸ä¼šè¶…è¿‡8çš„é•¿åº¦</strong></p><h5 id="12-7-4-3-æ‰©å®¹æµç¨‹"><a href="#12-7-4-3-æ‰©å®¹æµç¨‹" class="headerlink" title="12.7.4.3 æ‰©å®¹æµç¨‹"></a>12.7.4.3 æ‰©å®¹æµç¨‹</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">                            next = e.next;</span><br><span class="line">                            <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                    loHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = e;</span><br><span class="line">                                loTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                    hiHead = e;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = e;</span><br><span class="line">                                hiTail = e;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                            newTab[j] = loHead;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                            newTab[j + oldCap] = hiHead;</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure><blockquote><p> <strong>é¿å…äº†rehash</strong></p></blockquote><p><img src="https://oscimg.oschina.net/oscnet/up-f199c6b73df571a3922107499e3099cc5cd.png"></p><h3 id="12-8-åŠ è½½å› å­ä¸ºä»€ä¹ˆæ˜¯0-75ï¼Ÿ"><a href="#12-8-åŠ è½½å› å­ä¸ºä»€ä¹ˆæ˜¯0-75ï¼Ÿ" class="headerlink" title="12.8 åŠ è½½å› å­ä¸ºä»€ä¹ˆæ˜¯0.75ï¼Ÿ"></a>12.8 åŠ è½½å› å­ä¸ºä»€ä¹ˆæ˜¯0.75ï¼Ÿ</h3><ul><li>å¦‚æœè°ƒæ•´çš„æ¯”è¾ƒå°ï¼Œç©ºé—´åˆ©ç”¨ç‡ä¼šä¸‹é™</li><li>å¦‚æœè°ƒæ•´çš„æ¯”è¾ƒå¤§ï¼Œå“ˆå¸Œç¢°æ’å¯èƒ½æ¯”è¾ƒä¸¥é‡</li></ul><h3 id="12-9-çº¿ç¨‹å®‰å…¨çš„ConcurrentHashMap"><a href="#12-9-çº¿ç¨‹å®‰å…¨çš„ConcurrentHashMap" class="headerlink" title="12.9 çº¿ç¨‹å®‰å…¨çš„ConcurrentHashMap"></a>12.9 çº¿ç¨‹å®‰å…¨çš„ConcurrentHashMap</h3><h4 id="12-9-1-å¸¸ç”¨API"><a href="#12-9-1-å¸¸ç”¨API" class="headerlink" title="12.9.1 å¸¸ç”¨API"></a>12.9.1 å¸¸ç”¨API</h4><ul><li>Put  hashç¢°æ’æ—¶åŒæ­¥</li><li>get æ²¡æœ‰æ·»åŠ åŒæ­¥é”</li></ul><h4 id="12-9-2-JDK1-7ä¸­çš„concurrentHash"><a href="#12-9-2-JDK1-7ä¸­çš„concurrentHash" class="headerlink" title="12.9.2 JDK1.7ä¸­çš„concurrentHash"></a>12.9.2 JDK1.7ä¸­çš„concurrentHash</h4><h5 id="12-9-2-1-åœ¨JDK1-7ä¸­ä½¿ç”¨åˆ†æ®µé”segment-ç»§æ‰¿-reentrantLock"><a href="#12-9-2-1-åœ¨JDK1-7ä¸­ä½¿ç”¨åˆ†æ®µé”segment-ç»§æ‰¿-reentrantLock" class="headerlink" title="12.9.2.1 åœ¨JDK1.7ä¸­ä½¿ç”¨åˆ†æ®µé”segment ç»§æ‰¿ reentrantLock"></a>12.9.2.1 åœ¨JDK1.7ä¸­ä½¿ç”¨åˆ†æ®µé”segment ç»§æ‰¿ reentrantLock</h5><img src="https://oscimg.oschina.net/oscnet/up-c03ede9caa78c50bebf404c10c0508ccd3b.png" style="zoom:50%;" /><ul><li>æ ¹æ®keyå¯»æ‰¾segmentå¹¶å°è¯•è·å–é”</li><li>æ‰¾åˆ°entryæ•°ç»„ä¸Šçš„ä¸‹æ ‡ï¼Œç„¶åæ’å…¥æ•°æ®</li><li>entry table å¼€å§‹å®¹é‡æ˜¯2</li></ul><h5 id="12-9-2-2-æ‰©å®¹æœºåˆ¶"><a href="#12-9-2-2-æ‰©å®¹æœºåˆ¶" class="headerlink" title="12.9.2.2 æ‰©å®¹æœºåˆ¶"></a>12.9.2.2 æ‰©å®¹æœºåˆ¶</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// todo</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="12-9-2-3-é»˜è®¤å¹¶å‘åº¦"><a href="#12-9-2-3-é»˜è®¤å¹¶å‘åº¦" class="headerlink" title="12.9.2.3 é»˜è®¤å¹¶å‘åº¦"></a>12.9.2.3 é»˜è®¤å¹¶å‘åº¦</h5><p><strong>16</strong> ï¼Œ <font color=red>æ‰©å®¹æ˜¯å¦å¯ä»¥å¢åŠ å¹¶å‘åº¦ï¼Ÿ</font></p><h4 id="12-9-3-åœ¨JDK1-8ä¸­ä½¿ç”¨cas-synchronized"><a href="#12-9-3-åœ¨JDK1-8ä¸­ä½¿ç”¨cas-synchronized" class="headerlink" title="12.9.3 åœ¨JDK1.8ä¸­ä½¿ç”¨cas + synchronized"></a>12.9.3 åœ¨JDK1.8ä¸­ä½¿ç”¨cas + synchronized</h4><h5 id="12-9-3-1-é‡è¦å±æ€§"><a href="#12-9-3-1-é‡è¦å±æ€§" class="headerlink" title="12.9.3.1 é‡è¦å±æ€§"></a>12.9.3.1 é‡è¦å±æ€§</h5><p>ConcurrentHashMapæ‹¥æœ‰å‡ºè‰²çš„æ€§èƒ½, åœ¨çœŸæ­£æŒæ¡å†…éƒ¨ç»“æ„æ—¶, å…ˆè¦æŒæ¡æ¯”è¾ƒé‡è¦çš„æˆå‘˜:</p><ul><li><p>LOAD_FACTOR: è´Ÿè½½å› å­, é»˜è®¤75%, å½“tableä½¿ç”¨ç‡è¾¾åˆ°75%æ—¶, ä¸ºå‡å°‘tableçš„hashç¢°æ’, tabelé•¿åº¦å°†æ‰©å®¹ä¸€å€ã€‚è´Ÿè½½å› å­è®¡ç®—: å…ƒç´ æ€»ä¸ªæ•°%table.lengh</p></li><li><p>TREEIFY_THRESHOLD: é»˜è®¤8, å½“é“¾è¡¨é•¿åº¦è¾¾åˆ°8æ—¶, å°†ç»“æ„è½¬å˜ä¸ºçº¢é»‘æ ‘ã€‚</p></li><li><p>UNTREEIFY_THRESHOLD: é»˜è®¤6, çº¢é»‘æ ‘è½¬å˜ä¸ºé“¾è¡¨çš„é˜ˆå€¼ã€‚</p></li><li><p>MIN_TRANSFER_STRIDE: é»˜è®¤16, tableæ‰©å®¹æ—¶, æ¯ä¸ªçº¿ç¨‹æœ€å°‘è¿ç§»tableçš„æ§½ä½ä¸ªæ•°ã€‚</p></li><li><p>MOVED: å€¼ä¸º-1, å½“Node.hashä¸ºMOVEDæ—¶, ä»£è¡¨ç€tableæ­£åœ¨æ‰©å®¹</p></li><li><p>TREEBIN, ç½®ä¸º-2, ä»£è¡¨æ­¤å…ƒç´ åæ¥çº¢é»‘æ ‘ã€‚</p></li><li><p>nextTable: tableè¿ç§»è¿‡ç¨‹ä¸´æ—¶å˜é‡, åœ¨è¿ç§»è¿‡ç¨‹ä¸­å°†å…ƒç´ å…¨éƒ¨è¿ç§»åˆ°nextTableä¸Šã€‚</p></li><li><p>sizeCtl: ç”¨æ¥æ ‡å¿—tableåˆå§‹åŒ–å’Œæ‰©å®¹çš„,ä¸åŒçš„å–å€¼ä»£è¡¨ç€ä¸åŒçš„å«ä¹‰:</p></li><li><ul><li><ul><li>0: tableè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–</li><li>-1: tableæ­£åœ¨åˆå§‹åŒ–</li><li>å°äº-1: å®é™…å€¼ä¸ºresizeStamp(n)&lt;</li><li>å¤§äº0: åˆå§‹åŒ–å®Œæˆå, ä»£è¡¨tableæœ€å¤§å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°, é»˜è®¤ä¸º0.75*n</li></ul></li></ul></li><li><p>transferIndex: tableå®¹é‡ä»næ‰©åˆ°2næ—¶, æ˜¯ä»ç´¢å¼•n-&gt;1çš„å…ƒç´ å¼€å§‹è¿ç§», transferIndexä»£è¡¨å½“å‰å·²ç»è¿ç§»çš„å…ƒç´ ä¸‹æ ‡</p></li><li><p>ForwardingNode: ä¸€ä¸ªç‰¹æ®Šçš„NodeèŠ‚ç‚¹, å…¶hashcode=MOVED, ä»£è¡¨ç€æ­¤æ—¶tableæ­£åœ¨åšæ‰©å®¹æ“ä½œã€‚æ‰©å®¹æœŸé—´, è‹¥tableæŸä¸ªå…ƒç´ ä¸ºnull, é‚£ä¹ˆè¯¥å…ƒç´ è®¾ç½®ä¸ºForwardingNode, å½“ä¸‹ä¸ªçº¿ç¨‹å‘è¿™ä¸ªå…ƒç´ æ’å…¥æ•°æ®æ—¶, æ£€æŸ¥hashcode=MOVED, å°±ä¼šå¸®ç€æ‰©å®¹ã€‚</p></li></ul><p>â€‹    ConcurrentHashMapç”±ä¸‰éƒ¨åˆ†æ„æˆ, table+é“¾è¡¨+çº¢é»‘æ ‘, å…¶ä¸­tableæ˜¯ä¸€ä¸ªæ•°ç»„, æ—¢ç„¶æ˜¯æ•°ç»„, å¿…é¡»è¦åœ¨ä½¿ç”¨æ—¶ç¡®å®šæ•°ç»„çš„å¤§å°, å½“tableå­˜æ”¾çš„å…ƒç´ è¿‡å¤šæ—¶, å°±éœ€è¦æ‰©å®¹, ä»¥å‡å°‘ç¢°æ’å‘ç”Ÿæ¬¡æ•°, æœ¬æ–‡å°±è®²è§£æ‰©å®¹çš„è¿‡ç¨‹ã€‚</p><h5 id="12-9-3-2-æ‰©å®¹çš„è§¦å‘æ¡ä»¶"><a href="#12-9-3-2-æ‰©å®¹çš„è§¦å‘æ¡ä»¶" class="headerlink" title="12.9.3.2 æ‰©å®¹çš„è§¦å‘æ¡ä»¶"></a>12.9.3.2 æ‰©å®¹çš„è§¦å‘æ¡ä»¶</h5><p>æ‰©å®¹æ£€æŸ¥ä¸»è¦å‘ç”Ÿåœ¨æ’å…¥å…ƒç´ (putVal())çš„è¿‡ç¨‹:</p><ul><li>ä¸€ä¸ªçº¿ç¨‹æ’å®Œå…ƒç´ å, æ£€æŸ¥tableä½¿ç”¨ç‡, è‹¥è¶…è¿‡é˜ˆå€¼, è°ƒç”¨transferè¿›è¡Œæ‰©å®¹</li><li>ä¸€ä¸ªçº¿ç¨‹æ’å…¥æ•°æ®æ—¶, å‘ç°tableå¯¹åº”å…ƒç´ çš„hash=MOVED, é‚£ä¹ˆè°ƒç”¨helpTransfer()ååŠ©æ‰©å®¹ã€‚</li></ul><h5 id="12-9-3-3-putæ–¹æ³•è¯¦è§£"><a href="#12-9-3-3-putæ–¹æ³•è¯¦è§£" class="headerlink" title="12.9.3.3 putæ–¹æ³•è¯¦è§£"></a>12.9.3.3 putæ–¹æ³•è¯¦è§£</h5><p>æºç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">        <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">            <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">                tab = initTable();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                             <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                    <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                V oldVal = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            binCount = <span class="number">1</span>;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                                K ek;</span><br><span class="line">                                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                    ((ek = e.key) == key ||</span><br><span class="line">                                     (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                    oldVal = e.val;</span><br><span class="line">                                    <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                        e.val = value;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                Node&lt;K,V&gt; pred = e;</span><br><span class="line">                                <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                              value, <span class="keyword">null</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            Node&lt;K,V&gt; p;</span><br><span class="line">                            binCount = <span class="number">2</span>;</span><br><span class="line">                            <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                           value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                oldVal = p.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    p.val = value;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                        treeifyBin(tab, i);</span><br><span class="line">                    <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> oldVal;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h6 id="1ã€åˆå§‹åŒ–hash-table"><a href="#1ã€åˆå§‹åŒ–hash-table" class="headerlink" title="1ã€åˆå§‹åŒ–hash table"></a>1ã€åˆå§‹åŒ–hash table</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">tab = initTable();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="comment">// ä¸ºä»€ä¹ˆè¿™é‡Œåˆå§‹åŒ–éœ€è¦whileå¾ªç¯</span></span><br><span class="line">        <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">                Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = tab = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tab;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>åˆå§‹åŒ–çš„æ—¶å€™å¯èƒ½æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶åœ¨åˆå§‹åŒ–ï¼Œä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¿™é‡Œä½¿ç”¨äº†while + cas æ¥ä¿è¯å¤šçº¿ç¨‹å®‰å…¨ã€‚</p></blockquote><p><code>U.compareAndSwapInt(this, SIZECTL, sc, -1)</code> ç›¸å½“äºè·å–çº¿ç¨‹æ‰§è¡Œæƒé™ã€‚åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åˆå§‹åŒ–ï¼Œæ²¡æœ‰æ‹¿åˆ°æ‰§è¡Œæƒé™çš„æ—¶å€™ä¸‹ä¸€æ¬¡å¾ªç¯çš„æ—¶å€™ä¼šåˆ¤æ–­</p><p><code>(tab = table) == null || tab.length == 0</code>. ä¸æ»¡è¶³æ¡ä»¶è‡ªç„¶å°±ä¸å†åˆå§‹åŒ–äº†ã€‚</p><h6 id="2ã€åˆ¤æ–­æ•°ç»„ä¸‹æ ‡çš„ä½ç½®æ˜¯å¦æ˜¯ç©ºçš„å€¼"><a href="#2ã€åˆ¤æ–­æ•°ç»„ä¸‹æ ‡çš„ä½ç½®æ˜¯å¦æ˜¯ç©ºçš„å€¼" class="headerlink" title="2ã€åˆ¤æ–­æ•°ç»„ä¸‹æ ‡çš„ä½ç½®æ˜¯å¦æ˜¯ç©ºçš„å€¼"></a>2ã€åˆ¤æ–­æ•°ç»„ä¸‹æ ‡çš„ä½ç½®æ˜¯å¦æ˜¯ç©ºçš„å€¼</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) </span><br></pre></td></tr></table></figure><p>å¦‚æœæ•°ç»„ä¸‹æ ‡çš„ä½ç½®æ˜¯nullï¼Œè¯´æ˜è¿˜æ²¡æœ‰å…ƒç´ ï¼Œåˆ™ä½¿ç”¨casæ¥å­˜å‚¨æ•°æ®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,<span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">    <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br></pre></td></tr></table></figure><h6 id="3ã€ä¸ºä»€ä¹ˆéœ€è¦caså‘¢ï¼Ÿ"><a href="#3ã€ä¸ºä»€ä¹ˆéœ€è¦caså‘¢ï¼Ÿ" class="headerlink" title="3ã€ä¸ºä»€ä¹ˆéœ€è¦caså‘¢ï¼Ÿ"></a>3ã€ä¸ºä»€ä¹ˆéœ€è¦caså‘¢ï¼Ÿ</h6><ul><li>ä¿è¯çº¿ç¨‹å®‰å…¨</li></ul><h6 id="4ã€ä¸ºä»€ä¹ˆputæ–¹æ³•ç¬¬5è¡Œéœ€è¦å¾ªç¯ï¼Ÿ"><a href="#4ã€ä¸ºä»€ä¹ˆputæ–¹æ³•ç¬¬5è¡Œéœ€è¦å¾ªç¯ï¼Ÿ" class="headerlink" title="4ã€ä¸ºä»€ä¹ˆputæ–¹æ³•ç¬¬5è¡Œéœ€è¦å¾ªç¯ï¼Ÿ"></a>4ã€ä¸ºä»€ä¹ˆputæ–¹æ³•ç¬¬5è¡Œéœ€è¦å¾ªç¯ï¼Ÿ</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (Node&lt;K,V&gt;[] tab = table;;) </span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªçº¿ç¨‹putä¸€ä¸ªæ•°æ®å’Œç¬¬äºŒä¸ªçº¿ç¨‹putçš„æ•°æ®å¦‚æœå‘ç”Ÿäº†å†²çªï¼Œåˆ™ç¬¬ä¸€æ¬¡å¾ªç¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¾ç½®æˆåŠŸï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åªèƒ½ç­‰åˆ°ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚</p><h6 id="5ã€å¦‚æœåœ¨ä¸è€ƒè™‘æ‰©å®¹çš„æƒ…å†µä¸‹å‘ç”Ÿhashå†²çªï¼Œç¬¬äºŒæ¬¡æ’å…¥çš„æ—¶å€™ä¼šæ€æ ·ï¼Ÿ"><a href="#5ã€å¦‚æœåœ¨ä¸è€ƒè™‘æ‰©å®¹çš„æƒ…å†µä¸‹å‘ç”Ÿhashå†²çªï¼Œç¬¬äºŒæ¬¡æ’å…¥çš„æ—¶å€™ä¼šæ€æ ·ï¼Ÿ" class="headerlink" title="5ã€å¦‚æœåœ¨ä¸è€ƒè™‘æ‰©å®¹çš„æƒ…å†µä¸‹å‘ç”Ÿhashå†²çªï¼Œç¬¬äºŒæ¬¡æ’å…¥çš„æ—¶å€™ä¼šæ€æ ·ï¼Ÿ"></a>5ã€å¦‚æœåœ¨ä¸è€ƒè™‘æ‰©å®¹çš„æƒ…å†µä¸‹å‘ç”Ÿhashå†²çªï¼Œç¬¬äºŒæ¬¡æ’å…¥çš„æ—¶å€™ä¼šæ€æ ·ï¼Ÿ</h6><ul><li>å¯¹æ•°ç»„ä¸Šçš„å…ƒç´ ä¹Ÿå°±æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹çš„å¯¹è±¡åŠ é” synchronized</li><li>æ„å»ºé“¾è¡¨</li><li><strong>å°¾éƒ¨</strong>æ’å…¥æ–°å…ƒç´ </li><li>å¦‚æœå·²ç»å­˜åœ¨çº¢é»‘æ ‘ï¼Œåˆ™ç»§ç»­æ·»åŠ æ ‘çš„ç»“ç‚¹</li></ul><h6 id="6ã€å¾€é“¾è¡¨ä¸Šæ·»åŠ æ•°æ®å¦‚æœä¸ä½¿ç”¨synchronizedä¼šæ€æ ·ï¼Ÿ"><a href="#6ã€å¾€é“¾è¡¨ä¸Šæ·»åŠ æ•°æ®å¦‚æœä¸ä½¿ç”¨synchronizedä¼šæ€æ ·ï¼Ÿ" class="headerlink" title="6ã€å¾€é“¾è¡¨ä¸Šæ·»åŠ æ•°æ®å¦‚æœä¸ä½¿ç”¨synchronizedä¼šæ€æ ·ï¼Ÿ"></a>6ã€å¾€é“¾è¡¨ä¸Šæ·»åŠ æ•°æ®å¦‚æœä¸ä½¿ç”¨synchronizedä¼šæ€æ ·ï¼Ÿ</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">    pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,value, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå‡ºç°æ·»åŠ çš„å€¼è¢«è¦†ç›–æ‰çš„æƒ…å†µï¼š</p><ul><li>çº¿ç¨‹ä¸€æ‰§è¡Œ pred.next = new Node&lt;K,V&gt;  [1,a]</li><li>çº¿ç¨‹äºŒæ‰§è¡Œ pred.next = new Node&lt;K,V&gt;  [2,b]</li></ul><p> æœ€å[1,a]ä¸¢å¤±äº†ã€‚</p><h6 id="7ã€å¦‚ä½•åˆ¤æ–­æ­£åœ¨æ‰©å®¹"><a href="#7ã€å¦‚ä½•åˆ¤æ–­æ­£åœ¨æ‰©å®¹" class="headerlink" title="7ã€å¦‚ä½•åˆ¤æ–­æ­£åœ¨æ‰©å®¹"></a>7ã€å¦‚ä½•åˆ¤æ–­æ­£åœ¨æ‰©å®¹</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hash for forwarding nodes</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hash for roots of trees</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                tab = helpTransfer(tab, f);</span><br></pre></td></tr></table></figure><p>f æŒ‡çš„æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹ã€‚</p><h6 id="8ã€å¦‚æœputçš„æ—¶å€™æ­£åœ¨æ‰©å®¹ä¼šæ€æ ·"><a href="#8ã€å¦‚æœputçš„æ—¶å€™æ­£åœ¨æ‰©å®¹ä¼šæ€æ ·" class="headerlink" title="8ã€å¦‚æœputçš„æ—¶å€™æ­£åœ¨æ‰©å®¹ä¼šæ€æ ·"></a>8ã€å¦‚æœputçš„æ—¶å€™æ­£åœ¨æ‰©å®¹ä¼šæ€æ ·</h6><ul><li><p>å½“å‰çº¿ç¨‹ä¼šå¸®å¿™å‚ä¸æ‰©å®¹ã€‚<code>helpTransfer(tab, f)</code></p></li><li><p>æœ€å°‘åˆ†é…16ä¸ªæ§½ä½è¿ç§»</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123; <span class="comment">//tableæ‰©å®¹</span></span><br><span class="line">        Node&lt;K,V&gt;[] nextTab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">            (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ® length å¾—åˆ°ä¸€ä¸ªæ ‡è¯†ç¬¦å·</span></span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(tab.length);</span><br><span class="line">            <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span><br><span class="line">                   (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;<span class="comment">//è¯´æ˜è¿˜åœ¨æ‰©å®¹</span></span><br><span class="line">                <span class="comment">//åˆ¤æ–­æ˜¯å¦æ ‡å¿—å‘ç”Ÿäº†å˜åŒ–||  æ‰©å®¹ç»“æŸäº†</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                     <span class="comment">//è¾¾åˆ°æœ€å¤§çš„å¸®åŠ©çº¿ç¨‹ ||  åˆ¤æ–­æ‰©å®¹è½¬ç§»ä¸‹æ ‡æ˜¯å¦åœ¨è°ƒæ•´ï¼ˆæ‰©å®¹ç»“æŸï¼‰</span></span><br><span class="line">                    sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// å°† sizeCtl + 1, ï¼ˆè¡¨ç¤ºå¢åŠ äº†ä¸€ä¸ªçº¿ç¨‹å¸®åŠ©å…¶æ‰©å®¹ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">                    transfer(tab, nextTab);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> nextTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦åšäº†å¦‚ä¸‹äº‹æƒ…:</p><ul><li><p>æ£€æŸ¥æ˜¯å¦æ‰©å®¹å®Œæˆ</p></li><li><p>å¯¹sizeCtrl = sizeCtrl+1, ç„¶åè°ƒç”¨transfer()è¿›è¡ŒçœŸæ­£çš„æ‰©å®¹ã€‚</p></li></ul><h6 id="9ã€æ‰©å®¹transfer"><a href="#9ã€æ‰©å®¹transfer" class="headerlink" title="9ã€æ‰©å®¹transfer"></a>9ã€<strong>æ‰©å®¹transfer</strong></h6><p>æ‰©å®¹çš„æ•´ä½“æ­¥éª¤å°±æ˜¯æ–°å»ºä¸€ä¸ªnextTab, sizeæ˜¯ä¹‹å‰çš„2å€, å°†tableä¸Šçš„éç©ºå…ƒç´ è¿ç§»åˆ°nextTabä¸Šé¢å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">       <span class="comment">// subdivide rangeï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å°‘è¿ç§»16ä¸ªæ§½ä½ï¼Œå¤§çš„è¯ï¼Œæœ€å¤š</span></span><br><span class="line">        stride = MIN_TRANSFER_STRIDE;</span><br><span class="line">    <span class="comment">// initiating  æ‰å¼€å§‹åˆå§‹åŒ–æ–°çš„nextTab</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];  <span class="comment">//æ‰©å®¹2å€</span></span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        transferIndex = n;<span class="comment">//æ›´æ–°çš„è½¬ç§»ä¸‹æ ‡ï¼Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="comment">//æ˜¯å¦èƒ½å¤Ÿå‘å‰æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ</span></span><br><span class="line">    <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// to ensure sweep before committing nextTabï¼Œå®ŒæˆçŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç»“æŸæ­¤æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">        <span class="keyword">while</span> (advance) &#123; <span class="comment">//å–ä¸‹ä¸€ä¸ªå‘¨æœŸ</span></span><br><span class="line">            <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="comment">//æœ¬çº¿ç¨‹å¤„ç†çš„åŒºé—´èŒƒå›´ä¸º[bound, i),èŒƒå›´è¿˜æ²¡æœ‰å¤„ç†å®Œæˆï¼Œé‚£ä¹ˆå°±ç»§ç»­å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//ç›®å‰å¤„ç†åˆ°äº†è¿™é‡Œï¼ˆä»å¤§åˆ°å°ï¼Œ ä¸‹çº¿ï¼‰ï¼Œå¼€å§‹æ‰¾æ–°çš„ä¸€è½®çš„åŒºé—´</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¿™ä¸ªæ¡ä»¶æ”¹å˜çš„æ˜¯transferIndexçš„å€¼ï¼Œä»16å˜æˆäº†1</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                     (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                     <span class="comment">//nextBound æ˜¯è¿™æ¬¡è¿ç§»ä»»åŠ¡çš„è¾¹ç•Œï¼Œæ³¨æ„ï¼Œæ˜¯ä»åå¾€å‰</span></span><br><span class="line">                      nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                   nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                bound = nextBound; <span class="comment">//ä¸€å—åŒºé—´æœ€å°æ¡¶çš„ä¸‹æ ‡</span></span><br><span class="line">                i = nextIndex - <span class="number">1</span>; <span class="comment">//èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§æ¡¶çš„ä¸‹æ ‡</span></span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123; <span class="comment">//æ¯ä¸ªè¿ç§»çº¿ç¨‹éƒ½èƒ½è¾¾åˆ°è¿™é‡Œ</span></span><br><span class="line">            <span class="keyword">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123; <span class="comment">//è¿ç§»å®Œæˆ</span></span><br><span class="line">                nextTable = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//ç›´æ¥æŠŠä»¥å‰çš„tableä¸¢å¼ƒäº†ï¼Œä¸Šé¢çš„MOVEç­‰æ ‡å¿—å…¨éƒ¨ä¸¢å¼ƒï¼Œä½¿ç”¨æ–°çš„</span></span><br><span class="line">                table = nextTab;</span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>); <span class="comment">//æ‰©å¤§2n-0.5n = 1.50n, æ›´æ–°æ–°çš„å®¹é‡é˜ˆå€¼</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è¡¨ç¤ºå½“å‰çº¿ç¨‹è¿ç§»å®Œæˆäº†</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                 <span class="comment">//æ³¨æ„æ­¤æ—¶scçš„å€¼å¹¶ä¸ç­‰äºsizeCtlï¼Œä¸Šä¸€æ­¥ï¼ŒsizeCtl=sizeCtl-1äº†ã€‚è¿™ä¸¤ä¸ªå¯¹è±¡è¿˜æ˜¯åˆ†å‰²çš„</span></span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœå¯¹åº”ä½ç½®ä¸ºnullï¼Œ åˆ™å°†ForwardingNodeæ”¾åœ¨å¯¹åº”çš„åœ°æ–¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED) <span class="comment">//åˆ«çš„çº¿ç¨‹å·²ç»åœ¨å¤„ç†äº†ï¼Œå†æ¨è¿›ä¸€ä¸ªä¸‹æ ‡</span></span><br><span class="line">            advance = <span class="keyword">true</span>; <span class="comment">// already processedï¼Œæ¨åŠ¨åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸï¼Œä»ç„¶ä¼šæ£€æŸ¥iä¸boundæ˜¯å¦ç»“æŸ</span></span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">//è¯´æ˜ä½ç½®ä¸Šæœ‰å€¼äº†ï¼Œ</span></span><br><span class="line">            <span class="comment">//éœ€è¦åŠ é”ï¼Œé˜²æ­¢å†å‘é‡Œé¢æ”¾å€¼ï¼Œåœ¨æ”¾æ•°æ®æ—¶ï¼Œä¹Ÿä¼šé”ä½ã€‚æ¯”å¦‚æ•´ä¸ªtableæ­£åœ¨è¿ç§»ï¼Œè¿˜æ²¡æœ‰è¿ç§»åˆ°è¿™ä¸ªå…ƒç´ ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å‘è¿™ä¸ªèŠ‚ç‚¹æ’å…¥æ•°æ®ï¼Œæ­¤æ—¶è¿ç§»åˆ°è¿™é‡Œäº†ï¼Œä¼šè¢«é˜»å¡ä½</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;<span class="comment">//åˆ¤æ–­iä¸‹æ ‡å’Œfæ˜¯å¦ç›¸åŒ</span></span><br><span class="line">                    Node&lt;K,V&gt; ln, hn; <span class="comment">//é«˜ä½æ¡¶ï¼Œ åœ°ä½æ¡¶</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> runBit = fh &amp; n;<span class="comment">//nä¸º2^n, å–ä½™ååªèƒ½æ˜¯2^n</span></span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="comment">///æ‰¾åˆ°æœ€åä¸€ä¸ªä¸å’Œfnç›¸åŒçš„èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                            <span class="comment">//åªè¦æ‰¾åˆ°è¿™ï¼Œä¹‹åçš„å–å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸‹æ¬¡å¾ªç¯æ—¶ï¼Œå°±ä¸ç”¨å†å¾ªç¯åé¢çš„</span></span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123; <span class="comment">//æ¯”å¦‚1ï¼Œ16ï¼Œ32,å¦‚æœä½ä½%16ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯0ã€‚</span></span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                 <span class="comment">//è¿™æ ·å°±æŠŠç›¸åŒä¸²çš„ç»™ä¸²èµ·æ¥äº†</span></span><br><span class="line">                                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                <span class="comment">//è¿™æ ·å°±æŠŠç›¸åŒä¸²çš„ç»™ä¸²èµ·æ¥äº†ï¼Œæ³¨æ„è¿™é‡Œlnç”¨æ³•ï¼Œç¬¬ä¸€ä¸ªnextä¸ºnullï¼Œçƒ¦ç€ä¸²èµ·æ¥äº†ã€‚</span></span><br><span class="line">                                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTabAt(nextTab, i, ln); <span class="comment">//åç€ç»™ä¸²èµ·æ¥äº†</span></span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;<span class="comment">// å¦‚æœæ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>; <span class="comment">//ä¹Ÿæ˜¯é«˜ä½èŠ‚ç‚¹</span></span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;<span class="comment">//ä¹Ÿæ˜¯é«˜ä½èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123; <span class="comment">//ä¸­åºéå†çº¢é»‘æ ‘</span></span><br><span class="line">                            <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123; <span class="comment">//0çš„æ”¾ä½ä½</span></span><br><span class="line">                                <span class="comment">//æ³¨æ„è¿™é‡Œp.prev = loTailï¼Œæ¯ä¸€ä¸ªpéƒ½æ˜¯ä¸‹ä¸€ä¸ªçš„prev</span></span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    lo = p; <span class="comment">//æŠŠå¤´è®°ä½</span></span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = p;  <span class="comment">//ä¸Šä¸€æ¬¡çš„pçš„nextæ˜¯è¿™æ¬¡çš„p</span></span><br><span class="line">                                loTail = p; <span class="comment">//æŠŠä¸Šæ¬¡pç»™è®°ä½</span></span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123; <span class="comment">//é«˜ä½</span></span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    hi = p; <span class="comment">//æŠŠå°¾è®°ä½</span></span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :<span class="comment">// //åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬åŒ–ä¸ºæ ‘</span></span><br><span class="line">                            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t; <span class="comment">//å¦‚æœæ²¡æœ‰é«˜ä½çš„è¯ï¼Œåˆ™éƒ¨åˆ†ä¸ºä¸¤ä¸ªæ ‘</span></span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸¤ä¸ªå˜é‡éœ€è¦äº†è§£ä¸‹:</p><ul><li>advance: è¡¨ç¤ºæ˜¯å¦å¯ä»¥å‘ä¸‹ä¸€ä¸ªè½®å…ƒç´ è¿›è¡Œè¿ç§»ã€‚</li><li>finishing: tableæ‰€æœ‰å…ƒç´ æ˜¯å¦è¿ç§»å®Œæˆã€‚</li></ul><p>å¤§è‡´åšäº†å¦‚ä¸‹äº‹æƒ…:</p><ul><li>ç¡®å®šçº¿ç¨‹æ¯è½®è¿ç§»å…ƒç´ çš„ä¸ªæ•°stride, æ¯”å¦‚è¿›æ¥ä¸€ä¸ªçº¿ç¨‹, ç¡®å®šæ‰©å®¹tableä¸‹æ ‡ä¸º(a,b]ä¹‹é—´å…ƒç´ , ä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰©å®¹(b,c]ã€‚è¿™é‡Œå¯¹b-aæˆ–è€…c-bä¹Ÿæ˜¯ç”±æœ€å°å€¼16é™åˆ¶çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹æœ€å°‘æ‰©å®¹è¿ç»­16ä¸ªtableçš„å…ƒç´ ã€‚è€Œæ ‡å¿—å½“å‰è¿ç§»çš„ä¸‹æ ‡ä¿å­˜åœ¨transferIndexé‡Œé¢ã€‚</li><li>æ£€æŸ¥nextTabæ˜¯å¦å®Œæˆåˆå§‹åŒ–, è‹¥æ²¡æœ‰çš„è¯, è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªè¿ç§»çš„çº¿ç¨‹, å…ˆåˆå§‹åŒ–nextTab, sizeæ˜¯ä¹‹å‰tableçš„2å€ã€‚</li><li>è¿›å…¥whileå¾ªç¯æŸ¥æ‰¾æœ¬è½®è¿ç§»çš„tableä¸‹æ ‡å…ƒç´ åŒºé—´, ä¿å­˜åœ¨(bound, i]ä¸­, æ³¨æ„è¿™é‡Œæ˜¯åŠå¼€åŠé—­åŒºé—´ã€‚</li><li>ä»i -&gt; boundå¼€å§‹éå†tableä¸­æ¯ä¸ªå…ƒç´ , è¿™é‡Œæ˜¯ä»å¤§åˆ°å°éå†çš„:</li></ul><ol><li>è‹¥è¯¥å…ƒç´ ä¸ºç©º, åˆ™å‘è¯¥å…ƒç´ æ ‡å†™å…¥ForwardingNode, ç„¶åæ£€æŸ¥ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ å½“åˆ«çš„çº¿ç¨‹å‘è¿™ä¸ªå…ƒç´ æ’å…¥æ•°æ®æ—¶, æ ¹æ®è¿™ä¸ªæ ‡å¿—ç¬¦çŸ¥é“äº†tableæ­£åœ¨è¢«åˆ«çš„çº¿ç¨‹è¿ç§», åœ¨putValä¸­å°±ä¼šè°ƒç”¨helpTransferå¸®ç€è¿ç§»ã€‚</li><li>è‹¥è¯¥å…ƒç´ çš„hash=MOVED, ä»£è¡¨æ¬¡tableæ­£åœ¨å¤„äºè¿ç§»ä¹‹ä¸­, è·³è¿‡ã€‚ æŒ‰é“ç†ä¸ä¼šè·‘ç€è¿™é‡Œçš„ã€‚</li><li>å¦åˆ™è¯´æ˜è¯¥å…ƒç´ è·Ÿç€çš„æ˜¯ä¸€ä¸ªé“¾è¡¨æˆ–è€…æ˜¯ä¸ªçº¢é»‘æ ‘ç»“æ„, è‹¥hash&gt;0, åˆ™è¯´æ˜æ˜¯ä¸ªé“¾è¡¨, è‹¥f instanceof TreeBin, åˆ™è¯´æ˜æ˜¯ä¸ªçº¢é»‘æ ‘ç»“æ„ã€‚</li></ol><ul><li>é“¾è¡¨è¿ç§»åŸç†å¦‚ä¸‹: éå†é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹ã€‚ è‹¥èŠ‚ç‚¹çš„f.hash&amp;n==0æˆç«‹, åˆ™å°†èŠ‚ç‚¹æ”¾åœ¨i, å¦åˆ™, åˆ™å°†èŠ‚ç‚¹æ”¾åœ¨n+iä¸Šé¢ã€‚</li></ul><p>â€‹    è¿ç§»å‰, å¯¹è¯¥å…ƒç´ è¿›è¡ŒåŠ é”ã€‚ éå†é“¾è¡¨æ—¶, è¿™é‡Œä½¿ç”¨lastRunå˜é‡, ä¿ç•™çš„æ˜¯ä¸Šæ¬¡hashçš„å€¼, å‡å¦‚æ•´ä¸ªé“¾è¡¨å…¨éƒ¨èŠ‚ç‚¹f.hash&amp;n==0, é‚£ä¹ˆç¬¬äºŒæ¬¡éå†, åªè¦æ‰¾åˆ°lastRunçš„å€¼, é‚£ä¹ˆè®¤ä¸ºä¹‹åçš„èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒå€¼, å‡å°‘äº†ä¸å¿…è¦çš„f.hash&amp;nå–å€¼ã€‚éå†å®Œæ‰€æœ‰çš„èŠ‚ç‚¹å, æ­¤æ—¶å½¢æˆäº†ä¸¤æ¡é“¾è¡¨, lnå­˜æ”¾çš„æ˜¯f.hash&amp;n=0çš„èŠ‚ç‚¹, hnå­˜æ”¾çš„æ˜¯é0çš„èŠ‚ç‚¹, ç„¶åå°†lnå­˜æ”¾åœ¨nextTableç¬¬iå…ƒç´ çš„ä½ç½®, n+iå­˜æ”¾åœ¨n+içš„ä½ç½®ã€‚</p><p>è“è‰²èŠ‚ç‚¹ä»£è¡¨:f.hash&amp;n==0, ç»¿è‰²èŠ‚ç‚¹ä»£è¡¨f.hash&amp;n!=0ã€‚ æœ€ç»ˆè“è‰²çš„èŠ‚ç‚¹ä»åœ¨å­˜æ”¾åœ¨(0, n)èŒƒå›´é‡Œ, ç»¿çš„èŠ‚ç‚¹å­˜æ”¾åœ¨(n, 2n-1)çš„èŒƒå›´ä¹‹å†…ã€‚</p><ul><li>è¿ç§»é“¾è¡¨å’Œçº¢é»‘æ ‘çš„åŸç†æ˜¯ä¸€æ ·çš„, åœ¨çº¢é»‘æ ‘ä¸­, æˆ‘ä»¬è®°å½•äº†æ¯ä¸ªçº¢é»‘æ ‘çš„first(è¿™ä¸ªèŠ‚ç‚¹ä¸æ˜¯hashæœ€å°çš„èŠ‚ç‚¹)å’Œæ¯ä¸ªèŠ‚ç‚¹çš„next, æ ¹æ®è¿™ä¸¤ä¸ªå…ƒç´ , æˆ‘ä»¬å¯ä»¥è®¿é—®çº¢é»‘æ ‘æ‰€æœ‰çš„å…ƒç´ , çº¢é»‘æ ‘æ­¤æ—¶ä¹Ÿæ˜¯ä¸€ä¸ªé“¾è¡¨, çº¢é»‘æ ‘å’Œé“¾è¡¨è¿ç§»çš„è¿‡ç¨‹ä¸€æ ·ã€‚çº¢é»‘æ ‘æ ¹æ®è¿ç§»åæ‹†åˆ†æˆäº†hnå’Œln, æ ¹æ®é“¾è¡¨é•¿åº¦ç¡®å®šé“¾è¡¨æ˜¯çº¢é»‘æ ‘ç»“æ„è¿˜æ˜¯é€€åŒ–ä¸ºäº†é“¾è¡¨ã€‚</li></ul><h6 id="10ã€å¦‚ä½•ç¡®å®štableæ‰€æœ‰å…ƒç´ è¿ç§»å®Œæˆ"><a href="#10ã€å¦‚ä½•ç¡®å®štableæ‰€æœ‰å…ƒç´ è¿ç§»å®Œæˆ" class="headerlink" title="10ã€å¦‚ä½•ç¡®å®štableæ‰€æœ‰å…ƒç´ è¿ç§»å®Œæˆ"></a>10ã€å¦‚ä½•ç¡®å®štableæ‰€æœ‰å…ƒç´ è¿ç§»å®Œæˆ</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¡¨ç¤ºå½“å‰çº¿ç¨‹è¿ç§»å®Œæˆäº†</span></span><br><span class="line"><span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">     <span class="comment">//æ³¨æ„æ­¤æ—¶scçš„å€¼å¹¶ä¸ç­‰äºsizeCtlï¼Œä¸Šä¸€æ­¥ï¼ŒsizeCtl=sizeCtl-1äº†ã€‚è¿™ä¸¤ä¸ªå¯¹è±¡è¿˜æ˜¯åˆ†å‰²çš„</span></span><br><span class="line">    <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">    i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªçº¿ç¨‹å¼€å§‹è¿ç§»æ—¶, è®¾ç½®äº†sizeCtl= resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT+2, æ­¤åæ¯ä¸ªæ–°æ¥å¸®åŠ©è¿ç§»çš„çº¿ç¨‹éƒ½ä¼šsizeCtl=sizeCtl+1, å®Œæˆè¿ç§»å,sizeCtl-1, é‚£ä¹ˆåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹è¿˜å¤„äºè¿ç§»çŠ¶æ€, é‚£ä¹ˆsizeCtl&gt; resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT+2ä¸€ç›´æˆç«‹, å½“åªæœ‰æœ€åä¸€ä¸ªçº¿ç¨‹å®Œæˆè¿ç§»ä¹‹å, ç­‰å¼ä¸¤è¾¹æ‰æˆç«‹ã€‚ å¯èƒ½å¤§å®¶ä¼šæœ‰ç–‘é—®, ç¬¬ä¸€ä¸ªçº¿ç¨‹å¹¶æ²¡æœ‰å¯¹sizeCtl=sizeCtl+1, æ­¤æ—¶å®Œæˆåå†å‡ä¸€, é‚£ä¸æ˜¯ä¸ç›¸ç­‰äº†å—, æ³¨æ„è¿™é‡Œ, sizeCtlåœ¨å‡ä¸€å‰, å°†å€¼èµ‹ç»™äº†sc, ç­‰å¼æ¯”è¾ƒçš„æ˜¯scã€‚</p><p><strong>æ€»ç»“</strong></p><p>tableæ‰©å®¹è¿‡ç¨‹å°±æ˜¯å°†tableå…ƒç´ è¿ç§»åˆ°æ–°çš„tableä¸Š, åœ¨å…ƒç´ è¿ç§»æ—¶, å¯ä»¥å¹¶å‘å®Œæˆ, åŠ å¿«äº†è¿ç§»é€Ÿåº¦, åŒæ—¶ä¸è‡³äºé˜»å¡çº¿ç¨‹ã€‚æ‰€æœ‰å…ƒç´ è¿ç§»å®Œæˆå, æ—§çš„tableç›´æ¥ä¸¢å¤±, ç›´æ¥ä½¿ç”¨æ–°çš„tableã€‚</p><h2 id="13-å¹¶å‘å®¹å™¨ä¹‹CopyOnWriteArrayList"><a href="#13-å¹¶å‘å®¹å™¨ä¹‹CopyOnWriteArrayList" class="headerlink" title="13. å¹¶å‘å®¹å™¨ä¹‹CopyOnWriteArrayList"></a>13. å¹¶å‘å®¹å™¨ä¹‹CopyOnWriteArrayList</h2><h3 id="13-1-ä»€ä¹ˆæ˜¯fail-fastæœºåˆ¶"><a href="#13-1-ä»€ä¹ˆæ˜¯fail-fastæœºåˆ¶" class="headerlink" title="13.1 ä»€ä¹ˆæ˜¯fail-fastæœºåˆ¶"></a>13.1 ä»€ä¹ˆæ˜¯fail-fastæœºåˆ¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;pool-1-thread-11&quot;</span> java.util.ConcurrentModificationException</span><br><span class="line">at java.util.ArrayList$Itr.checkForComodification(ArrayList.java:<span class="number">909</span>)</span><br><span class="line">at java.util.ArrayList$Itr.next(ArrayList.java:<span class="number">859</span>)</span><br><span class="line">at com.yg.edu.list.CopyOnWriteArrayListRunner$ReadTask.run(CopyOnWriteArrayListRunner.java:<span class="number">30</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br></pre></td></tr></table></figure><h3 id="13-2-CopyOnWriteArrayListè®¾è®¡æ€è·¯"><a href="#13-2-CopyOnWriteArrayListè®¾è®¡æ€è·¯" class="headerlink" title="13.2 CopyOnWriteArrayListè®¾è®¡æ€è·¯"></a>13.2 CopyOnWriteArrayListè®¾è®¡æ€è·¯</h3><p>çŒœæƒ³ ReentrantReadWriteLock æ˜¯å¦å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿ</p><ul><li>è¯»æ“ä½œåŠ è¯»é”</li><li>å†™æ“ä½œåŠ å†™é”</li></ul><p>é€‚ç”¨äºè¯»å†™éƒ½æ¯”ä»·å¤šçš„åœºæ™¯ã€‚</p><p>ä½†æ˜¯å¦‚æœè¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹å‘¢ï¼Ÿæœ‰æ²¡æœ‰ä¼˜åŒ–æ–¹æ¡ˆï¼Ÿ</p><p><strong>æ ¸å¿ƒæ€æƒ³ï¼šè¯»å†™åˆ†ç¦»ï¼Œç©ºé—´æ¢æ—¶é—´ï¼Œé¿å…ä¸ºä¿è¯å¹¶å‘å®‰å…¨å¯¼è‡´çš„æ¿€çƒˆçš„é”ç«äº‰ã€‚</strong></p><p>åˆ’å…³é”®ç‚¹ï¼š</p><p>1ã€CopyOnWriteé€‚ç”¨äºè¯»å¤šå†™å°‘çš„æƒ…å†µï¼Œæœ€å¤§ç¨‹åº¦çš„æé«˜è¯»çš„æ•ˆç‡ï¼›</p><p>2ã€CopyOnWriteæ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œåœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼ŒåŸæœ‰çš„è¯»çš„æ•°æ®æ˜¯ä¸ä¼šå‘ç”Ÿæ›´æ–°çš„ï¼Œåªæœ‰æ–°çš„è¯»æ‰èƒ½è¯»åˆ°æœ€æ–°æ•°æ®ï¼›</p><p>3ã€å¦‚ä½•ä½¿å…¶ä»–çº¿ç¨‹èƒ½å¤ŸåŠæ—¶è¯»åˆ°æ–°çš„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨volatileå˜é‡ï¼›</p><p>4ã€å†™çš„æ—¶å€™ä¸èƒ½å¹¶å‘å†™ï¼Œéœ€è¦å¯¹å†™æ“ä½œè¿›è¡ŒåŠ é”ï¼›</p><h3 id="13-3-addæ–¹æ³•æºç "><a href="#13-3-addæ–¹æ³•æºç " class="headerlink" title="13.3 addæ–¹æ³•æºç "></a>13.3 addæ–¹æ³•æºç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Appends the specified element to the end of this list.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> e element to be appended to this list</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; (as specified by &#123;<span class="doctag">@link</span> Collection#add&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>final ReentrantLock lock = this.lock;  </code> ä¿è¯ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œaddã€‚</p><h3 id="13-4-ä½¿ç”¨åœºæ™¯"><a href="#13-4-ä½¿ç”¨åœºæ™¯" class="headerlink" title="13.4 ä½¿ç”¨åœºæ™¯"></a>13.4 ä½¿ç”¨åœºæ™¯</h3><ul><li>é€‚åˆè¯»å¤šå†™å°‘çš„æƒ…å†µã€‚ æ€è·¯å°±æ˜¯ç©ºé—´æ¢æ—¶é—´ã€‚</li><li>ä¼šé€ æˆä¸€è‡´æ€§é—®é¢˜ï¼Œåªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¯èƒ½ä¼šè¯»åˆ°è„æ•°æ®ã€‚</li></ul><h3 id="13-5-CopyOnWriteArraySet-åº•å±‚"><a href="#13-5-CopyOnWriteArraySet-åº•å±‚" class="headerlink" title="13.5 CopyOnWriteArraySet åº•å±‚"></a>13.5 CopyOnWriteArraySet åº•å±‚</h3><p>åº•å±‚åŸºäºCopyOnWriteArrayListå®ç°çš„</p><h3 id="13-6-ConcurrentSkipListMap"><a href="#13-6-ConcurrentSkipListMap" class="headerlink" title="13.6 ConcurrentSkipListMap"></a>13.6 ConcurrentSkipListMap</h3><p>è·³è¡¨ï¼š</p><p><img src="https://oscimg.oschina.net/oscnet/up-0612b400df82bb1c43bf84edffab38e09f3.png"></p><ul><li>ä¿è¯keyçš„é¡ºåº</li><li>åº•å±‚æ•°æ®ç»“æ„åŸºäºé“¾è¡¨</li><li>æ—¶é—´å¤æ‚åº¦O(logn)</li><li>ç©ºé—´æ¢æ—¶é—´</li></ul><h2 id="14-Executorçº¿ç¨‹æ± åŸç†è§£è¯»"><a href="#14-Executorçº¿ç¨‹æ± åŸç†è§£è¯»" class="headerlink" title="14. Executorçº¿ç¨‹æ± åŸç†è§£è¯»"></a>14. Executorçº¿ç¨‹æ± åŸç†è§£è¯»</h2><h3 id="14-1-ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ"><a href="#14-1-ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ" class="headerlink" title="14.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ"></a>14.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ</h3><p>çº¿ç¨‹æ˜¯è°ƒåº¦CPUèµ„æºçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ¨¡å‹åˆ†ä¸ºKLTæ¨¡å‹ä¸ULTæ¨¡å‹ï¼ˆè¿™ä¸ªåœ¨ç¬¬ä¸€éƒ¨åˆ†å·²ç»ä»‹ç»è¿‡ï¼‰ï¼Œ<strong>JVMä½¿ç”¨çš„KLTæ¨¡å‹</strong>ï¼Œ<font color=red>Javaçº¿ç¨‹ä¸OSçº¿ç¨‹ä¿æŒ1:1çš„æ˜ å°„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰ä¸€ä¸ªjavaçº¿ç¨‹ä¹Ÿä¼šåœ¨æ“ä½œç³»ç»Ÿé‡Œæœ‰ä¸€ä¸ªå¯¹åº”çš„çº¿ç¨‹ã€‚</font></p><p>è¿›ç¨‹æ˜¯ç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ã€‚</p><h3 id="14-2-javaçº¿ç¨‹ä¸­çš„çŠ¶æ€"><a href="#14-2-javaçº¿ç¨‹ä¸­çš„çŠ¶æ€" class="headerlink" title="14.2 javaçº¿ç¨‹ä¸­çš„çŠ¶æ€"></a>14.2 javaçº¿ç¨‹ä¸­çš„çŠ¶æ€</h3><p>Javaçº¿ç¨‹æœ‰å¤šç§ç”Ÿå‘½çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NEW,æ–°å»º</span><br><span class="line">RUNNABLE,è¿è¡Œ</span><br><span class="line">BLOCKED,é˜»å¡</span><br><span class="line">WAITING,ç­‰å¾…</span><br><span class="line">TIMED_WAITING,è¶…æ—¶ç­‰å¾…</span><br><span class="line">TERMINATEDï¼Œç»ˆç»“</span><br></pre></td></tr></table></figure><h3 id="14-3-ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ"><a href="#14-3-ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="14.3 ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ"></a>14.3 ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ï¼Ÿ</h3><p>åˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹éœ€è¦CPUè¿›è¡Œç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œå› ä¸ºä¸Šé¢æåˆ°è¿‡ï¼Œjavaçš„çº¿ç¨‹æ¨¡å‹æ˜¯JLTæ¨¡å‹ã€‚æ¯åˆ›å»ºä¸€ä¸ªjavaçº¿ç¨‹ï¼Œåœ¨åº•å±‚æ“ä½œç³»ç»Ÿä¹Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªç³»ç»Ÿçº§åˆ«çš„çº¿ç¨‹ï¼Œæœ‰æ“ä½œç³»ç»Ÿç®¡ç†ã€‚</p><img src="https://oscimg.oschina.net/oscnet/up-2f02154dba45685e2fc0853b060925897be.png" style="zoom:50%;" /><p>â€œçº¿ç¨‹æ± â€ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ï¼Œçº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœè¢«æ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œå› æ­¤Javaä¸­æä¾›çº¿ç¨‹æ± å¯¹çº¿ç¨‹è¿›è¡Œç»Ÿä¸€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§</p><p><strong>çº¿ç¨‹æ± ä»‹ç»</strong></p><p>åœ¨webå¼€å‘ä¸­ï¼ŒæœåŠ¡å™¨éœ€è¦æ¥å—å¹¶å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥ä¼šä¸ºä¸€ä¸ªè¯·æ±‚æ¥åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œå¤„ç†ã€‚å¦‚æœæ¯æ¬¡è¯·æ±‚éƒ½æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„è¯å®ç°èµ·æ¥éå¸¸ç®€ä¾¿ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼š</p><p><strong>å¦‚æœå¹¶å‘çš„è¯·æ±‚æ•°é‡éå¸¸å¤šï¼Œä½†æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´å¾ˆçŸ­ï¼Œè¿™æ ·å°±ä¼šé¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œå¦‚æ­¤ä¸€æ¥ä¼šå¤§å¤§é™ä½ç³»ç»Ÿçš„æ•ˆç‡ã€‚å¯èƒ½å‡ºç°æœåŠ¡å™¨åœ¨ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°çº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹ä¸ŠèŠ±è´¹çš„æ—¶é—´å’Œæ¶ˆè€—çš„ç³»ç»Ÿèµ„æºè¦æ¯”å¤„ç†å®é™…çš„ç”¨æˆ·è¯·æ±‚çš„æ—¶é—´å’Œèµ„æºæ›´å¤šã€‚</strong></p><p>é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ä½¿æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸è¢«é”€æ¯ï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–çš„ä»»åŠ¡å‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯çº¿ç¨‹æ± çš„ç›®çš„äº†ã€‚çº¿ç¨‹æ± ä¸ºçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„å¼€é”€å’Œèµ„æºä¸è¶³é—®é¢˜æä¾›äº†è§£å†³æ–¹æ¡ˆã€‚<strong>é€šè¿‡å¯¹å¤šä¸ªä»»åŠ¡é‡ç”¨çº¿ç¨‹ï¼Œçº¿ç¨‹åˆ›å»ºçš„å¼€é”€è¢«åˆ†æ‘Šåˆ°äº†å¤šä¸ªä»»åŠ¡ä¸Šã€‚</strong></p><h3 id="14-4-ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ"><a href="#14-4-ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ" class="headerlink" title="14.4 ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ"></a>14.4 ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ</h3><ul><li>å•ä¸ªä»»åŠ¡å¤„ç†æ—¶é—´æ¯”è¾ƒçŸ­</li><li>éœ€è¦å¤„ç†çš„ä»»åŠ¡æ•°é‡å¾ˆå¤§</li></ul><h3 id="14-5-çº¿ç¨‹æ± ä¼˜åŠ¿"><a href="#14-5-çº¿ç¨‹æ± ä¼˜åŠ¿" class="headerlink" title="14.5 çº¿ç¨‹æ± ä¼˜åŠ¿"></a>14.5 çº¿ç¨‹æ± ä¼˜åŠ¿</h3><ul><li>é‡ç”¨å­˜åœ¨çš„çº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºï¼Œæ¶ˆäº¡çš„å¼€é”€ï¼Œæé«˜æ€§èƒ½</li><li>æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚</li><li>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚</li></ul><h3 id="14-6-çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#14-6-çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="14.6 çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></a>14.6 çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3><img src="https://oscimg.oschina.net/oscnet/up-14b67eef074413b1b085b17cd32d0c4cff9.png" style="zoom:50%;" /><blockquote><p>ç­‰å¾…çŠ¶æ€ è¶…æ—¶ç­‰å¾…çŠ¶æ€ é˜»å¡çŠ¶æ€éƒ½ä¼šæ¶‰åŠåˆ°ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼</p></blockquote><h3 id="14-7-ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ"><a href="#14-7-ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ" class="headerlink" title="14.7 ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ"></a>14.7 ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ</h3><p>åç¨‹    (çº¤ç¨‹ï¼Œç”¨æˆ·çº§çº¿ç¨‹)ï¼Œç›®çš„æ˜¯ä¸ºäº†è¿½æ±‚æœ€å¤§åŠ›åº¦çš„å‘æŒ¥ç¡¬ä»¶æ€§èƒ½å’Œæå‡è½¯ä»¶çš„é€Ÿåº¦ï¼Œåç¨‹åŸºæœ¬åŸç†æ˜¯:åœ¨æŸä¸ªç‚¹æŒ‚èµ·å½“å‰çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¿å­˜æ ˆä¿¡æ¯ï¼Œå»æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡ï¼›ç­‰å®Œæˆæˆ–è¾¾åˆ°æŸä¸ªæ¡ä»¶æ—¶ï¼Œå†è¿˜åŸåŸæ¥çš„æ ˆä¿¡æ¯å¹¶ç»§ç»­æ‰§è¡Œ(æ•´ä¸ªè¿‡ç¨‹çº¿ç¨‹ä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢)ã€‚</p><blockquote><p> JavaåŸç”Ÿä¸æ”¯æŒåç¨‹ï¼Œåœ¨çº¯javaä»£ç é‡Œéœ€è¦ä½¿ç”¨åç¨‹çš„è¯éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹åŒ…,å¦‚ï¼šquasar</p></blockquote><ul><li>åªèƒ½åœ¨CPUçš„ä¸€ä¸ªæ ¸ä¸Šå·¥ä½œ</li><li>æŠŠçº¿ç¨‹åˆ†æˆè‹¥å¹²ä¸ª â€œå•å…ƒâ€ï¼Œä¹Ÿå°±æ˜¯åç¨‹ï¼Œåç¨‹ä¹‹é—´åˆ‡æ¢ä¸éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢</li><li>CPUå¤§éƒ¨åˆ†æ—¶é—´å¤„äºç©ºé—²ï¼Œä½¿ç”¨åç¨‹ç”¨æ¥æé«˜CPUåˆ©ç”¨ç‡</li></ul><h3 id="14-8-Excutoræ¡†æ¶"><a href="#14-8-Excutoræ¡†æ¶" class="headerlink" title="14.8 Excutoræ¡†æ¶"></a>14.8 Excutoræ¡†æ¶</h3><h4 id="14-8-1-Excutoræ¡†æ¶ç¤ºæ„å›¾"><a href="#14-8-1-Excutoræ¡†æ¶ç¤ºæ„å›¾" class="headerlink" title="14.8.1 Excutoræ¡†æ¶ç¤ºæ„å›¾"></a>14.8.1 <strong>Excutoræ¡†æ¶ç¤ºæ„å›¾</strong></h4><p><img src="https://oscimg.oschina.net/oscnet/up-ed874d9d3ada0cd7e36191cf9a5ac3efc82.png"></p><blockquote><p>æˆ‘ä»¬ç»å¸¸ç”¨åˆ°çš„æ˜¯ThreadPoolExecutor</p></blockquote><h4 id="14-8-2-é‡è¦çš„API"><a href="#14-8-2-é‡è¦çš„API" class="headerlink" title="14.8.2 é‡è¦çš„API"></a>14.8.2 é‡è¦çš„API</h4><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºExecutorä¸‹æœ‰ä¸€ä¸ªé‡è¦å­æ¥å£ExecutorServiceï¼Œå…¶ä¸­å®šä¹‰äº†çº¿ç¨‹æ± çš„å…·ä½“è¡Œä¸º</p><p>1ï¼Œ<strong>execute</strong>ï¼ˆRunnable commandï¼‰ï¼šå±¥è¡ŒRuannableç±»å‹çš„ä»»åŠ¡,</p><p>2ï¼Œ<strong>submit</strong>ï¼ˆtaskï¼‰ï¼šå¯ç”¨æ¥æäº¤Callableæˆ–Runnableä»»åŠ¡ï¼Œå¹¶è¿”å›ä»£è¡¨æ­¤ä»»åŠ¡çš„Futureå¯¹è±¡</p><p>3ï¼Œ<strong>shutdown</strong>ï¼ˆï¼‰ï¼šåœ¨å®Œæˆå·²æäº¤çš„ä»»åŠ¡åå°é—­åŠäº‹ï¼Œä¸å†æ¥ç®¡æ–°ä»»åŠ¡,</p><p>4ï¼Œ<strong>shutdownNow</strong>ï¼ˆï¼‰ï¼šåœæ­¢æ‰€æœ‰æ­£åœ¨å±¥è¡Œçš„ä»»åŠ¡å¹¶å°é—­åŠäº‹ã€‚</p><p>5ï¼Œ<strong>isTerminated</strong>ï¼ˆï¼‰ï¼šæµ‹è¯•æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å±¥è¡Œå®Œæ¯•äº†ã€‚</p><p>6ï¼Œ<strong>isShutdown</strong>ï¼ˆï¼‰ï¼šæµ‹è¯•æ˜¯å¦è¯¥ExecutorServiceå·²è¢«å…³é—­ã€‚</p><h4 id="14-8-3-é‡ç‚¹å±æ€§"><a href="#14-8-3-é‡ç‚¹å±æ€§" class="headerlink" title="14.8.3. é‡ç‚¹å±æ€§"></a>14.8.3. <strong>é‡ç‚¹å±æ€§</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p><strong>ctl</strong> æ˜¯å¯¹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€å’Œçº¿ç¨‹æ± ä¸­æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡è¿›è¡Œæ§åˆ¶çš„ä¸€ä¸ªå­—æ®µï¼Œ å®ƒåŒ…å«ä¸¤éƒ¨åˆ†çš„ä¿¡æ¯: </p><ul><li>çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) </li><li>çº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)</li></ul><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†Integerç±»å‹æ¥ä¿å­˜ï¼Œé«˜3ä½ä¿å­˜runStateï¼Œä½29ä½ä¿å­˜workerCountã€‚COUNT_BITS å°±æ˜¯29ï¼ŒCAPACITYå°±æ˜¯1å·¦ç§»29ä½å‡1ï¼ˆ29ä¸ª1ï¼‰ï¼Œè¿™ä¸ªå¸¸é‡è¡¨ç¤ºworkerCountçš„ä¸Šé™å€¼ï¼Œå¤§çº¦æ˜¯5äº¿ã€‚</p><p><strong>ctlç›¸å…³æ–¹æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Packing and unpacking ctl</span><br><span class="line">private static int runStateOf(int c)     &#123; return c &amp; ~CAPACITY; &#125; // è·å–è¿è¡ŒçŠ¶æ€</span><br><span class="line">private static int workerCountOf(int c)  &#123; return c &amp; CAPACITY; &#125; // è·å–æ´»åŠ¨çº¿ç¨‹æ•°</span><br><span class="line">private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125; // è·å–è¿è¡ŒçŠ¶æ€å’Œæ´»åŠ¨çº¿ç¨‹æ•°çš„å€¼</span><br></pre></td></tr></table></figure><h4 id="14-8-4ä¸ºä»€ä¹ˆé˜¿é‡Œjavaè§„çº¦ä¸­ä¸å»ºè®®ä½¿ç”¨Executors"><a href="#14-8-4ä¸ºä»€ä¹ˆé˜¿é‡Œjavaè§„çº¦ä¸­ä¸å»ºè®®ä½¿ç”¨Executors" class="headerlink" title="14.8.4ä¸ºä»€ä¹ˆé˜¿é‡Œjavaè§„çº¦ä¸­ä¸å»ºè®®ä½¿ç”¨Executors"></a>14.8.4ä¸ºä»€ä¹ˆé˜¿é‡Œjavaè§„çº¦ä¸­ä¸å»ºè®®ä½¿ç”¨Executors</h4><ul><li><p>å› ä¸ºé˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ã€‚ä»»åŠ¡å¯ä»¥æ— é™å­˜æ”¾ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</p></li><li><p>è€Œä¸”ä»»åŠ¡é˜»å¡æ—¶é—´æ¯”è¾ƒä¹…ã€‚</p></li></ul><h3 id="14-9-åˆ›å»ºçº¿ç¨‹æ± "><a href="#14-9-åˆ›å»ºçº¿ç¨‹æ± " class="headerlink" title="14.9 åˆ›å»ºçº¿ç¨‹æ± "></a>14.9 åˆ›å»ºçº¿ç¨‹æ± </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new &#123;<span class="doctag">@code</span> ThreadPoolExecutor&#125; with the given initial</span></span><br><span class="line"><span class="comment">     * parameters and default thread factory and rejected execution handler.</span></span><br><span class="line"><span class="comment">     * It may be more convenient to use one of the &#123;<span class="doctag">@link</span> Executors&#125; factory</span></span><br><span class="line"><span class="comment">     * methods instead of this general purpose constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span></span><br><span class="line"><span class="comment">     *        if they are idle, unless &#123;<span class="doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maximumPoolSize the maximum number of threads to allow in the</span></span><br><span class="line"><span class="comment">     *        pool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keepAliveTime when the number of threads is greater than</span></span><br><span class="line"><span class="comment">     *        the core, this is the maximum time that excess idle threads</span></span><br><span class="line"><span class="comment">     *        will wait for new tasks before terminating.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit the time unit for the &#123;<span class="doctag">@code</span> keepAliveTime&#125; argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workQueue the queue to use for holding tasks before they are</span></span><br><span class="line"><span class="comment">     *        executed.  This queue will hold only the &#123;<span class="doctag">@code</span> Runnable&#125;</span></span><br><span class="line"><span class="comment">     *        tasks submitted by the &#123;<span class="doctag">@code</span> execute&#125; method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException if one of the following holds:&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> corePoolSize &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> keepAliveTime &lt; 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt;= 0&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     *         &#123;<span class="doctag">@code</span> maximumPoolSize &lt; corePoolSize&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> workQueue&#125; is null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="params"><span class="function">                              TimeUnit unit,</span></span></span><br><span class="line"><span class="params"><span class="function">                              BlockingQueue&lt;Runnable&gt; workQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">             Executors.defaultThreadFactory(), defaultHandler);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="1-corePoolSize"><a href="#1-corePoolSize" class="headerlink" title="1. corePoolSize"></a>1. <strong>corePoolSize</strong></h4><p>çº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹æ•°ç­‰äºcorePoolSizeï¼›å¦‚æœå½“å‰çº¿ç¨‹æ•°ä¸ºcorePoolSizeï¼Œç»§ç»­æäº¤çš„ä»»åŠ¡è¢«ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«æ‰§è¡Œï¼›å¦‚æœæ‰§è¡Œäº†çº¿ç¨‹æ± çš„prestartAllCoreThreads()æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ã€‚</p><h4 id="2-maximumPoolSize"><a href="#2-maximumPoolSize" class="headerlink" title="2. maximumPoolSize"></a>2. <strong>maximumPoolSize</strong></h4><p>çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœå½“å‰é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”ç»§ç»­æäº¤ä»»åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå‰ææ˜¯å½“å‰çº¿ç¨‹æ•°å°äºmaximumPoolSizeï¼›</p><h4 id="3-keepAliveTime"><a href="#3-keepAliveTime" class="headerlink" title="3. keepAliveTime"></a>3. <strong>keepAliveTime</strong></h4><p>çº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹æ‰€å…è®¸çš„ç©ºé—²æ—¶é—´ã€‚å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äºcorePoolSizeçš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº†keepAliveTimeï¼›</p><h4 id="4-unit"><a href="#4-unit" class="headerlink" title="4. unit"></a>4. <strong>unit</strong></h4><p>keepAliveTimeçš„å•ä½ï¼›</p><h4 id="5-workQueue"><a href="#5-workQueue" class="headerlink" title="5. workQueue"></a>5. <strong>workQueue</strong></h4><p>ç”¨æ¥ä¿å­˜ç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¸”ä»»åŠ¡å¿…é¡»å®ç°Runableæ¥å£ï¼Œåœ¨JDKä¸­æä¾›äº†å¦‚ä¸‹é˜»å¡é˜Ÿåˆ—ï¼š</p><ul><li>1ã€ArrayBlockingQueueï¼šåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼›</li><li>2ã€LinkedBlockingQueneï¼šåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueneï¼›</li><li>3ã€SynchronousQueneï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueneï¼›</li><li>4ã€priorityBlockingQueneï¼šå…·æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼›</li></ul><h4 id="6-threadFactory"><a href="#6-threadFactory" class="headerlink" title="6. threadFactory"></a>6. <strong>threadFactory</strong></h4><p>å®ƒæ˜¯ThreadFactoryç±»å‹çš„å˜é‡ï¼Œç”¨æ¥åˆ›å»ºæ–°çº¿ç¨‹ã€‚é»˜è®¤ä½¿ç”¨Executors.defaultThreadFactory() æ¥åˆ›å»ºçº¿ç¨‹ã€‚ä½¿ç”¨é»˜è®¤çš„ThreadFactoryæ¥åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šä½¿æ–°åˆ›å»ºçš„çº¿ç¨‹å…·æœ‰ç›¸åŒçš„NORM_PRIORITYä¼˜å…ˆçº§å¹¶ä¸”æ˜¯éå®ˆæŠ¤çº¿ç¨‹ï¼ŒåŒæ—¶ä¹Ÿè®¾ç½®äº†çº¿ç¨‹çš„åç§°ã€‚</p><h4 id="7-handler"><a href="#7-handler" class="headerlink" title="7. handler"></a>7. <strong>handler</strong></h4><p>çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥ï¼Œå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”æ²¡æœ‰ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœç»§ç»­æäº¤ä»»åŠ¡ï¼Œå¿…é¡»é‡‡å–ä¸€ç§ç­–ç•¥å¤„ç†è¯¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æä¾›äº†4ç§ç­–ç•¥ï¼š</p><ul><li>1ã€AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼›</li><li>2ã€CallerRunsPolicyï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›</li><li>3ã€DiscardOldestPolicyï¼šä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼›</li><li>4ã€DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼›</li></ul><p>ä¸Šé¢çš„4ç§ç­–ç•¥éƒ½æ˜¯ThreadPoolExecutorçš„å†…éƒ¨ç±»ã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯å®ç°RejectedExecutionHandleræ¥å£ï¼Œè‡ªå®šä¹‰é¥±å’Œç­–ç•¥ï¼Œå¦‚è®°å½•æ—¥å¿—æˆ–æŒä¹…åŒ–å­˜å‚¨ä¸èƒ½å¤„ç†çš„ä»»åŠ¡ã€‚</p><h3 id="14-10-çº¿ç¨‹æ± æ‰§è¡Œæµç¨‹"><a href="#14-10-çº¿ç¨‹æ± æ‰§è¡Œæµç¨‹" class="headerlink" title="14.10 çº¿ç¨‹æ± æ‰§è¡Œæµç¨‹"></a>14.10 çº¿ç¨‹æ± æ‰§è¡Œæµç¨‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Proceed in 3 steps:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 1. If fewer than corePoolSize threads are running, try to</span></span><br><span class="line"><span class="comment">         * start a new thread with the given command as its first</span></span><br><span class="line"><span class="comment">         * task.  The call to addWorker atomically checks runState and</span></span><br><span class="line"><span class="comment">         * workerCount, and so prevents false alarms that would add</span></span><br><span class="line"><span class="comment">         * threads when it shouldn&#x27;t, by returning false.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 2. If a task can be successfully queued, then we still need</span></span><br><span class="line"><span class="comment">         * to double-check whether we should have added a thread</span></span><br><span class="line"><span class="comment">         * (because existing ones died since last checking) or that</span></span><br><span class="line"><span class="comment">         * the pool shut down since entry into this method. So we</span></span><br><span class="line"><span class="comment">         * recheck state and if necessary roll back the enqueuing if</span></span><br><span class="line"><span class="comment">         * stopped, or start a new thread if there are none.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 3. If we cannot queue task, then we try to add a new</span></span><br><span class="line"><span class="comment">         * thread.  If it fails, we know we are shut down or saturated</span></span><br><span class="line"><span class="comment">         * and so reject the task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">            <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            c = ctl.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">            <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">                reject(command);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">                addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">            reject(command);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¹¶æ‰§è¡Œä»»åŠ¡</li><li>æŠŠä»»åŠ¡æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—</li><li>è¿˜æœ‰ä»»åŠ¡ï¼Œåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œ</li><li>å¦‚æœè¿˜æœ‰ä»»åŠ¡è¿›æ¥ï¼Œæ‰§è¡Œå¯¹åº”çš„æ‹’ç»ç­–ç•¥</li></ul><p><strong>æ€è€ƒğŸ¤”</strong></p><h4 id="é—®é¢˜ä¸€"><a href="#é—®é¢˜ä¸€" class="headerlink" title="é—®é¢˜ä¸€"></a>é—®é¢˜ä¸€</h4><p>å¦‚æœæ ¸å¿ƒçº¿ç¨‹è¿˜æ²¡æœ‰åˆ›å»ºå®Œï¼Œæ­¤æ—¶å·²ç»åˆ›å»ºçš„æ ¸å¿ƒçº¿ç¨‹çš„ä»»åŠ¡å·²ç»å¤„ç†å®Œäº†ï¼Œæ­¤æ—¶ï¼Œçº¿ç¨‹æ± æ–°æäº¤çš„ä»»åŠ¡ç”±é‚£ä¸ªçº¿ç¨‹æ¥å¤„ç†å‘¢ï¼Ÿ</p><p>æ˜¯ç”±å·²ç»åˆ›å»ºçš„æ ¸å¿ƒçº¿ç¨‹å‘¢è¿˜æ˜¯ä¼šåˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼š <strong>ä¼šåˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹ï¼ŒçŸ¥é“æ ¸å¿ƒçº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚</strong></p><h4 id="é—®é¢˜äºŒ"><a href="#é—®é¢˜äºŒ" class="headerlink" title="é—®é¢˜äºŒ"></a>é—®é¢˜äºŒ</h4><p><strong><font color=red>å¦‚ä½•åŒºåˆ†æ ¸å¿ƒçº¿ç¨‹è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Ÿ</font></strong></p><p>å…¶å®å¹¶æ²¡æœ‰åŠæ³•åŒºåˆ†ï¼Œçº¿ç¨‹é”€æ¯çš„æ—¶å€™ä¼šå»åˆ¤æ–­å½“å‰çº¿ç¨‹æ•°é‡æ˜¯å¦æ¯”æ ¸å¿ƒçº¿ç¨‹æ•°å¤§ï¼Œå¦‚æœå¤§ï¼Œåˆ™çº¿ç¨‹é”€æ¯ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹å°±æ˜¯éæ ¸å¿ƒçº¿ç¨‹ã€‚å¦‚æœä¸å¤§ï¼Œè€Œä¸”ä¹Ÿå…è®¸æ ¸å¿ƒçº¿ç¨‹å­˜æ´»çš„è¯ï¼Œçº¿ç¨‹å°±ä¸ä¼šé”€æ¯ï¼Œç•™ä¸‹æ¥çš„ä¹Ÿå°±æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚</p><h3 id="14-11-çº¿ç¨‹æ± çš„ç”Ÿå‘½çŠ¶æ€ï¼Ÿ"><a href="#14-11-çº¿ç¨‹æ± çš„ç”Ÿå‘½çŠ¶æ€ï¼Ÿ" class="headerlink" title="14.11 çº¿ç¨‹æ± çš„ç”Ÿå‘½çŠ¶æ€ï¼Ÿ"></a>14.11 çº¿ç¨‹æ± çš„ç”Ÿå‘½çŠ¶æ€ï¼Ÿ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS; <span class="comment">//é«˜3ä½ä¸º111</span></span><br><span class="line">SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS; <span class="comment">//é«˜3ä½ä¸º000</span></span><br><span class="line">STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS; <span class="comment">//é«˜3ä½ä¸º001</span></span><br><span class="line">TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS; <span class="comment">//é«˜3ä½ä¸º010</span></span><br><span class="line">TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS; <span class="comment">//é«˜3ä½ä¸º011</span></span><br></pre></td></tr></table></figure><h4 id="1ã€RUNNING"><a href="#1ã€RUNNING" class="headerlink" title="1ã€RUNNING"></a>1ã€RUNNING</h4><p>(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨RUNNINGçŠ¶æ€æ—¶ï¼Œèƒ½å¤Ÿæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä»¥åŠå¯¹å·²æ·»åŠ çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚ </p><p>(02) çŠ¶æ€åˆ‡æ¢ï¼šçº¿ç¨‹æ± çš„åˆå§‹åŒ–çŠ¶æ€æ˜¯RUNNINGã€‚æ¢å¥è¯è¯´ï¼Œçº¿ç¨‹æ± è¢«ä¸€æ—¦è¢«åˆ›å»ºï¼Œå°±å¤„äºRUNNINGçŠ¶æ€ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ•°ä¸º0ï¼</p><h4 id="2ã€-SHUTDOWN"><a href="#2ã€-SHUTDOWN" class="headerlink" title="2ã€ SHUTDOWN"></a>2ã€ SHUTDOWN</h4><p>(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨SHUTDOWNçŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†èƒ½å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ã€‚ </p><p>(2) çŠ¶æ€åˆ‡æ¢ï¼šè°ƒç”¨çº¿ç¨‹æ± çš„shutdown()æ¥å£æ—¶ï¼Œçº¿ç¨‹æ± ç”±RUNNING -&gt; SHUTDOWNã€‚</p><h4 id="3ã€STOP"><a href="#3ã€STOP" class="headerlink" title="3ã€STOP"></a>3ã€STOP</h4><p>(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨STOPçŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚ </p><p>(2) çŠ¶æ€åˆ‡æ¢ï¼šè°ƒç”¨çº¿ç¨‹æ± çš„shutdownNow()æ¥å£æ—¶ï¼Œçº¿ç¨‹æ± ç”±(RUNNING or SHUTDOWN ) -&gt; STOPã€‚</p><h4 id="4ã€TIDYING"><a href="#4ã€TIDYING" class="headerlink" title="4ã€TIDYING"></a>4ã€TIDYING</h4><p>(1) çŠ¶æ€è¯´æ˜ï¼šå½“æ‰€æœ‰çš„ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œctlè®°å½•çš„â€ä»»åŠ¡æ•°é‡â€ä¸º0ï¼Œçº¿ç¨‹æ± ä¼šå˜ä¸ºTIDYINGçŠ¶æ€ã€‚å½“çº¿ç¨‹æ± å˜ä¸ºTIDYINGçŠ¶æ€æ—¶ï¼Œä¼šæ‰§è¡Œé’©å­å‡½æ•°terminated()ã€‚terminated()åœ¨ThreadPoolExecutorç±»ä¸­æ˜¯ç©ºçš„ï¼Œè‹¥ç”¨æˆ·æƒ³åœ¨çº¿ç¨‹æ± å˜ä¸ºTIDYINGæ—¶ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼›å¯ä»¥é€šè¿‡é‡è½½terminated()å‡½æ•°æ¥å®ç°ã€‚ </p><p>(2) çŠ¶æ€åˆ‡æ¢ï¼šå½“çº¿ç¨‹æ± åœ¨SHUTDOWNçŠ¶æ€ä¸‹ï¼Œé˜»å¡é˜Ÿåˆ—ä¸ºç©ºå¹¶ä¸”çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¹Ÿä¸ºç©ºæ—¶ï¼Œå°±ä¼šç”± SHUTDOWN -&gt; TIDYINGã€‚ å½“çº¿ç¨‹æ± åœ¨STOPçŠ¶æ€ä¸‹ï¼Œçº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¸ºç©ºæ—¶ï¼Œå°±ä¼šç”±STOP -&gt; TIDYINGã€‚</p><h4 id="5ã€-TERMINATED"><a href="#5ã€-TERMINATED" class="headerlink" title="5ã€ TERMINATED"></a>5ã€ TERMINATED</h4><p>(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å½»åº•ç»ˆæ­¢ï¼Œå°±å˜æˆTERMINATEDçŠ¶æ€ã€‚ </p><p>(2) çŠ¶æ€åˆ‡æ¢ï¼šçº¿ç¨‹æ± å¤„åœ¨TIDYINGçŠ¶æ€æ—¶ï¼Œæ‰§è¡Œå®Œterminated()ä¹‹åï¼Œå°±ä¼šç”± TIDYING -&gt; TERMINATEDã€‚</p><p>è¿›å…¥TERMINATEDçš„æ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>çº¿ç¨‹æ± ä¸æ˜¯RUNNINGçŠ¶æ€ï¼›</li><li>çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯TIDYINGçŠ¶æ€æˆ–TERMINATEDçŠ¶æ€ï¼›</li><li>å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ˜¯SHUTDOWNå¹¶ä¸”workerQueueä¸ºç©ºï¼›</li><li>workerCountä¸º0ï¼›</li><li>è®¾ç½®TIDYINGçŠ¶æ€æˆåŠŸã€‚</li></ul><img src="https://oscimg.oschina.net/oscnet/up-8dfc60e1eef3f170c19287d204a9e6caa4c.png" style="zoom:50%;" /><h3 id="14-12-çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"><a href="#14-12-çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ" class="headerlink" title="14.12 çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"></a>14.12 çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ</h3><h4 id="1-AbortPolicy-æŠ›å‡ºå¼‚å¸¸"><a href="#1-AbortPolicy-æŠ›å‡ºå¼‚å¸¸" class="headerlink" title="1. AbortPolicy æŠ›å‡ºå¼‚å¸¸"></a>1. AbortPolicy æŠ›å‡ºå¼‚å¸¸</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbortPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates an &#123;<span class="doctag">@code</span> AbortPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AbortPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Always throws RejectedExecutionException.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> RejectedExecutionException always</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">&quot;Task &quot;</span> + r.toString() +</span><br><span class="line">                                                 <span class="string">&quot; rejected from &quot;</span> +</span><br><span class="line">                                                 e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-CallerRunsPolicyï¼šç”±å½“å‰çº¿ç¨‹æ‰§è¡Œ"><a href="#2-CallerRunsPolicyï¼šç”±å½“å‰çº¿ç¨‹æ‰§è¡Œ" class="headerlink" title="2. CallerRunsPolicyï¼šç”±å½“å‰çº¿ç¨‹æ‰§è¡Œ"></a>2. CallerRunsPolicyï¼šç”±å½“å‰çº¿ç¨‹æ‰§è¡Œ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallerRunsPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;<span class="doctag">@code</span> CallerRunsPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CallerRunsPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Executes task r in the caller&#x27;s thread, unless the executor</span></span><br><span class="line"><span class="comment">         * has been shut down, in which case the task is discarded.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">                r.run();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-DiscardOldestPolicyï¼šæŠ›å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡"><a href="#3-DiscardOldestPolicyï¼šæŠ›å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡" class="headerlink" title="3. DiscardOldestPolicyï¼šæŠ›å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡"></a>3. DiscardOldestPolicyï¼šæŠ›å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardOldestPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;<span class="doctag">@code</span> DiscardOldestPolicy&#125; for the given executor.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DiscardOldestPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Obtains and ignores the next task that the executor</span></span><br><span class="line"><span class="comment">         * would otherwise execute, if one is immediately available,</span></span><br><span class="line"><span class="comment">         * and then retries execution of task r, unless the executor</span></span><br><span class="line"><span class="comment">         * is shut down, in which case task r is instead discarded.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">                e.getQueue().poll();</span><br><span class="line">                e.execute(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="4-DiscardPolicyï¼š-ç›´æ¥ä¸¢å¼ƒï¼Œä»€ä¹ˆéƒ½ä¸åš"><a href="#4-DiscardPolicyï¼š-ç›´æ¥ä¸¢å¼ƒï¼Œä»€ä¹ˆéƒ½ä¸åš" class="headerlink" title="4. DiscardPolicyï¼š ç›´æ¥ä¸¢å¼ƒï¼Œä»€ä¹ˆéƒ½ä¸åš"></a>4. DiscardPolicyï¼š ç›´æ¥ä¸¢å¼ƒï¼Œä»€ä¹ˆéƒ½ä¸åš</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscardPolicy</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates a &#123;<span class="doctag">@code</span> DiscardPolicy&#125;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DiscardPolicy</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Does nothing, which has the effect of discarding task r.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> r the runnable task requested to be executed</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the executor attempting to execute this task</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-13-éæ ¸å¿ƒçº¿ç¨‹è¿‡æœŸæ˜¯å¦‚ä½•åˆ¤æ–­çš„ï¼Ÿ"><a href="#14-13-éæ ¸å¿ƒçº¿ç¨‹è¿‡æœŸæ˜¯å¦‚ä½•åˆ¤æ–­çš„ï¼Ÿ" class="headerlink" title="14.13 éæ ¸å¿ƒçº¿ç¨‹è¿‡æœŸæ˜¯å¦‚ä½•åˆ¤æ–­çš„ï¼Ÿ"></a>14.13 éæ ¸å¿ƒçº¿ç¨‹è¿‡æœŸæ˜¯å¦‚ä½•åˆ¤æ–­çš„ï¼Ÿ</h3><p>é˜»å¡é˜Ÿåˆ—å®ç°ï¼Œpollè®¾ç½®æ—¶é—´ï¼Œç„¶åå“åº”ä¸­æ–­å¼‚å¸¸ã€‚</p><h3 id="14-14-çº¿ç¨‹æ± å‚æ•°å¦‚ä½•é…ç½®ï¼Ÿ"><a href="#14-14-çº¿ç¨‹æ± å‚æ•°å¦‚ä½•é…ç½®ï¼Ÿ" class="headerlink" title="14.14 çº¿ç¨‹æ± å‚æ•°å¦‚ä½•é…ç½®ï¼Ÿ"></a>14.14 çº¿ç¨‹æ± å‚æ•°å¦‚ä½•é…ç½®ï¼Ÿ</h3><ul><li>CPUå¯†é›†å‹ ï¼š CPUæ ¸æ•° + 1</li><li>IOå¯†é›†å‹ ï¼š 2å€CPUæ ¸æ•°</li></ul><h2 id="15-ScheduledThreadPoolExecutor"><a href="#15-ScheduledThreadPoolExecutor" class="headerlink" title="15. ScheduledThreadPoolExecutor"></a>15. ScheduledThreadPoolExecutor</h2><h4 id="15-1-åˆ›å»ºå®šæ—¶çº¿ç¨‹æ± "><a href="#15-1-åˆ›å»ºå®šæ—¶çº¿ç¨‹æ± " class="headerlink" title="15.1 åˆ›å»ºå®šæ—¶çº¿ç¨‹æ± "></a>15.1 åˆ›å»ºå®šæ—¶çº¿ç¨‹æ± </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ScheduledThreadPoolExecutor scheduledThreadPoolExecutor = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h4 id="15-2-å¦‚ä½•å‘¨æœŸæ€§æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Ÿ"><a href="#15-2-å¦‚ä½•å‘¨æœŸæ€§æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Ÿ" class="headerlink" title="15.2 å¦‚ä½•å‘¨æœŸæ€§æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Ÿ"></a>15.2 å¦‚ä½•å‘¨æœŸæ€§æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">scheduledThreadPoolExecutor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;send heart beat&quot;</span>);</span><br><span class="line">            <span class="keyword">long</span> starttime = System.currentTimeMillis(), nowtime = starttime;</span><br><span class="line">            <span class="keyword">while</span> ((nowtime - starttime) &lt; <span class="number">5000</span>) &#123;</span><br><span class="line">                nowtime = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;task over....&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;unexpected error , stop working&quot;</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>, <span class="number">2000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h4 id="15-3-å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¦‚æœå¤§äºæ‰§è¡Œæ—¶é—´é—´éš”æ€ä¹ˆåŠï¼Ÿ"><a href="#15-3-å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¦‚æœå¤§äºæ‰§è¡Œæ—¶é—´é—´éš”æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="15.3 å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¦‚æœå¤§äºæ‰§è¡Œæ—¶é—´é—´éš”æ€ä¹ˆåŠï¼Ÿ"></a>15.3 å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¦‚æœå¤§äºæ‰§è¡Œæ—¶é—´é—´éš”æ€ä¹ˆåŠï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheduleWithFixedDelay</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ç¬¬ä¸€ç§å®šæ—¶ä»»åŠ¡æ‰§è¡Œçš„æ–¹å¼ä¸‹ï¼Œåœ¨ä»»åŠ¡å¼€å§‹çš„æ—¶å€™å¼€å§‹ç®—èµ·ï¼Œä»»åŠ¡æ‰§è¡Œ5sï¼Œä½†æ˜¯ä»»åŠ¡æ‰§è¡Œé—´éš”æ—¶é—´æ˜¯2sï¼Œæ„å‘³ç€ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œç»“æŸï¼Œä¸‹ä¸€æ¬¡ä»»åŠ¡å°±åœ¨ç­‰å¾…æ‰§è¡Œè¿‡äº†ã€‚æœ€ç»ˆä¼šæ¼”å˜æˆï¼Œå®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´é—´éš”å˜æˆ5sã€‚</p><p>è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œå°±ä¸åº”è¯¥åœ¨ä»»åŠ¡æ‰§è¡Œå¼€å§‹çš„æ—¶å€™å°±è®°æ—¶ç®—èµ·ï¼Œè€Œæ˜¯åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œ2såå†å¼€å§‹æ‰§è¡Œæ–°ä¸€è½®ä»»åŠ¡ã€‚</p><p>å¦‚æœåªæœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°é…äº†2ä¸ªä¼šæ€æ ·ï¼Ÿ</p><p>åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥åªåˆ›å»ºäº†ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ã€‚</p><blockquote><p>çº¿ç¨‹åˆ›å»ºæ˜¯åœ¨æäº¤ä»»åŠ¡çš„æ—¶å€™ï¼Œæ‰€ä»¥ï¼Œå¦‚æœåªæ˜¯æäº¤äº†1ä¸ªä»»åŠ¡ï¼Œåªä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚</p></blockquote><h4 id="15-4-å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ"><a href="#15-4-å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ" class="headerlink" title="15.4 å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ"></a>15.4 å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">scheduledThreadPoolExecutor.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">    log.info(<span class="string">&quot;send heart beat&quot;</span>);</span><br><span class="line">    <span class="keyword">long</span> starttime = System.currentTimeMillis(), nowtime = starttime;</span><br><span class="line">    <span class="keyword">while</span> ((nowtime - starttime) &lt; <span class="number">5000</span>) &#123;</span><br><span class="line">        nowtime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;task over....&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;unexpected error , stop working&quot;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>, <span class="number">2000</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹åˆ›å»ºäº†ä½†æ˜¯ä»»åŠ¡ä¸æ‰§è¡Œ</p><h4 id="15-5-è¿˜æœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ"><a href="#15-5-è¿˜æœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ" class="headerlink" title="15.5 è¿˜æœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ"></a>15.5 è¿˜æœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line">timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">&quot;send heart beat&quot;</span>);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;unexpected error , stop working&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;,<span class="number">1000</span>,<span class="number">2000</span>);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">21</span>:<span class="number">11.915</span> [Timer-<span class="number">0</span>] INFO com.yg.edu.schedule.ScheduleThreadPoolRunner - send heart beat</span><br><span class="line">Exception in thread <span class="string">&quot;Timer-0&quot;</span> java.lang.RuntimeException: unexpected error , stop working</span><br><span class="line">at com.yg.edu.schedule.ScheduleThreadPoolRunner$<span class="number">1.</span>run(ScheduleThreadPoolRunner.java:<span class="number">95</span>)</span><br><span class="line">at java.util.TimerThread.mainLoop(Timer.java:<span class="number">555</span>)</span><br><span class="line">at java.util.TimerThread.run(Timer.java:<span class="number">505</span>)</span><br><span class="line"></span><br><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalStateException: Timer already cancelled.</span><br><span class="line">at java.util.Timer.sched(Timer.java:<span class="number">397</span>)</span><br><span class="line">at java.util.Timer.scheduleAtFixedRate(Timer.java:<span class="number">328</span>)</span><br><span class="line">at com.yg.edu.schedule.ScheduleThreadPoolRunner.main(ScheduleThreadPoolRunner.java:<span class="number">105</span>)</span><br></pre></td></tr></table></figure><h4 id="15-6-Timerå’ŒScheduledä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#15-6-Timerå’ŒScheduledä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="15.6 Timerå’ŒScheduledä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>15.6 Timerå’ŒScheduledä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h4><p>Timeræ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æœæäº¤äº†å¤šä¸ªä»»åŠ¡ï¼Œä¸€æ—¦ä¸€ä¸ªä»»åŠ¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œå…¶ä»–çš„ä»»åŠ¡ä¹Ÿæ— æ³•åœ¨æ‰§è¡Œ</p><p>scheduledThreadPoolExecutoræ˜¯å¤šçº¿ç¨‹çš„ï¼Œä¸€ä¸ªä»»åŠ¡æŠ›å‡ºäº†å¼‚å¸¸ä¸å½±å“å…¶ä»–çš„ä»»åŠ¡å’Œå°†è¦æ¥ä¸´çš„ä»»åŠ¡</p><h4 id="15-7-ä½¿ç”¨åœºæ™¯"><a href="#15-7-ä½¿ç”¨åœºæ™¯" class="headerlink" title="15.7 ä½¿ç”¨åœºæ™¯"></a>15.7 ä½¿ç”¨åœºæ™¯</h4><p>1ã€åˆ†å¸ƒå¼é” é”ç»­å‘½ å®šæ—¶åˆ¤æ–­ çœ‹é—¨ç‹—</p><p>2ã€å¿ƒè·³æ£€æµ‹</p><p>3ã€å…¶ä»–</p><h4 id="15-8-å®šæ—¶ä»»åŠ¡æ˜¯å¦‚ä½•æ’åºçš„ï¼Ÿ"><a href="#15-8-å®šæ—¶ä»»åŠ¡æ˜¯å¦‚ä½•æ’åºçš„ï¼Ÿ" class="headerlink" title="15.8 å®šæ—¶ä»»åŠ¡æ˜¯å¦‚ä½•æ’åºçš„ï¼Ÿ"></a>15.8 å®šæ—¶ä»»åŠ¡æ˜¯å¦‚ä½•æ’åºçš„ï¼Ÿ</h4><p>å †ç»“æ„</p><h2 id="16-Fock-Joinæ¡†æ¶"><a href="#16-Fock-Joinæ¡†æ¶" class="headerlink" title="16. Fock/Joinæ¡†æ¶"></a>16. Fock/Joinæ¡†æ¶</h2><h3 id="16-1-ä»»åŠ¡æ€§è´¨ç±»å‹"><a href="#16-1-ä»»åŠ¡æ€§è´¨ç±»å‹" class="headerlink" title="16.1 ä»»åŠ¡æ€§è´¨ç±»å‹"></a>16.1 <strong>ä»»åŠ¡æ€§è´¨ç±»å‹</strong></h3><h4 id="CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰"><a href="#CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰" class="headerlink" title="CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰"></a><strong>CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰</strong></h4><p>CPUå¯†é›†å‹ä¹Ÿå«è®¡ç®—å¯†é›†å‹ï¼ŒæŒ‡çš„æ˜¯ç³»ç»Ÿçš„ç¡¬ç›˜ã€å†…å­˜æ€§èƒ½ç›¸å¯¹CPUè¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPU Loading 100%ï¼ŒCPUè¦è¯»/å†™I/O(ç¡¬ç›˜/å†…å­˜)ï¼ŒI/Oåœ¨å¾ˆçŸ­çš„æ—¶é—´å°±å¯ä»¥å®Œæˆï¼Œè€ŒCPUè¿˜æœ‰è®¸å¤šè¿ç®—è¦å¤„ç†ï¼ŒCPU Loadingå¾ˆé«˜ã€‚</p><p>åœ¨å¤šé‡ç¨‹åºç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨ä»½æ—¶é—´ç”¨æ¥åšè®¡ç®—ã€é€»è¾‘åˆ¤æ–­ç­‰CPUåŠ¨ä½œçš„ç¨‹åºç§°ä¹‹CPU boundã€‚ä¾‹å¦‚ä¸€ä¸ªè®¡ç®—åœ†å‘¨ç‡è‡³å°æ•°ç‚¹ä¸€åƒä½ä»¥ä¸‹çš„ç¨‹åºï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹å½“ä¸­ç»å¤§éƒ¨ä»½æ—¶é—´ç”¨åœ¨ä¸‰è§’å‡½æ•°å’Œå¼€æ ¹å·çš„è®¡ç®—ï¼Œä¾¿æ˜¯å±äºCPU boundçš„ç¨‹åºã€‚</p><p>CPU boundçš„ç¨‹åºä¸€èˆ¬è€Œè¨€CPUå ç”¨ç‡ç›¸å½“é«˜ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«ä¸å¤ªéœ€è¦è®¿é—®I/Oè®¾å¤‡ï¼Œä¹Ÿå¯èƒ½æ˜¯å› ä¸ºç¨‹åºæ˜¯å¤šçº¿ç¨‹å®ç°å› æ­¤å±è”½æ‰äº†ç­‰å¾…I/Oçš„æ—¶é—´ã€‚</p><p>çº¿ç¨‹æ•°ä¸€èˆ¬è®¾ç½®ä¸ºï¼š<code>çº¿ç¨‹æ•° = CPUæ ¸æ•°+1 (ç°ä»£CPUæ”¯æŒè¶…çº¿ç¨‹)</code></p><h4 id="IOå¯†é›†å‹ï¼ˆI-O-boundï¼‰"><a href="#IOå¯†é›†å‹ï¼ˆI-O-boundï¼‰" class="headerlink" title="IOå¯†é›†å‹ï¼ˆI/O boundï¼‰"></a><strong>IOå¯†é›†å‹ï¼ˆI/O boundï¼‰</strong></h4><p>IOå¯†é›†å‹æŒ‡çš„æ˜¯ç³»ç»Ÿçš„CPUæ€§èƒ½ç›¸å¯¹ç¡¬ç›˜ã€å†…å­˜è¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œï¼Œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜) çš„è¯»/å†™æ“ä½œï¼Œæ­¤æ—¶CPU Loadingå¹¶ä¸é«˜ã€‚</p><p>I/O boundçš„ç¨‹åºä¸€èˆ¬åœ¨è¾¾åˆ°æ€§èƒ½æé™æ—¶ï¼ŒCPUå ç”¨ç‡ä»ç„¶è¾ƒä½ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«éœ€è¦å¤§é‡I/Oæ“ä½œï¼Œè€Œpipelineåšå¾—ä¸æ˜¯å¾ˆå¥½ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤„ç†å™¨èƒ½åŠ›ã€‚</p><p>çº¿ç¨‹æ•°ä¸€èˆ¬è®¾ç½®ä¸ºï¼š<code>çº¿ç¨‹æ•° = ï¼ˆï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´+çº¿ç¨‹CPUæ—¶é—´ï¼‰/çº¿ç¨‹CPUæ—¶é—´ ï¼‰* CPUæ•°ç›® </code></p><h4 id="CPUå¯†é›†å‹-vs-IOå¯†é›†å‹"><a href="#CPUå¯†é›†å‹-vs-IOå¯†é›†å‹" class="headerlink" title="CPUå¯†é›†å‹ vs IOå¯†é›†å‹"></a><strong>CPUå¯†é›†å‹ vs IOå¯†é›†å‹</strong></h4><p>æˆ‘ä»¬å¯ä»¥æŠŠä»»åŠ¡åˆ†ä¸ºè®¡ç®—å¯†é›†å‹å’ŒIOå¯†é›†å‹ã€‚</p><p>è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯è¦è¿›è¡Œå¤§é‡çš„è®¡ç®—ï¼Œæ¶ˆè€—CPUèµ„æºï¼Œæ¯”å¦‚è®¡ç®—åœ†å‘¨ç‡ã€å¯¹è§†é¢‘è¿›è¡Œé«˜æ¸…è§£ç ç­‰ç­‰ï¼Œå…¨é CPUçš„è¿ç®—èƒ½åŠ›ã€‚è¿™ç§è®¡ç®—å¯†é›†å‹ä»»åŠ¡è™½ç„¶ä¹Ÿå¯ä»¥ç”¨å¤šä»»åŠ¡å®Œæˆï¼Œä½†æ˜¯ä»»åŠ¡è¶Šå¤šï¼ŒèŠ±åœ¨ä»»åŠ¡åˆ‡æ¢çš„æ—¶é—´å°±è¶Šå¤šï¼ŒCPUæ‰§è¡Œä»»åŠ¡çš„æ•ˆç‡å°±è¶Šä½ï¼Œæ‰€ä»¥ï¼Œè¦æœ€é«˜æ•ˆåœ°åˆ©ç”¨CPUï¼Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡åŒæ—¶è¿›è¡Œçš„æ•°é‡åº”å½“ç­‰äºCPUçš„æ ¸å¿ƒæ•°ã€‚</p><p>è®¡ç®—å¯†é›†å‹ä»»åŠ¡ç”±äºä¸»è¦æ¶ˆè€—CPUèµ„æºï¼Œå› æ­¤ï¼Œä»£ç è¿è¡Œæ•ˆç‡è‡³å…³é‡è¦ã€‚Pythonè¿™æ ·çš„è„šæœ¬è¯­è¨€è¿è¡Œæ•ˆç‡å¾ˆä½ï¼Œå®Œå…¨ä¸é€‚åˆè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæœ€å¥½ç”¨Cè¯­è¨€ç¼–å†™ã€‚</p><p>ç¬¬äºŒç§ä»»åŠ¡çš„ç±»å‹æ˜¯IOå¯†é›†å‹ï¼Œæ¶‰åŠåˆ°ç½‘ç»œã€ç£ç›˜IOçš„ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯CPUæ¶ˆè€—å¾ˆå°‘ï¼Œä»»åŠ¡çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…IOæ“ä½œå®Œæˆï¼ˆå› ä¸ºIOçš„é€Ÿåº¦è¿œè¿œä½äºCPUå’Œå†…å­˜çš„é€Ÿåº¦ï¼‰ã€‚å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œä»»åŠ¡è¶Šå¤šï¼ŒCPUæ•ˆç‡è¶Šé«˜ï¼Œä½†ä¹Ÿæœ‰ä¸€ä¸ªé™åº¦ã€‚å¸¸è§çš„å¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚Webåº”ç”¨ã€‚</p><p>IOå¯†é›†å‹ä»»åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œ99%çš„æ—¶é—´éƒ½èŠ±åœ¨IOä¸Šï¼ŒèŠ±åœ¨CPUä¸Šçš„æ—¶é—´å¾ˆå°‘ï¼Œå› æ­¤ï¼Œç”¨è¿è¡Œé€Ÿåº¦æå¿«çš„Cè¯­è¨€æ›¿æ¢ç”¨Pythonè¿™æ ·è¿è¡Œé€Ÿåº¦æä½çš„è„šæœ¬è¯­è¨€ï¼Œå®Œå…¨æ— æ³•æå‡è¿è¡Œæ•ˆç‡ã€‚å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œæœ€åˆé€‚çš„è¯­è¨€å°±æ˜¯å¼€å‘æ•ˆç‡æœ€é«˜ï¼ˆä»£ç é‡æœ€å°‘ï¼‰çš„è¯­è¨€ï¼Œè„šæœ¬è¯­è¨€æ˜¯é¦–é€‰ï¼ŒCè¯­è¨€æœ€å·®ã€‚</p><h3 id="16-2-ä»€ä¹ˆæ˜¯-Fork-Join-æ¡†æ¶ï¼Ÿ"><a href="#16-2-ä»€ä¹ˆæ˜¯-Fork-Join-æ¡†æ¶ï¼Ÿ" class="headerlink" title="16.2 ä»€ä¹ˆæ˜¯ Fork/Join æ¡†æ¶ï¼Ÿ"></a>16.2 <strong>ä»€ä¹ˆæ˜¯ Fork/Join æ¡†æ¶ï¼Ÿ</strong></h3><p>Fork/Join æ¡†æ¶æ˜¯ Java7 æä¾›äº†çš„ä¸€ä¸ªç”¨äºå¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ¡†æ¶ï¼Œ æ˜¯ä¸€ä¸ªæŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œæœ€ç»ˆæ±‡æ€»æ¯ä¸ªå°ä»»åŠ¡ç»“æœåå¾—åˆ°å¤§ä»»åŠ¡ç»“æœçš„æ¡†æ¶ã€‚</p><p>Fork å°±æ˜¯æŠŠä¸€ä¸ªå¤§ä»»åŠ¡åˆ‡åˆ†ä¸ºè‹¥å¹²å­ä»»åŠ¡å¹¶è¡Œçš„æ‰§è¡Œï¼ŒJoin å°±æ˜¯åˆå¹¶è¿™äº›å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œæœ€åå¾—åˆ°è¿™ä¸ªå¤§ä»»åŠ¡çš„ç»“æœã€‚æ¯”å¦‚è®¡ç®—1+2+â€¦..ï¼‹10000ï¼Œå¯ä»¥åˆ†å‰²æˆ 10 ä¸ªå­ä»»åŠ¡ï¼Œæ¯ä¸ªå­ä»»åŠ¡åˆ†åˆ«å¯¹ 1000 ä¸ªæ•°è¿›è¡Œæ±‚å’Œï¼Œæœ€ç»ˆæ±‡æ€»è¿™ 10 ä¸ªå­ä»»åŠ¡çš„ç»“æœã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://oscimg.oschina.net/oscnet/up-c970a71304111fa60b62f1f29613c9108f8.png" style="zoom:50%;" /><h3 id="16-3-Fork-Jionç‰¹æ€§"><a href="#16-3-Fork-Jionç‰¹æ€§" class="headerlink" title="16.3 Fork/Jionç‰¹æ€§"></a>16.3 Fork/Jionç‰¹æ€§</h3><ol><li>ForkJoinPool ä¸æ˜¯ä¸ºäº†æ›¿ä»£ ExecutorServiceï¼Œè€Œæ˜¯å®ƒçš„è¡¥å……ï¼Œåœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸‹æ€§èƒ½æ¯” ExecutorService æ›´å¥½ã€‚ï¼ˆè§ Java Tip: When to use ForkJoinPool vs ExecutorService ï¼‰</li><li>ForkJoinPool <strong>ä¸»è¦ç”¨äºå®ç°â€œåˆ†è€Œæ²»ä¹‹â€çš„ç®—æ³•ï¼Œç‰¹åˆ«æ˜¯åˆ†æ²»ä¹‹åé€’å½’è°ƒç”¨çš„å‡½æ•°</strong>ï¼Œä¾‹å¦‚ quick sort ç­‰ã€‚</li><li>ForkJoinPool æœ€é€‚åˆçš„æ˜¯<strong>è®¡ç®—å¯†é›†å‹</strong>çš„ä»»åŠ¡ï¼Œå¦‚æœå­˜åœ¨ I/Oï¼Œçº¿ç¨‹é—´åŒæ­¥ï¼Œsleep() ç­‰ä¼šé€ æˆçº¿ç¨‹é•¿æ—¶é—´é˜»å¡çš„æƒ…å†µæ—¶ï¼Œæœ€å¥½é…åˆä½¿ç”¨ ManagedBlockerã€‚</li></ol><h3 id="16-4-Fork-Joinçš„å®ç°"><a href="#16-4-Fork-Joinçš„å®ç°" class="headerlink" title="16.4 Fork/Joinçš„å®ç°"></a>16.4 Fork/Joinçš„å®ç°</h3><p>å·¥ä½œçªƒå–ï¼ˆwork-stealingï¼‰ç®—æ³•æ˜¯æŒ‡æŸä¸ªçº¿ç¨‹ä»å…¶ä»–é˜Ÿåˆ—é‡Œçªƒå–ä»»åŠ¡æ¥æ‰§è¡Œã€‚</p><p>æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªæ¯”è¾ƒå¤§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªä»»åŠ¡åˆ†å‰²ä¸ºè‹¥å¹²äº’ä¸ä¾èµ–çš„å­ä»»åŠ¡ï¼Œä¸ºäº†å‡å°‘çº¿ç¨‹é—´çš„ç«äº‰ï¼Œäºæ˜¯æŠŠè¿™äº›å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„é˜Ÿåˆ—é‡Œï¼Œå¹¶ä¸ºæ¯ä¸ªé˜Ÿåˆ—åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œçº¿ç¨‹å’Œé˜Ÿåˆ—ä¸€ä¸€å¯¹åº”ï¼Œæ¯”å¦‚Açº¿ç¨‹è´Ÿè´£å¤„ç†Aé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯æœ‰çš„çº¿ç¨‹ä¼šå…ˆæŠŠè‡ªå·±é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¹²å®Œï¼Œè€Œå…¶ä»–çº¿ç¨‹å¯¹åº”çš„é˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡ç­‰å¾…å¤„ç†ã€‚å¹²å®Œæ´»çš„çº¿ç¨‹ä¸å…¶ç­‰ç€ï¼Œä¸å¦‚å»å¸®å…¶ä»–çº¿ç¨‹å¹²æ´»ï¼Œäºæ˜¯å®ƒå°±å»å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—é‡Œçªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚è€Œåœ¨è¿™æ—¶å®ƒä»¬ä¼šè®¿é—®åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘çªƒå–ä»»åŠ¡çº¿ç¨‹å’Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œé€š<strong>å¸¸ä¼šä½¿ç”¨åŒç«¯é˜Ÿåˆ—</strong>ï¼Œ**<font color=red >è¢«çªƒå–ä»»åŠ¡çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–ä»»åŠ¡çš„çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œã€‚</font>**</p><h4 id="16-4-1-å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹"><a href="#16-4-1-å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹" class="headerlink" title="16.4.1 å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹"></a>16.4.1 å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹</h4><p>æ˜¯å……åˆ†åˆ©ç”¨çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå¹¶å‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ï¼Œ</p><h4 id="16-4-2-å·¥ä½œçªƒå–ç®—æ³•çš„ç¼ºç‚¹"><a href="#16-4-2-å·¥ä½œçªƒå–ç®—æ³•çš„ç¼ºç‚¹" class="headerlink" title="16.4.2 å·¥ä½œçªƒå–ç®—æ³•çš„ç¼ºç‚¹"></a>16.4.2 å·¥ä½œçªƒå–ç®—æ³•çš„ç¼ºç‚¹</h4><ul><li><p>åœ¨æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯å­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚åŒç«¯é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ã€‚</p></li><li><p>æ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚åˆ›å»ºå¤šä¸ªçº¿ç¨‹å’Œå¤šä¸ªåŒç«¯é˜Ÿåˆ—ã€‚</p></li></ul><h4 id="16-4-3-å®ç°åŸç†"><a href="#16-4-3-å®ç°åŸç†" class="headerlink" title="16.4.3 å®ç°åŸç†"></a>16.4.3 å®ç°åŸç†</h4><img src="https://oscimg.oschina.net/oscnet/up-b60c6d2ce35c06c2f20c0904e2b559b35ae.png" style="zoom:50%;" /><ol><li>ForkJoinPool çš„æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼ˆWorkQueueï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼ˆDequeï¼‰ï¼Œé‡Œé¢å­˜æ”¾çš„å¯¹è±¡æ˜¯ä»»åŠ¡ï¼ˆForkJoinTaskï¼‰ã€‚</li><li>æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨è¿è¡Œä¸­äº§ç”Ÿæ–°çš„ä»»åŠ¡ï¼ˆé€šå¸¸æ˜¯å› ä¸ºè°ƒç”¨äº† fork()ï¼‰æ—¶ï¼Œä¼šæ”¾å…¥å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ LIFO æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä»é˜Ÿå°¾å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚</li><li>æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—åŒæ—¶ï¼Œä¼šå°è¯•çªƒå–ä¸€ä¸ªä»»åŠ¡ï¼ˆæˆ–æ˜¯æ¥è‡ªäºåˆšåˆšæäº¤åˆ° pool çš„ä»»åŠ¡ï¼Œæˆ–æ˜¯æ¥è‡ªäºå…¶ä»–å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ï¼‰ï¼Œçªƒå–çš„ä»»åŠ¡ä½äºå…¶ä»–çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿé¦–ï¼Œä¹Ÿå°±æ˜¯è¯´å·¥ä½œçº¿ç¨‹åœ¨çªƒå–å…¶ä»–å·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ FIFO æ–¹å¼ã€‚</li><li>åœ¨é‡åˆ° join() æ—¶ï¼Œå¦‚æœéœ€è¦ join çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™ä¼šå…ˆå¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…å…¶å®Œæˆã€‚</li><li>åœ¨æ—¢æ²¡æœ‰è‡ªå·±çš„ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰å¯ä»¥çªƒå–çš„ä»»åŠ¡æ—¶ï¼Œè¿›å…¥ä¼‘çœ ã€‚</li></ol><h3 id="16-5-Fork-Joinæ¡†æ¶æ‰§è¡Œæµç¨‹"><a href="#16-5-Fork-Joinæ¡†æ¶æ‰§è¡Œæµç¨‹" class="headerlink" title="16.5 Fork/Joinæ¡†æ¶æ‰§è¡Œæµç¨‹"></a>16.5 <strong>Fork/Joinæ¡†æ¶æ‰§è¡Œæµç¨‹</strong></h3><p>ForkJoinPool ä¸­çš„ä»»åŠ¡æ‰§è¡Œåˆ†ä¸¤ç§:</p><ul><li>ç›´æ¥é€šè¿‡ FJP æäº¤çš„å¤–éƒ¨ä»»åŠ¡(external/submissions task)ï¼Œå­˜æ”¾åœ¨ workQueues çš„å¶æ•°æ§½ä½ï¼›</li><li>é€šè¿‡å†…éƒ¨ fork åˆ†å‰²çš„å­ä»»åŠ¡(Worker task)ï¼Œå­˜æ”¾åœ¨ workQueues çš„å¥‡æ•°æ§½ä½ã€‚</li></ul><p><img src="https://oscimg.oschina.net/oscnet/up-1d1b8b1a381557e4f2f5be8016fb76cef90.png"></p><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul><li><a href="https://note.youdao.com/ynoteshare/index.html?id=e59837f57323a12defbb62fa837b330d&type=note&_time=1641267390260">JMMè®²è§£&amp;volatile</a></li><li><a href="https://note.youdao.com/ynoteshare/index.html?id=73fc01483ff8b40c47d6898ad17a66c8&type=note&_time=1641280508219">MESIåè®®</a></li><li><a href="https://note.youdao.com/ynoteshare/index.html?id=ee257490aa10fc87bb8c3823ed1e5421&type=note&_time=1641289972738">å¹¶å‘ç¼–ç¨‹ä¹‹synchronizedè¯¦è§£</a></li><li><a href="https://note.youdao.com/ynoteshare/index.html?id=695b21d540f1a6c8c0dae11c4d696b1f&type=note&_time=1641371184468">æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨AQSåº”ç”¨Lockè¯¦è§£ã€æ›´å¤šè¯¾ç¨‹ zx-cc.netã€‘</a></li><li><a href="https://note.youdao.com/ynoteshare/index.html?id=3224c156c25f8efcc118d5492d8fcffe&type=note&_time=1641782731057">Atomicç±»&amp;Unsafeç±»</a></li><li><a href="https://note.youdao.com/ynoteshare/index.html?id=28dacf9b84f676f10db7641c2cff742c&type=note&_time=1641787658813">å¹¶å‘å®¹å™¨ä¹‹ConcurrentHashMap</a></li><li><a href="https://note.youdao.com/ynoteshare/index.html?id=251afb555eaeb23df333d276fded9f75&type=note&_time=1641890739630">å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± </a></li><li>[Fork/Join](<a href="https://note.youdao.com/ynoteshare/index.html?id=43491d79e1e5735d39b34b8f7a20c5c7&amp;type=note&amp;_time=1641968709155">https://note.youdao.com/ynoteshare/index.html?id=43491d79e1e5735d39b34b8f7a20c5c7&amp;type=note&amp;_time=1641968709155</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;2-volatileå…³é”®å­—&quot;&gt;&lt;a href=&quot;#2-volatileå…³é”®å­—&quot; class=&quot;headerlink&quot; title=&quot;2. volatileå…³é”®å­—&quot;&gt;&lt;/a&gt;2. volatileå…³é”®å­—&lt;/h2&gt;&lt;h3 id=&quot;2-1-volatileçš„ä½œç”¨&quot;&gt;&lt;a</summary>
      
    
    
    
    
    <category term="å¤šçº¿ç¨‹" scheme="http://example.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•</title>
    <link href="http://example.com/wiki/MySQL%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E6%97%B6%E4%BC%9A%E9%80%89%E9%94%99%E7%B4%A2%E5%BC%95/"/>
    <id>http://example.com/wiki/MySQL%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E6%97%B6%E4%BC%9A%E9%80%89%E9%94%99%E7%B4%A2%E5%BC%95/</id>
    <published>2021-12-07T11:48:16.000Z</published>
    <updated>2021-12-07T11:49:06.435Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•"><a href="#MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•" class="headerlink" title="MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•"></a>MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•</h1><p>å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ç´¢å¼•ï¼Œä½ å·²ç»çŸ¥é“äº†åœ¨MySQLä¸­ä¸€å¼ è¡¨å…¶å®æ˜¯å¯ä»¥æ”¯æŒå¤šä¸ªç´¢å¼•çš„ã€‚ä½†æ˜¯ï¼Œä½  å†™SQLè¯­å¥çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä¸»åŠ¨æŒ‡å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨å“ªä¸ªç´¢å¼•æ˜¯ç”±MySQLæ¥ç¡® å®šçš„ã€‚</p><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰ç¢°åˆ°è¿‡è¿™ç§æƒ…å†µï¼Œä¸€æ¡æœ¬æ¥å¯ä»¥æ‰§è¡Œå¾—å¾ˆå¿«çš„è¯­å¥ï¼Œå´ç”±äºMySQLé€‰é”™äº†ç´¢ å¼•ï¼Œè€Œå¯¼è‡´æ‰§è¡Œé€Ÿåº¦å˜å¾—å¾ˆæ…¢?</p><p>æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸ªä¾‹å­å§ã€‚ æˆ‘ä»¬å…ˆå»ºä¸€ä¸ªç®€å•çš„è¡¨ï¼Œè¡¨é‡Œæœ‰aã€bä¸¤ä¸ªå­—æ®µï¼Œå¹¶åˆ†åˆ«å»ºä¸Šç´¢å¼•:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `t` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `a` int(11) DEFAULT NULL,</span><br><span class="line">  `b` int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `a` (`a`),</span><br><span class="line">  KEY `b` (`b`)</span><br><span class="line">) ENGINE=InnoDB;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæˆ‘ä»¬å¾€è¡¨tä¸­æ’å…¥10ä¸‡è¡Œè®°å½•ï¼Œå–å€¼æŒ‰æ•´æ•°é€’å¢ï¼Œå³:(1,1,1)ï¼Œ(2,2,2)ï¼Œ(3,3,3) ç›´åˆ° (100000,100000,100000)ã€‚</p><p>æˆ‘æ˜¯ç”¨å­˜å‚¨è¿‡ç¨‹æ¥æ’å…¥æ•°æ®çš„ï¼Œè¿™é‡Œæˆ‘è´´å‡ºæ¥æ–¹ä¾¿ä½ å¤ç°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter ;;</span><br><span class="line">create procedure idata()</span><br><span class="line">begin</span><br><span class="line">  declare i int;</span><br><span class="line">  set i=1;</span><br><span class="line">  while(i&lt;=100000)do</span><br><span class="line">    insert into t values(i, i, i);</span><br><span class="line">    set i=i+1;</span><br><span class="line">  end while;</span><br><span class="line">end;;</span><br><span class="line">delimiter ;</span><br><span class="line">call idata();</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æä¸€æ¡SQLè¯­å¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t where a between 10000 and 20000;</span><br></pre></td></tr></table></figure><p>ä½ ä¸€å®šä¼šè¯´ï¼Œè¿™ä¸ªè¯­å¥è¿˜ç”¨åˆ†æå—ï¼Œå¾ˆç®€å•å‘€ï¼Œaä¸Šæœ‰ç´¢å¼•ï¼Œè‚¯å®šæ˜¯è¦ä½¿ç”¨ç´¢å¼•açš„ã€‚ ä½ è¯´å¾—æ²¡é”™ï¼Œå›¾1æ˜¾ç¤ºçš„å°±æ˜¯ä½¿ç”¨explainå‘½ä»¤çœ‹åˆ°çš„è¿™æ¡è¯­å¥çš„æ‰§è¡Œæƒ…å†µã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-45dfccea9790939067fb35e26f7155fce11.png"></p><p>ä»å›¾1çœ‹ä¸Šå»ï¼Œè¿™æ¡æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œä¹Ÿç¡®å®ç¬¦åˆé¢„æœŸï¼Œkeyè¿™ä¸ªå­—æ®µå€¼æ˜¯â€™aâ€™ï¼Œè¡¨ç¤ºä¼˜åŒ–å™¨é€‰æ‹©äº†ç´¢</p><p>å¼•aã€‚</p><p>ä¸è¿‡åˆ«æ€¥ï¼Œè¿™ä¸ªæ¡ˆä¾‹ä¸ä¼šè¿™ä¹ˆç®€å•ã€‚åœ¨æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½çš„åŒ…å«äº†10ä¸‡è¡Œæ•°æ®çš„è¡¨ä¸Šï¼Œæˆ‘ä»¬å†åš å¦‚ä¸‹æ“ä½œã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-8a91fd7aff5e63d7798db49127b6d2fd6fd.png"></p><p>è¿™é‡Œï¼Œsession Açš„æ“ä½œä½ å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œå®ƒå°±æ˜¯å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ã€‚éšåï¼Œsession BæŠŠæ•°æ®éƒ½åˆ </p><p>é™¤åï¼Œåˆè°ƒç”¨äº† idataè¿™ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œæ’å…¥äº†10ä¸‡è¡Œæ•°æ®ã€‚</p><p>è¿™æ—¶å€™ï¼Œsession Bçš„æŸ¥è¯¢è¯­å¥select * from t where a between 10000 and 20000å°±ä¸ä¼šå†é€‰æ‹©ç´¢å¼•aäº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—(slow log)æ¥æŸ¥çœ‹ä¸€ä¸‹å…·ä½“çš„æ‰§è¡Œæƒ…å†µã€‚</p><p>ä¸ºäº†è¯´æ˜ä¼˜åŒ–å™¨é€‰æ‹©çš„ç»“æœæ˜¯å¦æ­£ç¡®ï¼Œæˆ‘å¢åŠ äº†ä¸€ä¸ªå¯¹ç…§ï¼Œå³:ä½¿ç”¨force index(a)æ¥è®©ä¼˜åŒ–å™¨å¼º</p><p>åˆ¶ä½¿ç”¨ç´¢å¼•a(è¿™éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘è¿˜ä¼šåœ¨è¿™ç¯‡æ–‡ç« çš„ååŠéƒ¨åˆ†ä¸­æåˆ°)ã€‚ ä¸‹é¢çš„ä¸‰æ¡SQLè¯­å¥ï¼Œå°±æ˜¯è¿™ä¸ªå®éªŒè¿‡ç¨‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set long_query_time=0;</span><br><span class="line">select * from t where a between 10000 and 20000; /*Q1*/</span><br><span class="line">select * from t force index(a) where a between 10000 and 20000;/*Q2*/</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€å¥ï¼Œæ˜¯å°†æ…¢æŸ¥è¯¢æ—¥å¿—çš„é˜ˆå€¼è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºè¿™ä¸ªçº¿ç¨‹æ¥ä¸‹æ¥çš„è¯­å¥éƒ½ä¼šè¢«è®°å½•å…¥æ…¢æŸ¥è¯¢æ—¥ å¿—ä¸­;</li><li> ç¬¬äºŒå¥ï¼ŒQ1æ˜¯session BåŸæ¥çš„æŸ¥è¯¢;</li><li> ç¬¬ä¸‰å¥ï¼ŒQ2æ˜¯åŠ äº†force index(a)æ¥å’Œsession BåŸæ¥çš„æŸ¥è¯¢è¯­å¥æ‰§è¡Œæƒ…å†µå¯¹æ¯”ã€‚</li></ul><p>å¦‚å›¾3æ‰€ç¤ºæ˜¯è¿™ä¸‰æ¡SQLè¯­å¥æ‰§è¡Œå®Œæˆåçš„æ…¢æŸ¥è¯¢æ—¥å¿—ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-6d0b7f98193f539ed902b463d2660b305b6.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒQ1æ‰«æäº†10ä¸‡è¡Œï¼Œæ˜¾ç„¶æ˜¯èµ°äº†å…¨è¡¨æ‰«æï¼Œæ‰§è¡Œæ—¶é—´æ˜¯40æ¯«ç§’ã€‚Q2æ‰«æäº†10001è¡Œï¼Œ</p><p>æ‰§è¡Œäº†21æ¯«ç§’ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨æ²¡æœ‰ä½¿ç”¨force indexçš„æ—¶å€™ï¼ŒMySQLç”¨é”™äº†ç´¢å¼•ï¼Œå¯¼è‡´äº†æ›´é•¿çš„æ‰§è¡Œæ—¶é—´ã€‚</p><p>è¿™ä¸ªä¾‹å­å¯¹åº”çš„æ˜¯æˆ‘ä»¬å¹³å¸¸ä¸æ–­åœ°åˆ é™¤å†å²æ•°æ®å’Œæ–°å¢æ•°æ®çš„åœºæ™¯ã€‚è¿™æ—¶ï¼ŒMySQLç«Ÿç„¶ä¼šé€‰é”™ç´¢å¼•ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å¥‡æ€ªå‘¢?ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªå¥‡æ€ªçš„ç»“æœè¯´èµ·å§ã€‚</p><h2 id="ä¼˜åŒ–å™¨çš„é€»è¾‘"><a href="#ä¼˜åŒ–å™¨çš„é€»è¾‘" class="headerlink" title="ä¼˜åŒ–å™¨çš„é€»è¾‘"></a>ä¼˜åŒ–å™¨çš„é€»è¾‘</h2><p>åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°±æåˆ°è¿‡ï¼Œé€‰æ‹©ç´¢å¼•æ˜¯ä¼˜åŒ–å™¨çš„å·¥ä½œã€‚</p><p>è€Œä¼˜åŒ–å™¨é€‰æ‹©ç´¢å¼•çš„ç›®çš„ï¼Œæ˜¯æ‰¾åˆ°ä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œæ–¹æ¡ˆï¼Œå¹¶ç”¨æœ€å°çš„ä»£ä»·å»æ‰§è¡Œè¯­å¥ã€‚åœ¨æ•°æ®åº“é‡Œé¢ï¼Œ<strong>æ‰«æè¡Œæ•°æ˜¯å½±å“æ‰§è¡Œä»£ä»·çš„å› ç´ ä¹‹ä¸€</strong>ã€‚æ‰«æçš„è¡Œæ•°è¶Šå°‘ï¼Œæ„å‘³ç€è®¿é—®ç£ç›˜æ•°æ®çš„æ¬¡æ•°è¶Š å°‘ï¼Œæ¶ˆè€—çš„CPUèµ„æºè¶Šå°‘ã€‚</p><p>å½“ç„¶ï¼Œæ‰«æè¡Œæ•°å¹¶ä¸æ˜¯å”¯ä¸€çš„åˆ¤æ–­æ ‡å‡†ï¼Œ<strong>ä¼˜åŒ–å™¨è¿˜ä¼šç»“åˆæ˜¯å¦ä½¿ç”¨ä¸´æ—¶è¡¨ã€æ˜¯å¦æ’åºç­‰å› ç´ è¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚</strong></p><p>æˆ‘ä»¬è¿™ä¸ªç®€å•çš„æŸ¥è¯¢è¯­å¥å¹¶æ²¡æœ‰æ¶‰åŠåˆ°ä¸´æ—¶è¡¨å’Œæ’åºï¼Œæ‰€ä»¥MySQLé€‰é”™ç´¢å¼•è‚¯å®šæ˜¯åœ¨åˆ¤æ–­æ‰«æè¡Œæ•°çš„æ—¶å€™å‡ºé—®é¢˜äº†ã€‚</p><h3 id="é‚£ä¹ˆï¼Œé—®é¢˜å°±æ˜¯-æ‰«æè¡Œæ•°æ˜¯æ€ä¹ˆåˆ¤æ–­çš„"><a href="#é‚£ä¹ˆï¼Œé—®é¢˜å°±æ˜¯-æ‰«æè¡Œæ•°æ˜¯æ€ä¹ˆåˆ¤æ–­çš„" class="headerlink" title="é‚£ä¹ˆï¼Œé—®é¢˜å°±æ˜¯:æ‰«æè¡Œæ•°æ˜¯æ€ä¹ˆåˆ¤æ–­çš„?"></a><font color=red>é‚£ä¹ˆï¼Œé—®é¢˜å°±æ˜¯:æ‰«æè¡Œæ•°æ˜¯æ€ä¹ˆåˆ¤æ–­çš„?</font></h3><p> MySQLåœ¨çœŸæ­£å¼€å§‹æ‰§è¡Œè¯­å¥ä¹‹å‰ï¼Œå¹¶ä¸èƒ½ç²¾ç¡®åœ°çŸ¥é“æ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„è®°å½•æœ‰å¤šå°‘æ¡ï¼Œè€Œåªèƒ½æ ¹æ®ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°ç®—è®°å½•æ•°ã€‚</p><p>è¿™ä¸ªç»Ÿè®¡ä¿¡æ¯å°±æ˜¯ç´¢å¼•çš„â€œåŒºåˆ†åº¦â€ã€‚æ˜¾ç„¶ï¼Œä¸€ä¸ªç´¢å¼•ä¸Šä¸åŒçš„å€¼è¶Šå¤šï¼Œè¿™ä¸ªç´¢å¼•çš„åŒºåˆ†åº¦å°±è¶Šå¥½ã€‚</p><p>è€Œä¸€ä¸ªç´¢å¼•ä¸Šä¸åŒçš„å€¼çš„ä¸ªæ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œåŸºæ•°â€(cardinality)ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªåŸºæ•°è¶Š å¤§ï¼Œç´¢å¼•çš„åŒºåˆ†åº¦è¶Šå¥½ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>show index</code>æ–¹æ³•ï¼Œçœ‹åˆ°ä¸€ä¸ªç´¢å¼•çš„åŸºæ•°ã€‚</p><p>å¦‚å›¾4æ‰€ç¤ºï¼Œå°±æ˜¯è¡¨tçš„show index çš„ç»“æœ ã€‚è™½ç„¶è¿™ä¸ªè¡¨çš„æ¯ä¸€è¡Œçš„ä¸‰ä¸ªå­—æ®µå€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯åœ¨ç»Ÿè®¡ä¿¡æ¯ä¸­ï¼Œè¿™ä¸‰ä¸ªç´¢å¼•çš„åŸºæ•°å€¼å¹¶ä¸ åŒï¼Œè€Œä¸”å…¶å®éƒ½ä¸å‡†ç¡®ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-6cf5345e7c9034a3953e7f1b4227f4cc8cc.png"></p><h3 id="é‚£ä¹ˆï¼ŒMySQLæ˜¯æ€æ ·å¾—åˆ°ç´¢å¼•çš„åŸºæ•°çš„å‘¢"><a href="#é‚£ä¹ˆï¼ŒMySQLæ˜¯æ€æ ·å¾—åˆ°ç´¢å¼•çš„åŸºæ•°çš„å‘¢" class="headerlink" title="é‚£ä¹ˆï¼ŒMySQLæ˜¯æ€æ ·å¾—åˆ°ç´¢å¼•çš„åŸºæ•°çš„å‘¢?"></a><strong>é‚£ä¹ˆï¼ŒMySQLæ˜¯æ€æ ·å¾—åˆ°ç´¢å¼•çš„åŸºæ•°çš„å‘¢?</strong></h3><p>è¿™é‡Œï¼Œæˆ‘ç»™ä½ ç®€å•ä»‹ç»ä¸€ä¸‹MySQLé‡‡æ ·ç»Ÿè®¡çš„æ–¹æ³•ã€‚ ä¸ºä»€ä¹ˆè¦é‡‡æ ·ç»Ÿè®¡å‘¢?  å› ä¸ºæŠŠæ•´å¼ è¡¨å–å‡ºæ¥ä¸€è¡Œè¡Œç»Ÿè®¡ï¼Œè™½ç„¶å¯ä»¥å¾—åˆ°ç²¾ç¡®çš„ç»“æœï¼Œä½†æ˜¯ä»£ä»·å¤ª</p><p>é«˜äº†ï¼Œæ‰€ä»¥åªèƒ½é€‰æ‹©â€œé‡‡æ ·ç»Ÿè®¡â€ã€‚ é‡‡æ ·ç»Ÿè®¡çš„æ—¶å€™ï¼ŒInnoDBé»˜è®¤ä¼šé€‰æ‹©Nä¸ªæ•°æ®é¡µï¼Œç»Ÿè®¡è¿™äº›é¡µé¢ä¸Šçš„ä¸åŒå€¼ï¼Œå¾—åˆ°ä¸€ä¸ªå¹³å‡å€¼ï¼Œç„¶åä¹˜ä»¥è¿™ä¸ªç´¢å¼•çš„é¡µé¢æ•°ï¼Œå°±å¾—åˆ°äº†è¿™ä¸ªç´¢å¼•çš„åŸºæ•°ã€‚</p><p>è€Œæ•°æ®è¡¨æ˜¯ä¼šæŒç»­æ›´æ–°çš„ï¼Œç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ä¹Ÿä¸ä¼šå›ºå®šä¸å˜ã€‚æ‰€ä»¥ï¼Œå½“å˜æ›´çš„æ•°æ®è¡Œæ•°è¶…è¿‡1/Mçš„ æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è§¦å‘é‡æ–°åšä¸€æ¬¡ç´¢å¼•ç»Ÿè®¡ã€‚</p><p>åœ¨MySQLä¸­ï¼Œæœ‰ä¸¤ç§å­˜å‚¨ç´¢å¼•ç»Ÿè®¡çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°innodb_stats_persistentçš„å€¼æ¥é€‰æ‹©:</p><ul><li>è®¾ç½®ä¸ºonçš„æ—¶å€™ï¼Œè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯ä¼šæŒä¹…åŒ–å­˜å‚¨ã€‚è¿™æ—¶ï¼Œé»˜è®¤çš„Næ˜¯20ï¼ŒMæ˜¯10ã€‚ </li><li>è®¾ç½®ä¸ºoffçš„æ—¶å€™ï¼Œè¡¨ç¤ºç»Ÿè®¡ä¿¡æ¯åªå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚è¿™æ—¶ï¼Œé»˜è®¤çš„Næ˜¯8ï¼ŒMæ˜¯16ã€‚</li></ul><p>ç”±äºæ˜¯é‡‡æ ·ç»Ÿè®¡ï¼Œæ‰€ä»¥ä¸ç®¡Næ˜¯20è¿˜æ˜¯8ï¼Œè¿™ä¸ªåŸºæ•°éƒ½æ˜¯å¾ˆå®¹æ˜“ä¸å‡†çš„ã€‚ ä½†ï¼Œè¿™è¿˜ä¸æ˜¯å…¨éƒ¨ã€‚</p><p>ä½ å¯ä»¥ä»å›¾4ä¸­çœ‹åˆ°ï¼Œè¿™æ¬¡çš„ç´¢å¼•ç»Ÿè®¡å€¼(cardinalityåˆ—)è™½ç„¶ä¸å¤Ÿç²¾ç¡®ï¼Œä½†å¤§ä½“ä¸Šè¿˜æ˜¯å·®ä¸å¤š çš„ï¼Œé€‰é”™ç´¢å¼•ä¸€å®šè¿˜æœ‰åˆ«çš„åŸå› ã€‚</p><p>å…¶å®ç´¢å¼•ç»Ÿè®¡åªæ˜¯ä¸€ä¸ªè¾“å…¥ï¼Œå¯¹äºä¸€ä¸ªå…·ä½“çš„è¯­å¥æ¥è¯´ï¼Œä¼˜åŒ–å™¨è¿˜è¦åˆ¤æ–­ï¼Œæ‰§è¡Œè¿™ä¸ªè¯­å¥æœ¬èº«è¦ æ‰«æå¤šå°‘è¡Œã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†ä¸€èµ·çœ‹çœ‹ä¼˜åŒ–å™¨é¢„ä¼°çš„ï¼Œè¿™ä¸¤ä¸ªè¯­å¥çš„æ‰«æè¡Œæ•°æ˜¯å¤šå°‘ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-5ef0aee057f2071d38388ec66b71d8f2b01.png"></p><p>rowsè¿™ä¸ªå­—æ®µè¡¨ç¤ºçš„æ˜¯é¢„è®¡æ‰«æè¡Œæ•°ã€‚</p><p>å…¶ä¸­ï¼ŒQ1çš„ç»“æœè¿˜æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œrowsçš„å€¼æ˜¯104620;ä½†æ˜¯Q2çš„rowså€¼æ˜¯37116ï¼Œåå·®å°±å¤§äº†ã€‚è€Œå›¾1ä¸­æˆ‘ä»¬ç”¨explainå‘½ä»¤çœ‹åˆ°çš„rowsæ˜¯åªæœ‰10001è¡Œï¼Œæ˜¯è¿™ä¸ªåå·®è¯¯å¯¼äº†ä¼˜åŒ–å™¨çš„åˆ¤æ–­ã€‚</p><p>åˆ°è¿™é‡Œï¼Œå¯èƒ½ä½ çš„ç¬¬ä¸€ä¸ªç–‘é—®ä¸æ˜¯ä¸ºä»€ä¹ˆä¸å‡†ï¼Œè€Œæ˜¯ä¼˜åŒ–å™¨ä¸ºä»€ä¹ˆæ”¾ç€æ‰«æ37000è¡Œçš„æ‰§è¡Œè®¡åˆ’ä¸ç”¨ï¼Œå´é€‰æ‹©äº†æ‰«æè¡Œæ•°æ˜¯100000çš„æ‰§è¡Œè®¡åˆ’å‘¢?</p><p>è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœä½¿ç”¨ç´¢å¼•aï¼Œæ¯æ¬¡ä»ç´¢å¼•aä¸Šæ‹¿åˆ°ä¸€ä¸ªå€¼ï¼Œéƒ½è¦å›åˆ°ä¸»é”®ç´¢å¼•ä¸ŠæŸ¥å‡ºæ•´è¡Œæ•°æ®ï¼Œ è¿™ä¸ªä»£ä»·ä¼˜åŒ–å™¨ä¹Ÿè¦ç®—è¿›å»çš„ã€‚</p><p>è€Œå¦‚æœé€‰æ‹©æ‰«æ10ä¸‡è¡Œï¼Œæ˜¯ç›´æ¥åœ¨ä¸»é”®ç´¢å¼•ä¸Šæ‰«æçš„ï¼Œæ²¡æœ‰é¢å¤–çš„ä»£ä»·ã€‚ ä¼˜åŒ–å™¨ä¼šä¼°ç®—è¿™ä¸¤ä¸ªé€‰æ‹©çš„ä»£ä»·ï¼Œä»ç»“æœçœ‹æ¥ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºç›´æ¥æ‰«æä¸»é”®ç´¢å¼•æ›´å¿«ã€‚å½“ç„¶ï¼Œä»æ‰§è¡Œæ—¶é—´çœ‹æ¥ï¼Œè¿™ä¸ªé€‰æ‹©å¹¶ä¸æ˜¯æœ€ä¼˜çš„ã€‚ </p><blockquote><p><strong>ä½¿ç”¨æ™®é€šç´¢å¼•éœ€è¦æŠŠå›è¡¨çš„ä»£ä»·ç®—è¿›å»</strong></p></blockquote><p>åœ¨å›¾1æ‰§è¡Œexplainçš„æ—¶å€™ï¼Œä¹Ÿè€ƒè™‘äº†è¿™ä¸ªç­–ç•¥çš„ä»£ä»· ï¼Œä½†å›¾1çš„é€‰æ‹©æ˜¯å¯¹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªç­–ç•¥å¹¶æ²¡æœ‰é—®é¢˜ã€‚ æ‰€ä»¥å†¤æœ‰å¤´å€ºæœ‰ä¸»ï¼ŒMySQLé€‰é”™ç´¢å¼•ï¼Œè¿™ä»¶äº‹å„¿</p><p>è¿˜å¾—å½’å’åˆ°æ²¡èƒ½å‡†ç¡®åœ°åˆ¤æ–­å‡ºæ‰«æè¡Œæ•°ã€‚</p><p>æ—¢ç„¶æ˜¯ç»Ÿè®¡ä¿¡æ¯ä¸å¯¹ï¼Œé‚£å°±ä¿®æ­£ã€‚<code>analyze table t</code> å‘½ä»¤ï¼Œå¯ä»¥ç”¨æ¥é‡æ–°ç»Ÿè®¡ç´¢å¼•ä¿¡æ¯ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ ä¸€ä¸‹æ‰§è¡Œæ•ˆæœã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-770cd142953256e165de08dd8f0e5c2fa3b.png"></p><p>æ‰€ä»¥åœ¨å®è·µä¸­ï¼Œå¦‚æœä½ å‘ç°explainçš„ç»“æœé¢„ä¼°çš„rowså€¼è·Ÿå®é™…æƒ…å†µå·®è·æ¯”è¾ƒå¤§ï¼Œå¯ä»¥é‡‡ç”¨è¿™ä¸ª æ–¹æ³•æ¥å¤„ç†ã€‚</p><p>å…¶å®ï¼Œå¦‚æœåªæ˜¯ç´¢å¼•ç»Ÿè®¡ä¸å‡†ç¡®ï¼Œé€šè¿‡analyzeå‘½ä»¤å¯ä»¥è§£å†³å¾ˆå¤šé—®é¢˜ï¼Œä½†æ˜¯å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œä¼˜ åŒ–å™¨å¯ä¸æ­¢æ˜¯çœ‹æ‰«æè¡Œæ•°ã€‚</p><p>ä¾ç„¶æ˜¯åŸºäºè¿™ä¸ªè¡¨tï¼Œæˆ‘ä»¬çœ‹çœ‹å¦å¤–ä¸€ä¸ªè¯­å¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t where (a between 1 and 1000)  and (b between 50000 and 100000) order by b limit 1</span><br></pre></td></tr></table></figure><p>ä»æ¡ä»¶ä¸Šçœ‹ï¼Œè¿™ä¸ªæŸ¥è¯¢æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå› æ­¤ä¼šè¿”å›ç©ºé›†åˆã€‚ åœ¨å¼€å§‹æ‰§è¡Œè¿™æ¡è¯­å¥ä¹‹å‰ï¼Œä½ å¯ä»¥å…ˆè®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ æ¥é€‰æ‹©ç´¢å¼•ï¼Œä¼šé€‰æ‹©å“ªä¸€ä¸ªå‘¢? </p><p>ä¸ºäº†ä¾¿äºåˆ†æï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹aã€bè¿™ä¸¤ä¸ªç´¢å¼•çš„ç»“æ„å›¾ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-6988e9b1a37bda5f715216d0131f2face47.png"></p><p>å¦‚æœä½¿ç”¨ç´¢å¼•aè¿›è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰«æç´¢å¼•açš„å‰1000ä¸ªå€¼ï¼Œç„¶åå–åˆ°å¯¹åº”çš„idï¼Œå†åˆ°ä¸»é”®ç´¢</p><p>å¼•ä¸Šå»æŸ¥å‡ºæ¯ä¸€è¡Œï¼Œç„¶åæ ¹æ®å­—æ®µbæ¥è¿‡æ»¤ã€‚æ˜¾ç„¶è¿™æ ·éœ€è¦æ‰«æ1000è¡Œã€‚ å¦‚æœä½¿ç”¨ç´¢å¼•bè¿›è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰«æç´¢å¼•bçš„æœ€å50001ä¸ªå€¼ï¼Œä¸ä¸Šé¢çš„æ‰§è¡Œè¿‡ç¨‹ç›¸åŒï¼Œä¹Ÿæ˜¯</p><p>éœ€è¦å›åˆ°ä¸»é”®ç´¢å¼•ä¸Šå–å€¼å†åˆ¤æ–­ï¼Œæ‰€ä»¥éœ€è¦æ‰«æ50001è¡Œã€‚</p><p>æ‰€ä»¥ä½ ä¸€å®šä¼šæƒ³ï¼Œå¦‚æœä½¿ç”¨ç´¢å¼•açš„è¯ï¼Œæ‰§è¡Œé€Ÿåº¦æ˜æ˜¾ä¼šå¿«å¾ˆå¤šã€‚é‚£ä¹ˆï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹åˆ°åº• æ˜¯ä¸æ˜¯è¿™ä¹ˆä¸€å›äº‹å„¿ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-bbcf622b5cb93c997f77d3bd2c25cc9796a.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿”å›ç»“æœä¸­keyå­—æ®µæ˜¾ç¤ºï¼Œè¿™æ¬¡ä¼˜åŒ–å™¨é€‰æ‹©äº†ç´¢å¼•bï¼Œè€Œrowså­—æ®µæ˜¾ç¤ºéœ€è¦æ‰«æçš„è¡Œ</p><p>æ•°æ˜¯50198ã€‚ ä»è¿™ä¸ªç»“æœä¸­ï¼Œä½ å¯ä»¥å¾—åˆ°ä¸¤ä¸ªç»“è®º:</p><ul><li>æ‰«æè¡Œæ•°çš„ä¼°è®¡å€¼ä¾ç„¶ä¸å‡†ç¡®;</li><li>è¿™ä¸ªä¾‹å­é‡ŒMySQLåˆé€‰é”™äº†ç´¢å¼•</li></ul><h2 id="ç´¢å¼•é€‰æ‹©å¼‚å¸¸å’Œå¤„ç†"><a href="#ç´¢å¼•é€‰æ‹©å¼‚å¸¸å’Œå¤„ç†" class="headerlink" title="ç´¢å¼•é€‰æ‹©å¼‚å¸¸å’Œå¤„ç†"></a>ç´¢å¼•é€‰æ‹©å¼‚å¸¸å’Œå¤„ç†</h2><p>å…¶å®å¤§å¤šæ•°æ—¶å€™ä¼˜åŒ–å™¨éƒ½èƒ½æ‰¾åˆ°æ­£ç¡®çš„ç´¢å¼•ï¼Œä½†å¶å°”ä½ è¿˜æ˜¯ä¼šç¢°åˆ°æˆ‘ä»¬ä¸Šé¢ä¸¾ä¾‹çš„è¿™ä¸¤ç§æƒ…å†µ: åŸæœ¬å¯ä»¥æ‰§è¡Œå¾—å¾ˆå¿«çš„SQLè¯­å¥ï¼Œæ‰§è¡Œé€Ÿåº¦å´æ¯”ä½ é¢„æœŸçš„æ…¢å¾ˆå¤šï¼Œä½ åº”è¯¥æ€ä¹ˆåŠå‘¢?</p><p>ä¸€ç§æ–¹æ³•æ˜¯ï¼Œåƒæˆ‘ä»¬ç¬¬ä¸€ä¸ªä¾‹å­ä¸€æ ·ï¼Œé‡‡ç”¨force indexå¼ºè¡Œé€‰æ‹©ä¸€ä¸ªç´¢å¼•ã€‚MySQLä¼šæ ¹æ® è¯æ³•è§£æçš„ç»“æœåˆ†æå‡ºå¯èƒ½å¯ä»¥ä½¿ç”¨çš„ç´¢å¼•ä½œä¸ºå€™é€‰é¡¹ï¼Œç„¶ååœ¨å€™é€‰åˆ—è¡¨ä¸­ä¾æ¬¡åˆ¤æ–­æ¯ä¸ªç´¢å¼•éœ€ è¦æ‰«æå¤šå°‘è¡Œã€‚å¦‚æœforce indexæŒ‡å®šçš„ç´¢å¼•åœ¨å€™é€‰ç´¢å¼•åˆ—è¡¨ä¸­ï¼Œå°±ç›´æ¥é€‰æ‹©è¿™ä¸ªç´¢å¼•ï¼Œä¸å†è¯„ä¼° å…¶ä»–ç´¢å¼•çš„æ‰§è¡Œä»£ä»·ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬äºŒä¸ªä¾‹å­ã€‚åˆšå¼€å§‹åˆ†ææ—¶ï¼Œæˆ‘ä»¬è®¤ä¸ºé€‰æ‹©ç´¢å¼•aä¼šæ›´å¥½ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹æ‰§è¡Œ æ•ˆæœ:</p><p><img src="https://oscimg.oschina.net/oscnet/up-2953174a3c3cf4fdc4d9c8f2a8975a904cd.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ¬è¯­å¥éœ€è¦æ‰§è¡Œ2.23ç§’ï¼Œè€Œå½“ä½ ä½¿ç”¨force index(a)çš„æ—¶å€™ï¼Œåªç”¨äº†0.05ç§’ï¼Œæ¯”ä¼˜åŒ–</p><p>å™¨çš„é€‰æ‹©å¿«äº†40å¤šå€ã€‚<br> ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼˜åŒ–å™¨æ²¡æœ‰é€‰æ‹©æ­£ç¡®çš„ç´¢å¼•ï¼Œforce indexèµ·åˆ°äº†â€œçŸ«æ­£â€çš„ä½œç”¨ã€‚ ä¸è¿‡å¾ˆå¤šç¨‹åºå‘˜ä¸å–œæ¬¢ä½¿ç”¨force indexï¼Œä¸€æ¥è¿™ä¹ˆå†™ä¸ä¼˜ç¾ï¼ŒäºŒæ¥å¦‚æœç´¢å¼•æ”¹äº†åå­—ï¼Œè¿™ä¸ªè¯­å¥ä¹Ÿå¾—æ”¹ï¼Œæ˜¾å¾—å¾ˆéº»çƒ¦ã€‚è€Œä¸”å¦‚æœä»¥åè¿ç§»åˆ°åˆ«çš„æ•°æ®åº“çš„è¯ï¼Œè¿™ä¸ªè¯­æ³•è¿˜å¯èƒ½ä¼šä¸å…¼å®¹ã€‚</p><blockquote><p>ä½†å…¶å®ä½¿ç”¨force indexæœ€ä¸»è¦çš„é—®é¢˜è¿˜æ˜¯å˜æ›´çš„åŠæ—¶æ€§ã€‚å› ä¸ºé€‰é”™ç´¢å¼•çš„æƒ…å†µè¿˜æ˜¯æ¯”è¾ƒå°‘å‡ºç° çš„ï¼Œæ‰€ä»¥å¼€å‘çš„æ—¶å€™é€šå¸¸ä¸ä¼šå…ˆå†™ä¸Šforce indexã€‚è€Œæ˜¯ç­‰åˆ°çº¿ä¸Šå‡ºç°é—®é¢˜çš„æ—¶å€™ï¼Œä½ æ‰ä¼šå†å»ä¿® æ”¹SQLè¯­å¥ã€åŠ ä¸Šforce indexã€‚ä½†æ˜¯ä¿®æ”¹ä¹‹åè¿˜è¦æµ‹è¯•å’Œå‘å¸ƒï¼Œå¯¹äºç”Ÿäº§ç³»ç»Ÿæ¥è¯´ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸å¤Ÿæ•æ·ã€‚</p></blockquote><p>æ‰€ä»¥ï¼Œæ•°æ®åº“çš„é—®é¢˜æœ€å¥½è¿˜æ˜¯åœ¨æ•°æ®åº“å†…éƒ¨æ¥è§£å†³ã€‚é‚£ä¹ˆï¼Œåœ¨æ•°æ®åº“é‡Œé¢è¯¥æ€æ ·è§£å†³å‘¢?</p><p>æ—¢ç„¶ä¼˜åŒ–å™¨æ”¾å¼ƒäº†ä½¿ç”¨ç´¢å¼•aï¼Œè¯´æ˜aè¿˜ä¸å¤Ÿåˆé€‚ï¼Œæ‰€ä»¥ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¿®æ”¹ è¯­å¥ï¼Œå¼•å¯¼MySQLä½¿ç”¨æˆ‘ä»¬æœŸæœ›çš„ç´¢å¼•ã€‚æ¯”å¦‚ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæ˜¾ç„¶æŠŠâ€œorderbyblimit1â€æ”¹ æˆ â€œorder by b,a limit 1â€ ï¼Œè¯­ä¹‰çš„é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹æ”¹ä¹‹åçš„æ•ˆæœ:</p><p><img src="https://oscimg.oschina.net/oscnet/up-697b792f8cd9e11b702ee9c5d2b8362f152.png"></p><p>ä¹‹å‰ä¼˜åŒ–å™¨é€‰æ‹©ä½¿ç”¨ç´¢å¼•bï¼Œæ˜¯å› ä¸ºå®ƒè®¤ä¸ºä½¿ç”¨ç´¢å¼•bå¯ä»¥é¿å…æ’åº(bæœ¬èº«æ˜¯ç´¢å¼•ï¼Œå·²ç»æ˜¯æœ‰åº</p><p>çš„äº†ï¼Œå¦‚æœé€‰æ‹©ç´¢å¼•bçš„è¯ï¼Œä¸éœ€è¦å†åšæ’åºï¼Œåªéœ€è¦éå†)ï¼Œæ‰€ä»¥å³ä½¿æ‰«æè¡Œæ•°å¤šï¼Œä¹Ÿåˆ¤å®šä¸º ä»£ä»·æ›´å°ã€‚</p><p>ç°åœ¨order by b,a è¿™ç§å†™æ³•ï¼Œè¦æ±‚æŒ‰ç…§b,aæ’åºï¼Œå°±æ„å‘³ç€ä½¿ç”¨è¿™ä¸¤ä¸ªç´¢å¼•éƒ½éœ€è¦æ’åºã€‚å› æ­¤ï¼Œæ‰« æè¡Œæ•°æˆäº†å½±å“å†³ç­–çš„ä¸»è¦æ¡ä»¶ï¼Œäºæ˜¯æ­¤æ—¶ä¼˜åŒ–å™¨é€‰äº†åªéœ€è¦æ‰«æ1000è¡Œçš„ç´¢å¼•aã€‚</p><p>å½“ç„¶ï¼Œè¿™ç§ä¿®æ”¹å¹¶ä¸æ˜¯é€šç”¨çš„ä¼˜åŒ–æ‰‹æ®µï¼Œåªæ˜¯åˆšå¥½åœ¨è¿™ä¸ªè¯­å¥é‡Œé¢æœ‰limit 1ï¼Œå› æ­¤å¦‚æœæœ‰æ»¡è¶³æ¡ ä»¶çš„è®°å½•ï¼Œ order by b limit 1å’Œorder by b,a limit 1 éƒ½ä¼šè¿”å›bæ˜¯æœ€å°çš„é‚£ä¸€è¡Œï¼Œé€»è¾‘ä¸Šä¸€è‡´ï¼Œæ‰ å¯ä»¥è¿™ä¹ˆåšã€‚</p><p>å¦‚æœä½ è§‰å¾—ä¿®æ”¹è¯­ä¹‰è¿™ä»¶äº‹å„¿ä¸å¤ªå¥½ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ç§æ”¹æ³•ï¼Œå›¾11æ˜¯æ‰§è¡Œæ•ˆæœã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-bb1eee544d4ffe4a4dd3a74e15f4aa08538.png"></p><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬ç”¨limit 100è®©ä¼˜åŒ–å™¨æ„è¯†åˆ°ï¼Œä½¿ç”¨bç´¢å¼•ä»£ä»·æ˜¯å¾ˆé«˜çš„ã€‚å…¶å®æ˜¯æˆ‘ä»¬æ ¹æ®<strong>æ•°æ®ç‰¹å¾è¯±å¯¼äº†ä¸€ä¸‹ä¼˜åŒ–å™¨</strong>ï¼Œä¹Ÿä¸å…·å¤‡é€šç”¨æ€§ã€‚</p><p><strong>ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ï¼Œåœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªæ›´åˆé€‚çš„ç´¢å¼•ï¼Œæ¥æä¾›ç»™ä¼˜åŒ–å™¨åšé€‰ æ‹©ï¼Œæˆ–åˆ æ‰è¯¯ç”¨çš„ç´¢å¼•ã€‚</strong></p><p>ä¸è¿‡ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°é€šè¿‡æ–°å¢ç´¢å¼•æ¥æ”¹å˜ä¼˜åŒ–å™¨è¡Œä¸ºçš„æ–¹æ³•ã€‚è¿™ç§æƒ…å†µå…¶å®æ¯”è¾ƒ å°‘ï¼Œå°¤å…¶æ˜¯ç»è¿‡DBAç´¢å¼•ä¼˜åŒ–è¿‡çš„åº“ï¼Œå†ç¢°åˆ°è¿™ä¸ªbugï¼Œæ‰¾åˆ°ä¸€ä¸ªæ›´åˆé€‚çš„ç´¢å¼•ä¸€èˆ¬æ¯”è¾ƒéš¾ã€‚</p><p>å¦‚æœæˆ‘è¯´è¿˜æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯åˆ æ‰ç´¢å¼•bï¼Œä½ å¯èƒ½ä¼šè§‰å¾—å¥½ç¬‘ã€‚ä½†å®é™…ä¸Šæˆ‘ç¢°åˆ°è¿‡ä¸¤æ¬¡è¿™æ ·çš„ä¾‹å­ï¼Œ æœ€ç»ˆæ˜¯DBAè·Ÿä¸šåŠ¡å¼€å‘æ²Ÿé€šåï¼Œå‘ç°è¿™ä¸ªä¼˜åŒ–å™¨é”™è¯¯é€‰æ‹©çš„ç´¢å¼•å…¶å®æ ¹æœ¬æ²¡æœ‰å¿…è¦å­˜åœ¨ï¼Œäºæ˜¯ å°±åˆ æ‰äº†è¿™ä¸ªç´¢å¼•ï¼Œä¼˜åŒ–å™¨ä¹Ÿå°±é‡æ–°é€‰æ‹©åˆ°äº†æ­£ç¡®çš„ç´¢å¼•ã€‚</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å‰é¢æˆ‘ä»¬åœ¨æ„é€ ç¬¬ä¸€ä¸ªä¾‹å­çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡session Açš„é…åˆï¼Œ è®©session Båˆ é™¤æ•°æ®ååˆé‡æ–°æ’å…¥äº†ä¸€éæ•°æ®ï¼Œç„¶åå°±å‘ç°explainç»“æœä¸­ï¼Œrowså­—æ®µä»10001 å˜æˆ37000å¤šã€‚</p><p>è€Œå¦‚æœæ²¡æœ‰session Açš„é…åˆï¼Œåªæ˜¯å•ç‹¬æ‰§è¡Œdelete from t ã€call idata()ã€explainè¿™ä¸‰å¥è¯ï¼Œä¼šçœ‹ åˆ°rowså­—æ®µå…¶å®è¿˜æ˜¯10000å·¦å³ã€‚ä½ å¯ä»¥è‡ªå·±éªŒè¯ä¸€ä¸‹è¿™ä¸ªç»“æœã€‚</p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ä¸ºä»€ä¹ˆç»è¿‡è¿™ä¸ªæ“ä½œåºåˆ—ï¼Œexplainçš„ç»“æœå°±ä¸å¯¹äº†?è¿™ é‡Œï¼Œæˆ‘æ¥ä¸ºä½ åˆ†æä¸€ä¸‹åŸå› ã€‚</p><p>delete è¯­å¥åˆ æ‰äº†æ‰€æœ‰çš„æ•°æ®ï¼Œç„¶åå†é€šè¿‡call idata()æ’å…¥äº†10ä¸‡è¡Œæ•°æ®ï¼Œçœ‹ä¸Šå»æ˜¯è¦†ç›–äº†åŸæ¥ çš„10ä¸‡è¡Œã€‚</p><p>ä½†æ˜¯ï¼Œ<strong>session Aå¼€å¯äº†äº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥ä¹‹å‰æ’å…¥çš„10ä¸‡è¡Œæ•°æ®æ˜¯ä¸èƒ½åˆ é™¤çš„</strong>ã€‚è¿™æ ·ï¼Œä¹‹å‰çš„æ•°æ®æ¯ä¸€è¡Œæ•°æ®éƒ½æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬æ˜¯deleteä¹‹å‰çš„æ•°æ®ï¼Œæ–°ç‰ˆæœ¬æ˜¯æ ‡è®°ä¸ºdeletedçš„æ•° æ®ã€‚</p><p>è¿™æ ·ï¼Œç´¢å¼•aä¸Šçš„æ•°æ®å…¶å®å°±æœ‰ä¸¤ä»½ã€‚</p><p>ç„¶åä½ ä¼šè¯´ï¼Œä¸å¯¹å•Šï¼Œä¸»é”®ä¸Šçš„æ•°æ®ä¹Ÿä¸èƒ½åˆ ï¼Œé‚£æ²¡æœ‰ä½¿ç”¨force indexçš„è¯­å¥ï¼Œä½¿ç”¨explainå‘½ä»¤ çœ‹åˆ°çš„æ‰«æè¡Œæ•°ä¸ºä»€ä¹ˆè¿˜æ˜¯100000å·¦å³?(æ½œå°è¯ï¼Œå¦‚æœè¿™ä¸ªä¹Ÿç¿»å€ï¼Œä¹Ÿè®¸ä¼˜åŒ–å™¨è¿˜ä¼šè®¤ä¸ºé€‰ å­—æ®µaä½œä¸ºç´¢å¼•æ›´åˆé€‚)</p><p>æ˜¯çš„ï¼Œä¸è¿‡è¿™ä¸ªæ˜¯ä¸»é”®ï¼Œä¸»é”®æ˜¯ç›´æ¥æŒ‰ç…§è¡¨çš„è¡Œæ•°æ¥ä¼°è®¡çš„ã€‚è€Œè¡¨çš„è¡Œæ•°ï¼Œä¼˜åŒ–å™¨ç›´æ¥ç”¨çš„æ˜¯ show table statusçš„å€¼ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•&quot;&gt;&lt;a href=&quot;#MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•&quot; class=&quot;headerlink&quot; title=&quot;MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•&quot;&gt;&lt;/a&gt;MySQLä¸ºä»€ä¹ˆæœ‰æ—¶ä¼šé€‰é”™ç´¢å¼•&lt;/h1&gt;&lt;p&gt;å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ç´¢å¼•ï¼Œä½ å·²ç»çŸ¥é“äº†åœ¨M</summary>
      
    
    
    
    
    <category term="MySQL" scheme="http://example.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>å­—ç¬¦ä¸²å­—æ®µå¦‚ä½•åˆ›å»ºç´¢å¼•</title>
    <link href="http://example.com/wiki/%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E6%AE%B5%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95/"/>
    <id>http://example.com/wiki/%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%97%E6%AE%B5%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95/</id>
    <published>2021-12-07T11:46:33.000Z</published>
    <updated>2021-12-07T11:47:11.778Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•"><a href="#æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•" class="headerlink" title="æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•"></a>æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•</h1><p>ç°åœ¨ï¼Œå‡ ä¹æ‰€æœ‰çš„ç³»ç»Ÿéƒ½æ”¯æŒé‚®ç®±ç™»å½•ï¼Œå¦‚ä½•åœ¨é‚®ç®±è¿™æ ·çš„å­—æ®µä¸Šå»ºç«‹åˆç†çš„ç´¢å¼•ï¼Œæ˜¯æˆ‘ä»¬ä»Šå¤© è¦è®¨è®ºçš„é—®é¢˜ã€‚</p><p>å‡è®¾ï¼Œä½ ç°åœ¨ç»´æŠ¤ä¸€ä¸ªæ”¯æŒé‚®ç®±ç™»å½•çš„ç³»ç»Ÿï¼Œç”¨æˆ·è¡¨æ˜¯è¿™ä¹ˆå®šä¹‰çš„:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> SUser(</span><br><span class="line">ID <span class="type">bigint</span> unsigned <span class="keyword">primary</span> key,</span><br><span class="line">email <span class="type">varchar</span>(<span class="number">64</span>),</span><br><span class="line">...</span><br><span class="line">)engine<span class="operator">=</span>innodb;</span><br></pre></td></tr></table></figure><p>ç”±äºè¦ä½¿ç”¨é‚®ç®±ç™»å½•ï¼Œæ‰€ä»¥ä¸šåŠ¡ä»£ç ä¸­ä¸€å®šä¼šå‡ºç°ç±»ä¼¼äºè¿™æ ·çš„è¯­å¥:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> f1, f2 <span class="keyword">from</span> SUser <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;xxx&#x27;</span>;</span><br></pre></td></tr></table></figure><p>ä»ç¬¬4å’Œç¬¬5ç¯‡è®²è§£ç´¢å¼•çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¦‚æœemailè¿™ä¸ªå­—æ®µä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯­ å¥å°±åªèƒ½åšå…¨è¡¨æ‰«æã€‚</p><p>åŒæ—¶ï¼ŒMySQLæ˜¯æ”¯æŒå‰ç¼€ç´¢å¼•çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥å®šä¹‰å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ä½œä¸ºç´¢å¼•ã€‚é»˜è®¤åœ°ï¼Œ<strong>å¦‚æœä½ åˆ›å»ºç´¢å¼•çš„è¯­å¥ä¸æŒ‡å®šå‰ç¼€é•¿åº¦ï¼Œé‚£ä¹ˆç´¢å¼•å°±ä¼šåŒ…å«æ•´ä¸ªå­—ç¬¦ä¸²ã€‚</strong></p><p>æ¯”å¦‚ï¼Œè¿™ä¸¤ä¸ªåœ¨emailå­—æ®µä¸Šåˆ›å»ºç´¢å¼•çš„è¯­å¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table SUser add index index1(email);</span><br><span class="line">æˆ–</span><br><span class="line">mysql&gt; alter table SUser add index index2(email(6));</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªè¯­å¥åˆ›å»ºçš„index1ç´¢å¼•é‡Œé¢ï¼ŒåŒ…å«äº†æ¯ä¸ªè®°å½•çš„æ•´ä¸ªå­—ç¬¦ä¸²;è€Œç¬¬äºŒä¸ªè¯­å¥åˆ›å»ºçš„index2 ç´¢å¼•é‡Œé¢ï¼Œå¯¹äºæ¯ä¸ªè®°å½•éƒ½æ˜¯åªå–å‰6ä¸ªå­—èŠ‚ã€‚</p><p>é‚£ä¹ˆï¼Œè¿™ä¸¤ç§ä¸åŒçš„å®šä¹‰åœ¨æ•°æ®ç»“æ„å’Œå­˜å‚¨ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢?å¦‚å›¾2å’Œ3æ‰€ç¤ºï¼Œå°±æ˜¯è¿™ä¸¤ä¸ªç´¢å¼• çš„ç¤ºæ„å›¾ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-fa537bde10fbcdecaf1b58576ec108c66f9.png"></p><p>ç´¢å¼•2 ğŸ‘‡</p><p><img src="https://oscimg.oschina.net/oscnet/up-68ada8a9dc6378cf9e9b3d35b9aab0a0bef.png"></p><p>ä»å›¾ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œç”±äºemail(6)è¿™ä¸ªç´¢å¼•ç»“æ„ä¸­æ¯ä¸ªé‚®ç®±å­—æ®µéƒ½åªå–å‰6ä¸ªå­—èŠ‚(å³:zhangs)ï¼Œæ‰€ä»¥å ç”¨çš„ç©ºé—´ä¼šæ›´å°ï¼Œè¿™å°±æ˜¯ä½¿ç”¨å‰ç¼€ç´¢å¼•çš„ä¼˜åŠ¿ã€‚</p><p>ä½†ï¼Œè¿™åŒæ—¶å¸¦æ¥çš„æŸå¤±æ˜¯ï¼Œ<strong>å¯èƒ½ä¼šå¢åŠ é¢å¤–çš„è®°å½•æ‰«ææ¬¡æ•°</strong>ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†çœ‹çœ‹ä¸‹é¢è¿™ä¸ªè¯­å¥ï¼Œåœ¨è¿™ä¸¤ä¸ªç´¢å¼•å®šä¹‰ä¸‹åˆ†åˆ«æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,email <span class="keyword">from</span> SUser <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;zhangssxyz@xxx.com&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li><p>å¦‚æœä½¿ç”¨çš„æ˜¯index1(å³emailæ•´ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•ç»“æ„)ï¼Œæ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„:</p><ul><li><p>ä»index1ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯â€™<a href="mailto:&#122;&#x68;&#x61;&#x6e;&#x67;&#115;&#115;&#120;&#121;&#x7a;&#x40;&#120;&#120;&#x78;&#x2e;&#x63;&#111;&#x6d;">&#122;&#x68;&#x61;&#x6e;&#x67;&#115;&#115;&#120;&#121;&#x7a;&#x40;&#120;&#120;&#x78;&#x2e;&#x63;&#111;&#x6d;</a>â€™çš„è¿™æ¡è®°å½•ï¼Œå–å¾—ID2çš„å€¼;</p></li><li><p>åˆ°ä¸»é”®ä¸ŠæŸ¥åˆ°ä¸»é”®å€¼æ˜¯ID2çš„è¡Œï¼Œåˆ¤æ–­emailçš„å€¼æ˜¯æ­£ç¡®çš„ï¼Œå°†è¿™è¡Œè®°å½•åŠ å…¥ç»“æœé›†;</p></li><li><p>å–index1ç´¢å¼•æ ‘ä¸ŠåˆšåˆšæŸ¥åˆ°çš„ä½ç½®çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œå‘ç°å·²ç»ä¸æ»¡è¶³ email=â€˜<a href="mailto:&#122;&#x68;&#x61;&#110;&#103;&#x73;&#x73;&#x78;&#x79;&#122;&#x40;&#x78;&#120;&#120;&#x2e;&#99;&#x6f;&#109;">&#122;&#x68;&#x61;&#110;&#103;&#x73;&#x73;&#x78;&#x79;&#122;&#x40;&#x78;&#120;&#120;&#x2e;&#99;&#x6f;&#109;</a>â€™çš„æ¡ä»¶äº†ï¼Œå¾ªç¯ç»“æŸã€‚</p></li></ul><p>è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦å›ä¸»é”®ç´¢å¼•å–ä¸€æ¬¡æ•°æ®ï¼Œæ‰€ä»¥ç³»ç»Ÿè®¤ä¸ºåªæ‰«æäº†ä¸€è¡Œã€‚</p></li><li><p>å¦‚æœä½¿ç”¨çš„æ˜¯index2(å³email(6)ç´¢å¼•ç»“æ„)ï¼Œæ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„:</p><ul><li>ä»index2ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯â€™zhangsâ€™çš„è®°å½•ï¼Œæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ˜¯ID1;</li><li>åˆ°ä¸»é”®ä¸ŠæŸ¥åˆ°ä¸»é”®å€¼æ˜¯ID1çš„è¡Œï¼Œåˆ¤æ–­å‡ºemailçš„å€¼ä¸æ˜¯â€™<a href="mailto:&#x7a;&#x68;&#x61;&#x6e;&#103;&#115;&#115;&#x78;&#x79;&#122;&#64;&#x78;&#x78;&#120;&#x2e;&#x63;&#111;&#x6d;">&#x7a;&#x68;&#x61;&#x6e;&#103;&#115;&#115;&#x78;&#x79;&#122;&#64;&#x78;&#x78;&#120;&#x2e;&#x63;&#111;&#x6d;</a>â€™ï¼Œè¿™è¡Œè®°å½•ä¸¢ å¼ƒ;</li><li>å–index2ä¸ŠåˆšåˆšæŸ¥åˆ°çš„ä½ç½®çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œå‘ç°ä»ç„¶æ˜¯â€™zhangsâ€™ï¼Œå–å‡ºID2ï¼Œå†åˆ°IDç´¢å¼•ä¸Šå– æ•´è¡Œç„¶ååˆ¤æ–­ï¼Œè¿™æ¬¡å€¼å¯¹äº†ï¼Œå°†è¿™è¡Œè®°å½•åŠ å…¥ç»“æœé›†;</li><li>é‡å¤ä¸Šä¸€æ­¥ï¼Œç›´åˆ°åœ¨idxe2ä¸Šå–åˆ°çš„å€¼ä¸æ˜¯â€™zhangsâ€™æ—¶ï¼Œå¾ªç¯ç»“æŸã€‚</li></ul><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¦å›ä¸»é”®ç´¢å¼•å–4æ¬¡æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ‰«æäº†4è¡Œã€‚</p></li></ul><p><strong>é€šè¿‡è¿™ä¸ªå¯¹æ¯”ï¼Œä½ å¾ˆå®¹æ˜“å°±å¯ä»¥å‘ç°ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•åï¼Œå¯èƒ½ä¼šå¯¼è‡´æŸ¥è¯¢è¯­å¥è¯»æ•°æ®çš„æ¬¡æ•°å˜å¤šã€‚</strong></p><blockquote><p>ä½†æ˜¯ï¼Œå¯¹äºè¿™ä¸ªæŸ¥è¯¢è¯­å¥æ¥è¯´ï¼Œå¦‚æœä½ å®šä¹‰çš„index2ä¸æ˜¯email(6)è€Œæ˜¯email(7)ï¼Œä¹Ÿå°±æ˜¯è¯´å– emailå­—æ®µçš„å‰7ä¸ªå­—èŠ‚æ¥æ„å»ºç´¢å¼•çš„è¯ï¼Œå³æ»¡è¶³å‰ç¼€â€™zhangssâ€™çš„è®°å½•åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿèƒ½å¤Ÿç›´æ¥æŸ¥åˆ° ID2ï¼Œåªæ‰«æä¸€è¡Œå°±ç»“æŸäº†ã€‚</p></blockquote><p><font color=blue>ä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå®šä¹‰å¥½é•¿åº¦ï¼Œå°±å¯ä»¥åšåˆ°æ—¢èŠ‚çœç©ºé—´ï¼Œåˆä¸ç”¨é¢å¤–å¢åŠ å¤ªå¤šçš„æŸ¥ è¯¢æˆæœ¬ã€‚</font></p><h2 id="å¦‚ä½•å®šä¹‰å‰ç¼€ç´¢å¼•çš„é•¿åº¦å‘¢"><a href="#å¦‚ä½•å®šä¹‰å‰ç¼€ç´¢å¼•çš„é•¿åº¦å‘¢" class="headerlink" title="å¦‚ä½•å®šä¹‰å‰ç¼€ç´¢å¼•çš„é•¿åº¦å‘¢"></a>å¦‚ä½•å®šä¹‰å‰ç¼€ç´¢å¼•çš„é•¿åº¦å‘¢</h2><p>äºæ˜¯ï¼Œä½ å°±æœ‰ä¸ªé—®é¢˜:å½“è¦ç»™å­—ç¬¦ä¸²åˆ›å»ºå‰ç¼€ç´¢å¼•æ—¶ï¼Œæœ‰ä»€ä¹ˆæ–¹æ³•èƒ½å¤Ÿç¡®å®šæˆ‘åº”è¯¥ä½¿ç”¨å¤šé•¿çš„å‰ç¼€å‘¢?</p><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨å»ºç«‹ç´¢å¼•æ—¶å…³æ³¨çš„æ˜¯åŒºåˆ†åº¦ï¼ŒåŒºåˆ†åº¦è¶Šé«˜è¶Šå¥½ã€‚å› ä¸ºåŒºåˆ†åº¦è¶Šé«˜ï¼Œæ„å‘³ç€é‡å¤çš„ é”®å€¼è¶Šå°‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»Ÿè®¡ç´¢å¼•ä¸Šæœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼æ¥åˆ¤æ–­è¦ä½¿ç”¨å¤šé•¿çš„å‰ç¼€ã€‚</p><p>é¦–å…ˆï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸ªè¯­å¥ï¼Œç®—å‡ºè¿™ä¸ªåˆ—ä¸Šæœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> email) <span class="keyword">as</span> L <span class="keyword">from</span> SUser;</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œä¾æ¬¡é€‰å–ä¸åŒé•¿åº¦çš„å‰ç¼€æ¥çœ‹è¿™ä¸ªå€¼ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦çœ‹ä¸€ä¸‹4~7ä¸ªå­—èŠ‚çš„å‰ç¼€ç´¢å¼•ï¼Œå¯ä»¥ç”¨ è¿™ä¸ªè¯­å¥:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span></span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">4</span>))<span class="keyword">as</span> L4, <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">5</span>))<span class="keyword">as</span> L5, <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">6</span>))<span class="keyword">as</span> L6, <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(email,<span class="number">7</span>))<span class="keyword">as</span> L7,</span><br><span class="line"><span class="keyword">from</span> SUser;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•å¾ˆå¯èƒ½ä¼šæŸå¤±åŒºåˆ†åº¦ï¼Œæ‰€ä»¥ä½ éœ€è¦é¢„å…ˆè®¾å®šä¸€ä¸ªå¯ä»¥æ¥å—çš„æŸå¤±æ¯”ä¾‹ï¼Œæ¯”å¦‚ 5%ã€‚ç„¶åï¼Œåœ¨è¿”å›çš„L4~L7ä¸­ï¼Œæ‰¾å‡ºä¸å°äº L * 95%çš„å€¼ï¼Œå‡è®¾è¿™é‡ŒL6ã€L7éƒ½æ»¡è¶³ï¼Œä½ å°±å¯ä»¥ é€‰æ‹©å‰ç¼€é•¿åº¦ä¸º6ã€‚</p><h2 id="å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“"><a href="#å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“" class="headerlink" title="å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“"></a>å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“</h2><p>å‰é¢æˆ‘ä»¬è¯´äº†ä½¿ç”¨å‰ç¼€ç´¢å¼•å¯èƒ½ä¼šå¢åŠ æ‰«æè¡Œæ•°ï¼Œè¿™ä¼šå½±å“åˆ°æ€§èƒ½ã€‚å…¶å®ï¼Œå‰ç¼€ç´¢å¼•çš„å½±å“ä¸æ­¢ å¦‚æ­¤ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å¦å¤–ä¸€ä¸ªåœºæ™¯ã€‚</p><p>ä½ å…ˆæ¥çœ‹çœ‹è¿™ä¸ªSQLè¯­å¥:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,email <span class="keyword">from</span> SUser <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;zhangssxyz@xxx.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p>ä¸å‰é¢ä¾‹å­ä¸­çš„SQLè¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,email <span class="keyword">from</span> SUser <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;zhangssxyz@xxx.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p>ç›¸æ¯”ï¼Œè¿™ä¸ªè¯­å¥åªè¦æ±‚è¿”å›idå’Œemailå­—æ®µã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœä½¿ç”¨index1(å³emailæ•´ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•ç»“æ„)çš„è¯ï¼Œå¯ä»¥åˆ©ç”¨è¦†ç›–ç´¢å¼•ï¼Œä»index1æŸ¥ åˆ°ç»“æœåç›´æ¥å°±è¿”å›äº†ï¼Œä¸éœ€è¦å›åˆ°IDç´¢å¼•å†å»æŸ¥ä¸€æ¬¡ã€‚è€Œå¦‚æœä½¿ç”¨index2(å³email(6)ç´¢å¼•ç»“ æ„)çš„è¯ï¼Œå°±ä¸å¾—ä¸å›åˆ°IDç´¢å¼•å†å»åˆ¤æ–­emailå­—æ®µçš„å€¼ã€‚</p><p><strong>å³ä½¿ä½ å°†index2çš„å®šä¹‰ä¿®æ”¹ä¸ºemail(18)çš„å‰ç¼€ç´¢å¼•ï¼Œè¿™æ—¶å€™è™½ç„¶index2å·²ç»åŒ…å«äº†æ‰€æœ‰çš„ä¿¡æ¯ï¼Œ ä½†InnoDBè¿˜æ˜¯è¦å›åˆ°idç´¢å¼•å†æŸ¥ä¸€ä¸‹ï¼Œå› ä¸ºç³»ç»Ÿå¹¶ä¸ç¡®å®šå‰ç¼€ç´¢å¼•çš„å®šä¹‰æ˜¯å¦æˆªæ–­äº†å®Œæ•´ä¿¡æ¯ã€‚</strong></p><p><font color=red>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•å°±ç”¨ä¸ä¸Šè¦†ç›–ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„ä¼˜åŒ–äº†ï¼Œè¿™ä¹Ÿæ˜¯ä½ åœ¨é€‰æ‹©æ˜¯å¦ä½¿ç”¨å‰ç¼€ ç´¢å¼•æ—¶éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªå› ç´ ã€‚</font></p><h2 id="å…¶ä»–æ–¹å¼"><a href="#å…¶ä»–æ–¹å¼" class="headerlink" title="å…¶ä»–æ–¹å¼"></a>å…¶ä»–æ–¹å¼</h2><p>å¯¹äºç±»ä¼¼äºé‚®ç®±è¿™æ ·çš„å­—æ®µæ¥è¯´ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•çš„æ•ˆæœå¯èƒ½è¿˜ä¸é”™ã€‚ä½†æ˜¯ï¼Œé‡åˆ°å‰ç¼€çš„åŒºåˆ†åº¦ä¸å¤Ÿå¥½çš„æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬è¦æ€ä¹ˆåŠå‘¢?</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å›½å®¶çš„èº«ä»½è¯å·ï¼Œä¸€å…±18ä½ï¼Œå…¶ä¸­å‰6ä½æ˜¯åœ°å€ç ï¼Œæ‰€ä»¥åŒä¸€ä¸ªå¿çš„äººçš„èº«ä»½è¯å·å‰</p><p>6ä½ä¸€èˆ¬ä¼šæ˜¯ç›¸åŒçš„ã€‚ å‡è®¾ä½ ç»´æŠ¤çš„æ•°æ®åº“æ˜¯ä¸€ä¸ªå¸‚çš„å…¬æ°‘ä¿¡æ¯ç³»ç»Ÿï¼Œè¿™æ—¶å€™å¦‚æœå¯¹èº«ä»½è¯å·åšé•¿åº¦ä¸º6çš„å‰ç¼€ç´¢å¼•çš„è¯ï¼Œè¿™ä¸ªç´¢å¼•çš„åŒºåˆ†åº¦å°±éå¸¸ä½äº†ã€‚ æŒ‰ç…§æˆ‘ä»¬å‰é¢è¯´çš„æ–¹æ³•ï¼Œå¯èƒ½ä½ éœ€è¦åˆ›å»ºé•¿åº¦ä¸º12ä»¥ä¸Šçš„å‰ç¼€ç´¢å¼•ï¼Œæ‰èƒ½å¤Ÿæ»¡è¶³åŒºåˆ†åº¦è¦æ±‚ã€‚</p><p>ä½†æ˜¯ï¼Œç´¢å¼•é€‰å–çš„è¶Šé•¿ï¼Œå ç”¨çš„ç£ç›˜ç©ºé—´å°±è¶Šå¤§ï¼Œç›¸åŒçš„æ•°æ®é¡µèƒ½æ”¾ä¸‹çš„ç´¢å¼•å€¼å°±è¶Šå°‘ï¼Œæœç´¢çš„ æ•ˆç‡ä¹Ÿå°±ä¼šè¶Šä½ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿç¡®å®šä¸šåŠ¡éœ€æ±‚é‡Œé¢åªæœ‰æŒ‰ç…§èº«ä»½è¯è¿›è¡Œç­‰å€¼æŸ¥è¯¢çš„éœ€æ±‚ï¼Œè¿˜æœ‰æ²¡æœ‰åˆ«çš„å¤„ç† æ–¹æ³•å‘¢?è¿™ç§æ–¹æ³•ï¼Œæ—¢å¯ä»¥å ç”¨æ›´å°çš„ç©ºé—´ï¼Œä¹Ÿèƒ½è¾¾åˆ°ç›¸åŒçš„æŸ¥è¯¢æ•ˆç‡ã€‚</p><p>ç­”æ¡ˆæ˜¯ï¼Œæœ‰çš„ã€‚</p><h3 id="ç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨å€’åºå­˜å‚¨"><a href="#ç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨å€’åºå­˜å‚¨" class="headerlink" title="ç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨å€’åºå­˜å‚¨"></a>ç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨å€’åºå­˜å‚¨</h3><p>å¦‚æœä½ å­˜å‚¨èº«ä»½è¯å·çš„æ—¶å€™æŠŠå®ƒå€’è¿‡æ¥å­˜ï¼Œæ¯æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œä½  å¯ä»¥è¿™ä¹ˆå†™:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> field_list <span class="keyword">from</span> t <span class="keyword">where</span> id_card <span class="operator">=</span> reverse(<span class="string">&#x27;input_id_card_string&#x27;</span>);</span><br></pre></td></tr></table></figure><p>ç”±äºèº«ä»½è¯å·çš„æœ€å6ä½æ²¡æœ‰åœ°å€ç è¿™æ ·çš„é‡å¤é€»è¾‘ï¼Œæ‰€ä»¥æœ€åè¿™6ä½å¾ˆå¯èƒ½å°±æä¾›äº†è¶³å¤Ÿçš„åŒº åˆ†åº¦ã€‚å½“ç„¶äº†ï¼Œå®è·µä¸­ä½ ä¸è¦å¿˜è®°ä½¿ç”¨count(distinct)æ–¹æ³•å»åšä¸ªéªŒè¯ã€‚</p><h3 id="ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨hashå­—æ®µ"><a href="#ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨hashå­—æ®µ" class="headerlink" title="ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨hashå­—æ®µ"></a>ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨hashå­—æ®µ</h3><p>ä½ å¯ä»¥åœ¨è¡¨ä¸Šå†åˆ›å»ºä¸€ä¸ªæ•´æ•°å­—æ®µï¼Œæ¥ä¿å­˜èº«ä»½è¯çš„æ ¡éªŒç ï¼Œ åŒæ—¶åœ¨è¿™ä¸ªå­—æ®µä¸Šåˆ›å»ºç´¢å¼•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table t add id_card_crc int unsigned, add index(id_card_crc);</span><br></pre></td></tr></table></figure><p>ç„¶åæ¯æ¬¡æ’å…¥æ–°è®°å½•çš„æ—¶å€™ï¼Œéƒ½åŒæ—¶ç”¨crc32()è¿™ä¸ªå‡½æ•°å¾—åˆ°æ ¡éªŒç å¡«åˆ°è¿™ä¸ªæ–°å­—æ®µã€‚ç”±äºæ ¡éªŒç  å¯èƒ½å­˜åœ¨å†²çªï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤ä¸ªä¸åŒçš„èº«ä»½è¯å·é€šè¿‡crc32()å‡½æ•°å¾—åˆ°çš„ç»“æœå¯èƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä½  çš„æŸ¥è¯¢è¯­å¥whereéƒ¨åˆ†è¦åˆ¤æ–­id_cardçš„å€¼æ˜¯å¦ç²¾ç¡®ç›¸åŒã€‚</p><p>è¿™æ ·ï¼Œ<strong>ç´¢å¼•çš„é•¿åº¦å˜æˆäº†4ä¸ªå­—èŠ‚</strong>ï¼Œæ¯”åŸæ¥å°äº†å¾ˆå¤šã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†ä¸€èµ·çœ‹çœ‹ä½¿ç”¨å€’åºå­˜å‚¨å’Œä½¿ç”¨hashå­—æ®µè¿™ä¸¤ç§æ–¹æ³•çš„å¼‚åŒç‚¹ã€‚</p><h3 id="é¦–å…ˆï¼Œå®ƒä»¬çš„ç›¸åŒç‚¹æ˜¯ï¼Œ"><a href="#é¦–å…ˆï¼Œå®ƒä»¬çš„ç›¸åŒç‚¹æ˜¯ï¼Œ" class="headerlink" title="é¦–å…ˆï¼Œå®ƒä»¬çš„ç›¸åŒç‚¹æ˜¯ï¼Œ"></a>é¦–å…ˆï¼Œå®ƒä»¬çš„ç›¸åŒç‚¹æ˜¯ï¼Œ</h3><p>éƒ½ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€‚å€’åºå­˜å‚¨çš„å­—æ®µä¸Šåˆ›å»ºçš„ç´¢å¼•æ˜¯æŒ‰ç…§å€’åºå­—ç¬¦ä¸²çš„ æ–¹å¼æ’åºçš„ï¼Œå·²ç»æ²¡æœ‰åŠæ³•åˆ©ç”¨ç´¢å¼•æ–¹å¼æŸ¥å‡ºèº«ä»½è¯å·ç åœ¨[ID_X, ID_Y]çš„æ‰€æœ‰å¸‚æ°‘äº†ã€‚åŒæ · åœ°ï¼Œhashå­—æ®µçš„æ–¹å¼ä¹Ÿåªèƒ½æ”¯æŒç­‰å€¼æŸ¥è¯¢ã€‚</p><h3 id="å®ƒä»¬çš„åŒºåˆ«ï¼Œ"><a href="#å®ƒä»¬çš„åŒºåˆ«ï¼Œ" class="headerlink" title="å®ƒä»¬çš„åŒºåˆ«ï¼Œ"></a>å®ƒä»¬çš„åŒºåˆ«ï¼Œ</h3><p>ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢:</p><ol><li>ä»å ç”¨çš„é¢å¤–ç©ºé—´æ¥çœ‹ï¼Œå€’åºå­˜å‚¨æ–¹å¼åœ¨ä¸»é”®ç´¢å¼•ä¸Šï¼Œä¸ä¼šæ¶ˆè€—é¢å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œhashå­— æ®µæ–¹æ³•éœ€è¦å¢åŠ ä¸€ä¸ªå­—æ®µã€‚å½“ç„¶ï¼Œå€’åºå­˜å‚¨æ–¹å¼ä½¿ç”¨4ä¸ªå­—èŠ‚çš„å‰ç¼€é•¿åº¦åº”è¯¥æ˜¯ä¸å¤Ÿçš„ï¼Œå¦‚ æœå†é•¿ä¸€ç‚¹ï¼Œè¿™ä¸ªæ¶ˆè€—è·Ÿé¢å¤–è¿™ä¸ªhashå­—æ®µä¹Ÿå·®ä¸å¤šæŠµæ¶ˆäº†ã€‚</li><li>åœ¨CPUæ¶ˆè€—æ–¹é¢ï¼Œå€’åºæ–¹å¼æ¯æ¬¡å†™å’Œè¯»çš„æ—¶å€™ï¼Œéƒ½éœ€è¦é¢å¤–è°ƒç”¨ä¸€æ¬¡reverseå‡½æ•°ï¼Œè€Œhash å­—æ®µçš„æ–¹å¼éœ€è¦é¢å¤–è°ƒç”¨ä¸€æ¬¡crc32()å‡½æ•°ã€‚å¦‚æœåªä»è¿™ä¸¤ä¸ªå‡½æ•°çš„è®¡ç®—å¤æ‚åº¦æ¥çœ‹çš„ è¯ï¼Œreverseå‡½æ•°é¢å¤–æ¶ˆè€—çš„CPUèµ„æºä¼šæ›´å°äº›ã€‚</li><li>ä»æŸ¥è¯¢æ•ˆç‡ä¸Šçœ‹ï¼Œä½¿ç”¨hashå­—æ®µæ–¹å¼çš„æŸ¥è¯¢æ€§èƒ½ç›¸å¯¹æ›´ç¨³å®šä¸€äº›ã€‚å› ä¸ºcrc32ç®—å‡ºæ¥çš„å€¼è™½ ç„¶æœ‰å†²çªçš„æ¦‚ç‡ï¼Œä½†æ˜¯æ¦‚ç‡éå¸¸å°ï¼Œå¯ä»¥è®¤ä¸ºæ¯æ¬¡æŸ¥è¯¢çš„å¹³å‡æ‰«æè¡Œæ•°æ¥è¿‘1ã€‚è€Œå€’åºå­˜å‚¨ æ–¹å¼æ¯•ç«Ÿè¿˜æ˜¯ç”¨çš„å‰ç¼€ç´¢å¼•çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜æ˜¯ä¼šå¢åŠ æ‰«æè¡Œæ•°ã€‚</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è·Ÿä½ èŠäº†èŠå­—ç¬¦ä¸²å­—æ®µåˆ›å»ºç´¢å¼•çš„åœºæ™¯ã€‚æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨çš„ æ–¹å¼æœ‰:</p><ol><li>ç›´æ¥åˆ›å»ºå®Œæ•´ç´¢å¼•ï¼Œè¿™æ ·å¯èƒ½æ¯”è¾ƒå ç”¨ç©ºé—´;</li><li>åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼ŒèŠ‚çœç©ºé—´ï¼Œä½†ä¼šå¢åŠ æŸ¥è¯¢æ‰«ææ¬¡æ•°ï¼Œå¹¶ä¸”ä¸èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•;</li><li>å€’åºå­˜å‚¨ï¼Œå†åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼Œç”¨äºç»•è¿‡å­—ç¬¦ä¸²æœ¬èº«å‰ç¼€çš„åŒºåˆ†åº¦ä¸å¤Ÿçš„é—®é¢˜;</li><li>åˆ›å»ºhashå­—æ®µç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šï¼Œæœ‰é¢å¤–çš„å­˜å‚¨å’Œè®¡ç®—æ¶ˆè€—ï¼Œè·Ÿç¬¬ä¸‰ç§æ–¹å¼ä¸€æ ·ï¼Œéƒ½ä¸æ”¯æŒèŒƒå›´æ‰«æã€‚</li></ol><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ è¦æ ¹æ®ä¸šåŠ¡å­—æ®µçš„ç‰¹ç‚¹é€‰æ‹©ä½¿ç”¨å“ªç§æ–¹å¼ã€‚</p><hr><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å¥½äº†ï¼Œåˆåˆ°äº†æœ€åçš„é—®é¢˜æ—¶é—´ã€‚</p><p>å¦‚æœä½ åœ¨ç»´æŠ¤ä¸€ä¸ªå­¦æ ¡çš„å­¦ç”Ÿä¿¡æ¯æ•°æ®åº“ï¼Œå­¦ç”Ÿç™»å½•åçš„ç»Ÿä¸€æ ¼å¼æ˜¯â€å­¦å·@gmail.comâ€, è€Œå­¦å·çš„è§„åˆ™æ˜¯:åäº”ä½çš„æ•°å­—ï¼Œå…¶ä¸­å‰ä¸‰ä½æ˜¯æ‰€åœ¨åŸå¸‚ç¼–å·ã€ç¬¬å››åˆ°ç¬¬å…­ä½æ˜¯å­¦æ ¡ç¼–å·ã€ç¬¬ä¸ƒä½åˆ°ç¬¬ åä½æ˜¯å…¥å­¦å¹´ä»½ã€æœ€åäº”ä½æ˜¯é¡ºåºç¼–å·ã€‚</p><p>ç³»ç»Ÿç™»å½•çš„æ—¶å€™éƒ½éœ€è¦å­¦ç”Ÿè¾“å…¥ç™»å½•åå’Œå¯†ç ï¼ŒéªŒè¯æ­£ç¡®åæ‰èƒ½ç»§ç»­ä½¿ç”¨ç³»ç»Ÿã€‚å°±åªè€ƒè™‘ç™»å½•éªŒè¯è¿™ä¸ªè¡Œä¸ºçš„è¯ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡è¿™ä¸ªç™»å½•åçš„ç´¢å¼•å‘¢?</p><p>ç”±äºè¿™ä¸ªå­¦å·çš„è§„åˆ™ï¼Œæ— è®ºæ˜¯æ­£å‘è¿˜æ˜¯åå‘çš„å‰ç¼€ç´¢å¼•ï¼Œé‡å¤åº¦éƒ½æ¯”è¾ƒé«˜ã€‚å› ä¸ºç»´æŠ¤çš„åªæ˜¯ä¸€ä¸ªå­¦æ ¡çš„ï¼Œå› æ­¤å‰é¢6ä½ï¼ˆå…¶ä¸­ï¼Œå‰ä¸‰ä½æ˜¯æ‰€åœ¨åŸå¸‚ç¼–å·ã€ç¬¬å››åˆ°ç¬¬å…­ä½æ˜¯å­¦æ ¡ç¼–å·ï¼‰å…¶å®æ˜¯å›ºå®šçš„ï¼Œé‚®ç®±åç¼€éƒ½æ˜¯@gamil.comï¼Œå› æ­¤å¯ä»¥åªå­˜å…¥å­¦å¹´ä»½åŠ é¡ºåºç¼–å·ï¼Œå®ƒä»¬çš„é•¿åº¦æ˜¯9ä½ã€‚</p><p>è€Œå…¶å®åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¯ä»¥ç”¨æ•°å­—ç±»å‹æ¥å­˜è¿™9ä½æ•°å­—ã€‚æ¯”å¦‚201100001ï¼Œè¿™æ ·åªéœ€è¦å 4ä¸ªå­—èŠ‚ã€‚å…¶å®è¿™ä¸ªå°±æ˜¯ä¸€ç§hashï¼Œåªæ˜¯å®ƒç”¨äº†æœ€ç®€å•çš„è½¬æ¢è§„åˆ™ï¼šå­—ç¬¦ä¸²è½¬æ•°å­—çš„è§„åˆ™ï¼Œè€Œåˆšå¥½æˆ‘ä»¬è®¾å®šçš„è¿™ä¸ªèƒŒæ™¯ï¼Œå¯ä»¥ä¿è¯è¿™ä¸ªè½¬æ¢åç»“æœçš„å”¯ä¸€æ€§ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•&quot;&gt;&lt;a href=&quot;#æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•&quot; class=&quot;headerlink&quot; title=&quot;æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•&quot;&gt;&lt;/a&gt;æ€ä¹ˆç»™å­—ç¬¦ä¸²å­—æ®µæ·»åŠ ç´¢å¼•&lt;/h1&gt;&lt;p&gt;ç°åœ¨ï¼Œå‡ ä¹æ‰€æœ‰çš„ç³»ç»Ÿéƒ½æ”¯æŒé‚®ç®±ç™»å½•ï¼Œå¦‚ä½•åœ¨é‚®ç®±è¿™æ ·çš„å­—æ®µä¸Šå»º</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>innodbæ˜¯å¦‚ä½•å¤„ç†è„é¡µçš„</title>
    <link href="http://example.com/wiki/innodb%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E8%84%8F%E9%A1%B5%E7%9A%84/"/>
    <id>http://example.com/wiki/innodb%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E8%84%8F%E9%A1%B5%E7%9A%84/</id>
    <published>2021-12-07T11:45:11.000Z</published>
    <updated>2021-12-07T11:46:04.083Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹"><a href="#æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹" class="headerlink" title="æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹"></a>æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹</h1><blockquote><p>innodbå¼•æ“æ˜¯å¦‚ä½•å¤„ç† <strong>è„é¡µ</strong> çš„</p></blockquote><p>å¹³æ—¶çš„å·¥ä½œä¸­ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„åœºæ™¯ï¼Œä¸€æ¡SQLè¯­å¥ï¼Œæ­£å¸¸æ‰§è¡Œçš„æ—¶å€™ç‰¹åˆ«å¿«ï¼Œä½† æ˜¯æœ‰æ—¶ä¹Ÿä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œå®ƒå°±ä¼šå˜å¾—ç‰¹åˆ«æ…¢ï¼Œå¹¶ä¸”è¿™æ ·çš„åœºæ™¯å¾ˆéš¾å¤ç°ï¼Œå®ƒä¸åªéšæœºï¼Œè€Œä¸”æŒç»­æ—¶é—´è¿˜å¾ˆçŸ­ã€‚</p><h2 id="ä½ çš„SQLè¯­å¥ä¸ºä»€ä¹ˆå˜â€œæ…¢â€äº†"><a href="#ä½ çš„SQLè¯­å¥ä¸ºä»€ä¹ˆå˜â€œæ…¢â€äº†" class="headerlink" title="ä½ çš„SQLè¯­å¥ä¸ºä»€ä¹ˆå˜â€œæ…¢â€äº†"></a>ä½ çš„SQLè¯­å¥ä¸ºä»€ä¹ˆå˜â€œæ…¢â€äº†</h2><p>åœ¨å‰é¢ã€Šä¸€æ¡SQLæ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„?ã€‹ä¸­ï¼Œä»‹ç»äº†WALæœºåˆ¶ã€‚ç°åœ¨ä½ çŸ¥é“äº†ï¼ŒInnoDBåœ¨å¤„ç†æ›´æ–°è¯­å¥çš„æ—¶å€™ï¼Œåªåšäº†å†™æ—¥å¿—è¿™ä¸€ä¸ªç£ç›˜æ“ä½œã€‚è¿™ä¸ªæ—¥å¿— å«ä½œredo log(é‡åšæ—¥å¿—)ï¼Œä¹Ÿå°±æ˜¯ã€Šå­”ä¹™å·±ã€‹é‡Œå’¸äº¨é…’åº—æŒæŸœç”¨æ¥è®°è´¦çš„ç²‰æ¿ï¼Œåœ¨æ›´æ–°å†…å­˜å†™ å®Œredo logåï¼Œå°±è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæœ¬æ¬¡æ›´æ–°æˆåŠŸã€‚</p><p>åšä¸‹ç±»æ¯”çš„è¯ï¼ŒæŒæŸœè®°è´¦çš„è´¦æœ¬æ˜¯æ•°æ®æ–‡ä»¶ï¼Œè®°è´¦ç”¨çš„ç²‰æ¿æ˜¯æ—¥å¿—æ–‡ä»¶(redo log)ï¼ŒæŒæŸœçš„è®°å¿†å°±æ˜¯å†…å­˜ã€‚</p><p>æŒæŸœæ€»è¦æ‰¾æ—¶é—´æŠŠè´¦æœ¬æ›´æ–°ä¸€ä¸‹ï¼Œè¿™å¯¹åº”çš„å°±æ˜¯æŠŠå†…å­˜é‡Œçš„æ•°æ®å†™å…¥ç£ç›˜çš„è¿‡ç¨‹ï¼Œæœ¯è¯­å°±æ˜¯ <strong>flush</strong>ã€‚åœ¨è¿™ä¸ªflushæ“ä½œæ‰§è¡Œä¹‹å‰ï¼Œå­”ä¹™å·±çš„èµŠè´¦æ€»é¢ï¼Œå…¶å®è·ŸæŒæŸœæ‰‹ä¸­è´¦æœ¬é‡Œé¢çš„è®°å½•æ˜¯ä¸ä¸€ è‡´çš„ã€‚å› ä¸ºå­”ä¹™å·±ä»Šå¤©çš„èµŠè´¦é‡‘é¢è¿˜åªåœ¨ç²‰æ¿ä¸Šï¼Œè€Œè´¦æœ¬é‡Œçš„è®°å½•æ˜¯è€çš„ï¼Œè¿˜æ²¡æŠŠä»Šå¤©çš„èµŠè´¦ç®—è¿›å»ã€‚</p><ul><li><p>å½“å†…å­˜æ•°æ®é¡µè·Ÿç£ç›˜æ•°æ®é¡µå†…å®¹ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå†…å­˜é¡µä¸ºâ€œè„é¡µâ€ã€‚</p></li><li><p>å†…å­˜æ•°æ®å†™å…¥åˆ°ç£ç›˜åï¼Œå†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®é¡µçš„å†…å®¹å°±ä¸€è‡´äº†ï¼Œç§°ä¸ºâ€œå¹²å‡€é¡µâ€ã€‚</p></li></ul><p><strong>ä¸è®ºæ˜¯è„é¡µè¿˜æ˜¯å¹²å‡€é¡µï¼Œéƒ½åœ¨å†…å­˜ä¸­</strong>ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œå†…å­˜å¯¹åº”çš„å°±æ˜¯æŒæŸœçš„è®°å¿†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç¤ºæ„å›¾æ¥å±•ç¤ºä¸€ä¸‹â€œå­”ä¹™å·±èµŠè´¦â€çš„æ•´ä¸ªæ“ä½œè¿‡ç¨‹ã€‚å‡è®¾åŸæ¥å­”ä¹™å·±æ¬ è´¦10 æ–‡ï¼Œè¿™æ¬¡åˆè¦èµŠ9æ–‡ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-81108822d1cb4643a5d86440190c0790bc6.png"></p><p>å›åˆ°æ–‡ç« å¼€å¤´çš„é—®é¢˜ï¼Œä½ ä¸éš¾æƒ³è±¡ï¼Œå¹³æ—¶æ‰§è¡Œå¾ˆå¿«çš„æ›´æ–°æ“ä½œï¼Œå…¶å®å°±æ˜¯åœ¨å†™å†…å­˜å’Œæ—¥å¿—ï¼Œè€Œ</p><p><strong>MySQLå¶å°”â€œæŠ–â€ä¸€ä¸‹çš„é‚£ä¸ªç¬é—´ï¼Œå¯èƒ½å°±æ˜¯åœ¨åˆ·è„é¡µ(flush)ã€‚</strong></p><h3 id="é‚£ä¹ˆï¼Œä»€ä¹ˆæƒ…å†µä¼šå¼•å‘æ•°æ®åº“çš„flushè¿‡ç¨‹å‘¢"><a href="#é‚£ä¹ˆï¼Œä»€ä¹ˆæƒ…å†µä¼šå¼•å‘æ•°æ®åº“çš„flushè¿‡ç¨‹å‘¢" class="headerlink" title="é‚£ä¹ˆï¼Œä»€ä¹ˆæƒ…å†µä¼šå¼•å‘æ•°æ®åº“çš„flushè¿‡ç¨‹å‘¢?"></a>é‚£ä¹ˆï¼Œä»€ä¹ˆæƒ…å†µä¼šå¼•å‘æ•°æ®åº“çš„flushè¿‡ç¨‹å‘¢?</h3><p>æˆ‘ä»¬è¿˜æ˜¯ç»§ç»­ç”¨å’¸äº¨é…’åº—æŒæŸœçš„è¿™ä¸ªä¾‹å­ï¼Œæƒ³ä¸€æƒ³:æŒæŸœåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šæŠŠç²‰æ¿ä¸Šçš„èµŠè´¦è®°å½•æ”¹</p><p>åˆ°è´¦æœ¬ä¸Š?</p><h4 id="ç¬¬ä¸€ç§åœºæ™¯"><a href="#ç¬¬ä¸€ç§åœºæ™¯" class="headerlink" title="ç¬¬ä¸€ç§åœºæ™¯"></a>ç¬¬ä¸€ç§åœºæ™¯</h4><p>ç²‰æ¿æ»¡äº†ï¼Œè®°ä¸ä¸‹äº†ã€‚è¿™æ—¶å€™å¦‚æœå†æœ‰äººæ¥èµŠè´¦ï¼ŒæŒæŸœå°±åªå¾—æ”¾ä¸‹æ‰‹é‡Œçš„æ´» å„¿ï¼Œå°†ç²‰æ¿ä¸Šçš„è®°å½•æ“¦æ‰ä¸€äº›ï¼Œç•™å‡ºç©ºä½ä»¥ä¾¿ç»§ç»­è®°è´¦ã€‚å½“ç„¶åœ¨æ“¦æ‰ä¹‹å‰ï¼Œä»–å¿…é¡»å…ˆå°†æ­£ç¡® çš„è´¦ç›®è®°å½•åˆ°è´¦æœ¬ä¸­æ‰è¡Œã€‚</p><p> è¿™ä¸ªåœºæ™¯ï¼Œå¯¹åº”çš„å°±æ˜¯InnoDBçš„redo logå†™æ»¡äº†ã€‚è¿™æ—¶å€™ç³»ç»Ÿä¼šåœæ­¢æ‰€æœ‰æ›´æ–°æ“ä½œï¼ŒæŠŠ checkpointå¾€å‰æ¨è¿›ï¼Œredo logç•™å‡ºç©ºé—´å¯ä»¥ç»§ç»­å†™ã€‚æˆ‘åœ¨ç¬¬äºŒè®²ç”»äº†ä¸€ä¸ªredo logçš„ç¤ºæ„ å›¾ï¼Œè¿™é‡Œæˆ‘æ”¹æˆç¯å½¢ï¼Œä¾¿äºå¤§å®¶ç†è§£ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-4e9f7569d6266f23dd6ea7df11fd9a1bc82.png"></p><p>checkpointå¯ä¸æ˜¯éšä¾¿å¾€å‰ä¿®æ”¹ä¸€ä¸‹ä½ç½®å°±å¯ä»¥çš„ã€‚æ¯”å¦‚å›¾2ä¸­ ğŸ‘†ï¼ŒæŠŠcheckpointä½ç½®ä»CPæ¨è¿›åˆ°CPâ€™ï¼Œå°±éœ€è¦å°†ä¸¤ä¸ªç‚¹ä¹‹é—´çš„æ—¥å¿—(æµ…ç»¿è‰²éƒ¨åˆ†)ï¼Œå¯¹åº”çš„æ‰€æœ‰è„é¡µéƒ½flushåˆ°ç£ç›˜ä¸Šã€‚ä¹‹åï¼Œå›¾ ä¸­ä»write posåˆ°CPâ€™ä¹‹é—´å°±æ˜¯å¯ä»¥å†å†™å…¥çš„redo logçš„åŒºåŸŸã€‚</p><h4 id="ç¬¬äºŒç§åœºæ™¯"><a href="#ç¬¬äºŒç§åœºæ™¯" class="headerlink" title="ç¬¬äºŒç§åœºæ™¯"></a>ç¬¬äºŒç§åœºæ™¯</h4><p>è¿™ä¸€å¤©ç”Ÿæ„å¤ªå¥½ï¼Œè¦è®°ä½çš„äº‹æƒ…å¤ªå¤šï¼ŒæŒæŸœå‘ç°è‡ªå·±å¿«è®°ä¸ä½äº†ï¼Œèµ¶ç´§æ‰¾å‡º è´¦æœ¬æŠŠå­”ä¹™å·±è¿™ç¬”è´¦å…ˆåŠ è¿›å»ã€‚ </p><p>è¿™ç§åœºæ™¯ï¼Œå¯¹åº”çš„å°±æ˜¯ç³»ç»Ÿå†…å­˜ä¸è¶³ã€‚å½“éœ€è¦æ–°çš„å†…å­˜é¡µï¼Œè€Œå†…å­˜ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œå°±è¦æ·˜æ±°ä¸€äº›æ•°æ®é¡µï¼Œç©ºå‡ºå†…å­˜ç»™åˆ«çš„æ•°æ®é¡µä½¿ç”¨ã€‚å¦‚æœæ·˜æ±°çš„æ˜¯â€œè„é¡µâ€ï¼Œå°±è¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜ã€‚ </p><p>ä½ ä¸€å®šä¼šè¯´ï¼Œè¿™æ—¶å€™éš¾é“ä¸èƒ½ç›´æ¥æŠŠå†…å­˜æ·˜æ±°æ‰ï¼Œä¸‹æ¬¡éœ€è¦è¯·æ±‚çš„æ—¶å€™ï¼Œä»ç£ç›˜è¯»å…¥æ•°æ®é¡µï¼Œç„¶åæ‹¿redo logå‡ºæ¥åº”ç”¨ä¸å°±è¡Œäº†? è¿™é‡Œå…¶å®æ˜¯ä»æ€§èƒ½è€ƒè™‘çš„ã€‚</p><p><strong>å¦‚æœåˆ·è„é¡µä¸€å®šä¼šå†™ç›˜ï¼Œ å°±ä¿è¯äº†æ¯ä¸ªæ•°æ®é¡µæœ‰ä¸¤ç§çŠ¶æ€:</strong></p><ul><li><p>ä¸€ç§æ˜¯å†…å­˜é‡Œå­˜åœ¨ï¼Œå†…å­˜é‡Œå°±è‚¯å®šæ˜¯æ­£ç¡®çš„ç»“æœï¼Œç›´æ¥è¿”å›; </p></li><li><p>å¦ä¸€ç§æ˜¯å†…å­˜é‡Œæ²¡æœ‰æ•°æ®ï¼Œå°±å¯ä»¥è‚¯å®šæ•°æ®æ–‡ä»¶ä¸Šæ˜¯æ­£ç¡®çš„ç»“æœï¼Œè¯»å…¥å†…å­˜åè¿”å›ã€‚ è¿™æ ·çš„æ•ˆç‡æœ€é«˜ã€‚</p></li></ul><h4 id="ç¬¬ä¸‰ç§åœºæ™¯"><a href="#ç¬¬ä¸‰ç§åœºæ™¯" class="headerlink" title="ç¬¬ä¸‰ç§åœºæ™¯"></a>ç¬¬ä¸‰ç§åœºæ™¯</h4><p>ç”Ÿæ„ä¸å¿™çš„æ—¶å€™ï¼Œæˆ–è€…æ‰“çƒŠä¹‹åã€‚è¿™æ—¶å€™æŸœå°æ²¡äº‹ï¼ŒæŒæŸœé—²ç€ä¹Ÿæ˜¯é—²ç€ï¼Œä¸ å¦‚æ›´æ–°è´¦æœ¬ã€‚ </p><p>è¿™ç§åœºæ™¯ï¼Œå¯¹åº”çš„å°±æ˜¯MySQLè®¤ä¸ºç³»ç»Ÿâ€œç©ºé—²â€çš„æ—¶å€™ã€‚å½“ç„¶ï¼ŒMySQLâ€œè¿™å®¶é…’åº—â€çš„ç”Ÿæ„å¥½èµ· æ¥å¯æ˜¯ä¼šå¾ˆå¿«å°±èƒ½æŠŠç²‰æ¿è®°æ»¡çš„ï¼Œæ‰€ä»¥â€œæŒæŸœâ€è¦åˆç†åœ°å®‰æ’æ—¶é—´ï¼Œå³ä½¿æ˜¯â€œç”Ÿæ„å¥½â€çš„æ—¶å€™ï¼Œä¹Ÿ è¦è§ç¼æ’é’ˆåœ°æ‰¾æ—¶é—´ï¼Œåªè¦æœ‰æœºä¼šå°±åˆ·ä¸€ç‚¹â€œè„é¡µâ€ã€‚</p><h4 id="ç¬¬å››ç§åœºæ™¯"><a href="#ç¬¬å››ç§åœºæ™¯" class="headerlink" title="ç¬¬å››ç§åœºæ™¯"></a>ç¬¬å››ç§åœºæ™¯</h4><p>å¹´åº•äº†å’¸äº¨é…’åº—è¦å…³é—¨å‡ å¤©ï¼Œéœ€è¦æŠŠè´¦ç»“æ¸…ä¸€ä¸‹ã€‚è¿™æ—¶å€™æŒæŸœè¦æŠŠæ‰€æœ‰è´¦éƒ½ è®°åˆ°è´¦æœ¬ä¸Šï¼Œè¿™æ ·è¿‡å®Œå¹´é‡æ–°å¼€å¼ çš„æ—¶å€™ï¼Œå°±èƒ½å°±ç€è´¦æœ¬æ˜ç¡®è´¦ç›®æƒ…å†µäº†ã€‚ </p><p>è¿™ç§åœºæ™¯ï¼Œå¯¹åº”çš„å°±æ˜¯MySQLæ­£å¸¸å…³é—­çš„æƒ…å†µã€‚è¿™æ—¶å€™ï¼ŒMySQLä¼šæŠŠå†…å­˜çš„è„é¡µéƒ½flushåˆ°ç£ ç›˜ä¸Šï¼Œè¿™æ ·ä¸‹æ¬¡MySQLå¯åŠ¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥ä»ç£ç›˜ä¸Šè¯»æ•°æ®ï¼Œå¯åŠ¨é€Ÿåº¦ä¼šå¾ˆå¿«ã€‚</p><h4 id="æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥åˆ†æä¸€ä¸‹ä¸Šé¢å››ç§åœºæ™¯å¯¹æ€§èƒ½çš„å½±å“ã€‚"><a href="#æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥åˆ†æä¸€ä¸‹ä¸Šé¢å››ç§åœºæ™¯å¯¹æ€§èƒ½çš„å½±å“ã€‚" class="headerlink" title="æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥åˆ†æä¸€ä¸‹ä¸Šé¢å››ç§åœºæ™¯å¯¹æ€§èƒ½çš„å½±å“ã€‚"></a>æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥åˆ†æä¸€ä¸‹ä¸Šé¢å››ç§åœºæ™¯å¯¹æ€§èƒ½çš„å½±å“ã€‚</h4><p>å…¶ä¸­ï¼Œç¬¬ä¸‰ç§æƒ…å†µæ˜¯å±äºMySQLç©ºé—²æ—¶çš„æ“ä½œï¼Œè¿™æ—¶ç³»ç»Ÿæ²¡ä»€ä¹ˆå‹åŠ›ï¼Œè€Œç¬¬å››ç§åœºæ™¯æ˜¯æ•°æ®åº“ æœ¬æ¥å°±è¦å…³é—­äº†ã€‚è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä½ ä¸ä¼šå¤ªå…³æ³¨â€œæ€§èƒ½â€é—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œï¼Œæˆ‘ä»¬ä¸»è¦æ¥åˆ†æä¸€ä¸‹å‰ ä¸¤ç§åœºæ™¯ä¸‹çš„æ€§èƒ½é—®é¢˜ã€‚</p><p>ç¬¬ä¸€ç§æ˜¯â€œ<strong>redo logå†™æ»¡äº†ï¼Œè¦flushè„é¡µ</strong>â€ï¼Œè¿™ç§æƒ…å†µæ˜¯InnoDBè¦å°½é‡é¿å…çš„ã€‚å› ä¸ºå‡ºç°è¿™ç§æƒ…å†µ çš„æ—¶å€™ï¼Œæ•´ä¸ªç³»ç»Ÿå°±ä¸èƒ½å†æ¥å—æ›´æ–°äº†ï¼Œæ‰€æœ‰çš„æ›´æ–°éƒ½å¿…é¡»å µä½ã€‚å¦‚æœä½ ä»ç›‘æ§ä¸Šçœ‹ï¼Œè¿™æ—¶å€™æ›´ æ–°æ•°ä¼šè·Œä¸º0ã€‚</p><p>ç¬¬äºŒç§æ˜¯â€œå†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œè¦å…ˆå°†è„é¡µå†™åˆ°ç£ç›˜â€ï¼Œè¿™ç§æƒ…å†µå…¶å®æ˜¯å¸¸æ€ã€‚</p><p>InnoDBç”¨ç¼“å†²æ±  (buffer pool)ç®¡ç†å†…å­˜ï¼Œç¼“å†²æ± ä¸­çš„å†…å­˜é¡µæœ‰ä¸‰ç§çŠ¶æ€:</p><ul><li>ç¬¬ä¸€ç§æ˜¯ï¼Œè¿˜æ²¡æœ‰ä½¿ç”¨çš„;</li><li>ç¬¬äºŒç§æ˜¯ï¼Œä½¿ç”¨äº†å¹¶ä¸”æ˜¯å¹²å‡€é¡µ;</li><li>ç¬¬ä¸‰ç§æ˜¯ï¼Œä½¿ç”¨äº†å¹¶ä¸”æ˜¯è„é¡µã€‚</li></ul><p><strong>InnoDBçš„ç­–ç•¥æ˜¯å°½é‡ä½¿ç”¨å†…å­˜ï¼Œå› æ­¤å¯¹äºä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„åº“æ¥è¯´ï¼Œæœªè¢«ä½¿ç”¨çš„é¡µé¢å¾ˆå°‘ã€‚</strong></p><p>è€Œå½“è¦è¯»å…¥çš„æ•°æ®é¡µæ²¡æœ‰åœ¨å†…å­˜çš„æ—¶å€™ï¼Œå°±å¿…é¡»åˆ°ç¼“å†²æ± ä¸­ç”³è¯·ä¸€ä¸ªæ•°æ®é¡µã€‚</p><p>è¿™æ—¶å€™åªèƒ½æŠŠæœ€ä¹…ä¸ä½¿ç”¨çš„æ•°æ®é¡µä»å†…å­˜ä¸­æ·˜æ±°æ‰: </p><ul><li><p>å¦‚æœè¦æ·˜æ±°çš„æ˜¯ä¸€ä¸ªå¹²å‡€é¡µï¼Œå°±ç›´æ¥é‡Šæ”¾å‡ºæ¥å¤ç”¨;</p></li><li><p>ä½†å¦‚æœæ˜¯è„é¡µå‘¢ï¼Œå°±å¿…é¡»å°†è„é¡µå…ˆåˆ·åˆ°ç£ç›˜ï¼Œå˜æˆå¹²å‡€é¡µåæ‰èƒ½å¤ç”¨ã€‚ æ‰€ä»¥ï¼Œåˆ·è„é¡µè™½ç„¶æ˜¯å¸¸æ€ï¼Œä½†æ˜¯å‡ºç°ä»¥ä¸‹è¿™ä¸¤ç§æƒ…å†µï¼Œéƒ½æ˜¯ä¼šæ˜æ˜¾å½±å“æ€§èƒ½çš„:</p><ul><li><p>ä¸€ä¸ªæŸ¥è¯¢è¦æ·˜æ±°çš„è„é¡µä¸ªæ•°å¤ªå¤šï¼Œä¼šå¯¼è‡´æŸ¥è¯¢çš„å“åº”æ—¶é—´æ˜æ˜¾å˜é•¿;</p></li><li><p>æ—¥å¿—å†™æ»¡ï¼Œæ›´æ–°å…¨éƒ¨å µä½ï¼Œå†™æ€§èƒ½è·Œä¸º0ï¼Œè¿™ç§æƒ…å†µå¯¹æ•æ„Ÿä¸šåŠ¡æ¥è¯´ï¼Œæ˜¯ä¸èƒ½æ¥å—çš„ã€‚ </p></li></ul><p>æ‰€ä»¥ï¼ŒInnoDBéœ€è¦æœ‰æ§åˆ¶è„é¡µæ¯”ä¾‹çš„æœºåˆ¶ï¼Œæ¥å°½é‡é¿å…ä¸Šé¢çš„è¿™ä¸¤ç§æƒ…å†µã€‚</p></li></ul><h2 id="InnoDBåˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥"><a href="#InnoDBåˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥" class="headerlink" title="InnoDBåˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥"></a>InnoDBåˆ·è„é¡µçš„æ§åˆ¶ç­–ç•¥</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥å’Œä½ è¯´è¯´InnoDBè„é¡µçš„æ§åˆ¶ç­–ç•¥ï¼Œä»¥åŠå’Œè¿™äº›ç­–ç•¥ç›¸å…³çš„å‚æ•°ã€‚</p><p>é¦–å…ˆï¼Œ<strong>ä½ è¦æ­£ç¡®åœ°å‘Šè¯‰InnoDBæ‰€åœ¨ä¸»æœºçš„IOèƒ½åŠ›</strong>ï¼Œè¿™æ ·InnoDBæ‰èƒ½çŸ¥é“éœ€è¦å…¨åŠ›åˆ·è„é¡µçš„æ—¶ å€™ï¼Œå¯ä»¥åˆ·å¤šå¿«ã€‚</p><p>è¿™å°±è¦ç”¨åˆ° <code>innodb_io_capacity</code> è¿™ä¸ªå‚æ•°äº†ï¼Œå®ƒä¼šå‘Šè¯‰InnoDBä½ çš„ç£ç›˜èƒ½åŠ›ã€‚è¿™ä¸ªå€¼æˆ‘<strong>å»ºè®®ä½ è®¾ç½®æˆç£ç›˜çš„IOPS</strong>ã€‚</p><p>ç£ç›˜çš„IOPSå¯ä»¥é€šè¿‡fioè¿™ä¸ªå·¥å…·æ¥æµ‹è¯•ï¼Œä¸‹é¢çš„è¯­å¥æ˜¯æˆ‘ç”¨æ¥æµ‹è¯•ç£ç›˜éšæœº è¯»å†™çš„å‘½ä»¤:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fio -filename=$filename -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=500M -numjobs=10 -runtime=10 -group_reporting -name=mytest </span><br></pre></td></tr></table></figure><p>å…¶å®ï¼Œå› ä¸ºæ²¡èƒ½æ­£ç¡®åœ°è®¾ç½®innodb_io_capacityå‚æ•°ï¼Œè€Œå¯¼è‡´çš„æ€§èƒ½é—®é¢˜ä¹Ÿæ¯”æ¯”çš†æ˜¯ã€‚ä¹‹å‰ï¼Œå°±æ›¾æœ‰å…¶ä»–å…¬å¸çš„å¼€å‘è´Ÿè´£äººæ‰¾æˆ‘çœ‹ä¸€ä¸ªåº“çš„æ€§èƒ½é—®é¢˜ï¼Œ<strong>è¯´MySQLçš„å†™å…¥é€Ÿåº¦å¾ˆæ…¢ï¼ŒTPSå¾ˆä½ï¼Œ ä½†æ˜¯æ•°æ®åº“ä¸»æœºçš„IOå‹åŠ›å¹¶ä¸å¤§</strong>ã€‚ç»è¿‡ä¸€ç•ªæ’æŸ¥ï¼Œå‘ç°ç½ªé­ç¥¸é¦–å°±æ˜¯è¿™ä¸ªå‚æ•°çš„è®¾ç½®å‡ºäº†é—®é¢˜ã€‚</p><p>ä»–çš„ä¸»æœºç£ç›˜ç”¨çš„æ˜¯SSDï¼Œä½†æ˜¯innodb_io_capacityçš„å€¼è®¾ç½®çš„æ˜¯300ã€‚äºæ˜¯ï¼ŒInnoDBè®¤ä¸ºè¿™ä¸ª ç³»ç»Ÿçš„èƒ½åŠ›å°±è¿™ä¹ˆå·®ï¼Œæ‰€ä»¥åˆ·è„é¡µåˆ·å¾—ç‰¹åˆ«æ…¢ï¼Œç”šè‡³æ¯”è„é¡µç”Ÿæˆçš„é€Ÿåº¦è¿˜æ…¢ï¼Œè¿™æ ·å°±é€ æˆäº†<strong>è„é¡µç´¯ç§¯</strong>ï¼Œå½±å“äº†æŸ¥è¯¢å’Œæ›´æ–°æ€§èƒ½ã€‚</p><p>è™½ç„¶æˆ‘ä»¬ç°åœ¨å·²ç»å®šä¹‰äº†â€œå…¨åŠ›åˆ·è„é¡µâ€çš„è¡Œä¸ºï¼Œä½†å¹³æ—¶æ€»ä¸èƒ½ä¸€ç›´æ˜¯å…¨åŠ›åˆ·å§? æ¯•ç«Ÿç£ç›˜èƒ½åŠ›ä¸èƒ½åªç”¨æ¥åˆ·è„é¡µï¼Œè¿˜éœ€è¦æœåŠ¡ç”¨æˆ·è¯·æ±‚ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€èµ·çœ‹çœ‹InnoDBæ€ä¹ˆæ§åˆ¶å¼•æ“æŒ‰ ç…§â€œå…¨åŠ›â€çš„ç™¾åˆ†æ¯”æ¥åˆ·è„é¡µã€‚</p><h3 id="æ ¹æ®æˆ‘å‰é¢æåˆ°çš„çŸ¥è¯†ç‚¹ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ æ¥è®¾è®¡ç­–ç•¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦ï¼Œä¼šå‚è€ƒå“ªäº›å› ç´ å‘¢"><a href="#æ ¹æ®æˆ‘å‰é¢æåˆ°çš„çŸ¥è¯†ç‚¹ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ æ¥è®¾è®¡ç­–ç•¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦ï¼Œä¼šå‚è€ƒå“ªäº›å› ç´ å‘¢" class="headerlink" title="æ ¹æ®æˆ‘å‰é¢æåˆ°çš„çŸ¥è¯†ç‚¹ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ æ¥è®¾è®¡ç­–ç•¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦ï¼Œä¼šå‚è€ƒå“ªäº›å› ç´ å‘¢?"></a>æ ¹æ®æˆ‘å‰é¢æåˆ°çš„çŸ¥è¯†ç‚¹ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ æ¥è®¾è®¡ç­–ç•¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦ï¼Œä¼šå‚è€ƒå“ªäº›å› ç´ å‘¢?</h3><p>è¿™ä¸ªé—®é¢˜å¯ä»¥è¿™ä¹ˆæƒ³ï¼Œå¦‚æœåˆ·å¤ªæ…¢ï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ?  é¦–å…ˆæ˜¯å†…å­˜è„é¡µå¤ªå¤šï¼Œå…¶æ¬¡æ˜¯redo logå†™æ»¡ã€‚</p><p>æ‰€ä»¥ï¼ŒInnoDBçš„åˆ·ç›˜é€Ÿåº¦å°±æ˜¯è¦å‚è€ƒè¿™ä¸¤ä¸ªå› ç´ :ä¸€ä¸ªæ˜¯è„é¡µæ¯”ä¾‹ï¼Œä¸€ä¸ªæ˜¯redo logå†™ç›˜é€Ÿåº¦ã€‚</p><p>InnoDBä¼šæ ¹æ®è¿™ä¸¤ä¸ªå› ç´ å…ˆå•ç‹¬ç®—å‡ºä¸¤ä¸ªæ•°å­—ã€‚ </p><p>å‚æ•° <code>innodb_max_dirty_pages_pct</code> æ˜¯è„é¡µæ¯”ä¾‹ä¸Šé™ï¼Œé»˜è®¤å€¼æ˜¯75%ã€‚InnoDBä¼šæ ¹æ®å½“å‰çš„è„é¡µæ¯”ä¾‹(å‡è®¾ä¸ºM)ï¼Œç®—å‡ºä¸€ä¸ªèŒƒå›´åœ¨0åˆ°100ä¹‹é—´çš„æ•°å­—ï¼Œè®¡ç®—è¿™ä¸ªæ•°å­—çš„ä¼ªä»£ç ç±»ä¼¼è¿™æ ·:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">F1(M) &#123;</span><br><span class="line">  if M&gt;=innodb_max_dirty_pages_pct then</span><br><span class="line">      return 100;</span><br><span class="line">  return 100*M/innodb_max_dirty_pages_pct;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>InnoDBæ¯æ¬¡å†™å…¥çš„æ—¥å¿—éƒ½æœ‰ä¸€ä¸ªåºå·ï¼Œå½“å‰å†™å…¥çš„åºå·è·Ÿcheckpointå¯¹åº”çš„åºå·ä¹‹é—´çš„å·®å€¼ï¼Œ æˆ‘ä»¬å‡è®¾ä¸ºNã€‚InnoDBä¼šæ ¹æ®è¿™ä¸ªNç®—å‡ºä¸€ä¸ªèŒƒå›´åœ¨0åˆ°100ä¹‹é—´çš„æ•°å­—ï¼Œè¿™ä¸ªè®¡ç®—å…¬å¼å¯ä»¥è®°ä¸º F2(N)ã€‚F2(N)ç®—æ³•æ¯”è¾ƒå¤æ‚ï¼Œä½ åªè¦çŸ¥é“Nè¶Šå¤§ï¼Œç®—å‡ºæ¥çš„å€¼è¶Šå¤§å°±å¥½äº†ã€‚</p><p>ç„¶åï¼Œæ ¹æ®ä¸Šè¿°ç®—å¾—çš„F1(M)å’ŒF2(N)ä¸¤ä¸ªå€¼ï¼Œå–å…¶ä¸­è¾ƒå¤§çš„å€¼è®°ä¸ºRï¼Œä¹‹åå¼•æ“å°±å¯ä»¥æŒ‰ç…§ <code>innodb_io_capacity</code> å®šä¹‰çš„èƒ½åŠ›**ä¹˜ä»¥R%**æ¥æ§åˆ¶åˆ·è„é¡µçš„é€Ÿåº¦ã€‚</p><p>ä¸Šè¿°çš„è®¡ç®—æµç¨‹æ¯”è¾ƒæŠ½è±¡ï¼Œä¸å®¹æ˜“ç†è§£ï¼Œæ‰€ä»¥æˆ‘ç”»äº†ä¸€ä¸ªç®€å•çš„æµç¨‹å›¾ã€‚å›¾ä¸­çš„F1ã€F2å°±æ˜¯ä¸Š é¢æˆ‘ä»¬é€šè¿‡è„é¡µæ¯”ä¾‹å’Œredo logå†™å…¥é€Ÿåº¦ç®—å‡ºæ¥çš„ä¸¤ä¸ªå€¼ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-20c9667918f63b5caa0ca3397366d407a73.png"></p><p>ç°åœ¨ä½ çŸ¥é“äº†ï¼ŒInnoDBä¼šåœ¨åå°åˆ·è„é¡µï¼Œè€Œåˆ·è„é¡µçš„è¿‡ç¨‹æ˜¯è¦å°†å†…å­˜é¡µå†™å…¥ç£ç›˜ã€‚</p><p>æ‰€ä»¥ï¼Œæ— è®ºæ˜¯ä½ çš„æŸ¥è¯¢è¯­å¥åœ¨éœ€è¦å†…å­˜çš„æ—¶å€™å¯èƒ½è¦æ±‚æ·˜æ±°ä¸€ä¸ªè„é¡µï¼Œè¿˜æ˜¯ç”±äºåˆ·è„é¡µçš„é€»è¾‘ä¼šå ç”¨IOèµ„æºå¹¶å¯èƒ½å½±å“åˆ°äº†ä½ çš„æ›´æ–°è¯­å¥ï¼Œéƒ½å¯èƒ½æ˜¯é€ æˆä½ ä»ä¸šåŠ¡ç«¯æ„ŸçŸ¥åˆ°MySQLâ€œæŠ–â€äº†ä¸€ä¸‹çš„åŸå› ã€‚</p><p>è¦å°½é‡é¿å…è¿™ç§æƒ…å†µï¼Œä½ å°±è¦åˆç†åœ°è®¾ç½®innodb_io_capacityçš„å€¼ï¼Œå¹¶ä¸”å¹³æ—¶è¦å¤šå…³æ³¨è„é¡µæ¯”ä¾‹ï¼Œ<strong>ä¸è¦è®©å®ƒç»å¸¸æ¥è¿‘75%ã€‚</strong></p><p>å…¶ä¸­ï¼Œè„é¡µæ¯”ä¾‹æ˜¯é€šè¿‡<code>Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_total</code>å¾—åˆ° çš„ï¼Œå…·ä½“çš„å‘½ä»¤å‚è€ƒä¸‹é¢çš„ä»£ç :</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> VARIABLE_VALUE <span class="keyword">into</span> <span class="variable">@a</span> <span class="keyword">from</span> global_status <span class="keyword">where</span> VARIABLE_NAME <span class="operator">=</span> <span class="string">&#x27;Innodb_buffer_pool_pages_dirty&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> VARIABLE_VALUE <span class="keyword">into</span> <span class="variable">@b</span> <span class="keyword">from</span> global_status <span class="keyword">where</span> VARIABLE_NAME <span class="operator">=</span> <span class="string">&#x27;Innodb_buffer_pool_pages_total&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@a</span><span class="operator">/</span><span class="variable">@b</span>;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸ªæœ‰è¶£çš„ç­–ç•¥ã€‚</p><p>ä¸€æ—¦ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚éœ€è¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å…ˆflushæ‰ä¸€ä¸ªè„é¡µæ—¶ï¼Œè¿™ä¸ªæŸ¥è¯¢å°±å¯èƒ½è¦æ¯”å¹³æ—¶æ…¢äº†ã€‚è€ŒMySQLä¸­çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå¯èƒ½è®©ä½ çš„æŸ¥è¯¢ä¼šæ›´æ…¢ï¼šåœ¨å‡†å¤‡åˆ·ä¸€ä¸ªè„é¡µçš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ªæ•°æ®é¡µæ—è¾¹çš„æ•°æ®é¡µåˆšå¥½æ˜¯è„é¡µï¼Œå°±ä¼šæŠŠè¿™ä¸ªâ€œé‚»å±…â€ä¹Ÿå¸¦ç€ä¸€èµ·åˆ·æ‰ï¼›è€Œä¸”è¿™ä¸ªæŠŠâ€œé‚»å±…â€æ‹–ä¸‹æ°´çš„é€»è¾‘è¿˜å¯ä»¥ç»§ç»­è”“å»¶ï¼Œä¹Ÿå°±æ˜¯å¯¹äºæ¯ä¸ªé‚»å±…æ•°æ®é¡µï¼Œå¦‚æœè·Ÿå®ƒç›¸é‚»çš„æ•°æ®é¡µä¹Ÿè¿˜æ˜¯è„é¡µçš„è¯ï¼Œä¹Ÿä¼šè¢«æ”¾åˆ°ä¸€èµ·åˆ·ã€‚</p><p>åœ¨InnoDBä¸­ï¼Œ<code>innodb_flush_neighbors</code> å‚æ•°å°±æ˜¯ç”¨æ¥æ§åˆ¶è¿™ä¸ªè¡Œä¸ºçš„ï¼Œå€¼ä¸º1çš„æ—¶å€™ä¼šæœ‰ä¸Šè¿°çš„â€œè¿åâ€æœºåˆ¶ï¼Œå€¼ä¸º0æ—¶è¡¨ç¤ºä¸æ‰¾é‚»å±…ï¼Œè‡ªå·±åˆ·è‡ªå·±çš„ã€‚</p><p>æ‰¾â€œé‚»å±…â€è¿™ä¸ªä¼˜åŒ–åœ¨æœºæ¢°ç¡¬ç›˜æ—¶ä»£æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ï¼Œå¯ä»¥å‡å°‘å¾ˆå¤šéšæœºIOã€‚æœºæ¢°ç¡¬ç›˜çš„éšæœºIOPSä¸€èˆ¬åªæœ‰å‡ ç™¾ï¼Œç›¸åŒçš„é€»è¾‘æ“ä½œå‡å°‘éšæœºIOå°±æ„å‘³ç€ç³»ç»Ÿæ€§èƒ½çš„å¤§å¹…åº¦æå‡ã€‚</p><p>è€Œå¦‚æœä½¿ç”¨çš„æ˜¯SSDè¿™ç±»IOPSæ¯”è¾ƒé«˜çš„è®¾å¤‡çš„è¯ï¼Œ<strong>æˆ‘å°±å»ºè®®ä½ æŠŠinnodb_flush_neighborsçš„å€¼è®¾ç½®æˆ0</strong>ã€‚å› ä¸ºè¿™æ—¶å€™IOPSå¾€å¾€ä¸æ˜¯ç“¶é¢ˆï¼Œè€Œâ€œåªåˆ·è‡ªå·±â€ï¼Œå°±èƒ½æ›´å¿«åœ°æ‰§è¡Œå®Œå¿…è¦çš„åˆ·è„é¡µæ“ä½œï¼Œå‡å°‘SQLè¯­å¥å“åº”æ—¶é—´ã€‚</p><p><strong>åœ¨MySQL 8.0ä¸­ï¼Œinnodb_flush_neighborså‚æ•°çš„é»˜è®¤å€¼å·²ç»æ˜¯0äº†ã€‚</strong></p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>ä»Šå¤©è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å»¶ç»­ç¬¬2ç¯‡ä¸­ä»‹ç»çš„WALçš„æ¦‚å¿µï¼Œå’Œä½ è§£é‡Šäº†è¿™ä¸ªæœºåˆ¶åç»­éœ€è¦çš„åˆ·è„é¡µæ“ä½œå’Œæ‰§è¡Œæ—¶æœºã€‚åˆ©ç”¨WALæŠ€æœ¯ï¼Œæ•°æ®åº“å°†éšæœºå†™è½¬æ¢æˆäº†é¡ºåºå†™ï¼Œå¤§å¤§æå‡äº†æ•°æ®åº“çš„æ€§èƒ½ã€‚</p><p>ä½†æ˜¯ï¼Œç”±æ­¤ä¹Ÿå¸¦æ¥äº†å†…å­˜è„é¡µçš„é—®é¢˜ã€‚è„é¡µä¼šè¢«åå°çº¿ç¨‹è‡ªåŠ¨flushï¼Œä¹Ÿä¼šç”±äºæ•°æ®é¡µæ·˜æ±°è€Œè§¦å‘flushï¼Œè€Œåˆ·è„é¡µçš„è¿‡ç¨‹ç”±äºä¼šå ç”¨èµ„æºï¼Œå¯èƒ½ä¼šè®©ä½ çš„æ›´æ–°å’ŒæŸ¥è¯¢è¯­å¥çš„å“åº”æ—¶é—´é•¿ä¸€äº›ã€‚åœ¨æ–‡ç« é‡Œï¼Œæˆ‘ä¹Ÿç»™ä½ ä»‹ç»äº†æ§åˆ¶åˆ·è„é¡µçš„æ–¹æ³•å’Œå¯¹åº”çš„ç›‘æ§æ–¹å¼ã€‚</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä¸€ä¸ªå†…å­˜é…ç½®ä¸º128GBã€innodb_io_capacityè®¾ç½®ä¸º20000çš„å¤§è§„æ ¼å®ä¾‹ï¼Œæ­£å¸¸ä¼šå»ºè®®ä½ å°†redo logè®¾ç½®æˆ4ä¸ª1GBçš„æ–‡ä»¶ã€‚</p><p>ä½†å¦‚æœä½ åœ¨é…ç½®çš„æ—¶å€™ä¸æ…å°†redo logè®¾ç½®æˆäº†1ä¸ª100Mçš„æ–‡ä»¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿåˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µå‘¢ï¼Ÿ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹&quot;&gt;&lt;a href=&quot;#æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹&quot; class=&quot;headerlink&quot; title=&quot;æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹&quot;&gt;&lt;/a&gt;æˆ‘çš„mysqlä¸ºä»€ä¹ˆä¼šæŠ–ä¸€ä¸‹&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;innodbå¼•æ“æ˜¯</summary>
      
    
    
    
    
    <category term="MySQL" scheme="http://example.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„</title>
    <link href="http://example.com/wiki/%E4%B8%80%E6%9D%A1%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/"/>
    <id>http://example.com/wiki/%E4%B8%80%E6%9D%A1%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/</id>
    <published>2021-12-06T10:47:01.000Z</published>
    <updated>2021-12-06T10:47:33.600Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„"><a href="#ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„" class="headerlink" title="ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„"></a>ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„</h1><p>å‰é¢æˆ‘ä»¬ç³»ç»Ÿäº†è§£äº†ä¸€ä¸ªæŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼Œå¹¶ä»‹ç»äº†æ‰§è¡Œè¿‡ç¨‹ä¸­æ¶‰åŠçš„å¤„ç†æ¨¡å—ã€‚ç›¸ä¿¡ä½ è¿˜ è®°å¾—ï¼Œä¸€æ¡æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸€èˆ¬æ˜¯ç»è¿‡è¿æ¥å™¨ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰åŠŸèƒ½æ¨¡å—ï¼Œæœ€å åˆ°è¾¾å­˜å‚¨å¼•æ“ã€‚</p><p>é‚£ä¹ˆï¼Œä¸€æ¡æ›´æ–°è¯­å¥çš„æ‰§è¡Œæµç¨‹åˆæ˜¯æ€æ ·çš„å‘¢?</p><p>ä¹‹å‰ä½ å¯èƒ½ç»å¸¸å¬DBAåŒäº‹è¯´ï¼ŒMySQLå¯ä»¥æ¢å¤åˆ°åŠä¸ªæœˆå†…ä»»æ„ä¸€ç§’çš„çŠ¶æ€ï¼ŒæƒŠå¹çš„åŒæ—¶ï¼Œä½  æ˜¯ä¸æ˜¯å¿ƒä¸­ä¹Ÿä¼šä¸å…ä¼šå¥½å¥‡ï¼Œè¿™æ˜¯æ€æ ·åšåˆ°çš„å‘¢?</p><p>æˆ‘ä»¬è¿˜æ˜¯ä»ä¸€ä¸ªè¡¨çš„ä¸€æ¡æ›´æ–°è¯­å¥è¯´èµ·ï¼Œä¸‹é¢æ˜¯è¿™ä¸ªè¡¨çš„åˆ›å»ºè¯­å¥ï¼Œè¿™ä¸ªè¡¨æœ‰ä¸€ä¸ªä¸»é”®IDå’Œä¸€ä¸ª æ•´å‹å­—æ®µc:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table T(ID int primary key, c int);</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦å°†ID=2è¿™ä¸€è¡Œçš„å€¼åŠ 1ï¼ŒSQLè¯­å¥å°±ä¼šè¿™ä¹ˆå†™:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update T set c=c+1 where ID=2;</span><br></pre></td></tr></table></figure><p>å‰é¢æˆ‘æœ‰è·Ÿä½ ä»‹ç»è¿‡SQLè¯­å¥åŸºæœ¬çš„æ‰§è¡Œé“¾è·¯ï¼Œè¿™é‡Œæˆ‘å†æŠŠé‚£å¼ å›¾æ‹¿è¿‡æ¥ï¼Œä½ ä¹Ÿå¯ä»¥å…ˆç®€å•çœ‹çœ‹ è¿™ä¸ªå›¾å›é¡¾ä¸‹ã€‚é¦–å…ˆï¼Œå¯ä»¥ç¡®å®šçš„è¯´ï¼ŒæŸ¥è¯¢è¯­å¥çš„é‚£ä¸€å¥—æµç¨‹ï¼Œæ›´æ–°è¯­å¥ä¹Ÿæ˜¯åŒæ ·ä¼šèµ°ä¸€éã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-661c52fa2ca85182e119823265a003d152b.png" alt="MySQLçš„é€»è¾‘æ¶æ„å›¾"></p><p>ä½ æ‰§è¡Œè¯­å¥å‰è¦å…ˆè¿æ¥æ•°æ®åº“ï¼Œè¿™æ˜¯è¿æ¥å™¨çš„å·¥ä½œã€‚</p><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œ<font color=blue>åœ¨ä¸€ä¸ªè¡¨ä¸Šæœ‰æ›´æ–°çš„æ—¶å€™ï¼Œè·Ÿè¿™ä¸ªè¡¨æœ‰å…³çš„æŸ¥è¯¢ç¼“å­˜ä¼šå¤±æ•ˆï¼Œæ‰€ä»¥è¿™æ¡è¯­å¥å°±ä¼š æŠŠè¡¨Tä¸Šæ‰€æœ‰ç¼“å­˜ç»“æœéƒ½æ¸…ç©ºã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜çš„åŸå› ã€‚</font></p><p>æ¥ä¸‹æ¥ï¼Œåˆ†æå™¨ä¼šé€šè¿‡è¯æ³•å’Œè¯­æ³•è§£æçŸ¥é“è¿™æ˜¯ä¸€æ¡æ›´æ–°è¯­å¥ã€‚ä¼˜åŒ–å™¨å†³å®šè¦ä½¿ç”¨IDè¿™ä¸ªç´¢å¼•ã€‚ ç„¶åï¼Œæ‰§è¡Œå™¨è´Ÿè´£å…·ä½“æ‰§è¡Œï¼Œæ‰¾åˆ°è¿™ä¸€è¡Œï¼Œç„¶åæ›´æ–°ã€‚</p><p>ä¸æŸ¥è¯¢æµç¨‹ä¸ä¸€æ ·çš„æ˜¯ï¼Œæ›´æ–°æµç¨‹è¿˜æ¶‰åŠä¸¤ä¸ªé‡è¦çš„æ—¥å¿—æ¨¡å—ï¼Œå®ƒä»¬æ­£æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®¨è®ºçš„ä¸» è§’:<strong>redo log(é‡åšæ—¥å¿—)å’Œ binlog(å½’æ¡£æ—¥å¿—)<strong>ã€‚å¦‚æœæ¥è§¦MySQLï¼Œé‚£è¿™ä¸¤ä¸ªè¯è‚¯å®šæ˜¯ç»•ä¸è¿‡ çš„ï¼Œæˆ‘åé¢çš„å†…å®¹é‡Œä¹Ÿä¼šä¸æ–­åœ°å’Œä½ å¼ºè°ƒã€‚</strong>ä¸è¿‡è¯è¯´å›æ¥ï¼Œredo logå’Œbinlogåœ¨è®¾è®¡ä¸Šæœ‰å¾ˆå¤šæœ‰ æ„æ€çš„åœ°æ–¹ï¼Œè¿™äº›è®¾è®¡æ€è·¯ä¹Ÿå¯ä»¥ç”¨åˆ°ä½ è‡ªå·±çš„ç¨‹åºé‡Œã€‚</strong></p><h2 id="é‡è¦çš„æ—¥å¿—æ¨¡å—-redo-log"><a href="#é‡è¦çš„æ—¥å¿—æ¨¡å—-redo-log" class="headerlink" title="é‡è¦çš„æ—¥å¿—æ¨¡å—:redo log"></a>é‡è¦çš„æ—¥å¿—æ¨¡å—:redo log</h2><p>ä¸çŸ¥é“ä½ è¿˜è®°ä¸è®°å¾—ã€Šå­”ä¹™å·±ã€‹è¿™ç¯‡æ–‡ç« ï¼Œé…’åº—æŒæŸœæœ‰ä¸€ä¸ªç²‰æ¿ï¼Œä¸“é—¨ç”¨æ¥è®°å½•å®¢äººçš„èµŠè´¦è®° å½•ã€‚å¦‚æœèµŠè´¦çš„äººä¸å¤šï¼Œé‚£ä¹ˆä»–å¯ä»¥æŠŠé¡¾å®¢åå’Œè´¦ç›®å†™åœ¨æ¿ä¸Šã€‚ä½†å¦‚æœèµŠè´¦çš„äººå¤šäº†ï¼Œç²‰æ¿æ€»ä¼š æœ‰è®°ä¸ä¸‹çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™æŒæŸœä¸€å®šè¿˜æœ‰ä¸€ä¸ªä¸“é—¨è®°å½•èµŠè´¦çš„è´¦æœ¬ã€‚</p><p>å¦‚æœæœ‰äººè¦èµŠè´¦æˆ–è€…è¿˜è´¦çš„è¯ï¼ŒæŒæŸœä¸€èˆ¬æœ‰ä¸¤ç§åšæ³•:</p><ul><li><p>ä¸€ç§åšæ³•æ˜¯ç›´æ¥æŠŠè´¦æœ¬ç¿»å‡ºæ¥ï¼ŒæŠŠè¿™æ¬¡èµŠçš„è´¦åŠ ä¸Šå»æˆ–è€…æ‰£é™¤æ‰;</p></li><li><p>å¦ä¸€ç§åšæ³•æ˜¯å…ˆåœ¨ç²‰æ¿ä¸Šè®°ä¸‹è¿™æ¬¡çš„è´¦ï¼Œç­‰æ‰“çƒŠä»¥åå†æŠŠè´¦æœ¬ç¿»å‡ºæ¥æ ¸ç®—ã€‚</p></li></ul><p>åœ¨ç”Ÿæ„çº¢ç«æŸœå°å¾ˆå¿™æ—¶ï¼ŒæŒæŸœä¸€å®šä¼šé€‰æ‹©åè€…ï¼Œå› ä¸ºå‰è€…æ“ä½œå®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ã€‚é¦–å…ˆï¼Œä½ å¾—æ‰¾åˆ° è¿™ä¸ªäººçš„èµŠè´¦æ€»é¢é‚£æ¡è®°å½•ã€‚ä½ æƒ³æƒ³ï¼Œå¯†å¯†éº»éº»å‡ åé¡µï¼ŒæŒæŸœè¦æ‰¾åˆ°é‚£ä¸ªåå­—ï¼Œå¯èƒ½è¿˜å¾—å¸¦ä¸Šè€ èŠ±é•œæ…¢æ…¢æ‰¾ï¼Œæ‰¾åˆ°ä¹‹åå†æ‹¿å‡ºç®—ç›˜è®¡ç®—ï¼Œæœ€åå†å°†ç»“æœå†™å›åˆ°è´¦æœ¬ä¸Šã€‚</p><p>è¿™æ•´ä¸ªè¿‡ç¨‹æƒ³æƒ³éƒ½éº»çƒ¦ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œè¿˜æ˜¯å…ˆåœ¨ç²‰æ¿ä¸Šè®°ä¸€ä¸‹æ–¹ä¾¿ã€‚ä½ æƒ³æƒ³ï¼Œå¦‚æœæŒæŸœæ²¡æœ‰ç²‰æ¿çš„ å¸®åŠ©ï¼Œæ¯æ¬¡è®°è´¦éƒ½å¾—ç¿»è´¦æœ¬ï¼Œæ•ˆç‡æ˜¯ä¸æ˜¯ä½å¾—è®©äººéš¾ä»¥å¿å—?</p><p>åŒæ ·ï¼Œ<font color=blue>åœ¨MySQLé‡Œä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœæ¯ä¸€æ¬¡çš„æ›´æ–°æ“ä½œéƒ½éœ€è¦å†™è¿›ç£ç›˜ï¼Œç„¶åç£ç›˜ä¹Ÿè¦æ‰¾åˆ° å¯¹åº”çš„é‚£æ¡è®°å½•ï¼Œç„¶åå†æ›´æ–°ï¼Œæ•´ä¸ªè¿‡ç¨‹IOæˆæœ¬ã€æŸ¥æ‰¾æˆæœ¬éƒ½å¾ˆé«˜ã€‚</font>ä¸ºäº†è§£å†³è¿™ä¸ªé—® é¢˜ï¼ŒMySQLçš„è®¾è®¡è€…å°±ç”¨äº†ç±»ä¼¼é…’åº—æŒæŸœç²‰æ¿çš„æ€è·¯æ¥æå‡æ›´æ–°æ•ˆç‡ã€‚</p><p>è€Œç²‰æ¿å’Œè´¦æœ¬é…åˆçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯MySQLé‡Œç»å¸¸è¯´åˆ°çš„<code>WAL</code>æŠ€æœ¯ï¼ŒWALçš„å…¨ç§°æ˜¯<code>Write- Ahead Logging</code>ï¼Œ<font color=red>å®ƒçš„å…³é”®ç‚¹å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜</font>ï¼Œä¹Ÿå°±æ˜¯å…ˆå†™ç²‰æ¿ï¼Œç­‰ä¸å¿™çš„æ—¶å€™å†å†™è´¦æœ¬ã€‚</p><blockquote><p>å…·ä½“æ¥è¯´ï¼Œå½“æœ‰ä¸€æ¡è®°å½•éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼ŒInnoDBå¼•æ“å°±ä¼šå…ˆæŠŠè®°å½•å†™åˆ°redo log(ç²‰æ¿)é‡Œ é¢ï¼Œå¹¶æ›´æ–°å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚åŒæ—¶ï¼ŒInnoDBå¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªæ“ä½œ è®°å½•æ›´æ–°åˆ°ç£ç›˜é‡Œé¢ï¼Œè€Œè¿™ä¸ªæ›´æ–°å¾€å¾€æ˜¯åœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—²çš„æ—¶å€™åšï¼Œè¿™å°±åƒæ‰“çƒŠä»¥åæŒæŸœåšçš„äº‹ã€‚</p></blockquote><p>å¦‚æœä»Šå¤©èµŠè´¦çš„ä¸å¤šï¼ŒæŒæŸœå¯ä»¥ç­‰æ‰“çƒŠåå†æ•´ç†ã€‚ä½†å¦‚æœæŸå¤©èµŠè´¦çš„ç‰¹åˆ«å¤šï¼Œç²‰æ¿å†™æ»¡äº†ï¼Œåˆæ€ ä¹ˆåŠå‘¢?è¿™ä¸ªæ—¶å€™æŒæŸœåªå¥½æ”¾ä¸‹æ‰‹ä¸­çš„æ´»å„¿ï¼ŒæŠŠç²‰æ¿ä¸­çš„ä¸€éƒ¨åˆ†èµŠè´¦è®°å½•æ›´æ–°åˆ°è´¦æœ¬ä¸­ï¼Œç„¶åæŠŠ è¿™äº›è®°å½•ä»ç²‰æ¿ä¸Šæ“¦æ‰ï¼Œä¸ºè®°æ–°è´¦è…¾å‡ºç©ºé—´ã€‚</p><p>ä¸æ­¤ç±»ä¼¼ï¼ŒInnoDBçš„redo logæ˜¯å›ºå®šå¤§å°çš„ï¼Œæ¯”å¦‚å¯ä»¥é…ç½®ä¸ºä¸€ç»„4ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯ 1GBï¼Œé‚£ä¹ˆè¿™å—â€œç²‰æ¿â€æ€»å…±å°±å¯ä»¥è®°å½•4GBçš„æ“ä½œã€‚ä»å¤´å¼€å§‹å†™ï¼Œå†™åˆ°æœ«å°¾å°±åˆå›åˆ°å¼€å¤´å¾ªç¯ å†™ï¼Œå¦‚ä¸‹é¢è¿™ä¸ªå›¾æ‰€ç¤ºã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-846e5f4de8648713e24cdd7a028b547f4a6.png"></p><p>write posæ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œä¸€è¾¹å†™ä¸€è¾¹åç§»ï¼Œå†™åˆ°ç¬¬3å·æ–‡ä»¶æœ«å°¾åå°±å›åˆ°0å·æ–‡ä»¶å¼€å¤´ã€‚ checkpointæ˜¯å½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œä¹Ÿæ˜¯å¾€åæ¨ç§»å¹¶ä¸”å¾ªç¯çš„ï¼Œæ“¦é™¤è®°å½•å‰è¦æŠŠè®°å½•æ›´æ–°åˆ°æ•°æ®æ–‡ ä»¶ã€‚</p><p>write poså’Œcheckpointä¹‹é—´çš„æ˜¯â€œç²‰æ¿â€ä¸Šè¿˜ç©ºç€çš„éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ¥è®°å½•æ–°çš„æ“ä½œã€‚å¦‚æœwrite pos è¿½ä¸Šcheckpointï¼Œè¡¨ç¤ºâ€œç²‰æ¿â€æ»¡äº†ï¼Œè¿™æ—¶å€™ä¸èƒ½å†æ‰§è¡Œæ–°çš„æ›´æ–°ï¼Œå¾—åœä¸‹æ¥å…ˆæ“¦æ‰ä¸€äº›è®°å½•ï¼ŒæŠŠ checkpointæ¨è¿›ä¸€ä¸‹ã€‚</p><p>æœ‰äº†redo logï¼ŒInnoDBå°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¹‹å‰æäº¤çš„è®°å½•éƒ½ä¸ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªèƒ½åŠ›ç§°ä¸ºcrash-safeã€‚</p><p>è¦ç†è§£crash-safeè¿™ä¸ªæ¦‚å¿µï¼Œå¯ä»¥æƒ³æƒ³æˆ‘ä»¬å‰é¢èµŠè´¦è®°å½•çš„ä¾‹å­ã€‚åªè¦èµŠè´¦è®°å½•è®°åœ¨äº†ç²‰æ¿ä¸Šæˆ– å†™åœ¨äº†è´¦æœ¬ä¸Šï¼Œä¹‹åå³ä½¿æŒæŸœå¿˜è®°äº†ï¼Œæ¯”å¦‚çªç„¶åœä¸šå‡ å¤©ï¼Œæ¢å¤ç”Ÿæ„åä¾ç„¶å¯ä»¥é€šè¿‡è´¦æœ¬å’Œç²‰æ¿ ä¸Šçš„æ•°æ®æ˜ç¡®èµŠè´¦è´¦ç›®ã€‚</p><h2 id="é‡è¦çš„æ—¥å¿—æ¨¡å—-binlog"><a href="#é‡è¦çš„æ—¥å¿—æ¨¡å—-binlog" class="headerlink" title="é‡è¦çš„æ—¥å¿—æ¨¡å—:binlog"></a>é‡è¦çš„æ—¥å¿—æ¨¡å—:binlog</h2><p>å‰é¢æˆ‘ä»¬è®²è¿‡ï¼ŒMySQLæ•´ä½“æ¥çœ‹ï¼Œå…¶å®å°±æœ‰ä¸¤å—:ä¸€å—æ˜¯Serverå±‚ï¼Œå®ƒä¸»è¦åšçš„æ˜¯MySQLåŠŸèƒ½ å±‚é¢çš„äº‹æƒ…;è¿˜æœ‰ä¸€å—æ˜¯å¼•æ“å±‚ï¼Œè´Ÿè´£å­˜å‚¨ç›¸å…³çš„å…·ä½“äº‹å®œã€‚ä¸Šé¢æˆ‘ä»¬èŠåˆ°çš„ç²‰æ¿redo logæ˜¯ InnoDBå¼•æ“ç‰¹æœ‰çš„æ—¥å¿—ï¼Œè€ŒServerå±‚ä¹Ÿæœ‰è‡ªå·±çš„æ—¥å¿—ï¼Œç§°ä¸ºbinlog(å½’æ¡£æ—¥å¿—)ã€‚</p><p>æˆ‘æƒ³ä½ è‚¯å®šä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä»½æ—¥å¿—å‘¢?</p><p>å› ä¸ºæœ€å¼€å§‹MySQLé‡Œå¹¶æ²¡æœ‰InnoDBå¼•æ“ã€‚MySQLè‡ªå¸¦çš„å¼•æ“æ˜¯MyISAMï¼Œä½†æ˜¯MyISAMæ²¡æœ‰ crash-safeçš„èƒ½åŠ›ï¼Œbinlogæ—¥å¿—åªèƒ½ç”¨äºå½’æ¡£ã€‚è€ŒInnoDBæ˜¯å¦ä¸€ä¸ªå…¬å¸ä»¥æ’ä»¶å½¢å¼å¼•å…¥MySQL çš„ï¼Œæ—¢ç„¶åªä¾é binlogæ˜¯æ²¡æœ‰crash-safeèƒ½åŠ›çš„ï¼Œæ‰€ä»¥InnoDBä½¿ç”¨å¦å¤–ä¸€å¥—æ—¥å¿—ç³»ç»Ÿâ€” â€” ä¹Ÿå°±æ˜¯redo logæ¥å®ç°crash-safeèƒ½åŠ›ã€‚</p><p>è¿™ä¸¤ç§æ—¥å¿—æœ‰ä»¥ä¸‹ä¸‰ç‚¹ä¸åŒã€‚</p><ol><li><font color=red>redologæ˜¯InnoDBå¼•æ“ç‰¹æœ‰çš„;</font> binlogæ˜¯MySQLçš„Serverå±‚å®ç°çš„ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ã€‚</li><li>redologæ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€; binlogæ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œæ¯”å¦‚â€œç»™ID=2è¿™ä¸€è¡Œçš„cå­—æ®µåŠ 1 â€ã€‚</li><li>redologæ˜¯å¾ªç¯å†™çš„ï¼Œç©ºé—´å›ºå®šä¼šç”¨å®Œ;binlogæ˜¯å¯ä»¥è¿½åŠ å†™å…¥çš„ã€‚â€œè¿½åŠ å†™â€æ˜¯æŒ‡binlogæ–‡ä»¶å†™åˆ°ä¸€å®šå¤§å°åä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼Œå¹¶ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ã€‚</li></ol><p>æœ‰äº†å¯¹è¿™ä¸¤ä¸ªæ—¥å¿—çš„æ¦‚å¿µæ€§ç†è§£ï¼Œæˆ‘ä»¬å†æ¥çœ‹æ‰§è¡Œå™¨å’ŒInnoDBå¼•æ“åœ¨æ‰§è¡Œè¿™ä¸ªç®€å•çš„updateè¯­ å¥æ—¶çš„å†…éƒ¨æµç¨‹ã€‚</p><ol><li>æ‰§è¡Œå™¨å…ˆæ‰¾å¼•æ“å–ID=2è¿™ä¸€è¡Œã€‚IDæ˜¯ä¸»é”®ï¼Œå¼•æ“ç›´æ¥ç”¨æ ‘æœç´¢æ‰¾åˆ°è¿™ä¸€è¡Œã€‚å¦‚æœID=2è¿™ä¸€ è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨å†…å­˜ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨;å¦åˆ™ï¼Œéœ€è¦å…ˆä»ç£ç›˜è¯»å…¥å†…å­˜ï¼Œç„¶ åå†è¿”å›ã€‚</li><li>æ‰§è¡Œå™¨æ‹¿åˆ°å¼•æ“ç»™çš„è¡Œæ•°æ®ï¼ŒæŠŠè¿™ä¸ªå€¼åŠ ä¸Š1ï¼Œæ¯”å¦‚åŸæ¥æ˜¯Nï¼Œç°åœ¨å°±æ˜¯N+1ï¼Œå¾—åˆ°æ–°çš„ä¸€è¡Œ æ•°æ®ï¼Œå†è°ƒç”¨å¼•æ“æ¥å£å†™å…¥è¿™è¡Œæ–°æ•°æ®ã€‚</li><li>å¼•æ“å°†è¿™è¡Œæ–°æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼ŒåŒæ—¶å°†è¿™ä¸ªæ›´æ–°æ“ä½œè®°å½•åˆ°redologé‡Œé¢ï¼Œæ­¤æ—¶redologå¤„ äºprepareçŠ¶æ€ã€‚ç„¶åå‘ŠçŸ¥æ‰§è¡Œå™¨æ‰§è¡Œå®Œæˆäº†ï¼Œéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡ã€‚</li><li>æ‰§è¡Œå™¨ç”Ÿæˆè¿™ä¸ªæ“ä½œçš„binlogï¼Œå¹¶æŠŠbinlogå†™å…¥ç£ç›˜ã€‚</li><li>æ‰§è¡Œå™¨è°ƒç”¨å¼•æ“çš„æäº¤äº‹åŠ¡æ¥å£ï¼Œå¼•æ“æŠŠåˆšåˆšå†™å…¥çš„redologæ”¹æˆæäº¤(commit)çŠ¶æ€ï¼Œæ›´æ–°å®Œæˆã€‚</li></ol><p>è¿™é‡Œæˆ‘ç»™å‡ºè¿™ä¸ªupdateè¯­å¥çš„æ‰§è¡Œæµç¨‹å›¾ï¼Œå›¾ä¸­æµ…è‰²æ¡†è¡¨ç¤ºæ˜¯åœ¨InnoDBå†…éƒ¨æ‰§è¡Œçš„ï¼Œæ·±è‰²æ¡†è¡¨ç¤ºæ˜¯åœ¨æ‰§è¡Œå™¨ä¸­æ‰§è¡Œçš„ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-67fa7fe81e054dbaaae134dea88c9d651f3.png"></p><p><strong><font color=blue>ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œæœ€åä¸‰æ­¥çœ‹ä¸Šå»æœ‰ç‚¹â€œç»•â€ï¼Œå°†redo logçš„å†™å…¥æ‹†æˆäº†ä¸¤ä¸ªæ­¥éª¤:prepareå’Œcommitï¼Œè¿™å°±æ˜¯â€ä¸¤é˜¶æ®µæäº¤â€ã€‚</font></strong></p><h2 id="ä¸¤é˜¶æ®µæäº¤"><a href="#ä¸¤é˜¶æ®µæäº¤" class="headerlink" title="ä¸¤é˜¶æ®µæäº¤"></a>ä¸¤é˜¶æ®µæäº¤</h2><p>ä¸ºä»€ä¹ˆå¿…é¡»æœ‰â€œä¸¤é˜¶æ®µæäº¤â€å‘¢?è¿™æ˜¯ä¸ºäº†è®©ä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸€è‡´ã€‚è¦è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¾— ä»æ–‡ç« å¼€å¤´çš„é‚£ä¸ªé—®é¢˜è¯´èµ·:æ€æ ·è®©æ•°æ®åº“æ¢å¤åˆ°åŠä¸ªæœˆå†…ä»»æ„ä¸€ç§’çš„çŠ¶æ€?</p><p>å‰é¢æˆ‘ä»¬è¯´è¿‡äº†ï¼Œbinlogä¼šè®°å½•æ‰€æœ‰çš„é€»è¾‘æ“ä½œï¼Œå¹¶ä¸”æ˜¯é‡‡ç”¨â€œè¿½åŠ å†™â€çš„å½¢å¼ã€‚å¦‚æœä½ çš„DBAæ‰¿ è¯ºè¯´åŠä¸ªæœˆå†…å¯ä»¥æ¢å¤ï¼Œé‚£ä¹ˆå¤‡ä»½ç³»ç»Ÿä¸­ä¸€å®šä¼šä¿å­˜æœ€è¿‘åŠä¸ªæœˆçš„æ‰€æœ‰binlogï¼ŒåŒæ—¶ç³»ç»Ÿä¼šå®šæœŸ åšæ•´åº“å¤‡ä»½ã€‚è¿™é‡Œçš„â€œå®šæœŸâ€å–å†³äºç³»ç»Ÿçš„é‡è¦æ€§ï¼Œå¯ä»¥æ˜¯ä¸€å¤©ä¸€å¤‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€å‘¨ä¸€å¤‡ã€‚</p><p>å½“éœ€è¦æ¢å¤åˆ°æŒ‡å®šçš„æŸä¸€ç§’æ—¶ï¼Œæ¯”å¦‚æŸå¤©ä¸‹åˆä¸¤ç‚¹å‘ç°ä¸­åˆåäºŒç‚¹æœ‰ä¸€æ¬¡è¯¯åˆ è¡¨ï¼Œéœ€è¦æ‰¾å›æ•° æ®ï¼Œé‚£ä½ å¯ä»¥è¿™ä¹ˆåš:</p><ul><li><p>é¦–å…ˆï¼Œæ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œå¦‚æœä½ è¿æ°”å¥½ï¼Œå¯èƒ½å°±æ˜¯æ˜¨å¤©æ™šä¸Šçš„ä¸€ä¸ªå¤‡ä»½ï¼Œä»è¿™ä¸ªå¤‡ ä»½æ¢å¤åˆ°ä¸´æ—¶åº“;</p></li><li><p>ç„¶åï¼Œä»å¤‡ä»½çš„æ—¶é—´ç‚¹å¼€å§‹ï¼Œå°†å¤‡ä»½çš„binlogä¾æ¬¡å–å‡ºæ¥ï¼Œé‡æ”¾åˆ°ä¸­åˆè¯¯åˆ è¡¨ä¹‹å‰çš„é‚£ä¸ªæ—¶åˆ»ã€‚</p></li></ul><p>è¿™æ ·ä½ çš„ä¸´æ—¶åº“å°±è·Ÿè¯¯åˆ ä¹‹å‰çš„çº¿ä¸Šåº“ä¸€æ ·äº†ï¼Œç„¶åä½ å¯ä»¥æŠŠè¡¨æ•°æ®ä»ä¸´æ—¶åº“å–å‡ºæ¥ï¼ŒæŒ‰éœ€è¦æ¢å¤åˆ°çº¿ä¸Šåº“å»ã€‚</p><p>å¥½äº†ï¼Œè¯´å®Œäº†æ•°æ®æ¢å¤è¿‡ç¨‹ï¼Œæˆ‘ä»¬å›æ¥è¯´è¯´ï¼Œä¸ºä»€ä¹ˆæ—¥å¿—éœ€è¦â€œä¸¤é˜¶æ®µæäº¤â€ã€‚è¿™é‡Œä¸å¦¨ç”¨åè¯æ³• æ¥è¿›è¡Œè§£é‡Šã€‚</p><blockquote><p>ç”±äºredo logå’Œbinlogæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„é€»è¾‘ï¼Œå¦‚æœä¸ç”¨ä¸¤é˜¶æ®µæäº¤ï¼Œè¦ä¹ˆå°±æ˜¯å…ˆå†™å®Œredo logå†å†™ binlogï¼Œæˆ–è€…é‡‡ç”¨åè¿‡æ¥çš„é¡ºåºã€‚æˆ‘ä»¬çœ‹çœ‹è¿™ä¸¤ç§æ–¹å¼ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p></blockquote><p>ä»ç„¶ç”¨å‰é¢çš„updateè¯­å¥æ¥åšä¾‹å­ã€‚å‡è®¾å½“å‰ID=2çš„è¡Œï¼Œå­—æ®µcçš„å€¼æ˜¯0ï¼Œå†å‡è®¾æ‰§è¡Œupdateè¯­ å¥è¿‡ç¨‹ä¸­åœ¨å†™å®Œç¬¬ä¸€ä¸ªæ—¥å¿—åï¼Œç¬¬äºŒä¸ªæ—¥å¿—è¿˜æ²¡æœ‰å†™å®ŒæœŸé—´å‘ç”Ÿäº†crashï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢?</p><ul><li><p>å…ˆå†™redo logåå†™binlogã€‚å‡è®¾åœ¨redo logå†™å®Œï¼Œbinlogè¿˜æ²¡æœ‰å†™å®Œçš„æ—¶å€™ï¼ŒMySQLè¿›ç¨‹å¼‚ å¸¸é‡å¯ã€‚ç”±äºæˆ‘ä»¬å‰é¢è¯´è¿‡çš„ï¼Œredo logå†™å®Œä¹‹åï¼Œç³»ç»Ÿå³ä½¿å´©æºƒï¼Œä»ç„¶èƒ½å¤ŸæŠŠæ•°æ®æ¢å¤å› æ¥ï¼Œæ‰€ä»¥æ¢å¤åè¿™ä¸€è¡Œcçš„å€¼æ˜¯1ã€‚ ä½†æ˜¯ç”±äºbinlogæ²¡å†™å®Œå°±crashäº†ï¼Œè¿™æ—¶å€™binlogé‡Œé¢å°±æ²¡æœ‰è®°å½•è¿™ä¸ªè¯­å¥ã€‚å› æ­¤ï¼Œä¹‹åå¤‡ä»½ æ—¥å¿—çš„æ—¶å€™ï¼Œå­˜èµ·æ¥çš„binlogé‡Œé¢å°±æ²¡æœ‰è¿™æ¡è¯­å¥ã€‚ ç„¶åä½ ä¼šå‘ç°ï¼Œå¦‚æœéœ€è¦ç”¨è¿™ä¸ªbinlogæ¥æ¢å¤ä¸´æ—¶åº“çš„è¯ï¼Œç”±äºè¿™ä¸ªè¯­å¥çš„binlogä¸¢å¤±ï¼Œè¿™ ä¸ªä¸´æ—¶åº“å°±ä¼šå°‘äº†è¿™ä¸€æ¬¡æ›´æ–°ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œcçš„å€¼å°±æ˜¯0ï¼Œä¸åŸåº“çš„å€¼ä¸åŒã€‚</p></li><li><p>å…ˆå†™binlogåå†™redo logã€‚å¦‚æœåœ¨binlogå†™å®Œä¹‹åcrashï¼Œç”±äºredo logè¿˜æ²¡å†™ï¼Œå´©æºƒæ¢å¤ä»¥ åè¿™ä¸ªäº‹åŠ¡æ— æ•ˆï¼Œæ‰€ä»¥è¿™ä¸€è¡Œcçš„å€¼æ˜¯0ã€‚ä½†æ˜¯binlogé‡Œé¢å·²ç»è®°å½•äº†â€œæŠŠcä»0æ”¹æˆ1â€è¿™ä¸ªæ—¥ å¿—ã€‚æ‰€ä»¥ï¼Œåœ¨ä¹‹åç”¨binlogæ¥æ¢å¤çš„æ—¶å€™å°±å¤šäº†ä¸€ä¸ªäº‹åŠ¡å‡ºæ¥ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œcçš„å€¼å°±æ˜¯ 1ï¼Œä¸åŸåº“çš„å€¼ä¸åŒã€‚</p></li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¸ä½¿ç”¨â€œä¸¤é˜¶æ®µæäº¤â€ï¼Œ<font color=blue>é‚£ä¹ˆæ•°æ®åº“çš„çŠ¶æ€å°±æœ‰å¯èƒ½å’Œç”¨å®ƒçš„æ—¥å¿—æ¢å¤å‡ºæ¥çš„åº“çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚</font></p><p>ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿™ä¸ªæ¦‚ç‡æ˜¯ä¸æ˜¯å¾ˆä½ï¼Œå¹³æ—¶ä¹Ÿæ²¡æœ‰ä»€ä¹ˆåŠ¨ä¸åŠ¨å°±éœ€è¦æ¢å¤ä¸´æ—¶åº“çš„åœºæ™¯å‘€?</p><p>å…¶å®ä¸æ˜¯çš„ï¼Œä¸åªæ˜¯è¯¯æ“ä½œåéœ€è¦ç”¨è¿™ä¸ªè¿‡ç¨‹æ¥æ¢å¤æ•°æ®ã€‚å½“ä½ éœ€è¦æ‰©å®¹çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å†å¤šæ­å»ºä¸€äº›å¤‡åº“æ¥å¢åŠ ç³»ç»Ÿçš„è¯»èƒ½åŠ›çš„æ—¶å€™ï¼Œç°åœ¨å¸¸è§çš„åšæ³•ä¹Ÿæ˜¯ç”¨å…¨é‡å¤‡ä»½åŠ ä¸Šåº”ç”¨binlogæ¥å®ç°çš„ï¼Œ<font color=blue>è¿™ä¸ªâ€œä¸ä¸€è‡´â€å°±ä¼šå¯¼è‡´ä½ çš„çº¿ä¸Šå‡ºç°ä¸»ä»æ•°æ®åº“ä¸ä¸€è‡´çš„æƒ…å†µã€‚</font></p><p>ç®€å•è¯´ï¼Œredo logå’Œbinlogéƒ½å¯ä»¥ç”¨äºè¡¨ç¤ºäº‹åŠ¡çš„æäº¤çŠ¶æ€ï¼Œè€Œä¸¤é˜¶æ®µæäº¤å°±æ˜¯è®©è¿™ä¸¤ä¸ªçŠ¶æ€ä¿æŒé€»è¾‘ä¸Šçš„ä¸€è‡´ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä»Šå¤©ï¼Œæˆ‘ä»‹ç»äº†MySQLé‡Œé¢æœ€é‡è¦çš„ä¸¤ä¸ªæ—¥å¿—ï¼Œå³ç‰©ç†æ—¥å¿—redo logå’Œé€»è¾‘æ—¥å¿—binlogã€‚</p><ul><li><p>redo logç”¨äºä¿è¯crash-safeèƒ½åŠ›ã€‚innodb_flush_log_at_trx_commitè¿™ä¸ªå‚æ•°è®¾ç½®æˆ1çš„æ—¶å€™ï¼Œ è¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡çš„redo logéƒ½ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™ä¸ªå‚æ•°æˆ‘å»ºè®®ä½ è®¾ç½®æˆ1ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ MySQLå¼‚å¸¸é‡å¯ä¹‹åæ•°æ®ä¸ä¸¢å¤±ã€‚</p></li><li><p>sync_binlogè¿™ä¸ªå‚æ•°è®¾ç½®æˆ1çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡çš„binlogéƒ½æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™ä¸ªå‚æ•°æˆ‘ä¹Ÿå»º è®®ä½ è®¾ç½®æˆ1ï¼Œè¿™æ ·å¯ä»¥ä¿è¯MySQLå¼‚å¸¸é‡å¯ä¹‹åbinlogä¸ä¸¢å¤±ã€‚</p></li></ul><p>æˆ‘è¿˜è·Ÿä½ ä»‹ç»äº†ä¸MySQLæ—¥å¿—ç³»ç»Ÿå¯†åˆ‡ç›¸å…³çš„â€œä¸¤é˜¶æ®µæäº¤â€ã€‚<strong>ä¸¤é˜¶æ®µæäº¤æ˜¯è·¨ç³»ç»Ÿç»´æŒæ•°æ®é€»è¾‘ ä¸€è‡´æ€§æ—¶å¸¸ç”¨çš„ä¸€ä¸ªæ–¹æ¡ˆ</strong>ï¼Œå³ä½¿ä½ ä¸åšæ•°æ®åº“å†…æ ¸å¼€å‘ï¼Œæ—¥å¸¸å¼€å‘ä¸­ä¹Ÿæœ‰å¯èƒ½ä¼šç”¨åˆ°ã€‚</p><p>æ–‡ç« çš„æœ€åï¼Œæˆ‘ç»™ä½ ç•™ä¸€ä¸ªæ€è€ƒé¢˜å§ã€‚å‰é¢æˆ‘è¯´åˆ°å®šæœŸå…¨é‡å¤‡ä»½çš„å‘¨æœŸâ€œå–å†³äºç³»ç»Ÿé‡è¦æ€§ï¼Œæœ‰çš„æ˜¯ä¸€å¤©ä¸€å¤‡ï¼Œæœ‰çš„æ˜¯ä¸€å‘¨ä¸€å¤‡â€ã€‚é‚£ä¹ˆåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œä¸€å¤©ä¸€å¤‡ä¼šæ¯”ä¸€å‘¨ä¸€å¤‡æ›´æœ‰ä¼˜åŠ¿å‘¢?æˆ–è€…è¯´ï¼Œå®ƒå½±å“äº†è¿™ä¸ªæ•°æ®åº“ç³»ç»Ÿçš„å“ªä¸ªæŒ‡æ ‡?</p><h3 id="é—®é¢˜å›ç­”"><a href="#é—®é¢˜å›ç­”" class="headerlink" title="é—®é¢˜å›ç­”"></a>é—®é¢˜å›ç­”</h3><p>ä¸€å¤©ä¸€å¤‡å¥½å¤„æ˜¯â€œæœ€é•¿æ¢å¤æ—¶é—´â€æ›´çŸ­ã€‚</p><p>åœ¨ä¸€å¤©ä¸€å¤‡çš„æ¨¡å¼é‡Œï¼Œæœ€åæƒ…å†µä¸‹éœ€è¦åº”ç”¨ä¸€å¤©çš„binlogã€‚æ¯”å¦‚ï¼Œä½ æ¯å¤©0ç‚¹åšä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œ è€Œè¦æ¢å¤å‡ºä¸€ä¸ªåˆ°æ˜¨å¤©æ™šä¸Š23ç‚¹çš„å¤‡ä»½ã€‚</p><p>ä¸€å‘¨ä¸€å¤‡æœ€åæƒ…å†µå°±è¦åº”ç”¨ä¸€å‘¨çš„binlogäº†ã€‚ç³»ç»Ÿçš„å¯¹åº”æŒ‡æ ‡å°±æ˜¯RTO(æ¢å¤ç›®æ ‡æ—¶é—´)ã€‚</p><p>å½“ç„¶è¿™ä¸ªæ˜¯æœ‰æˆæœ¬çš„ï¼Œå› ä¸ºæ›´é¢‘ç¹å…¨é‡å¤‡ä»½éœ€è¦æ¶ˆè€—æ›´å¤šå­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥è¿™ä¸ªRTOæ˜¯æˆæœ¬æ¢æ¥ çš„ï¼Œå°±éœ€è¦ä½ æ ¹æ®ä¸šåŠ¡é‡è¦æ€§æ¥è¯„ä¼°äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„&quot;&gt;&lt;a href=&quot;#ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„&quot; class=&quot;headerlink&quot; title=&quot;ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„&quot;&gt;&lt;/a&gt;ä¸€æ¡æ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„&lt;/h1&gt;&lt;p&gt;å‰é¢æˆ‘ä»¬ç³»ç»Ÿäº†è§£äº†ä¸€ä¸ªæŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæµç¨‹ï¼Œå¹¶ä»‹ç»äº†æ‰§è¡Œè¿‡ç¨‹ä¸­</summary>
      
    
    
    
    
    <category term="MySQL" scheme="http://example.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§</title>
    <link href="http://example.com/wiki/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB/"/>
    <id>http://example.com/wiki/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB/</id>
    <published>2021-12-06T10:45:45.000Z</published>
    <updated>2021-12-06T10:46:46.383Z</updated>
    
    <content type="html"><![CDATA[<h1 id="äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§"><a href="#äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§" class="headerlink" title="äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§"></a>äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§</h1><p>æåˆ°äº‹åŠ¡ï¼Œä½ è‚¯å®šä¸é™Œç”Ÿï¼Œå’Œæ•°æ®åº“æ‰“äº¤é“çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¼šç”¨åˆ°äº‹åŠ¡ã€‚æœ€ç»å…¸çš„ä¾‹å­å°±æ˜¯è½¬ è´¦ï¼Œä½ è¦ç»™æœ‹å‹å°ç‹è½¬100å—é’±ï¼Œè€Œæ­¤æ—¶ä½ çš„é“¶è¡Œå¡åªæœ‰100å—é’±ã€‚</p><p>è½¬è´¦è¿‡ç¨‹å…·ä½“åˆ°ç¨‹åºé‡Œä¼šæœ‰ä¸€ç³»åˆ—çš„æ“ä½œï¼Œæ¯”å¦‚æŸ¥è¯¢ä½™é¢ã€åšåŠ å‡æ³•ã€æ›´æ–°ä½™é¢ç­‰ï¼Œè¿™äº›æ“ä½œå¿… é¡»ä¿è¯æ˜¯ä¸€ä½“çš„ï¼Œä¸ç„¶ç­‰ç¨‹åºæŸ¥å®Œä¹‹åï¼Œè¿˜æ²¡åšå‡æ³•ä¹‹å‰ï¼Œä½ è¿™100å—é’±ï¼Œå®Œå…¨å¯ä»¥å€Ÿç€è¿™ä¸ªæ—¶ é—´å·®å†æŸ¥ä¸€æ¬¡ï¼Œç„¶åå†ç»™å¦å¤–ä¸€ä¸ªæœ‹å‹è½¬è´¦ï¼Œå¦‚æœé“¶è¡Œè¿™ä¹ˆæ•´ï¼Œä¸å°±ä¹±äº†ä¹ˆ?è¿™æ—¶å°±è¦ç”¨åˆ°â€œäº‹ åŠ¡â€è¿™ä¸ªæ¦‚å¿µäº†ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œäº‹åŠ¡å°±æ˜¯è¦ä¿è¯ä¸€ç»„æ•°æ®åº“æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚åœ¨MySQLä¸­ï¼Œäº‹ åŠ¡æ”¯æŒæ˜¯åœ¨å¼•æ“å±‚å®ç°çš„ã€‚ä½ ç°åœ¨çŸ¥é“ï¼ŒMySQLæ˜¯ä¸€ä¸ªæ”¯æŒå¤šå¼•æ“çš„ç³»ç»Ÿï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼• æ“éƒ½æ”¯æŒäº‹åŠ¡ã€‚æ¯”å¦‚MySQLåŸç”Ÿçš„MyISAMå¼•æ“å°±ä¸æ”¯æŒäº‹åŠ¡ï¼Œè¿™ä¹Ÿæ˜¯MyISAMè¢«InnoDBå–ä»£ çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚</p><p>ä»Šå¤©çš„æ–‡ç« é‡Œï¼Œæˆ‘å°†ä¼šä»¥InnoDBä¸ºä¾‹ï¼Œå‰–æMySQLåœ¨äº‹åŠ¡æ”¯æŒæ–¹é¢çš„ç‰¹å®šå®ç°ï¼Œå¹¶åŸºäºåŸç†ç»™ å‡ºç›¸åº”çš„å®è·µå»ºè®®ï¼Œå¸Œæœ›è¿™äº›æ¡ˆä¾‹èƒ½åŠ æ·±ä½ å¯¹MySQLäº‹åŠ¡åŸç†çš„ç†è§£ã€‚</p><h2 id="éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«"><a href="#éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«" class="headerlink" title="éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«"></a>éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«</h2><p>æåˆ°äº‹åŠ¡ï¼Œä½ è‚¯å®šä¼šæƒ³åˆ°ACID(Atomicityã€Consistencyã€Isolationã€Durabilityï¼Œå³åŸå­æ€§ã€ä¸€ è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§)ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥è¯´è¯´å…¶ä¸­Iï¼Œä¹Ÿå°±æ˜¯â€œéš”ç¦»æ€§â€ã€‚</p><p>å½“æ•°æ®åº“ä¸Šæœ‰å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±å¯èƒ½å‡ºç°è„è¯»(dirty read)ã€ä¸å¯é‡å¤è¯»(non-repeatable read)ã€å¹»è¯»(phantom read)çš„é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå°±æœ‰äº†â€œéš”ç¦»çº§åˆ«â€çš„æ¦‚å¿µã€‚</p><p>åœ¨è°ˆéš”ç¦»çº§åˆ«ä¹‹å‰ï¼Œä½ é¦–å…ˆè¦çŸ¥é“ï¼Œä½ éš”ç¦»å¾—è¶Šä¸¥å®ï¼Œæ•ˆç‡å°±ä¼šè¶Šä½ã€‚å› æ­¤å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éƒ½è¦ åœ¨äºŒè€…ä¹‹é—´å¯»æ‰¾ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚SQLæ ‡å‡†çš„äº‹åŠ¡éš”ç¦»çº§åˆ«åŒ…æ‹¬:è¯»æœªæäº¤(read uncommitted)ã€ è¯»æäº¤(read committed)ã€å¯é‡å¤è¯»(repeatable read)å’Œä¸²è¡ŒåŒ–(serializable )ã€‚ä¸‹é¢æˆ‘é€ ä¸€ä¸ºä½ è§£é‡Š:</p><ul><li>è¯»æœªæäº¤æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ°ã€‚</li><li>è¯»æäº¤æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚ </li><li>å¯é‡å¤è¯»æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œæ€»æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€ è‡´çš„ã€‚å½“ç„¶åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæœªæäº¤å˜æ›´å¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚ </li><li>ä¸²è¡ŒåŒ–ï¼Œé¡¾åæ€ä¹‰æ˜¯å¯¹äºåŒä¸€è¡Œè®°å½•ï¼Œâ€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œâ€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚å½“å‡ºç°è¯»å†™é”å†²çª çš„æ—¶å€™ï¼Œåè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</li></ul><p>å…¶ä¸­â€œè¯»æäº¤â€å’Œâ€œå¯é‡å¤è¯»â€æ¯”è¾ƒéš¾ç†è§£ï¼Œæ‰€ä»¥æˆ‘ç”¨ä¸€ä¸ªä¾‹å­è¯´æ˜è¿™å‡ ç§éš”ç¦»çº§åˆ«ã€‚å‡è®¾æ•°æ®è¡¨Tä¸­ åªæœ‰ä¸€åˆ—ï¼Œå…¶ä¸­ä¸€è¡Œçš„å€¼ä¸º1ï¼Œä¸‹é¢æ˜¯æŒ‰ç…§æ—¶é—´é¡ºåºæ‰§è¡Œä¸¤ä¸ªäº‹åŠ¡çš„è¡Œä¸ºã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> T(c <span class="type">int</span>) engine<span class="operator">=</span>InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T(c) <span class="keyword">values</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><img src="https://oscimg.oschina.net/oscnet/up-4263a773c9c9bf065d77d3f59bdb13b004f.png"></p><p>æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Aä¼šæœ‰å“ªäº›ä¸åŒçš„è¿”å›ç»“æœï¼Œä¹Ÿå°±æ˜¯å›¾é‡Œé¢V1ã€V2ã€V3 çš„è¿”å›å€¼åˆ†åˆ«æ˜¯ä»€ä¹ˆã€‚</p><ul><li><p>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œè¯»æœªæäº¤â€ï¼Œ åˆ™V1çš„å€¼å°±æ˜¯2ã€‚è¿™æ—¶å€™äº‹åŠ¡Bè™½ç„¶è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯ç»“æœå·²ç»è¢« Açœ‹åˆ°äº†ã€‚å› æ­¤ï¼ŒV2ã€V3ä¹Ÿéƒ½æ˜¯2ã€‚ </p></li><li><p>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œè¯»æäº¤â€ï¼Œåˆ™V1æ˜¯1ï¼ŒV2çš„å€¼æ˜¯2ã€‚äº‹åŠ¡Bçš„æ›´æ–°åœ¨æäº¤åæ‰èƒ½è¢«Açœ‹åˆ°ã€‚æ‰€ä»¥ï¼Œ V3çš„å€¼ä¹Ÿæ˜¯2ã€‚</p></li><li><p>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œå¯é‡å¤è¯»â€ï¼Œåˆ™V1ã€V2æ˜¯1ï¼ŒV3æ˜¯2ã€‚ä¹‹æ‰€ä»¥V2è¿˜æ˜¯1ï¼Œéµå¾ªçš„å°±æ˜¯è¿™ä¸ªè¦æ±‚: äº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´çœ‹åˆ°çš„æ•°æ®å‰åå¿…é¡»æ˜¯ä¸€è‡´çš„ã€‚</p></li><li><p>è‹¥éš”ç¦»çº§åˆ«æ˜¯â€œä¸²è¡ŒåŒ–â€ï¼Œåˆ™åœ¨äº‹åŠ¡Bæ‰§è¡Œâ€œå°†1æ”¹æˆ2â€çš„æ—¶å€™ï¼Œä¼šè¢«é”ä½ã€‚ç›´åˆ°äº‹åŠ¡Aæäº¤åï¼Œ äº‹åŠ¡Bæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥ä»Açš„è§’åº¦çœ‹ï¼Œ V1ã€V2å€¼æ˜¯1ï¼ŒV3çš„å€¼æ˜¯2ã€‚</p></li></ul><p>åœ¨å®ç°ä¸Šï¼Œæ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†ã€‚<font color="red">åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦» çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚</font><font color=blue>åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§ åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ªSQLè¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„</font>ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œè¯»æœªæäº¤â€éš”ç¦» çº§åˆ«ä¸‹ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µ;è€Œâ€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥ç”¨åŠ é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ•°æ®åº“è¡Œä¸ºæ˜¯æœ‰æ‰€ä¸åŒçš„ã€‚Oracleæ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«å…¶ å®å°±æ˜¯â€œè¯»æäº¤â€ï¼Œå› æ­¤å¯¹äºä¸€äº›ä»Oracleè¿ç§»åˆ°MySQLçš„åº”ç”¨ï¼Œä¸ºä¿è¯æ•°æ®åº“éš”ç¦»çº§åˆ«çš„ä¸€è‡´ï¼Œ ä½ ä¸€å®šè¦è®°å¾—å°†MySQLçš„éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºâ€œè¯»æäº¤â€ã€‚</p><p>é…ç½®çš„æ–¹å¼æ˜¯ï¼Œå°†å¯åŠ¨å‚æ•°transaction-isolationçš„å€¼è®¾ç½®æˆREAD-COMMITTEDã€‚ä½ å¯ä»¥ç”¨<code>show variables</code>æ¥æŸ¥çœ‹å½“å‰çš„å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;transaction_isolation&#x27;;</span><br><span class="line">+-----------------------+----------------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+-----------------------+----------------+</span><br><span class="line">| transaction_isolation | READ-COMMITTED |</span><br><span class="line">+-----------------------+----------------+</span><br></pre></td></tr></table></figure><p>æ€»ç»“æ¥è¯´ï¼Œå­˜åœ¨å³åˆç†ï¼Œå“ªä¸ªéš”ç¦»çº§åˆ«éƒ½æœ‰å®ƒè‡ªå·±çš„ä½¿ç”¨åœºæ™¯ï¼Œä½ è¦æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡æƒ…å†µæ¥å®šã€‚ æˆ‘æƒ³ä½ å¯èƒ½ä¼šé—®é‚£ä»€ä¹ˆæ—¶å€™éœ€è¦â€œå¯é‡å¤è¯»â€çš„åœºæ™¯å‘¢?æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ•°æ®æ ¡å¯¹é€»è¾‘çš„æ¡ˆä¾‹ã€‚</p><p>å‡è®¾ä½ åœ¨ç®¡ç†ä¸€ä¸ªä¸ªäººé“¶è¡Œè´¦æˆ·è¡¨ã€‚ä¸€ä¸ªè¡¨å­˜äº†æ¯ä¸ªæœˆæœˆåº•çš„ä½™é¢ï¼Œä¸€ä¸ªè¡¨å­˜äº†è´¦å•æ˜ç»†ã€‚è¿™æ—¶ å€™ä½ è¦åšæ•°æ®æ ¡å¯¹ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­ä¸Šä¸ªæœˆçš„ä½™é¢å’Œå½“å‰ä½™é¢çš„å·®é¢ï¼Œæ˜¯å¦ä¸æœ¬æœˆçš„è´¦å•æ˜ç»†ä¸€è‡´ã€‚ ä½ ä¸€å®šå¸Œæœ›åœ¨æ ¡å¯¹è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æœ‰ç”¨æˆ·å‘ç”Ÿäº†ä¸€ç¬”æ–°çš„äº¤æ˜“ï¼Œä¹Ÿä¸å½±å“ä½ çš„æ ¡å¯¹ç»“æœã€‚</p><p>è¿™æ—¶å€™ä½¿ç”¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«å°±å¾ˆæ–¹ä¾¿ã€‚äº‹åŠ¡å¯åŠ¨æ—¶çš„è§†å›¾å¯ä»¥è®¤ä¸ºæ˜¯é™æ€çš„ï¼Œä¸å—å…¶ä»–äº‹åŠ¡ æ›´æ–°çš„å½±å“ã€‚</p><h2 id="äº‹åŠ¡éš”ç¦»çš„å®ç°"><a href="#äº‹åŠ¡éš”ç¦»çš„å®ç°" class="headerlink" title="äº‹åŠ¡éš”ç¦»çš„å®ç°"></a>äº‹åŠ¡éš”ç¦»çš„å®ç°</h2><p>ç†è§£äº†äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹äº‹åŠ¡éš”ç¦»å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ã€‚è¿™é‡Œæˆ‘ä»¬å±•å¼€è¯´æ˜â€œå¯é‡å¤ è¯»â€ã€‚</p><p>åœ¨MySQLä¸­ï¼Œå®é™…ä¸Šæ¯æ¡è®°å½•åœ¨æ›´æ–°çš„æ—¶å€™éƒ½ä¼šåŒæ—¶è®°å½•ä¸€æ¡å›æ»šæ“ä½œã€‚è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œé€š è¿‡å›æ»šæ“ä½œï¼Œéƒ½å¯ä»¥å¾—åˆ°å‰ä¸€ä¸ªçŠ¶æ€çš„å€¼ã€‚</p><p>å‡è®¾ä¸€ä¸ªå€¼ä»1è¢«æŒ‰é¡ºåºæ”¹æˆäº†2ã€3ã€4ï¼Œåœ¨å›æ»šæ—¥å¿—é‡Œé¢å°±ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„è®°å½•ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-823d70046a45479d602f2a8e62bc33ad0a2.png"></p><p>å½“å‰å€¼æ˜¯4ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢è¿™æ¡è®°å½•çš„æ—¶å€™ï¼Œä¸åŒæ—¶åˆ»å¯åŠ¨çš„äº‹åŠ¡ä¼šæœ‰ä¸åŒçš„read-viewã€‚å¦‚å›¾ä¸­çœ‹ åˆ°çš„ï¼Œåœ¨è§†å›¾Aã€Bã€Cé‡Œé¢ï¼Œè¿™ä¸€ä¸ªè®°å½•çš„å€¼åˆ†åˆ«æ˜¯1ã€2ã€4ï¼ŒåŒä¸€æ¡è®°å½•åœ¨ç³»ç»Ÿä¸­å¯ä»¥å­˜åœ¨å¤š ä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯æ•°æ®åº“çš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)ã€‚å¯¹äºread-view Aï¼Œè¦å¾—åˆ°1ï¼Œå°±å¿…é¡»å°†å½“å‰ å€¼ä¾æ¬¡æ‰§è¡Œå›¾ä¸­æ‰€æœ‰çš„å›æ»šæ“ä½œå¾—åˆ°ã€‚</p><p>åŒæ—¶ä½ ä¼šå‘ç°ï¼Œå³ä½¿ç°åœ¨æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å°†4æ”¹æˆ5ï¼Œè¿™ä¸ªäº‹åŠ¡è·Ÿread-view Aã€Bã€Cå¯¹åº”çš„ äº‹åŠ¡æ˜¯ä¸ä¼šå†²çªçš„ã€‚</p><p>ä½ ä¸€å®šä¼šé—®ï¼Œå›æ»šæ—¥å¿—æ€»ä¸èƒ½ä¸€ç›´ä¿ç•™å§ï¼Œä»€ä¹ˆæ—¶å€™åˆ é™¤å‘¢? ç­”æ¡ˆæ˜¯ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™æ‰åˆ é™¤ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œç³»ç»Ÿä¼šåˆ¤æ–­ï¼Œå½“æ²¡æœ‰äº‹åŠ¡å†éœ€è¦ç”¨åˆ°è¿™äº›å›æ»šæ—¥å¿—æ—¶ï¼Œå›æ»šæ—¥å¿—ä¼šè¢«åˆ é™¤ã€‚</p><p>ä»€ä¹ˆæ—¶å€™æ‰ä¸éœ€è¦äº†å‘¢?å°±æ˜¯å½“ç³»ç»Ÿé‡Œæ²¡æœ‰æ¯”è¿™ä¸ªå›æ»šæ—¥å¿—æ›´æ—©çš„read-viewçš„æ—¶å€™ã€‚ åŸºäºä¸Šé¢çš„è¯´æ˜ï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ä¸ºä»€ä¹ˆå»ºè®®ä½ å°½é‡ä¸è¦ä½¿ç”¨é•¿äº‹åŠ¡ã€‚</p><p>é•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ã€‚ç”±äºè¿™äº›äº‹åŠ¡éšæ—¶å¯èƒ½è®¿é—®æ•°æ®åº“é‡Œé¢çš„ä»»ä½•æ•° æ®ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œæ•°æ®åº“é‡Œé¢å®ƒå¯èƒ½ç”¨åˆ°çš„å›æ»šè®°å½•éƒ½å¿…é¡»ä¿ç•™ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤§é‡å  ç”¨å­˜å‚¨ç©ºé—´ã€‚</p><p>åœ¨MySQL 5.5åŠä»¥å‰çš„ç‰ˆæœ¬ï¼Œå›æ»šæ—¥å¿—æ˜¯è·Ÿæ•°æ®å­—å…¸ä¸€èµ·æ”¾åœ¨ibdataæ–‡ä»¶é‡Œçš„ï¼Œå³ä½¿é•¿äº‹åŠ¡æœ€ç»ˆ æäº¤ï¼Œå›æ»šæ®µè¢«æ¸…ç†ï¼Œæ–‡ä»¶ä¹Ÿä¸ä¼šå˜å°ã€‚æˆ‘è§è¿‡æ•°æ®åªæœ‰20GBï¼Œè€Œå›æ»šæ®µæœ‰200GBçš„åº“ã€‚æœ€ç»ˆ åªå¥½ä¸ºäº†æ¸…ç†å›æ»šæ®µï¼Œé‡å»ºæ•´ä¸ªåº“ã€‚</p><p>é™¤äº†å¯¹å›æ»šæ®µçš„å½±å“ï¼Œé•¿äº‹åŠ¡è¿˜å ç”¨é”èµ„æºï¼Œä¹Ÿå¯èƒ½æ‹–å®æ•´ä¸ªåº“ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨åé¢è®²é”çš„æ—¶å€™ å±•å¼€ã€‚</p><h3 id="äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼"><a href="#äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼" class="headerlink" title="äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼"></a>äº‹åŠ¡çš„å¯åŠ¨æ–¹å¼</h3><p>å¦‚å‰é¢æ‰€è¿°ï¼Œé•¿äº‹åŠ¡æœ‰è¿™äº›æ½œåœ¨é£é™©ï¼Œæˆ‘å½“ç„¶æ˜¯å»ºè®®ä½ å°½é‡é¿å…ã€‚å…¶å®å¾ˆå¤šæ—¶å€™ä¸šåŠ¡å¼€å‘åŒå­¦å¹¶ ä¸æ˜¯æœ‰æ„ä½¿ç”¨é•¿äº‹åŠ¡ï¼Œé€šå¸¸æ˜¯ç”±äºè¯¯ç”¨æ‰€è‡´ã€‚MySQLçš„äº‹åŠ¡å¯åŠ¨æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§:</p><ul><li><p>æ˜¾å¼å¯åŠ¨äº‹åŠ¡è¯­å¥ï¼Œ begin æˆ– start transactionã€‚é…å¥—çš„æäº¤è¯­å¥æ˜¯commitï¼Œå›æ»šè¯­å¥æ˜¯ rollbackã€‚</p></li><li><p>set autocommit=0ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šå°†è¿™ä¸ªçº¿ç¨‹çš„è‡ªåŠ¨æäº¤å…³æ‰ã€‚æ„å‘³ç€å¦‚æœä½ åªæ‰§è¡Œä¸€ä¸ª selectè¯­å¥ï¼Œè¿™ä¸ªäº‹åŠ¡å°±å¯åŠ¨äº†ï¼Œè€Œä¸”å¹¶ä¸ä¼šè‡ªåŠ¨æäº¤ã€‚è¿™ä¸ªäº‹åŠ¡æŒç»­å­˜åœ¨ç›´åˆ°ä½ ä¸»åŠ¨æ‰§è¡Œ commit æˆ– rollback è¯­å¥ï¼Œæˆ–è€…æ–­å¼€è¿æ¥ã€‚</p></li></ul><p>æœ‰äº›å®¢æˆ·ç«¯è¿æ¥æ¡†æ¶ä¼šé»˜è®¤è¿æ¥æˆåŠŸåå…ˆæ‰§è¡Œä¸€ä¸ªset autocommit=0çš„å‘½ä»¤ã€‚è¿™å°±å¯¼è‡´æ¥ä¸‹æ¥çš„ æŸ¥è¯¢éƒ½åœ¨äº‹åŠ¡ä¸­ï¼Œå¦‚æœæ˜¯é•¿è¿æ¥ï¼Œå°±å¯¼è‡´äº†æ„å¤–çš„é•¿äº‹åŠ¡ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä¼šå»ºè®®ä½ æ€»æ˜¯ä½¿ç”¨set autocommit=1, é€šè¿‡æ˜¾å¼è¯­å¥çš„æ–¹å¼æ¥å¯åŠ¨äº‹åŠ¡ã€‚</p><p>ä½†æ˜¯æœ‰çš„å¼€å‘åŒå­¦ä¼šçº ç»“â€œå¤šä¸€æ¬¡äº¤äº’â€çš„é—®é¢˜ã€‚å¯¹äºä¸€ä¸ªéœ€è¦é¢‘ç¹ä½¿ç”¨äº‹åŠ¡çš„ä¸šåŠ¡ï¼Œç¬¬äºŒç§æ–¹å¼ æ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹æ—¶éƒ½ä¸éœ€è¦ä¸»åŠ¨æ‰§è¡Œä¸€æ¬¡ â€œbeginâ€ï¼Œå‡å°‘äº†è¯­å¥çš„äº¤äº’æ¬¡æ•°ã€‚å¦‚æœä½ ä¹Ÿæœ‰è¿™ä¸ªé¡¾ è™‘ï¼Œæˆ‘å»ºè®®ä½ ä½¿ç”¨<font color=red>commit work and chain</font>è¯­æ³•ã€‚</p><p>åœ¨autocommitä¸º1çš„æƒ…å†µä¸‹ï¼Œç”¨beginæ˜¾å¼å¯åŠ¨çš„äº‹åŠ¡ï¼Œå¦‚æœæ‰§è¡Œcommitåˆ™æäº¤äº‹åŠ¡ã€‚å¦‚æœæ‰§è¡Œ commit work and chainï¼Œåˆ™æ˜¯æäº¤äº‹åŠ¡å¹¶è‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™æ ·ä¹Ÿçœå»äº†å†æ¬¡æ‰§è¡Œbeginè¯­ å¥çš„å¼€é”€ã€‚åŒæ—¶å¸¦æ¥çš„å¥½å¤„æ˜¯ä»ç¨‹åºå¼€å‘çš„è§’åº¦æ˜ç¡®åœ°çŸ¥é“æ¯ä¸ªè¯­å¥æ˜¯å¦å¤„äºäº‹åŠ¡ä¸­ã€‚</p><p>ä½ å¯ä»¥åœ¨information_schemaåº“çš„innodb_trxè¿™ä¸ªè¡¨ä¸­æŸ¥è¯¢é•¿äº‹åŠ¡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªè¯­å¥ï¼Œç”¨äºæŸ¥ æ‰¾æŒç»­æ—¶é—´è¶…è¿‡60sçš„äº‹åŠ¡ã€‚</p><p><code>select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))&gt;60 </code> </p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>æˆ‘ç»™ä½ ç•™ä¸€ä¸ªé—®é¢˜å§ã€‚ä½ ç°åœ¨çŸ¥é“äº†ç³»ç»Ÿé‡Œé¢åº”è¯¥é¿å…é•¿äº‹åŠ¡ï¼Œå¦‚æœä½ æ˜¯ä¸šåŠ¡å¼€å‘è´Ÿè´£äººåŒæ—¶ä¹Ÿ æ˜¯æ•°æ®åº“è´Ÿè´£äººï¼Œä½ ä¼šæœ‰ä»€ä¹ˆæ–¹æ¡ˆæ¥é¿å…å‡ºç°æˆ–è€…å¤„ç†è¿™ç§æƒ…å†µå‘¢?</p><p>è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä»åº”ç”¨å¼€å‘ç«¯å’Œæ•°æ®åº“ç«¯æ¥çœ‹ã€‚ é¦–å…ˆï¼Œä»åº”ç”¨å¼€å‘ç«¯æ¥çœ‹:</p><ol><li>ç¡®è®¤æ˜¯å¦ä½¿ç”¨äº†set autocommit=0ã€‚è¿™ä¸ªç¡®è®¤å·¥ä½œå¯ä»¥åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¼€å±•ï¼ŒæŠŠMySQLçš„ general_logå¼€èµ·æ¥ï¼Œç„¶åéšä¾¿è·‘ä¸€ä¸ªä¸šåŠ¡é€»è¾‘ï¼Œé€šè¿‡general_logçš„æ—¥å¿—æ¥ç¡®è®¤ã€‚ä¸€èˆ¬æ¡†æ¶ å¦‚æœä¼šè®¾ç½®è¿™ä¸ªå€¼ï¼Œä¹Ÿå°±ä¼šæä¾›å‚æ•°æ¥æ§åˆ¶è¡Œä¸ºï¼Œä½ çš„ç›®æ ‡å°±æ˜¯æŠŠå®ƒæ”¹æˆ1ã€‚</li><li>ç¡®è®¤æ˜¯å¦æœ‰ä¸å¿…è¦çš„åªè¯»äº‹åŠ¡ã€‚æœ‰äº›æ¡†æ¶ä¼šä¹ æƒ¯ä¸ç®¡ä»€ä¹ˆè¯­å¥å…ˆç”¨begin/commitæ¡†èµ·æ¥ã€‚æˆ‘ è§è¿‡æœ‰äº›æ˜¯ä¸šåŠ¡å¹¶æ²¡æœ‰è¿™ä¸ªéœ€è¦ï¼Œä½†æ˜¯ä¹ŸæŠŠå¥½å‡ ä¸ªselectè¯­å¥æ”¾åˆ°äº†äº‹åŠ¡ä¸­ã€‚è¿™ç§åªè¯»äº‹åŠ¡ å¯ä»¥å»æ‰ã€‚</li><li>ä¸šåŠ¡è¿æ¥æ•°æ®åº“çš„æ—¶å€™ï¼Œæ ¹æ®ä¸šåŠ¡æœ¬èº«çš„é¢„ä¼°ï¼Œé€šè¿‡SETMAX_EXECUTION_TIMEå‘½ä»¤ï¼Œ æ¥æ§åˆ¶æ¯ä¸ªè¯­å¥æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œé¿å…å•ä¸ªè¯­å¥æ„å¤–æ‰§è¡Œå¤ªé•¿æ—¶é—´ã€‚(ä¸ºä»€ä¹ˆä¼šæ„å¤–?åœ¨å ç»­çš„æ–‡ç« ä¸­ä¼šæåˆ°è¿™ç±»æ¡ˆä¾‹)</li></ol><p>å…¶æ¬¡ï¼Œä»æ•°æ®åº“ç«¯æ¥çœ‹:</p><ol><li>ç›‘æ§ information_schema.Innodb_trxè¡¨ï¼Œè®¾ç½®é•¿äº‹åŠ¡é˜ˆå€¼ï¼Œè¶…è¿‡å°±æŠ¥è­¦/æˆ–è€…kill;</li><li>Perconaçš„pt-killè¿™ä¸ªå·¥å…·ä¸é”™ï¼Œæ¨èä½¿ç”¨;</li><li>åœ¨ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•é˜¶æ®µè¦æ±‚è¾“å‡ºæ‰€æœ‰çš„general_logï¼Œåˆ†ææ—¥å¿—è¡Œä¸ºæå‰å‘ç°é—®é¢˜;</li><li>å¦‚æœä½¿ç”¨çš„æ˜¯MySQL5.6æˆ–è€…æ›´æ–°ç‰ˆæœ¬ï¼ŒæŠŠinnodb_undo_tablespacesè®¾ç½®æˆ2(æˆ–æ›´å¤§çš„ å€¼)ã€‚å¦‚æœçœŸçš„å‡ºç°å¤§äº‹åŠ¡å¯¼è‡´å›æ»šæ®µè¿‡å¤§ï¼Œè¿™æ ·è®¾ç½®åæ¸…ç†èµ·æ¥æ›´æ–¹ä¾¿ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§&quot;&gt;&lt;a href=&quot;#äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§&quot; class=&quot;headerlink&quot; title=&quot;äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§&quot;&gt;&lt;/a&gt;äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§&lt;/h1&gt;&lt;p&gt;æåˆ°äº‹åŠ¡ï¼Œä½ è‚¯å®šä¸é™Œç”Ÿï¼Œå’Œæ•°</summary>
      
    
    
    
    
    <category term="MySQL" scheme="http://example.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢</title>
    <link href="http://example.com/wiki/%E5%85%A8%E5%B1%80%E9%94%81%E5%92%8C%E8%A1%A8%E9%94%81/"/>
    <id>http://example.com/wiki/%E5%85%A8%E5%B1%80%E9%94%81%E5%92%8C%E8%A1%A8%E9%94%81/</id>
    <published>2021-12-06T10:43:52.000Z</published>
    <updated>2021-12-06T10:45:28.949Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢"><a href="#å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢" class="headerlink" title="å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢"></a>å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢</h1><p>ä»Šå¤©æˆ‘è¦è·Ÿä½ èŠèŠMySQLçš„é”ã€‚æ•°æ®åº“é”è®¾è®¡çš„åˆè¡·æ˜¯å¤„ç†å¹¶å‘é—®é¢˜ã€‚ä½œä¸ºå¤šç”¨æˆ·å…±äº«çš„èµ„ æºï¼Œå½“å‡ºç°å¹¶å‘è®¿é—®çš„æ—¶å€™ï¼Œæ•°æ®åº“éœ€è¦åˆç†åœ°æ§åˆ¶èµ„æºçš„è®¿é—®è§„åˆ™ã€‚è€Œé”å°±æ˜¯ç”¨æ¥å®ç°è¿™äº›è®¿é—®è§„åˆ™çš„é‡è¦æ•°æ®ç»“æ„ã€‚</p><p>æ ¹æ®åŠ é”çš„èŒƒå›´ï¼ŒMySQLé‡Œé¢çš„é”å¤§è‡´å¯ä»¥åˆ†æˆ<strong>å…¨å±€é”ã€è¡¨çº§é”å’Œè¡Œé”</strong>ä¸‰ç±»ã€‚ä»Šå¤©è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä¼šå’Œä½ åˆ†äº«å…¨å±€é”å’Œè¡¨çº§é”ã€‚è€Œå…³äºè¡Œé”çš„å†…å®¹ï¼Œæˆ‘ä¼šç•™ç€åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å†å’Œä½ è¯¦ç»†ä»‹ ç»ã€‚</p><p>è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œé”çš„è®¾è®¡æ¯”è¾ƒå¤æ‚ï¼Œè¿™ä¸¤ç¯‡æ–‡ç« ä¸ä¼šæ¶‰åŠé”çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œä¸»è¦ä»‹ç»çš„æ˜¯ç¢°åˆ°é”æ—¶çš„ç°è±¡å’Œå…¶èƒŒåçš„åŸç†ã€‚</p><h2 id="å…¨å±€é”"><a href="#å…¨å±€é”" class="headerlink" title="å…¨å±€é”"></a>å…¨å±€é”</h2><p>é¡¾åæ€ä¹‰ï¼Œå…¨å±€é”å°±æ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹åŠ é”ã€‚MySQLæä¾›äº†ä¸€ä¸ªåŠ å…¨å±€è¯»é”çš„æ–¹æ³•ï¼Œå‘½ä»¤æ˜¯ <code>Flush tables with read lock</code> (FTWRL)ã€‚å½“ä½ éœ€è¦è®©æ•´ä¸ªåº“å¤„äºåªè¯»çŠ¶æ€çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä¹‹åå…¶ä»–çº¿ç¨‹çš„ä»¥ä¸‹è¯­å¥ä¼šè¢«é˜»å¡:æ•°æ®æ›´æ–°è¯­å¥(æ•°æ®çš„å¢åˆ æ”¹)ã€æ•°æ®å®šä¹‰è¯­å¥(åŒ…æ‹¬ å»ºè¡¨ã€ä¿®æ”¹è¡¨ç»“æ„ç­‰)å’Œæ›´æ–°ç±»äº‹åŠ¡çš„æäº¤è¯­å¥ã€‚</p><p><strong><font color=blue>å…¨å±€é”çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œåšå…¨åº“é€»è¾‘å¤‡ä»½ã€‚ä¹Ÿå°±æ˜¯æŠŠæ•´åº“æ¯ä¸ªè¡¨éƒ½selectå‡ºæ¥å­˜æˆæ–‡æœ¬ã€‚</font></strong></p><p>ä»¥å‰æœ‰ä¸€ç§åšæ³•ï¼Œæ˜¯é€šè¿‡FTWRLç¡®ä¿ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹å¯¹æ•°æ®åº“åšæ›´æ–°ï¼Œç„¶åå¯¹æ•´ä¸ªåº“åšå¤‡ä»½ã€‚ æ³¨æ„ï¼Œåœ¨å¤‡ä»½è¿‡ç¨‹ä¸­æ•´ä¸ªåº“å®Œå…¨å¤„äºåªè¯»çŠ¶æ€ã€‚</p><p>ä½†æ˜¯è®©æ•´åº“éƒ½åªè¯»ï¼Œå¬ä¸Šå»å°±å¾ˆå±é™©:</p><ul><li><p>å¦‚æœä½ åœ¨ä¸»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´éƒ½ä¸èƒ½æ‰§è¡Œæ›´æ–°ï¼Œä¸šåŠ¡åŸºæœ¬ä¸Šå°±å¾—åœæ‘†;</p></li><li><p>å¦‚æœä½ åœ¨ä»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆå¤‡ä»½æœŸé—´ä»åº“ä¸èƒ½æ‰§è¡Œä¸»åº“åŒæ­¥è¿‡æ¥çš„binlogï¼Œä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿã€‚</p></li></ul><p>çœ‹æ¥åŠ å…¨å±€é”ä¸å¤ªå¥½ã€‚ä½†æ˜¯ç»†æƒ³ä¸€ä¸‹ï¼Œ<font color=red>å¤‡ä»½ä¸ºä»€ä¹ˆè¦åŠ é”å‘¢? æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸åŠ é”ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚</font></p><p>å‡è®¾ä½ ç°åœ¨è¦ç»´æŠ¤â€œæå®¢æ—¶é—´â€çš„è´­ä¹°ç³»ç»Ÿï¼Œå…³æ³¨çš„æ˜¯ç”¨æˆ·è´¦æˆ·ä½™é¢è¡¨å’Œç”¨æˆ·è¯¾ç¨‹è¡¨ã€‚</p><p>ç°åœ¨å‘èµ·ä¸€ä¸ªé€»è¾‘å¤‡ä»½ã€‚å‡è®¾å¤‡ä»½æœŸé—´ï¼Œæœ‰ä¸€ä¸ªç”¨æˆ·ï¼Œä»–è´­ä¹°äº†ä¸€é—¨è¯¾ç¨‹ï¼Œä¸šåŠ¡é€»è¾‘é‡Œå°±è¦æ‰£æ‰ ä»–çš„ä½™é¢ï¼Œç„¶åå¾€å·²è´­è¯¾ç¨‹é‡Œé¢åŠ ä¸Šä¸€é—¨è¯¾ã€‚</p><p>å¦‚æœæ—¶é—´é¡ºåºä¸Šæ˜¯å…ˆå¤‡ä»½è´¦æˆ·ä½™é¢è¡¨(u_account)ï¼Œç„¶åç”¨æˆ·è´­ä¹°ï¼Œç„¶åå¤‡ä»½ç”¨æˆ·è¯¾ç¨‹è¡¨ (u_course)ï¼Œä¼šæ€ä¹ˆæ ·å‘¢?ä½ å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªå›¾:</p><p><img src="https://oscimg.oschina.net/oscnet/up-b686a902a661f2ba86e2820a32f1fd1b7c5.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå¤‡ä»½ç»“æœé‡Œï¼Œç”¨æˆ·Açš„æ•°æ®çŠ¶æ€æ˜¯â€œè´¦æˆ·ä½™é¢æ²¡æ‰£ï¼Œä½†æ˜¯ç”¨æˆ·è¯¾ç¨‹è¡¨é‡Œé¢å·²ç»å¤šäº†</p><p>ä¸€é—¨è¯¾â€ã€‚å¦‚æœåé¢ç”¨è¿™ä¸ªå¤‡ä»½æ¥æ¢å¤æ•°æ®çš„è¯ï¼Œç”¨æˆ·Aå°±å‘ç°ï¼Œè‡ªå·±èµšäº†ã€‚ ä½œä¸ºç”¨æˆ·å¯åˆ«è§‰å¾—è¿™æ ·å¯çœŸå¥½å•Šï¼Œä½ å¯ä»¥è¯•æƒ³ä¸€ä¸‹:å¦‚æœå¤‡ä»½è¡¨çš„é¡ºåºåè¿‡æ¥ï¼Œå…ˆå¤‡ä»½ç”¨æˆ·è¯¾ç¨‹è¡¨å†å¤‡ä»½è´¦æˆ·ä½™é¢è¡¨ï¼Œåˆå¯èƒ½ä¼šå‡ºç°ä»€ä¹ˆç»“æœ?</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸åŠ é”çš„è¯ï¼Œå¤‡ä»½ç³»ç»Ÿå¤‡ä»½çš„å¾—åˆ°çš„åº“ä¸æ˜¯ä¸€ä¸ªé€»è¾‘æ—¶é—´ç‚¹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯é€»è¾‘ä¸ä¸€è‡´ çš„ã€‚</p><p>è¯´åˆ°è§†å›¾ä½ è‚¯å®šæƒ³èµ·æ¥äº†ï¼Œæˆ‘ä»¬åœ¨å‰é¢è®²äº‹åŠ¡éš”ç¦»çš„æ—¶å€™ï¼Œå…¶å®æ˜¯æœ‰ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿæ‹¿åˆ°ä¸€è‡´æ€§è§† å›¾çš„ï¼Œå¯¹å§?</p><p>æ˜¯çš„ï¼Œå°±æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚</p><p>å®˜æ–¹è‡ªå¸¦çš„é€»è¾‘å¤‡ä»½å·¥å…·æ˜¯mysqldumpã€‚å½“<code>mysqldump</code>ä½¿ç”¨å‚æ•°<code>â€“single-transaction</code>çš„æ—¶å€™ï¼Œå¯¼ æ•°æ®ä¹‹å‰å°±ä¼šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œæ¥ç¡®ä¿æ‹¿åˆ°ä¸€è‡´æ€§è§†å›¾ã€‚è€Œç”±äºMVCCçš„æ”¯æŒï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ•°æ®æ˜¯ å¯ä»¥æ­£å¸¸æ›´æ–°çš„ã€‚</p><p>ä½ ä¸€å®šåœ¨ç–‘æƒ‘ï¼Œæœ‰äº†è¿™ä¸ªåŠŸèƒ½ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦FTWRLå‘¢?ä¸€è‡´æ€§è¯»æ˜¯å¥½ï¼Œä½†å‰ææ˜¯å¼•æ“è¦æ”¯æŒè¿™ä¸ªéš”ç¦»çº§åˆ«ã€‚æ¯”å¦‚ï¼Œ<font color=blue>å¯¹äºMyISAMè¿™ç§ä¸æ”¯æŒäº‹åŠ¡çš„å¼•æ“ï¼Œå¦‚æœå¤‡ä»½è¿‡ç¨‹ä¸­æœ‰æ›´æ–°ï¼Œæ€»æ˜¯ åªèƒ½å–åˆ°æœ€æ–°çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ç ´åäº†å¤‡ä»½çš„ä¸€è‡´æ€§ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨FTWRLå‘½ä»¤äº†ã€‚</font></p><p>æ‰€ä»¥ï¼Œ<font color=blue>single-transactionæ–¹æ³•åªé€‚ç”¨äºæ‰€æœ‰çš„è¡¨ä½¿ç”¨äº‹åŠ¡å¼•æ“çš„åº“</font>ã€‚å¦‚æœæœ‰çš„è¡¨ä½¿ç”¨äº†ä¸æ”¯æŒäº‹åŠ¡çš„å¼•æ“ï¼Œé‚£ä¹ˆå¤‡ä»½å°±åªèƒ½é€šè¿‡FTWRLæ–¹æ³•ã€‚è¿™å¾€å¾€æ˜¯DBAè¦æ±‚ä¸šåŠ¡å¼€å‘äººå‘˜ä½¿ç”¨ InnoDBæ›¿ä»£MyISAMçš„åŸå› ä¹‹ä¸€ã€‚</p><p>ä½ ä¹Ÿè®¸ä¼šé—®ï¼Œæ—¢ç„¶è¦å…¨åº“åªè¯»ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ <code>set global readonly=true</code>çš„æ–¹å¼å‘¢? ç¡®å® readonlyæ–¹å¼ä¹Ÿå¯ä»¥è®©å…¨åº“è¿›å…¥åªè¯»çŠ¶æ€ï¼Œä½†æˆ‘è¿˜æ˜¯ä¼šå»ºè®®ä½ ç”¨FTWRLæ–¹å¼ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŸå› :</p><ul><li>åœ¨æœ‰äº›ç³»ç»Ÿä¸­ï¼Œreadonlyçš„å€¼ä¼šè¢«ç”¨æ¥åšå…¶ä»–é€»è¾‘ï¼Œæ¯”å¦‚ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªåº“æ˜¯ä¸»åº“è¿˜æ˜¯å¤‡ åº“ã€‚å› æ­¤ï¼Œä¿®æ”¹globalå˜é‡çš„æ–¹å¼å½±å“é¢æ›´å¤§ï¼Œæˆ‘ä¸å»ºè®®ä½ ä½¿ç”¨ã€‚</li><li>åœ¨å¼‚å¸¸å¤„ç†æœºåˆ¶ä¸Šæœ‰å·®å¼‚ã€‚å¦‚æœæ‰§è¡ŒFTWRLå‘½ä»¤ä¹‹åç”±äºå®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸æ–­å¼€ï¼Œé‚£ä¹ˆ MySQLä¼šè‡ªåŠ¨é‡Šæ”¾è¿™ä¸ªå…¨å±€é”ï¼Œæ•´ä¸ªåº“å›åˆ°å¯ä»¥æ­£å¸¸æ›´æ–°çš„çŠ¶æ€ã€‚è€Œå°†æ•´ä¸ªåº“è®¾ç½®ä¸º readonlyä¹‹åï¼Œå¦‚æœå®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™æ•°æ®åº“å°±ä¼šä¸€ç›´ä¿æŒreadonlyçŠ¶æ€ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ•´ä¸ª åº“é•¿æ—¶é—´å¤„äºä¸å¯å†™çŠ¶æ€ï¼Œé£é™©è¾ƒé«˜ã€‚</li></ul><p>ä¸šåŠ¡çš„æ›´æ–°ä¸åªæ˜¯å¢åˆ æ”¹æ•°æ®(DML)ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯åŠ å­—æ®µç­‰ä¿®æ”¹è¡¨ç»“æ„çš„æ“ä½œ(DDL)ã€‚ä¸è®º æ˜¯å“ªç§æ–¹æ³•ï¼Œä¸€ä¸ªåº“è¢«å…¨å±€é”ä¸Šä»¥åï¼Œä½ è¦å¯¹é‡Œé¢ä»»ä½•ä¸€ä¸ªè¡¨åšåŠ å­—æ®µæ“ä½œï¼Œéƒ½æ˜¯ä¼šè¢«é”ä½çš„ã€‚</p><p>ä½†æ˜¯ï¼Œå³ä½¿æ²¡æœ‰è¢«å…¨å±€é”ä½ï¼ŒåŠ å­—æ®µä¹Ÿä¸æ˜¯å°±èƒ½ä¸€å¸†é£é¡ºçš„ï¼Œå› ä¸ºä½ è¿˜ä¼šç¢°åˆ°æ¥ä¸‹æ¥æˆ‘ä»¬è¦ä»‹ç» çš„è¡¨çº§é”ã€‚</p><h2 id="è¡¨çº§é”"><a href="#è¡¨çº§é”" class="headerlink" title="è¡¨çº§é”"></a>è¡¨çº§é”</h2><p>MySQLé‡Œé¢è¡¨çº§åˆ«çš„é”æœ‰ä¸¤ç§:ä¸€ç§æ˜¯è¡¨é”ï¼Œä¸€ç§æ˜¯å…ƒæ•°æ®é”(meta data lockï¼ŒMDL)ã€‚</p><p>è¡¨é”çš„è¯­æ³•æ˜¯ <code>lock tables ...read/write</code>ã€‚ä¸FTWRLç±»ä¼¼ï¼Œå¯ä»¥ç”¨unlock tablesä¸»åŠ¨é‡Šæ”¾é”ï¼Œ ä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯æ–­å¼€çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾ã€‚éœ€è¦æ³¨æ„ï¼Œlock tablesè¯­æ³•é™¤äº†ä¼šé™åˆ¶åˆ«çš„çº¿ç¨‹çš„è¯»å†™ å¤–ï¼Œä¹Ÿé™å®šäº†æœ¬çº¿ç¨‹æ¥ä¸‹æ¥çš„æ“ä½œå¯¹è±¡ã€‚</p><p>ä¸¾ä¸ªä¾‹å­, å¦‚æœåœ¨æŸä¸ªçº¿ç¨‹Aä¸­æ‰§è¡Œlock tables t1 read, t2 write; è¿™ä¸ªè¯­å¥ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å†™t1ã€è¯» å†™t2çš„è¯­å¥éƒ½ä¼šè¢«é˜»å¡ã€‚åŒæ—¶ï¼Œçº¿ç¨‹Aåœ¨æ‰§è¡Œunlock tablesä¹‹å‰ï¼Œä¹Ÿåªèƒ½æ‰§è¡Œè¯»t1ã€è¯»å†™t2çš„æ“ ä½œã€‚è¿å†™t1éƒ½ä¸å…è®¸ï¼Œè‡ªç„¶ä¹Ÿä¸èƒ½è®¿é—®å…¶ä»–è¡¨ã€‚</p><p>åœ¨è¿˜æ²¡æœ‰å‡ºç°æ›´ç»†ç²’åº¦çš„é”çš„æ—¶å€™ï¼Œè¡¨é”æ˜¯æœ€å¸¸ç”¨çš„å¤„ç†å¹¶å‘çš„æ–¹å¼ã€‚è€Œå¯¹äºInnoDBè¿™ç§æ”¯æŒ è¡Œé”çš„å¼•æ“ï¼Œä¸€èˆ¬ä¸ä½¿ç”¨lock tableså‘½ä»¤æ¥æ§åˆ¶å¹¶å‘ï¼Œæ¯•ç«Ÿé”ä½æ•´ä¸ªè¡¨çš„å½±å“é¢è¿˜æ˜¯å¤ªå¤§ã€‚</p><h3 id="metadata-lock"><a href="#metadata-lock" class="headerlink" title="metadata lock"></a>metadata lock</h3><p>å¦ä¸€ç±»è¡¨çº§çš„é”æ˜¯<font color=blue>MDL(metadata lock)</font>ã€‚MDLä¸éœ€è¦æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šã€‚</p><p>MDLçš„ä½œç”¨æ˜¯ï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢æ­£åœ¨éå†ä¸€ä¸ª è¡¨ä¸­çš„æ•°æ®ï¼Œè€Œæ‰§è¡ŒæœŸé—´å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªè¡¨ç»“æ„åšå˜æ›´ï¼Œåˆ äº†ä¸€åˆ—ï¼Œé‚£ä¹ˆæŸ¥è¯¢çº¿ç¨‹æ‹¿åˆ°çš„ç»“æœ è·Ÿè¡¨ç»“æ„å¯¹ä¸ä¸Šï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚</p><p>å› æ­¤ï¼Œåœ¨MySQL 5.5ç‰ˆæœ¬ä¸­å¼•å…¥äº†MDLï¼Œ**<font color=blue>å½“å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLè¯»é”;å½“ è¦å¯¹è¡¨åšç»“æ„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLå†™é”ã€‚</font>**</p><ul><li><p>è¯»é”ä¹‹é—´ä¸äº’æ–¥ï¼Œå› æ­¤ä½ å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€å¼ è¡¨å¢åˆ æ”¹æŸ¥ã€‚</p></li><li><p>è¯»å†™é”ä¹‹é—´ã€å†™é”ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œç”¨æ¥ä¿è¯å˜æ›´è¡¨ç»“æ„æ“ä½œçš„å®‰å…¨æ€§ã€‚å› æ­¤ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªçº¿ ç¨‹è¦åŒæ—¶ç»™ä¸€ä¸ªè¡¨åŠ å­—æ®µï¼Œå…¶ä¸­ä¸€ä¸ªè¦ç­‰å¦ä¸€ä¸ªæ‰§è¡Œå®Œæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚</p></li></ul><p>è™½ç„¶MDLé”æ˜¯ç³»ç»Ÿé»˜è®¤ä¼šåŠ çš„ï¼Œä½†å´æ˜¯ä½ ä¸èƒ½å¿½ç•¥çš„ä¸€ä¸ªæœºåˆ¶ã€‚</p><p><strong>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ç»å¸¸çœ‹åˆ°æœ‰äººæ‰åˆ°è¿™ä¸ªå‘é‡Œ:ç»™ä¸€ä¸ªå°è¡¨åŠ ä¸ªå­—æ®µï¼Œå¯¼è‡´æ•´ä¸ªåº“æŒ‚äº†ã€‚</strong></p><p>ä½ è‚¯å®šçŸ¥é“ï¼Œç»™ä¸€ä¸ªè¡¨åŠ å­—æ®µï¼Œæˆ–è€…ä¿®æ”¹å­—æ®µï¼Œæˆ–è€…åŠ ç´¢å¼•ï¼Œéœ€è¦æ‰«æå…¨è¡¨çš„æ•°æ®ã€‚åœ¨å¯¹å¤§è¡¨æ“ ä½œçš„æ—¶å€™ï¼Œä½ è‚¯å®šä¼šç‰¹åˆ«å°å¿ƒï¼Œä»¥å…å¯¹çº¿ä¸ŠæœåŠ¡é€ æˆå½±å“ã€‚è€Œå®é™…ä¸Šï¼Œå³ä½¿æ˜¯å°è¡¨ï¼Œæ“ä½œä¸æ…ä¹Ÿ ä¼šå‡ºé—®é¢˜ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„æ“ä½œåºåˆ—ï¼Œå‡è®¾è¡¨tæ˜¯ä¸€ä¸ªå°è¡¨ã€‚</p><p>âš ï¸å¤‡æ³¨:è¿™é‡Œçš„å®éªŒç¯å¢ƒæ˜¯MySQL 5.6ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-968696480927070a2a696f9d8f05bccda93.png"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°session Aå…ˆå¯åŠ¨ï¼Œè¿™æ—¶å€™ä¼šå¯¹è¡¨tåŠ ä¸€ä¸ªMDLè¯»é”ã€‚ç”±äºsession Béœ€è¦çš„ä¹Ÿæ˜¯ MDLè¯»é”ï¼Œå› æ­¤å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚</p><p>ä¹‹åsession Cä¼šè¢«blockedï¼Œæ˜¯å› ä¸ºsession Açš„MDLè¯»é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œè€Œsession Céœ€è¦MDLå†™ é”ï¼Œå› æ­¤åªèƒ½è¢«é˜»å¡ã€‚</p><p>å¦‚æœåªæœ‰session Cè‡ªå·±è¢«é˜»å¡è¿˜æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä½†æ˜¯ä¹‹åæ‰€æœ‰è¦åœ¨è¡¨tä¸Šæ–°ç”³è¯·MDLè¯»é”çš„è¯·æ±‚ä¹Ÿ ä¼šè¢«session Cé˜»å¡ã€‚å‰é¢æˆ‘ä»¬è¯´äº†ï¼Œæ‰€æœ‰å¯¹è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œéƒ½éœ€è¦å…ˆç”³è¯·MDLè¯»é”ï¼Œå°±éƒ½è¢« é”ä½ï¼Œç­‰äºè¿™ä¸ªè¡¨ç°åœ¨å®Œå…¨ä¸å¯è¯»å†™äº†ã€‚</p><p><strong><font color=red>å¦‚æœæŸä¸ªè¡¨ä¸Šçš„æŸ¥è¯¢è¯­å¥é¢‘ç¹ï¼Œè€Œä¸”å®¢æˆ·ç«¯æœ‰é‡è¯•æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¶…æ—¶åä¼šå†èµ·ä¸€ä¸ªæ–°session å†è¯·æ±‚çš„è¯ï¼Œè¿™ä¸ªåº“çš„çº¿ç¨‹å¾ˆå¿«å°±ä¼šçˆ†æ»¡ã€‚</font></strong></p><p>ä½ ç°åœ¨åº”è¯¥çŸ¥é“äº†ï¼Œäº‹åŠ¡ä¸­çš„MDLé”ï¼Œåœ¨è¯­å¥æ‰§è¡Œå¼€å§‹æ—¶ç”³è¯·ï¼Œä½†æ˜¯è¯­å¥ç»“æŸåå¹¶ä¸ä¼šé©¬ä¸Šé‡Š æ”¾ï¼Œè€Œä¼šç­‰åˆ°æ•´ä¸ªäº‹åŠ¡æäº¤åå†é‡Šæ”¾ã€‚</p><hr><p>åŸºäºä¸Šé¢çš„åˆ†æï¼Œ<font color=red>æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•å®‰å…¨åœ°ç»™å°è¡¨åŠ å­—æ®µ?</font></p><p><strong>é¦–å…ˆæˆ‘ä»¬è¦è§£å†³é•¿äº‹åŠ¡ï¼Œäº‹åŠ¡ä¸æäº¤ï¼Œå°±ä¼šä¸€ç›´å ç€MDLé”ã€‚</strong></p><p>åœ¨MySQLçš„information_schema åº“çš„ innodb_trxè¡¨ä¸­ï¼Œä½ å¯ä»¥æŸ¥åˆ°å½“å‰æ‰§è¡Œä¸­çš„äº‹åŠ¡ã€‚å¦‚æœä½ è¦åšDDLå˜æ›´çš„è¡¨åˆšå¥½æœ‰é•¿äº‹åŠ¡ åœ¨æ‰§è¡Œï¼Œè¦è€ƒè™‘å…ˆæš‚åœDDLï¼Œæˆ–è€…killæ‰è¿™ä¸ªé•¿äº‹åŠ¡ã€‚</p><p>ä½†è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ã€‚å¦‚æœä½ è¦å˜æ›´çš„è¡¨æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¡¨ï¼Œè™½ç„¶æ•°æ®é‡ä¸å¤§ï¼Œä½†æ˜¯ä¸Šé¢çš„è¯·æ±‚å¾ˆé¢‘ ç¹ï¼Œè€Œä½ ä¸å¾—ä¸åŠ ä¸ªå­—æ®µï¼Œä½ è¯¥æ€ä¹ˆåšå‘¢?</p><p>è¿™æ—¶å€™killå¯èƒ½æœªå¿…ç®¡ç”¨ï¼Œå› ä¸ºæ–°çš„è¯·æ±‚é©¬ä¸Šå°±æ¥äº†ã€‚æ¯”è¾ƒç†æƒ³çš„æœºåˆ¶æ˜¯ï¼Œåœ¨alter tableè¯­å¥é‡Œé¢ è®¾å®šç­‰å¾…æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™ä¸ªæŒ‡å®šçš„ç­‰å¾…æ—¶é—´é‡Œé¢èƒ½å¤Ÿæ‹¿åˆ°MDLå†™é”æœ€å¥½ï¼Œæ‹¿ä¸åˆ°ä¹Ÿä¸è¦é˜»å¡å é¢çš„ä¸šåŠ¡è¯­å¥ï¼Œå…ˆæ”¾å¼ƒã€‚ä¹‹åå¼€å‘äººå‘˜æˆ–è€…DBAå†é€šè¿‡é‡è¯•å‘½ä»¤é‡å¤è¿™ä¸ªè¿‡ç¨‹ã€‚</p><p>MariaDBå·²ç»åˆå¹¶äº†AliSQLçš„è¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå¼€æºåˆ†æ”¯ç›®å‰éƒ½æ”¯æŒDDL NOWAIT/WAIT n è¿™ä¸ªè¯­æ³•ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name NOWAIT <span class="keyword">add</span> <span class="keyword">column</span> ...</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tbl_name WAIT N <span class="keyword">add</span> <span class="keyword">column</span> ...</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å¤‡ä»½ä¸€èˆ¬éƒ½ä¼šåœ¨å¤‡åº“ä¸Šæ‰§è¡Œï¼Œä½ åœ¨ç”¨â€“single-transactionæ–¹æ³•åšé€» è¾‘å¤‡ä»½çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸»åº“ä¸Šçš„ä¸€ä¸ªå°è¡¨åšäº†ä¸€ä¸ªDDLï¼Œæ¯”å¦‚ç»™ä¸€ä¸ªè¡¨ä¸ŠåŠ äº†ä¸€åˆ—ã€‚è¿™æ—¶å€™ï¼Œä» å¤‡åº“ä¸Šä¼šçœ‹åˆ°ä»€ä¹ˆç°è±¡å‘¢?</p><h3 id="å‚è€ƒç­”æ¡ˆ"><a href="#å‚è€ƒç­”æ¡ˆ" class="headerlink" title="å‚è€ƒç­”æ¡ˆ"></a>å‚è€ƒç­”æ¡ˆ</h3><p><a href="https://blog.csdn.net/qq_26502245/article/details/111688120">https://blog.csdn.net/qq_26502245/article/details/111688120</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢&quot;&gt;&lt;a href=&quot;#å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢&quot; class=&quot;headerlink&quot; title=&quot;å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢&quot;&gt;&lt;/a&gt;å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆå¤šé˜»ç¢&lt;/h1&gt;&lt;</summary>
      
    
    
    
    
    <category term="MySQL" scheme="http://example.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¡sqlæ˜¯å¦‚ä½•æ‰§è¡Œçš„</title>
    <link href="http://example.com/wiki/%E4%B8%80%E6%9D%A1sql%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/"/>
    <id>http://example.com/wiki/%E4%B8%80%E6%9D%A1sql%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/</id>
    <published>2021-12-06T10:35:29.000Z</published>
    <updated>2021-12-06T10:36:26.549Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ"><a href="#ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ" class="headerlink" title="ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ"></a>ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ</h1><p>è¿™ä¸ªé—®é¢˜ç­‰åŒäºï¼š <strong>è¯·å°†ä¸€ä¸‹mysqlçš„åŸºç¡€æ¶æ„</strong></p><h2 id="MySQLçš„é€»è¾‘æ¶æ„"><a href="#MySQLçš„é€»è¾‘æ¶æ„" class="headerlink" title="MySQLçš„é€»è¾‘æ¶æ„"></a>MySQLçš„é€»è¾‘æ¶æ„</h2><p>æˆ‘ä»¬ç»å¸¸è¯´ï¼Œçœ‹ä¸€ä¸ªäº‹å„¿åƒä¸‡ä¸ è¦ç›´æ¥é™·å…¥ç»†èŠ‚é‡Œï¼Œä½ åº”è¯¥å…ˆé¸Ÿç°å…¶å…¨è²Œï¼Œè¿™æ ·èƒ½å¤Ÿå¸®åŠ©ä½ ä»é«˜ç»´åº¦ç†è§£é—®é¢˜ã€‚åŒæ ·ï¼Œå¯¹äº MySQLçš„å­¦ä¹ ä¹Ÿæ˜¯è¿™æ ·ã€‚å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨æ•°æ®åº“ï¼Œçœ‹åˆ°çš„é€šå¸¸éƒ½æ˜¯ä¸€ä¸ªæ•´ä½“ã€‚æ¯”å¦‚ï¼Œä½ æœ‰ä¸ªæœ€ç®€ å•çš„è¡¨ï¼Œè¡¨é‡Œåªæœ‰ä¸€ä¸ªIDå­—æ®µï¼Œåœ¨æ‰§è¡Œä¸‹é¢è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ—¶:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T <span class="keyword">where</span> ID<span class="operator">=</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°çš„åªæ˜¯è¾“å…¥ä¸€æ¡è¯­å¥ï¼Œè¿”å›ä¸€ä¸ªç»“æœï¼Œå´ä¸çŸ¥é“è¿™æ¡è¯­å¥åœ¨MySQLå†…éƒ¨çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p>æ‰€ä»¥ä»Šå¤©æˆ‘æƒ³å’Œä½ ä¸€èµ·æŠŠMySQLæ‹†è§£ä¸€ä¸‹ï¼Œçœ‹çœ‹é‡Œé¢éƒ½æœ‰å“ªäº›â€œé›¶ä»¶â€ï¼Œå¸Œæœ›å€Ÿç”±è¿™ä¸ªæ‹†è§£è¿‡ç¨‹ï¼Œ è®©ä½ å¯¹MySQLæœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚è¿™æ ·å½“æˆ‘ä»¬ç¢°åˆ°MySQLçš„ä¸€äº›å¼‚å¸¸æˆ–è€…é—®é¢˜æ—¶ï¼Œå°±èƒ½å¤Ÿç›´æˆ³æœ¬ è´¨ï¼Œæ›´ä¸ºå¿«é€Ÿåœ°å®šä½å¹¶è§£å†³é—®é¢˜ã€‚</p><p>ä¸‹é¢æˆ‘ç»™å‡ºçš„æ˜¯MySQLçš„åŸºæœ¬æ¶æ„ç¤ºæ„å›¾ï¼Œä»ä¸­ä½ å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°SQLè¯­å¥åœ¨MySQLçš„å„ä¸ªåŠŸ èƒ½æ¨¡å—ä¸­çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-661c52fa2ca85182e119823265a003d152b.png" alt="MySQLçš„é€»è¾‘æ¶æ„å›¾"></p><p>å¤§ä½“æ¥è¯´ï¼ŒMySQLå¯ä»¥åˆ†ä¸º<strong>Serverå±‚</strong>å’Œ<strong>å­˜å‚¨å¼•æ“å±‚</strong>ä¸¤éƒ¨åˆ†ã€‚</p><p>Serverå±‚åŒ…æ‹¬<strong>è¿æ¥å™¨</strong>ã€<strong>æŸ¥è¯¢ç¼“å­˜</strong>ã€<strong>åˆ†æå™¨</strong>ã€<strong>ä¼˜åŒ–å™¨</strong>ã€<strong>æ‰§è¡Œå™¨</strong>ç­‰ï¼Œæ¶µç›–MySQLçš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡ åŠŸèƒ½ï¼Œä»¥åŠæ‰€æœ‰çš„å†…ç½®å‡½æ•°(å¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å’ŒåŠ å¯†å‡½æ•°ç­‰)ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨ è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚</p><p>è€Œå­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæå–ã€‚å…¶æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼Œæ”¯æŒInnoDBã€MyISAMã€ Memoryç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ã€‚ç°åœ¨æœ€å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯InnoDBï¼Œå®ƒä»MySQL 5.5.5ç‰ˆæœ¬å¼€å§‹æˆä¸ºäº† é»˜è®¤å­˜å‚¨å¼•æ“ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ æ‰§è¡Œcreate tableå»ºè¡¨çš„æ—¶å€™ï¼Œå¦‚æœä¸æŒ‡å®šå¼•æ“ç±»å‹ï¼Œé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯InnoDBã€‚ä¸ è¿‡ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå­˜å‚¨å¼•æ“çš„ç±»å‹æ¥é€‰æ‹©åˆ«çš„å¼•æ“ï¼Œæ¯”å¦‚åœ¨create tableè¯­å¥ä¸­ä½¿ç”¨ <code>engine=memory</code>, æ¥æŒ‡å®šä½¿ç”¨å†…å­˜å¼•æ“åˆ›å»ºè¡¨ã€‚ä¸åŒå­˜å‚¨å¼•æ“çš„è¡¨æ•°æ®å­˜å–æ–¹å¼ä¸åŒï¼Œæ”¯æŒçš„åŠŸ èƒ½ä¹Ÿä¸åŒï¼Œåœ¨åé¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šè®¨è®ºåˆ°å¼•æ“çš„é€‰æ‹©ã€‚</p><p>ä»å›¾ä¸­ä¸éš¾çœ‹å‡ºï¼Œä¸åŒçš„å­˜å‚¨å¼•æ“å…±ç”¨ä¸€ä¸ªServerå±‚ ï¼Œä¹Ÿå°±æ˜¯ä»è¿æ¥å™¨åˆ°æ‰§è¡Œå™¨çš„éƒ¨åˆ†ã€‚ä½ å¯ ä»¥å…ˆå¯¹æ¯ä¸ªç»„ä»¶çš„åå­—æœ‰ä¸ªå°è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šç»“åˆå¼€å¤´æåˆ°çš„é‚£æ¡SQLè¯­å¥ï¼Œå¸¦ä½ èµ°ä¸€éæ•´ä¸ªæ‰§ è¡Œæµç¨‹ï¼Œä¾æ¬¡çœ‹ä¸‹æ¯ä¸ªç»„ä»¶çš„ä½œç”¨ã€‚</p><h2 id="è¿æ¥å™¨"><a href="#è¿æ¥å™¨" class="headerlink" title="è¿æ¥å™¨"></a>è¿æ¥å™¨</h2><p>ç¬¬ä¸€æ­¥ï¼Œä½ ä¼šå…ˆè¿æ¥åˆ°è¿™ä¸ªæ•°æ®åº“ä¸Šï¼Œè¿™æ—¶å€™æ¥å¾…ä½ çš„å°±æ˜¯è¿æ¥å™¨ã€‚è¿æ¥å™¨è´Ÿè´£è·Ÿå®¢æˆ·ç«¯å»ºç«‹è¿ æ¥ã€è·å–æƒé™ã€ç»´æŒå’Œç®¡ç†è¿æ¥ã€‚è¿æ¥å‘½ä»¤ä¸€èˆ¬æ˜¯è¿™ä¹ˆå†™çš„:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>h$ip <span class="operator">-</span>P$port <span class="operator">-</span>u$<span class="keyword">user</span> <span class="operator">-</span>p</span><br></pre></td></tr></table></figure><p>è¾“å®Œå‘½ä»¤ä¹‹åï¼Œä½ å°±éœ€è¦åœ¨äº¤äº’å¯¹è¯é‡Œé¢è¾“å…¥å¯†ç ã€‚è™½ç„¶å¯†ç ä¹Ÿå¯ä»¥ç›´æ¥è·Ÿåœ¨-påé¢å†™åœ¨å‘½ä»¤è¡Œ ä¸­ï¼Œä½†è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´ä½ çš„å¯†ç æ³„éœ²ã€‚å¦‚æœä½ è¿çš„æ˜¯ç”Ÿäº§æœåŠ¡å™¨ï¼Œå¼ºçƒˆå»ºè®®ä½ ä¸è¦è¿™ä¹ˆåšã€‚</p><p>è¿æ¥å‘½ä»¤ä¸­çš„mysqlæ˜¯å®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨æ¥è·ŸæœåŠ¡ç«¯å»ºç«‹è¿æ¥ã€‚åœ¨å®Œæˆç»å…¸çš„TCPæ¡æ‰‹åï¼Œè¿æ¥å™¨ å°±è¦å¼€å§‹è®¤è¯ä½ çš„èº«ä»½ï¼Œè¿™ä¸ªæ—¶å€™ç”¨çš„å°±æ˜¯ä½ è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ã€‚</p><ul><li>å¦‚æœç”¨æˆ·åæˆ–å¯†ç ä¸å¯¹ï¼Œä½ å°±ä¼šæ”¶åˆ°ä¸€ä¸ªâ€Access denied for userâ€çš„é”™è¯¯ï¼Œç„¶åå®¢æˆ·ç«¯ç¨‹åº ç»“æŸæ‰§è¡Œã€‚</li><li>å¦‚æœç”¨æˆ·åå¯†ç è®¤è¯é€šè¿‡ï¼Œè¿æ¥å™¨ä¼šåˆ°æƒé™è¡¨é‡Œé¢æŸ¥å‡ºä½ æ‹¥æœ‰çš„æƒé™ã€‚ä¹‹åï¼Œè¿™ä¸ªè¿æ¥é‡Œé¢ çš„æƒé™åˆ¤æ–­é€»è¾‘ï¼Œéƒ½å°†ä¾èµ–äºæ­¤æ—¶è¯»åˆ°çš„æƒé™ã€‚</li></ul><p>è¿™å°±æ„å‘³ç€ï¼Œä¸€ä¸ªç”¨æˆ·æˆåŠŸå»ºç«‹è¿æ¥åï¼Œå³ä½¿ä½ ç”¨ç®¡ç†å‘˜è´¦å·å¯¹è¿™ä¸ªç”¨æˆ·çš„æƒé™åšäº†ä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨è¿æ¥çš„æƒé™ã€‚<strong>ä¿®æ”¹å®Œæˆåï¼Œåªæœ‰å†æ–°å»ºçš„è¿æ¥æ‰ä¼šä½¿ç”¨æ–°çš„æƒé™è®¾ç½®</strong>ã€‚</p><p>è¿æ¥å®Œæˆåï¼Œå¦‚æœä½ æ²¡æœ‰åç»­çš„åŠ¨ä½œï¼Œè¿™ä¸ªè¿æ¥å°±å¤„äºç©ºé—²çŠ¶æ€ï¼Œä½ å¯ä»¥åœ¨show processlistå‘½ ä»¤ä¸­çœ‹åˆ°å®ƒã€‚æ–‡æœ¬ä¸­è¿™ä¸ªå›¾æ˜¯show processlistçš„ç»“æœï¼Œå…¶ä¸­çš„Commandåˆ—æ˜¾ç¤ºä¸ºâ€œSleepâ€çš„è¿™ ä¸€è¡Œï¼Œå°±è¡¨ç¤ºç°åœ¨ç³»ç»Ÿé‡Œé¢æœ‰ä¸€ä¸ªç©ºé—²è¿æ¥ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-2a647e124a6b81400ac56c8602d08803a29.png"></p><p>å®¢æˆ·ç«¯å¦‚æœå¤ªé•¿æ—¶é—´æ²¡åŠ¨é™ï¼Œè¿æ¥å™¨å°±ä¼šè‡ªåŠ¨å°†å®ƒæ–­å¼€ã€‚è¿™ä¸ªæ—¶é—´æ˜¯ç”±å‚æ•°<code>wait_timeout</code>æ§åˆ¶ çš„ï¼Œ<strong>é»˜è®¤å€¼æ˜¯8å°æ—¶ã€‚</strong></p><p>å¦‚æœåœ¨è¿æ¥è¢«æ–­å¼€ä¹‹åï¼Œå®¢æˆ·ç«¯å†æ¬¡å‘é€è¯·æ±‚çš„è¯ï¼Œå°±ä¼šæ”¶åˆ°ä¸€ä¸ªé”™è¯¯æé†’: <code>Lost connection to MySQL server during query</code>ã€‚è¿™æ—¶å€™å¦‚æœä½ è¦ç»§ç»­ï¼Œå°±éœ€è¦é‡è¿ï¼Œç„¶åå†æ‰§è¡Œè¯·æ±‚äº†ã€‚</p><p>æ•°æ®åº“é‡Œé¢ï¼Œé•¿è¿æ¥æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚çŸ­è¿æ¥ åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚</p><p>å»ºç«‹è¿æ¥çš„è¿‡ç¨‹é€šå¸¸æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œ<font color=blue>æ‰€ä»¥æˆ‘å»ºè®®ä½ åœ¨ä½¿ç”¨ä¸­è¦å°½é‡å‡å°‘å»ºç«‹è¿æ¥çš„åŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯å°½é‡ä½¿ç”¨é•¿è¿æ¥ã€‚</font></p><p>ä½†æ˜¯å…¨éƒ¨ä½¿ç”¨é•¿è¿æ¥åï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼Œæœ‰äº›æ—¶å€™MySQLå ç”¨å†…å­˜æ¶¨å¾—ç‰¹åˆ«å¿«ï¼Œè¿™æ˜¯å› ä¸º MySQLåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿æ¥å¯¹è±¡é‡Œé¢çš„ã€‚è¿™äº›èµ„æºä¼šåœ¨è¿æ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚æ‰€ä»¥å¦‚æœé•¿è¿æ¥ç´¯ç§¯ä¸‹æ¥ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨å¤ªå¤§ï¼Œè¢«ç³»ç»Ÿå¼ºè¡Œæ€æ‰(OOM)ï¼Œä»ç° è±¡çœ‹å°±æ˜¯MySQLå¼‚å¸¸é‡å¯äº†ã€‚</p><p>æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢?ä½ å¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆã€‚</p><ul><li><p>å®šæœŸæ–­å¼€é•¿è¿æ¥ã€‚ä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç¨‹åºé‡Œé¢åˆ¤æ–­æ‰§è¡Œè¿‡ä¸€ä¸ªå ç”¨å†…å­˜çš„å¤§æŸ¥è¯¢åï¼Œæ–­å¼€ è¿æ¥ï¼Œä¹‹åè¦æŸ¥è¯¢å†é‡è¿ã€‚</p></li><li><p>å¦‚æœä½ ç”¨çš„æ˜¯MySQL5.7æˆ–æ›´æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connectionæ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„æºã€‚è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œ ä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€ã€‚</p></li></ul><h2 id="æŸ¥è¯¢ç¼“å­˜"><a href="#æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="æŸ¥è¯¢ç¼“å­˜"></a>æŸ¥è¯¢ç¼“å­˜</h2><p>è¿æ¥å»ºç«‹å®Œæˆåï¼Œä½ å°±å¯ä»¥æ‰§è¡Œselectè¯­å¥äº†ã€‚æ‰§è¡Œé€»è¾‘å°±ä¼šæ¥åˆ°ç¬¬äºŒæ­¥**:æŸ¥è¯¢ç¼“å­˜ã€‚**</p><p>MySQLæ‹¿åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚åï¼Œä¼šå…ˆåˆ°æŸ¥è¯¢ç¼“å­˜çœ‹çœ‹ï¼Œä¹‹å‰æ˜¯ä¸æ˜¯æ‰§è¡Œè¿‡è¿™æ¡è¯­å¥ã€‚ä¹‹å‰æ‰§è¡Œè¿‡ çš„è¯­å¥åŠå…¶ç»“æœå¯èƒ½ä¼šä»¥key-valueå¯¹çš„å½¢å¼ï¼Œè¢«ç›´æ¥ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚keyæ˜¯æŸ¥è¯¢çš„è¯­å¥ï¼Œvalueæ˜¯ æŸ¥è¯¢çš„ç»“æœã€‚å¦‚æœä½ çš„æŸ¥è¯¢èƒ½å¤Ÿç›´æ¥åœ¨è¿™ä¸ªç¼“å­˜ä¸­æ‰¾åˆ°keyï¼Œé‚£ä¹ˆè¿™ä¸ªvalueå°±ä¼šè¢«ç›´æ¥è¿”å›ç»™å®¢ æˆ·ç«¯ã€‚</p><p>å¦‚æœè¯­å¥ä¸åœ¨æŸ¥è¯¢ç¼“å­˜ä¸­ï¼Œå°±ä¼šç»§ç»­åé¢çš„æ‰§è¡Œé˜¶æ®µã€‚æ‰§è¡Œå®Œæˆåï¼Œæ‰§è¡Œç»“æœä¼šè¢«å­˜å…¥æŸ¥è¯¢ç¼“å­˜ ä¸­ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæŸ¥è¯¢å‘½ä¸­ç¼“å­˜ï¼ŒMySQLä¸éœ€è¦æ‰§è¡Œåé¢çš„å¤æ‚æ“ä½œï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ç»“ æœï¼Œè¿™ä¸ªæ•ˆç‡ä¼šå¾ˆé«˜ã€‚</p><p><font color=blue>ä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä¼šå»ºè®®ä½ ä¸è¦ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆå‘¢? å› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ©ã€‚</font></p><blockquote><p>æŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆéå¸¸é¢‘ç¹ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚å› æ­¤ å¾ˆå¯èƒ½ä½ è´¹åŠ²åœ°æŠŠç»“æœå­˜èµ·æ¥ï¼Œè¿˜æ²¡ä½¿ç”¨å‘¢ï¼Œå°±è¢«ä¸€ä¸ªæ›´æ–°å…¨æ¸…ç©ºäº†ã€‚å¯¹äºæ›´æ–°å‹åŠ›å¤§çš„æ•°æ®åº“ æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ä¼šéå¸¸ä½ã€‚é™¤éä½ çš„ä¸šåŠ¡å°±æ˜¯æœ‰ä¸€å¼ é™æ€è¡¨ï¼Œå¾ˆé•¿æ—¶é—´æ‰ä¼šæ›´æ–°ä¸€æ¬¡ã€‚ æ¯”å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿé…ç½®è¡¨ï¼Œé‚£è¿™å¼ è¡¨ä¸Šçš„æŸ¥è¯¢æ‰é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚</p></blockquote><p>å¥½åœ¨MySQLä¹Ÿæä¾›äº†è¿™ç§â€œæŒ‰éœ€ä½¿ç”¨â€çš„æ–¹å¼ã€‚ä½ å¯ä»¥å°†å‚æ•°<code>query_cache_type</code>è®¾ç½®æˆ <code>DEMAND</code>ï¼Œè¿™æ ·å¯¹äºé»˜è®¤çš„SQLè¯­å¥éƒ½ä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚è€Œå¯¹äºä½ ç¡®å®šè¦ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜çš„è¯­ å¥ï¼Œå¯ä»¥ç”¨SQL_CACHEæ˜¾å¼æŒ‡å®šï¼Œåƒä¸‹é¢è¿™ä¸ªè¯­å¥ä¸€æ ·:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> SQL_CACHE <span class="operator">*</span> <span class="keyword">from</span> T <span class="keyword">where</span> ID<span class="operator">=</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure><p><font color=red>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMySQL 8.0ç‰ˆæœ¬ç›´æ¥å°†æŸ¥è¯¢ç¼“å­˜çš„æ•´å—åŠŸèƒ½åˆ æ‰äº†ï¼Œä¹Ÿå°±æ˜¯è¯´8.0å¼€å§‹å½»åº•æ²¡æœ‰ è¿™ä¸ªåŠŸèƒ½äº†ã€‚</font></p><h2 id="åˆ†æå™¨"><a href="#åˆ†æå™¨" class="headerlink" title="åˆ†æå™¨"></a>åˆ†æå™¨</h2><p>å¦‚æœæ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œå°±è¦å¼€å§‹çœŸæ­£æ‰§è¡Œè¯­å¥äº†ã€‚é¦–å…ˆï¼Œ<font color=blue>MySQLéœ€è¦çŸ¥é“ä½ è¦åšä»€ä¹ˆ</font>ï¼Œå› æ­¤éœ€è¦å¯¹SQLè¯­å¥åšè§£æã€‚</p><p>åˆ†æå™¨å…ˆä¼šåšâ€œè¯æ³•åˆ†æâ€ã€‚ä½ è¾“å…¥çš„æ˜¯ç”±å¤šä¸ªå­—ç¬¦ä¸²å’Œç©ºæ ¼ç»„æˆçš„ä¸€æ¡SQLè¯­å¥ï¼ŒMySQLéœ€è¦è¯† åˆ«å‡ºé‡Œé¢çš„å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œä»£è¡¨ä»€ä¹ˆã€‚</p><p>MySQLä»ä½ è¾“å…¥çš„â€selectâ€è¿™ä¸ªå…³é”®å­—è¯†åˆ«å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ã€‚å®ƒä¹Ÿè¦æŠŠå­—ç¬¦ä¸²â€œTâ€è¯†åˆ« æˆâ€œè¡¨åTâ€ï¼ŒæŠŠå­—ç¬¦ä¸²â€œIDâ€è¯†åˆ«æˆâ€œåˆ—IDâ€ã€‚</p><p>åšå®Œäº†è¿™äº›è¯†åˆ«ä»¥åï¼Œå°±è¦åšâ€œè¯­æ³•åˆ†æâ€ã€‚æ ¹æ®è¯æ³•åˆ†æçš„ç»“æœï¼Œè¯­æ³•åˆ†æå™¨ä¼šæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œ åˆ¤æ–­ä½ è¾“å…¥çš„è¿™ä¸ªSQLè¯­å¥æ˜¯å¦æ»¡è¶³MySQLè¯­æ³•ã€‚</p><p>å¦‚æœä½ çš„è¯­å¥ä¸å¯¹ï¼Œå°±ä¼šæ”¶åˆ°<code>â€œYou have an error in your SQL syntaxâ€</code>çš„é”™è¯¯æé†’ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ª è¯­å¥selectå°‘æ‰“äº†å¼€å¤´çš„å­—æ¯â€œsâ€ã€‚</p><p><img src="https://oscimg.oschina.net/oscnet/up-4b5816275605cf38dcea5964ab23bfc1e16.png"></p><p><font color=red>ä¸€èˆ¬è¯­æ³•é”™è¯¯ä¼šæç¤ºç¬¬ä¸€ä¸ªå‡ºç°é”™è¯¯çš„ä½ç½®ï¼Œæ‰€ä»¥ä½ è¦å…³æ³¨çš„æ˜¯ç´§æ¥â€œuse nearâ€çš„å†…å®¹ã€‚</font></p><h2 id="ä¼˜åŒ–å™¨"><a href="#ä¼˜åŒ–å™¨" class="headerlink" title="ä¼˜åŒ–å™¨"></a>ä¼˜åŒ–å™¨</h2><p>ç»è¿‡äº†åˆ†æå™¨ï¼ŒMySQLå°±çŸ¥é“ä½ è¦åšä»€ä¹ˆäº†ã€‚åœ¨å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œè¿˜è¦å…ˆç»è¿‡ä¼˜åŒ–å™¨çš„å¤„ç†ã€‚</p><p>ä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•;æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è”(join)çš„æ—¶å€™ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåºã€‚æ¯”å¦‚ä½ æ‰§è¡Œä¸‹é¢è¿™æ ·çš„è¯­å¥ï¼Œè¿™ä¸ªè¯­å¥æ˜¯æ‰§è¡Œä¸¤ä¸ªè¡¨çš„join:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">join</span> t2 <span class="keyword">using</span>(ID)  <span class="keyword">where</span> t1.c<span class="operator">=</span><span class="number">10</span> <span class="keyword">and</span> t2.d<span class="operator">=</span><span class="number">20</span>;</span><br></pre></td></tr></table></figure><ul><li>æ—¢å¯ä»¥å…ˆä»è¡¨t1é‡Œé¢å–å‡ºc=10çš„è®°å½•çš„IDå€¼ï¼Œå†æ ¹æ®IDå€¼å…³è”åˆ°è¡¨t2ï¼Œå†åˆ¤æ–­t2é‡Œé¢dçš„å€¼æ˜¯ å¦ç­‰äº20ã€‚</li><li>ä¹Ÿå¯ä»¥å…ˆä»è¡¨t2é‡Œé¢å–å‡ºd=20çš„è®°å½•çš„IDå€¼ï¼Œå†æ ¹æ®IDå€¼å…³è”åˆ°t1ï¼Œå†åˆ¤æ–­t1é‡Œé¢cçš„å€¼æ˜¯å¦ ç­‰äº10ã€‚</li></ul><p>è¿™ä¸¤ç§æ‰§è¡Œæ–¹æ³•çš„é€»è¾‘ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰ä¸åŒï¼Œè€Œä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯å†³å®šé€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªæ–¹æ¡ˆã€‚</p><p>ä¼˜åŒ–å™¨é˜¶æ®µå®Œæˆåï¼Œè¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæ–¹æ¡ˆå°±ç¡®å®šä¸‹æ¥äº†ï¼Œç„¶åè¿›å…¥æ‰§è¡Œå™¨é˜¶æ®µã€‚å¦‚æœä½ è¿˜æœ‰ä¸€äº› ç–‘é—®ï¼Œæ¯”å¦‚ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆé€‰æ‹©ç´¢å¼•çš„ï¼Œæœ‰æ²¡æœ‰å¯èƒ½é€‰æ‹©é”™ç­‰ç­‰ï¼Œåœ¨åé¢çš„æ–‡ç« ä¸­å•ç‹¬å±•å¼€è¯´æ˜ä¼˜åŒ–å™¨çš„å†…å®¹ã€‚</p><h2 id="æ‰§è¡Œå™¨"><a href="#æ‰§è¡Œå™¨" class="headerlink" title="æ‰§è¡Œå™¨"></a>æ‰§è¡Œå™¨</h2><p><font color=blue>MySQLé€šè¿‡åˆ†æå™¨çŸ¥é“äº†ä½ è¦åšä»€ä¹ˆï¼Œé€šè¿‡ä¼˜åŒ–å™¨çŸ¥é“äº†è¯¥æ€ä¹ˆåšï¼Œäºæ˜¯å°±è¿›å…¥äº†æ‰§è¡Œå™¨é˜¶ æ®µï¼Œå¼€å§‹æ‰§è¡Œè¯­å¥ã€‚</font></p><p>å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­ä¸€ä¸‹ä½ å¯¹è¿™ä¸ªè¡¨Tæœ‰æ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šè¿”å›æ²¡æœ‰ æƒé™çš„é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from T where ID=10;</span><br><span class="line"></span><br><span class="line">ERROR 1142 (42000): SELECT command denied to user &#x27;b&#x27;@&#x27;localhost&#x27; for table &#x27;T&#x27;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰æƒé™ï¼Œå°±æ‰“å¼€è¡¨ç»§ç»­æ‰§è¡Œã€‚æ‰“å¼€è¡¨çš„æ—¶å€™ï¼Œæ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œå»ä½¿ç”¨<strong>è¿™ä¸ªå¼•æ“</strong>æä¾›çš„æ¥å£ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­çš„è¡¨Tä¸­ï¼ŒIDå­—æ®µæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ‰§è¡Œå™¨çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„:</p><ul><li>è°ƒç”¨InnoDBå¼•æ“æ¥å£å–è¿™ä¸ªè¡¨çš„ç¬¬ä¸€è¡Œï¼Œåˆ¤æ–­IDå€¼æ˜¯ä¸æ˜¯10ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯åˆ™å°†è¿™è¡Œå­˜åœ¨ç»“æœé›†ä¸­;</li><li>è°ƒç”¨å¼•æ“æ¥å£å–â€œä¸‹ä¸€è¡Œâ€ï¼Œé‡å¤ç›¸åŒçš„åˆ¤æ–­é€»è¾‘ï¼Œç›´åˆ°å–åˆ°è¿™ä¸ªè¡¨çš„æœ€åä¸€è¡Œã€‚</li><li>æ‰§è¡Œå™¨å°†ä¸Šè¿°éå†è¿‡ç¨‹ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œç»„æˆçš„è®°å½•é›†ä½œä¸ºç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ul><p>è‡³æ­¤ï¼Œè¿™ä¸ªè¯­å¥å°±æ‰§è¡Œå®Œæˆäº†ã€‚ å¯¹äºæœ‰ç´¢å¼•çš„è¡¨ï¼Œæ‰§è¡Œçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šã€‚</p><p>ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ˜¯â€œå–æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€è¡Œâ€è¿™ä¸ªæ¥å£ï¼Œä¹‹åå¾ªç¯å–â€œæ»¡è¶³æ¡ä»¶çš„ä¸‹ä¸€è¡Œâ€è¿™ä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£éƒ½æ˜¯å¼•æ“ä¸­å·²ç»å®šä¹‰å¥½çš„ã€‚ ä½ ä¼šåœ¨æ•°æ®åº“çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­çœ‹åˆ°ä¸€ä¸ªrows_examinedçš„å­—æ®µï¼Œè¡¨ç¤ºè¿™ä¸ªè¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰«æäº†å¤šå°‘è¡Œã€‚</p><p>è¿™ä¸ªå€¼å°±æ˜¯åœ¨æ‰§è¡Œå™¨æ¯æ¬¡è°ƒç”¨å¼•æ“è·å–æ•°æ®è¡Œçš„æ—¶å€™ç´¯åŠ çš„ã€‚<strong>åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæ‰§è¡Œå™¨è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨å¼•æ“å†…éƒ¨åˆ™æ‰«æäº†å¤šè¡Œï¼Œå› æ­¤å¼•æ“æ‰«æè¡Œæ•°è·Ÿ rows_examinedå¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒçš„</strong>ã€‚æˆ‘ä»¬åé¢ä¼šä¸“é—¨æœ‰ä¸€ç¯‡æ–‡ç« æ¥è®²å­˜å‚¨å¼•æ“çš„å†…éƒ¨æœºåˆ¶ï¼Œ é‡Œé¢ä¼šæœ‰è¯¦ç»†çš„è¯´æ˜ã€‚</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>æˆ‘ç»™ä½ ç•™ä¸€ä¸ªé—®é¢˜å§ï¼Œå¦‚æœè¡¨Tä¸­æ²¡æœ‰å­—æ®µkï¼Œè€Œä½ æ‰§è¡Œäº†è¿™ä¸ªè¯­å¥ select * from T where k=1, é‚£ è‚¯å®šæ˜¯ä¼šæŠ¥â€œä¸å­˜åœ¨è¿™ä¸ªåˆ—â€çš„é”™è¯¯:     <code>â€œUnknown column â€˜kâ€™ in â€˜where clauseâ€™â€</code>ã€‚ä½ è§‰å¾—è¿™ä¸ªé”™è¯¯æ˜¯ åœ¨æˆ‘ä»¬ä¸Šé¢æåˆ°çš„å“ªä¸ªé˜¶æ®µæŠ¥å‡ºæ¥çš„å‘¢?</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ&quot;&gt;&lt;/a&gt;ä¸€æ¡sqlåˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿ&lt;/h1&gt;&lt;p&gt;è¿™ä¸ªé—®é¢˜ç­‰åŒäºï¼š &lt;strong&gt;è¯·å°†ä¸€ä¸‹m</summary>
      
    
    
    
    
    <category term="MySQL" scheme="http://example.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearchä½¿ç”¨è§„èŒƒ</title>
    <link href="http://example.com/wiki/Elasticsearch%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83/"/>
    <id>http://example.com/wiki/Elasticsearch%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83/</id>
    <published>2021-11-01T06:45:39.000Z</published>
    <updated>2021-11-01T06:46:32.745Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Elasticsearchä½¿ç”¨è§„èŒƒ"><a href="#Elasticsearchä½¿ç”¨è§„èŒƒ" class="headerlink" title="Elasticsearchä½¿ç”¨è§„èŒƒ"></a>Elasticsearchä½¿ç”¨è§„èŒƒ</h1><h2 id="æŸ¥è¯¢è§„èŒƒå»ºè®®"><a href="#æŸ¥è¯¢è§„èŒƒå»ºè®®" class="headerlink" title="æŸ¥è¯¢è§„èŒƒå»ºè®®"></a>æŸ¥è¯¢è§„èŒƒå»ºè®®</h2><ul><li><p><strong>å®šä¹‰å¥½mappingså’Œsettings</strong>ï¼Œä¸åŒçš„æ•°æ®ç±»å‹æŸ¥è¯¢æ•ˆç‡ä¸ä¸€æ ·ï¼Œå»ºè®®åªéœ€åšç²¾ç¡®æŸ¥è¯¢ä»¥åŠèŒƒå›´æŸ¥è¯¢çš„å­—æ®µè®¾ç½®ä¸ºkeywordç±»å‹ã€‚å¯¹äºè¦è¿›è¡Œå…¨æ–‡æ£€ç´¢çš„å­—æ®µè®¾ç½®åˆç†çš„åˆ†è¯å™¨ã€‚</p></li><li><p>å¯¹äºåªéœ€è¦æŸ¥è¯¢æ•°æ®ç»“æœè€Œä¸éœ€è¦ç»“æœçš„ç›¸å…³åº¦è®¡ç®—çš„æƒ…å†µï¼Œ<strong>ä½¿ç”¨filter queryèƒ½å¤§å¹…æå‡ä½ çš„æŸ¥è¯¢æ•ˆç‡</strong>ã€‚ä¾‹å¦‚è¿‡æ»¤æŸè½¦ç‰Œå’Œå·ç ã€‚</p></li><li><p><strong>é¿å…ä¸€æ¬¡æ€§å–å‡ºå¤§é‡çš„æ•°é‡</strong>ï¼šElasticsearchè¢«è®¾è®¡ä¸ºä¸€ä¸ªæœç´¢å¼•æ“ï¼Œè¿™ä½¿å¾—å®ƒéå¸¸æ“…é•¿è·å–ä¸æŸ¥è¯¢åŒ¹é…çš„æœ€ä¼˜æ–‡æ¡£ï¼Œä½†æ˜¯ä¸é€‚åˆç”¨æ¥æ£€ç´¢ä¸ç‰¹å®šæŸ¥è¯¢åŒ¹é…çš„æ‰€æœ‰æ–‡æ¡£ã€‚ Elasticsearchä¸ºäº†é¿å…æ·±åˆ†é¡µï¼Œä¸å…è®¸ä½¿ç”¨åˆ†é¡µï¼ˆfrom&amp;sizeï¼‰æŸ¥è¯¢10000æ¡ä»¥åçš„æ•°æ®ï¼Œå¦‚æœéœ€è¦è¿™æ ·åšï¼Œè¯·ç¡®ä¿ä½¿ç”¨Scroll APIã€‚ ï¼ˆScroll API åæ¥ä¸è¢«æ¨èä½¿ç”¨ å¯ä»¥ä½¿ç”¨search afterï¼‰</p></li><li><p><strong>å°½é‡ç»†åŒ–æŸ¥è¯¢æ¡ä»¶</strong>ï¼ŒæŸ¥è¯¢çš„æ¡ä»¶è¶Šç»†ï¼ŒæŸ¥è¯¢æ•ˆç‡è¶Šé«˜ã€‚</p></li><li><p><strong>é€‰æ‹©åˆé€‚çš„æŸ¥è¯¢ç±»å‹</strong>ï¼Œæ¯”å¦‚termæŸ¥è¯¢æ•ˆç‡ç›¸å¯¹ä¼šé«˜ä¸€äº›ã€‚</p></li><li><p><strong>ä¼˜åŒ–è·¯ç”±</strong></p><p>  Elasticsearchå†™å…¥æ–‡æ¡£æ—¶ï¼Œæ–‡æ¡£ä¼šé€šè¿‡ä¸€ä¸ªå…¬å¼è·¯ç”±åˆ°ä¸€ä¸ªç´¢å¼•ä¸­çš„ä¸€ä¸ªåˆ†ç‰‡ä¸Šã€‚é»˜è®¤å…¬å¼å¦‚ä¸‹ï¼š<br>  <code>shard_num = hash(_routing) % num_primary_shards</code><br>  _routingå­—æ®µçš„å–å€¼ï¼Œé»˜è®¤æ˜¯_idå­—æ®µï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯è®¾ç½®ç»å¸¸æŸ¥è¯¢çš„å­—æ®µä½œä¸ºè·¯ç”±å­—æ®µã€‚ä¾‹å¦‚å¯ä»¥è€ƒè™‘å°†ç”¨æˆ·idã€åœ°åŒºä½œä¸ºè·¯ç”±å­—æ®µï¼ŒæŸ¥è¯¢æ—¶å¯ä»¥è¿‡æ»¤ä¸å¿…è¦çš„åˆ†ç‰‡ï¼ŒåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚</p></li><li><p>é¿å…ä½¿ç”¨wildcardæ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢<br>  Elasticsearché»˜è®¤æ”¯æŒé€šè¿‡*ï¼Ÿæ­£åˆ™è¡¨è¾¾å¼æ¥åšæ¨¡ç³ŠåŒ¹é…ï¼Œæ•°æ®é‡çº§åˆ«è¾¾åˆ°TB+ç”šè‡³æ›´é«˜ä¹‹åï¼Œæ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢é€šå¸¸ä¼šè€—æ—¶æ¯”è¾ƒé•¿ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œå¡æ­»ä¹ƒè‡³å´©æºƒå®•æœºçš„æƒ…å†µã€‚æ‰€ä»¥æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ï¼Œä¸è¦ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢ã€‚</p></li><li><p>åˆç†çš„é…ç½®ä½¿ç”¨indexå±æ€§ï¼Œanalyzedå’Œnot_analyzedï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚æ¥æ§åˆ¶å­—æ®µæ˜¯å¦åˆ†è¯æˆ–ä¸åˆ†è¯ã€‚åªæœ‰groupbyéœ€æ±‚çš„å­—æ®µï¼Œé…ç½®æ—¶å°±è®¾ç½®æˆnot_analyzed,ä»¥æé«˜æŸ¥è¯¢æˆ–èšç±»çš„æ•ˆç‡ã€‚</p></li><li><p>query_stringæˆ–multi_matchçš„æŸ¥è¯¢å­—æ®µè¶Šå¤šï¼ŒæŸ¥è¯¢è¶Šæ…¢ã€‚<br>  å¯ä»¥åœ¨mappingé˜¶æ®µï¼Œåˆ©ç”¨copy_toå±æ€§å°†å¤šå­—æ®µçš„å€¼ç´¢å¼•åˆ°ä¸€ä¸ªæ–°å­—æ®µï¼Œmulti_matchæ—¶ï¼Œç”¨æ–°çš„å­—æ®µæŸ¥è¯¢ã€‚</p></li><li><p><strong>æ—¥æœŸå­—æ®µçš„æŸ¥è¯¢</strong><br>  å°¤å…¶æ˜¯ç”¨nowçš„æŸ¥è¯¢å®é™…ä¸Šæ˜¯ä¸å­˜åœ¨ç¼“å­˜çš„ï¼Œå› æ­¤ï¼Œ å¯ä»¥ä»ä¸šåŠ¡çš„è§’åº¦æ¥è€ƒè™‘æ˜¯å¦ä¸€å®šè¦ç”¨now,æ¯•ç«Ÿåˆ©ç”¨query cacheæ˜¯èƒ½å¤Ÿå¤§å¤§æé«˜æŸ¥è¯¢æ•ˆç‡çš„ã€‚</p></li><li><p><strong>æŸ¥è¯¢ç»“æœé›†çš„å¤§å°ä¸èƒ½éšæ„è®¾ç½®æˆå¤§å¾—ç¦»è°±çš„å€¼</strong><br>  å¦‚query.setSizeä¸èƒ½è®¾ç½®æˆInteger.MAX_VALUEï¼Œ<font color=red>å› ä¸ºESå†…éƒ¨éœ€è¦å»ºç«‹ä¸€ä¸ªæ•°æ®ç»“æ„æ¥æ”¾æŒ‡å®šå¤§å°çš„ç»“æœé›†æ•°æ®ã€‚</font></p></li><li><p><strong>å°½é‡é¿å…ä½¿ç”¨scriptï¼Œä¸‡ä¸å¾—å·²éœ€è¦ä½¿ç”¨çš„è¯ï¼Œé€‰æ‹©painless &amp; experssionså¼•æ“ã€‚</strong><br>  <font color=blue>ä¸€æ—¦ä½¿ç”¨scriptæŸ¥è¯¢ï¼Œä¸€å®šè¦æ³¨æ„æ§åˆ¶è¿”å›ï¼Œåƒä¸‡ä¸è¦æœ‰æ­»å¾ªç¯ï¼Œå› ä¸ºESæ²¡æœ‰è„šæœ¬è¿è¡Œçš„è¶…æ—¶æ§åˆ¶ï¼Œåªè¦å½“å‰çš„è„šæœ¬æ²¡æ‰§è¡Œå®Œï¼Œè¯¥æŸ¥è¯¢ä¼šä¸€ç›´é˜»å¡ã€‚</font></p></li></ul><h2 id="å®¹é‡è§„åˆ’"><a href="#å®¹é‡è§„åˆ’" class="headerlink" title="å®¹é‡è§„åˆ’"></a>å®¹é‡è§„åˆ’</h2><ul><li><p><strong>åˆ†ç‰‡(shard)å®¹é‡</strong></p><ul><li>éæ—¥å¿—å‹(æœç´¢å‹ã€çº¿ä¸Šä¸šåŠ¡å‹)çš„shardå®¹é‡åœ¨10~30GBï¼ˆå»ºè®®åœ¨10Gï¼‰</li><li>æ—¥å¿—å‹çš„shardå®¹é‡åœ¨30~100GBï¼ˆå»ºè®®30Gï¼‰</li><li>å•ä¸ªshardçš„æ–‡æ¡£ä¸ªæ•°ä¸èƒ½è¶…è¿‡21äº¿å·¦å³(Integer.MAX_VALUE - 128)<br>æ³¨ï¼šä¸€ä¸ªshardå°±æ˜¯ä¸€ä¸ªluceneåˆ†ç‰‡ï¼ŒESåº•å±‚åŸºäºluceneå®ç°ã€‚ä¸»åˆ†ç‰‡ä¸ªæ•°ä¸€æ—¦ç¡®å®šï¼Œå°±ä¸å¯ä»¥æ›´æ”¹ã€‚å‰¯æœ¬åˆ†ç‰‡ä¸ªæ•°å¯ä»¥æ ¹æ®éœ€è¦éšæ—¶ä¿®æ”¹ã€‚</li></ul></li><li><p><strong>ç´¢å¼•(index)æ•°é‡</strong><br>å¤§ç´¢å¼•éœ€è¦æ‹†åˆ†ï¼šå¢å¼ºæ€§èƒ½ï¼Œé£é™©åˆ†æ•£ã€‚<br>åä¾‹ï¼šä¸€ä¸ª10Tçš„ç´¢å¼•ï¼Œä¾‹å¦‚æŒ‰dateæŸ¥è¯¢ã€nameæŸ¥è¯¢<br>æ­£ä¾‹ï¼šindex_nameæ‹†æˆå¤šä¸ªindex_name_${date}<br>æ­£ä¾‹ï¼šindex_nameæŒ‰hashæ‹†åˆ†index_name_{1,2,3,â€¦100..}<br>æç¤ºï¼šç´¢å¼•å’Œshardæ•°å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå¯¹äºæ‰¹é‡è¯»å†™éƒ½ä¼šæœ‰æ€§èƒ½ä¸‹é™ï¼Œæ‰€ä»¥è¦ç»¼åˆè€ƒè™‘æ€§èƒ½å’Œå®¹é‡è§„åˆ’ï¼ŒåŒæ—¶é…åˆå‹åŠ›æµ‹è¯•ï¼Œä¸å­˜åœ¨çœŸæ­£çš„æœ€ä¼˜è§£ã€‚</p></li><li><p><strong>èŠ‚ç‚¹ã€åˆ†ç‰‡ã€ç´¢å¼•</strong><br>ä¸€ä¸ªèŠ‚ç‚¹ç®¡ç†çš„shardæ•°ä¸è¦è¶…è¿‡200ä¸ª</p></li></ul><h2 id="é…ç½®ä½¿ç”¨è§„èŒƒ"><a href="#é…ç½®ä½¿ç”¨è§„èŒƒ" class="headerlink" title="é…ç½®ä½¿ç”¨è§„èŒƒ"></a>é…ç½®ä½¿ç”¨è§„èŒƒ</h2><ul><li><p><strong>shardä¸ªæ•°ï¼ˆnumber_of_shardsï¼‰</strong><br>  primery shard ï¼šé»˜è®¤æ•°é‡æ˜¯1<br>  replica shardæ•°é‡ä¸º1ï¼š æ˜¯æ¯ä¸ªprimary shard æœ‰å¤šå°‘ä¸ªå‰¯æœ¬åˆ†ç‰‡çš„æ„æ€<br>  primery shard = 1 ; replica shard = 2 ; æ„å‘³ç€ä¸€ä¸ªç´¢å¼•ï¼Œä¸€å…±å­˜åœ¨9ä¸ªshard</p></li><li><p><strong>refreshé¢‘ç‡ï¼ˆrefresh_intervalï¼‰</strong><br>  ESçš„å®šä½æ˜¯å‡†å®æ—¶æœç´¢å¼•æ“ï¼Œè¯¥å€¼é»˜è®¤æ˜¯1sï¼Œè¡¨ç¤ºå†™å…¥å1ç§’åå¯è¢«æœç´¢åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œçš„å€¼å–å†³äºä¸šåŠ¡å¯¹å®æ—¶æ€§çš„è¦æ±‚ï¼Œæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯è¶Šå°è¶Šå¥½ï¼Œåˆ·æ–°é¢‘ç‡é«˜ä¹Ÿæ„å‘³ç€å¯¹ESçš„å¼€é”€ä¹Ÿå¤§ï¼Œé€šå¸¸ä¸šåŠ¡ç±»å‹åœ¨1-5sï¼Œæ—¥å¿—å‹åœ¨30s-120sï¼Œå¦‚æœé›†ä¸­å¯¼å…¥æ•°æ®å¯å°†å…¶è®¾ç½®ä¸º-1ï¼ŒESä¼šè‡ªåŠ¨å®Œæˆæ•°æ®åˆ·æ–°ï¼ˆæ³¨æ„å®Œæˆåæ›´æ”¹å›æ¥ï¼Œå¦åˆ™åç»­ä¼šå‡ºç°æœç´¢ä¸åˆ°æ•°æ®ï¼‰</p></li><li><p><strong>ä½¿ç”¨åˆ«åï¼ˆaliasesï¼‰</strong>ï¼šä¸è¦è¿‡åº¦ä¾èµ–åˆ«ååŠŸèƒ½</p></li><li><p><strong>æ…¢æ—¥å¿—ï¼ˆslowlogï¼‰</strong></p></li><li><p><strong>è®¾ç½®åˆç†çš„routing key(é»˜è®¤æ˜¯id)</strong><br>  idä¸å‡è¡¡ï¼šé›†ç¾¤å®¹é‡å’Œè®¿é—®ä¸å‡è¡¡ï¼Œå¯¹äºåˆ†å¸ƒå¼å­˜å‚¨æ˜¯è‡´å‘½çš„</p></li><li><p><strong>å…³é—­_all</strong><br>  ES6.0å·²ç»å»æ‰ï¼Œå¯¹å®¹é‡ï¼ˆç´¢å¼•è¿‡å¤§ï¼‰å’Œæ€§èƒ½ï¼ˆæ€§èƒ½ä¸‹é™ï¼‰éƒ½æœ‰å½±å“ã€‚    </p></li><li><p><strong>é¿å…å¤§å®½è¡¨</strong><br>  ESé»˜è®¤æœ€å¤§1000ï¼Œä½†å»ºè®®ä¸è¦è¶…è¿‡100.    </p></li><li><p><strong>textç±»å‹çš„å­—æ®µä¸è¦ä½¿ç”¨èšåˆæŸ¥è¯¢ã€‚</strong><br>  <font color=red>textç±»å‹fileddataä¼šåŠ å¤§å¯¹å†…å­˜çš„å ç”¨ï¼Œå¦‚æœæœ‰éœ€æ±‚ä½¿ç”¨ï¼Œå»ºè®®ä½¿ç”¨keyword</font></p></li><li><p><strong>èšåˆæŸ¥è¯¢é¿å…ä½¿ç”¨è¿‡å¤šåµŒå¥—</strong><br>  <font color=red>èšåˆæŸ¥è¯¢çš„ä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœéƒ½ä¼šåœ¨å†…å­˜ä¸­è¿›è¡Œï¼ŒåµŒå¥—è¿‡å¤šï¼Œä¼šå¯¼è‡´å†…å­˜è€—å°½</font></p></li><li><p><strong>ä¿®æ”¹index_buffer_sizeçš„è®¾ç½®</strong><br>  å¯ä»¥è®¾ç½®æˆç™¾åˆ†æ•°ï¼Œä¹Ÿå¯è®¾ç½®æˆå…·ä½“çš„å¤§å°ï¼Œå¤§å°å¯æ ¹æ®é›†ç¾¤çš„è§„æ¨¡åšä¸åŒçš„è®¾ç½®æµ‹è¯•ã€‚<br>ã€€ã€€<code>indices.memory.index_buffer_sizeï¼š10%ï¼ˆé»˜è®¤ï¼‰</code><br>ã€€ã€€<code>indices.memory.min_index_buffer_sizeï¼š 48mbï¼ˆé»˜è®¤ï¼‰</code><br>ã€€ã€€<code>indices.memory.max_index_buffer_size</code></p></li><li><p><strong>ä¿®æ”¹translogç›¸å…³çš„è®¾ç½®</strong></p><ul><li>æ§åˆ¶æ•°æ®ä»å†…å­˜åˆ°ç¡¬ç›˜çš„æ“ä½œé¢‘ç‡ï¼Œä»¥å‡å°‘ç¡¬ç›˜IOã€‚å¯å°†sync_intervalçš„æ—¶é—´è®¾ç½®å¤§ä¸€äº›ã€‚<br>ã€€ã€€      <code>index.translog.sync_intervalï¼š5s(é»˜è®¤)</code></li><li>æ§åˆ¶tranlogæ•°æ®å—çš„å¤§å°ï¼Œè¾¾åˆ°thresholdå¤§å°æ—¶ï¼Œæ‰ä¼šflushåˆ°luceneç´¢å¼•æ–‡ä»¶ã€‚<br>  <code>index.translog.flush_threshold_sizeï¼š512mb(é»˜è®¤)    </code></li></ul></li><li><p><strong>_idå­—æ®µçš„ä½¿ç”¨</strong><br>  åº”å°½å¯èƒ½é¿å…è‡ªå®šä¹‰_id,ä»¥é¿å…é’ˆå¯¹IDçš„ç‰ˆæœ¬ç®¡ç†ï¼›å»ºè®®ä½¿ç”¨ESçš„é»˜è®¤IDç”Ÿæˆç­–ç•¥æˆ–ä½¿ç”¨æ•°å­—ç±»å‹IDåšä¸ºä¸»é”®    </p></li><li><p><strong>Cacheçš„è®¾ç½®åŠä½¿ç”¨</strong></p><ul><li>QueryCache: ESæŸ¥è¯¢çš„æ—¶å€™ï¼Œä½¿ç”¨filteræŸ¥è¯¢ä¼šä½¿ç”¨query cache,å¦‚æœä¸šåŠ¡åœºæ™¯ä¸­çš„è¿‡æ»¤æŸ¥è¯¢æ¯”è¾ƒå¤šï¼Œå»ºè®®å°†querycacheè®¾ç½®å¤§ä¸€äº›ï¼Œä»¥æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚<br><code>indices.queries.cache.sizeï¼š 10%ï¼ˆé»˜è®¤ï¼‰</code>ï¼Œå¯è®¾ç½®æˆç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯è®¾ç½®æˆå…·ä½“å€¼ï¼Œå¦‚256mbã€‚</li></ul><p>  å½“ç„¶ä¹Ÿå¯ä»¥ç¦ç”¨æŸ¥è¯¢ç¼“å­˜ï¼ˆé»˜è®¤æ˜¯å¼€å¯ï¼‰, é€šè¿‡<code>index.queries.cache.enabledï¼šfalse</code>è®¾ç½®ã€‚</p><ul><li>FieldDataCache:åœ¨èšç±»æˆ–æ’åºæ—¶ï¼Œ<code>field data cache</code>ä¼šä½¿ç”¨é¢‘ç¹ï¼Œå› æ­¤ï¼Œ<strong>è®¾ç½®å­—æ®µæ•°æ®ç¼“å­˜çš„å¤§å°ï¼Œåœ¨èšç±»æˆ–æ’åºåœºæ™¯è¾ƒå¤šçš„æƒ…å½¢ä¸‹å¾ˆæœ‰å¿…è¦</strong><br>  å¯é€šè¿‡<code>indices.fielddata.cache.sizeï¼š30%</code>æˆ–<code>å…·ä½“å€¼10GB</code>æ¥è®¾ç½®ã€‚<strong>ä½†æ˜¯å¦‚æœåœºæ™¯æˆ–æ•°æ®å˜æ›´æ¯”è¾ƒé¢‘ç¹ï¼Œè®¾ç½®cacheå¹¶ä¸æ˜¯å¥½çš„åšæ³•ï¼Œå› ä¸ºç¼“å­˜åŠ è½½çš„å¼€é”€ä¹Ÿæ˜¯ç‰¹åˆ«å¤§çš„ã€‚</strong></li><li><strong>ShardRequestCache</strong><br>æŸ¥è¯¢è¯·æ±‚å‘èµ·åï¼Œæ¯ä¸ªåˆ†ç‰‡ä¼šå°†ç»“æœè¿”å›ç»™åè°ƒèŠ‚ç‚¹(Coordinating Node),ç”±åè°ƒèŠ‚ç‚¹å°†ç»“æœæ•´åˆã€‚<br>å¦‚æœæœ‰éœ€æ±‚ï¼Œå¯ä»¥è®¾ç½®å¼€å¯;é€šè¿‡è®¾ç½®<strong>index.requests.cache.enable: true</strong>æ¥å¼€å¯ã€‚<br>ä¸è¿‡ï¼Œ<code>shard request cache</code>åªç¼“å­˜<code>hits.total</code>, <code>aggregations</code>, <code>suggestions</code>ç±»å‹çš„æ•°æ®ï¼Œå¹¶ä¸ä¼šç¼“å­˜hitsçš„å†…å®¹ã€‚ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®<code>indices.requests.cache.size: 1%ï¼ˆé»˜è®¤ï¼‰</code>æ¥æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ã€‚    </li></ul></li></ul><h2 id="å­—æ®µè®¾è®¡è§„èŒƒ"><a href="#å­—æ®µè®¾è®¡è§„èŒƒ" class="headerlink" title="å­—æ®µè®¾è®¡è§„èŒƒ"></a>å­—æ®µè®¾è®¡è§„èŒƒ</h2><ul><li><p>textå’Œkeywordçš„ç”¨é€”å¿…é¡»åˆ†æ¸…ï¼šåˆ†è¯å’Œå…³é”®è¯ï¼ˆç¡®å®šå­—æ®µæ˜¯å¦éœ€è¦åˆ†è¯ï¼‰</p></li><li><p>ç¡®å®šå­—æ®µæ˜¯å¦éœ€è¦ç‹¬ç«‹å­˜å‚¨</p></li><li><p>å­—æ®µç±»å‹ä¸æ”¯æŒä¿®æ”¹ï¼Œå¿…é¡»è°¨æ…ã€‚</p></li><li><p>å¯¹ä¸éœ€è¦è¿›è¡Œèšåˆ/æ’åºçš„å­—æ®µç¦ç”¨doc_values</p></li><li><p>ä¸è¦åœ¨textåšæ¨¡ç³Šæœç´¢ï¼š</p></li></ul><h2 id="è¿è§„æ“ä½œ"><a href="#è¿è§„æ“ä½œ" class="headerlink" title="è¿è§„æ“ä½œ"></a>è¿è§„æ“ä½œ</h2><ul><li>åŸåˆ™ï¼šä¸è¦å¿½ç•¥è®¾è®¡ï¼Œå¿«å°±æ˜¯æ…¢ï¼Œåçš„ç´¢å¼•è®¾è®¡åæ‚£æ— ç©·.</li><li>æ‹’ç»å¤§èšåˆ ï¼šESè®¡ç®—éƒ½åœ¨JVMå†…å­˜ä¸­å®Œæˆã€‚</li><li>æ‹’ç»æ¨¡ç³ŠæŸ¥è¯¢ï¼šesä¸€å¤§æ€æ‰‹</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;wildcard&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;title.keyword&quot;</span>:<span class="string">&quot;*å¼ ä¸‰*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>æ‹’ç»æ·±åº¦åˆ†é¡µ<br>  ESè·å–æ•°æ®æ—¶ï¼Œæ¯æ¬¡é»˜è®¤æœ€å¤šè·å–10000æ¡ï¼Œè·å–æ›´å¤šéœ€è¦åˆ†é¡µï¼Œä½†å­˜åœ¨æ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œ<font color=red>ä¸€å®šä¸è¦ä½¿ç”¨from/Sizeæ–¹å¼ï¼Œå»ºè®®ä½¿ç”¨scrollæˆ–è€…searchAfteræ–¹å¼ã€‚</font> scrollä¼šæŠŠä¸Šä¸€æ¬¡æŸ¥è¯¢ç»“æœç¼“å­˜ä¸€å®šæ—¶é—´ï¼ˆé€šè¿‡é…ç½®scroll=1må®ç°)ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨scrollæ—¶ä¸€å®šè¦ä¿è¯searchç»“æœé›†ä¸è¦å¤ªå¤§ã€‚</p></li><li><p>åŸºæ•°æŸ¥è¯¢<br>å°½é‡ä¸è¦ç”¨åŸºæ•°æŸ¥è¯¢å»æŸ¥è¯¢å»é‡åçš„æ•°æ®é‡å¤§å°ï¼ˆkibanaä¸­ç•Œé¢ä¸Šæ˜¾ç¤ºæ˜¯Unique Countï¼ŒDistinct Countç­‰ï¼‰ï¼Œå³å°‘ç”¨å¦‚ä¸‹çš„æŸ¥è¯¢ï¼š</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">     <span class="attr">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;userId&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>ç¦æ­¢æŸ¥è¯¢ indexName-*</li><li>é¿å…ä½¿ç”¨scriptã€update_by_queryã€delete_by_queryï¼Œå¯¹çº¿ä¸Šæ€§èƒ½å½±å“è¾ƒå¤§ã€‚</li></ul><h2 id="å»ºè®®æ“ä½œ"><a href="#å»ºè®®æ“ä½œ" class="headerlink" title="å»ºè®®æ“ä½œ"></a>å»ºè®®æ“ä½œ</h2><ul><li><strong>å¤ç”¨é¢„ç´¢å¼•æ•°æ®æ–¹å¼æ¥æé«˜AGGæ€§èƒ½</strong><br>  å¦‚é€šè¿‡terms aggregationsæ›¿ä»£range aggregationsï¼Œ å¦‚è¦æ ¹æ®å¹´é¾„æ¥åˆ†ç»„ï¼Œåˆ†ç»„ç›®æ ‡æ˜¯:å°‘å¹´ï¼ˆ14å²ä»¥ä¸‹ï¼‰ é’å¹´ï¼ˆ14-28ï¼‰ ä¸­å¹´ï¼ˆ29-50ï¼‰ è€å¹´ï¼ˆ51ä»¥ä¸Šï¼‰ï¼Œ <font color=red>å¯ä»¥åœ¨ç´¢å¼•çš„æ—¶å€™è®¾ç½®ä¸€ä¸ªage_groupå­—æ®µï¼Œé¢„å…ˆå°†æ•°æ®è¿›è¡Œåˆ†ç±»</font>ã€‚ä»è€Œä¸ç”¨æŒ‰ageæ¥åšrange aggregations,é€šè¿‡age_groupå­—æ®µå°±å¯ä»¥äº†ã€‚</li><li><strong>é¿å…å°†ä¸ç›¸å…³çš„æ•°æ®æ”¾åœ¨åŒä¸€ä¸ªç´¢å¼•ä¸­ï¼Œä»¥é¿å…ç¨€ç–ï¼Œå°†è¿™äº›æ–‡ä»¶æ”¾åœ¨ä¸åŒçš„ç´¢å¼•ä¸­å¾€å¾€æ›´å¥½ã€‚</strong></li></ul><h2 id="ç´¢å¼•åŠå­—æ®µå‘½åè§„èŒƒ"><a href="#ç´¢å¼•åŠå­—æ®µå‘½åè§„èŒƒ" class="headerlink" title="ç´¢å¼•åŠå­—æ®µå‘½åè§„èŒƒ"></a>ç´¢å¼•åŠå­—æ®µå‘½åè§„èŒƒ</h2><h3 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h3><p>ç´¢å¼•å—æ–‡ä»¶ç³»ç»Ÿçš„é™åˆ¶ã€‚ä»…å¯èƒ½ä¸ºå°å†™å­—æ¯ï¼Œä¸èƒ½ä¸‹åˆ’çº¿å¼€å¤´ã€‚åŒæ—¶éœ€éµå®ˆä¸‹åˆ—è§„åˆ™ï¼š</p><ul><li>ä¸èƒ½åŒ…æ‹¬ , /, *, ?, â€œ, &lt;, &gt;, |, ç©ºæ ¼, é€—å·, #</li><li>7.0ç‰ˆæœ¬ä¹‹å‰å¯ä»¥ä½¿ç”¨å†’å·:,ä½†ä¸å»ºè®®ä½¿ç”¨å¹¶åœ¨7.0ç‰ˆæœ¬ä¹‹åä¸å†æ”¯æŒ</li><li>ä¸èƒ½ä»¥è¿™äº›å­—ç¬¦ -, _, + å¼€å¤´</li><li>ä¸èƒ½åŒ…æ‹¬ . æˆ– â€¦</li><li>é•¿åº¦ä¸èƒ½è¶…è¿‡ 255 ä¸ªå­—ç¬¦</li></ul><p>ä»¥ä¸Šè¿™äº›å‘½åé™åˆ¶æ˜¯å› ä¸ºå½“Elasticsearchä½¿ç”¨ç´¢å¼•åç§°ä½œä¸ºç£ç›˜ä¸Šçš„ç›®å½•åç§°ï¼Œè¿™äº›åç§°å¿…é¡»ç¬¦åˆä¸åŒæ“ä½œç³»ç»Ÿçš„çº¦å®šã€‚<br>æœªæ¥å¯èƒ½ä¼šæ”¾å¼€è¿™äº›é™åˆ¶ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨uuidå…³è”ç´¢å¼•æ”¾åœ¨ç£ç›˜ä¸Šï¼Œè€Œä¸ä½¿ç”¨ç´¢å¼•åç§°</p><h3 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h3><p><font color=red>7.0ç‰ˆæœ¬ä¹‹åä¸å†æ”¯æŒç±»å‹ï¼Œé»˜è®¤ä¸º_doc</font></p><h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><ul><li>ä¸€ä¸ªç´¢å¼•çš„shardæ•°ä¸€æ—¦ç¡®å®šä¸èƒ½æ”¹å˜</li><li>ESä¸æ”¯æŒäº‹åŠ¡ACIDç‰¹æ€§ã€‚</li><li>reindexï¼šreindexå¯ä»¥å®ç°ç´¢å¼•çš„shardå˜æ›´ï¼Œä½†ä»£ä»·éå¸¸å¤§ï¼šé€Ÿåº¦æ…¢ã€å¯¹æ€§èƒ½æœ‰å½±å“ï¼Œæ‰€ä»¥å¥½çš„è®¾è®¡å’Œè§„åˆ’æ›´é‡è¦</li><li>fieldä¸€æ—¦åˆ›å»ºä¸èƒ½æ›´æ”¹mappingï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ï¼Œåˆ™å¿…é¡»é‡æ–°åˆ›å»ºç´¢å¼•</li></ul><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h2><ul><li><a href="http://www.javajcw.com/72.html">Elasticsearch ä½¿ç”¨è§„èŒƒ</a></li><li><a href="https://blog.csdn.net/neweastsun/article/details/95868716">Elasticsearchç´¢å¼•åŠå­—æ®µå‘½åè§„èŒƒ</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Elasticsearchä½¿ç”¨è§„èŒƒ&quot;&gt;&lt;a href=&quot;#Elasticsearchä½¿ç”¨è§„èŒƒ&quot; class=&quot;headerlink&quot; title=&quot;Elasticsearchä½¿ç”¨è§„èŒƒ&quot;&gt;&lt;/a&gt;Elasticsearchä½¿ç”¨è§„èŒƒ&lt;/h1&gt;&lt;h2 id=&quot;æŸ¥è¯¢è§„èŒƒå»º</summary>
      
    
    
    
    
    <category term="Elasticsearch" scheme="http://example.com/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®ç»“æ„åŠç®—æ³•-æ ‘</title>
    <link href="http://example.com/wiki/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E7%AE%97%E6%B3%95-%E6%A0%91/"/>
    <id>http://example.com/wiki/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E7%AE%97%E6%B3%95-%E6%A0%91/</id>
    <published>2021-09-30T08:36:56.000Z</published>
    <updated>2021-09-30T08:36:56.240Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><blockquote><ul><li><a href=""></a></li><li><a href=""></a></li></ul></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‚è€ƒèµ„æ–™&quot;&gt;&lt;a href=&quot;#å‚è€ƒèµ„æ–™&quot; class=&quot;headerlink&quot; title=&quot;å‚è€ƒèµ„æ–™&quot;&gt;&lt;/a&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;&lt;/a&gt;&lt;/l</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://example.com/wiki/draft/%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/"/>
    <id>http://example.com/wiki/draft/%E8%BF%9C%E7%A8%8B%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/</id>
    <published>2021-09-27T14:11:31.478Z</published>
    <updated>2021-09-27T14:36:06.660Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®"><a href="#åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®" class="headerlink" title="åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®"></a>åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®</h1><h2 id="1ã€ä»€ä¹ˆæ˜¯é€šä¿¡"><a href="#1ã€ä»€ä¹ˆæ˜¯é€šä¿¡" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯é€šä¿¡"></a>1ã€ä»€ä¹ˆæ˜¯é€šä¿¡</h2><p>å¸¸è§çš„é€šä¿¡æœ‰ä¸¤ç§ï¼š</p><p>1ã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„é€šä¿¡ï¼Œé€šè¿‡httpåè®®è¿›è¡Œé€šä¿¡ï¼Œæˆ–è€…æœåŠ¡å™¨ä¸æœåŠ¡å™¨ä¹‹é—´ä¹Ÿä¼šè¿›è¡Œé€šä¿¡ã€‚</p><p>2ã€å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ï¼Œé€šè¿‡RPCï¼Œå®ç°ç±»ä¼¼äºå•ä½“æ¶æ„ä¸­çš„serviceæ–¹æ³•çš„è°ƒç”¨ã€‚</p><h2 id="2ã€Javaä¸­æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡å‘¢"><a href="#2ã€Javaä¸­æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡å‘¢" class="headerlink" title="2ã€Javaä¸­æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡å‘¢"></a>2ã€Javaä¸­æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡å‘¢</h2><p>é€šè¿‡socketå¥—æ¥å­—å®ç°</p><blockquote><p>æ¢è¡Œç¬¦ å‘ å¯¼è‡´æç¤ºConnection Reset (readline)</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®&quot;&gt;&lt;a href=&quot;#åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®&quot; class=&quot;headerlink&quot; title=&quot;åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®&quot;&gt;&lt;/a&gt;åˆ†å¸ƒå¼æ¶æ„åŸºçŸ³-è¿œç¨‹é€šä¿¡åè®®&lt;/h1&gt;&lt;h2 id=&quot;1ã€ä»€ä¹ˆæ˜¯é€šä¿¡&quot;&gt;&lt;a href=</summary>
      
    
    
    
    <category term="draft" scheme="http://example.com/categories/draft/"/>
    
    
  </entry>
  
  <entry>
    <title>äºŒåˆ†æŸ¥æ‰¾ï¼ˆè¿­ä»£&amp;é€’å½’ï¼‰</title>
    <link href="http://example.com/wiki/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%EF%BC%88%E8%BF%AD%E4%BB%A3-%E9%80%92%E5%BD%92%EF%BC%89/"/>
    <id>http://example.com/wiki/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%EF%BC%88%E8%BF%AD%E4%BB%A3-%E9%80%92%E5%BD%92%EF%BC%89/</id>
    <published>2021-09-27T09:00:45.000Z</published>
    <updated>2021-09-27T09:59:51.333Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/binary-search/">https://leetcode-cn.com/problems/binary-search/</a></p><h2 id="1-äºŒåˆ†æŸ¥æ‰¾"><a href="#1-äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="1. äºŒåˆ†æŸ¥æ‰¾"></a>1. äºŒåˆ†æŸ¥æ‰¾</h2><p>ç»™å®šä¸€ä¸ª n ä¸ªå…ƒç´ æœ‰åºçš„ï¼ˆå‡åºï¼‰æ•´å‹æ•°ç»„ nums å’Œä¸€ä¸ªç›®æ ‡å€¼ target  ï¼Œå†™ä¸€ä¸ªå‡½æ•°æœç´¢ nums ä¸­çš„ targetï¼Œå¦‚æœç›®æ ‡å€¼å­˜åœ¨è¿”å›ä¸‹æ ‡ï¼Œå¦åˆ™è¿”å› -1ã€‚</p><h3 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹ 1:"></a>ç¤ºä¾‹ 1:</h3><p>è¾“å…¥: <code>nums = [-1,0,3,5,9,12], target = 9</code><br>è¾“å‡º: 4<br>è§£é‡Š: 9 å‡ºç°åœ¨ nums ä¸­å¹¶ä¸”ä¸‹æ ‡ä¸º 4</p><h3 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹ 2:"></a>ç¤ºä¾‹ 2:</h3><p>è¾“å…¥: <code>nums = [-1,0,3,5,9,12], target = 2</code><br>è¾“å‡º: -1<br>è§£é‡Š: 2 ä¸å­˜åœ¨ nums ä¸­å› æ­¤è¿”å› -1</p><p>æç¤ºï¼š</p><blockquote><p>ä½ å¯ä»¥å‡è®¾ nums ä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯ä¸é‡å¤çš„ã€‚<br>n å°†åœ¨ [1, 10000]ä¹‹é—´ã€‚<br>nums çš„æ¯ä¸ªå…ƒç´ éƒ½å°†åœ¨ [-9999, 9999]ä¹‹é—´ã€‚</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/image-20210927170614830.png" alt="image-20210927170614830"></p><h3 id="é€’å½’å†™æ³•"><a href="#é€’å½’å†™æ³•" class="headerlink" title="é€’å½’å†™æ³•"></a>é€’å½’å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// æ³¨æ„è¾¹ç•Œ</span></span><br><span class="line">        <span class="keyword">return</span> find(<span class="number">0</span>, nums.length - <span class="number">1</span>, target, nums);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> right, <span class="keyword">int</span> target, <span class="keyword">int</span>[] nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left &lt;= right) &#123;</span><br><span class="line">          <span class="comment">// æ³¨æ„midå–å€¼çš„å†™æ³•ï¼Œé¿å…è¶Šç•Œå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">int</span> mid = (right - left) / <span class="number">2</span> + left;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &gt; target) &#123;</span><br><span class="line">                <span class="keyword">return</span> find(left, mid - <span class="number">1</span>, target, nums);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">                <span class="keyword">return</span> find(mid + <span class="number">1</span>, right, target, nums);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿­ä»£å†™æ³•"><a href="#è¿­ä»£å†™æ³•" class="headerlink" title="è¿­ä»£å†™æ³•"></a>è¿­ä»£å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> right = nums.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(left &lt;= right) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (right - left) / <span class="number">2</span> + left;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &gt; target) &#123;</span><br><span class="line">                right = mid - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">                left = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-æŸ¥æ‰¾ç¬¬ä¸€ä¸ªé”™è¯¯ç‰ˆæœ¬"><a href="#2-æŸ¥æ‰¾ç¬¬ä¸€ä¸ªé”™è¯¯ç‰ˆæœ¬" class="headerlink" title="2. æŸ¥æ‰¾ç¬¬ä¸€ä¸ªé”™è¯¯ç‰ˆæœ¬"></a>2. æŸ¥æ‰¾ç¬¬ä¸€ä¸ªé”™è¯¯ç‰ˆæœ¬</h2><p><a href="https://leetcode-cn.com/problems/first-bad-version/">leetcode278</a></p><p>ä½ æ˜¯äº§å“ç»ç†ï¼Œç›®å‰æ­£åœ¨å¸¦é¢†ä¸€ä¸ªå›¢é˜Ÿå¼€å‘æ–°çš„äº§å“ã€‚ä¸å¹¸çš„æ˜¯ï¼Œä½ çš„äº§å“çš„æœ€æ–°ç‰ˆæœ¬æ²¡æœ‰é€šè¿‡è´¨é‡æ£€æµ‹ã€‚ç”±äºæ¯ä¸ªç‰ˆæœ¬éƒ½æ˜¯åŸºäºä¹‹å‰çš„ç‰ˆæœ¬å¼€å‘çš„ï¼Œæ‰€ä»¥é”™è¯¯çš„ç‰ˆæœ¬ä¹‹åçš„æ‰€æœ‰ç‰ˆæœ¬éƒ½æ˜¯é”™çš„ã€‚</p><p>å‡è®¾ä½ æœ‰ n ä¸ªç‰ˆæœ¬ [1, 2, â€¦, n]ï¼Œä½ æƒ³æ‰¾å‡ºå¯¼è‡´ä¹‹åæ‰€æœ‰ç‰ˆæœ¬å‡ºé”™çš„ç¬¬ä¸€ä¸ªé”™è¯¯çš„ç‰ˆæœ¬ã€‚</p><p>ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ bool isBadVersion(version) æ¥å£æ¥åˆ¤æ–­ç‰ˆæœ¬å· version æ˜¯å¦åœ¨å•å…ƒæµ‹è¯•ä¸­å‡ºé”™ã€‚å®ç°ä¸€ä¸ªå‡½æ•°æ¥æŸ¥æ‰¾ç¬¬ä¸€ä¸ªé”™è¯¯çš„ç‰ˆæœ¬ã€‚ä½ åº”è¯¥å°½é‡å‡å°‘å¯¹è°ƒç”¨ API çš„æ¬¡æ•°ã€‚</p><h3 id="ç¤ºä¾‹-1ï¼š"><a href="#ç¤ºä¾‹-1ï¼š" class="headerlink" title="ç¤ºä¾‹ 1ï¼š"></a>ç¤ºä¾‹ 1ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šn = 5, bad = 4</span><br><span class="line">è¾“å‡ºï¼š4</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">è°ƒç”¨ isBadVersion(3) -&gt; false </span><br><span class="line">è°ƒç”¨ isBadVersion(5) -&gt; true </span><br><span class="line">è°ƒç”¨ isBadVersion(4) -&gt; true</span><br><span class="line">æ‰€ä»¥ï¼Œ4 æ˜¯ç¬¬ä¸€ä¸ªé”™è¯¯çš„ç‰ˆæœ¬ã€‚</span><br></pre></td></tr></table></figure><h3 id="è¿­ä»£å†™æ³•-1"><a href="#è¿­ä»£å†™æ³•-1" class="headerlink" title="è¿­ä»£å†™æ³•"></a>è¿­ä»£å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> <span class="keyword">extends</span> <span class="title">VersionControl</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">firstBadVersion</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> right = n;</span><br><span class="line">        <span class="keyword">while</span> (left &lt;= right) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (right - left) / <span class="number">2</span> + left;</span><br><span class="line">            <span class="keyword">if</span> (isBadVersion(mid)) &#123;</span><br><span class="line">                right = mid - <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                left = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> left;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-æœç´¢æ’å…¥ä½ç½®"><a href="#3-æœç´¢æ’å…¥ä½ç½®" class="headerlink" title="3. æœç´¢æ’å…¥ä½ç½®"></a>3. <a href="https://leetcode-cn.com/problems/search-insert-position/">æœç´¢æ’å…¥ä½ç½®</a></h2><p>Leetcode 35</p><p>ç»™å®šä¸€ä¸ªæ’åºæ•°ç»„å’Œä¸€ä¸ªç›®æ ‡å€¼ï¼Œåœ¨æ•°ç»„ä¸­æ‰¾åˆ°ç›®æ ‡å€¼ï¼Œå¹¶è¿”å›å…¶ç´¢å¼•ã€‚å¦‚æœç›®æ ‡å€¼ä¸å­˜åœ¨äºæ•°ç»„ä¸­ï¼Œè¿”å›å®ƒå°†ä¼šè¢«æŒ‰é¡ºåºæ’å…¥çš„ä½ç½®ã€‚</p><p>è¯·å¿…é¡»ä½¿ç”¨æ—¶é—´å¤æ‚åº¦ä¸º O(log n) çš„ç®—æ³•ã€‚</p><h3 id="é€’å½’å†™æ³•-1"><a href="#é€’å½’å†™æ³•-1" class="headerlink" title="é€’å½’å†™æ³•"></a>é€’å½’å†™æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">searchInsert</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> right = nums.length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (left &lt;= right) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (right - left) / <span class="number">2</span> + left;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] == target) &#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &gt; target) &#123;</span><br><span class="line">                right = mid - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">                left = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> left;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://leetcode-cn.com/problems/binary-search/&quot;&gt;https://leetcode-cn.com/problems/binary-search/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;1-äºŒåˆ†æŸ¥æ‰¾&quot;&gt;&lt;a href</summary>
      
    
    
    
    <category term="Leetcode" scheme="http://example.com/categories/Leetcode/"/>
    
    <category term="äºŒåˆ†" scheme="http://example.com/categories/Leetcode/%E4%BA%8C%E5%88%86/"/>
    
    
    <category term="Leetcode" scheme="http://example.com/tags/Leetcode/"/>
    
    <category term="äºŒåˆ†" scheme="http://example.com/tags/%E4%BA%8C%E5%88%86/"/>
    
  </entry>
  
  <entry>
    <title>é¢è¯•å®˜çœŸçš„é—®æˆ‘ã€Œåˆ†å¸ƒå¼äº‹åŠ¡ã€äº†</title>
    <link href="http://example.com/wiki/%E9%9D%A2%E8%AF%95%E5%AE%98%E7%9C%9F%E7%9A%84%E9%97%AE%E6%88%91%E3%80%8C%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E3%80%8D%E4%BA%86/"/>
    <id>http://example.com/wiki/%E9%9D%A2%E8%AF%95%E5%AE%98%E7%9C%9F%E7%9A%84%E9%97%AE%E6%88%91%E3%80%8C%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E3%80%8D%E4%BA%86/</id>
    <published>2021-09-18T09:07:46.000Z</published>
    <updated>2021-09-27T08:16:38.281Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CAPç†è®º"><a href="#CAPç†è®º" class="headerlink" title="CAPç†è®º"></a>CAPç†è®º</h2><p>CAPå®šç†ï¼Œåˆè¢«å«ä½œå¸ƒé²å°”å®šç†ã€‚å¯¹äºè®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´(ä¸ä»…ä»…æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡)çš„æ¶æ„å¸ˆæ¥è¯´ï¼ŒCAPå°±æ˜¯ä½ çš„å…¥é—¨ç†è®ºã€‚</p><p>C (ä¸€è‡´æ€§):å¯¹æŸä¸ªæŒ‡å®šçš„å®¢æˆ·ç«¯æ¥è¯´ï¼Œè¯»æ“ä½œèƒ½è¿”å›æœ€æ–°çš„å†™æ“ä½œã€‚å¯¹äºæ•°æ®åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šçš„æ•°æ®ä¸Šæ¥è¯´ï¼Œå¦‚æœåœ¨æŸä¸ªèŠ‚ç‚¹æ›´æ–°äº†æ•°æ®ï¼Œé‚£ä¹ˆåœ¨å…¶ä»–èŠ‚ç‚¹å¦‚æœéƒ½èƒ½è¯»å–åˆ°è¿™ä¸ªæœ€æ–°çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ç§°ä¸ºå¼ºä¸€è‡´ï¼Œå¦‚æœæœ‰æŸä¸ªèŠ‚ç‚¹æ²¡æœ‰è¯»å–åˆ°ï¼Œé‚£å°±æ˜¯åˆ†å¸ƒå¼ä¸ä¸€è‡´ã€‚<br>A (å¯ç”¨æ€§)ï¼šéæ•…éšœçš„èŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†çš„å“åº”(ä¸æ˜¯é”™è¯¯å’Œè¶…æ—¶çš„å“åº”)ã€‚å¯ç”¨æ€§çš„ä¸¤ä¸ªå…³é”®ä¸€ä¸ªæ˜¯åˆç†çš„æ—¶é—´ï¼Œä¸€ä¸ªæ˜¯åˆç†çš„å“åº”ã€‚åˆç†çš„æ—¶é—´æŒ‡çš„æ˜¯è¯·æ±‚ä¸èƒ½æ— é™è¢«é˜»å¡ï¼Œåº”è¯¥åœ¨åˆç†çš„æ—¶é—´ç»™å‡ºè¿”å›ã€‚åˆç†çš„å“åº”æŒ‡çš„æ˜¯ç³»ç»Ÿåº”è¯¥æ˜ç¡®è¿”å›ç»“æœå¹¶ä¸”ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œè¿™é‡Œçš„æ­£ç¡®æŒ‡çš„æ˜¯æ¯”å¦‚åº”è¯¥è¿”å›50ï¼Œè€Œä¸æ˜¯è¿”å›40ã€‚<br>P (åˆ†åŒºå®¹é”™æ€§):å½“å‡ºç°ç½‘ç»œåˆ†åŒºåï¼Œç³»ç»Ÿèƒ½å¤Ÿç»§ç»­å·¥ä½œã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œè¿™é‡Œä¸ªé›†ç¾¤æœ‰å¤šå°æœºå™¨ï¼Œæœ‰å°æœºå™¨ç½‘ç»œå‡ºç°äº†é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªé›†ç¾¤ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p><p>ç†Ÿæ‚‰CAPçš„äººéƒ½çŸ¥é“ï¼Œä¸‰è€…ä¸èƒ½å…±æœ‰ï¼Œå¦‚æœæ„Ÿå…´è¶£å¯ä»¥æœç´¢CAPçš„è¯æ˜ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œæ— æ³•100%å¯é ï¼Œåˆ†åŒºå…¶å®æ˜¯ä¸€ä¸ªå¿…ç„¶ç°è±¡ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©äº†CAè€Œæ”¾å¼ƒäº†Pï¼Œé‚£ä¹ˆå½“å‘ç”Ÿåˆ†åŒºç°è±¡æ—¶ï¼Œä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œè¿™ä¸ªæ—¶å€™å¿…é¡»æ‹’ç»è¯·æ±‚ï¼Œä½†æ˜¯Aåˆä¸å…è®¸ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸Šä¸å¯èƒ½é€‰æ‹©CAæ¶æ„ï¼Œåªèƒ½é€‰æ‹©CPæˆ–è€…APæ¶æ„ã€‚<br>å¯¹äºCPæ¥è¯´ï¼Œæ”¾å¼ƒå¯ç”¨æ€§ï¼Œè¿½æ±‚ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œæˆ‘ä»¬çš„zookeeperå…¶å®å°±æ˜¯è¿½æ±‚çš„å¼ºä¸€è‡´ã€‚<br>å¯¹äºAPæ¥è¯´ï¼Œæ”¾å¼ƒä¸€è‡´æ€§(è¿™é‡Œè¯´çš„ä¸€è‡´æ€§æ˜¯å¼ºä¸€è‡´æ€§)ï¼Œè¿½æ±‚åˆ†åŒºå®¹é”™æ€§å’Œå¯ç”¨æ€§ï¼Œè¿™æ˜¯å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„é€‰æ‹©ï¼Œåé¢çš„BASEä¹Ÿæ˜¯æ ¹æ®APæ¥æ‰©å±•ã€‚<br>é¡ºä¾¿ä¸€æï¼ŒCAPç†è®ºä¸­æ˜¯å¿½ç•¥ç½‘ç»œå»¶è¿Ÿï¼Œä¹Ÿå°±æ˜¯å½“äº‹åŠ¡æäº¤æ—¶ï¼Œä»èŠ‚ç‚¹Aå¤åˆ¶åˆ°èŠ‚ç‚¹Bï¼Œä½†æ˜¯åœ¨ç°å®ä¸­è¿™ä¸ªæ˜¯æ˜æ˜¾ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥æ€»ä¼šæœ‰ä¸€å®šçš„æ—¶é—´æ˜¯ä¸ä¸€è‡´ã€‚åŒæ—¶CAPä¸­é€‰æ‹©ä¸¤ä¸ªï¼Œæ¯”å¦‚ä½ é€‰æ‹©äº†CPï¼Œå¹¶ä¸æ˜¯å«ä½ æ”¾å¼ƒAã€‚å› ä¸ºPå‡ºç°çš„æ¦‚ç‡å®åœ¨æ˜¯å¤ªå°äº†ï¼Œå¤§éƒ¨åˆ†çš„æ—¶é—´ä½ ä»ç„¶éœ€è¦ä¿è¯CAã€‚å°±ç®—åˆ†åŒºå‡ºç°äº†ä½ ä¹Ÿè¦ä¸ºåæ¥çš„Aåšå‡†å¤‡ï¼Œæ¯”å¦‚é€šè¿‡ä¸€äº›æ—¥å¿—çš„æ‰‹æ®µï¼Œæ˜¯å…¶ä»–æœºå™¨å›å¤è‡³å¯ç”¨ã€‚</p><h2 id="BASEç†è®º"><a href="#BASEç†è®º" class="headerlink" title="BASEç†è®º"></a>BASEç†è®º</h2><p>BASE æ˜¯ Basically Available(åŸºæœ¬å¯ç”¨)ã€Soft state(è½¯çŠ¶æ€)å’Œ Eventually consistent (æœ€ç»ˆä¸€è‡´æ€§)ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚æ˜¯å¯¹CAPä¸­APçš„ä¸€ä¸ªæ‰©å±•</p><p>åŸºæœ¬å¯ç”¨:åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨åŠŸèƒ½ï¼Œä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨ã€‚<br>è½¯çŠ¶æ€:å…è®¸ç³»ç»Ÿä¸­å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸å½±å“ç³»ç»Ÿå¯ç”¨æ€§ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯CAPä¸­çš„ä¸ä¸€è‡´ã€‚<br>æœ€ç»ˆä¸€è‡´:æœ€ç»ˆä¸€è‡´æ˜¯æŒ‡ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®éƒ½å°†ä¼šè¾¾åˆ°ä¸€è‡´ã€‚</p><p>BASEè§£å†³äº†CAPä¸­ç†è®ºæ²¡æœ‰ç½‘ç»œå»¶è¿Ÿï¼Œåœ¨BASEä¸­ç”¨è½¯çŠ¶æ€å’Œæœ€ç»ˆä¸€è‡´ï¼Œä¿è¯äº†å»¶è¿Ÿåçš„ä¸€è‡´æ€§ã€‚BASEå’Œ ACID æ˜¯ç›¸åçš„ï¼Œå®ƒå®Œå…¨ä¸åŒäºACIDçš„å¼ºä¸€è‡´æ€§æ¨¡å‹ï¼Œè€Œæ˜¯é€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—å¯ç”¨æ€§ï¼Œå¹¶å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯ä¸ä¸€è‡´çš„ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚</p><h2 id="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"></a>åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</h2><h3 id="2PC"><a href="#2PC" class="headerlink" title="2PC"></a>2PC</h3><h3 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.bilibili.com/video/BV1FJ411A7mV?from=search&seid=11114763225649816490&spm_id_from=333.337.0.0">bilibili åˆ†å¸ƒå¼äº‹åŠ¡è¯¦è§£</a></li><li><a href="http://blog.itpub.net/69946034/viewspace-2671341/">å¾®æœåŠ¡åˆ†å¸ƒå¼äº‹åŠ¡4ç§è§£å†³æ–¹æ¡ˆå®æˆ˜</a></li><li><a href="https://juejin.cn/post/6844903647197806605">å†æœ‰äººé—®ä½ åˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒæŠŠè¿™ç¯‡æ‰”ç»™ä»–</a></li><li><a href="https://juejin.cn/post/6844903573667446797#heading-5">https://juejin.cn/post/6844903573667446797#heading-5</a>  </li><li><a href="https://juejin.cn/post/7012425995634343966?utm_source=gold_browser_extension">https://juejin.cn/post/7012425995634343966?utm_source=gold_browser_extension</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;CAPç†è®º&quot;&gt;&lt;a href=&quot;#CAPç†è®º&quot; class=&quot;headerlink&quot; title=&quot;CAPç†è®º&quot;&gt;&lt;/a&gt;CAPç†è®º&lt;/h2&gt;&lt;p&gt;CAPå®šç†ï¼Œåˆè¢«å«ä½œå¸ƒé²å°”å®šç†ã€‚å¯¹äºè®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´(ä¸ä»…ä»…æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡)çš„æ¶æ„å¸ˆæ¥è¯´ï¼ŒCAPå°±æ˜¯ä½ çš„å…¥é—¨ç†è®ºã€‚&lt;</summary>
      
    
    
    
    <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="http://example.com/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
    
    <category term="åˆ†å¸ƒå¼" scheme="http://example.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Redis-é«˜æ€§èƒ½IOæ¨¡å‹</title>
    <link href="http://example.com/wiki/Redis-%E9%AB%98%E6%80%A7%E8%83%BDIO%E6%A8%A1%E5%9E%8B/"/>
    <id>http://example.com/wiki/Redis-%E9%AB%98%E6%80%A7%E8%83%BDIO%E6%A8%A1%E5%9E%8B/</id>
    <published>2021-09-16T03:54:08.000Z</published>
    <updated>2021-09-16T07:53:17.457Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><blockquote><ul><li><a href="https://www.cnblogs.com/liang24/p/14178730.html">RedisåŸºç¡€ç¯‡ï¼ˆäºŒï¼‰é«˜æ€§èƒ½IOæ¨¡å‹</a></li><li><a href="https://www.jianshu.com/p/dfd940e7fca2">èŠèŠIOå¤šè·¯å¤ç”¨ä¹‹selectã€pollã€epollè¯¦è§£</a></li><li><a href="https://www.jianshu.com/p/486b0965c296">èŠèŠLinux äº”ç§IOæ¨¡å‹</a></li></ul></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‚è€ƒèµ„æ–™&quot;&gt;&lt;a href=&quot;#å‚è€ƒèµ„æ–™&quot; class=&quot;headerlink&quot; title=&quot;å‚è€ƒèµ„æ–™&quot;&gt;&lt;/a&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/liang24/p/</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>åŸºç¡€ç®—æ³•åˆ†ç±»å’Œæ€æƒ³</title>
    <link href="http://example.com/wiki/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95%E5%88%86%E7%B1%BB%E5%92%8C%E6%80%9D%E6%83%B3/"/>
    <id>http://example.com/wiki/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95%E5%88%86%E7%B1%BB%E5%92%8C%E6%80%9D%E6%83%B3/</id>
    <published>2021-09-15T11:44:40.000Z</published>
    <updated>2021-09-16T02:46:09.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ"><a href="#å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ" class="headerlink" title="å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ"></a>å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ</h1><h2 id="å›æº¯ç®—æ³•"><a href="#å›æº¯ç®—æ³•" class="headerlink" title="å›æº¯ç®—æ³•"></a>å›æº¯ç®—æ³•</h2><p>å¯ä»¥å‚ç…§ä¸‹é¢ğŸ‘‡æ–‡ç« ï¼š<br><a href="https://zhuanlan.zhihu.com/p/93530380">å›æº¯ç®—æ³•å¥—è·¯è¯¦è§£</a>  </p><p><strong>ç»ƒä¹ é¢˜åº“</strong><br>éƒ½æ˜¯å›æº¯ç®—æ³•çš„é¢˜ç›®ï¼šğŸ‘‡<br><a href="https://leetcode-cn.com/tag/backtracking/problemset/">https://leetcode-cn.com/tag/backtracking/problemset/</a>  </p><h2 id="æ•´ç†çš„æ¯”è¾ƒä¸é”™çš„èµ„æº"><a href="#æ•´ç†çš„æ¯”è¾ƒä¸é”™çš„èµ„æº" class="headerlink" title="æ•´ç†çš„æ¯”è¾ƒä¸é”™çš„èµ„æº"></a><font color=blue>æ•´ç†çš„æ¯”è¾ƒä¸é”™çš„èµ„æº</font></h2><p><a href="https://labuladong.gitbook.io/algo/mu-lu-ye/xue-xi-shu-ju-jie-gou-he-suan-fa-de-gao-xiao-fang-fa">ğŸ“–labuladong çš„ç®—æ³•å°æŠ„</a>  </p><p><img src="https://cdn.jsdelivr.net/gh/zabernism/image@main/gao/20210915202940.png" alt="20210915202940">  </p><p>æ•´ä½“æ¥è¯´è¿˜æ˜¯ç›¸å½“ä¸é”™çš„ï¼  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ&quot;&gt;&lt;a href=&quot;#å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ&quot; class=&quot;headerlink&quot; title=&quot;å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ&quot;&gt;&lt;/a&gt;å¸¸è§çš„ç®—æ³•è§£é¢˜æ€è·¯ä»¥åŠæ¨¡ç‰ˆ&lt;/h1&gt;&lt;h2 id=&quot;å›æº¯ç®—æ³•&quot;&gt;&lt;a href=&quot;#å›æº¯ç®—æ³•&quot;</summary>
      
    
    
    
    
    <category term="ç®—æ³•" scheme="http://example.com/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="æ•°æ®ç»“æ„" scheme="http://example.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ClassNotFoundExceptionä¸NoClassDefFoundErrorçš„åŒºåˆ«</title>
    <link href="http://example.com/wiki/%E7%90%86%E8%A7%A3ClassNotFoundException%E4%B8%8ENoClassDefFoundError%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <id>http://example.com/wiki/%E7%90%86%E8%A7%A3ClassNotFoundException%E4%B8%8ENoClassDefFoundError%E7%9A%84%E5%8C%BA%E5%88%AB/</id>
    <published>2021-09-15T07:43:20.000Z</published>
    <updated>2021-09-18T06:40:55.071Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ClassNotFoundException"><a href="#ClassNotFoundException" class="headerlink" title="ClassNotFoundException"></a>ClassNotFoundException</h2><p>ç±»åŠ è½½æ—¶åœ¨æŒ‡å®šè·¯å¾„ä¸‹æ²¡æœ‰æ‰¾åˆ°ç±»æ–‡ä»¶</p><h2 id="NoClassDefFoundError"><a href="#NoClassDefFoundError" class="headerlink" title="NoClassDefFoundError"></a>NoClassDefFoundError</h2><p>1ã€ç¼–è¯‘æ—¶å­˜åœ¨æŸä¸ªç±»ï¼Œä½†æ˜¯è¿è¡Œæ—¶å´æ‰¾ä¸åˆ°</p><blockquote><p>ç¼–è¯‘å®Œæˆä¹‹åï¼Œæ‰‹åŠ¨åˆ é™¤ä¸€ä¸ªç±»çš„classæ–‡ä»¶</p></blockquote><p>2ã€ç±»æ ¹æœ¬å°±æ²¡æœ‰åˆå§‹åŒ–æˆåŠŸï¼Œç»“æœä½ è¿˜æŠŠå®ƒå½“åšæ­£å¸¸ç±»ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™äº‹ä¹Ÿä¸å°ï¼Œå¿…é¡»æŠ›å‡ºERRORå‘Šè¯‰ä½ ä¸èƒ½å†ä½¿ç”¨äº†</p><p><a href="https://cloud.tencent.com/developer/article/1356060">https://cloud.tencent.com/developer/article/1356060</a></p><p><a href="https://blog.csdn.net/u012129558/article/details/81540804">https://blog.csdn.net/u012129558/article/details/81540804</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ClassNotFoundException&quot;&gt;&lt;a href=&quot;#ClassNotFoundException&quot; class=&quot;headerlink&quot; title=&quot;ClassNotFoundException&quot;&gt;&lt;/a&gt;ClassNotFoundExcepti</summary>
      
    
    
    
    
    <category term="JAVA" scheme="http://example.com/tags/JAVA/"/>
    
  </entry>
  
  <entry>
    <title>Rediså®ç°åˆ†å¸ƒå¼é”</title>
    <link href="http://example.com/wiki/Redis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <id>http://example.com/wiki/Redis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</id>
    <published>2021-09-15T03:21:41.000Z</published>
    <updated>2021-09-15T05:20:16.512Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚"><a href="#Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚" class="headerlink" title="Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚"></a>Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚</h1><p><strong>1ã€redisåˆ†å¸ƒå¼é”ç›´æ¥ä½¿ç”¨ <code>setNx</code> è·å–é”ğŸ”’ï¼Œ<code>del key</code> é‡Šæ”¾é”</strong></p><p>ä¼šé€ æˆ ã€Œ <font color=blue><strong>æ­»é”</strong></font> ã€çš„é—®é¢˜ï¼Œè·å–é”çš„çº¿ç¨‹æ²¡æœ‰é‡Šæ”¾é”ï¼Œè¿›ç¨‹æ­»æ‰äº†ï¼Œå…¶ä»–è¿›ç¨‹æ°¸è¿œæ— æ³•è·å–é”</p><p><strong>2ã€ç»™é”å¯¹åº”çš„keyæ·»åŠ è¿‡æœŸæ—¶é—´ä¸å°±å¯ä»¥è§£å†³æ­»é”çš„é—®é¢˜äº†å—ï¼Ÿ</strong></p><p><code>127.0.0.1:6379&gt; SETNX lock 1    // åŠ é”(integer) </code></p><p><code>127.0.0.1:6379&gt; EXPIRE lock 10  // 10såè‡ªåŠ¨è¿‡æœŸ(integer) </code></p><p><font color=blue> <strong>ä¸Šé¢ä¸¤ä¸ªå‘½ä»¤æœ‰ä»€ä¹ˆé—®é¢˜å—</strong>ï¼Ÿ</font></p><p>ä¸æ˜¯åŸå­æ“ä½œï¼Œå¯èƒ½ <code>expire</code>æ²¡æœ‰æ‰§è¡Œï¼ä½¿ç”¨å¦‚ä¸‹å¤åˆå‘½ä»¤ ğŸ‘‡</p><p><code>127.0.0.1:6379&gt; SET lock 1 EX 10 NX</code></p><p><strong>3ã€è¿™æ ·è¿˜ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œè¿›ç¨‹2é‡Šæ”¾çš„æ˜¯è¿›ç¨‹1çš„é”</strong></p><p>è¿›ç¨‹1æ“ä½œæ—¶é—´å¤ªä¹…ï¼Œè¿˜æ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”ï¼Œé”å°±è¿‡æœŸäº†ï¼Œç„¶åè¿›ç¨‹2è·å–é”ï¼Œç„¶åæ‰§è¡Œï¼Œè¿›ç¨‹2è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œè¿›ç¨‹1æ‰§è¡Œå®Œäº†ï¼Œé‡Šæ”¾</p><p>é”ï¼Œä½†æ˜¯é‡Šæ”¾çš„æ˜¯è¿›ç¨‹2çš„é”ã€‚ã€Œ <font color=blue><strong>é‡Šæ”¾ä»–äººé”</strong></font>ã€å’Œ ã€Œ <font color=blue><strong>é”è¿‡æœŸæ—¶é—´é—®é¢˜</strong></font>ã€</p><ol><li>åŠ é”ï¼š<code>SET lock_key $unique_id EX $expire_time NX</code></li><li>æ“ä½œå…±äº«èµ„æº</li><li>é‡Šæ”¾é”ï¼šLua è„šæœ¬ï¼Œå…ˆ GET åˆ¤æ–­é”æ˜¯å¦å½’å±è‡ªå·±ï¼Œå† DEL é‡Šæ”¾é”</li></ol><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// åˆ¤æ–­é”æ˜¯è‡ªå·±çš„ï¼Œæ‰é‡Šæ”¾</span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;GET&quot;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&quot;DEL&quot;</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>4ã€é”è¿‡æœŸæ—¶é—´ä¸å¥½è¯„ä¼°æ€ä¹ˆåŠï¼Ÿ</strong></p><p><font color=blue><strong>å‡è®¾ä¸€ä¸ªæ–¹æ¡ˆï¼š</strong></font></p><p><strong>åŠ é”æ—¶ï¼Œå…ˆè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œç„¶åæˆ‘ä»¬å¼€å¯ä¸€ä¸ªã€Œå®ˆæŠ¤çº¿ç¨‹ã€ï¼Œå®šæ—¶å»æ£€æµ‹è¿™ä¸ªé”çš„å¤±æ•ˆæ—¶é—´ï¼Œå¦‚æœé”å¿«è¦è¿‡æœŸäº†ï¼Œæ“ä½œå…±äº«èµ„æºè¿˜æœªå®Œæˆï¼Œé‚£ä¹ˆå°±è‡ªåŠ¨å¯¹é”è¿›è¡Œã€Œç»­æœŸã€ï¼Œé‡æ–°è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</strong></p><p>å¦‚æœä½ æ˜¯ Java æŠ€æœ¯æ ˆï¼Œå¹¸è¿çš„æ˜¯ï¼Œå·²ç»æœ‰ä¸€ä¸ªåº“æŠŠè¿™äº›å·¥ä½œéƒ½å°è£…å¥½äº†ï¼š<font color=blue><strong>Redisson</strong></font>ã€‚</p><p>Redisson æ˜¯ä¸€ä¸ª Java è¯­è¨€å®ç°çš„ Redis SDK å®¢æˆ·ç«¯ï¼Œåœ¨ä½¿ç”¨åˆ†å¸ƒå¼é”æ—¶ï¼Œå®ƒå°±é‡‡ç”¨äº†ã€Œè‡ªåŠ¨ç»­æœŸã€çš„æ–¹æ¡ˆæ¥é¿å…é”è¿‡æœŸï¼Œè¿™ä¸ªå®ˆæŠ¤çº¿ç¨‹æˆ‘ä»¬ä¸€èˆ¬ä¹ŸæŠŠå®ƒå«åšã€Œçœ‹é—¨ç‹—ã€çº¿ç¨‹ã€‚</p><p><strong><font color=red>ä»¥ä¸Šéƒ½æ˜¯åŸºäºå•æœºredisçš„è§’åº¦æ€è€ƒçš„redisåˆ†å¸ƒå¼é”çš„é—®é¢˜ï¼Œä¸»è¦æœ‰ä¸‰ç‚¹ ğŸ‘‡</font></strong></p><p>1ã€æ­»é”é—®é¢˜ ï¼ˆåŠ è¿‡æœŸæ—¶é—´è§£å†³ï¼‰</p><p>2ã€é‡Šæ”¾ä»–äººé” ï¼ˆæ·»åŠ çº¿ç¨‹æ ‡å¿—ï¼‰</p><p>3ã€é”è¿‡æœŸæ—¶é—´é—®é¢˜ ï¼ˆå®ˆæŠ¤çº¿ç¨‹è‡ªåŠ¨ç»­æœŸï¼‰</p><p><strong><font color=red>å¦‚æœæ˜¯redisé›†ç¾¤æ¨¡å¼ä¸‹ä¼šæœ‰å“ªäº›é—®é¢˜å‘¢ ğŸ‘‡</font></strong></p><p>åœ¨redisä¸»ä»æ¨¡å¼ä¸‹ï¼Œå¦‚æœmasterèŠ‚ç‚¹çªç„¶å®•æœºäº†ï¼Œé”è¿˜æ²¡æœ‰åŒæ­¥åˆ°ä»èŠ‚ç‚¹æ˜¯ï¼Œæ˜¯ä¸æ˜¯åˆ†å¸ƒå¼é”å°±ä¸¢äº†ï¼Ÿï¼Ÿï¼Ÿ</p><p>Redis ä½œè€…æå‡ºçš„ Redlock æ–¹æ¡ˆï¼Œæ˜¯å¦‚ä½•è§£å†³ä¸»ä»åˆ‡æ¢åï¼Œé”å¤±æ•ˆé—®é¢˜çš„ã€‚å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ ï¼Ÿ ã€Œ **<font color=blue>RedLock</font>**ã€</p><p><strong>Redlock çš„æ–¹æ¡ˆåŸºäº 2 ä¸ªå‰æï¼š</strong></p><ol><li>ä¸å†éœ€è¦éƒ¨ç½²<strong>ä»åº“</strong>å’Œ<strong>å“¨å…µ</strong>å®ä¾‹ï¼Œåªéƒ¨ç½²<strong>ä¸»åº“</strong></li><li>ä½†ä¸»åº“è¦éƒ¨ç½²å¤šä¸ªï¼Œå®˜æ–¹æ¨èè‡³å°‘ 5 ä¸ªå®ä¾‹</li></ol><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæƒ³ç”¨ä½¿ç”¨ Redlockï¼Œä½ è‡³å°‘è¦éƒ¨ç½² 5 ä¸ª Redis å®ä¾‹ï¼Œè€Œä¸”éƒ½æ˜¯ä¸»åº“ï¼Œå®ƒä»¬ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸ªå­¤ç«‹çš„å®ä¾‹ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼šä¸æ˜¯éƒ¨ç½² Redis Clusterï¼Œå°±æ˜¯éƒ¨ç½² 5 ä¸ªç®€å•çš„ Redis å®ä¾‹ã€‚</strong></p></blockquote><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><blockquote><ul><li><a href="https://mp.weixin.qq.com/s/ybiN5Q89wI0CnLURGUz4vw">æ·±åº¦å‰–æï¼šRedis åˆ†å¸ƒå¼é”åˆ°åº•å®‰å…¨å—ï¼Ÿçœ‹å®Œè¿™ç¯‡æ–‡ç« å½»åº•æ‡‚äº†ï¼</a></li></ul></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚&quot;&gt;&lt;a href=&quot;#Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚&quot; class=&quot;headerlink&quot; title=&quot;Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚&quot;&gt;&lt;/a&gt;Rediså®ç°åˆ†å¸ƒå¼é”çš„ç§ç§ç»†èŠ‚&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;1ã€redi</summary>
      
    
    
    
    
    <category term="Redis" scheme="http://example.com/tags/Redis/"/>
    
    <category term="åˆ†å¸ƒå¼" scheme="http://example.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>LinkedHashMapå®ç°ç®€æ˜“LRU</title>
    <link href="http://example.com/wiki/LinkedHashMap%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93LRU/"/>
    <id>http://example.com/wiki/LinkedHashMap%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93LRU/</id>
    <published>2021-09-15T02:07:58.000Z</published>
    <updated>2021-09-15T02:09:16.411Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›® #"></a>é¢˜ç›® <a href="https://hadyang.com/interview/docs/leetcode/LRUCache/#%E9%A2%98%E7%9B%AE">#</a></h2><p>è¿ç”¨ä½ æ‰€æŒæ¡çš„æ•°æ®ç»“æ„ï¼Œè®¾è®¡å’Œå®ç°ä¸€ä¸ª LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨) ç¼“å­˜æœºåˆ¶ã€‚å®ƒåº”è¯¥æ”¯æŒä»¥ä¸‹æ“ä½œï¼š è·å–æ•°æ® get å’Œ å†™å…¥æ•°æ® put ã€‚</p><p>è·å–æ•°æ® get(key) - å¦‚æœå¯†é’¥ (key) å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è·å–å¯†é’¥çš„å€¼ï¼ˆæ€»æ˜¯æ­£æ•°ï¼‰ï¼Œå¦åˆ™è¿”å› -1ã€‚ å†™å…¥æ•°æ® put(key, value) - å¦‚æœå¯†é’¥ä¸å­˜åœ¨ï¼Œåˆ™å†™å…¥å…¶æ•°æ®å€¼ã€‚å½“ç¼“å­˜å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå®ƒåº”è¯¥åœ¨å†™å…¥æ–°æ•°æ®ä¹‹å‰åˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®å€¼ï¼Œä»è€Œä¸ºæ–°çš„æ•°æ®å€¼ç•™å‡ºç©ºé—´ã€‚</p><p>è¿›é˜¶:</p><p>ä½ æ˜¯å¦å¯ä»¥åœ¨ O(1) æ—¶é—´å¤æ‚åº¦å†…å®Œæˆè¿™ä¸¤ç§æ“ä½œï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LruCache</span> <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(capacity , <span class="number">0.75f</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        Integer integer = <span class="keyword">super</span>.get(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> integer == <span class="keyword">null</span> ? -<span class="number">1</span> : integer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Integer, Integer&gt; eldest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size() &gt; <span class="keyword">this</span>.capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        LruCache cache = <span class="keyword">new</span> LruCache(<span class="number">2</span>);</span><br><span class="line">        cache.put(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">        cache.put(<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;get1 -&gt; &quot;</span> + cache.get(<span class="number">1</span>));</span><br><span class="line">        System.err.println(<span class="string">&quot;get2 -&gt; &quot;</span> + cache.get(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        System.err.println(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        cache.put(<span class="number">3</span>,<span class="number">3</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;get1 -&gt; &quot;</span> + cache.get(<span class="number">1</span>));</span><br><span class="line">        System.err.println(<span class="string">&quot;get2 -&gt; &quot;</span> + cache.get(<span class="number">2</span>));</span><br><span class="line">        System.err.println(<span class="string">&quot;get3 -&gt; &quot;</span> + cache.get(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        System.err.println(<span class="string">&quot;----------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        cache.put(<span class="number">4</span>,<span class="number">4</span>);</span><br><span class="line">        System.err.println(<span class="string">&quot;get1 -&gt; &quot;</span> + cache.get(<span class="number">1</span>));</span><br><span class="line">        System.err.println(<span class="string">&quot;get2 -&gt; &quot;</span> + cache.get(<span class="number">2</span>));</span><br><span class="line">        System.err.println(<span class="string">&quot;get3 -&gt; &quot;</span> + cache.get(<span class="number">3</span>));</span><br><span class="line">        System.err.println(<span class="string">&quot;get4 -&gt; &quot;</span> + cache.get(<span class="number">4</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;é¢˜ç›®&quot;&gt;&lt;a href=&quot;#é¢˜ç›®&quot; class=&quot;headerlink&quot; title=&quot;é¢˜ç›® #&quot;&gt;&lt;/a&gt;é¢˜ç›® &lt;a href=&quot;https://hadyang.com/interview/docs/leetcode/LRUCache/#%E9%A2%98%E7</summary>
      
    
    
    
    
    <category term="LRU" scheme="http://example.com/tags/LRU/"/>
    
  </entry>
  
  <entry>
    <title>Redisæ“ä½œä¸ºä»€ä¹ˆæ˜¯åŸå­æ€§çš„ï¼Ÿ</title>
    <link href="http://example.com/wiki/Redis%E6%93%8D%E4%BD%9C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E5%8E%9F%E5%AD%90%E6%80%A7%E7%9A%84%EF%BC%9F/"/>
    <id>http://example.com/wiki/Redis%E6%93%8D%E4%BD%9C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E5%8E%9F%E5%AD%90%E6%80%A7%E7%9A%84%EF%BC%9F/</id>
    <published>2021-09-14T02:46:36.000Z</published>
    <updated>2021-09-14T03:19:40.931Z</updated>
    
    <content type="html"><![CDATA[<h2 id="RedisåŸåˆ™æ€§æ“ä½œ"><a href="#RedisåŸåˆ™æ€§æ“ä½œ" class="headerlink" title="RedisåŸåˆ™æ€§æ“ä½œ"></a>RedisåŸåˆ™æ€§æ“ä½œ</h2><p>å¯¹Redisæ¥è¯´ï¼Œæ‰§è¡Œgetã€setä»¥åŠevalç­‰APIï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡éƒ½ä¼šç”±Redisçš„çº¿ç¨‹å»è´Ÿè´£æ‰§è¡Œï¼Œä»»åŠ¡è¦ä¹ˆæ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆ</p><p>æ‰§è¡Œå¤±è´¥ï¼Œè¿™å°±æ˜¯Redisçš„å‘½ä»¤æ˜¯åŸå­æ€§çš„åŸå› ã€‚</p><blockquote><p>Redisæœ¬èº«æä¾›çš„æ‰€æœ‰APIéƒ½æ˜¯åŸå­æ“ä½œï¼ŒRedisä¸­çš„äº‹åŠ¡å…¶å®æ˜¯è¦ä¿è¯æ‰¹é‡æ“ä½œçš„åŸå­æ€§ã€‚</p></blockquote><h2 id="äº‹åŠ¡å‘½ä»¤"><a href="#äº‹åŠ¡å‘½ä»¤" class="headerlink" title="äº‹åŠ¡å‘½ä»¤"></a>äº‹åŠ¡å‘½ä»¤</h2><p>MULTI ã€ EXEC ã€ DISCARD å’Œ WATCH æ˜¯ Redis äº‹åŠ¡ç›¸å…³çš„å‘½ä»¤ã€‚äº‹åŠ¡å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œ å¹¶ä¸”å¸¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªé‡è¦çš„ä¿è¯ï¼š</p><ul><li>äº‹åŠ¡æ˜¯ä¸€ä¸ªå•ç‹¬çš„éš”ç¦»æ“ä½œï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰€æ‰“æ–­ã€‚</li><li>äº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼šäº‹åŠ¡ä¸­çš„å‘½ä»¤è¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨éƒ½ä¸æ‰§è¡Œã€‚</li></ul><p>Discard:Redis Discard å‘½ä»¤ç”¨äºå–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å¦‚ä½•å¼€å¯ä¸€ä¸ªäº‹åŠ¡</span><br><span class="line">watch key1 key2 . . . ï¼ˆç›‘å¬ç›¸å…³keyï¼‰</span><br><span class="line">multi (å¼€å¯äº‹åŠ¡)</span><br><span class="line">// å¯¹ç›‘å¬keyçš„ä¸€äº›æ“ä½œ</span><br><span class="line">execï¼ˆæ‰§è¡Œäº‹åŠ¡ï¼‰</span><br><span class="line">discardï¼ˆå–æ¶ˆäº‹åŠ¡ï¼‰</span><br></pre></td></tr></table></figure><p><strong>EXEC</strong> å‘½ä»¤è´Ÿè´£è§¦å‘å¹¶æ‰§è¡Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤ï¼šå¦‚æœå®¢æˆ·ç«¯åœ¨ä½¿ç”¨ MULTI å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ä¹‹åï¼Œå´å› ä¸ºæ–­çº¿è€Œæ²¡æœ‰æˆåŠŸæ‰§è¡Œ EXEC ï¼Œé‚£ä¹ˆäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœå®¢æˆ·ç«¯æˆåŠŸåœ¨å¼€å¯äº‹åŠ¡ä¹‹åæ‰§è¡Œ EXEC ï¼Œé‚£ä¹ˆäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šè¢«æ‰§è¡Œã€‚</p><h3 id="å¦‚æœrediså¤‡ä»½é‡‡ç”¨çš„æ˜¯AOFçš„æ–¹å¼ï¼Œäº‹åŠ¡æ‰§è¡Œä¸€åŠè¢«ç»ˆæ­¢ï¼Œä¼šæ€æ ·ï¼Ÿ"><a href="#å¦‚æœrediså¤‡ä»½é‡‡ç”¨çš„æ˜¯AOFçš„æ–¹å¼ï¼Œäº‹åŠ¡æ‰§è¡Œä¸€åŠè¢«ç»ˆæ­¢ï¼Œä¼šæ€æ ·ï¼Ÿ" class="headerlink" title="å¦‚æœrediså¤‡ä»½é‡‡ç”¨çš„æ˜¯AOFçš„æ–¹å¼ï¼Œäº‹åŠ¡æ‰§è¡Œä¸€åŠè¢«ç»ˆæ­¢ï¼Œä¼šæ€æ ·ï¼Ÿ"></a><font color=blue><strong>å¦‚æœrediså¤‡ä»½é‡‡ç”¨çš„æ˜¯AOFçš„æ–¹å¼ï¼Œäº‹åŠ¡æ‰§è¡Œä¸€åŠè¢«ç»ˆæ­¢ï¼Œä¼šæ€æ ·ï¼Ÿ</strong></font></h3><p>å½“ä½¿ç”¨ AOF æ–¹å¼åšæŒä¹…åŒ–çš„æ—¶å€™ï¼Œ Redis ä¼šä½¿ç”¨å•ä¸ª write(2) å‘½ä»¤å°†äº‹åŠ¡å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚</p><p>ç„¶è€Œï¼Œå¦‚æœ Redis æœåŠ¡å™¨å› ä¸ºæŸäº›åŸå› è¢«ç®¡ç†å‘˜æ€æ­»ï¼Œæˆ–è€…é‡ä¸ŠæŸç§ç¡¬ä»¶æ•…éšœï¼Œé‚£ä¹ˆå¯èƒ½åªæœ‰éƒ¨åˆ†äº‹åŠ¡å‘½ä»¤ä¼šè¢«æˆåŠŸå†™å…¥åˆ°ç£ç›˜ä¸­ã€‚</p><p>å¦‚æœ Redis åœ¨é‡æ–°å¯åŠ¨æ—¶å‘ç° AOF æ–‡ä»¶å‡ºäº†è¿™æ ·çš„é—®é¢˜ï¼Œé‚£ä¹ˆå®ƒä¼šé€€å‡ºï¼Œå¹¶æ±‡æŠ¥ä¸€ä¸ªé”™è¯¯ã€‚</p><p>ä½¿ç”¨ <code>redis-check-aof</code> ç¨‹åºå¯ä»¥ä¿®å¤è¿™ä¸€é—®é¢˜ï¼šå®ƒä¼šç§»é™¤ AOF æ–‡ä»¶ä¸­ä¸å®Œæ•´äº‹åŠ¡çš„ä¿¡æ¯ï¼Œç¡®ä¿æœåŠ¡å™¨å¯ä»¥é¡ºåˆ©å¯åŠ¨ã€‚</p><p>ä» 2.2 ç‰ˆæœ¬å¼€å§‹ï¼ŒRedis è¿˜å¯ä»¥é€šè¿‡ä¹è§‚é”ï¼ˆoptimistic lockï¼‰å®ç° CAS ï¼ˆcheck-and-setï¼‰æ“ä½œï¼Œå…·ä½“ä¿¡æ¯è¯·å‚è€ƒæ–‡æ¡£çš„ååŠéƒ¨åˆ†ã€‚</p><h3 id="å¦‚æœæ˜¯é›†ç¾¤ä¸‹ï¼Œwatchå‘½ä»¤æœ‰æ²¡æœ‰ä»€ä¹ˆå±€é™æ€§ï¼Ÿ"><a href="#å¦‚æœæ˜¯é›†ç¾¤ä¸‹ï¼Œwatchå‘½ä»¤æœ‰æ²¡æœ‰ä»€ä¹ˆå±€é™æ€§ï¼Ÿ" class="headerlink" title="å¦‚æœæ˜¯é›†ç¾¤ä¸‹ï¼Œwatchå‘½ä»¤æœ‰æ²¡æœ‰ä»€ä¹ˆå±€é™æ€§ï¼Ÿ"></a><font color=blue>å¦‚æœæ˜¯é›†ç¾¤ä¸‹ï¼Œwatchå‘½ä»¤æœ‰æ²¡æœ‰ä»€ä¹ˆå±€é™æ€§ï¼Ÿ</font></h3><p>æœ‰æ²¡æœ‰æƒ³è¿‡ä¸ºä»€ä¹ˆç›‘å¬å¤šä¸ªè½åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šçš„<code>key</code>ï¼Œä¸åŒæ§½ä½çš„ä¹Ÿä¸å¯ä»¥ï¼Œä¼šä¸è¢«å…è®¸ï¼Ÿåœ¨å•èŠ‚ç‚¹ä¸‹ï¼Œ<code>Redis</code>å•çº¿ç¨‹æ‰§è¡Œï¼Œèƒ½å¤Ÿä¿è¯åŸå­æ€§ï¼Œä½†åœ¨ä¸åŒèŠ‚ç‚¹ä¸‹ï¼Œå°±æ˜¯å¤šè¿›ç¨‹å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œ<code>Watch</code>è‡ªç„¶å°±ä¸èƒ½ç”¨ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><blockquote><ul><li><a href="https://www.cnblogs.com/lori/p/9300087.html">çŸ¥å…¶æ‰€ä»¥ç„¶~redisçš„åŸå­æ€§</a></li><li><a href="https://juejin.cn/post/6844904098987245576">Rediså®ç°åŸå­æ“ä½œçš„ä¸¤ç§æ–¹å¼ä¸å•†å“å…¥åº“å‡ºåº“è§£å†³æ–¹æ¡ˆ</a></li></ul></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;RedisåŸåˆ™æ€§æ“ä½œ&quot;&gt;&lt;a href=&quot;#RedisåŸåˆ™æ€§æ“ä½œ&quot; class=&quot;headerlink&quot; title=&quot;RedisåŸåˆ™æ€§æ“ä½œ&quot;&gt;&lt;/a&gt;RedisåŸåˆ™æ€§æ“ä½œ&lt;/h2&gt;&lt;p&gt;å¯¹Redisæ¥è¯´ï¼Œæ‰§è¡Œgetã€setä»¥åŠevalç­‰APIï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ä»»åŠ¡</summary>
      
    
    
    
    
    <category term="Redis" scheme="http://example.com/tags/Redis/"/>
    
  </entry>
  
</feed>
